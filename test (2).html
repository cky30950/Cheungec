<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­é†«è¨ºæ‰€ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
<script type="module">
    // Import Firebase functions
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, setDoc, onSnapshot, query, where, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getDatabase, ref, set, get, child, push, update, remove, onValue, off } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    // æ‚¨çš„ Firebase é…ç½®ï¼ˆè«‹æ›¿æ›æˆæ‚¨çš„å¯¦éš›é…ç½®ï¼‰
const firebaseConfig = {
  apiKey: "AIzaSyCx_BLIWVKZs0vJa5TwL6zoycJexY_5nXU",
  authDomain: "system-1e90a.firebaseapp.com",
  databaseURL: "https://system-1e90a-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "system-1e90a",
  storageBucket: "system-1e90a.firebasestorage.app",
  messagingSenderId: "80947900109",
  appId: "1:80947900109:web:b6cd62bb2f1e07971a4384"
};

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);
    const auth = getAuth(app);

    // è®“å…¶ä»–è…³æœ¬å¯ä»¥ä½¿ç”¨ Firebase
    window.firebase = {
        app, db, rtdb, auth,
        collection, addDoc, getDocs, doc, updateDoc, deleteDoc, setDoc, onSnapshot, query, where, orderBy, limit,
        ref, set, get, child, push, update, remove, onValue, off,
        signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged
    };

    // é€£æ¥ç‹€æ…‹ç›£æ§
    window.firebaseConnected = false;
    const connectedRef = ref(rtdb, '.info/connected');
    onValue(connectedRef, (snapshot) => {
        if (snapshot.val() === true) {
            window.firebaseConnected = true;
            console.log('Firebase å·²é€£æ¥');
        } else {
            window.firebaseConnected = false;
            console.log('Firebase é€£æ¥ä¸­æ–·');
        }
    });

    console.log('Firebase åˆå§‹åŒ–å®Œæˆ');
</script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* æµ®å‹•æç¤ºæ¨£å¼ */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            max-width: 500px;
            padding: 16px 20px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transform: translateX(100%);
            transition: all 0.3s ease-in-out;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .toast.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .toast.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .toast.info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }
        
        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .toast-content {
            flex: 1;
            line-height: 1.4;
        }
    </style>
    <style>
/* å¯¦æ™‚ç‹€æ…‹æŒ‡ç¤ºå™¨æ¨£å¼ */
.realtime-status {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.5rem;
    border-radius: 0.5rem;
    font-size: 0.75rem;
    font-weight: 500;
}

.status-online {
    background-color: #dcfce7;
    color: #166534;
}

.status-busy {
    background-color: #fef3c7;
    color: #92400e;
}

.status-offline {
    background-color: #f3f4f6;
    color: #6b7280;
}

/* é€šçŸ¥å‹•ç•« */
@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.notification-enter {
    animation: slideInRight 0.3s ease-out;
}

/* å¯¦æ™‚æ›´æ–°æŒ‡ç¤ºå™¨ */
.realtime-indicator {
    position: relative;
}

.realtime-indicator::after {
    content: '';
    position: absolute;
    top: -2px;
    right: -2px;
    width: 8px;
    height: 8px;
    background-color: #10b981;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
    }
    
    70% {
        transform: scale(1);
        box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
    }
    
    100% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
    }
}
</style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">
    <!-- ç™»å…¥é é¢ -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="text-4xl mb-4">ğŸ¥</div>
                <h1 id="loginTitle" class="text-2xl font-bold text-gray-800 mb-2">ä¸­é†«è¨ºæ‰€ç³»çµ±</h1>
                <p id="loginEnglishTitle" class="text-sm text-gray-500 mb-3">TCM Clinic</p>
                <p class="text-gray-600">è«‹è¼¸å…¥æ‚¨çš„é›»å­éƒµä»¶åŠå¯†ç¢¼ç™»å…¥</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">é›»å­éƒµä»¶</label>
                    <input type="email" id="mainLoginUsername" placeholder="è«‹è¼¸å…¥é›»å­éƒµä»¶" 
                           class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           onkeypress="if(event.key==='Enter') document.getElementById('mainLoginPassword').focus()">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">å¯†ç¢¼</label>
                    <input type="password" id="mainLoginPassword" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" 
                           class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           onkeypress="if(event.key==='Enter') attemptMainLogin()">
                </div>
                
                <button onclick="attemptMainLogin()" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                    ç™»å…¥ç³»çµ±
                </button>
                
                <!-- ç¤ºç¯„å¸³è™Ÿæç¤ºå€å·²ç§»é™¤ï¼Œç³»çµ±ä½¿ç”¨è€…è«‹ä½¿ç”¨æ‚¨çš„é›»å­éƒµä»¶ç™»å…¥ -->
            </div>
        </div>
    </div>

    <!-- ä¸»ç³»çµ±é é¢ -->
    <div id="mainSystem" class="hidden fade-in">
        <!-- å´é‚Šé¸å–® -->
        <div id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-2xl transform -translate-x-full transition-transform duration-300 ease-in-out">
            <div class="flex flex-col h-full">
                <!-- é¸å–®æ¨™é¡Œ -->
                <div class="bg-green-600 text-white p-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">ğŸ¥</span>
                            <h2 class="text-lg font-bold">è¨ºæ‰€åŠŸèƒ½</h2>
                        </div>
                        <button onclick="toggleSidebar()" class="text-white hover:text-gray-200 text-xl">
                            Ã—
                        </button>
                    </div>
                    <div id="sidebarUserRole" class="text-sm text-green-100 mt-2"></div>
                </div>

                <!-- åŠŸèƒ½é¸å–®é …ç›® -->
                <div class="flex-1 py-4">
                    <div id="sidebarMenu" class="space-y-2 px-4">
                        <!-- é¸å–®é …ç›®æœƒå‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- åº•éƒ¨æ“ä½œ -->
                <div class="border-t border-gray-200 p-4">
                    <button onclick="logout()" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg text-sm transition duration-200 flex items-center justify-center">
                        <span class="mr-2">ğŸšª</span>
                        ç™»å‡ºç³»çµ±
                    </button>
                </div>
            </div>
        </div>

        <!-- é®ç½©å±¤ -->
        <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden" onclick="toggleSidebar()"></div>

        <!-- é ‚éƒ¨å°èˆª -->
        <nav class="bg-white shadow-lg border-b-4 border-green-500">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <button onclick="toggleSidebar()" class="mr-4 p-2 rounded-lg hover:bg-gray-100 transition duration-200">
                            <div class="w-6 h-6 flex flex-col justify-center space-y-1">
                                <div class="w-full h-0.5 bg-gray-600"></div>
                                <div class="w-full h-0.5 bg-gray-600"></div>
                                <div class="w-full h-0.5 bg-gray-600"></div>
                            </div>
                        </button>
                        <span class="text-2xl mr-3">ğŸ¥</span>
                        <div>
                            <h1 id="systemTitle" class="text-xl font-bold text-gray-800">ä¸­é†«è¨ºæ‰€ç³»çµ±</h1>
                            <p id="systemEnglishTitle" class="text-xs text-gray-500">TCM Clinic</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="userRole" class="text-sm text-gray-600"></span>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                            ç™»å‡º
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
        <div class="max-w-7xl mx-auto px-4 py-6">
            <!-- æ­¡è¿é é¢ -->
            <div id="welcomePage" class="text-center py-16">
                <div class="text-6xl mb-6">ğŸ¥</div>
                <h2 id="welcomeTitle" class="text-3xl font-bold text-gray-800 mb-2">æ­¡è¿ä½¿ç”¨ä¸­é†«è¨ºæ‰€ç³»çµ±</h2>
                <p id="welcomeEnglishTitle" class="text-lg text-gray-500 mb-4">Welcome to TCM Clinic</p>
                <p class="text-gray-600 text-lg mb-8">è«‹é»æ“Šå·¦ä¸Šè§’é¸å–®æŒ‰éˆ•é–‹å§‹ä½¿ç”¨ç³»çµ±åŠŸèƒ½</p>
                <div class="bg-white rounded-xl shadow-lg p-8 max-w-4xl mx-auto">
                    <h3 class="text-xl font-semibold mb-4">ç³»çµ±åŠŸèƒ½æ¦‚è¦½</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <div class="text-2xl mb-2">ğŸ‘¥</div>
                            <div class="font-semibold">ç—…äººè³‡æ–™ç®¡ç†</div>
                            <div class="text-gray-600 mt-1">æ–°å¢ã€æŸ¥çœ‹ã€ç®¡ç†ç—…äººè³‡æ–™</div>
                        </div>
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <div class="text-2xl mb-2">ğŸ©º</div>
                            <div class="font-semibold">è¨ºç—‡ç³»çµ±</div>
                            <div class="text-gray-600 mt-1">è¨˜éŒ„ç—‡ç‹€ã€è¨ºæ–·ã€é–‹ç«‹è™•æ–¹</div>
                        </div>
                        <div class="text-center p-4 bg-purple-50 rounded-lg">
                            <div class="text-2xl mb-2">ğŸ‘¤</div>
                            <div class="font-semibold">ç”¨æˆ¶ç®¡ç†</div>
                            <div class="text-gray-600 mt-1">ç®¡ç†è¨ºæ‰€ç”¨æˆ¶æ¬Šé™</div>
                        </div>
                        <div class="text-center p-4 bg-red-50 rounded-lg">
                            <div class="text-2xl mb-2">âš™ï¸</div>
                            <div class="font-semibold">ç³»çµ±ç®¡ç†</div>
                            <div class="text-gray-600 mt-1">çµ±è¨ˆè³‡æ–™ã€å‚™ä»½åŒ¯å‡º</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç—…äººè³‡æ–™ç®¡ç† -->
            <div id="patientManagement" class="hidden bg-white rounded-xl shadow-lg p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">ç—…äººè³‡æ–™ç®¡ç†</h2>
                    <div class="flex flex-col md:flex-row gap-3">
                        <div class="relative">
                            <input type="text" id="searchPatient" placeholder="æœå°‹ç—…äººç·¨è™Ÿã€å§“åæˆ–é›»è©±..." class="border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:ring-2 focus:ring-green-500 focus:border-transparent w-full md:w-64">
                            <span class="absolute right-3 top-2.5 text-gray-400">ğŸ”</span>
                        </div>
                        <button onclick="showAddPatientForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200 whitespace-nowrap">
                            + æ–°å¢ç—…äºº
                        </button>
                    </div>
                </div>

                <!-- æ–°å¢/ç·¨è¼¯ç—…äººè¡¨å–®å½ˆçª— -->
                <div id="addPatientModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                            <h3 id="formTitle" class="text-xl font-bold text-gray-800">æ–°å¢ç—…äººè³‡æ–™</h3>
                            <button onclick="hideAddPatientForm()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">å§“å *</label>
                                    <input type="text" id="patientName" placeholder="è«‹è¼¸å…¥å§“å" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">å¹´é½¡</label>
                                    <input type="number" id="patientAge" placeholder="ç³»çµ±è‡ªå‹•è¨ˆç®—" min="0" max="120" readonly class="w-full border border-gray-300 rounded-lg px-4 py-2 bg-gray-100 text-gray-600">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">æ€§åˆ¥ *</label>
                                    <select id="patientGender" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                        <option value="">è«‹é¸æ“‡æ€§åˆ¥</option>
                                        <option value="ç”·">ç”·</option>
                                        <option value="å¥³">å¥³</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">é›»è©±è™Ÿç¢¼ *</label>
                                    <input type="tel" id="patientPhone" placeholder="ä¾‹ï¼š0912-345-678" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <!-- å°‡èº«åˆ†è­‰å­—è™Ÿè¨­ç‚ºå¿…å¡«ï¼Œä¸¦ç§»é™¤å›ºå®šé•·åº¦é™åˆ¶ -->
                                    <label class="block text-sm font-medium text-gray-700 mb-1">èº«åˆ†è­‰å­—è™Ÿ *</label>
                                    <input type="text" id="patientIdCard" placeholder="ä¾‹ï¼šA123456789" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">å‡ºç”Ÿæ—¥æœŸ *</label>
                                    <input type="date" id="patientBirthDate" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent" onchange="updatePatientAge()">
                                </div>
                                <div class="md:col-span-2 lg:col-span-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">è¯çµ¡åœ°å€</label>
                                    <textarea id="patientAddress" placeholder="è«‹è¼¸å…¥å®Œæ•´åœ°å€" rows="2" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                                </div>
                                <div class="md:col-span-2 lg:col-span-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">éæ•å²</label>
                                    <textarea id="patientAllergies" placeholder="è«‹è©³ç´°è¨˜éŒ„è—¥ç‰©éæ•æˆ–é£Ÿç‰©éæ•å²" rows="2" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                                </div>
                                <div class="md:col-span-2 lg:col-span-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ç—…å²åŠå‚™è¨»</label>
                                    <textarea id="patientHistory" placeholder="è«‹è¨˜éŒ„é‡è¦ç—…å²ã€å®¶æ—ç—…å²ã€æ…¢æ€§ç–¾ç—…ç­‰" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-gray-200">
                                <button onclick="hideAddPatientForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                                    å–æ¶ˆ
                                </button>
                                <button onclick="savePatient()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200">
                                    <span id="saveButtonText">å„²å­˜</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç—…äººåˆ—è¡¨ -->
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ç·¨è™Ÿ</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">å§“å</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">å¹´é½¡</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">æ€§åˆ¥</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">é›»è©±</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="patientList" class="divide-y divide-gray-200">
                            <!-- ç—…äººè³‡æ–™æœƒå‹•æ…‹è¼‰å…¥ -->
                        </tbody>
                    </table>
                </div>

                <!-- ç—…äººè©³ç´°è³‡æ–™å½ˆçª— -->
                <div id="patientDetailModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
                            <h3 class="text-xl font-bold text-gray-800">ç—…äººè©³ç´°è³‡æ–™</h3>
                            <button onclick="closePatientDetail()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                        </div>
                        <div id="patientDetailContent" class="p-6">
                            <!-- è©³ç´°å…§å®¹æœƒå‹•æ…‹è¼‰å…¥ -->
                        </div>
                    </div>
                </div>

                <!-- ç—…äººç—…æ­·æŸ¥çœ‹å½ˆçª— -->
                <div id="patientMedicalHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                            <h3 id="patientMedicalHistoryTitle" class="text-xl font-bold text-gray-800">ç—…æ­·è¨˜éŒ„</h3>
                            <button onclick="closePatientMedicalHistoryModal()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                        </div>
                        
                        <div class="p-6">
                            <!-- ç—…äººåŸºæœ¬è³‡è¨Š -->
                            <div id="patientMedicalHistoryPatientInfo" class="bg-blue-50 rounded-lg p-4 mb-6">
                                <!-- ç—…äººè³‡è¨Šæœƒå‹•æ…‹è¼‰å…¥ -->
                            </div>
                            
                            <!-- è¨ºç—‡è¨˜éŒ„åˆ—è¡¨ -->
                            <div id="patientMedicalHistoryContent">
                                <!-- è¨ºç—‡è¨˜éŒ„æœƒå‹•æ…‹è¼‰å…¥ -->
                            </div>
                        </div>
                    </div>
                </div>




            </div>

            <!-- è¨ºç—‡ç³»çµ± -->
            <div id="consultationSystem" class="hidden bg-white rounded-xl shadow-lg p-6">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">æ›è™Ÿè¨ºç—‡ç³»çµ±</h2>
                    <p class="text-gray-600 mt-2">ç°¡æ½”çš„æ›è™Ÿæµç¨‹ç®¡ç†</p>
                </div>
                
                <!-- ç—…äººæœç´¢æ›è™Ÿ -->
                <div class="bg-gradient-to-r from-blue-50 to-green-50 rounded-lg p-6 mb-6">
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold text-gray-800 flex items-center mb-2">
                            <span class="mr-2">ğŸ”</span>æœç´¢ç—…äººæ›è™Ÿ
                        </h3>
                        <p class="text-sm text-gray-600">è«‹è¼¸å…¥ç—…äººå§“åã€ç·¨è™Ÿæˆ–é›»è©±é€²è¡Œæœç´¢</p>
                    </div>
                    
                    <div class="flex gap-3">
                        <div class="flex-1 relative">
                            <input type="text" id="patientSearchInput" placeholder="æœå°‹ç—…äººå§“åã€ç·¨è™Ÿæˆ–é›»è©±..." 
                                   class="w-full border border-gray-300 rounded-lg px-4 py-3 pr-10 focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                   oninput="searchPatientsForRegistration()">
                            <span class="absolute right-3 top-3.5 text-gray-400">ğŸ”</span>
                        </div>
                        <button onclick="clearPatientSearch()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-lg transition duration-200">
                            æ¸…é™¤
                        </button>
                    </div>
                    
                    <!-- æœç´¢çµæœ -->
                    <div id="patientSearchResults" class="mt-4 hidden">
                        <div class="bg-white rounded-lg border border-gray-200 max-h-64 overflow-y-auto">
                            <div id="searchResultsList" class="divide-y divide-gray-200">
                                <!-- æœç´¢çµæœæœƒå‹•æ…‹è¼‰å…¥ -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ›è™Ÿå½ˆçª— -->
                <div id="registrationModal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
                        <div class="bg-green-600 text-white px-6 py-4 rounded-t-xl">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-bold">ç—…äººæ›è™Ÿ</h3>
                                <button onclick="closeRegistrationModal()" class="text-white hover:text-gray-200 text-2xl">Ã—</button>
                            </div>
                        </div>
                        
                        <div class="p-6 space-y-4">
                            <!-- é¸ä¸­çš„ç—…äººè³‡è¨Š -->
                            <div class="bg-blue-50 rounded-lg p-4">
                                <div class="flex items-center mb-2">
                                    <span class="mr-2">ğŸ‘¤</span>
                                    <span class="font-semibold text-gray-700">ç—…äººè³‡è¨Š</span>
                                </div>
                                <div id="selectedPatientInfo" class="text-sm text-gray-600">
                                    <!-- ç—…äººè³‡è¨Šæœƒå‹•æ…‹è¼‰å…¥ -->
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <span class="mr-2">ğŸ‘¨â€âš•ï¸</span>æ›è™Ÿé†«å¸« *
                                </label>
                                <select id="appointmentDoctor" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="">è«‹é¸æ“‡é†«å¸«</option>
                                    <!-- é†«å¸«é¸é …æœƒå‹•æ…‹è¼‰å…¥ -->
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <span class="mr-2">â°</span>æ›è™Ÿæ™‚é–“
                                </label>
                                <input type="datetime-local" id="appointmentDateTime" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <span class="mr-2">ğŸ“</span>ä¸»è¨´ç—‡ç‹€
                                </label>
                                <textarea id="quickChiefComplaint" placeholder="è«‹ç°¡è¿°ç—…äººçš„ä¸»è¦ç—‡ç‹€..." rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                            </div>
                            
                            <div class="flex space-x-3 pt-4">
                                <button onclick="closeRegistrationModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg transition duration-200">
                                    å–æ¶ˆ
                                </button>
                                <button onclick="confirmRegistration()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                    ç¢ºèªæ›è™Ÿ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ä»Šæ—¥æ›è™Ÿåˆ—è¡¨ -->
                <div class="bg-white border border-gray-200 rounded-lg">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 rounded-t-lg">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                                <span class="mr-2">ğŸ“…</span>ä»Šæ—¥æ›è™Ÿåˆ—è¡¨
                            </h3>
                            <div class="text-sm text-gray-600">
                                ç¸½è¨ˆï¼š<span id="todayTotal" class="font-semibold text-blue-600">0</span> äºº
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">åºè™Ÿ</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ç—…äººå§“å</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">æ›è™Ÿé†«å¸«</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">æ›è™Ÿæ™‚é–“</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ä¸»è¨´ç—‡ç‹€</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ç‹€æ…‹</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="todayAppointmentsList" class="divide-y divide-gray-200">
                                    <!-- æ›è™Ÿåˆ—è¡¨æœƒå‹•æ…‹è¼‰å…¥ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>



                <!-- è¨ºç—‡è¨˜éŒ„æŸ¥çœ‹å½ˆçª— -->
                <div id="medicalHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                            <h3 id="medicalHistoryTitle" class="text-xl font-bold text-gray-800">è¨ºç—‡è¨˜éŒ„</h3>
                            <button onclick="closeMedicalHistoryModal()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                        </div>
                        
                        <div class="p-6">
                            <!-- ç—…äººåŸºæœ¬è³‡è¨Š -->
                            <div id="medicalHistoryPatientInfo" class="bg-blue-50 rounded-lg p-4 mb-6">
                                <!-- ç—…äººè³‡è¨Šæœƒå‹•æ…‹è¼‰å…¥ -->
                            </div>
                            
                            <!-- è¨ºç—‡è¨˜éŒ„åˆ—è¡¨ -->
                            <div id="medicalHistoryContent">
                                <!-- è¨ºç—‡è¨˜éŒ„æœƒå‹•æ…‹è¼‰å…¥ -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è¨ºç—‡è¡¨å–®å€åŸŸ -->
                <div id="consultationForm" class="hidden bg-white border border-gray-200 rounded-lg mt-6">
                    <div class="bg-green-600 text-white px-6 py-4 rounded-t-lg">
                        <h3 class="text-xl font-bold">è¨ºç—‡è¨˜éŒ„</h3>
                    </div>
                    
                    <div class="p-6">
                        <!-- ç—…äººè³‡è¨Š -->
                        <div class="bg-blue-50 rounded-lg p-4 mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="font-medium">ç—…äººï¼š</span>
                                    <span id="formPatientName" class="text-blue-600 font-semibold"></span>
                                </div>
                                <div>
                                    <span class="font-medium">æ›è™Ÿæ™‚é–“ï¼š</span>
                                    <span id="formAppointmentTime"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- è¨ºç—‡è¡¨å–® -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- å·¦å´ -->
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        ä¸»è¨´ *
                                    </label>
                                    <textarea id="formSymptoms" placeholder="ç—…äººä¸»è¦ä¸é©ç—‡ç‹€ã€ç™¼ç—…æ™‚é–“ã€ç—‡ç‹€ç‰¹é»ç­‰..." rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        èˆŒè±¡
                                    </label>
                                    <textarea id="formTongue" placeholder="èˆŒè³ªã€èˆŒè‹”ã€èˆŒå½¢ç­‰..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        è„ˆè±¡
                                    </label>
                                    <textarea id="formPulse" placeholder="è„ˆä½ã€è„ˆç‡ã€è„ˆåŠ›ã€è„ˆå½¢ç­‰..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        ç¾ç—…å²
                                    </label>
                                    <textarea id="formCurrentHistory" placeholder="ç™¼ç—…ç¶“éã€ç—‡ç‹€è®ŠåŒ–ã€æ²»ç™‚ç¶“éç­‰..." rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        ä¸­é†«è¨ºæ–· *
                                    </label>
                                    <textarea id="formDiagnosis" placeholder="ä¸­é†«ç—…åè¨ºæ–·..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        è­‰å‹è¨ºæ–·
                                    </label>
                                    <textarea id="formSyndrome" placeholder="è¾¨è­‰åˆ†å‹ã€ç—…æ©Ÿåˆ†æ..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        é‡ç¸å‚™è¨»
                                    </label>
                                    <textarea id="formAcupunctureNotes" placeholder="é‡ç¸ç©´ä½ã€æ‰‹æ³•ã€æ³¨æ„äº‹é …ç­‰..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                            </div>
                            
                            <!-- å³å´ -->
                            <div class="space-y-4">
                                
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="block text-sm font-semibold text-gray-700">
                                            è™•æ–¹å…§å®¹
                                        </label>
                                        <button type="button" onclick="loadPreviousPrescription()" 
                                                class="text-xs bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded transition duration-200">
                                            ğŸ“‹ è¼‰å…¥ä¸Šæ¬¡è™•æ–¹
                                        </button>
                                    </div>
                                    
                                    <!-- ä¸­è—¥åº«æœç´¢å€åŸŸ -->
                                    <div class="mb-3 bg-yellow-50 rounded-lg p-3 border border-yellow-200">
                                        <div class="flex items-center mb-2">
                                            <span class="text-sm font-medium text-yellow-800 mr-2">ğŸ” æœç´¢ä¸­è—¥åº«ï¼š</span>
                                            <div class="flex-1 relative">
                                                <input type="text" id="prescriptionSearch" placeholder="æœç´¢ä¸­è—¥ææˆ–æ–¹åŠ‘åç¨±..." 
                                                       class="w-full border border-yellow-300 rounded px-3 py-1 text-sm focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                                       oninput="searchHerbsForPrescription()">
                                                <button onclick="clearPrescriptionSearch()" class="absolute right-2 top-1 text-gray-400 hover:text-gray-600 text-sm">Ã—</button>
                                            </div>
                                        </div>
                                        
                                        <!-- æœç´¢çµæœ -->
                                        <div id="prescriptionSearchResults" class="hidden">
                                            <div class="bg-white rounded border border-yellow-200 max-h-48 overflow-y-auto">
                                                <div id="prescriptionSearchList" class="grid grid-cols-1 md:grid-cols-2 gap-2 p-2">
                                                    <!-- æœç´¢çµæœæœƒå‹•æ…‹è¼‰å…¥ -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- å·²é¸æ“‡çš„è™•æ–¹å…§å®¹ -->
                                    <div class="border border-gray-300 rounded-lg p-3 min-h-[120px] bg-gray-50">
                                        <div id="selectedPrescriptionItems" class="space-y-2">
                                            <div class="text-sm text-gray-500 text-center py-4">
                                                è«‹ä½¿ç”¨ä¸Šæ–¹æœç´¢åŠŸèƒ½æ·»åŠ ä¸­è—¥ææˆ–æ–¹åŠ‘
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- æœè—¥å¤©æ•¸åŠæ¬¡æ•¸è¨­å®šï¼ˆåªåœ¨æœ‰è™•æ–¹å…§å®¹æ™‚é¡¯ç¤ºï¼‰ -->
                                    <div id="medicationSettings" class="mt-3 bg-yellow-50 rounded-lg p-3 border border-yellow-200" style="display: none;">
                                        <div class="space-y-3">
                                            <!-- æœè—¥å¤©æ•¸ -->
                                            <div class="flex items-center justify-between">
                                                <span class="text-sm font-medium text-yellow-800">æœè—¥å¤©æ•¸</span>
                                                <div class="flex items-center space-x-2">
                                                    <button onclick="updateMedicationDays(-1)" class="w-7 h-7 bg-yellow-500 text-white rounded-full text-sm hover:bg-yellow-600 transition duration-200">-</button>
                                                    <input type="number" id="medicationDays" value="5" min="1" max="30" 
                                                           class="w-14 px-2 py-1 text-center border border-yellow-300 rounded focus:ring-2 focus:ring-yellow-500 focus:border-transparent text-sm"
                                                           onchange="updateMedicationDaysFromInput()" onclick="this.select()">
                                                    <button onclick="updateMedicationDays(1)" class="w-7 h-7 bg-yellow-500 text-white rounded-full text-sm hover:bg-yellow-600 transition duration-200">+</button>
                                                    <span class="text-sm text-yellow-800">å¤©</span>
                                                </div>
                                            </div>
                                            
                                            <!-- æœè—¥æ¬¡æ•¸ -->
                                            <div class="flex items-center justify-between">
                                                <span class="text-sm font-medium text-yellow-800">æ¯æ—¥æ¬¡æ•¸</span>
                                                <div class="flex items-center space-x-2">
                                                    <button onclick="updateMedicationFrequency(-1)" class="w-7 h-7 bg-yellow-500 text-white rounded-full text-sm hover:bg-yellow-600 transition duration-200">-</button>
                                                    <input type="number" id="medicationFrequency" value="2" min="1" max="6" 
                                                           class="w-14 px-2 py-1 text-center border border-yellow-300 rounded focus:ring-2 focus:ring-yellow-500 focus:border-transparent text-sm"
                                                           onchange="updateMedicationFrequency(0)" onclick="this.select()">
                                                    <button onclick="updateMedicationFrequency(1)" class="w-7 h-7 bg-yellow-500 text-white rounded-full text-sm hover:bg-yellow-600 transition duration-200">+</button>
                                                    <span class="text-sm text-yellow-800">æ¬¡/æ—¥</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- éš±è—çš„æ–‡æœ¬åŸŸç”¨æ–¼å­˜å„²è™•æ–¹å…§å®¹ -->
                                    <textarea id="formPrescription" class="hidden"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        æœç”¨æ–¹æ³•
                                    </label>
                                    <textarea id="formUsage" placeholder="ç…ç…®æ–¹æ³•ã€æœç”¨æ™‚é–“ã€åŠ‘é‡ç­‰..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="block text-sm font-semibold text-gray-700">
                                            æ”¶è²»é …ç›®
                                        </label>
                                        <button type="button" onclick="loadPreviousBillingItems()" 
                                                class="text-xs bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded transition duration-200">
                                            ğŸ’° è¼‰å…¥ä¸Šæ¬¡æ”¶è²»
                                        </button>
                                    </div>
                                    
                                    <!-- æ”¶è²»é …ç›®æœç´¢å€åŸŸ -->
                                    <div class="mb-3 bg-green-50 rounded-lg p-3 border border-green-200">
                                        <div class="flex items-center mb-2">
                                            <span class="text-sm font-medium text-green-800 mr-2">ğŸ’° é¸æ“‡æ”¶è²»é …ç›®ï¼š</span>
                                            <div class="flex-1 relative">
                                                <input type="text" id="billingSearch" placeholder="æœç´¢æ”¶è²»é …ç›®åç¨±..." 
                                                       class="w-full border border-green-300 rounded px-3 py-1 text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                       oninput="searchBillingForConsultation()">
                                                <button onclick="clearBillingSearch()" class="absolute right-2 top-1 text-gray-400 hover:text-gray-600 text-sm">Ã—</button>
                                            </div>
                                        </div>
                                        
                                        <!-- æœç´¢çµæœ -->
                                        <div id="billingSearchResults" class="hidden">
                                            <div class="bg-white rounded border border-green-200 max-h-48 overflow-y-auto">
                                                <div id="billingSearchList" class="grid grid-cols-1 md:grid-cols-2 gap-2 p-2">
                                                    <!-- æœç´¢çµæœæœƒå‹•æ…‹è¼‰å…¥ -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- å·²é¸æ“‡çš„æ”¶è²»é …ç›® -->
                                    <div class="border border-gray-300 rounded-lg p-3 min-h-[80px] bg-gray-50">
                                        <div id="selectedBillingItems" class="space-y-2">
                                            <div class="text-sm text-gray-500 text-center py-4">
                                                è«‹ä½¿ç”¨ä¸Šæ–¹æœç´¢åŠŸèƒ½æ·»åŠ æ”¶è²»é …ç›®
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- ç¸½è²»ç”¨é¡¯ç¤º -->
                                    <div class="mt-2 text-right">
                                        <span class="text-sm font-medium text-gray-700">ç¸½è²»ç”¨ï¼š</span>
                                        <span id="totalBillingAmount" class="text-lg font-bold text-green-600">$0</span>
                                    </div>
                                    
                                    <!-- éš±è—çš„æ–‡æœ¬åŸŸç”¨æ–¼å­˜å„²æ”¶è²»é …ç›® -->
                                    <textarea id="formBillingItems" class="hidden"></textarea>

                                    <!-- ç—…äººå¥—ç¥¨ç®¡ç† -->
                                    <div class="mt-4 border border-purple-200 rounded-lg p-3 bg-purple-50">
                                      <div class="flex items-center justify-between mb-2">
                                        <div class="text-sm font-semibold text-purple-800">ğŸ« ç—…äººå¥—ç¥¨</div>
                                        <button type="button" onclick="refreshPatientPackagesUI()"
                                                class="text-xs px-2 py-1 bg-purple-600 text-white rounded">åˆ·æ–°</button>
                                      </div>
                                      <div id="patientPackagesList" class="space-y-2 text-sm text-gray-700">
                                        <!-- å‹•æ…‹è¼‰å…¥ -->
                                        <div class="text-gray-500">å°šæœªè¼‰å…¥æˆ–ç„¡å¥—ç¥¨</div>
                                      </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        ç™‚ç¨‹
                                    </label>
                                    <input type="text" id="formTreatmentCourse" placeholder="ä¾‹ï¼š7å¤©ã€2é€±ã€1å€‹æœˆç­‰..." class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        é†«å›‘åŠæ³¨æ„äº‹é …
                                    </label>
                                    <textarea id="formInstructions" placeholder="é£²é£Ÿå®œå¿Œã€ç”Ÿæ´»èª¿è­·ã€æ³¨æ„äº‹é …ç­‰..." rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- è¤‡è¨ºæ™‚é–“åŠå…¶ä»–æ™‚é–“è¨­å®š -->
                        <div class="mt-6 pt-4 border-t border-gray-200">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        è¤‡è¨ºæ™‚é–“
                                    </label>
                                    <input type="datetime-local" id="formFollowUpDate" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">å»ºè­°ç—…äººä¸‹æ¬¡å›è¨ºçš„æ™‚é–“</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        åˆ°è¨ºæ™‚é–“
                                    </label>
                                    <input type="datetime-local" id="formVisitTime" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">å¯¦éš›åˆ°è¨ºçš„æ™‚é–“ï¼ˆç”¨æ–¼è­‰æ˜æ›¸ï¼‰</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        å»ºè­°ä¼‘æ¯æœŸé–“
                                    </label>
                                    <div class="space-y-2">
                                        <div class="flex items-center space-x-2">
                                            <label class="text-xs text-gray-600 w-12">é–‹å§‹ï¼š</label>
                                            <input type="date" id="formRestStartDate" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" onchange="updateRestPeriod()">
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <label class="text-xs text-gray-600 w-12">çµæŸï¼š</label>
                                            <input type="date" id="formRestEndDate" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" onchange="updateRestPeriod()">
                                        </div>
                                        <div class="text-center">
                                            <span id="restPeriodDisplay" class="text-sm text-gray-500 font-medium">è«‹é¸æ“‡é–‹å§‹å’ŒçµæŸæ—¥æœŸ</span>
                                        </div>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">ç”¨æ–¼ç—…å‡è­‰æ˜æ›¸çš„å»ºè­°ä¼‘æ¯æœŸé–“</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ“ä½œæŒ‰éˆ• -->
                        <div class="flex justify-end space-x-3 mt-6 pt-4 border-t border-gray-200">
                            <button onclick="cancelConsultation()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                                å–æ¶ˆè¨ºç—‡
                            </button>
                            <button onclick="saveConsultation()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200">
                                <span id="consultationSaveButtonText">å®Œæˆè¨ºç—‡</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¸­è—¥åº«ç®¡ç† -->
            <div id="herbLibrary" class="hidden bg-white rounded-xl shadow-lg p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">ä¸­è—¥åº«ç®¡ç†</h2>
                    <div class="flex flex-col md:flex-row gap-3">
                        <div class="relative">
                            <input type="text" id="searchHerb" placeholder="æœå°‹ä¸­è—¥ææˆ–æ–¹åŠ‘åç¨±..." class="border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:ring-2 focus:ring-green-500 focus:border-transparent w-full md:w-64">
                            <span class="absolute right-3 top-2.5 text-gray-400">ğŸ”</span>
                        </div>
                        <button onclick="showAddHerbForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200 whitespace-nowrap">
                            + æ–°å¢ä¸­è—¥æ
                        </button>
                        <button onclick="showAddFormulaForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200 whitespace-nowrap">
                            + æ–°å¢æ–¹åŠ‘
                        </button>
                    </div>
                </div>

                <!-- åˆ†é¡æ¨™ç±¤ -->
                <div class="mb-6">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterHerbLibrary('all')" id="filter-all" class="px-4 py-2 rounded-lg text-sm font-medium bg-blue-100 text-blue-800 transition duration-200">
                            å…¨éƒ¨
                        </button>
                        <button onclick="filterHerbLibrary('herb')" id="filter-herb" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            ä¸­è—¥æ
                        </button>
                        <button onclick="filterHerbLibrary('formula')" id="filter-formula" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            æ–¹åŠ‘
                        </button>
                    </div>
                </div>

                <!-- æ–°å¢/ç·¨è¼¯ä¸­è—¥æè¡¨å–®å½ˆçª— -->
                <div id="addHerbModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                            <h3 id="herbFormTitle" class="text-xl font-bold text-gray-800">æ–°å¢ä¸­è—¥æ</h3>
                            <button onclick="hideAddHerbForm()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ä¸­è—¥æåç¨± *</label>
                                    <input type="text" id="herbName" placeholder="è«‹è¼¸å…¥ä¸­è—¥æåç¨±" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">åˆ¥å</label>
                                    <input type="text" id="herbAlias" placeholder="å…¶ä»–åç¨±æˆ–åˆ¥å" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">æ€§å‘³</label>
                                    <input type="text" id="herbNature" placeholder="ä¾‹ï¼šç”˜ã€å¾®è‹¦ï¼Œæº«" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">æ­¸ç¶“</label>
                                    <input type="text" id="herbMeridian" placeholder="ä¾‹ï¼šè‚ºã€è„¾ã€è…ç¶“" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">åŠŸæ•ˆ</label>
                                    <textarea id="herbEffects" placeholder="è«‹æè¿°ä¸»è¦åŠŸæ•ˆ" rows="2" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ä¸»æ²»</label>
                                    <textarea id="herbIndications" placeholder="è«‹æè¿°ä¸»è¦æ²»ç™‚ç¯„åœ" rows="2" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">å¸¸ç”¨åŠ‘é‡</label>
                                    <input type="text" id="herbDosage" placeholder="ä¾‹ï¼š3-9g" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ä½¿ç”¨æ³¨æ„</label>
                                    <input type="text" id="herbCautions" placeholder="ç¦å¿Œæˆ–æ³¨æ„äº‹é …" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-gray-200">
                                <button onclick="hideAddHerbForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                                    å–æ¶ˆ
                                </button>
                                <button onclick="saveHerb()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200">
                                    <span id="herbSaveButtonText">å„²å­˜</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ–°å¢/ç·¨è¼¯æ–¹åŠ‘è¡¨å–®å½ˆçª— -->
                <div id="addFormulaModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                            <h3 id="formulaFormTitle" class="text-xl font-bold text-gray-800">æ–°å¢æ–¹åŠ‘</h3>
                            <button onclick="hideAddFormulaForm()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">æ–¹åŠ‘åç¨± *</label>
                                        <input type="text" id="formulaName" placeholder="è«‹è¼¸å…¥æ–¹åŠ‘åç¨±" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">å‡ºè™•</label>
                                        <input type="text" id="formulaSource" placeholder="ä¾‹ï¼šå‚·å¯’è«–ã€é‡‘åŒ±è¦ç•¥" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">åŠŸæ•ˆ</label>
                                        <textarea id="formulaEffects" placeholder="è«‹æè¿°æ–¹åŠ‘ä¸»è¦åŠŸæ•ˆ" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">ä¸»æ²»</label>
                                        <textarea id="formulaIndications" placeholder="è«‹æè¿°ä¸»è¦æ²»ç™‚ç—…ç—‡" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                    </div>
                                </div>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">çµ„æˆ *</label>
                                        <textarea id="formulaComposition" placeholder="è«‹è¼¸å…¥æ–¹åŠ‘çµ„æˆï¼Œä¾‹å¦‚ï¼š&#10;äººåƒ&#10;ç™½æœ®&#10;èŒ¯è‹“&#10;ç”˜è‰" rows="8" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">ç”¨æ³•</label>
                                        <textarea id="formulaUsage" placeholder="ç…ç…®æ–¹æ³•ã€æœç”¨æ–¹å¼ç­‰" rows="2" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">æ³¨æ„äº‹é …</label>
                                        <textarea id="formulaCautions" placeholder="ç¦å¿Œã€æ³¨æ„äº‹é …ç­‰" rows="2" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-gray-200">
                                <button onclick="hideAddFormulaForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                                    å–æ¶ˆ
                                </button>
                                <button onclick="saveFormula()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition duration-200">
                                    <span id="formulaSaveButtonText">å„²å­˜</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ä¸­è—¥åº«åˆ—è¡¨ -->
                <div class="overflow-x-auto">
                    <div id="herbLibraryList" class="space-y-4">
                        <!-- ä¸­è—¥åº«å…§å®¹æœƒå‹•æ…‹è¼‰å…¥ -->
                    </div>
                </div>
            </div>

            <!-- æ”¶è²»é …ç›®ç®¡ç† -->
            <div id="billingManagement" class="hidden bg-white rounded-xl shadow-lg p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">æ”¶è²»é …ç›®ç®¡ç†</h2>
                    <div class="flex flex-col md:flex-row gap-3">
                        <div class="relative">
                            <input type="text" id="searchBilling" placeholder="æœå°‹æ”¶è²»é …ç›®åç¨±..." class="border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:ring-2 focus:ring-green-500 focus:border-transparent w-full md:w-64">
                            <span class="absolute right-3 top-2.5 text-gray-400">ğŸ”</span>
                        </div>
                        <button onclick="showAddBillingItemForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200 whitespace-nowrap">
                            + æ–°å¢æ”¶è²»é …ç›®
                        </button>
                    </div>
                </div>

                <!-- åˆ†é¡æ¨™ç±¤ -->
                <div class="mb-6">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterBillingItems('all')" id="billing-filter-all" class="px-4 py-2 rounded-lg text-sm font-medium bg-blue-100 text-blue-800 transition duration-200">
                            å…¨éƒ¨
                        </button>
                        <button onclick="filterBillingItems('consultation')" id="billing-filter-consultation" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            è¨ºç™‚è²»
                        </button>
                        <button onclick="filterBillingItems('medicine')" id="billing-filter-medicine" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            è—¥è²»
                        </button>
                        <button onclick="filterBillingItems('treatment')" id="billing-filter-treatment" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            æ²»ç™‚è²»
                        </button>
                        <button onclick="filterBillingItems('other')" id="billing-filter-other" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            å…¶ä»–
                        </button>
                        <button onclick="filterBillingItems('discount')" id="billing-filter-discount" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            æŠ˜æ‰£é …ç›®
                        </button>
                        <button onclick="filterBillingItems('package')" id="billing-filter-package" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            å¥—ç¥¨é …ç›®
                        </button>
                    </div>
                </div>

                <!-- æ–°å¢/ç·¨è¼¯æ”¶è²»é …ç›®è¡¨å–®å½ˆçª— -->
                <div id="addBillingItemModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                            <h3 id="billingItemFormTitle" class="text-xl font-bold text-gray-800">æ–°å¢æ”¶è²»é …ç›®</h3>
                            <button onclick="hideAddBillingItemForm()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">é …ç›®åç¨± *</label>
                                    <input type="text" id="billingItemName" placeholder="è«‹è¼¸å…¥æ”¶è²»é …ç›®åç¨±" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">é …ç›®é¡åˆ¥ *</label>
                                    <select id="billingItemCategory" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                        <option value="">è«‹é¸æ“‡é¡åˆ¥</option>
                                        <option value="consultation">è¨ºç™‚è²»</option>
                                        <option value="medicine">è—¥è²»</option>
                                        <option value="treatment">æ²»ç™‚è²»</option>
                                        <option value="other">å…¶ä»–</option>
                                        <option value="discount">æŠ˜æ‰£é …ç›®</option>
                                        <option value="package">å¥—ç¥¨é …ç›®</option>
                                    </select>
                                </div>
                                <!-- å¥—ç¥¨å°ˆç”¨æ¬„ä½ï¼šç•¶é¡åˆ¥é¸æ“‡ package æ™‚é¡¯ç¤º -->
                                <div id="packageFields" class="md:col-span-2 hidden">
                                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                      <label class="block text-sm font-medium text-gray-700 mb-1">å¥—ç¥¨å¯ç”¨æ¬¡æ•¸ *</label>
                                      <input type="number" id="billingItemPackageUses" placeholder="ä¾‹å¦‚ï¼š10" min="1"
                                             class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    </div>
                                    <div>
                                      <label class="block text-sm font-medium text-gray-700 mb-1">æœ‰æ•ˆå¤©æ•¸ *</label>
                                      <input type="number" id="billingItemValidityDays" placeholder="ä¾‹å¦‚ï¼š180ï¼ˆåŠå¹´ï¼‰" min="1"
                                             class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                      <p class="text-xs text-gray-500 mt-1">è‡ªè³¼è²·æ—¥èµ·ç®—</p>
                                    </div>
                                  </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">æ”¶è²»é‡‘é¡ *</label>
                                    <input type="number" id="billingItemPrice" placeholder="0" step="1" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">æŠ˜æ‰£é …ç›®ï¼šè¼¸å…¥0.9è¡¨ç¤º9æŠ˜ï¼Œè¼¸å…¥9æœƒè‡ªå‹•è½‰ç‚º9æŠ˜ï¼Œæˆ–è¼¸å…¥è² æ•¸è¡¨ç¤ºå›ºå®šé‡‘é¡æŠ˜æ‰£</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">è¨ˆè²»å–®ä½</label>
                                    <input type="text" id="billingItemUnit" placeholder="ä¾‹ï¼šæ¬¡ã€åŠ‘ã€åŒ…" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">é …ç›®èªªæ˜</label>
                                    <textarea id="billingItemDescription" placeholder="è«‹æè¿°æ”¶è²»é …ç›®çš„è©³ç´°å…§å®¹" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="billingItemActive" checked class="mr-2 rounded">
                                        <span class="text-sm font-medium text-gray-700">å•Ÿç”¨æ­¤æ”¶è²»é …ç›®</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-gray-200">
                                <button onclick="hideAddBillingItemForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                                    å–æ¶ˆ
                                </button>
                                <button onclick="saveBillingItem()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200">
                                    <span id="billingItemSaveButtonText">å„²å­˜</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ”¶è²»é …ç›®åˆ—è¡¨ -->
                <div class="overflow-x-auto">
                    <div id="billingItemsList" class="space-y-4">
                        <!-- æ”¶è²»é …ç›®å…§å®¹æœƒå‹•æ…‹è¼‰å…¥ -->
                    </div>
                </div>
            </div>

            <!-- è¨ºæ‰€ç”¨æˆ¶ç®¡ç† -->
            <div id="userManagement" class="hidden bg-white rounded-xl shadow-lg p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">è¨ºæ‰€ç”¨æˆ¶ç®¡ç†</h2>
                    <div class="flex flex-col md:flex-row gap-3">
                        <div class="relative">
                            <input type="text" id="searchUser" placeholder="æœå°‹ç”¨æˆ¶åç¨±æˆ–é›»å­éƒµä»¶..." class="border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:ring-2 focus:ring-green-500 focus:border-transparent w-full md:w-64">
                            <span class="absolute right-3 top-2.5 text-gray-400">ğŸ”</span>
                        </div>
                        <button onclick="showAddUserForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200 whitespace-nowrap">
                            + æ–°å¢ç”¨æˆ¶
                        </button>
                    </div>
                </div>

                <!-- ç‹€æ…‹ç¯©é¸æ¨™ç±¤ -->
                <div class="mb-6">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterUsers('all')" id="user-filter-all" class="px-4 py-2 rounded-lg text-sm font-medium bg-blue-100 text-blue-800 transition duration-200">
                            å…¨éƒ¨ç”¨æˆ¶
                        </button>
                        <button onclick="filterUsers('inactive')" id="user-filter-inactive" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            å·²åœç”¨
                        </button>
                    </div>
                </div>

                <!-- æ–°å¢/ç·¨è¼¯ç”¨æˆ¶è¡¨å–®å½ˆçª— -->
                <div id="addUserModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                            <h3 id="userFormTitle" class="text-xl font-bold text-gray-800">æ–°å¢ç”¨æˆ¶</h3>
                            <button onclick="hideAddUserForm()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- å¸³è™Ÿèˆ‡å¯†ç¢¼æ¬„ä½å·²ç§»é™¤ï¼Œç³»çµ±å°‡è‡ªå‹•ä½¿ç”¨ Firebase UID æˆ–é›»å­éƒµä»¶ç”¢ç”Ÿè­˜åˆ¥åç¨± -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">å§“å *</label>
                                    <input type="text" id="userDisplayName" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">è·ä½ *</label>
                                    <select id="userPosition" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent" onchange="toggleRegistrationNumberField()">
                                        <option value="">è«‹é¸æ“‡è·ä½</option>
                                        <option value="è¨ºæ‰€ç®¡ç†">è¨ºæ‰€ç®¡ç†</option>
                                        <option value="é†«å¸«">é†«å¸«</option>
                                        <option value="è­·ç†å¸«">è­·ç†å¸«</option>
                                    </select>
                                </div>
                                <div id="registrationNumberField" class="hidden">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ä¸­é†«è¨»å†Šç·¨è™Ÿ *</label>
                                    <input type="text" id="userRegistrationNumber" placeholder="è«‹è¼¸å…¥ä¸­é†«è¨»å†Šç·¨è™Ÿ" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">é†«å¸«è·ä½å¿…é ˆå¡«å¯«è¨»å†Šç·¨è™Ÿ</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">é›»å­éƒµä»¶</label>
                                    <input type="email" id="userEmail" placeholder="è«‹è¼¸å…¥é›»å­éƒµä»¶" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">é›»è©±è™Ÿç¢¼</label>
                                    <input type="tel" id="userPhone" placeholder="è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <!-- Firebase UID æ¬„ä½ -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Firebase UID</label>
                                    <input type="text" id="userUID" placeholder="è«‹è¼¸å…¥ Firebase UIDï¼ˆå¯ä¸å¡«ï¼‰" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">å°æ‡‰ Firebase Authentication å¸³è™Ÿçš„ UID</p>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="userActive" checked class="mr-2 rounded">
                                        <span class="text-sm font-medium text-gray-700">å•Ÿç”¨æ­¤ç”¨æˆ¶å¸³è™Ÿ</span>
                                    </label>
                                    <p class="text-xs text-gray-500 mt-1">åœç”¨çš„å¸³è™Ÿå°‡ç„¡æ³•ç™»å…¥ç³»çµ±</p>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-gray-200">
                                <button onclick="hideAddUserForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                                    å–æ¶ˆ
                                </button>
                                <button onclick="saveUser()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200">
                                    <span id="userSaveButtonText">å„²å­˜</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç”¨æˆ¶åˆ—è¡¨ -->
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">å§“å</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">è·ä½</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">è¨»å†Šç·¨è™Ÿ</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">é›»å­éƒµä»¶</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ç‹€æ…‹</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">æœ€å¾Œç™»å…¥</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="userList" class="divide-y divide-gray-200">
                            <!-- ç”¨æˆ¶è³‡æ–™æœƒå‹•æ…‹è¼‰å…¥ -->
                        </tbody>
                    </table>
                </div>
            </div>

<!-- è²¡å‹™å ±è¡¨ -->
            <div id="financialReports" class="hidden bg-white rounded-xl shadow-lg p-6">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2 flex items-center">
                        <span class="mr-3">ğŸ“Š</span>è²¡å‹™å ±è¡¨
                    </h2>
                    <p class="text-gray-600">è¨ºæ‰€æ”¶å…¥åˆ†æèˆ‡è²¡å‹™çµ±è¨ˆ</p>
                </div>

                <!-- ç¯©é¸æ§åˆ¶å€ -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å ±è¡¨é¡å‹</label>
                            <select id="reportType" onchange="generateFinancialReport()" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="daily">æ—¥å ±è¡¨</option>
                                <option value="weekly">é€±å ±è¡¨</option>
                                <option value="monthly" selected>æœˆå ±è¡¨</option>
                                <option value="yearly">å¹´å ±è¡¨</option>
                                <option value="custom">è‡ªè¨‚æœŸé–“</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å¿«é€Ÿé¸æ“‡</label>
                            <select id="quickDate" onchange="setQuickDate()" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="">è«‹é¸æ“‡...</option>
                                <option value="today">ä»Šå¤©</option>
                                <option value="yesterday">æ˜¨å¤©</option>
                                <option value="thisWeek">æœ¬é€±</option>
                                <option value="lastWeek">ä¸Šé€±</option>
                                <option value="thisMonth">æœ¬æœˆ</option>
                                <option value="lastMonth">ä¸Šæœˆ</option>
                                <option value="thisYear">ä»Šå¹´</option>
                                <option value="lastYear">å»å¹´</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">é–‹å§‹æ—¥æœŸ</label>
                            <input type="date" id="startDate" onchange="generateFinancialReport()" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">çµæŸæ—¥æœŸ</label>
                            <input type="date" id="endDate" onchange="generateFinancialReport()" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">é†«å¸«ç¯©é¸</label>
                            <select id="doctorFilter" onchange="generateFinancialReport()" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="">å…¨éƒ¨é†«å¸«</option>
                            </select>
                        </div>
                        
                        <div class="flex items-end space-x-2">
                            <button onclick="generateFinancialReport()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200 flex items-center">
                                <span class="mr-2">ğŸ”„</span>æ›´æ–°å ±è¡¨
                            </button>
                            <button onclick="exportFinancialReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition duration-200 flex items-center">
                                <span class="mr-2">ğŸ“¥</span>åŒ¯å‡º
                            </button>
                        </div>
                    </div>
                </div>

                <!-- é—œéµæŒ‡æ¨™å¡ç‰‡ -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gradient-to-r from-green-400 to-green-600 text-white rounded-xl p-6 shadow-lg transform hover:scale-105 transition duration-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100 text-sm font-medium">ç¸½æ”¶å…¥</p>
                                <h3 id="totalRevenue" class="text-3xl font-bold">$0</h3>
                                <p id="revenueChange" class="text-green-100 text-sm mt-1">çµ±è¨ˆæœŸé–“æ”¶å…¥</p>
                            </div>
                            <div class="bg-white bg-opacity-20 rounded-full p-3">
                                <span class="text-2xl">ğŸ’°</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-blue-400 to-blue-600 text-white rounded-xl p-6 shadow-lg transform hover:scale-105 transition duration-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100 text-sm font-medium">è¨ºç—‡äººæ¬¡</p>
                                <h3 id="totalConsultations" class="text-3xl font-bold">0</h3>
                                <p id="consultationChange" class="text-blue-100 text-sm mt-1">å®Œæˆè¨ºç—‡æ¬¡æ•¸</p>
                            </div>
                            <div class="bg-white bg-opacity-20 rounded-full p-3">
                                <span class="text-2xl">ğŸ‘¥</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-purple-400 to-purple-600 text-white rounded-xl p-6 shadow-lg transform hover:scale-105 transition duration-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100 text-sm font-medium">å¹³å‡æ¶ˆè²»</p>
                                <h3 id="averageRevenue" class="text-3xl font-bold">$0</h3>
                                <p id="averageChange" class="text-purple-100 text-sm mt-1">æ¯æ¬¡è¨ºç—‡å¹³å‡</p>
                            </div>
                            <div class="bg-white bg-opacity-20 rounded-full p-3">
                                <span class="text-2xl">ğŸ“Š</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-orange-400 to-orange-600 text-white rounded-xl p-6 shadow-lg transform hover:scale-105 transition duration-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-orange-100 text-sm font-medium">æ´»èºé†«å¸«</p>
                                <h3 id="activeDoctors" class="text-3xl font-bold">0</h3>
                                <p id="doctorChange" class="text-orange-100 text-sm mt-1">æœ‰è¨ºç—‡çš„é†«å¸«</p>
                            </div>
                            <div class="bg-white bg-opacity-20 rounded-full p-3">
                                <span class="text-2xl">ğŸ‘¨â€âš•ï¸</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è©³ç´°å ±è¡¨ -->
                <div class="bg-white border border-gray-200 rounded-lg">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 rounded-t-lg">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                                <span class="mr-2">ğŸ“‹</span>è©³ç´°è²¡å‹™å ±è¡¨
                            </h3>
                            <div class="text-sm text-gray-600">
                                è³‡æ–™æ›´æ–°æ™‚é–“ï¼š<span id="lastUpdateTime">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ¨™ç±¤é  -->
                    <div class="border-b border-gray-200">
                        <nav class="flex space-x-8 px-6" role="tablist">
                            <button onclick="switchFinancialTab('summary')" id="financialSummaryTab" class="py-4 px-1 border-b-2 border-green-500 text-green-600 font-medium text-sm transition duration-200">
                                æ”¶å…¥æ‘˜è¦
                            </button>
                            <button onclick="switchFinancialTab('daily')" id="financialDailyTab" class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm transition duration-200">
                                æ¯æ—¥æ˜ç´°
                            </button>
                            <button onclick="switchFinancialTab('doctor')" id="financialDoctorTab" class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm transition duration-200">
                                é†«å¸«æ¥­ç¸¾
                            </button>
                            <button onclick="switchFinancialTab('service')" id="financialServiceTab" class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm transition duration-200">
                                æœå‹™åˆ†æ
                            </button>
                        </nav>
                    </div>
                    
                    <!-- æ¨™ç±¤å…§å®¹ -->
                    <div class="p-6">
                        <!-- æ”¶å…¥æ‘˜è¦æ¨™ç±¤ -->
                        <div id="financialSummaryContent" class="financial-tab-content">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">é …ç›®</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">é‡‘é¡</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">ä½”æ¯”</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">å‚™è¨»</th>
                                        </tr>
                                    </thead>
                                    <tbody id="financialSummaryTableBody" class="divide-y divide-gray-200">
                                        <tr>
                                            <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                                                è«‹é»æ“Šã€Œæ›´æ–°å ±è¡¨ã€ä¾†è¼‰å…¥è³‡æ–™
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- æ¯æ—¥æ˜ç´°æ¨™ç±¤ -->
                        <div id="financialDailyContent" class="financial-tab-content hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">æ—¥æœŸ</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">è¨ºç—‡äººæ¬¡</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">æ”¶å…¥é‡‘é¡</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">å¹³å‡æ¶ˆè²»</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ä¸»è¦æœå‹™</th>
                                        </tr>
                                    </thead>
                                    <tbody id="financialDailyTableBody" class="divide-y divide-gray-200">
                                        <tr>
                                            <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                                                è«‹é»æ“Šã€Œæ›´æ–°å ±è¡¨ã€ä¾†è¼‰å…¥è³‡æ–™
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- é†«å¸«æ¥­ç¸¾æ¨™ç±¤ -->
                        <div id="financialDoctorContent" class="financial-tab-content hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">é†«å¸«</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">è¨ºç—‡äººæ¬¡</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">ç¸½æ”¶å…¥</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">å¹³å‡æ¶ˆè²»</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">ä½”æ¯”</th>
                                        </tr>
                                    </thead>
                                    <tbody id="financialDoctorTableBody" class="divide-y divide-gray-200">
                                        <tr>
                                            <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                                                è«‹é»æ“Šã€Œæ›´æ–°å ±è¡¨ã€ä¾†è¼‰å…¥è³‡æ–™
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- æœå‹™åˆ†ææ¨™ç±¤ -->
                        <div id="financialServiceContent" class="financial-tab-content hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">æœå‹™é¡å‹</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">æ¬¡æ•¸</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">ç¸½é‡‘é¡</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">å¹³å‡å–®åƒ¹</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">æ”¶å…¥ä½”æ¯”</th>
                                        </tr>
                                    </thead>
                                    <tbody id="financialServiceTableBody" class="divide-y divide-gray-200">
                                        <tr>
                                            <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                                                è«‹é»æ“Šã€Œæ›´æ–°å ±è¡¨ã€ä¾†è¼‰å…¥è³‡æ–™
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç³»çµ±ç®¡ç† -->
            <div id="systemManagement" class="hidden bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">ç³»çµ±ç®¡ç†</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">è¨ºæ‰€çµ±è¨ˆ</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span>ç¸½ç—…äººæ•¸ï¼š</span>
                                <span id="totalPatients" class="font-semibold">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>ä»Šæ—¥è¨ºç—‡ï¼š</span>
                                <span id="todayConsultations" class="font-semibold">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>æœ¬æœˆè¨ºç—‡ï¼š</span>
                                <span id="monthlyConsultations" class="font-semibold">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">è¨ºæ‰€è¨­å®š</h3>
                        <div class="space-y-3">
                            <div class="text-center py-4" id="clinicSettingsDisplay">
                                <div class="text-sm text-gray-700 mb-3">
                                    <div class="font-medium">è¨ºæ‰€ä¸­æ–‡åç¨±ï¼š<span id="displayChineseName">ä¸­é†«è¨ºæ‰€ç³»çµ±</span></div>
                                    <div class="text-gray-600 mt-1">è¨ºæ‰€è‹±æ–‡åç¨±ï¼š<span id="displayEnglishName">TCM Clinic</span></div>
                                </div>
                                <button onclick="showClinicSettingsModal()" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                    è¨ºæ‰€è³‡æ–™ä¿®æ”¹
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">è³‡æ–™ç®¡ç†</h3>
                        <div class="space-y-3">
                            <button onclick="exportData()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                åŒ¯å‡ºè³‡æ–™
                            </button>
                            <button onclick="backupData()" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                å‚™ä»½è³‡æ–™
                            </button>
                            <button onclick="clearData()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                æ¸…é™¤è³‡æ–™
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¨ºæ‰€è³‡æ–™ä¿®æ”¹å½ˆçª— -->
    <div id="clinicSettingsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                <h3 class="text-xl font-bold text-gray-800">è¨ºæ‰€è³‡æ–™ä¿®æ”¹</h3>
                <button onclick="hideClinicSettingsModal()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
            </div>
            
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">è¨ºæ‰€ä¸­æ–‡åç¨± *</label>
                        <input type="text" id="clinicChineseName" placeholder="è«‹è¼¸å…¥è¨ºæ‰€ä¸­æ–‡åç¨±" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">è¨ºæ‰€è‹±æ–‡åç¨±</label>
                        <input type="text" id="clinicEnglishName" placeholder="è«‹è¼¸å…¥è¨ºæ‰€è‹±æ–‡åç¨±" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">è¨ºæ‰€ç‡Ÿæ¥­æ™‚é–“</label>
                        <input type="text" id="clinicBusinessHours" placeholder="ä¾‹ï¼šé€±ä¸€è‡³é€±äº” 09:00-18:00" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">è¨ºæ‰€é›»è©±</label>
                        <input type="tel" id="clinicPhone" placeholder="è«‹è¼¸å…¥è¨ºæ‰€é›»è©±è™Ÿç¢¼" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">è¨ºæ‰€åœ°å€</label>
                        <textarea id="clinicAddress" placeholder="è«‹è¼¸å…¥è¨ºæ‰€å®Œæ•´åœ°å€" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-gray-200">
                    <button onclick="hideClinicSettingsModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                        å–æ¶ˆ
                    </button>
                    <button onclick="saveClinicSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition duration-200">
                        å„²å­˜
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // ç³»çµ±è³‡æ–™å„²å­˜
        let currentUser = null;
        let currentUserData = null;
        
        // è¨ºæ‰€è¨­å®š
        let clinicSettings = JSON.parse(localStorage.getItem('clinicSettings') || '{}');
        if (!clinicSettings.chineseName) {
            clinicSettings.chineseName = 'ä¸­é†«è¨ºæ‰€ç³»çµ±';
            clinicSettings.englishName = 'TCM Clinic';
            clinicSettings.businessHours = 'é€±ä¸€è‡³é€±äº” 09:00-18:00';
            clinicSettings.phone = '(852) 2345-6789';
            clinicSettings.address = 'é¦™æ¸¯ä¸­ç’°çš‡åå¤§é“ä¸­123è™Ÿ';
            localStorage.setItem('clinicSettings', JSON.stringify(clinicSettings));
        }
        
        // æµ®å‹•æç¤ºåŠŸèƒ½
        function showToast(message, type = 'info') {
            // ç§»é™¤ç¾æœ‰çš„æç¤º
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // å‰µå»ºæ–°çš„æç¤º
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            // è¨­ç½®åœ–æ¨™
            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
                info: 'â„¹ï¸'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-content">${message}</div>
            `;
            
            // æ·»åŠ åˆ°é é¢
            document.body.appendChild(toast);
            
            // é¡¯ç¤ºå‹•ç•«
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // 2ç§’å¾Œæ·¡å‡ºä¸¦ç§»é™¤
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 2000);
        }
        
        // è¨ˆç®—å¹´é½¡å‡½æ•¸
        function calculateAge(birthDate) {
            const birth = new Date(birthDate);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            
            return age;
        }
        
        // æ ¼å¼åŒ–å¹´é½¡é¡¯ç¤º
        function formatAge(birthDate) {
            if (!birthDate) return 'æœªçŸ¥';
            
            const birth = new Date(birthDate);
            const today = new Date();
            
            let years = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                years--;
            }
            
            if (years > 0) {
                return `${years}æ­²`;
            } else {
                // æœªæ»¿ä¸€æ­²çš„å¬°å¹¼å…’é¡¯ç¤ºæœˆæ•¸
                let months = today.getMonth() - birth.getMonth();
                let days = today.getDate() - birth.getDate();
                
                if (days < 0) {
                    months--;
                    const lastMonth = new Date(today.getFullYear(), today.getMonth(), 0);
                    days += lastMonth.getDate();
                }
                
                if (months < 0) {
                    months += 12;
                }
                
                if (months > 0) {
                    return `${months}å€‹æœˆ`;
                } else {
                    return `${days}å¤©`;
                }
            }
        }
        
        // ç”Ÿæˆç—…äººç·¨è™Ÿå‡½æ•¸
        function generatePatientNumber() {
            const existingNumbers = patients
                .map(p => p.patientNumber)
                .filter(num => num && num.startsWith('P'))
                .map(num => parseInt(num.substring(1)))
                .filter(num => !isNaN(num));
            
            const maxNumber = existingNumbers.length > 0 ? Math.max(...existingNumbers) : 0;
            const newNumber = maxNumber + 1;
            return `P${newNumber.toString().padStart(6, '0')}`;
        }

        // é è¨­æ¸¬è©¦ç—…äººè³‡æ–™
        const defaultPatients = [
            {
                id: 1001,
                patientNumber: 'P000001',
                name: 'ç‹å°æ˜',
                gender: 'ç”·',
                phone: '0912-345-678',
                birthDate: '1989-03-15',
                address: 'å°åŒ—å¸‚å¤§å®‰å€ä¿¡ç¾©è·¯å››æ®µ123è™Ÿ',
                history: 'é«˜è¡€å£“ç—…å²3å¹´ï¼Œå¶æœ‰é ­æšˆç—‡ç‹€',
                createdAt: new Date('2024-01-15').toISOString()
            },
            {
                id: 1002,
                patientNumber: 'P000002',
                name: 'æç¾è¯',
                gender: 'å¥³',
                phone: '0923-456-789',
                birthDate: '1996-07-22',
                address: 'æ–°åŒ—å¸‚æ¿æ©‹å€ä¸­å±±è·¯äºŒæ®µ456è™Ÿ',
                history: 'ç¶“å¸¸æ€§å¤±çœ ï¼Œå·¥ä½œå£“åŠ›å¤§',
                createdAt: new Date('2024-01-20').toISOString()
            },
            {
                id: 1003,
                patientNumber: 'P000003',
                name: 'å¼µå¿—å¼·',
                gender: 'ç”·',
                phone: '0934-567-890',
                birthDate: '1982-11-08',
                address: 'æ¡ƒåœ’å¸‚ä¸­å£¢å€ä¸­æ­£è·¯789è™Ÿ',
                history: 'æ…¢æ€§èƒƒç‚ï¼Œé£²é£Ÿä¸è¦å¾‹',
                createdAt: new Date('2024-02-01').toISOString()
            },
            {
                id: 1004,
                patientNumber: 'P000004',
                name: 'é™³é›…å©·',
                gender: 'å¥³',
                phone: '0945-678-901',
                birthDate: '1993-05-12',
                address: 'å°ä¸­å¸‚è¥¿å±¯å€å°ç£å¤§é“ä¸‰æ®µ321è™Ÿ',
                history: 'æœˆç¶“ä¸èª¿ï¼Œç¶“å¸¸è…°é…¸èƒŒç—›',
                createdAt: new Date('2024-02-10').toISOString()
            },
            {
                id: 1005,
                patientNumber: 'P000005',
                name: 'æ—å¤§å‰',
                gender: 'ç”·',
                phone: '0956-789-012',
                birthDate: '1969-12-03',
                address: 'é«˜é›„å¸‚å‰é‡‘å€ä¸­æ­£å››è·¯654è™Ÿ',
                history: 'ç³–å°¿ç—…æ‚£è€…ï¼Œéœ€å®šæœŸè¿½è¹¤è¡€ç³–',
                createdAt: new Date('2024-02-15').toISOString()
            }
        ];

        // åˆå§‹åŒ–ç—…äººè³‡æ–™ï¼ˆå¦‚æœæœ¬åœ°å„²å­˜ç‚ºç©ºå‰‡è¼‰å…¥é è¨­è³‡æ–™ï¼‰
        let patients = JSON.parse(localStorage.getItem('patients') || '[]');
        if (patients.length === 0) {
            patients = defaultPatients;
            localStorage.setItem('patients', JSON.stringify(patients));
        } else {
            // ç‚ºèˆŠè³‡æ–™è£œå……ç—…äººç·¨è™Ÿ
            let needsUpdate = false;
            patients.forEach(patient => {
                if (!patient.patientNumber) {
                    patient.patientNumber = generatePatientNumber();
                    needsUpdate = true;
                }
            });
            if (needsUpdate) {
                localStorage.setItem('patients', JSON.stringify(patients));
            }
        }
        
        // é è¨­è¨ºç—‡è¨˜éŒ„
        const defaultConsultations = [
            {
                id: 2001,
                appointmentId: 3001,
                patientId: 1001,
                symptoms: 'é ­ç—›é ­æšˆï¼Œè¡€å£“åé«˜ï¼Œä¼´æœ‰å¿ƒæ‚¸ï¼Œç¡çœ å“è³ªä¸ä½³',
                tongue: 'èˆŒè³ªç´…ï¼Œè‹”è–„é»ƒ',
                pulse: 'è„ˆå¼¦æ•¸',
                currentHistory: 'æ‚£è€…3å¹´å‰è¨ºæ–·é«˜è¡€å£“ï¼Œå¹³æ™‚è¡€å£“æ§åˆ¶ä¸ç©©å®šï¼Œè¿‘æœŸå·¥ä½œå£“åŠ›å¤§ï¼Œé ­ç—›ç—‡ç‹€åŠ é‡',
                diagnosis: 'çœ©æšˆï¼ˆé«˜è¡€å£“ç—…ï¼‰',
                syndrome: 'è‚é™½ä¸Šäº¢è­‰',
                prescription: 'å¤©éº»é‰¤è—¤é£²åŠ æ¸›\nå¤©éº» 10g\né‰¤è—¤ 15g\nçŸ³æ±ºæ˜ 30g\næ¢”å­ 10g\né»ƒèŠ© 10g\nå·ç‰›è† 15g\næœä»² 15g\nç›Šæ¯è‰ 15g\nå¤œäº¤è—¤ 20g\nèŒ¯ç¥ 15g',
                usage: 'æ°´ç…æœï¼Œæ¯æ—¥ä¸€åŠ‘ï¼Œåˆ†æ—©æ™šå…©æ¬¡æº«æœ',
                treatmentCourse: '7å¤©',
                instructions: 'æ³¨æ„ä¼‘æ¯ï¼Œé¿å…æƒ…ç·’æ¿€å‹•ï¼Œå®šæœŸç›£æ¸¬è¡€å£“ï¼Œé£²é£Ÿæ¸…æ·¡å°‘é¹½',
                followUpDate: '2024-03-01T09:00',
                date: new Date('2024-02-23T10:30').toISOString(),
                doctor: 'drzhang',
                status: 'completed'
            },
            {
                id: 2002,
                appointmentId: 3002,
                patientId: 1002,
                symptoms: 'å¤±çœ å¤šå¤¢ï¼Œå…¥ç¡å›°é›£ï¼Œæ˜“é†’ï¼Œä¼´æœ‰å¿ƒç…©ï¼Œå·¥ä½œå£“åŠ›å¤§',
                tongue: 'èˆŒè³ªæ·¡ç´…ï¼Œè‹”è–„ç™½',
                pulse: 'è„ˆç´°æ•¸',
                currentHistory: 'æ‚£è€…è¿‘åŠå¹´ä¾†å·¥ä½œå£“åŠ›å¢å¤§ï¼Œç¡çœ å“è³ªé€æ¼¸ä¸‹é™ï¼Œæ¯æ™šéœ€1-2å°æ™‚æ‰èƒ½å…¥ç¡',
                diagnosis: 'ä¸å¯ï¼ˆå¤±çœ ç—‡ï¼‰',
                syndrome: 'å¿ƒè…ä¸äº¤è­‰',
                prescription: 'ç”˜éº¥å¤§æ£—æ¹¯åˆäº¤æ³°ä¸¸åŠ æ¸›\nç”˜è‰ 6g\nå°éº¥ 30g\nå¤§æ£— 10æš\né»ƒé€£ 3g\nè‚‰æ¡‚ 1g\né…¸æ£—ä» 20g\né¾éª¨ 15g\nç‰¡è £ 15g\né å¿— 10g\nèŒ¯ç¥ 15g',
                usage: 'æ°´ç…æœï¼Œæ¯æ—¥ä¸€åŠ‘ï¼Œæ™šé¤å¾ŒåŠç¡å‰å„æœä¸€æ¬¡',
                treatmentCourse: '10å¤©',
                instructions: 'ç¡å‰é¿å…ä½¿ç”¨é›»å­ç”¢å“ï¼Œä¿æŒè¦å¾‹ä½œæ¯ï¼Œå¯é©ç•¶é€²è¡Œæ”¾é¬†é‹å‹•',
                followUpDate: '2024-03-05T14:00',
                date: new Date('2024-02-25T14:15').toISOString(),
                doctor: 'drzhang',
                status: 'completed'
            },
            {
                id: 2003,
                appointmentId: 3003,
                patientId: 1003,
                symptoms: 'èƒƒè„˜è„¹ç—›ï¼Œé£Ÿå¾ŒåŠ é‡ï¼Œå™¯æ°£é »ç¹ï¼Œé£Ÿæ…¾ä¸æŒ¯',
                tongue: 'èˆŒè³ªæ·¡ï¼Œè‹”ç™½è†©',
                pulse: 'è„ˆå¼¦æ»‘',
                currentHistory: 'æ‚£è€…æœ‰æ…¢æ€§èƒƒç‚ç—…å²ï¼Œå¹³æ™‚é£²é£Ÿä¸è¦å¾‹ï¼Œå¸¸æœ‰èƒƒè„˜ä¸é©ï¼Œè¿‘æœŸç—‡ç‹€åŠ é‡',
                diagnosis: 'èƒƒç—›ï¼ˆæ…¢æ€§èƒƒç‚ï¼‰',
                syndrome: 'è„¾èƒƒè™›å¼±ï¼Œæ¿•æ»¯ä¸­ç„¦è­‰',
                prescription: 'é¦™ç ‚å…­å›å­æ¹¯åŠ æ¸›\né»¨åƒ 15g\nç™½æœ® 10g\nèŒ¯è‹“ 15g\nç”˜è‰ 6g\né™³çš® 10g\nåŠå¤ 10g\næœ¨é¦™ 6g\nç ‚ä» 6g\næ³æ®¼ 10g\nç¥éº´ 15g',
                usage: 'æ°´ç…æœï¼Œæ¯æ—¥ä¸€åŠ‘ï¼Œé£¯å‰30åˆ†é˜æº«æœ',
                treatmentCourse: '14å¤©',
                instructions: 'è¦å¾‹é£²é£Ÿï¼Œç´°åš¼æ…¢åš¥ï¼Œé¿å…ç”Ÿå†·è¾›è¾£é£Ÿç‰©ï¼Œä¿æŒå¿ƒæƒ…æ„‰å¿«',
                followUpDate: '2024-03-10T10:30',
                date: new Date('2024-02-26T10:45').toISOString(),
                doctor: 'drzhang',
                status: 'completed'
            }
        ];

        let consultations = JSON.parse(localStorage.getItem('consultations') || '[]');
        if (consultations.length === 0) {
            consultations = defaultConsultations;
            localStorage.setItem('consultations', JSON.stringify(consultations));
        }
        
        // é è¨­æ›è™Ÿè¨˜éŒ„
        const defaultAppointments = [
            {
                id: 3001,
                patientId: 1001,
                appointmentTime: new Date('2024-02-23T10:00').toISOString(),
                appointmentDoctor: 'drzhang',
                chiefComplaint: 'é ­ç—›é ­æšˆï¼Œè¡€å£“åé«˜',
                status: 'completed',
                createdAt: new Date('2024-02-22T15:30').toISOString(),
                createdBy: 'nurse_amy',
                arrivedAt: new Date('2024-02-23T09:55').toISOString(),
                confirmedBy: 'nurse_amy',
                consultationStartTime: new Date('2024-02-23T10:30').toISOString(),
                consultingDoctor: 'drzhang',
                completedAt: new Date('2024-02-23T11:15').toISOString(),
                consultationId: 2001,
                completedBy: 'drzhang'
            },
            {
                id: 3002,
                patientId: 1002,
                appointmentTime: new Date('2024-02-25T14:00').toISOString(),
                appointmentDoctor: 'drzhang',
                chiefComplaint: 'å¤±çœ å¤šå¤¢ï¼Œå…¥ç¡å›°é›£',
                status: 'completed',
                createdAt: new Date('2024-02-24T10:20').toISOString(),
                createdBy: 'nurse_amy',
                arrivedAt: new Date('2024-02-25T13:50').toISOString(),
                confirmedBy: 'nurse_amy',
                consultationStartTime: new Date('2024-02-25T14:15').toISOString(),
                consultingDoctor: 'drzhang',
                completedAt: new Date('2024-02-25T15:00').toISOString(),
                consultationId: 2002,
                completedBy: 'drzhang'
            },
            {
                id: 3003,
                patientId: 1003,
                appointmentTime: new Date('2024-02-26T10:30').toISOString(),
                appointmentDoctor: 'drzhang',
                chiefComplaint: 'èƒƒè„˜è„¹ç—›ï¼Œé£Ÿå¾ŒåŠ é‡',
                status: 'completed',
                createdAt: new Date('2024-02-25T16:45').toISOString(),
                createdBy: 'nurse_amy',
                arrivedAt: new Date('2024-02-26T10:25').toISOString(),
                confirmedBy: 'nurse_amy',
                consultationStartTime: new Date('2024-02-26T10:45').toISOString(),
                consultingDoctor: 'drzhang',
                completedAt: new Date('2024-02-26T11:30').toISOString(),
                consultationId: 2003,
                completedBy: 'drzhang'
            }
        ];

        let appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
        if (appointments.length === 0) {
            appointments = defaultAppointments;
            localStorage.setItem('appointments', JSON.stringify(appointments));
        } else {
            // ç‚ºèˆŠè³‡æ–™è£œå……é†«å¸«æ¬„ä½
            let needsUpdate = false;
            appointments.forEach(appointment => {
                if (!appointment.appointmentDoctor) {
                    appointment.appointmentDoctor = 'drzhang'; // é è¨­ç‚ºå¼µé†«å¸«
                    needsUpdate = true;
                }
            });
            if (needsUpdate) {
                localStorage.setItem('appointments', JSON.stringify(appointments));
            }
        }

        // é è¨­ä¸­è—¥æè³‡æ–™
        const defaultHerbs = [
            {
                id: 5001,
                type: 'herb',
                name: 'äººåƒ',
                alias: 'ç´…åƒã€ç™½åƒ',
                nature: 'ç”˜ã€å¾®è‹¦ï¼Œå¾®æº«',
                meridian: 'è„¾ã€è‚ºã€å¿ƒç¶“',
                effects: 'å¤§è£œå…ƒæ°£ï¼Œå¾©è„ˆå›ºè„«ï¼Œè£œè„¾ç›Šè‚ºï¼Œç”Ÿæ´¥å®‰ç¥',
                indications: 'é«”è™›æ¬²è„«ï¼Œè‚¢å†·è„ˆå¾®ï¼Œè„¾è™›é£Ÿå°‘ï¼Œè‚ºè™›å–˜å’³ï¼Œæ´¥å‚·å£æ¸´ï¼Œå…§ç†±æ¶ˆæ¸´ï¼Œä¹…ç—…è™›ç¾¸ï¼Œé©šæ‚¸å¤±çœ ï¼Œé™½ç—¿å®®å†·',
                dosage: '3-9g',
                cautions: 'ä¸å®œèˆ‡è—œè˜†åŒç”¨',
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 5002,
                type: 'herb',
                name: 'ç™½æœ®',
                alias: 'æ–¼æœ®ã€å†¬æœ®',
                nature: 'ç”˜ã€è‹¦ï¼Œæº«',
                meridian: 'è„¾ã€èƒƒç¶“',
                effects: 'å¥è„¾ç›Šæ°£ï¼Œç‡¥æ¿•åˆ©æ°´ï¼Œæ­¢æ±—ï¼Œå®‰èƒ',
                indications: 'è„¾è™›é£Ÿå°‘ï¼Œè…¹è„¹æ³„ç€‰ï¼Œç—°é£²çœ©æ‚¸ï¼Œæ°´è…«ï¼Œè‡ªæ±—ï¼Œèƒå‹•ä¸å®‰',
                dosage: '6-12g',
                cautions: 'é™°è™›ç‡¥æ¸´ï¼Œæ°£æ»¯è„¹æ‚¶è€…å¿Œæœ',
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 5003,
                type: 'herb',
                name: 'èŒ¯è‹“',
                alias: 'ç™½èŒ¯è‹“ã€é›²è‹“',
                nature: 'ç”˜ã€æ·¡ï¼Œå¹³',
                meridian: 'å¿ƒã€è‚ºã€è„¾ã€è…ç¶“',
                effects: 'åˆ©æ°´æ»²æ¿•ï¼Œå¥è„¾ï¼Œå¯§å¿ƒ',
                indications: 'æ°´è…«å°¿å°‘ï¼Œç—°é£²çœ©æ‚¸ï¼Œè„¾è™›é£Ÿå°‘ï¼Œä¾¿æºæ³„ç€‰ï¼Œå¿ƒç¥ä¸å®‰ï¼Œé©šæ‚¸å¤±çœ ',
                dosage: '10-15g',
                cautions: 'è™›å¯’ç²¾æ»‘æˆ–æ°£è™›ä¸‹é™·è€…å¿Œæœ',
                createdAt: new Date('2024-01-01').toISOString()
            }
        ];

        // é è¨­æ–¹åŠ‘è³‡æ–™
        const defaultFormulas = [
            {
                id: 6001,
                type: 'formula',
                name: 'å››å›å­æ¹¯',
                source: 'å¤ªå¹³æƒ æ°‘å’ŒåŠ‘å±€æ–¹',
                effects: 'ç›Šæ°£å¥è„¾',
                indications: 'è„¾èƒƒæ°£è™›ï¼Œé¢è‰²èç™½ï¼Œèªè²ä½å¾®ï¼Œæ°£çŸ­ä¹åŠ›ï¼Œé£Ÿå°‘ä¾¿æºï¼ŒèˆŒæ·¡è‹”ç™½ï¼Œè„ˆè™›å¼±',
                composition: 'äººåƒ\nç™½æœ®\nèŒ¯è‹“\nç”˜è‰',
                usage: 'æ°´ç…æœï¼Œæ¯æ—¥ä¸€åŠ‘ï¼Œåˆ†äºŒæ¬¡æº«æœ',
                cautions: 'é™°è™›ç«æ—ºè€…æ…ç”¨',
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 6002,
                type: 'formula',
                name: 'å…­å›å­æ¹¯',
                source: 'é†«å­¸æ­£å‚³',
                effects: 'ç›Šæ°£å¥è„¾ï¼Œç‡¥æ¿•åŒ–ç—°',
                indications: 'è„¾èƒƒæ°£è™›å…¼æœ‰ç—°æ¿•ï¼Œé£Ÿå°‘ä¾¿æºï¼Œèƒ¸è„˜ç—æ‚¶ï¼Œå˜”é€†ç­‰ç—‡',
                composition: 'äººåƒ\nç™½æœ®\nèŒ¯è‹“\nç”˜è‰\né™³çš®\nåŠå¤',
                usage: 'æ°´ç…æœï¼Œæ¯æ—¥ä¸€åŠ‘ï¼Œåˆ†äºŒæ¬¡æº«æœ',
                cautions: 'é™°è™›ç‡¥å’³ã€æ´¥æ¶²ä¸è¶³è€…å¿Œç”¨',
                createdAt: new Date('2024-01-01').toISOString()
            }
        ];

        // åˆå§‹åŒ–ä¸­è—¥åº«è³‡æ–™
        let herbLibrary = [];
        /**
         * å¾ Firestore è®€å–ä¸­è—¥åº«è³‡æ–™ï¼Œè‹¥è³‡æ–™ä¸å­˜åœ¨å‰‡è‡ªå‹•ä½¿ç”¨é è¨­å€¼åˆå§‹åŒ–ã€‚
         * æ­¤å‡½å¼æœƒç­‰å¾… Firebase åˆå§‹åŒ–å®Œæˆå¾Œå†åŸ·è¡Œã€‚
         */
        async function initHerbLibrary() {
            // ç­‰å¾… Firebase åˆå§‹åŒ–
            while (!window.firebase || !window.firebase.db) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            try {
                // å¾ Firestore å–å¾— herbLibrary é›†åˆè³‡æ–™
                const querySnapshot = await window.firebase.getDocs(
                    window.firebase.collection(window.firebase.db, 'herbLibrary')
                );
                const herbsFromFirestore = [];
                querySnapshot.forEach((docSnap) => {
                    // docSnap.data() å·²åŒ…å« id å±¬æ€§ï¼Œå› æ­¤ç›´æ¥å±•é–‹
                    herbsFromFirestore.push({ ...docSnap.data() });
                });
                if (herbsFromFirestore.length === 0) {
                    // è‹¥ Firestore ä¸­æ²’æœ‰è³‡æ–™ï¼Œä½¿ç”¨é è¨­ä¸­è—¥æèˆ‡æ–¹åŠ‘åˆå§‹åŒ–
                    const combinedDefaults = [...defaultHerbs, ...defaultFormulas];
                    for (const item of combinedDefaults) {
                        await window.firebase.setDoc(
                            window.firebase.doc(window.firebase.db, 'herbLibrary', String(item.id)),
                            item
                        );
                    }
                    herbLibrary = combinedDefaults;
                } else {
                    herbLibrary = herbsFromFirestore;
                }
            } catch (error) {
                console.error('è®€å–/åˆå§‹åŒ–ä¸­è—¥åº«è³‡æ–™å¤±æ•—:', error);
            }
        }

        // é è¨­æ”¶è²»é …ç›®è³‡æ–™
        const defaultBillingItems = [
            // è¨ºç™‚è²»é¡åˆ¥
            {
                id: 4001,
                name: 'è¨ºé‡‘',
                category: 'consultation',
                price: 150,
                unit: 'æ¬¡',
                description: 'ä¸­é†«å¸«è¨ºç—‡è²»ç”¨',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4002,
                name: 'è¤‡è¨ºè²»',
                category: 'consultation',
                price: 120,
                unit: 'æ¬¡',
                description: 'è¤‡è¨ºç—…äººè¨ºç—‡è²»ç”¨',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4003,
                name: 'æ€¥è¨ºè²»',
                category: 'consultation',
                price: 200,
                unit: 'æ¬¡',
                description: 'æ€¥è¨ºæˆ–éè¾¦å…¬æ™‚é–“è¨ºç—‡',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            
            // è—¥è²»é¡åˆ¥
            {
                id: 4011,
                name: 'ä¸­è—¥èª¿åŠ‘è²»',
                category: 'medicine',
                price: 25,
                unit: 'åŠ‘',
                description: 'ä¸­è—¥æèª¿åŠ‘åŠåŒ…è£è²»ç”¨',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4012,
                name: 'æ¿ƒç¸®ä¸­è—¥ç²‰',
                category: 'medicine',
                price: 15,
                unit: 'åŒ…',
                description: 'ç§‘å­¸ä¸­è—¥æ¿ƒç¸®ç²‰åŠ‘',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4013,
                name: 'å¤–ç”¨è—¥è†',
                category: 'medicine',
                price: 80,
                unit: 'æ”¯',
                description: 'ä¸­è—¥å¤–ç”¨è—¥è†',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4014,
                name: 'è—¥é…’',
                category: 'medicine',
                price: 120,
                unit: 'ç“¶',
                description: 'ä¸­è—¥æµ¸è£½è—¥é…’',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            
            // æ²»ç™‚è²»é¡åˆ¥
            {
                id: 4021,
                name: 'é‡ç¸æ²»ç™‚',
                category: 'treatment',
                price: 100,
                unit: 'æ¬¡',
                description: 'é‡ç¸ç©´ä½æ²»ç™‚',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4022,
                name: 'æ¨æ‹¿æŒ‰æ‘©',
                category: 'treatment',
                price: 150,
                unit: 'æ¬¡',
                description: 'ä¸­é†«æ¨æ‹¿æŒ‰æ‘©æ²»ç™‚',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4023,
                name: 'æ‹”ç½æ²»ç™‚',
                category: 'treatment',
                price: 80,
                unit: 'æ¬¡',
                description: 'æ‹”ç½ç™‚æ³•',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4024,
                name: 'åˆ®ç—§æ²»ç™‚',
                category: 'treatment',
                price: 60,
                unit: 'æ¬¡',
                description: 'åˆ®ç—§ç™‚æ³•',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4025,
                name: 'è‰¾ç¸æ²»ç™‚',
                category: 'treatment',
                price: 90,
                unit: 'æ¬¡',
                description: 'è‰¾æ¢ç¸æ³•æ²»ç™‚',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4026,
                name: 'é›»é‡æ²»ç™‚',
                category: 'treatment',
                price: 120,
                unit: 'æ¬¡',
                description: 'é›»é‡åˆºæ¿€æ²»ç™‚',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4027,
                name: 'è€³é‡æ²»ç™‚',
                category: 'treatment',
                price: 70,
                unit: 'æ¬¡',
                description: 'è€³ç©´é‡åˆºæ²»ç™‚',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4028,
                name: 'å°å…’æ¨æ‹¿',
                category: 'treatment',
                price: 100,
                unit: 'æ¬¡',
                description: 'å°å…’æ¨æ‹¿æŒ‰æ‘©',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            
            // å…¶ä»–é¡åˆ¥
            {
                id: 4031,
                name: 'è¨ºæ–·æ›¸',
                category: 'other',
                price: 50,
                unit: 'ä»½',
                description: 'ä¸­é†«è¨ºæ–·è­‰æ˜æ›¸',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4032,
                name: 'ç—…å‡è­‰æ˜',
                category: 'other',
                price: 30,
                unit: 'ä»½',
                description: 'ç—…å‡è­‰æ˜æ›¸',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4033,
                name: 'é«”è³ªèª¿ç†è«®è©¢',
                category: 'other',
                price: 200,
                unit: 'æ¬¡',
                description: 'å€‹äººé«”è³ªåˆ†æåŠèª¿ç†å»ºè­°',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4034,
                name: 'é£²é£ŸæŒ‡å°',
                category: 'other',
                price: 80,
                unit: 'æ¬¡',
                description: 'ä¸­é†«é£²é£Ÿç™‚æ³•æŒ‡å°',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4035,
                name: 'é¤Šç”Ÿä¿å¥è«®è©¢',
                category: 'other',
                price: 120,
                unit: 'æ¬¡',
                description: 'ä¸­é†«é¤Šç”Ÿä¿å¥æŒ‡å°',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            
            // æŠ˜æ‰£é …ç›®é¡åˆ¥
            {
                id: 4041,
                name: 'é•·è€…å„ªæƒ ',
                category: 'discount',
                price: 0.9, // 9æŠ˜
                unit: '',
                description: '65æ­²ä»¥ä¸Šé•·è€…9æŠ˜å„ªæƒ ',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4042,
                name: 'å­¸ç”Ÿå„ªæƒ ',
                category: 'discount',
                price: 0.85, // 85æŠ˜
                unit: '',
                description: 'å­¸ç”Ÿæ†‘è­‰85æŠ˜å„ªæƒ ',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4043,
                name: 'æœƒå“¡å„ªæƒ ',
                category: 'discount',
                price: 0.95, // 95æŠ˜
                unit: '',
                description: 'è¨ºæ‰€æœƒå“¡95æŠ˜å„ªæƒ ',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4044,
                name: 'ç™‚ç¨‹å¥—é¤æŠ˜æ‰£',
                category: 'discount',
                price: 0.8, // 8æŠ˜
                unit: '',
                description: 'è³¼è²·ç™‚ç¨‹å¥—é¤8æŠ˜å„ªæƒ ',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4045,
                name: 'åˆè¨ºå„ªæƒ ',
                category: 'discount',
                price: -50, // å›ºå®šæ¸›50å…ƒ
                unit: '',
                description: 'é¦–æ¬¡å°±è¨ºæ¸›å…50å…ƒ',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4046,
                name: 'è¤‡è¨ºå„ªæƒ åˆ¸',
                category: 'discount',
                price: -30, // å›ºå®šæ¸›30å…ƒ
                unit: '',
                description: 'è¤‡è¨ºå„ªæƒ åˆ¸æ¸›å…30å…ƒ',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4047,
                name: 'å®¶åº­å¥—é¤æŠ˜æ‰£',
                category: 'discount',
                price: 0.75, // 75æŠ˜
                unit: '',
                description: 'å®¶åº­æˆå“¡åŒæ™‚å°±è¨º75æŠ˜',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4048,
                name: 'ç¯€æ—¥ç‰¹æƒ ',
                category: 'discount',
                price: 0.88, // 88æŠ˜
                unit: '',
                description: 'ç¯€æ—¥æœŸé–“ç‰¹åˆ¥å„ªæƒ 88æŠ˜',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            // å¥—ç¥¨é …ç›®é¡åˆ¥
            {
                id: 4051,
                name: 'ä¸­é†«é¤Šç”Ÿå¥—é¤',
                category: 'package',
                price: 1200,
                unit: 'å¥—',
                description: 'åŒ…å«ï¼šè¨ºç—‡1æ¬¡ + é‡ç¸3æ¬¡ + ä¸­è—¥7åŠ‘ï¼Œé©åˆæ—¥å¸¸ä¿å¥',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4052,
                name: 'é‡ç¸ç™‚ç¨‹å¥—ç¥¨ï¼ˆ10æ¬¡ï¼‰',
                category: 'package',
                price: 800,
                unit: 'å¥—',
                description: 'é‡ç¸æ²»ç™‚10æ¬¡å¥—ç¥¨ï¼Œå–®æ¬¡ä½¿ç”¨åƒ¹å€¼$100ï¼Œå¥—ç¥¨åƒ¹$800',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4053,
                name: 'æ¨æ‹¿æŒ‰æ‘©å¥—ç¥¨ï¼ˆ5æ¬¡ï¼‰',
                category: 'package',
                price: 600,
                unit: 'å¥—',
                description: 'æ¨æ‹¿æŒ‰æ‘©5æ¬¡å¥—ç¥¨ï¼Œå–®æ¬¡ä½¿ç”¨åƒ¹å€¼$150ï¼Œå¥—ç¥¨åƒ¹$600',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4054,
                name: 'ä¸­é†«èª¿ç†ç™‚ç¨‹',
                category: 'package',
                price: 2000,
                unit: 'å¥—',
                description: 'åŒ…å«ï¼šåˆè¨º1æ¬¡ + è¤‡è¨º3æ¬¡ + é‡ç¸8æ¬¡ + ä¸­è—¥21åŠ‘ï¼Œ3é€±å®Œæ•´èª¿ç†',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4055,
                name: 'å®¶åº­ä¿å¥å¥—é¤',
                category: 'package',
                price: 3000,
                unit: 'å¥—',
                description: 'é©åˆ3-4äººå®¶åº­ï¼ŒåŒ…å«é«”è³ªåˆ†æã€é¤Šç”ŸæŒ‡å°ã€é é˜²ä¿å¥è«®è©¢',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4056,
                name: 'ç—›ç—‡å°ˆé …å¥—ç¥¨',
                category: 'package',
                price: 1500,
                unit: 'å¥—',
                description: 'å°ˆæ²»å„ç¨®ç—›ç—‡ï¼ŒåŒ…å«ï¼šè¨ºç—‡2æ¬¡ + é‡ç¸6æ¬¡ + æ¨æ‹¿4æ¬¡ + å¤–ç”¨è—¥è†',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4057,
                name: 'æœˆå­èª¿ç†å¥—é¤',
                category: 'package',
                price: 2500,
                unit: 'å¥—',
                description: 'ç”¢å¾Œèª¿ç†å°ˆç”¨ï¼ŒåŒ…å«ï¼šè¨ºç—‡4æ¬¡ + ä¸­è—¥28åŠ‘ + ç‡Ÿé¤ŠæŒ‡å° + é«”è³ªèª¿ç†',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4058,
                name: 'å­¸ç”Ÿå¥åº·å¥—ç¥¨',
                category: 'package',
                price: 800,
                unit: 'å¥—',
                description: 'å­¸ç”Ÿå°ˆäº«å„ªæƒ å¥—ç¥¨ï¼ŒåŒ…å«ï¼šè¨ºç—‡2æ¬¡ + é‡ç¸3æ¬¡ + å¥åº·æŒ‡å°',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            }
        ];

        // åˆå§‹åŒ–æ”¶è²»é …ç›®è³‡æ–™
        let billingItems = [];
        /**
         * å¾ Firestore è®€å–æ”¶è²»é …ç›®è³‡æ–™ï¼Œè‹¥è³‡æ–™ä¸å­˜åœ¨å‰‡ä½¿ç”¨é è¨­è³‡æ–™åˆå§‹åŒ–ã€‚
         * æ­¤å‡½å¼æœƒç­‰å¾… Firebase åˆå§‹åŒ–å®Œæˆå¾Œå†åŸ·è¡Œã€‚
         */
        async function initBillingItems() {
            // ç­‰å¾… Firebase åˆå§‹åŒ–
            while (!window.firebase || !window.firebase.db) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            try {
                // å¾ Firestore å–å¾— billingItems é›†åˆè³‡æ–™
                const querySnapshot = await window.firebase.getDocs(
                    window.firebase.collection(window.firebase.db, 'billingItems')
                );
                const itemsFromFirestore = [];
                querySnapshot.forEach((docSnap) => {
                    itemsFromFirestore.push({ ...docSnap.data() });
                });
                if (itemsFromFirestore.length === 0) {
                    // è‹¥ Firestore ä¸­æ²’æœ‰è³‡æ–™ï¼Œä½¿ç”¨é è¨­æ”¶è²»é …ç›®åˆå§‹åŒ–
                    for (const item of defaultBillingItems) {
                        await window.firebase.setDoc(
                            window.firebase.doc(window.firebase.db, 'billingItems', String(item.id)),
                            item
                        );
                    }
                    billingItems = defaultBillingItems;
                } else {
                    billingItems = itemsFromFirestore;
                }
            } catch (error) {
                console.error('è®€å–/åˆå§‹åŒ–æ”¶è²»é …ç›®è³‡æ–™å¤±æ•—:', error);
            }
        }

        // é è¨­ç”¨æˆ¶è³‡æ–™
        const defaultUsers = [
            {
                id: 1,
                username: 'manager',
                name: 'é™³ç¶“ç†',
                position: 'è¨ºæ‰€ç®¡ç†',
                email: 'admin@clinic.com',
                phone: '02-8888-1001',
                active: true,
                // Firebase UID å°æ‡‰å€¼ï¼Œå¯æ–¼ç”¨æˆ¶ç®¡ç†ä¸­è¨­å®š
                uid: '',
                createdAt: new Date('2024-01-01').toISOString(),
                lastLogin: null
            },
            {
                id: 2,
                username: 'drzhang',
                name: 'å¼µä¸­é†«å¸«',
                position: 'é†«å¸«',
                registrationNumber: 'CM001234',
                email: 'doctor@clinic.com',
                phone: '02-8888-1002',
                active: true,
                // Firebase UID å°æ‡‰å€¼ï¼Œå¯æ–¼ç”¨æˆ¶ç®¡ç†ä¸­è¨­å®š
                uid: '',
                createdAt: new Date('2024-01-01').toISOString(),
                lastLogin: null
            },
            {
                id: 3,
                username: 'nurse_amy',
                name: 'æ—è­·ç†å¸«',
                position: 'è­·ç†å¸«',
                email: 'nurse@clinic.com',
                phone: '02-8888-1003',
                active: true,
                // Firebase UID å°æ‡‰å€¼ï¼Œå¯æ–¼ç”¨æˆ¶ç®¡ç†ä¸­è¨­å®š
                uid: '',
                createdAt: new Date('2024-01-01').toISOString(),
                lastLogin: null
            }
        ];

        // åˆå§‹åŒ–ç”¨æˆ¶è³‡æ–™
        let users = JSON.parse(localStorage.getItem('users') || '[]');
        if (users.length === 0) {
            users = defaultUsers;
            localStorage.setItem('users', JSON.stringify(users));
        }

        // æ‰€æœ‰ç”¨æˆ¶éƒ½æœ‰å®Œæ•´æ¬Šé™
        const allPermissions = ['patientManagement', 'consultationSystem', 'herbLibrary', 'billingManagement', 'financialReports', 'userManagement', 'systemManagement'];

// ä¸»è¦ç™»å…¥åŠŸèƒ½
async function attemptMainLogin() {
    const email = document.getElementById('mainLoginUsername').value.trim();
    const password = document.getElementById('mainLoginPassword').value.trim();
    
    if (!email || !password) {
        showToast('è«‹è¼¸å…¥é›»å­éƒµä»¶å’Œå¯†ç¢¼ï¼', 'error');
        return;
    }

    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    const loginButton = document.querySelector('button[onclick="attemptMainLogin()"]');
    const originalText = loginButton.textContent;
    loginButton.textContent = 'ç™»å…¥ä¸­...';
    loginButton.disabled = true;

    try {
        // ç­‰å¾… Firebase åˆå§‹åŒ–
        while (!window.firebase) {
            await new Promise(resolve => setTimeout(resolve, 100));
        }

        // ä½¿ç”¨ Firebase ç™»å…¥
        const userCredential = await window.firebase.signInWithEmailAndPassword(
            window.firebase.auth,
            email,
            password
        );

        console.log('Firebase ç™»å…¥æˆåŠŸ:', userCredential.user.email);

        // å–å¾— Firebase ä½¿ç”¨è€…è³‡è¨Š
        const firebaseUser = userCredential.user;
        const uid = firebaseUser.uid;

        // åŒæ­¥è¼‰å…¥ Firebase ç”¨æˆ¶æ•¸æ“š
        await syncUserDataFromFirebase();

        // åœ¨ç”¨æˆ¶è³‡æ–™ä¸­å°‹æ‰¾å°æ‡‰çš„ UID æˆ–é›»å­éƒµä»¶
        let matchingUser = users.find(u => u.uid && u.uid === uid);
        if (!matchingUser) {
            // è‹¥æœªè¨­å®š uidï¼Œæ”¹ç”¨ email æ¯”å°ï¼ˆä¸å€åˆ†å¤§å°å¯«ï¼‰
            matchingUser = users.find(u => u.email && u.email.toLowerCase() === firebaseUser.email.toLowerCase());
            if (matchingUser) {
                // å°‡ Firebase UID è¨­å®šåˆ°ç”¨æˆ¶è³‡æ–™ä¸­ï¼Œä»¥ä¾¿ä¸‹æ¬¡å¯ç›´æ¥é€é UID æ¯”å°
                matchingUser.uid = uid;
                
                // æ›´æ–°åˆ° Firebase
                try {
                    await window.firebaseDataManager.updateUser(matchingUser.id, { uid: uid });
                } catch (error) {
                    console.error('æ›´æ–°ç”¨æˆ¶ UID å¤±æ•—:', error);
                }
                
                // æ›´æ–°æœ¬åœ°å­˜å„²
                localStorage.setItem('users', JSON.stringify(users));
            }
        }

        if (matchingUser) {
            // æ‰¾åˆ°å°æ‡‰ç”¨æˆ¶ï¼Œæª¢æŸ¥æ˜¯å¦å•Ÿç”¨
            if (!matchingUser.active) {
                showToast('æ‚¨çš„å¸³è™Ÿå·²è¢«åœç”¨ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡', 'error');
                await window.firebase.signOut(window.firebase.auth);
                return;
            }

            // æ›´æ–°æœ€å¾Œç™»å…¥æ™‚é–“
            matchingUser.lastLogin = new Date().toISOString();
            try {
                await window.firebaseDataManager.updateUser(matchingUser.id, { 
                    lastLogin: new Date() 
                });
            } catch (error) {
                console.error('æ›´æ–°æœ€å¾Œç™»å…¥æ™‚é–“å¤±æ•—:', error);
            }
            
            // ä½¿ç”¨ç”¨æˆ¶è³‡æ–™é€²è¡Œç™»å…¥
            currentUserData = matchingUser;
            currentUser = matchingUser.username;
        } else {
            // è‹¥æ‰¾ä¸åˆ°å°æ‡‰ç”¨æˆ¶ï¼Œä½¿ç”¨ Firebase è³‡è¨Šå»ºç«‹è‡¨æ™‚ç”¨æˆ¶è³‡æ–™
            currentUserData = {
                id: null,
                uid: uid,
                username: firebaseUser.email,
                email: firebaseUser.email,
                name: firebaseUser.displayName || getUserNameFromEmail(firebaseUser.email),
                position: getUserPositionFromEmail(firebaseUser.email),
                active: true,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                lastLogin: new Date().toISOString()
            };
            currentUser = currentUserData.username;
        }

        // ç™»å…¥æˆåŠŸï¼Œåˆ‡æ›åˆ°ä¸»ç³»çµ±
        performLogin(currentUserData);
        
        showToast('ç™»å…¥æˆåŠŸï¼', 'success');

    } catch (error) {
        console.error('ç™»å…¥å¤±æ•—:', error);
        let errorMessage = 'ç™»å…¥å¤±æ•—';
        
        if (error.code === 'auth/user-not-found') {
            errorMessage = 'é›»å­éƒµä»¶ä¸å­˜åœ¨';
        } else if (error.code === 'auth/wrong-password') {
            errorMessage = 'å¯†ç¢¼éŒ¯èª¤';
        } else if (error.code === 'auth/invalid-email') {
            errorMessage = 'é›»å­éƒµä»¶æ ¼å¼ä¸æ­£ç¢º';
        }
        
        showToast(errorMessage, 'error');
        document.getElementById('mainLoginPassword').value = '';
    } finally {
        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
        loginButton.textContent = originalText;
        loginButton.disabled = false;
    }
}

// åŒæ­¥ Firebase ç”¨æˆ¶æ•¸æ“šåˆ°æœ¬åœ°
async function syncUserDataFromFirebase() {
    try {
        if (!window.firebaseDataManager || !window.firebaseDataManager.isReady) {
            console.log('Firebase æ•¸æ“šç®¡ç†å™¨å°šæœªæº–å‚™å°±ç·’ï¼Œè·³éåŒæ­¥');
            return;
        }

        const result = await window.firebaseDataManager.getUsers();
        if (result.success && result.data.length > 0) {
            // æ›´æ–°æœ¬åœ° users è®Šæ•¸
            users = result.data.map(user => ({
                ...user,
                // ç¢ºä¿æ•¸æ“šæ ¼å¼å…¼å®¹æ€§
                createdAt: user.createdAt ? (user.createdAt.seconds ? new Date(user.createdAt.seconds * 1000).toISOString() : user.createdAt) : new Date().toISOString(),
                updatedAt: user.updatedAt ? (user.updatedAt.seconds ? new Date(user.updatedAt.seconds * 1000).toISOString() : user.updatedAt) : new Date().toISOString(),
                lastLogin: user.lastLogin ? (user.lastLogin.seconds ? new Date(user.lastLogin.seconds * 1000).toISOString() : user.lastLogin) : null
            }));
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å„²ä½œç‚ºå‚™ç”¨
            localStorage.setItem('users', JSON.stringify(users));
            console.log('å·²åŒæ­¥ Firebase ç”¨æˆ¶æ•¸æ“šåˆ°æœ¬åœ°:', users.length, 'ç­†');
        } else {
            console.log('Firebase ç”¨æˆ¶æ•¸æ“šç‚ºç©ºæˆ–è®€å–å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°æ•¸æ“š');
        }
    } catch (error) {
        console.error('åŒæ­¥ Firebase ç”¨æˆ¶æ•¸æ“šå¤±æ•—:', error);
    }
}

// å¹«åŠ©å‡½æ•¸ï¼šå¾ email ç²å–å§“å
function getUserNameFromEmail(email) {
    if (email === 'admin@clinic.com') return 'ç³»çµ±ç®¡ç†å“¡';
    if (email === 'doctor@clinic.com') return 'å¼µä¸­é†«å¸«';
    if (email === 'nurse@clinic.com') return 'æ—è­·ç†å¸«';
    return 'ç”¨æˆ¶';
}

// å¹«åŠ©å‡½æ•¸ï¼šå¾ email ç²å–è·ä½
function getUserPositionFromEmail(email) {
    if (email === 'admin@clinic.com') return 'è¨ºæ‰€ç®¡ç†';
    if (email === 'doctor@clinic.com') return 'é†«å¸«';
    if (email === 'nurse@clinic.com') return 'è­·ç†å¸«';
    return 'ç”¨æˆ¶';
}
        
        // åŸ·è¡Œç™»å…¥
        async function performLogin(user) {
            // æ›´æ–°æœ€å¾Œç™»å…¥æ™‚é–“
            const userIndex = users.findIndex(u => u.id === user.id);
            if (userIndex !== -1) {
                users[userIndex].lastLogin = new Date().toISOString();
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            currentUser = user.username;
            currentUserData = user;
            
    // åˆ‡æ›åˆ°ä¸»ç³»çµ±
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('mainSystem').classList.remove('hidden');
    
    document.getElementById('userRole').textContent = `ç•¶å‰ç”¨æˆ¶ï¼š${getUserDisplayName(user)}`;
    document.getElementById('sidebarUserRole').textContent = `ç•¶å‰ç”¨æˆ¶ï¼š${getUserDisplayName(user)}`;
    
    generateSidebarMenu();
    updateStatistics();
    
    // æ·»åŠ å¯¦æ™‚åŠŸèƒ½
    if (window.realtimeManager && window.realtimeManager.isReady) {
        await window.realtimeManager.setUserOnline(user.id, user);
    }
    
    showToast(`æ­¡è¿å›ä¾†ï¼Œ${getUserDisplayName(user)}ï¼`, 'success');
}
        // å´é‚Šé¸å–®æ§åˆ¶
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        // ç™»å‡ºåŠŸèƒ½
async function logout() {
    try {
        // æ¸…ç†å¯¦æ™‚åŠŸèƒ½
        if (window.realtimeManager && currentUserData) {
            await window.realtimeManager.setUserOffline(currentUserData.id);
            window.realtimeManager.cleanup();
        }
        
        // Firebase ç™»å‡º
        if (window.firebase && window.firebase.auth) {
            await window.firebase.signOut(window.firebase.auth);
        }
        
        // æ¸…ç†æœ¬åœ°æ•¸æ“š
        currentUser = null;
        currentUserData = null;
        
        document.getElementById('loginPage').classList.remove('hidden');
        document.getElementById('mainSystem').classList.add('hidden');
        document.getElementById('sidebar').classList.add('-translate-x-full');
        document.getElementById('sidebarOverlay').classList.add('hidden');
        hideAllSections();
        
        // æ¸…ç©ºç™»å…¥è¡¨å–®
        document.getElementById('mainLoginUsername').value = '';
        document.getElementById('mainLoginPassword').value = '';
        
        showToast('å·²æˆåŠŸç™»å‡º', 'success');
        
    } catch (error) {
        console.error('ç™»å‡ºéŒ¯èª¤:', error);
        showToast('ç™»å‡ºæ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
    }
}

        // ç”Ÿæˆå´é‚Šé¸å–®
        function generateSidebarMenu() {
            const menuContainer = document.getElementById('sidebarMenu');
            menuContainer.innerHTML = '';

            // å®šç¾©å„å€‹åŠŸèƒ½çš„æ¨™é¡Œã€åœ–ç¤ºåŠèªªæ˜
            const menuItems = {
                patientManagement: { title: 'ç—…äººè³‡æ–™ç®¡ç†', icon: 'ğŸ‘¥', description: 'æ–°å¢ã€æŸ¥çœ‹ã€ç®¡ç†ç—…äººè³‡æ–™' },
                consultationSystem: { title: 'è¨ºç—‡ç³»çµ±', icon: 'ğŸ©º', description: 'è¨˜éŒ„ç—‡ç‹€ã€è¨ºæ–·ã€é–‹ç«‹è™•æ–¹' },
                herbLibrary: { title: 'ä¸­è—¥åº«ç®¡ç†', icon: 'ğŸŒ¿', description: 'ç®¡ç†ä¸­è—¥æåŠæ–¹åŠ‘è³‡æ–™' },
                billingManagement: { title: 'æ”¶è²»é …ç›®ç®¡ç†', icon: 'ğŸ’°', description: 'ç®¡ç†è¨ºç™‚è²»ç”¨åŠæ”¶è²»é …ç›®' },
                userManagement: { title: 'è¨ºæ‰€ç”¨æˆ¶ç®¡ç†', icon: 'ğŸ‘¤', description: 'ç®¡ç†è¨ºæ‰€ç”¨æˆ¶æ¬Šé™' },
                financialReports: { title: 'è²¡å‹™å ±è¡¨', icon: 'ğŸ“Š', description: 'æ”¶å…¥åˆ†æèˆ‡è²¡å‹™çµ±è¨ˆ' },
                systemManagement: { title: 'ç³»çµ±ç®¡ç†', icon: 'âš™ï¸', description: 'çµ±è¨ˆè³‡æ–™ã€å‚™ä»½åŒ¯å‡º' }
            };

            /*
             * æ ¹æ“šç•¶å‰ç”¨æˆ¶çš„è·ä½æ±ºå®šå¯ä½¿ç”¨çš„åŠŸèƒ½åˆ—è¡¨ã€‚ä¸€èˆ¬è·ä½åƒ…èƒ½æŸ¥çœ‹èˆ‡è¨ºç™‚ç›¸é—œçš„è³‡æ–™ï¼Œ
             * ã€Œè¨ºæ‰€ç®¡ç†ã€è·ä½å¯ä»¥é¡å¤–å­˜å–è²¡å‹™å ±è¡¨ã€ç”¨æˆ¶ç®¡ç†èˆ‡ç³»çµ±ç®¡ç†ã€‚
             */
            function getPermissionsForPosition(position) {
                const basePermissions = ['patientManagement', 'consultationSystem', 'herbLibrary', 'billingManagement'];
                // ã€Œè¨ºæ‰€ç®¡ç†ã€è·ä½å¯ä½¿ç”¨æ‰€æœ‰é€²éšåŠŸèƒ½
                if (position === 'è¨ºæ‰€ç®¡ç†') {
                    return [...basePermissions, 'financialReports', 'userManagement', 'systemManagement'];
                }
                // é†«å¸«è·ä½äº¦å¯ç®¡ç†ç”¨æˆ¶ï¼Œå› æ­¤åŠ å…¥ userManagement æ¬Šé™
                if (position === 'é†«å¸«') {
                    return [...basePermissions, 'userManagement'];
                }
                // å…¶ä»–è·ä½åƒ…å…·å‚™åŸºæœ¬åŠŸèƒ½
                return basePermissions;
            }

            // å–å¾—ç•¶å‰ç”¨æˆ¶è·ä½ï¼Œæ²’æœ‰è·ä½é è¨­ç‚ºä¸€èˆ¬ä½¿ç”¨è€…
            const userPosition = (currentUserData && currentUserData.position) || '';
            const permissions = getPermissionsForPosition(userPosition);

            // ä¾åºå»ºç«‹å´é‚Šé¸å–®æŒ‰éˆ•
            permissions.forEach(permission => {
                const item = menuItems[permission];
                if (!item) return;
                const button = document.createElement('button');
                button.className = 'w-full text-left p-4 rounded-lg hover:bg-gray-100 transition duration-200 border border-gray-200 mb-2';
                button.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-2xl mr-4">${item.icon}</span>
                        <div>
                            <div class="font-semibold text-gray-800">${item.title}</div>
                            <div class="text-sm text-gray-600">${item.description}</div>
                        </div>
                    </div>
                `;
                button.onclick = () => {
                    showSection(permission);
                    toggleSidebar();
                };
                menuContainer.appendChild(button);
            });
        }

        // é¡¯ç¤ºæŒ‡å®šå€åŸŸ
        function showSection(sectionId) {
            // è‹¥ç‚ºè²¡å‹™å ±è¡¨æˆ–ç³»çµ±ç®¡ç†ï¼Œåƒ…é™è¨ºæ‰€ç®¡ç†å­˜å–
            if (['financialReports', 'systemManagement'].includes(sectionId)) {
                if (!currentUserData || currentUserData.position !== 'è¨ºæ‰€ç®¡ç†') {
                    showToast('æ¬Šé™ä¸è¶³ï¼Œåƒ…è¨ºæ‰€ç®¡ç†å¯ä½¿ç”¨æ­¤åŠŸèƒ½', 'error');
                    return;
                }
            }
            // è‹¥ç‚ºç”¨æˆ¶ç®¡ç†ï¼Œè¨ºæ‰€ç®¡ç†åŠé†«å¸«çš†å¯å­˜å–
            if (sectionId === 'userManagement') {
                if (!currentUserData || !['è¨ºæ‰€ç®¡ç†', 'é†«å¸«'].includes(currentUserData.position)) {
                    showToast('æ¬Šé™ä¸è¶³ï¼Œåƒ…è¨ºæ‰€ç®¡ç†æˆ–é†«å¸«å¯ä½¿ç”¨æ­¤åŠŸèƒ½', 'error');
                    return;
                }
            }

            hideAllSections();
            document.getElementById('welcomePage').classList.add('hidden');
            document.getElementById(sectionId).classList.remove('hidden');

            if (sectionId === 'patientManagement') {
                loadPatientList();
            } else if (sectionId === 'consultationSystem') {
                loadConsultationSystem();
            } else if (sectionId === 'herbLibrary') {
                loadHerbLibrary();
            } else if (sectionId === 'billingManagement') {
                loadBillingManagement();
            } else if (sectionId === 'financialReports') {
                loadFinancialReports();
            } else if (sectionId === 'userManagement') {
                loadUserManagement();
            }
        }

        // éš±è—æ‰€æœ‰å€åŸŸ
        function hideAllSections() {
            ['patientManagement', 'consultationSystem', 'herbLibrary', 'billingManagement', 'userManagement', 'financialReports', 'systemManagement', 'welcomePage'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
        }

        // ç—…äººç®¡ç†åŠŸèƒ½
        let editingPatientId = null;
        let filteredPatients = [];
        
        // æ›´æ–°ç—…äººå¹´é½¡é¡¯ç¤º
        function updatePatientAge() {
            const birthDate = document.getElementById('patientBirthDate').value;
            const ageInput = document.getElementById('patientAge');
            
            if (birthDate) {
                const age = calculateAge(birthDate);
                ageInput.value = age;
            } else {
                ageInput.value = '';
            }
        }

        function showAddPatientForm() {
            editingPatientId = null;
            document.getElementById('formTitle').textContent = 'æ–°å¢ç—…äººè³‡æ–™';
            document.getElementById('saveButtonText').textContent = 'å„²å­˜';
            document.getElementById('addPatientModal').classList.remove('hidden');
            clearPatientForm();
        }

        function hideAddPatientForm() {
            document.getElementById('addPatientModal').classList.add('hidden');
            clearPatientForm();
            editingPatientId = null;
        }

        function clearPatientForm() {
            ['patientName', 'patientAge', 'patientGender', 'patientPhone', 'patientIdCard', 'patientBirthDate', 'patientAddress', 'patientAllergies', 'patientHistory'].forEach(id => {
                document.getElementById(id).value = '';
            });
        }

async function savePatient() {
    const patient = {
        name: document.getElementById('patientName').value.trim(),
        age: document.getElementById('patientAge').value,
        gender: document.getElementById('patientGender').value,
        phone: document.getElementById('patientPhone').value.trim(),
        idCard: document.getElementById('patientIdCard').value.trim(),
        birthDate: document.getElementById('patientBirthDate').value,
        address: document.getElementById('patientAddress').value.trim(),
        allergies: document.getElementById('patientAllergies').value.trim(),
        history: document.getElementById('patientHistory').value.trim()
    };

    // é©—è­‰å¿…å¡«æ¬„ä½ï¼šå§“åã€æ€§åˆ¥ã€é›»è©±ã€å‡ºç”Ÿæ—¥æœŸèˆ‡èº«åˆ†è­‰å­—è™Ÿ
    if (!patient.name || !patient.gender || !patient.phone || !patient.birthDate || !patient.idCard) {
        showToast('è«‹å¡«å¯«å¿…è¦è³‡æ–™ï¼ˆå§“åã€æ€§åˆ¥ã€é›»è©±ã€å‡ºç”Ÿæ—¥æœŸã€èº«åˆ†è­‰å­—è™Ÿï¼‰ï¼', 'error');
        return;
    }

    // é©—è­‰å‡ºç”Ÿæ—¥æœŸ
    const birthDate = new Date(patient.birthDate);
    const today = new Date();
    if (birthDate > today) {
        showToast('å‡ºç”Ÿæ—¥æœŸä¸èƒ½æ™šæ–¼ä»Šå¤©ï¼', 'error');
        return;
    }

    // è¨ˆç®—å¹´é½¡
    const calculatedAge = calculateAge(patient.birthDate);
    if (calculatedAge > 120) {
        showToast('è«‹ç¢ºèªå‡ºç”Ÿæ—¥æœŸæ˜¯å¦æ­£ç¢ºï¼', 'error');
        return;
    }

    // é©—è­‰é›»è©±æ ¼å¼
    const phoneRegex = /^[0-9\-\+\(\)\s]+$/;
    if (!phoneRegex.test(patient.phone)) {
        showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»è©±è™Ÿç¢¼ï¼', 'error');
        return;
    }

    // ä¸é™åˆ¶èº«åˆ†è­‰å­—è™Ÿæ ¼å¼ï¼Œå› æ­¤ç„¡éœ€æª¢æŸ¥æ ¼å¼

    try {
        if (editingPatientId) {
            // æ›´æ–°ç¾æœ‰ç—…äºº
            const result = await window.firebaseDataManager.updatePatient(editingPatientId, patient);
            if (result.success) {
                showToast('ç—…äººè³‡æ–™å·²æˆåŠŸæ›´æ–°ï¼', 'success');
            } else {
                showToast('æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                return;
            }
        } else {
            // æ–°å¢ç—…äºº
            // ç”Ÿæˆç—…äººç·¨è™Ÿ
            patient.patientNumber = await generatePatientNumberFromFirebase();
            
            const result = await window.firebaseDataManager.addPatient(patient);
            if (result.success) {
                showToast('ç—…äººè³‡æ–™å·²æˆåŠŸæ–°å¢ï¼', 'success');
            } else {
                showToast('æ–°å¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                return;
            }
        }

        // é‡æ–°è¼‰å…¥ç—…äººåˆ—è¡¨
        await loadPatientListFromFirebase();
        hideAddPatientForm();
        updateStatistics();

    } catch (error) {
        console.error('ä¿å­˜ç—…äººè³‡æ–™éŒ¯èª¤:', error);
        showToast('ä¿å­˜æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
    }
}

        // å¾ Firebase ç”Ÿæˆç—…äººç·¨è™Ÿ
async function generatePatientNumberFromFirebase() {
    try {
        const result = await window.firebaseDataManager.getPatients();
        if (!result.success) {
            return 'P000001'; // å¦‚æœç„¡æ³•è®€å–ï¼Œä½¿ç”¨é è¨­ç·¨è™Ÿ
        }

        const existingNumbers = result.data
            .map(p => p.patientNumber)
            .filter(num => num && num.startsWith('P'))
            .map(num => parseInt(num.substring(1)))
            .filter(num => !isNaN(num));

        const maxNumber = existingNumbers.length > 0 ? Math.max(...existingNumbers) : 0;
        const newNumber = maxNumber + 1;
        return `P${newNumber.toString().padStart(6, '0')}`;
    } catch (error) {
        console.error('ç”Ÿæˆç—…äººç·¨è™Ÿå¤±æ•—:', error);
        return `P${Date.now().toString().slice(-6)}`; // å‚™ç”¨æ–¹æ¡ˆ
    }
}

// å¾ Firebase è¼‰å…¥ç—…äººåˆ—è¡¨
async function loadPatientListFromFirebase() {
    const tbody = document.getElementById('patientList');
    const searchTerm = document.getElementById('searchPatient').value.toLowerCase();
    
    try {
        // é¡¯ç¤ºè¼‰å…¥ä¸­
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
                    <div class="mt-2">è¼‰å…¥ä¸­...</div>
                </td>
            </tr>
        `;

        const result = await window.firebaseDataManager.getPatients();
        
        if (!result.success) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                        è®€å–è³‡æ–™å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢
                    </td>
                </tr>
            `;
            return;
        }

        // éæ¿¾ç—…äººè³‡æ–™
        const filteredPatients = result.data.filter(patient => 
            patient.name.toLowerCase().includes(searchTerm) ||
            patient.phone.includes(searchTerm) ||
            (patient.idCard && patient.idCard.toLowerCase().includes(searchTerm)) ||
            (patient.patientNumber && patient.patientNumber.toLowerCase().includes(searchTerm))
        );

        tbody.innerHTML = '';

        if (filteredPatients.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                        ${searchTerm ? 'æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„ç—…äºº' : 'å°šç„¡ç—…äººè³‡æ–™'}
                    </td>
                </tr>
            `;
            return;
        }

        filteredPatients.forEach(patient => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            row.innerHTML = `
                <td class="px-4 py-3 text-sm text-blue-600 font-medium">${patient.patientNumber || 'æœªè¨­å®š'}</td>
                <td class="px-4 py-3 text-sm text-gray-900 font-medium">${patient.name}</td>
                <td class="px-4 py-3 text-sm text-gray-900">${formatAge(patient.birthDate)}</td>
                <td class="px-4 py-3 text-sm text-gray-900">${patient.gender}</td>
                <td class="px-4 py-3 text-sm text-gray-900">${patient.phone}</td>
                <td class="px-4 py-3 text-sm space-x-2">
                    <button onclick="viewPatient('${patient.id}')" class="text-blue-600 hover:text-blue-800">æŸ¥çœ‹</button>
                    <button onclick="editPatient('${patient.id}')" class="text-green-600 hover:text-green-800">ç·¨è¼¯</button>
                    <button onclick="deletePatient('${patient.id}')" class="text-red-600 hover:text-red-800">åˆªé™¤</button>
                </td>
            `;
            tbody.appendChild(row);
        });

        console.log('å·²è¼‰å…¥', filteredPatients.length, 'ç­†ç—…äººè³‡æ–™');

    } catch (error) {
        console.error('è¼‰å…¥ç—…äººåˆ—è¡¨éŒ¯èª¤:', error);
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                    è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥
                </td>
            </tr>
        `;
    }
}

function loadPatientList() {
    loadPatientListFromFirebase();
}

async function editPatient(id) {
    try {
        // å¾ Firebase ç²å–ç—…äººè³‡æ–™
        const result = await window.firebaseDataManager.getPatients();
        if (!result.success) {
            showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™', 'error');
            return;
        }

        const patient = result.data.find(p => p.id === id);
        if (!patient) {
            showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™', 'error');
            return;
        }

        editingPatientId = id;
        document.getElementById('formTitle').textContent = 'ç·¨è¼¯ç—…äººè³‡æ–™';
        document.getElementById('saveButtonText').textContent = 'æ›´æ–°';
        
        // å¡«å…¥ç¾æœ‰è³‡æ–™
        document.getElementById('patientName').value = patient.name || '';
        document.getElementById('patientGender').value = patient.gender || '';
        document.getElementById('patientPhone').value = patient.phone || '';
        document.getElementById('patientIdCard').value = patient.idCard || '';
        document.getElementById('patientBirthDate').value = patient.birthDate || '';
        document.getElementById('patientAddress').value = patient.address || '';
        document.getElementById('patientAllergies').value = patient.allergies || '';
        document.getElementById('patientHistory').value = patient.history || '';
        
        // è‡ªå‹•è¨ˆç®—å¹´é½¡
        updatePatientAge();
        
        document.getElementById('addPatientModal').classList.remove('hidden');

    } catch (error) {
        console.error('ç·¨è¼¯ç—…äººè³‡æ–™éŒ¯èª¤:', error);
        showToast('è®€å–ç—…äººè³‡æ–™å¤±æ•—', 'error');
    }
}
async function deletePatient(id) {
    try {
        // å¾ Firebase ç²å–ç—…äººè³‡æ–™
        const result = await window.firebaseDataManager.getPatients();
        if (!result.success) {
            showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™', 'error');
            return;
        }

        const patient = result.data.find(p => p.id === id);
        if (!patient) {
            showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™', 'error');
            return;
        }

        const confirmMessage = `ç¢ºå®šè¦åˆªé™¤ç—…äººã€Œ${patient.name}ã€çš„è³‡æ–™å—ï¼Ÿ\n\næ³¨æ„ï¼šç›¸é—œçš„è¨ºç—‡è¨˜éŒ„ä¹Ÿæœƒä¸€ä½µåˆªé™¤ï¼`;
        
        if (confirm(confirmMessage)) {
            // é¡¯ç¤ºåˆªé™¤ä¸­ç‹€æ…‹
            showToast('åˆªé™¤ä¸­...', 'info');

            // å¾ Firebase åˆªé™¤ç—…äººè³‡æ–™
            const deleteResult = await window.firebaseDataManager.deletePatient(id);
            
            if (deleteResult.success) {
                showToast('ç—…äººè³‡æ–™å·²åˆªé™¤ï¼', 'success');
                // é‡æ–°è¼‰å…¥ç—…äººåˆ—è¡¨
                await loadPatientListFromFirebase();
                updateStatistics();
            } else {
                showToast('åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            }
        }

    } catch (error) {
        console.error('åˆªé™¤ç—…äººè³‡æ–™éŒ¯èª¤:', error);
        showToast('åˆªé™¤æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
    }
}

async function viewPatient(id) {
    try {
        // å¾ Firebase ç²å–ç—…äººè³‡æ–™
        const result = await window.firebaseDataManager.getPatients();
        if (!result.success) {
            showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™', 'error');
            return;
        }

        const patient = result.data.find(p => p.id === id);
        if (!patient) {
            showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™', 'error');
            return;
        }

        // é¡¯ç¤ºç—…äººè©³ç´°è³‡æ–™
        const content = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <h4 class="text-lg font-semibold text-gray-800 border-b pb-2">åŸºæœ¬è³‡æ–™</h4>
                    <div class="space-y-2">
                        <div><span class="font-medium">ç—…äººç·¨è™Ÿï¼š</span><span class="text-blue-600 font-semibold">${patient.patientNumber || 'æœªè¨­å®š'}</span></div>
                        <div><span class="font-medium">å§“åï¼š</span>${patient.name}</div>
                        <div><span class="font-medium">å¹´é½¡ï¼š</span>${formatAge(patient.birthDate)}</div>
                        <div><span class="font-medium">æ€§åˆ¥ï¼š</span>${patient.gender}</div>
                        <div><span class="font-medium">é›»è©±ï¼š</span>${patient.phone}</div>
                        ${patient.idCard ? `<div><span class="font-medium">èº«åˆ†è­‰ï¼š</span>${patient.idCard}</div>` : ''}
                        ${patient.birthDate ? `<div><span class="font-medium">å‡ºç”Ÿæ—¥æœŸï¼š</span>${new Date(patient.birthDate).toLocaleDateString('zh-TW')}</div>` : ''}
                        ${patient.address ? `<div><span class="font-medium">åœ°å€ï¼š</span>${patient.address}</div>` : ''}
                    </div>
                </div>
                
                <div class="space-y-4">
                    <h4 class="text-lg font-semibold text-gray-800 border-b pb-2">é†«ç™‚è³‡è¨Š</h4>
                    <div class="space-y-2">
                        ${patient.allergies ? `<div><span class="font-medium">éæ•å²ï¼š</span><div class="mt-1 p-2 bg-red-50 rounded text-sm">${patient.allergies}</div></div>` : ''}
                        ${patient.history ? `<div><span class="font-medium">ç—…å²ï¼š</span><div class="mt-1 p-2 bg-gray-50 rounded text-sm">${patient.history}</div></div>` : ''}
                        <div><span class="font-medium">å»ºæª”æ—¥æœŸï¼š</span>${patient.createdAt ? new Date(patient.createdAt.seconds * 1000).toLocaleDateString('zh-TW') : 'æœªçŸ¥'}</div>
                        ${patient.updatedAt ? `<div><span class="font-medium">æ›´æ–°æ—¥æœŸï¼š</span>${new Date(patient.updatedAt.seconds * 1000).toLocaleDateString('zh-TW')}</div>` : ''}
                    </div>
                </div>
            </div>
            
            <!-- è¨ºç—‡è¨˜éŒ„æ‘˜è¦ -->
            <div class="mt-6 pt-6 border-t border-gray-200">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-lg font-semibold text-gray-800">è¨ºç—‡è¨˜éŒ„æ‘˜è¦</h4>
                </div>
                
<div id="patientConsultationSummary">
    <div class="text-center py-4">
        <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-gray-900"></div>
        <div class="mt-2 text-sm">è¼‰å…¥è¨ºç—‡è¨˜éŒ„ä¸­...</div>
    </div>
</div>
            </div>
        `;

                // è¼‰å…¥è¨ºç—‡è¨˜éŒ„æ‘˜è¦
        loadPatientConsultationSummary(id);
        
        document.getElementById('patientDetailContent').innerHTML = content;
        document.getElementById('patientDetailModal').classList.remove('hidden');

    } catch (error) {
        console.error('æŸ¥çœ‹ç—…äººè³‡æ–™éŒ¯èª¤:', error);
        showToast('è®€å–ç—…äººè³‡æ–™å¤±æ•—', 'error');
    }
}

        function closePatientDetail() {
            document.getElementById('patientDetailModal').classList.add('hidden');
        }





        // æœå°‹åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            // å¥—ç¥¨æ¬„ä½åˆ‡æ›
            const categorySelect = document.getElementById('billingItemCategory');
            if (categorySelect) {
                categorySelect.addEventListener('change', function () {
                    const isPackage = this.value === 'package';
                    const pf = document.getElementById('packageFields');
                    if (pf) pf.classList.toggle('hidden', !isPackage);
                });
            }
            const searchInput = document.getElementById('searchPatient');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    loadPatientList();
                });
            }
        });

        // è¨ºç—‡ç³»çµ±åŠŸèƒ½
        let selectedPatientForRegistration = null;
        let currentConsultingAppointmentId = null;
        
        function loadConsultationSystem() {
            loadTodayAppointments();
            clearPatientSearch();
        }
        
// 1. ä¿®æ”¹ç—…äººæœå°‹å‡½æ•¸ï¼Œæ”¹ç‚ºå¾ Firebase è®€å–è³‡æ–™
async function searchPatientsForRegistration() {
    const searchTerm = document.getElementById('patientSearchInput').value.trim().toLowerCase();
    const resultsContainer = document.getElementById('patientSearchResults');
    const resultsList = document.getElementById('searchResultsList');
    
    if (searchTerm.length < 1) {
        resultsContainer.classList.add('hidden');
        return;
    }
    
    // é¡¯ç¤ºè¼‰å…¥ä¸­
    resultsList.innerHTML = `
        <div class="p-4 text-center text-gray-500">
            <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-gray-900"></div>
            <div class="mt-2">æœå°‹ä¸­...</div>
        </div>
    `;
    resultsContainer.classList.remove('hidden');
    
    try {
        // å¾ Firebase ç²å–ç—…äººè³‡æ–™
        const result = await window.firebaseDataManager.getPatients();
        
        if (!result.success) {
            resultsList.innerHTML = `
                <div class="p-4 text-center text-red-500">
                    è®€å–ç—…äººè³‡æ–™å¤±æ•—ï¼Œè«‹é‡è©¦
                </div>
            `;
            return;
        }
        
        // æœç´¢åŒ¹é…çš„ç—…äºº
        const matchedPatients = result.data.filter(patient => 
            patient.name.toLowerCase().includes(searchTerm) ||
            patient.phone.includes(searchTerm) ||
            (patient.patientNumber && patient.patientNumber.toLowerCase().includes(searchTerm))
        );
        
        if (matchedPatients.length === 0) {
            resultsList.innerHTML = `
                <div class="p-4 text-center text-gray-500">
                    æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„ç—…äºº
                </div>
            `;
            resultsContainer.classList.remove('hidden');
            return;
        }
        
        // é¡¯ç¤ºæœç´¢çµæœ
        resultsList.innerHTML = matchedPatients.map(patient => `
            <div class="p-4 hover:bg-gray-50 cursor-pointer transition duration-200" onclick="selectPatientForRegistration('${patient.id}')">
                <div>
                    <div class="font-semibold text-gray-900">${patient.name}</div>
                    <div class="text-sm text-gray-600">ç·¨è™Ÿï¼š${patient.patientNumber} | å¹´é½¡ï¼š${formatAge(patient.birthDate)} | æ€§åˆ¥ï¼š${patient.gender}</div>
                    <div class="text-sm text-gray-500">é›»è©±ï¼š${patient.phone}</div>
                </div>
            </div>
        `).join('');
        
        resultsContainer.classList.remove('hidden');
        
    } catch (error) {
        console.error('æœå°‹ç—…äººè³‡æ–™éŒ¯èª¤:', error);
        resultsList.innerHTML = `
            <div class="p-4 text-center text-red-500">
                æœå°‹å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥
            </div>
        `;
    }
}
        
// 2. ä¿®æ”¹é¸æ“‡ç—…äººé€²è¡Œæ›è™Ÿå‡½æ•¸
async function selectPatientForRegistration(patientId) {
    // æª¢æŸ¥æ˜¯å¦æœ‰ç—…äººæ­£åœ¨è¨ºç—‡ä¸­
    const consultingAppointment = appointments.find(apt => 
        apt.status === 'consulting' && 
        new Date(apt.appointmentTime).toDateString() === new Date().toDateString()
    );
    
    if (consultingAppointment) {
        try {
            // å¾ Firebase ç²å–æ­£åœ¨è¨ºç—‡çš„ç—…äººè³‡æ–™
            const result = await window.firebaseDataManager.getPatients();
            if (result.success) {
                const consultingPatient = result.data.find(p => p.id === consultingAppointment.patientId);
                const consultingPatientName = consultingPatient ? consultingPatient.name : 'æŸä½ç—…äºº';
                showToast(`ç„¡æ³•é€²è¡Œæ›è™Ÿï¼${consultingPatientName}æ­£åœ¨è¨ºç—‡ä¸­ï¼Œè«‹ç­‰å¾…è¨ºç—‡å®Œæˆå¾Œå†é€²è¡Œæ›è™Ÿæ“ä½œã€‚`, 'warning');
                return;
            }
        } catch (error) {
            console.error('æª¢æŸ¥è¨ºç—‡ç‹€æ…‹éŒ¯èª¤:', error);
        }
    }
    
    try {
        // å¾ Firebase ç²å–ç—…äººè³‡æ–™
        const result = await window.firebaseDataManager.getPatients();
        if (!result.success) {
            showToast('è®€å–ç—…äººè³‡æ–™å¤±æ•—', 'error');
            return;
        }
        
        const patient = result.data.find(p => p.id === patientId);
        if (!patient) {
            showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™', 'error');
            return;
        }
        
        selectedPatientForRegistration = patient;
        showRegistrationModal(patient);
        
    } catch (error) {
        console.error('é¸æ“‡ç—…äººè³‡æ–™éŒ¯èª¤:', error);
        showToast('è®€å–ç—…äººè³‡æ–™å¤±æ•—', 'error');
    }
}
        
        // æ¸…é™¤ç—…äººæœç´¢
        function clearPatientSearch() {
            document.getElementById('patientSearchInput').value = '';
            document.getElementById('patientSearchResults').classList.add('hidden');
            selectedPatientForRegistration = null;
        }
        

        
        // é¡¯ç¤ºæ›è™Ÿå½ˆçª—
        function showRegistrationModal(patient) {
            if (!patient) return;
            
            // é¡¯ç¤ºé¸ä¸­çš„ç—…äººè³‡è¨Š
            document.getElementById('selectedPatientInfo').innerHTML = `
                <div class="space-y-1">
                    <div><span class="font-medium">å§“åï¼š</span>${patient.name}</div>
                    <div><span class="font-medium">ç·¨è™Ÿï¼š</span>${patient.patientNumber}</div>
                    <div><span class="font-medium">å¹´é½¡ï¼š</span>${formatAge(patient.birthDate)} | <span class="font-medium">æ€§åˆ¥ï¼š</span>${patient.gender}</div>
                    <div><span class="font-medium">é›»è©±ï¼š</span>${patient.phone}</div>
                </div>
            `;
            
            // è¼‰å…¥é†«å¸«é¸é …
            loadDoctorOptions();
            
            // è¨­ç½®é è¨­æ›è™Ÿæ™‚é–“ç‚ºç•¶å‰æ™‚é–“ï¼ˆåŠ 5åˆ†é˜é¿å…æ™‚é–“éæœŸï¼‰
            const now = new Date();
            now.setMinutes(now.getMinutes() + 5); // åŠ 5åˆ†é˜
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const localDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
            
            document.getElementById('appointmentDateTime').value = localDateTime;
            
            clearRegistrationForm();
            document.getElementById('registrationModal').classList.remove('hidden');
        }
        
        // è¼‰å…¥é†«å¸«é¸é …
        function loadDoctorOptions() {
            const doctorSelect = document.getElementById('appointmentDoctor');
            
            // ç²å–æ‰€æœ‰å•Ÿç”¨çš„é†«å¸«ç”¨æˆ¶
            const doctors = users.filter(user => 
                user.active && user.position === 'é†«å¸«'
            );
            
            // æ¸…ç©ºç¾æœ‰é¸é …ï¼ˆä¿ç•™é è¨­é¸é …ï¼‰
            doctorSelect.innerHTML = '<option value="">è«‹é¸æ“‡é†«å¸«</option>';
            
            // æ·»åŠ é†«å¸«é¸é …
            doctors.forEach(doctor => {
                const option = document.createElement('option');
                option.value = doctor.username;
                option.textContent = `${doctor.name}é†«å¸«`;
                if (doctor.registrationNumber) {
                    option.textContent += ` (${doctor.registrationNumber})`;
                }
                doctorSelect.appendChild(option);
            });
            
            // å¦‚æœç•¶å‰ç”¨æˆ¶æ˜¯é†«å¸«ï¼Œé è¨­é¸æ“‡è‡ªå·±
            if (currentUserData && currentUserData.position === 'é†«å¸«') {
                doctorSelect.value = currentUserData.username;
            }
        }
        
        // é—œé–‰æ›è™Ÿå½ˆçª—
        function closeRegistrationModal() {
            document.getElementById('registrationModal').classList.add('hidden');
            clearRegistrationForm();
            selectedPatientForRegistration = null;
        }
        
        // æ¸…ç©ºæ›è™Ÿè¡¨å–®
        function clearRegistrationForm() {
            document.getElementById('appointmentDoctor').value = '';
            document.getElementById('quickChiefComplaint').value = '';
        }
        
        // ç¢ºèªæ›è™Ÿ
        function confirmRegistration() {
            if (!selectedPatientForRegistration) {
                showToast('ç³»çµ±éŒ¯èª¤ï¼šæœªé¸æ“‡ç—…äººï¼', 'error');
                return;
            }
            
            const appointmentDateTime = document.getElementById('appointmentDateTime').value;
            const appointmentDoctor = document.getElementById('appointmentDoctor').value;
            const chiefComplaint = document.getElementById('quickChiefComplaint').value.trim();
            
            if (!appointmentDateTime) {
                showToast('è«‹é¸æ“‡æ›è™Ÿæ™‚é–“ï¼', 'error');
                return;
            }
            
            if (!appointmentDoctor) {
                showToast('è«‹é¸æ“‡æ›è™Ÿé†«å¸«ï¼', 'error');
                return;
            }
            
            // é©—è­‰é¸æ“‡çš„é†«å¸«æ˜¯å¦å­˜åœ¨ä¸”å•Ÿç”¨
            const selectedDoctor = users.find(user => 
                user.username === appointmentDoctor && 
                user.active && 
                user.position === 'é†«å¸«'
            );
            
            if (!selectedDoctor) {
                showToast('é¸æ“‡çš„é†«å¸«ç„¡æ•ˆï¼Œè«‹é‡æ–°é¸æ“‡ï¼', 'error');
                return;
            }
            
            // é©—è­‰æ›è™Ÿæ™‚é–“ä¸èƒ½æ˜¯éå»æ™‚é–“ï¼ˆå…è¨±1åˆ†é˜çš„èª¤å·®ï¼‰
            const selectedTime = new Date(appointmentDateTime);
            const now = new Date();
            now.setMinutes(now.getMinutes() - 1); // å…è¨±1åˆ†é˜èª¤å·®
            if (selectedTime < now) {
                showToast('æ›è™Ÿæ™‚é–“ä¸èƒ½æ—©æ–¼ç¾åœ¨æ™‚é–“ï¼', 'error');
                return;
            }
            
    const appointment = {
        id: Date.now(),
        patientId: selectedPatientForRegistration.id,
        appointmentTime: selectedTime.toISOString(),
        appointmentDoctor: appointmentDoctor,
        chiefComplaint: chiefComplaint || 'ç„¡ç‰¹æ®Šä¸»è¨´',
        status: 'registered',
        createdAt: new Date().toISOString(),
        createdBy: currentUserData ? currentUserData.username : currentUser
    };
    
    appointments.push(appointment);
    localStorage.setItem('appointments', JSON.stringify(appointments));
    
    // åŒæ­¥åˆ°å¯¦æ™‚æ•¸æ“šåº«
    if (window.realtimeManager && window.realtimeManager.isReady) {
        window.realtimeManager.syncAppointmentToRealtime(appointment);
    }
    
    showToast(`${selectedPatientForRegistration.name} å·²æ›è™Ÿçµ¦ ${selectedDoctor.name}é†«å¸«ï¼`, 'success');
    
    closeRegistrationModal();
    clearPatientSearch();
    loadTodayAppointments();
}
        
        // æ¯æ—¥è‡ªå‹•æ¸…ç©ºæ›è™Ÿåˆ—è¡¨
        function clearOldAppointments() {
            const today = new Date().toDateString();
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayString = yesterday.toDateString();
            
            // ç§»é™¤æ˜¨å¤©åŠæ›´æ—©çš„æ›è™Ÿè¨˜éŒ„
            const originalLength = appointments.length;
            appointments = appointments.filter(apt => {
                const appointmentDate = new Date(apt.appointmentTime).toDateString();
                return appointmentDate >= today; // åªä¿ç•™ä»Šå¤©åŠä»¥å¾Œçš„æ›è™Ÿ
            });
            
            // å¦‚æœæœ‰æ¸…é™¤è¨˜éŒ„ï¼Œä¿å­˜åˆ°æœ¬åœ°å„²å­˜
            if (appointments.length < originalLength) {
                localStorage.setItem('appointments', JSON.stringify(appointments));
                console.log(`å·²æ¸…é™¤ ${originalLength - appointments.length} ç­†éæœŸæ›è™Ÿè¨˜éŒ„`);
            }
        }

// 3. ä¿®æ”¹ä»Šæ—¥æ›è™Ÿåˆ—è¡¨è¼‰å…¥åŠŸèƒ½ï¼Œç¢ºä¿èƒ½æ­£ç¢ºé¡¯ç¤ºç—…äººè³‡è¨Š
async function loadTodayAppointments() {
    // å…ˆæ¸…ç©ºéæœŸæ›è™Ÿ
    clearOldAppointments();
    
    const today = new Date().toDateString();
    let todayAppointments = appointments.filter(apt => 
        new Date(apt.appointmentTime).toDateString() === today
    );
    
    // å¦‚æœç•¶å‰ç”¨æˆ¶æ˜¯é†«å¸«ï¼Œåªé¡¯ç¤ºæ›çµ¦è‡ªå·±çš„ç—…äºº
    if (currentUserData && currentUserData.position === 'é†«å¸«') {
        todayAppointments = todayAppointments.filter(apt => 
            apt.appointmentDoctor === currentUserData.username
        );
    }
    
    // æŒ‰æ™‚é–“æ’åº
    todayAppointments.sort((a, b) => new Date(a.appointmentTime) - new Date(b.appointmentTime));
    
    const tbody = document.getElementById('todayAppointmentsList');
    document.getElementById('todayTotal').textContent = todayAppointments.length;
    
    if (todayAppointments.length === 0) {
        const message = currentUserData && currentUserData.position === 'é†«å¸«' 
            ? 'ä»Šæ—¥æš«ç„¡æ›çµ¦æ‚¨çš„ç—…äºº' 
            : 'ä»Šæ—¥æš«ç„¡æ›è™Ÿè¨˜éŒ„';
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                    ${message}
                </td>
            </tr>
        `;
        return;
    }
    
    try {
        // å¾ Firebase ç²å–æ‰€æœ‰ç—…äººè³‡æ–™
        const result = await window.firebaseDataManager.getPatients();
        const patientsData = result.success ? result.data : [];
        
        tbody.innerHTML = todayAppointments.map((appointment, index) => {
            // å¾ Firebase è³‡æ–™ä¸­å°‹æ‰¾å°æ‡‰ç—…äºº
            const patient = patientsData.find(p => p.id === appointment.patientId);
            
            if (!patient) {
                // å¦‚æœåœ¨ Firebase æ‰¾ä¸åˆ°ï¼Œå˜—è©¦å¾æœ¬åœ°é™£åˆ—æ‰¾ï¼ˆå‘å¾Œå…¼å®¹ï¼‰
                const localPatient = patients.find(p => p.id === appointment.patientId);
                if (!localPatient) {
                    return `
                        <tr class="hover:bg-gray-50">
                            <td colspan="7" class="px-4 py-3 text-center text-red-500">
                                æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ (ID: ${appointment.patientId})
                            </td>
                        </tr>
                    `;
                }
                // ä½¿ç”¨æœ¬åœ°ç—…äººè³‡æ–™
                return createAppointmentRow(appointment, localPatient, index);
            }
            
            // ä½¿ç”¨ Firebase ç—…äººè³‡æ–™
            return createAppointmentRow(appointment, patient, index);
        }).join('');
        
    } catch (error) {
        console.error('è¼‰å…¥æ›è™Ÿåˆ—è¡¨éŒ¯èª¤:', error);
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="px-4 py-8 text-center text-red-500">
                    è¼‰å…¥æ›è™Ÿåˆ—è¡¨å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢
                </td>
            </tr>
        `;
    }
}

// 1. ä¿®æ”¹ createAppointmentRow å‡½æ•¸ï¼Œç¢ºä¿è¨ºç—‡è¨˜éŒ„æŒ‰éˆ•æ­£ç¢ºå‚³é patientId
function createAppointmentRow(appointment, patient, index) {
    // ç²å–æ›è™Ÿé†«å¸«è³‡è¨Š
    const appointmentDoctor = users.find(u => u.username === appointment.appointmentDoctor);
    const doctorName = appointmentDoctor ? `${appointmentDoctor.name}é†«å¸«` : 'æœªæŒ‡å®šé†«å¸«';
    
    const statusInfo = getStatusInfo(appointment.status);
    const operationButtons = getOperationButtons(appointment, patient); // å‚³é patient åƒæ•¸
    
    return `
        <tr class="hover:bg-gray-50">
            <td class="px-4 py-3 text-sm text-gray-900 font-medium">${index + 1}</td>
            <td class="px-4 py-3 text-sm font-medium text-gray-900">
                ${patient.name}
                <div class="text-xs text-gray-500">${patient.patientNumber}</div>
            </td>
            <td class="px-4 py-3 text-sm text-gray-900">
                <div class="font-medium text-blue-600">${doctorName}</div>
            </td>
            <td class="px-4 py-3 text-sm text-gray-900">
                ${new Date(appointment.appointmentTime).toLocaleString('zh-TW', {
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                })}
            </td>
            <td class="px-4 py-3 text-sm text-gray-900">
                <div class="max-w-xs truncate" title="${appointment.chiefComplaint || 'ç„¡'}">
                    ${appointment.chiefComplaint || 'ç„¡'}
                </div>
            </td>
            <td class="px-4 py-3">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusInfo.class}">
                    ${statusInfo.text}
                </span>
            </td>
            <td class="px-4 py-3 text-sm">
                <div class="flex flex-wrap gap-1">
                    ${operationButtons}
                </div>
            </td>
        </tr>
    `;
}
        
        // ç²å–ç‹€æ…‹è³‡è¨Š
        function getStatusInfo(status) {
            const statusMap = {
                'registered': { text: 'å·²æ›è™Ÿ', class: 'bg-blue-100 text-blue-800' },
                'waiting': { text: 'å€™è¨ºä¸­', class: 'bg-yellow-100 text-yellow-800' },
                'consulting': { text: 'è¨ºç—‡ä¸­', class: 'bg-green-100 text-green-800' },
                'completed': { text: 'å·²å®Œæˆ', class: 'bg-gray-100 text-gray-800' }
            };
            return statusMap[status] || { text: 'æœªçŸ¥', class: 'bg-gray-100 text-gray-800' };
        }
        
// 2. ä¿®æ”¹ getOperationButtons å‡½æ•¸ï¼Œç¢ºä¿ä½¿ç”¨æ­£ç¢ºçš„ patientId
function getOperationButtons(appointment, patient = null) {
    const buttons = [];
    
    // æª¢æŸ¥æ˜¯å¦æœ‰ç—…äººæ­£åœ¨è¨ºç—‡ä¸­
    const isAnyoneConsulting = appointments.some(apt => 
        apt.status === 'consulting' && 
        new Date(apt.appointmentTime).toDateString() === new Date().toDateString()
    );
    
    const isCurrentConsulting = appointment.status === 'consulting';
    
    // æª¢æŸ¥ç•¶å‰ç”¨æˆ¶æ˜¯å¦ç‚ºè©²æ›è™Ÿçš„é†«å¸«
    const isAppointmentDoctor = currentUserData && 
        currentUserData.position === 'é†«å¸«' && 
        appointment.appointmentDoctor === currentUserData.username;
    
    // æª¢æŸ¥ç•¶å‰ç”¨æˆ¶æ˜¯å¦ç‚ºç®¡ç†å“¡æˆ–è­·ç†å¸«ï¼ˆå¯ä»¥é€²è¡Œç®¡ç†æ“ä½œï¼‰
    const canManage = currentUserData && 
        (currentUserData.position === 'è¨ºæ‰€ç®¡ç†' || currentUserData.position === 'è­·ç†å¸«');
    
    // æª¢æŸ¥ç•¶å‰ç”¨æˆ¶æ˜¯å¦å¯ä»¥ç¢ºèªåˆ°é”ï¼ˆç®¡ç†å“¡ã€è­·ç†å¸«æˆ–è©²æ›è™Ÿçš„é†«å¸«ï¼‰
    const canConfirmArrival = canManage || isAppointmentDoctor;
    
    // ä½¿ç”¨æ­£ç¢ºçš„ patientIdï¼ˆå„ªå…ˆä½¿ç”¨ Firebase IDï¼‰
    const patientId = patient ? patient.id : appointment.patientId;
    
    // æ‰€æœ‰ç‹€æ…‹éƒ½å¯ä»¥æŸ¥çœ‹è¨ºç—‡è¨˜éŒ„
    buttons.push(`<button onclick="viewPatientMedicalHistory('${patientId}')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs transition duration-200">è¨ºç—‡è¨˜éŒ„</button>`);
    
    // å¦‚æœæœ‰äººåœ¨è¨ºç—‡ä¸­ä¸”ä¸æ˜¯ç•¶å‰ç—…äººï¼Œå‰‡å…¶ä»–æ“ä½œéƒ½è¢«ç¦ç”¨
    const isDisabled = isAnyoneConsulting && !isCurrentConsulting;
    let disabledTooltip = '';
    if (isDisabled) {
        const consultingAppointment = appointments.find(apt => 
            apt.status === 'consulting' && 
            new Date(apt.appointmentTime).toDateString() === new Date().toDateString()
        );
        disabledTooltip = `title="æœ‰ç—…äººæ­£åœ¨è¨ºç—‡ä¸­ï¼Œæ“ä½œæš«æ™‚ç¦ç”¨"`;
    }
    
    switch (appointment.status) {
        case 'registered':
            if (isDisabled) {
                if (canConfirmArrival) {
                    buttons.push(`<span class="bg-gray-300 text-gray-500 px-2 py-1 rounded text-xs cursor-not-allowed" ${disabledTooltip}>ç¢ºèªåˆ°é”</span>`);
                }
                if (canManage) {
                    buttons.push(`<span class="bg-gray-300 text-gray-500 px-2 py-1 rounded text-xs cursor-not-allowed" ${disabledTooltip}>ç§»é™¤æ›è™Ÿ</span>`);
                }
            } else {
                if (canConfirmArrival) {
                    buttons.push(`<button onclick="confirmPatientArrival(${appointment.id})" class="bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded text-xs transition duration-200">ç¢ºèªåˆ°é”</button>`);
                }
                if (canManage) {
                    buttons.push(`<button onclick="removeAppointment(${appointment.id})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition duration-200">ç§»é™¤æ›è™Ÿ</button>`);
                }
            }
            break;
            
        case 'waiting':
            if (isDisabled) {
                if (isAppointmentDoctor) {
                    buttons.push(`<span class="bg-gray-300 text-gray-500 px-2 py-1 rounded text-xs cursor-not-allowed" ${disabledTooltip}>é–‹å§‹è¨ºç—‡</span>`);
                }
            } else {
                if (isAppointmentDoctor) {
                    buttons.push(`<button onclick="startConsultation(${appointment.id})" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs transition duration-200">é–‹å§‹è¨ºç—‡</button>`);
                }
            }
            break;
            
        case 'consulting':
            if (isAppointmentDoctor) {
                buttons.push(`<button onclick="continueConsultation(${appointment.id})" class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-xs transition duration-200">ç¹¼çºŒè¨ºç—‡</button>`);
            }
            break;
            
        case 'completed':
            // åˆ—å°æ”¶æ“šåŠŸèƒ½ä¸å—è¨ºç—‡ç‹€æ…‹é™åˆ¶
            buttons.push(`<button onclick="printReceiptFromAppointment(${appointment.id})" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs transition duration-200">åˆ—å°æ”¶æ“š</button>`);
            buttons.push(`<button onclick="printAttendanceCertificateFromAppointment(${appointment.id})" class="bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-xs transition duration-200">åˆ°è¨ºè­‰æ˜</button>`);
            buttons.push(`<button onclick="printSickLeaveFromAppointment(${appointment.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs transition duration-200">ç—…å‡è­‰æ˜</button>`);
            
            if (isDisabled) {
                if (isAppointmentDoctor) {
                    buttons.push(`<span class="bg-gray-300 text-gray-500 px-2 py-1 rounded text-xs cursor-not-allowed" ${disabledTooltip}>ä¿®æ”¹ç—…æ­·</span>`);
                }
                if (canManage) {
                    buttons.push(`<span class="bg-gray-300 text-gray-500 px-2 py-1 rounded text-xs cursor-not-allowed" ${disabledTooltip}>æ’¤å›è¨ºç—‡</span>`);
                }
            } else {
                if (isAppointmentDoctor) {
                    buttons.push(`<button onclick="editMedicalRecord(${appointment.id})" class="bg-orange-500 hover:bg-orange-600 text-white px-2 py-1 rounded text-xs transition duration-200">ä¿®æ”¹ç—…æ­·</button>`);
                }
                if (canManage) {
                    buttons.push(`<button onclick="withdrawConsultation(${appointment.id})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition duration-200">æ’¤å›è¨ºç—‡</button>`);
                }
            }
            break;
            
        default:
            buttons.push('<span class="text-gray-400 text-xs">ç‹€æ…‹ç•°å¸¸</span>');
            break;
    }
    
    return buttons.join('');
}

        
// 3. ä¿®æ”¹ç¢ºèªç—…äººåˆ°é”å‡½æ•¸ï¼Œæ”¯æ´ Firebase
async function confirmPatientArrival(appointmentId) {
    const appointment = appointments.find(apt => apt.id === appointmentId);
    if (!appointment) {
        showToast('æ‰¾ä¸åˆ°æ›è™Ÿè¨˜éŒ„ï¼', 'error');
        return;
    }
    
    try {
        // å¾ Firebase ç²å–ç—…äººè³‡æ–™
        const result = await window.firebaseDataManager.getPatients();
        if (!result.success) {
            showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        
        const patient = result.data.find(p => p.id === appointment.patientId);
        if (!patient) {
            showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        
        // è©³ç´°ç‹€æ…‹æª¢æŸ¥
        console.log(`ç¢ºèªåˆ°é”ç‹€æ…‹æª¢æŸ¥ - ç—…äºº: ${patient.name}, ç•¶å‰ç‹€æ…‹: ${appointment.status}`);
        
        // åªæœ‰å·²æ›è™Ÿç‹€æ…‹æ‰èƒ½ç¢ºèªåˆ°é”
        if (appointment.status !== 'registered') {
            const statusNames = {
                'waiting': 'å€™è¨ºä¸­',
                'consulting': 'è¨ºç—‡ä¸­',
                'completed': 'å·²å®Œæˆ'
            };
            const currentStatusName = statusNames[appointment.status] || appointment.status;
            showToast(`ç„¡æ³•ç¢ºèªåˆ°é”ï¼ç—…äºº ${patient.name} ç›®å‰ç‹€æ…‹ç‚ºã€Œ${currentStatusName}ã€ï¼Œåªèƒ½å°ã€Œå·²æ›è™Ÿã€çš„ç—…äººç¢ºèªåˆ°é”ã€‚`, 'warning');
            return;
        }
        
        // æ›´æ–°ç‹€æ…‹ç‚ºå€™è¨ºä¸­
    appointment.status = 'waiting';
    appointment.arrivedAt = new Date().toISOString();
    appointment.confirmedBy = currentUserData ? currentUserData.username : currentUser;
    
    localStorage.setItem('appointments', JSON.stringify(appointments));
    
    // æ›´æ–°å¯¦æ™‚ç‹€æ…‹
    if (window.realtimeManager) {
        await window.realtimeManager.updateAppointmentStatus(appointmentId, 'waiting', {
            arrivedAt: appointment.arrivedAt,
            confirmedBy: appointment.confirmedBy
        });
    }
    
    showToast(`ç—…äººå·²ç¢ºèªåˆ°é”ï¼Œé€²å…¥å€™è¨ºç‹€æ…‹ï¼`, 'success');
    loadTodayAppointments();
    } catch (error) {
        console.error('ç¢ºèªç—…äººåˆ°é”éŒ¯èª¤:', error);
        // å‡ºç¾ä»»ä½•éŒ¯èª¤æ™‚é¡¯ç¤ºé€šçŸ¥ï¼Œé¿å…æœªè™•ç†çš„ä¾‹å¤–å°è‡´ç™»å…¥åŠŸèƒ½ç„¡æ³•æ­£å¸¸åŸ·è¡Œ
        showToast('ç¢ºèªç—…äººåˆ°é”æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
    }
}
        
 // 5. ä¿®æ”¹ç§»é™¤æ›è™Ÿå‡½æ•¸ï¼Œæ”¯æ´ Firebase
async function removeAppointment(appointmentId) {
    const appointment = appointments.find(apt => apt.id === appointmentId);
    if (!appointment) {
        showToast('æ‰¾ä¸åˆ°æ›è™Ÿè¨˜éŒ„ï¼', 'error');
        return;
    }
    
    try {
        // å¾ Firebase ç²å–ç—…äººè³‡æ–™
        const result = await window.firebaseDataManager.getPatients();
        if (!result.success) {
            showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        
        const patient = result.data.find(p => p.id === appointment.patientId);
        if (!patient) {
            showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        
        // è©³ç´°ç‹€æ…‹æª¢æŸ¥
        console.log(`ç§»é™¤æ›è™Ÿç‹€æ…‹æª¢æŸ¥ - ç—…äºº: ${patient.name}, ç•¶å‰ç‹€æ…‹: ${appointment.status}`);
        
        // æª¢æŸ¥æ˜¯å¦å¯ä»¥ç§»é™¤
        if (appointment.status === 'waiting') {
            showToast(`ç„¡æ³•ç§»é™¤æ›è™Ÿï¼ç—…äºº ${patient.name} å·²ç¢ºèªåˆ°é”å€™è¨ºä¸­ï¼Œè«‹è¯ç¹«é†«å¸«è™•ç†ã€‚`, 'warning');
            return;
        }
        
        if (appointment.status === 'consulting') {
            showToast(`ç„¡æ³•ç§»é™¤æ›è™Ÿï¼ç—…äºº ${patient.name} ç›®å‰æ­£åœ¨è¨ºç—‡ä¸­ï¼Œè«‹å…ˆçµæŸè¨ºç—‡å¾Œå†ç§»é™¤ã€‚`, 'warning');
            return;
        }
        
        if (appointment.status === 'completed') {
            showToast(`ç„¡æ³•ç§»é™¤æ›è™Ÿï¼ç—…äºº ${patient.name} å·²å®Œæˆè¨ºç—‡ï¼Œå·²å®Œæˆçš„è¨˜éŒ„ç„¡æ³•ç§»é™¤ã€‚`, 'warning');
            return;
        }
        
        // ç¢ºèªç§»é™¤
        const statusNames = {
            'registered': 'å·²æ›è™Ÿ',
            'waiting': 'å€™è¨ºä¸­'
        };
        const statusText = statusNames[appointment.status] || appointment.status;
        
        const confirmMessage = `ç¢ºå®šè¦ç§»é™¤ ${patient.name} çš„æ›è™Ÿå—ï¼Ÿ\n\n` +
                             `ç‹€æ…‹ï¼š${statusText}\n` +
                             `æ›è™Ÿæ™‚é–“ï¼š${new Date(appointment.appointmentTime).toLocaleString('zh-TW')}\n\n` +
                             `æ³¨æ„ï¼šæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`;
        
        if (confirm(confirmMessage)) {
            // å¾æ›è™Ÿåˆ—è¡¨ä¸­ç§»é™¤
            appointments = appointments.filter(apt => apt.id !== appointmentId);
            localStorage.setItem('appointments', JSON.stringify(appointments));
            
            showToast(`å·²ç§»é™¤ ${patient.name} çš„æ›è™Ÿè¨˜éŒ„`, 'success');
            loadTodayAppointments();
            
            // å¦‚æœæ­£åœ¨è¨ºç—‡è¡¨å–®ä¸­é¡¯ç¤ºè©²ç—…äººï¼Œå‰‡é—œé–‰è¡¨å–®
            if (currentConsultingAppointmentId === appointmentId) {
                closeConsultationForm();
                currentConsultingAppointmentId = null;
            }
        }
        
    } catch (error) {
        console.error('ç§»é™¤æ›è™ŸéŒ¯èª¤:', error);
        showToast('ç§»é™¤æ›è™Ÿæ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
    }
}

        

        
 // 4. ä¿®æ”¹é–‹å§‹è¨ºç—‡å‡½æ•¸ï¼Œæ”¯æ´ Firebase
async function startConsultation(appointmentId) {
    const appointment = appointments.find(apt => apt.id === appointmentId);
    if (!appointment) {
        showToast('æ‰¾ä¸åˆ°æ›è™Ÿè¨˜éŒ„ï¼', 'error');
        return;
    }
    
    try {
        // å¾ Firebase ç²å–ç—…äººè³‡æ–™
        const result = await window.firebaseDataManager.getPatients();
        if (!result.success) {
            showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        
        const patient = result.data.find(p => p.id === appointment.patientId);
        if (!patient) {
            showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        
        // æª¢æŸ¥ç•¶å‰ç”¨æˆ¶æ˜¯å¦ç‚ºè©²æ›è™Ÿçš„é†«å¸«
        if (!currentUserData || currentUserData.position !== 'é†«å¸«' || appointment.appointmentDoctor !== currentUserData.username) {
            showToast('åªæœ‰è©²æ›è™Ÿçš„é†«å¸«æ‰èƒ½é–‹å§‹è¨ºç—‡ï¼', 'error');
            return;
        }
        
        // è©³ç´°ç‹€æ…‹æª¢æŸ¥
        console.log(`é–‹å§‹è¨ºç—‡ç‹€æ…‹æª¢æŸ¥ - ç—…äºº: ${patient.name}, ç•¶å‰ç‹€æ…‹: ${appointment.status}`);
        
        // æª¢æŸ¥ç—…äººç‹€æ…‹æ˜¯å¦å…è¨±é–‹å§‹è¨ºç—‡
        if (!['waiting', 'registered'].includes(appointment.status)) {
            const statusNames = {
                'consulting': 'è¨ºç—‡ä¸­',
                'completed': 'å·²å®Œæˆ'
            };
            const currentStatusName = statusNames[appointment.status] || appointment.status;
            showToast(`ç„¡æ³•é–‹å§‹è¨ºç—‡ï¼ç—…äºº ${patient.name} ç›®å‰ç‹€æ…‹ç‚ºã€Œ${currentStatusName}ã€ï¼Œåªèƒ½å°ã€Œå·²æ›è™Ÿã€æˆ–ã€Œå€™è¨ºä¸­ã€çš„ç—…äººé–‹å§‹è¨ºç—‡ã€‚`, 'error');
            return;
        }
        
        // å¦‚æœæ˜¯å·²æ›è™Ÿç‹€æ…‹ï¼Œè‡ªå‹•ç¢ºèªåˆ°é”
        if (appointment.status === 'registered') {
            appointment.arrivedAt = new Date().toISOString();
            appointment.confirmedBy = currentUserData ? currentUserData.username : currentUser;
            showToast(`${patient.name} å·²è‡ªå‹•ç¢ºèªåˆ°é”`, 'info');
        }
        
        // æª¢æŸ¥æ˜¯å¦å·²æœ‰å…¶ä»–ç—…äººåœ¨è¨ºç—‡ä¸­ï¼ˆåªæª¢æŸ¥åŒä¸€é†«å¸«çš„ç—…äººï¼‰
        const consultingAppointment = appointments.find(apt => 
            apt.status === 'consulting' && 
            apt.id !== appointmentId &&
            apt.appointmentDoctor === currentUserData.username &&
            new Date(apt.appointmentTime).toDateString() === new Date().toDateString()
        );
        
        if (consultingAppointment) {
            // å¾ Firebase ç²å–æ­£åœ¨è¨ºç—‡çš„ç—…äººè³‡æ–™
            const consultingPatient = result.data.find(p => p.id === consultingAppointment.patientId);
            const consultingPatientName = consultingPatient ? consultingPatient.name : 'æœªçŸ¥ç—…äºº';
            
            if (confirm(`æ‚¨ç›®å‰æ­£åœ¨ç‚º ${consultingPatientName} è¨ºç—‡ã€‚\n\næ˜¯å¦è¦çµæŸè©²ç—…äººçš„è¨ºç—‡ä¸¦é–‹å§‹ç‚º ${patient.name} è¨ºç—‡ï¼Ÿ\n\næ³¨æ„ï¼š${consultingPatientName} çš„ç‹€æ…‹å°‡æ”¹å›å€™è¨ºä¸­ã€‚`)) {
                // çµæŸç•¶å‰è¨ºç—‡çš„ç—…äºº
                consultingAppointment.status = 'waiting';
                delete consultingAppointment.consultationStartTime;
                delete consultingAppointment.consultingDoctor;
                
                // é—œé–‰å¯èƒ½é–‹å•Ÿçš„è¨ºç—‡è¡¨å–®
                if (currentConsultingAppointmentId === consultingAppointment.id) {
                    closeConsultationForm();
                }
                
                showToast(`å·²çµæŸ ${consultingPatientName} çš„è¨ºç—‡`, 'info');
            } else {
                return; // ç”¨æˆ¶å–æ¶ˆæ“ä½œ
            }
        }
        
        // é–‹å§‹æ–°çš„è¨ºç—‡ - æ­£ç¢ºè¨­ç½®ç‹€æ…‹ç‚ºè¨ºç—‡ä¸­
    appointment.status = 'consulting';
    appointment.consultationStartTime = new Date().toISOString();
    appointment.consultingDoctor = currentUserData ? currentUserData.username : currentUser;
    
    localStorage.setItem('appointments', JSON.stringify(appointments));
    
    // æ›´æ–°å¯¦æ™‚ç‹€æ…‹
    if (window.realtimeManager) {
        await window.realtimeManager.updateConsultationStatus(appointmentId, {
            step: 'consulting',
            doctor: currentUser,
            patientId: appointment.patientId,
            startTime: appointment.consultationStartTime
        });
    }
    
    currentConsultingAppointmentId = appointmentId;
    showConsultationForm(appointment);
    loadTodayAppointments();
    
    showToast(`é–‹å§‹è¨ºç—‡`, 'success');
    } catch (error) {
        console.error('é–‹å§‹è¨ºç—‡éŒ¯èª¤:', error);
        // å‡ºç¾ä»»ä½•éŒ¯èª¤æ™‚é¡¯ç¤ºé€šçŸ¥ï¼Œé¿å…æœªè™•ç†çš„ä¾‹å¤–å°è‡´åŠŸèƒ½ç„¡æ³•æ­£å¸¸åŸ·è¡Œ
        showToast('é–‹å§‹è¨ºç—‡æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
    }
}
        
        // ç¹¼çºŒè¨ºç—‡
        function continueConsultation(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) return;
            
            currentConsultingAppointmentId = appointmentId;
            showConsultationForm(appointment);
        }
        
// ä¿®å¾©è¨ºç—‡è¡¨å–®é¡¯ç¤ºå‡½æ•¸
async function showConsultationForm(appointment) {
    try {
        // å¾ Firebase ç²å–ç—…äººè³‡æ–™
        const result = await window.firebaseDataManager.getPatients();
        if (!result.success) {
            showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        
        const patient = result.data.find(p => p.id === appointment.patientId);
        if (!patient) {
            showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        
        // è¨­ç½®ç—…äººè³‡è¨Š
        document.getElementById('formPatientName').textContent = `${patient.name} (${patient.patientNumber})`;
        document.getElementById('formAppointmentTime').textContent = new Date(appointment.appointmentTime).toLocaleString('zh-TW');
        renderPatientPackages(patient.id);
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºç·¨è¼¯æ¨¡å¼
        if (appointment.status === 'completed' && appointment.consultationId) {
            // ç·¨è¼¯æ¨¡å¼ï¼šå¾ Firebase è¼‰å…¥ç¾æœ‰è¨ºç—‡è¨˜éŒ„
            await loadConsultationForEdit(appointment.consultationId);
        } else {
            // æ–°è¨ºç—‡æ¨¡å¼ï¼šä½¿ç”¨ç©ºç™½è¡¨å–®
            clearConsultationForm();
            
            // è¨­ç½®é è¨­å€¼
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const localDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
            document.getElementById('formVisitTime').value = localDateTime;
            
            // è¨­ç½®é è¨­ä¼‘æ¯æœŸé–“
            const startDate = new Date();
            const endDate = new Date();
            endDate.setDate(startDate.getDate() + 2);
            
            const startDateStr = `${startDate.getFullYear()}-${String(startDate.getMonth() + 1).padStart(2, '0')}-${String(startDate.getDate()).padStart(2, '0')}`;
            const endDateStr = `${endDate.getFullYear()}-${String(endDate.getMonth() + 1).padStart(2, '0')}-${String(endDate.getDate()).padStart(2, '0')}`;
            
            document.getElementById('formRestStartDate').value = startDateStr;
            document.getElementById('formRestEndDate').value = endDateStr;
            updateRestPeriod();
            
            // å¦‚æœæ›è™Ÿæ™‚æœ‰å¡«å¯«ä¸»è¨´ï¼Œå‰‡é å¡«åˆ°ä¸»è¨´æ¬„ä½
            if (appointment.chiefComplaint && appointment.chiefComplaint !== 'ç„¡ç‰¹æ®Šä¸»è¨´') {
                document.getElementById('formSymptoms').value = appointment.chiefComplaint;
            }
            
            // è‡ªå‹•æ·»åŠ é è¨­è¨ºé‡‘æ”¶è²»é …ç›®
            addDefaultConsultationFee(patient);
            
            document.getElementById('consultationSaveButtonText').textContent = 'å®Œæˆè¨ºç—‡';
        }
        
        document.getElementById('consultationForm').classList.remove('hidden');
        
        // æ»¾å‹•åˆ°è¡¨å–®ä½ç½®
        document.getElementById('consultationForm').scrollIntoView({ behavior: 'smooth' });
        
    } catch (error) {
        console.error('é¡¯ç¤ºè¨ºç—‡è¡¨å–®éŒ¯èª¤:', error);
        showToast('è¼‰å…¥è¨ºç—‡è¡¨å–®æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
    }
}

// æ–°å¢ï¼šè§£æè¨ºç—‡æ—¥æœŸçš„é€šç”¨å‡½æ•¸
function parseConsultationDate(dateInput) {
    if (!dateInput) return null;
    
    try {
        // å¦‚æœæ˜¯ Firebase Timestamp æ ¼å¼
        if (dateInput.seconds) {
            return new Date(dateInput.seconds * 1000);
        }
        
        // å¦‚æœæ˜¯å­—ç¬¦ä¸²æ ¼å¼
        if (typeof dateInput === 'string') {
            const parsed = new Date(dateInput);
            if (!isNaN(parsed.getTime())) {
                return parsed;
            }
        }
        
        // å¦‚æœæ˜¯ Date å°è±¡
        if (dateInput instanceof Date) {
            return dateInput;
        }
        
        // å¦‚æœæ˜¯æ•¸å­—æ ¼å¼ï¼ˆtimestampï¼‰
        if (typeof dateInput === 'number') {
            return new Date(dateInput);
        }
        
        return null;
    } catch (error) {
        console.error('æ—¥æœŸè§£æéŒ¯èª¤:', error, dateInput);
        return null;
    }
}

// ä¿®å¾©æ ¼å¼åŒ–è¨ºç—‡æ—¥æœŸé¡¯ç¤º
function formatConsultationDate(dateInput) {
    const date = parseConsultationDate(dateInput);
    if (!date || isNaN(date.getTime())) {
        return 'æ—¥æœŸæœªçŸ¥';
    }
    
    return date.toLocaleDateString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
    });
}

function formatConsultationDateTime(dateInput) {
    const date = parseConsultationDate(dateInput);
    if (!date || isNaN(date.getTime())) {
        return 'æ™‚é–“æœªçŸ¥';
    }
    
    return date.toLocaleString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

        
// æ–°å¢ï¼šå¾ Firebase è¼‰å…¥è¨ºç—‡è¨˜éŒ„é€²è¡Œç·¨è¼¯
async function loadConsultationForEdit(consultationId) {
    try {
        // å…ˆå˜—è©¦å¾æœ¬åœ°æ‰¾
        let consultation = consultations.find(c => c.id === consultationId);
        
        // å¦‚æœæœ¬åœ°æ‰¾ä¸åˆ°ï¼Œå¾ Firebase æ‰¾
        if (!consultation) {
            const consultationResult = await window.firebaseDataManager.getConsultations();
            if (consultationResult.success) {
                consultation = consultationResult.data.find(c => c.id === consultationId);
                if (consultation) {
                    // åŒæ­¥åˆ°æœ¬åœ°
                    consultations.push(consultation);
                    localStorage.setItem('consultations', JSON.stringify(consultations));
                }
            }
        }
        
        if (consultation) {
            // è¼‰å…¥è¨ºç—‡è¨˜éŒ„å…§å®¹
            document.getElementById('formSymptoms').value = consultation.symptoms || '';
            document.getElementById('formTongue').value = consultation.tongue || '';
            document.getElementById('formPulse').value = consultation.pulse || '';
            document.getElementById('formCurrentHistory').value = consultation.currentHistory || '';
            document.getElementById('formDiagnosis').value = consultation.diagnosis || '';
            document.getElementById('formSyndrome').value = consultation.syndrome || '';
            document.getElementById('formAcupunctureNotes').value = consultation.acupunctureNotes || '';
            document.getElementById('formUsage').value = consultation.usage || '';
            document.getElementById('formTreatmentCourse').value = consultation.treatmentCourse || '';
            document.getElementById('formInstructions').value = consultation.instructions || '';
            document.getElementById('formFollowUpDate').value = consultation.followUpDate || '';
            
            // è™•ç†åˆ°è¨ºæ™‚é–“ - æ”¯æ´å¤šç¨®æ—¥æœŸæ ¼å¼
            if (consultation.visitTime) {
                const visitTime = parseConsultationDate(consultation.visitTime);
                if (visitTime) {
                    const year = visitTime.getFullYear();
                    const month = String(visitTime.getMonth() + 1).padStart(2, '0');
                    const day = String(visitTime.getDate()).padStart(2, '0');
                    const hours = String(visitTime.getHours()).padStart(2, '0');
                    const minutes = String(visitTime.getMinutes()).padStart(2, '0');
                    document.getElementById('formVisitTime').value = `${year}-${month}-${day}T${hours}:${minutes}`;
                }
            }
            
            // è¼‰å…¥ä¼‘æ¯æœŸé–“è¨­å®š
            if (consultation.restStartDate && consultation.restEndDate) {
                document.getElementById('formRestStartDate').value = consultation.restStartDate;
                document.getElementById('formRestEndDate').value = consultation.restEndDate;
                updateRestPeriod();
            } else {
                // ä½¿ç”¨é è¨­å€¼
                const startDate = new Date();
                const endDate = new Date();
                endDate.setDate(startDate.getDate() + 2);
                
                const startDateStr = `${startDate.getFullYear()}-${String(startDate.getMonth() + 1).padStart(2, '0')}-${String(startDate.getDate()).padStart(2, '0')}`;
                const endDateStr = `${endDate.getFullYear()}-${String(endDate.getMonth() + 1).padStart(2, '0')}-${String(endDate.getDate()).padStart(2, '0')}`;
                
                document.getElementById('formRestStartDate').value = startDateStr;
                document.getElementById('formRestEndDate').value = endDateStr;
                updateRestPeriod();
            }
            
            // è¼‰å…¥è™•æ–¹å…§å®¹
            selectedPrescriptionItems = [];
            if (consultation.prescription) {
                document.getElementById('formPrescription').value = consultation.prescription;
                parsePrescriptionToItems(consultation.prescription);
                updatePrescriptionDisplay();
            }
            
            // è¼‰å…¥æ”¶è²»é …ç›®
            selectedBillingItems = [];
            if (consultation.billingItems) {
                document.getElementById('formBillingItems').value = consultation.billingItems;
                parseBillingItemsFromText(consultation.billingItems);
                updateBillingDisplay();
            }
            
            document.getElementById('consultationSaveButtonText').textContent = 'æ›´æ–°ç—…æ­·';
        } else {
            showToast('æ‰¾ä¸åˆ°è¨ºç—‡è¨˜éŒ„ï¼Œå°‡ä½¿ç”¨ç©ºç™½è¡¨å–®', 'warning');
            clearConsultationForm();
        }
    } catch (error) {
        console.error('è¼‰å…¥è¨ºç—‡è¨˜éŒ„éŒ¯èª¤:', error);
        showToast('è¼‰å…¥è¨ºç—‡è¨˜éŒ„å¤±æ•—ï¼Œå°‡ä½¿ç”¨ç©ºç™½è¡¨å–®', 'warning');
        clearConsultationForm();
    }
}

        
        // æ¸…ç©ºè¨ºç—‡è¡¨å–®
        function clearConsultationForm() {
            ['formSymptoms', 'formTongue', 'formPulse', 'formCurrentHistory', 'formDiagnosis', 'formSyndrome', 'formAcupunctureNotes', 'formPrescription', 'formFollowUpDate', 'formVisitTime', 'formRestStartDate', 'formRestEndDate'].forEach(id => {
                document.getElementById(id).value = '';
            });
            
            // é‡ç½®æœè—¥æ—¥æ•¸å’Œæ¬¡æ•¸ç‚ºé è¨­å€¼
            document.getElementById('medicationDays').value = '5';
            document.getElementById('medicationFrequency').value = '2';
            
            // é‡ç½®ä¼‘æ¯æœŸé–“é¡¯ç¤º
            document.getElementById('restPeriodDisplay').textContent = 'è«‹é¸æ“‡é–‹å§‹å’ŒçµæŸæ—¥æœŸ';
            document.getElementById('restPeriodDisplay').className = 'text-sm text-gray-500 font-medium';
            
            // è¨­ç½®é è¨­å€¼
            document.getElementById('formUsage').value = 'æ—©æ™šä¸€æ¬¡ï¼Œé£¯å¾Œæœ';
            document.getElementById('formInstructions').value = 'æ³¨æ„ä¼‘æ¯ï¼Œé£²é£Ÿæ¸…æ·¡';
            document.getElementById('formTreatmentCourse').value = 'ä¸€å‘¨';
            
            // æ¸…ç©ºè™•æ–¹é …ç›®
            selectedPrescriptionItems = [];
            updatePrescriptionDisplay();
            clearPrescriptionSearch();
            
            // æ¸…ç©ºæ”¶è²»é …ç›®ï¼ˆä½†æœƒåœ¨ prefillWithPreviousRecord ä¸­è‡ªå‹•æ·»åŠ è¨ºé‡‘ï¼‰
            selectedBillingItems = [];
            updateBillingDisplay();
            clearBillingSearch();
        }
        
        // é—œé–‰è¨ºç—‡è¡¨å–®
        function closeConsultationForm() {
            // éš±è—è¨ºç—‡è¡¨å–®
            document.getElementById('consultationForm').classList.add('hidden');
            
            // æ¸…ç†å…¨åŸŸè®Šæ•¸
            currentConsultingAppointmentId = null;
            
            // æ¸…ç©ºè™•æ–¹å’Œæ”¶è²»é …ç›®é¸æ“‡
            selectedPrescriptionItems = [];
            selectedBillingItems = [];
            
            // æ»¾å‹•å›é ‚éƒ¨
            document.getElementById('consultationSystem').scrollIntoView({ behavior: 'smooth' });
        }
        
        // å–æ¶ˆè¨ºç—‡
        async function cancelConsultation() {
            if (!currentConsultingAppointmentId) {
                closeConsultationForm();
                return;
            }
            
            const appointment = appointments.find(apt => apt.id === currentConsultingAppointmentId);
            if (!appointment) {
                closeConsultationForm();
                currentConsultingAppointmentId = null;
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            if (!patient) {
                closeConsultationForm();
                currentConsultingAppointmentId = null;
                return;
            }
            
            // è©³ç´°ç‹€æ…‹æª¢æŸ¥
            console.log(`å–æ¶ˆè¨ºç—‡ç‹€æ…‹æª¢æŸ¥ - ç—…äºº: ${patient.name}, ç•¶å‰ç‹€æ…‹: ${appointment.status}`);
            
            if (appointment.status === 'consulting') {
                const confirmMessage = `ç¢ºå®šè¦å–æ¶ˆ ${patient.name} çš„è¨ºç—‡å—ï¼Ÿ\n\n` +
                                     `ç—…äººç‹€æ…‹å°‡å›åˆ°å€™è¨ºä¸­ï¼Œå·²å¡«å¯«çš„è¨ºç—‡å…§å®¹å°‡æœƒéºå¤±ã€‚\n\n` +
                                     `æ³¨æ„ï¼šæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`;
                
                if (confirm(confirmMessage)) {
                    // å°‡ç‹€æ…‹æ”¹å›å€™è¨ºä¸­
                    appointment.status = 'waiting';
                    delete appointment.consultationStartTime;
                    delete appointment.consultingDoctor;
                    
                    // ä¿å­˜ç‹€æ…‹è®Šæ›´
                    localStorage.setItem('appointments', JSON.stringify(appointments));
                    
                    showToast(`å·²å–æ¶ˆ ${patient.name} çš„è¨ºç—‡ï¼Œç—…äººå›åˆ°å€™è¨ºç‹€æ…‹`, 'info');
                    
                    // é—œé–‰è¡¨å–®ä¸¦æ¸…ç†
                    closeConsultationForm();
                    currentConsultingAppointmentId = null;
                    loadTodayAppointments();
                }
            } else if (appointment.status === 'completed') {
                // å¦‚æœæ˜¯å·²å®Œæˆçš„è¨ºç—‡ï¼Œåªæ˜¯é—œé–‰ç·¨è¼¯æ¨¡å¼
                showToast('å·²é€€å‡ºç—…æ­·ç·¨è¼¯æ¨¡å¼', 'info');
                closeConsultationForm();
                currentConsultingAppointmentId = null;
            } else {
                // å…¶ä»–ç‹€æ…‹ç›´æ¥é—œé–‰
                closeConsultationForm();
                currentConsultingAppointmentId = null;
            }
        }
        
        // å„²å­˜è¨ºç—‡è¨˜éŒ„ï¼ˆé†«å¸«æ“ä½œï¼‰
async function saveConsultation() {
    if (!currentConsultingAppointmentId) {
        showToast('ç³»çµ±éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è¨ºç—‡è¨˜éŒ„ï¼', 'error');
        return;
    }
    
    const symptoms = document.getElementById('formSymptoms').value.trim();
    const diagnosis = document.getElementById('formDiagnosis').value.trim();
    
    if (!symptoms || !diagnosis) {
        showToast('è«‹å¡«å¯«å¿…å¡«æ¬„ä½ï¼šä¸»è¨´ã€ä¸­é†«è¨ºæ–·ï¼', 'error');
        return;
    }

    try {
        // ç²å–ç•¶å‰æ›è™Ÿä¿¡æ¯ï¼ˆå¾åŸå§‹æ•¸æ“šçµæ§‹ç²å–ï¼Œå› ç‚ºæ›è™Ÿé‚„æ²’æœ‰é·ç§»åˆ° Firebaseï¼‰
        const appointment = appointments.find(apt => apt.id === currentConsultingAppointmentId);
        if (!appointment) {
            showToast('æ‰¾ä¸åˆ°æ›è™Ÿè¨˜éŒ„ï¼', 'error');
            return;
        }

        const consultation = {
            appointmentId: currentConsultingAppointmentId,
            patientId: appointment.patientId,
            symptoms: symptoms,
            tongue: document.getElementById('formTongue').value.trim(),
            pulse: document.getElementById('formPulse').value.trim(),
            currentHistory: document.getElementById('formCurrentHistory').value.trim(),
            diagnosis: diagnosis,
            syndrome: document.getElementById('formSyndrome').value.trim(),
            acupunctureNotes: document.getElementById('formAcupunctureNotes').value.trim(),
            prescription: document.getElementById('formPrescription').value.trim(),
            usage: document.getElementById('formUsage').value.trim(),
            treatmentCourse: document.getElementById('formTreatmentCourse').value.trim(),
            instructions: document.getElementById('formInstructions').value.trim(),
            followUpDate: document.getElementById('formFollowUpDate').value,
            visitTime: document.getElementById('formVisitTime').value,
            restStartDate: document.getElementById('formRestStartDate').value,
            restEndDate: document.getElementById('formRestEndDate').value,
            billingItems: document.getElementById('formBillingItems').value.trim(),
            date: new Date(),
            doctor: currentUser,
            status: 'completed'
        };

        // é¡¯ç¤ºä¿å­˜ä¸­ç‹€æ…‹
        const saveButton = document.querySelector('[onclick="saveConsultation()"]');
        const originalText = saveButton.textContent;
        saveButton.textContent = 'ä¿å­˜ä¸­...';
        saveButton.disabled = true;

        // ä¿å­˜åˆ° Firebase
        const result = await window.firebaseDataManager.addConsultation(consultation);

        if (result.success) {
            // æ›´æ–°æœ¬åœ°æ›è™Ÿç‹€æ…‹ï¼ˆæš«æ™‚ï¼Œç›´åˆ°æ›è™Ÿç³»çµ±ä¹Ÿé·ç§»åˆ° Firebaseï¼‰
            appointment.status = 'completed';
            appointment.completedAt = new Date().toISOString();
            appointment.consultationId = result.id;
            appointment.completedBy = currentUser;
            localStorage.setItem('appointments', JSON.stringify(appointments));

            showToast('è¨ºç—‡è¨˜éŒ„å·²ä¿å­˜ï¼', 'success');
            
            closeConsultationForm();
            loadTodayAppointments();
            updateStatistics();
            clearAllSearchFields();

        } else {
            showToast('ä¿å­˜è¨ºç—‡è¨˜éŒ„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
        }

    } catch (error) {
        console.error('ä¿å­˜è¨ºç—‡è¨˜éŒ„éŒ¯èª¤:', error);
        showToast('ä¿å­˜æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
    } finally {
        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
        const saveButton = document.querySelector('[onclick="saveConsultation()"]');
        if (saveButton) {
            saveButton.textContent = originalText;
            saveButton.disabled = false;
        }
    }
}
        
        // ç—…äººè³‡æ–™ç®¡ç†é é¢çš„ç—…æ­·æŸ¥çœ‹åŠŸèƒ½
        let currentPatientConsultations = [];
        let currentPatientHistoryPage = 0;
        
        async function showPatientMedicalHistory(patientId) {
    try {
const patientResult = await window.firebaseDataManager.getPatients();
if (!patientResult.success) {
    showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™ï¼', 'error');
    return;
}

const patient = patientResult.data.find(p => p.id === patientId);
if (!patient) {
    showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ï¼', 'error');
    return;
}
            
            // ç²å–è©²ç—…äººçš„æ‰€æœ‰è¨ºç—‡è¨˜éŒ„
            currentPatientConsultations = consultations
                .filter(c => c.patientId === patientId)
                .sort((a, b) => new Date(a.date) - new Date(b.date)); // æŒ‰æ—¥æœŸå‡åºæ’åˆ—ï¼ˆè¼ƒèˆŠè‡³è¼ƒæ–°ï¼‰
            
            // é è¨­é¡¯ç¤ºæœ€æ–°çš„ç—…æ­·ï¼ˆæœ€è¿‘ä¸€æ¬¡è¨ºç—‡ï¼‰
            currentPatientHistoryPage = currentPatientConsultations.length - 1;
            
            // è¨­ç½®æ¨™é¡Œ
            document.getElementById('patientMedicalHistoryTitle').textContent = `${patient.name} çš„ç—…æ­·è¨˜éŒ„`;
            
            // é¡¯ç¤ºç—…äººåŸºæœ¬è³‡è¨Š
            document.getElementById('patientMedicalHistoryPatientInfo').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
                    <div>
                        <span class="font-medium text-gray-700">ç—…äººç·¨è™Ÿï¼š</span>
                        <span class="text-blue-600 font-semibold">${patient.patientNumber}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">å§“åï¼š</span>
                        <span class="font-semibold">${patient.name}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">å¹´é½¡ï¼š</span>
                        <span>${formatAge(patient.birthDate)}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">æ€§åˆ¥ï¼š</span>
                        <span>${patient.gender}</span>
                    </div>
                    ${patient.allergies ? `
                    <div class="md:col-span-4">
                        <span class="font-medium text-red-600">éæ•å²ï¼š</span>
                        <span class="text-red-700 bg-red-50 px-2 py-1 rounded">${patient.allergies}</span>
                    </div>
                    ` : ''}
                </div>
            `;
            
            // é¡¯ç¤ºåˆ†é ç—…æ­·è¨˜éŒ„
            displayPatientMedicalHistoryPage();
            
            document.getElementById('patientMedicalHistoryModal').classList.remove('hidden');
            } catch (error) {
        console.error('è®€å–ç—…äººè³‡æ–™éŒ¯èª¤:', error);
        showToast('è®€å–ç—…äººè³‡æ–™å¤±æ•—', 'error');
    }
        }
        
        function displayPatientMedicalHistoryPage() {
            const contentDiv = document.getElementById('patientMedicalHistoryContent');
            
            if (currentPatientConsultations.length === 0) {
                contentDiv.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-4xl mb-4">ğŸ“‹</div>
                        <div class="text-lg font-medium mb-2">æš«ç„¡è¨ºç—‡è¨˜éŒ„</div>
                        <div class="text-sm">è©²ç—…äººå°šæœªæœ‰è¨ºç—‡è¨˜éŒ„</div>
                    </div>
                `;
                return;
            }
            
            const consultation = currentPatientConsultations[currentPatientHistoryPage];
            const totalPages = currentPatientConsultations.length;
            const currentPageNumber = currentPatientHistoryPage + 1;
            const consultationNumber = currentPatientHistoryPage + 1;
            
            contentDiv.innerHTML = `
                <!-- åˆ†é å°èˆª -->
                <div class="mb-6 flex justify-between items-center bg-gray-50 rounded-lg p-4">
                    <div class="flex items-center space-x-4">
                        <h4 class="text-lg font-semibold text-gray-800">è¨ºç—‡è¨˜éŒ„</h4>
                        <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                            ç¬¬ ${consultationNumber} æ¬¡è¨ºç—‡
                        </span>
                        <span class="text-sm text-gray-600">
                            å…± ${totalPages} æ¬¡è¨ºç—‡è¨˜éŒ„
                        </span>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <button onclick="changePatientHistoryPage(-1)" 
                                ${currentPatientHistoryPage === 0 ? 'disabled' : ''}
                                class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-sm">
                            â† è¼ƒèˆŠ
                        </button>
                        <span class="text-sm text-gray-600 px-2">
                            ${currentPageNumber} / ${totalPages}
                        </span>
                        <button onclick="changePatientHistoryPage(1)" 
                                ${currentPatientHistoryPage === totalPages - 1 ? 'disabled' : ''}
                                class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-sm">
                            è¼ƒæ–° â†’
                        </button>
                    </div>
                </div>
                
                <!-- ç•¶å‰ç—…æ­·è¨˜éŒ„ -->
                <div class="border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                    <div class="bg-gradient-to-r from-gray-50 to-blue-50 px-6 py-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center space-x-4">
                                <span class="font-semibold text-gray-900 text-lg">
                                    ${new Date(consultation.date).toLocaleDateString('zh-TW')} 
                                    ${new Date(consultation.date).toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'})}
                                </span>
                                <span class="text-sm text-gray-600 bg-white px-3 py-1 rounded">
                                    é†«å¸«ï¼š${getDoctorDisplayName(consultation.doctor)}
                                </span>
                                ${consultation.updatedAt ? `
                                    <span class="text-xs text-orange-600 bg-orange-50 px-2 py-1 rounded">
                                        å·²ä¿®æ”¹
                                    </span>
                                ` : ''}
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="printConsultationRecord(${consultation.id})" 
                                        class="text-green-600 hover:text-green-800 text-sm font-medium bg-green-50 px-3 py-2 rounded">
                                    ğŸ“„ åˆ—å°æ”¶æ“š
                                </button>
                                <button onclick="printAttendanceCertificate(${consultation.id})" 
                                        class="text-blue-600 hover:text-blue-800 text-sm font-medium bg-blue-50 px-3 py-2 rounded">
                                    ğŸ“‹ åˆ°è¨ºè­‰æ˜
                                </button>
                                ${(() => {
                                    // æª¢æŸ¥æ˜¯å¦æ­£åœ¨è¨ºç—‡ä¸”ç‚ºç›¸åŒç—…äºº
                                    if (currentConsultingAppointmentId) {
                                        const currentAppointment = appointments.find(apt => apt.id === currentConsultingAppointmentId);
                                        if (currentAppointment && currentAppointment.patientId === consultation.patientId) {
                                            return `
                                                <button onclick="loadMedicalRecordToCurrentConsultation(${consultation.id})" 
                                                        class="text-blue-600 hover:text-blue-800 text-sm font-medium bg-blue-50 px-3 py-2 rounded">
                                                    ğŸ“‹ è¼‰å…¥ç—…æ­·
                                                </button>
                                            `;
                                        }
                                    }
                                    return '';
                                })()}
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="space-y-4">
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ä¸»è¨´</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.symptoms || 'ç„¡è¨˜éŒ„'}</div>
                                </div>
                                
                                ${consultation.tongue ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">èˆŒè±¡</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.tongue}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.pulse ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">è„ˆè±¡</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.pulse}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.currentHistory ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ç¾ç—…å²</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.currentHistory}</div>
                                </div>
                                ` : ''}
                                
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ä¸­é†«è¨ºæ–·</span>
                                    <div class="bg-green-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-green-400">${consultation.diagnosis || 'ç„¡è¨˜éŒ„'}</div>
                                </div>
                                
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">è­‰å‹è¨ºæ–·</span>
                                    <div class="bg-blue-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-blue-400">${consultation.syndrome || 'ç„¡è¨˜éŒ„'}</div>
                                </div>
                                
                                ${consultation.acupunctureNotes ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">é‡ç¸å‚™è¨»</span>
                                    <div class="bg-orange-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-orange-400">${consultation.acupunctureNotes}</div>
                                </div>
                                ` : ''}
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">è™•æ–¹å…§å®¹</span>
                                    <div class="bg-yellow-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-yellow-400 whitespace-pre-line">${consultation.prescription || 'ç„¡è¨˜éŒ„'}</div>
                                </div>
                                
                                ${consultation.usage ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">æœç”¨æ–¹æ³•</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.usage}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.treatmentCourse ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ç™‚ç¨‹</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.treatmentCourse}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.instructions ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">é†«å›‘åŠæ³¨æ„äº‹é …</span>
                                    <div class="bg-red-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-red-400">${consultation.instructions}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.followUpDate ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">è¤‡è¨ºæ™‚é–“</span>
                                    <div class="bg-purple-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-purple-400">${new Date(consultation.followUpDate).toLocaleString('zh-TW')}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.billingItems ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">æ”¶è²»é …ç›®</span>
                                    <div class="bg-green-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-green-400 whitespace-pre-line">${consultation.billingItems}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function changePatientHistoryPage(direction) {
            const newPage = currentPatientHistoryPage + direction;
            if (newPage >= 0 && newPage < currentPatientConsultations.length) {
                currentPatientHistoryPage = newPage;
                displayPatientMedicalHistoryPage();
            }
        }

        // é—œé–‰ç—…äººç—…æ­·æŸ¥çœ‹å½ˆçª—
        function closePatientMedicalHistoryModal() {
            document.getElementById('patientMedicalHistoryModal').classList.add('hidden');
        }



        // è¨ºç—‡ç³»çµ±ä¸­çš„ç—…æ­·æŸ¥çœ‹åŠŸèƒ½
        let currentConsultationConsultations = [];
        let currentConsultationHistoryPage = 0;
        
// 5. ä¿®æ”¹æŸ¥çœ‹ç—…äººè¨ºç—‡è¨˜éŒ„åŠŸèƒ½
async function viewPatientMedicalHistory(patientId) {
    try {
        // å¾ Firebase ç²å–ç—…äººè³‡æ–™
        const patientResult = await window.firebaseDataManager.getPatients();
        if (!patientResult.success) {
            showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™', 'error');
            return;
        }
        
        const patient = patientResult.data.find(p => p.id === patientId);
        if (!patient) {
            showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™', 'error');
            return;
        }
        
        // ç²å–è©²ç—…äººçš„æ‰€æœ‰è¨ºç—‡è¨˜éŒ„
        const consultationResult = await window.firebaseDataManager.getPatientConsultations(patientId);
        if (!consultationResult.success) {
            showToast('ç„¡æ³•è®€å–è¨ºç—‡è¨˜éŒ„', 'error');
            return;
        }
        
        currentConsultationConsultations = consultationResult.data;
        
        // é è¨­é¡¯ç¤ºæœ€æ–°çš„ç—…æ­·ï¼ˆæœ€è¿‘ä¸€æ¬¡è¨ºç—‡ï¼‰
        currentConsultationHistoryPage = 0; // Firebase å·²ç¶“æŒ‰æ™‚é–“æ’åºï¼Œæœ€æ–°åœ¨å‰
        
        // è¨­ç½®æ¨™é¡Œ
        document.getElementById('medicalHistoryTitle').textContent = `${patient.name} çš„è¨ºç—‡è¨˜éŒ„`;
        
        // é¡¯ç¤ºç—…äººåŸºæœ¬è³‡è¨Š
        document.getElementById('medicalHistoryPatientInfo').innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
                <div>
                    <span class="font-medium text-gray-700">ç—…äººç·¨è™Ÿï¼š</span>
                    <span class="text-blue-600 font-semibold">${patient.patientNumber}</span>
                </div>
                <div>
                    <span class="font-medium text-gray-700">å§“åï¼š</span>
                    <span class="font-semibold">${patient.name}</span>
                </div>
                <div>
                    <span class="font-medium text-gray-700">å¹´é½¡ï¼š</span>
                    <span>${formatAge(patient.birthDate)}</span>
                </div>
                <div>
                    <span class="font-medium text-gray-700">æ€§åˆ¥ï¼š</span>
                    <span>${patient.gender}</span>
                </div>
                ${patient.allergies ? `
                <div class="md:col-span-4">
                    <span class="font-medium text-red-600">éæ•å²ï¼š</span>
                    <span class="text-red-700 bg-red-50 px-2 py-1 rounded">${patient.allergies}</span>
                </div>
                ` : ''}
            </div>
        `;
        
        // é¡¯ç¤ºåˆ†é ç—…æ­·è¨˜éŒ„
        displayConsultationMedicalHistoryPage();
        
        document.getElementById('medicalHistoryModal').classList.remove('hidden');
        
    } catch (error) {
        console.error('æŸ¥çœ‹ç—…äººè¨ºç—‡è¨˜éŒ„éŒ¯èª¤:', error);
        showToast('è®€å–ç—…äººè³‡æ–™å¤±æ•—', 'error');
    }
}
        
// ä¿®å¾©ç—…æ­·è¨˜éŒ„é¡¯ç¤ºä¸­çš„æ—¥æœŸå•é¡Œ
function displayConsultationMedicalHistoryPage() {
    const contentDiv = document.getElementById('medicalHistoryContent');
    
    if (currentConsultationConsultations.length === 0) {
        contentDiv.innerHTML = `
            <div class="text-center py-12 text-gray-500">
                <div class="text-4xl mb-4">ğŸ“‹</div>
                <div class="text-lg font-medium mb-2">æš«ç„¡è¨ºç—‡è¨˜éŒ„</div>
                <div class="text-sm">è©²ç—…äººå°šæœªæœ‰è¨ºç—‡è¨˜éŒ„</div>
            </div>
        `;
        return;
    }
    
    const consultation = currentConsultationConsultations[currentConsultationHistoryPage];
    const totalPages = currentConsultationConsultations.length;
    const currentPageNumber = currentConsultationHistoryPage + 1;
    const consultationNumber = currentConsultationHistoryPage + 1;
    
    contentDiv.innerHTML = `
        <!-- åˆ†é å°èˆª -->
        <div class="mb-6 flex justify-between items-center bg-gray-50 rounded-lg p-4">
            <div class="flex items-center space-x-4">
                <h4 class="text-lg font-semibold text-gray-800">è¨ºç—‡è¨˜éŒ„</h4>
                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                    ç¬¬ ${consultationNumber} æ¬¡è¨ºç—‡
                </span>
                <span class="text-sm text-gray-600">
                    å…± ${totalPages} æ¬¡è¨ºç—‡è¨˜éŒ„
                </span>
            </div>
            
            <div class="flex items-center space-x-2">
                <button onclick="changeConsultationHistoryPage(-1)" 
                        ${currentConsultationHistoryPage === 0 ? 'disabled' : ''}
                        class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-sm">
                    â† è¼ƒèˆŠ
                </button>
                <span class="text-sm text-gray-600 px-2">
                    ${currentPageNumber} / ${totalPages}
                </span>
                <button onclick="changeConsultationHistoryPage(1)" 
                        ${currentConsultationHistoryPage === totalPages - 1 ? 'disabled' : ''}
                        class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-sm">
                    è¼ƒæ–° â†’
                </button>
            </div>
        </div>
        
        <!-- ç•¶å‰ç—…æ­·è¨˜éŒ„ -->
        <div class="border border-gray-200 rounded-lg overflow-hidden shadow-sm">
            <div class="bg-gradient-to-r from-gray-50 to-blue-50 px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <span class="font-semibold text-gray-900 text-lg">
                            ${formatConsultationDateTime(consultation.date)}
                        </span>
                        <span class="text-sm text-gray-600 bg-white px-3 py-1 rounded">
                            é†«å¸«ï¼š${getDoctorDisplayName(consultation.doctor)}
                        </span>
                        ${consultation.updatedAt ? `
                            <span class="text-xs text-orange-600 bg-orange-50 px-2 py-1 rounded">
                                å·²ä¿®æ”¹
                            </span>
                        ` : ''}
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="printConsultationRecord(${consultation.id})" 
                                class="text-green-600 hover:text-green-800 text-sm font-medium bg-green-50 px-3 py-2 rounded">
                            ğŸ“„ åˆ—å°æ”¶æ“š
                        </button>
                        <button onclick="printAttendanceCertificate(${consultation.id})" 
                                class="text-blue-600 hover:text-blue-800 text-sm font-medium bg-blue-50 px-3 py-2 rounded">
                            ğŸ“‹ åˆ°è¨ºè­‰æ˜
                        </button>
                        ${(() => {
                            // æª¢æŸ¥æ˜¯å¦æ­£åœ¨è¨ºç—‡ä¸”ç‚ºç›¸åŒç—…äºº
                            if (currentConsultingAppointmentId) {
                                const currentAppointment = appointments.find(apt => apt.id === currentConsultingAppointmentId);
                                if (currentAppointment && currentAppointment.patientId === consultation.patientId) {
                                    return `
                                        <button onclick="loadMedicalRecordToCurrentConsultation(${consultation.id})" 
                                                class="text-blue-600 hover:text-blue-800 text-sm font-medium bg-blue-50 px-3 py-2 rounded">
                                            ğŸ“‹ è¼‰å…¥ç—…æ­·
                                        </button>
                                    `;
                                }
                            }
                            return '';
                        })()}
                    </div>
                </div>
            </div>
            
            <div class="p-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="space-y-4">
                        <div>
                            <span class="text-sm font-semibold text-gray-700 block mb-2">ä¸»è¨´</span>
                            <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.symptoms || 'ç„¡è¨˜éŒ„'}</div>
                        </div>
                        
                        ${consultation.tongue ? `
                        <div>
                            <span class="text-sm font-semibold text-gray-700 block mb-2">èˆŒè±¡</span>
                            <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.tongue}</div>
                        </div>
                        ` : ''}
                        
                        ${consultation.pulse ? `
                        <div>
                            <span class="text-sm font-semibold text-gray-700 block mb-2">è„ˆè±¡</span>
                            <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.pulse}</div>
                        </div>
                        ` : ''}
                        
                        ${consultation.currentHistory ? `
                        <div>
                            <span class="text-sm font-semibold text-gray-700 block mb-2">ç¾ç—…å²</span>
                            <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.currentHistory}</div>
                        </div>
                        ` : ''}
                        
                        <div>
                            <span class="text-sm font-semibold text-gray-700 block mb-2">ä¸­é†«è¨ºæ–·</span>
                            <div class="bg-green-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-green-400">${consultation.diagnosis || 'ç„¡è¨˜éŒ„'}</div>
                        </div>
                        
                        <div>
                            <span class="text-sm font-semibold text-gray-700 block mb-2">è­‰å‹è¨ºæ–·</span>
                            <div class="bg-blue-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-blue-400">${consultation.syndrome || 'ç„¡è¨˜éŒ„'}</div>
                        </div>
                        
                        ${consultation.acupunctureNotes ? `
                        <div>
                            <span class="text-sm font-semibold text-gray-700 block mb-2">é‡ç¸å‚™è¨»</span>
                            <div class="bg-orange-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-orange-400">${consultation.acupunctureNotes}</div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <span class="text-sm font-semibold text-gray-700 block mb-2">è™•æ–¹å…§å®¹</span>
                            <div class="bg-yellow-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-yellow-400 whitespace-pre-line">${consultation.prescription || 'ç„¡è¨˜éŒ„'}</div>
                        </div>
                        
                        ${consultation.usage ? `
                        <div>
                            <span class="text-sm font-semibold text-gray-700 block mb-2">æœç”¨æ–¹æ³•</span>
                            <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.usage}</div>
                        </div>
                        ` : ''}
                        
                        ${consultation.treatmentCourse ? `
                        <div>
                            <span class="text-sm font-semibold text-gray-700 block mb-2">ç™‚ç¨‹</span>
                            <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.treatmentCourse}</div>
                        </div>
                        ` : ''}
                        
                        ${consultation.instructions ? `
                        <div>
                            <span class="text-sm font-semibold text-gray-700 block mb-2">é†«å›‘åŠæ³¨æ„äº‹é …</span>
                            <div class="bg-red-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-red-400">${consultation.instructions}</div>
                        </div>
                        ` : ''}
                        
                        ${consultation.followUpDate ? `
                        <div>
                            <span class="text-sm font-semibold text-gray-700 block mb-2">è¤‡è¨ºæ™‚é–“</span>
                            <div class="bg-purple-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-purple-400">${formatConsultationDateTime(consultation.followUpDate)}</div>
                        </div>
                        ` : ''}
                        
                        ${consultation.billingItems ? `
                        <div>
                            <span class="text-sm font-semibold text-gray-700 block mb-2">æ”¶è²»é …ç›®</span>
                            <div class="bg-green-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-green-400 whitespace-pre-line">${consultation.billingItems}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>
    `;
}
        
        function changeConsultationHistoryPage(direction) {
            const newPage = currentConsultationHistoryPage + direction;
            if (newPage >= 0 && newPage < currentConsultationConsultations.length) {
                currentConsultationHistoryPage = newPage;
                displayConsultationMedicalHistoryPage();
            }
        }
        
        // é—œé–‰è¨ºç—‡è¨˜éŒ„å½ˆçª—
        function closeMedicalHistoryModal() {
            document.getElementById('medicalHistoryModal').classList.add('hidden');
        }
        

        
// 1. ä¿®æ”¹å¾æ›è™Ÿè¨˜éŒ„åˆ—å°æ”¶æ“šå‡½æ•¸
async function printReceiptFromAppointment(appointmentId) {
    const appointment = appointments.find(apt => apt.id === appointmentId);
    if (!appointment) {
        showToast('æ‰¾ä¸åˆ°æ›è™Ÿè¨˜éŒ„ï¼', 'error');
        return;
    }
    
    if (appointment.status !== 'completed' || !appointment.consultationId) {
        showToast('åªèƒ½åˆ—å°å·²å®Œæˆè¨ºç—‡çš„æ”¶æ“šï¼', 'error');
        return;
    }
    
    try {
        // å¾ Firebase ç²å–è¨ºç—‡è¨˜éŒ„
        const consultationResult = await window.firebaseDataManager.getConsultations();
        if (!consultationResult.success) {
            showToast('ç„¡æ³•è®€å–è¨ºç—‡è¨˜éŒ„ï¼', 'error');
            return;
        }
        
        const consultation = consultationResult.data.find(c => c.id === appointment.consultationId);
        if (!consultation) {
            showToast('æ‰¾ä¸åˆ°å°æ‡‰çš„è¨ºç—‡è¨˜éŒ„ï¼', 'error');
            return;
        }
        
        // ç›´æ¥èª¿ç”¨ç¾æœ‰çš„åˆ—å°åŠŸèƒ½
        await printConsultationRecord(consultation.id, consultation);
        
    } catch (error) {
        console.error('åˆ—å°æ”¶æ“šéŒ¯èª¤:', error);
        showToast('åˆ—å°æ”¶æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
    }
}

        
// 2. ä¿®æ”¹å¾æ›è™Ÿè¨˜éŒ„åˆ—å°åˆ°è¨ºè­‰æ˜å‡½æ•¸
async function printAttendanceCertificateFromAppointment(appointmentId) {
    const appointment = appointments.find(apt => apt.id === appointmentId);
    if (!appointment) {
        showToast('æ‰¾ä¸åˆ°æ›è™Ÿè¨˜éŒ„ï¼', 'error');
        return;
    }
    
    if (appointment.status !== 'completed' || !appointment.consultationId) {
        showToast('åªèƒ½åˆ—å°å·²å®Œæˆè¨ºç—‡çš„åˆ°è¨ºè­‰æ˜ï¼', 'error');
        return;
    }
    
    try {
        // å¾ Firebase ç²å–è¨ºç—‡è¨˜éŒ„
        const consultationResult = await window.firebaseDataManager.getConsultations();
        if (!consultationResult.success) {
            showToast('ç„¡æ³•è®€å–è¨ºç—‡è¨˜éŒ„ï¼', 'error');
            return;
        }
        
        const consultation = consultationResult.data.find(c => c.id === appointment.consultationId);
        if (!consultation) {
            showToast('æ‰¾ä¸åˆ°å°æ‡‰çš„è¨ºç—‡è¨˜éŒ„ï¼', 'error');
            return;
        }
        
        // ç›´æ¥èª¿ç”¨åˆ°è¨ºè­‰æ˜åˆ—å°åŠŸèƒ½
        await printAttendanceCertificate(consultation.id, consultation);
        
    } catch (error) {
        console.error('åˆ—å°åˆ°è¨ºè­‰æ˜éŒ¯èª¤:', error);
        showToast('åˆ—å°åˆ°è¨ºè­‰æ˜æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
    }
}
        
// 3. ä¿®æ”¹å¾æ›è™Ÿè¨˜éŒ„åˆ—å°ç—…å‡è­‰æ˜å‡½æ•¸
async function printSickLeaveFromAppointment(appointmentId) {
    const appointment = appointments.find(apt => apt.id === appointmentId);
    if (!appointment) {
        showToast('æ‰¾ä¸åˆ°æ›è™Ÿè¨˜éŒ„ï¼', 'error');
        return;
    }
    
    if (appointment.status !== 'completed' || !appointment.consultationId) {
        showToast('åªèƒ½åˆ—å°å·²å®Œæˆè¨ºç—‡çš„ç—…å‡è­‰æ˜ï¼', 'error');
        return;
    }
    
    try {
        // å¾ Firebase ç²å–è¨ºç—‡è¨˜éŒ„
        const consultationResult = await window.firebaseDataManager.getConsultations();
        if (!consultationResult.success) {
            showToast('ç„¡æ³•è®€å–è¨ºç—‡è¨˜éŒ„ï¼', 'error');
            return;
        }
        
        const consultation = consultationResult.data.find(c => c.id === appointment.consultationId);
        if (!consultation) {
            showToast('æ‰¾ä¸åˆ°å°æ‡‰çš„è¨ºç—‡è¨˜éŒ„ï¼', 'error');
            return;
        }
        
        // ç›´æ¥èª¿ç”¨ç—…å‡è­‰æ˜åˆ—å°åŠŸèƒ½
        await printSickLeave(consultation.id, consultation);
        
    } catch (error) {
        console.error('åˆ—å°ç—…å‡è­‰æ˜éŒ¯èª¤:', error);
        showToast('åˆ—å°ç—…å‡è­‰æ˜æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
    }
}
        
// 4. ä¿®æ”¹åˆ—å°è¨ºç—‡è¨˜éŒ„å‡½æ•¸
async function printConsultationRecord(consultationId, consultationData = null) {
    let consultation = consultationData;
    
    // å¦‚æœæ²’æœ‰æä¾›è¨ºç—‡è³‡æ–™ï¼Œå¾ Firebase ç²å–
    if (!consultation) {
        try {
            const consultationResult = await window.firebaseDataManager.getConsultations();
            if (!consultationResult.success) {
                showToast('ç„¡æ³•è®€å–è¨ºç—‡è¨˜éŒ„ï¼', 'error');
                return;
            }
            
            consultation = consultationResult.data.find(c => c.id === consultationId);
            if (!consultation) {
                showToast('æ‰¾ä¸åˆ°è¨ºç—‡è¨˜éŒ„ï¼', 'error');
                return;
            }
        } catch (error) {
            console.error('è®€å–è¨ºç—‡è¨˜éŒ„éŒ¯èª¤:', error);
            showToast('è®€å–è¨ºç—‡è¨˜éŒ„å¤±æ•—', 'error');
            return;
        }
    }
    
    try {
        // å¾ Firebase ç²å–ç—…äººè³‡æ–™
        const patientResult = await window.firebaseDataManager.getPatients();
        if (!patientResult.success) {
            showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        
        const patient = patientResult.data.find(p => p.id === consultation.patientId);
        if (!patient) {
            showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        
        // è§£ææ”¶è²»é …ç›®ä»¥è¨ˆç®—ç¸½é‡‘é¡
        let totalAmount = 0;
        let billingItemsHtml = '';
        if (consultation.billingItems) {
            const lines = consultation.billingItems.split('\n');
            lines.forEach(line => {
                if (line.includes('=') && line.includes('$')) {
                    const match = line.match(/\$(\d+)/);
                    if (match) {
                        totalAmount += parseInt(match[1]);
                    }
                    billingItemsHtml += `<tr><td style="padding: 5px; border-bottom: 1px dotted #ccc;">${line}</td></tr>`;
                } else if (line.includes('ç¸½è²»ç”¨')) {
                    const match = line.match(/\$(\d+)/);
                    if (match) {
                        totalAmount = parseInt(match[1]);
                    }
                }
            });
        }
        
        // ç²å–è¨ºç—‡æ—¥æœŸï¼ˆè™•ç† Firebase Timestampï¼‰
        let consultationDate;
        if (consultation.date && consultation.date.seconds) {
            consultationDate = new Date(consultation.date.seconds * 1000);
        } else if (consultation.date) {
            consultationDate = new Date(consultation.date);
        } else {
            consultationDate = new Date();
        }
        
        // å‰µå»ºä¸­é†«è¨ºæ‰€æ”¶æ“šæ ¼å¼
        const printContent = `
            <!DOCTYPE html>
            <html lang="zh-TW">
            <head>
                <meta charset="UTF-8">
                <title>æ”¶æ“š - ${patient.name}</title>
                <style>
                    body { 
                        font-family: 'Microsoft JhengHei', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; 
                        margin: 0; 
                        padding: 10px; 
                        line-height: 1.3;
                        font-size: 11px;
                    }
                    .receipt-container {
                        width: 148mm;
                        height: 210mm;
                        margin: 0 auto;
                        border: 2px solid #000;
                        padding: 8px;
                        background: white;
                        box-sizing: border-box;
                    }
                    .clinic-header {
                        text-align: center;
                        border-bottom: 2px double #000;
                        padding-bottom: 10px;
                        margin-bottom: 15px;
                    }
                    .clinic-name {
                        font-size: 14px;
                        font-weight: bold;
                        margin-bottom: 2px;
                        letter-spacing: 1px;
                    }
                    .clinic-subtitle {
                        font-size: 10px;
                        color: #666;
                        margin-bottom: 3px;
                    }
                    .receipt-title {
                        font-size: 14px;
                        font-weight: bold;
                        text-align: center;
                        margin: 6px 0;
                        letter-spacing: 2px;
                    }
                    .receipt-info {
                        margin-bottom: 10px;
                    }
                    .info-row {
                        display: flex;
                        justify-content: space-between;
                        margin-bottom: 3px;
                        font-size: 11px;
                    }
                    .info-label {
                        font-weight: bold;
                    }
                    .items-section {
                        border-top: 1px solid #000;
                        border-bottom: 1px solid #000;
                        padding: 6px 0;
                        margin: 8px 0;
                    }
                    .items-title {
                        font-weight: bold;
                        text-align: center;
                        margin-bottom: 6px;
                        font-size: 12px;
                    }
                    .items-table {
                        width: 100%;
                        font-size: 10px;
                    }
                    .items-table td {
                        padding: 3px 5px;
                        border-bottom: 1px dotted #999;
                    }
                    .total-section {
                        text-align: right;
                        margin: 8px 0;
                        font-size: 12px;
                        font-weight: bold;
                    }
                    .total-amount {
                        font-size: 12px;
                        color: #000;
                        border: 2px solid #000;
                        padding: 4px;
                        display: inline-block;
                        min-width: 60px;
                        text-align: center;
                    }
                    .prescription-section {
                        margin: 8px 0;
                        border-top: 1px dashed #666;
                        padding-top: 6px;
                    }
                    .prescription-title {
                        font-weight: bold;
                        margin-bottom: 4px;
                        font-size: 11px;
                    }
                    .prescription-content {
                        background: #f9f9f9;
                        padding: 4px;
                        border: 1px solid #ddd;
                        font-size: 10px;
                        line-height: 1.2;
                    }
                    .footer-info {
                        margin-top: 10px;
                        border-top: 1px dashed #666;
                        padding-top: 6px;
                        font-size: 9px;
                        color: #666;
                    }
                    .footer-row {
                        display: flex;
                        justify-content: space-between;
                        margin-bottom: 2px;
                    }
                    .thank-you {
                        text-align: center;
                        margin: 8px 0;
                        font-weight: bold;
                        font-size: 11px;
                    }
                    .diagnosis-section {
                        margin: 6px 0;
                        font-size: 10px;
                    }
                    .diagnosis-title {
                        font-weight: bold;
                        margin-bottom: 3px;
                    }
                    @media print {
                        @page {
                            size: A5;
                            margin: 10mm;
                        }
                        body { 
                            margin: 0; 
                            padding: 0; 
                            font-size: 11px;
                        }
                        .receipt-container { 
                            border: 2px solid #000;
                            width: 100%;
                            height: 100%;
                            padding: 8mm;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="receipt-container">
                    <!-- è¨ºæ‰€æ¨™é¡Œ -->
                    <div class="clinic-header">
                        <div class="clinic-name">${clinicSettings.chineseName || 'ä¸­é†«è¨ºæ‰€ç³»çµ±'}</div>
                        <div class="clinic-subtitle">${clinicSettings.englishName || 'TCM Clinic'}</div>
                        <div class="clinic-subtitle">é›»è©±ï¼š${clinicSettings.phone || '(852) 2345-6789'}ã€€åœ°å€ï¼š${clinicSettings.address || 'é¦™æ¸¯ä¸­ç’°çš‡åå¤§é“ä¸­123è™Ÿ'}</div>
                    </div>
                    
                    <!-- æ”¶æ“šæ¨™é¡Œ -->
                    <div class="receipt-title">æ”¶ã€€æ“š</div>
                    
                    <!-- åŸºæœ¬è³‡è¨Š -->
                    <div class="receipt-info">
                        <div class="info-row">
                            <span class="info-label">æ”¶æ“šç·¨è™Ÿï¼š</span>
                            <span>R${consultation.id.toString().padStart(6, '0')}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ç—…äººå§“åï¼š</span>
                            <span>${patient.name}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ç—…æ­·è™Ÿç¢¼ï¼š</span>
                            <span>${patient.patientNumber}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">è¨ºç™‚æ—¥æœŸï¼š</span>
                            <span>${consultationDate.toLocaleDateString('zh-TW', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit'
                            })}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">è¨ºç™‚æ™‚é–“ï¼š</span>
                            <span>${consultationDate.toLocaleTimeString('zh-TW', {
                                hour: '2-digit',
                                minute: '2-digit'
                            })}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ä¸»æ²»é†«å¸«ï¼š</span>
                            <span>${getDoctorDisplayName(consultation.doctor)}</span>
                        </div>
                        ${(() => {
                            const regNumber = getDoctorRegistrationNumber(consultation.doctor);
                            return regNumber ? `
                                <div class="info-row">
                                    <span class="info-label">è¨»å†Šç·¨è™Ÿï¼š</span>
                                    <span>${regNumber}</span>
                                </div>
                            ` : '';
                        })()}
                    </div>
                    
                    <!-- è¨ºæ–·è³‡è¨Š -->
                    ${consultation.diagnosis ? `
                    <div class="diagnosis-section">
                        <div class="diagnosis-title">è¨ºæ–·ï¼š</div>
                        <div>${consultation.diagnosis}</div>
                        ${consultation.syndrome ? `<div>è­‰å‹ï¼š${consultation.syndrome}</div>` : ''}
                    </div>
                    ` : ''}
                    
                    <!-- æ”¶è²»é …ç›® -->
                    ${consultation.billingItems ? `
                    <div class="items-section">
                        <div class="items-title">æ”¶è²»æ˜ç´°</div>
                        <table class="items-table">
                            ${billingItemsHtml}
                        </table>
                    </div>
                    ` : ''}
                    
                    <!-- ç¸½é‡‘é¡ -->
                    <div class="total-section">
                        <div style="margin-bottom: 8px; font-size: 10px;">æ‡‰æ”¶é‡‘é¡ï¼š</div>
                        <div class="total-amount">HK$ ${totalAmount.toLocaleString()}</div>
                    </div>
                    
                    <!-- è™•æ–¹è³‡è¨Š -->
                    ${consultation.prescription ? `
                    <div class="prescription-section">
                        <div class="prescription-title">ğŸ“‹ è™•æ–¹å…§å®¹</div>
                        <div class="prescription-content">${(() => {
                            // å°‡è™•æ–¹å…§å®¹æŒ‰è¡Œåˆ†å‰²ï¼Œç„¶å¾Œæ©«å‘æ’åˆ—
                            const lines = consultation.prescription.split('\n').filter(line => line.trim());
                            const allItems = [];
                            let i = 0;
                            
                            while (i < lines.length) {
                                const line = lines[i].trim();
                                if (!line) {
                                    i++;
                                    continue;
                                }
                                
                                // æª¢æŸ¥æ˜¯å¦ç‚ºè—¥æ/æ–¹åŠ‘æ ¼å¼ï¼ˆåç¨± åŠ‘é‡gï¼‰
                                const itemMatch = line.match(/^(.+?)\s+(\d+(?:\.\d+)?)g$/);
                                if (itemMatch) {
                                    const itemName = itemMatch[1].trim();
                                    const dosage = itemMatch[2];
                                    
                                    // æª¢æŸ¥æ˜¯å¦ç‚ºå¸¸è¦‹æ–¹åŠ‘åç¨±
                                    const isFormula = ['æ¹¯', 'æ•£', 'ä¸¸', 'è†', 'é£²', 'ä¸¹', 'ç…', 'æ–¹', 'åŠ‘'].some(suffix => itemName.includes(suffix));
                                    
                                    if (isFormula) {
                                        // æª¢æŸ¥ä¸‹ä¸€è¡Œæ˜¯å¦ç‚ºæ–¹åŠ‘çµ„æˆ
                                        let composition = '';
                                        if (i + 1 < lines.length) {
                                            const nextLine = lines[i + 1].trim();
                                            // å¦‚æœä¸‹ä¸€è¡Œä¸æ˜¯æ¨™æº–è—¥ææ ¼å¼ï¼Œè¦–ç‚ºæ–¹åŠ‘çµ„æˆ
                                            if (nextLine && !nextLine.match(/^.+?\s+\d+(?:\.\d+)?g$/)) {
                                                composition = nextLine.replace(/\n/g, 'ã€').replace(/ã€/g, ',');
                                                i++; // è·³éçµ„æˆè¡Œ
                                            }
                                        }
                                        
                                        // æ–¹åŠ‘é¡¯ç¤ºæ ¼å¼ï¼šæ–¹åŠ‘å åŠ‘é‡g (çµ„æˆ)
                                        if (composition) {
                                            allItems.push(`${itemName} ${dosage}g <span style="font-size: 8px;">(${composition})</span>`);
                                        } else {
                                            allItems.push(`${itemName} ${dosage}g`);
                                        }
                                    } else {
                                        // æ™®é€šè—¥æ
                                        allItems.push(`${itemName} ${dosage}g`);
                                    }
                                } else {
                                    // éæ¨™æº–æ ¼å¼çš„è¡Œï¼Œå¯èƒ½æ˜¯ç¨ç«‹çš„èªªæ˜
                                    allItems.push(`<div style="margin: 2px 0; font-size: 9px; color: #666;">${line}</div>`);
                                }
                                
                                i++;
                            }
                            
                            // åˆ†é›¢æ™®é€šé …ç›®å’Œç‰¹æ®Šè¡Œ
                            const regularItems = allItems.filter(item => typeof item === 'string' && !item.includes('<div'));
                            const specialLines = allItems.filter(item => typeof item === 'string' && item.includes('<div'));
                            
                            let result = '';
                            
                            // å…ˆé¡¯ç¤ºç‰¹æ®Šè¡Œ
                            specialLines.forEach(line => {
                                result += line;
                            });
                            
                            // ç„¶å¾Œé¡¯ç¤ºæ‰€æœ‰é …ç›®ï¼ˆåŒ…æ‹¬æ–¹åŠ‘å’Œè—¥æï¼‰ï¼Œæ¯è¡Œ4å€‹æ©«å‘æ’åˆ—
                            if (regularItems.length > 0) {
                                for (let j = 0; j < regularItems.length; j += 4) {
                                    const lineItems = regularItems.slice(j, j + 4);
                                    result += `<div style="margin: 2px 0;">${lineItems.join('ã€€')}</div>`;
                                }
                            }
                            
                            return result || consultation.prescription.replace(/\n/g, '<br>');
                        })()}</div>
                        ${consultation.usage ? `
                        <div style="margin-top: 8px; font-size: 12px;">
                            <strong>æœç”¨æ–¹æ³•ï¼š</strong>${consultation.usage}
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}
                    
                    <!-- é†«å›‘ -->
                    ${consultation.instructions ? `
                    <div style="margin: 10px 0; font-size: 12px; background: #fff3cd; padding: 8px; border: 1px solid #ffeaa7;">
                        <strong>âš ï¸ é†«å›‘åŠæ³¨æ„äº‹é …ï¼š</strong><br>
                        ${consultation.instructions}
                    </div>
                    ` : ''}
                    
                    <!-- è¤‡è¨ºæé†’ -->
                    ${consultation.followUpDate ? `
                    <div style="margin: 10px 0; font-size: 12px; background: #e3f2fd; padding: 8px; border: 1px solid #90caf9;">
                        <strong>ğŸ“… å»ºè­°è¤‡è¨ºæ™‚é–“ï¼š</strong><br>
                        ${new Date(consultation.followUpDate).toLocaleString('zh-TW')}
                    </div>
                    ` : ''}
                    
                    <!-- æ„Ÿè¬èª -->
                    <div class="thank-you">
                        è¬è¬æ‚¨çš„å…‰è‡¨ï¼Œç¥æ‚¨èº«é«”å¥åº·ï¼
                    </div>
                    
                    <!-- é å°¾è³‡è¨Š -->
                    <div class="footer-info">
                        <div class="footer-row">
                            <span>æ”¶æ“šé–‹ç«‹æ™‚é–“ï¼š</span>
                            <span>${new Date().toLocaleString('zh-TW')}</span>
                        </div>
                        <div class="footer-row">
                            <span>è¨ºæ‰€ç‡Ÿæ¥­æ™‚é–“ï¼š</span>
                            <span>${clinicSettings.businessHours || 'é€±ä¸€è‡³é€±äº” 09:00-18:00'}</span>
                        </div>
                        <div class="footer-row">
                            <span>æœ¬æ”¶æ“šè«‹å¦¥å–„ä¿å­˜</span>
                            <span>å¦‚æœ‰ç–‘å•è«‹æ´½æ«ƒæª¯</span>
                        </div>
                    </div>
                </div>
            </body>
            </html>
        `;
        
        // é–‹å•Ÿæ–°è¦–çª—é€²è¡Œåˆ—å°
        const printWindow = window.open('', '_blank', 'width=500,height=700');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        
        showToast('ä¸­é†«è¨ºæ‰€æ”¶æ“šå·²æº–å‚™åˆ—å°ï¼', 'success');
        
    } catch (error) {
        console.error('åˆ—å°æ”¶æ“šéŒ¯èª¤:', error);
        showToast('åˆ—å°æ”¶æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
    }
}
        
// 5. ä¿®æ”¹åˆ—å°åˆ°è¨ºè­‰æ˜å‡½æ•¸
async function printAttendanceCertificate(consultationId, consultationData = null) {
    let consultation = consultationData;
    
    // å¦‚æœæ²’æœ‰æä¾›è¨ºç—‡è³‡æ–™ï¼Œå¾ Firebase ç²å–
    if (!consultation) {
        try {
            const consultationResult = await window.firebaseDataManager.getConsultations();
            if (!consultationResult.success) {
                showToast('ç„¡æ³•è®€å–è¨ºç—‡è¨˜éŒ„ï¼', 'error');
                return;
            }
            
            consultation = consultationResult.data.find(c => c.id === consultationId);
            if (!consultation) {
                showToast('æ‰¾ä¸åˆ°è¨ºç—‡è¨˜éŒ„ï¼', 'error');
                return;
            }
        } catch (error) {
            console.error('è®€å–è¨ºç—‡è¨˜éŒ„éŒ¯èª¤:', error);
            showToast('è®€å–è¨ºç—‡è¨˜éŒ„å¤±æ•—', 'error');
            return;
        }
    }
    
    try {
        // å¾ Firebase ç²å–ç—…äººè³‡æ–™
        const patientResult = await window.firebaseDataManager.getPatients();
        if (!patientResult.success) {
            showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        
        const patient = patientResult.data.find(p => p.id === consultation.patientId);
        if (!patient) {
            showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        
        // ç²å–è¨ºç—‡æ—¥æœŸï¼ˆè™•ç† Firebase Timestampï¼‰
        let consultationDate;
        if (consultation.date && consultation.date.seconds) {
            consultationDate = new Date(consultation.date.seconds * 1000);
        } else if (consultation.date) {
            consultationDate = new Date(consultation.date);
        } else {
            consultationDate = new Date();
        }
        
        // å‰µå»ºåˆ°è¨ºè­‰æ˜æ ¼å¼
        const printContent = `
            <!DOCTYPE html>
            <html lang="zh-TW">
            <head>
                <meta charset="UTF-8">
                <title>åˆ°è¨ºè­‰æ˜æ›¸ - ${patient.name}</title>
                <style>
                    body { 
                        font-family: 'Microsoft JhengHei', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; 
                        margin: 0; 
                        padding: 8px; 
                        line-height: 1.3;
                        font-size: 10px;
                        background: white;
                    }
                    .certificate-container {
                        width: 148mm;
                        height: 210mm;
                        margin: 0 auto;
                        border: 3px solid #000;
                        padding: 8px;
                        background: white;
                        position: relative;
                        box-sizing: border-box;
                    }
                    .clinic-header {
                        text-align: center;
                        border-bottom: 2px solid #000;
                        padding-bottom: 10px;
                        margin-bottom: 15px;
                    }
                    .clinic-name {
                        font-size: 13px;
                        font-weight: bold;
                        margin-bottom: 3px;
                        letter-spacing: 1px;
                    }
                    .clinic-subtitle {
                        font-size: 10px;
                        color: #666;
                        margin-bottom: 4px;
                    }
                    .certificate-title {
                        font-size: 16px;
                        font-weight: bold;
                        text-align: center;
                        margin: 8px 0;
                        letter-spacing: 3px;
                        color: #000;
                    }
                    .certificate-number {
                        text-align: right;
                        font-size: 10px;
                        color: #666;
                        margin-bottom: 10px;
                    }
                    .content-section {
                        margin: 8px 0;
                        font-size: 10px;
                        line-height: 1.4;
                    }
                    .patient-info {
                        margin: 8px 0;
                    }
                    .info-row {
                        margin: 4px 0;
                        display: flex;
                        align-items: center;
                    }
                    .info-label {
                        font-weight: bold;
                        min-width: 80px;
                        display: inline-block;
                        font-size: 10px;
                    }
                    .info-value {
                        border-bottom: 1px solid #000;
                        min-width: 120px;
                        padding: 3px 6px;
                        margin-left: 6px;
                        font-size: 10px;
                    }
                    .attendance-section {
                        margin: 8px 0;
                        background: #e3f2fd;
                        padding: 6px;
                        border: 2px solid #2196f3;
                        border-radius: 4px;
                        text-align: center;
                    }
                    .attendance-title {
                        font-size: 11px;
                        font-weight: bold;
                        color: #1976d2;
                        margin-bottom: 4px;
                    }
                    .attendance-details {
                        font-size: 10px;
                        line-height: 1.3;
                    }
                    .doctor-signature {
                        margin-top: 10px;
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-end;
                    }
                    .signature-section {
                        text-align: center;
                    }
                    .signature-line {
                        border-bottom: 2px solid #000;
                        width: 60px;
                        height: 25px;
                        margin: 6px auto;
                        position: relative;
                    }
                    .signature-label {
                        font-size: 9px;
                        color: #666;
                        margin-top: 3px;
                    }
                    .date-section {
                        text-align: right;
                        font-size: 10px;
                    }
                    .footer-note {
                        margin-top: 15px;
                        padding-top: 8px;
                        border-top: 1px dashed #666;
                        font-size: 8px;
                        color: #666;
                        text-align: center;
                    }
                    .watermark {
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%) rotate(-45deg);
                        font-size: 80px;
                        color: rgba(0, 0, 0, 0.05);
                        font-weight: bold;
                        z-index: 0;
                        pointer-events: none;
                    }
                    .content {
                        position: relative;
                        z-index: 1;
                    }
                    @media print {
                        @page {
                            size: A5;
                            margin: 10mm;
                        }
                        body { 
                            margin: 0; 
                            padding: 0; 
                            font-size: 11px;
                        }
                        .certificate-container { 
                            border: 3px solid #000;
                            width: 100%;
                            height: 100%;
                            padding: 8mm;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="certificate-container">
                    <!-- æµ®æ°´å° -->
                    <div class="watermark">åˆ°è¨ºè­‰æ˜</div>
                    
                    <div class="content">
                        <!-- è¨ºæ‰€æ¨™é¡Œ -->
                        <div class="clinic-header">
                            <div class="clinic-name">${clinicSettings.chineseName || 'ä¸­é†«è¨ºæ‰€ç³»çµ±'}</div>
                            <div class="clinic-subtitle">${clinicSettings.englishName || 'TCM Clinic'}</div>
                            <div class="clinic-subtitle">é›»è©±ï¼š${clinicSettings.phone || '(852) 2345-6789'}ã€€åœ°å€ï¼š${clinicSettings.address || 'é¦™æ¸¯ä¸­ç’°çš‡åå¤§é“ä¸­123è™Ÿ'}</div>
                        </div>
                        
                        <!-- è­‰æ˜æ›¸ç·¨è™Ÿ -->
                        <div class="certificate-number">
                            è­‰æ˜æ›¸ç·¨è™Ÿï¼šAC${consultation.id.toString().padStart(6, '0')}
                        </div>
                        
                        <!-- è­‰æ˜æ›¸æ¨™é¡Œ -->
                        <div class="certificate-title">åˆ°è¨ºè­‰æ˜æ›¸</div>
                        
                        <!-- ç—…äººè³‡è¨Š -->
                        <div class="patient-info">
                            <div class="info-row">
                                <span class="info-label">å§“ã€€ã€€åï¼š</span>
                                <span class="info-value">${patient.name}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">æ€§ã€€ã€€åˆ¥ï¼š</span>
                                <span class="info-value">${patient.gender}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">å¹´ã€€ã€€é½¡ï¼š</span>
                                <span class="info-value">${formatAge(patient.birthDate)}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">èº«åˆ†è­‰è™Ÿï¼š</span>
                                <span class="info-value">${patient.idCard || 'æœªæä¾›'}</span>
                            </div>
                        </div>
                        
                        <!-- åˆ°è¨ºè³‡è¨Š -->
                        <div class="attendance-section">
                            <div class="attendance-title">åˆ°è¨ºè³‡è¨Š</div>
                            <div class="attendance-details">
                                <div><strong>åˆ°è¨ºæ—¥æœŸï¼š</strong>${(() => {
                                    const visitDate = consultation.visitTime ? new Date(consultation.visitTime) : consultationDate;
                                    return visitDate.toLocaleDateString('zh-TW', {
                                        year: 'numeric',
                                        month: '2-digit',
                                        day: '2-digit'
                                    });
                                })()}</div>
                                <div><strong>åˆ°è¨ºæ™‚é–“ï¼š</strong>${(() => {
                                    const visitDate = consultation.visitTime ? new Date(consultation.visitTime) : consultationDate;
                                    return visitDate.toLocaleTimeString('zh-TW', {
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    });
                                })()}</div>
                            </div>
                        </div>
                        
                        <!-- è¨ºç™‚è³‡è¨Š -->
                        ${consultation.diagnosis ? `
                        <div class="content-section">
                            <div style="margin-bottom: 15px;">
                                <strong>è¨ºæ–·çµæœï¼š</strong>${consultation.diagnosis}
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="content-section">
                            <strong>èŒ²è­‰æ˜ä¸Šè¿°ç—…äººç¢ºå¯¦æ–¼ä¸Šè¿°æ—¥æœŸæ™‚é–“åˆ°æœ¬è¨ºæ‰€æ¥å—ä¸­é†«è¨ºç™‚ã€‚</strong>
                        </div>
                        
                        <div class="content-section">
                            <strong>ç‰¹æ­¤è­‰æ˜ã€‚</strong>
                        </div>
                        
                        <!-- é†«å¸«ç°½åå€ -->
                        <div class="doctor-signature">
                            <div class="signature-section">
                                <div class="signature-line"></div>
                                <div class="signature-label">ä¸»æ²»é†«å¸«ç°½å</div>
                                <div style="margin-top: 10px; font-weight: bold;">
                                    ${getDoctorDisplayName(consultation.doctor)}
                                </div>
                                ${(() => {
                                    const regNumber = getDoctorRegistrationNumber(consultation.doctor);
                                    return regNumber ? `
                                        <div style="margin-top: 5px; font-size: 12px; color: #666;">
                                            è¨»å†Šç·¨è™Ÿï¼š${regNumber}
                                        </div>
                                    ` : '';
                                })()}
                            </div>
                            
                            <div class="date-section">
                                <div style="margin-bottom: 20px;">
                                    <strong>é–‹ç«‹æ—¥æœŸï¼š</strong><br>
                                    ${new Date().toLocaleDateString('zh-TW', {
                                        year: 'numeric',
                                        month: '2-digit',
                                        day: '2-digit'
                                    })}
                                </div>
                                <div style="border: 2px solid #000; padding: 15px; text-align: center; background: #f8f9fa;">
                                    <div style="font-weight: bold; margin-bottom: 5px;">è¨ºæ‰€å°ç« </div>
                                    <div style="font-size: 12px; color: #666;">(æ­¤è™•æ‡‰è“‹è¨ºæ‰€å°ç« )</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- é å°¾èªªæ˜ -->
                        <div class="footer-note">
                            <div>æœ¬è­‰æ˜æ›¸åƒ…è­‰æ˜åˆ°è¨ºäº‹å¯¦ï¼Œå¦‚æœ‰ç–‘å•è«‹æ´½æœ¬è¨ºæ‰€</div>
                            <div>è¨ºæ‰€é›»è©±ï¼š${clinicSettings.phone || '(852) 2345-6789'} | ç‡Ÿæ¥­æ™‚é–“ï¼š${clinicSettings.businessHours || 'é€±ä¸€è‡³é€±äº” 09:00-18:00'}</div>
                            <div style="margin-top: 10px; font-size: 10px;">
                                è­‰æ˜æ›¸é–‹ç«‹æ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}
                            </div>
                        </div>
                    </div>
                </div>
            </body>
            </html>
        `;
        
        // é–‹å•Ÿæ–°è¦–çª—é€²è¡Œåˆ—å°
        const printWindow = window.open('', '_blank', 'width=700,height=900');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        
        showToast('åˆ°è¨ºè­‰æ˜æ›¸å·²æº–å‚™åˆ—å°ï¼', 'success');
        
    } catch (error) {
        console.error('åˆ—å°åˆ°è¨ºè­‰æ˜éŒ¯èª¤:', error);
        showToast('åˆ—å°åˆ°è¨ºè­‰æ˜æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
    }
}
        
// ä¿®å¾©ç—…å‡è­‰æ˜å‡½æ•¸
async function printSickLeave(consultationId, consultationData = null) {
    let consultation = consultationData;
    
    // å¦‚æœæ²’æœ‰æä¾›è¨ºç—‡è³‡æ–™ï¼Œå¾æœ¬åœ°æŸ¥æ‰¾
    if (!consultation) {
        consultation = consultations.find(c => c.id === consultationId);
        if (!consultation) {
            showToast('æ‰¾ä¸åˆ°è¨ºç—‡è¨˜éŒ„ï¼', 'error');
            return;
        }
    }
    
    try {            
        const patientResult = await window.firebaseDataManager.getPatients();
        if (!patientResult.success) {
            showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }

        const patient = patientResult.data.find(p => p.id === consultation.patientId);
        if (!patient) {
            showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        
        // å‰µå»ºç—…å‡è­‰æ˜æ ¼å¼
        const printContent = `
            <!DOCTYPE html>
            <html lang="zh-TW">
            <head>
                <meta charset="UTF-8">
                <title>ç—…å‡è­‰æ˜æ›¸ - ${patient.name}</title>
                <style>
                    body { 
                        font-family: 'Microsoft JhengHei', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; 
                        margin: 0; 
                        padding: 8px; 
                        line-height: 1.3;
                        font-size: 10px;
                        background: white;
                    }
                    .certificate-container {
                        width: 148mm;
                        height: 210mm;
                        margin: 0 auto;
                        border: 3px solid #000;
                        padding: 8px;
                        background: white;
                        position: relative;
                        box-sizing: border-box;
                    }
                    .clinic-header {
                        text-align: center;
                        border-bottom: 2px solid #000;
                        padding-bottom: 10px;
                        margin-bottom: 15px;
                    }
                    .clinic-name {
                        font-size: 13px;
                        font-weight: bold;
                        margin-bottom: 3px;
                        letter-spacing: 1px;
                    }
                    .clinic-subtitle {
                        font-size: 10px;
                        color: #666;
                        margin-bottom: 4px;
                    }
                    .certificate-title {
                        font-size: 16px;
                        font-weight: bold;
                        text-align: center;
                        margin: 8px 0;
                        letter-spacing: 3px;
                        color: #000;
                    }
                    .certificate-number {
                        text-align: right;
                        font-size: 10px;
                        color: #666;
                        margin-bottom: 10px;
                    }
                    .content-section {
                        margin: 8px 0;
                        font-size: 10px;
                        line-height: 1.4;
                    }
                    .patient-info {
                        margin: 8px 0;
                    }
                    .info-row {
                        margin: 4px 0;
                        display: flex;
                        align-items: center;
                    }
                    .info-label {
                        font-weight: bold;
                        min-width: 80px;
                        display: inline-block;
                        font-size: 10px;
                    }
                    .info-value {
                        border-bottom: 1px solid #000;
                        min-width: 120px;
                        padding: 3px 6px;
                        margin-left: 6px;
                        font-size: 10px;
                    }
                    .diagnosis-section {
                        margin: 8px 0;
                        background: #f9f9f9;
                        padding: 6px;
                        border: 1px solid #ddd;
                        border-radius: 3px;
                    }
                    .rest-period {
                        margin: 8px 0;
                        font-size: 11px;
                        font-weight: bold;
                        text-align: center;
                        background: #fff3cd;
                        padding: 6px;
                        border: 2px solid #ffc107;
                        border-radius: 4px;
                    }
                    .doctor-signature {
                        margin-top: 10px;
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-end;
                    }
                    .signature-section {
                        text-align: center;
                    }
                    .signature-line {
                        border-bottom: 2px solid #000;
                        width: 60px;
                        height: 25px;
                        margin: 6px auto;
                        position: relative;
                    }
                    .signature-label {
                        font-size: 9px;
                        color: #666;
                        margin-top: 3px;
                    }
                    .date-section {
                        text-align: right;
                        font-size: 10px;
                    }
                    .footer-note {
                        margin-top: 15px;
                        padding-top: 8px;
                        border-top: 1px dashed #666;
                        font-size: 8px;
                        color: #666;
                        text-align: center;
                    }
                    .watermark {
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%) rotate(-45deg);
                        font-size: 80px;
                        color: rgba(0, 0, 0, 0.05);
                        font-weight: bold;
                        z-index: 0;
                        pointer-events: none;
                    }
                    .content {
                        position: relative;
                        z-index: 1;
                    }
                    @media print {
                        @page {
                            size: A5;
                            margin: 10mm;
                        }
                        body { 
                            margin: 0; 
                            padding: 0; 
                            font-size: 11px;
                        }
                        .certificate-container { 
                            border: 3px solid #000;
                            width: 100%;
                            height: 100%;
                            padding: 8mm;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="certificate-container">
                    <!-- æµ®æ°´å° -->
                    <div class="watermark">ç—…å‡è­‰æ˜</div>
                    
                    <div class="content">
                        <!-- è¨ºæ‰€æ¨™é¡Œ -->
                        <div class="clinic-header">
                            <div class="clinic-name">${clinicSettings.chineseName || 'ä¸­é†«è¨ºæ‰€ç³»çµ±'}</div>
                            <div class="clinic-subtitle">${clinicSettings.englishName || 'TCM Clinic'}</div>
                            <div class="clinic-subtitle">é›»è©±ï¼š${clinicSettings.phone || '(852) 2345-6789'}ã€€åœ°å€ï¼š${clinicSettings.address || 'é¦™æ¸¯ä¸­ç’°çš‡åå¤§é“ä¸­123è™Ÿ'}</div>
                        </div>
                        
                        <!-- è­‰æ˜æ›¸ç·¨è™Ÿ -->
                        <div class="certificate-number">
                            è­‰æ˜æ›¸ç·¨è™Ÿï¼šSL${consultation.id.toString().padStart(6, '0')}
                        </div>
                        
                        <!-- è­‰æ˜æ›¸æ¨™é¡Œ -->
                        <div class="certificate-title">ç—…å‡è­‰æ˜æ›¸</div>
                        
                        <!-- ç—…äººè³‡è¨Š -->
                        <div class="patient-info">
                            <div class="info-row">
                                <span class="info-label">å§“ã€€ã€€åï¼š</span>
                                <span class="info-value">${patient.name}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">æ€§ã€€ã€€åˆ¥ï¼š</span>
                                <span class="info-value">${patient.gender}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">å¹´ã€€ã€€é½¡ï¼š</span>
                                <span class="info-value">${formatAge(patient.birthDate)}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">èº«åˆ†è­‰è™Ÿï¼š</span>
                                <span class="info-value">${patient.idCard || 'æœªæä¾›'}</span>
                            </div>
                        </div>
                        
                        <!-- è¨ºæ–·è³‡è¨Š -->
                        <div class="diagnosis-section">
                            <div style="margin-bottom: 15px;">
                                <strong>è¨ºç™‚æ—¥æœŸï¼š</strong>${(() => {
                                    const visitDate = consultation.visitTime ? new Date(consultation.visitTime) : new Date(consultation.date);
                                    return visitDate.toLocaleDateString('zh-TW', {
                                        year: 'numeric',
                                        month: '2-digit',
                                        day: '2-digit'
                                    });
                                })()}
                            </div>
                            <div style="margin-bottom: 15px;">
                                <strong>è¨ºæ–·çµæœï¼š</strong>${consultation.diagnosis || 'éœ€è¦ä¼‘æ¯èª¿é¤Š'}
                            </div>
                        </div>
                        
                        <!-- å»ºè­°ä¼‘æ¯æœŸé–“ -->
                        <div class="rest-period">
                            å»ºè­°ä¼‘æ¯æœŸé–“ï¼š${(() => {
                                // å„ªå…ˆä½¿ç”¨è¨ºç—‡è¨˜éŒ„ä¸­çš„ä¼‘æ¯æœŸé–“è¨­å®š
                                if (consultation.restStartDate && consultation.restEndDate) {
                                    const startDate = new Date(consultation.restStartDate);
                                    const endDate = new Date(consultation.restEndDate);
                                    const timeDiff = endDate.getTime() - startDate.getTime();
                                    const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1; // åŒ…å«é–‹å§‹å’ŒçµæŸæ—¥æœŸ
                                    
                                    return `${startDate.toLocaleDateString('zh-TW')} è‡³ ${endDate.toLocaleDateString('zh-TW')} (å…± ${daysDiff} å¤©)`;
                                }
                                
                                // å¦‚æœæ²’æœ‰è¨­å®šä¼‘æ¯æœŸé–“ï¼Œä½¿ç”¨èˆŠçš„é‚è¼¯
                                let restDays = consultation.restDays ? parseInt(consultation.restDays) : 3;
                                
                                // å¦‚æœæ²’æœ‰è¨­å®šä¼‘æ¯å¤©æ•¸ï¼Œå‰‡æ ¹æ“šæ²»ç™‚ç™‚ç¨‹æ¨ç®—
                                if (!consultation.restDays) {
                                    const treatmentCourse = consultation.treatmentCourse || 'ä¸€å‘¨';
                                    
                                    if (treatmentCourse.includes('å¤©')) {
                                        const match = treatmentCourse.match(/(\d+)å¤©/);
                                        if (match) {
                                            restDays = Math.min(parseInt(match[1]), 7); // æœ€å¤š7å¤©
                                        }
                                    } else if (treatmentCourse.includes('é€±') || treatmentCourse.includes('å‘¨')) {
                                        const match = treatmentCourse.match(/(\d+)[é€±å‘¨]/);
                                        if (match) {
                                            restDays = Math.min(parseInt(match[1]) * 7, 7); // æœ€å¤š7å¤©
                                        }
                                    }
                                }
                                
                                // ä½¿ç”¨åˆ°è¨ºæ™‚é–“ä½œç‚ºèµ·å§‹æ—¥æœŸï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨è¨ºç—‡æ—¥æœŸ
                                const startDate = consultation.visitTime ? new Date(consultation.visitTime) : new Date(consultation.date);
                                const endDate = new Date(startDate);
                                endDate.setDate(startDate.getDate() + restDays - 1);
                                
                                return `${startDate.toLocaleDateString('zh-TW')} è‡³ ${endDate.toLocaleDateString('zh-TW')} (å…± ${restDays} å¤©)`;
                            })()}
                        </div>
                        
                        <!-- é†«å›‘ -->
                        ${consultation.instructions ? `
                        <div class="content-section">
                            <strong>é†«å¸«å»ºè­°ï¼š</strong><br>
                            ${consultation.instructions}
                        </div>
                        ` : ''}
                        
                        <div class="content-section">
                            <strong>ç‰¹æ­¤è­‰æ˜ã€‚</strong>
                        </div>
                        
                        <!-- é†«å¸«ç°½åå€ -->
                        <div class="doctor-signature">
                            <div class="signature-section">
                                <div class="signature-line"></div>
                                <div class="signature-label">ä¸»æ²»é†«å¸«ç°½å</div>
                                <div style="margin-top: 10px; font-weight: bold;">
                                    ${getDoctorDisplayName(consultation.doctor)}
                                </div>
                                ${(() => {
                                    const regNumber = getDoctorRegistrationNumber(consultation.doctor);
                                    return regNumber ? `
                                        <div style="margin-top: 5px; font-size: 12px; color: #666;">
                                            è¨»å†Šç·¨è™Ÿï¼š${regNumber}
                                        </div>
                                    ` : '';
                                })()}
                            </div>
                            
                            <div class="date-section">
                                <div style="margin-bottom: 20px;">
                                    <strong>é–‹ç«‹æ—¥æœŸï¼š</strong><br>
                                    ${new Date().toLocaleDateString('zh-TW', {
                                        year: 'numeric',
                                        month: '2-digit',
                                        day: '2-digit'
                                    })}
                                </div>
                                <div style="border: 2px solid #000; padding: 15px; text-align: center; background: #f8f9fa;">
                                    <div style="font-weight: bold; margin-bottom: 5px;">è¨ºæ‰€å°ç« </div>
                                    <div style="font-size: 12px; color: #666;">(æ­¤è™•æ‡‰è“‹è¨ºæ‰€å°ç« )</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- é å°¾èªªæ˜ -->
                        <div class="footer-note">
                            <div>æœ¬è­‰æ˜æ›¸åƒ…ä¾›è«‹å‡ä½¿ç”¨ï¼Œå¦‚æœ‰ç–‘å•è«‹æ´½æœ¬è¨ºæ‰€</div>
                            <div>è¨ºæ‰€é›»è©±ï¼š${clinicSettings.phone || '(852) 2345-6789'} | ç‡Ÿæ¥­æ™‚é–“ï¼š${clinicSettings.businessHours || 'é€±ä¸€è‡³é€±äº” 09:00-18:00'}</div>
                            <div style="margin-top: 10px; font-size: 10px;">
                                è­‰æ˜æ›¸é–‹ç«‹æ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}
                            </div>
                        </div>
                    </div>
                </div>
            </body>
            </html>
        `;
        
        // é–‹å•Ÿæ–°è¦–çª—é€²è¡Œåˆ—å°
        const printWindow = window.open('', '_blank', 'width=700,height=900');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        
        showToast('ç—…å‡è­‰æ˜æ›¸å·²æº–å‚™åˆ—å°ï¼', 'success');
        
    } catch (error) {
        console.error('è®€å–ç—…äººè³‡æ–™éŒ¯èª¤:', error);
        showToast('è®€å–ç—…äººè³‡æ–™å¤±æ•—', 'error');
    }
}

// ä¿®å¾©æ’¤å›è¨ºç—‡åŠŸèƒ½
async function withdrawConsultation(appointmentId) {
    const appointment = appointments.find(apt => apt.id === appointmentId);
    if (!appointment) {
        showToast('æ‰¾ä¸åˆ°æ›è™Ÿè¨˜éŒ„ï¼', 'error');
        return;
    }
    
    try {             
        const patientResult = await window.firebaseDataManager.getPatients();
        if (!patientResult.success) {
            showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }

        const patient = patientResult.data.find(p => p.id === appointment.patientId);
        if (!patient) {
            showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        
        // è©³ç´°ç‹€æ…‹æª¢æŸ¥
        console.log(`æ’¤å›è¨ºç—‡ç‹€æ…‹æª¢æŸ¥ - ç—…äºº: ${patient.name}, ç•¶å‰ç‹€æ…‹: ${appointment.status}, è¨ºç—‡è¨˜éŒ„ID: ${appointment.consultationId}`);
        
        // åªæœ‰å·²å®Œæˆçš„è¨ºç—‡æ‰èƒ½æ’¤å›
        if (appointment.status !== 'completed') {
            const statusNames = {
                'registered': 'å·²æ›è™Ÿ',
                'waiting': 'å€™è¨ºä¸­',
                'consulting': 'è¨ºç—‡ä¸­'
            };
            const currentStatusName = statusNames[appointment.status] || appointment.status;
            showToast(`ç„¡æ³•æ’¤å›è¨ºç—‡ï¼ç—…äºº ${patient.name} ç›®å‰ç‹€æ…‹ç‚ºã€Œ${currentStatusName}ã€ï¼Œåªèƒ½æ’¤å›å·²å®Œæˆçš„è¨ºç—‡ã€‚`, 'warning');
            return;
        }
        
        // æª¢æŸ¥æ˜¯å¦æœ‰è¨ºç—‡è¨˜éŒ„
        if (!appointment.consultationId) {
            showToast(`ç„¡æ³•æ’¤å›è¨ºç—‡ï¼ç—…äºº ${patient.name} æ²’æœ‰å°æ‡‰çš„è¨ºç—‡è¨˜éŒ„ã€‚`, 'error');
            return;
        }
        
        const consultation = consultations.find(c => c.id === appointment.consultationId);
        if (!consultation) {
            showToast(`ç„¡æ³•æ’¤å›è¨ºç—‡ï¼æ‰¾ä¸åˆ°ç—…äºº ${patient.name} çš„è¨ºç—‡è¨˜éŒ„è³‡æ–™ã€‚`, 'error');
            return;
        }
        
        // ç¢ºèªæ’¤å›æ“ä½œ
        const confirmMessage = `ç¢ºå®šè¦æ’¤å› ${patient.name} çš„è¨ºç—‡å—ï¼Ÿ\n\n` +
                             `æ­¤æ“ä½œå°‡æœƒï¼š\n` +
                             `â€¢ åˆªé™¤è©²æ¬¡è¨ºç—‡è¨˜éŒ„\n` +
                             `â€¢ ç—…äººç‹€æ…‹å›åˆ°ã€Œå·²æ›è™Ÿã€\n` +
                             `â€¢ æ‰€æœ‰è¨ºç—‡è³‡æ–™å°‡æ°¸ä¹…éºå¤±\n\n` +
                             `è¨ºç—‡æ—¥æœŸï¼š${new Date(consultation.date).toLocaleString('zh-TW')}\n` +
                             `è¨ºæ–·ï¼š${consultation.diagnosis || 'ç„¡è¨˜éŒ„'}\n\n` +
                             `æ³¨æ„ï¼šæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`;
        
        if (confirm(confirmMessage)) {
            // åˆªé™¤è¨ºç—‡è¨˜éŒ„
            const consultationIndex = consultations.findIndex(c => c.id === appointment.consultationId);
            if (consultationIndex !== -1) {
                consultations.splice(consultationIndex, 1);
                localStorage.setItem('consultations', JSON.stringify(consultations));
            }
            
            // å°‡æ›è™Ÿç‹€æ…‹æ”¹å›å·²æ›è™Ÿ
            appointment.status = 'registered';
            delete appointment.completedAt;
            delete appointment.consultationId;
            delete appointment.completedBy;
            delete appointment.consultationStartTime;
            delete appointment.consultingDoctor;
            
            // ä¿å­˜ç‹€æ…‹è®Šæ›´
            localStorage.setItem('appointments', JSON.stringify(appointments));
            
            showToast(`å·²æ’¤å› ${patient.name} çš„è¨ºç—‡ï¼Œç—…äººç‹€æ…‹å›åˆ°å·²æ›è™Ÿ`, 'success');
            
            // å¦‚æœæ­£åœ¨ç·¨è¼¯è©²ç—…æ­·ï¼Œå‰‡é—œé–‰è¡¨å–®
            if (currentConsultingAppointmentId === appointmentId) {
                closeConsultationForm();
                currentConsultingAppointmentId = null;
            }
            
            // é‡æ–°è¼‰å…¥åˆ—è¡¨å’Œçµ±è¨ˆ
            loadTodayAppointments();
            updateStatistics();
        }
    } catch (error) {
        console.error('è®€å–ç—…äººè³‡æ–™éŒ¯èª¤:', error);
        showToast('è®€å–ç—…äººè³‡æ–™å¤±æ•—', 'error');
    }
}

// ä¿®å¾©ä¿®æ”¹ç—…æ­·åŠŸèƒ½
async function editMedicalRecord(appointmentId) {
    const appointment = appointments.find(apt => apt.id === appointmentId);
    if (!appointment) {
        showToast('æ‰¾ä¸åˆ°æ›è™Ÿè¨˜éŒ„ï¼', 'error');
        return;
    }
    
    try {            
        const patientResult = await window.firebaseDataManager.getPatients();
        if (!patientResult.success) {
            showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }

        const patient = patientResult.data.find(p => p.id === appointment.patientId);
        if (!patient) {
            showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        
        // è©³ç´°ç‹€æ…‹æª¢æŸ¥
        console.log(`ä¿®æ”¹ç—…æ­·ç‹€æ…‹æª¢æŸ¥ - ç—…äºº: ${patient.name}, ç•¶å‰ç‹€æ…‹: ${appointment.status}, è¨ºç—‡è¨˜éŒ„ID: ${appointment.consultationId}`);
        
        // åªæœ‰å·²å®Œæˆçš„è¨ºç—‡æ‰èƒ½ä¿®æ”¹ç—…æ­·
        if (appointment.status !== 'completed') {
            const statusNames = {
                'registered': 'å·²æ›è™Ÿ',
                'waiting': 'å€™è¨ºä¸­',
                'consulting': 'è¨ºç—‡ä¸­'
            };
            const currentStatusName = statusNames[appointment.status] || appointment.status;
            showToast(`ç„¡æ³•ä¿®æ”¹ç—…æ­·ï¼ç—…äºº ${patient.name} ç›®å‰ç‹€æ…‹ç‚ºã€Œ${currentStatusName}ã€ï¼Œåªèƒ½ä¿®æ”¹å·²å®Œæˆè¨ºç—‡çš„ç—…æ­·ã€‚`, 'warning');
            return;
        }
        
        // æª¢æŸ¥æ˜¯å¦æœ‰è¨ºç—‡è¨˜éŒ„
        if (!appointment.consultationId) {
            showToast(`ç„¡æ³•ä¿®æ”¹ç—…æ­·ï¼ç—…äºº ${patient.name} æ²’æœ‰å°æ‡‰çš„è¨ºç—‡è¨˜éŒ„ã€‚`, 'error');
            return;
        }
        
        const consultation = consultations.find(c => c.id === appointment.consultationId);
        if (!consultation) {
            showToast(`ç„¡æ³•ä¿®æ”¹ç—…æ­·ï¼æ‰¾ä¸åˆ°ç—…äºº ${patient.name} çš„è¨ºç—‡è¨˜éŒ„è³‡æ–™ã€‚`, 'error');
            return;
        }
        
        // æª¢æŸ¥æ˜¯å¦æœ‰å…¶ä»–ç—…äººæ­£åœ¨è¨ºç—‡ä¸­
        const consultingAppointment = appointments.find(apt => 
            apt.status === 'consulting' && 
            new Date(apt.appointmentTime).toDateString() === new Date().toDateString()
        );
        
        if (consultingAppointment) {
            // å¾ Firebase ç²å–æ­£åœ¨è¨ºç—‡çš„ç—…äººè³‡æ–™
            const consultingPatient = patientResult.data.find(p => p.id === consultingAppointment.patientId);
            const consultingPatientName = consultingPatient ? consultingPatient.name : 'æœªçŸ¥ç—…äºº';
            
            if (confirm(`ç›®å‰ ${consultingPatientName} æ­£åœ¨è¨ºç—‡ä¸­ã€‚\n\næ˜¯å¦è¦çµæŸè©²ç—…äººçš„è¨ºç—‡ä¸¦é–‹å§‹ä¿®æ”¹ ${patient.name} çš„ç—…æ­·ï¼Ÿ\n\næ³¨æ„ï¼š${consultingPatientName} çš„ç‹€æ…‹å°‡æ”¹å›å€™è¨ºä¸­ã€‚`)) {
                // çµæŸç•¶å‰è¨ºç—‡çš„ç—…äºº
                consultingAppointment.status = 'waiting';
                delete consultingAppointment.consultationStartTime;
                delete consultingAppointment.consultingDoctor;
                
                // é—œé–‰å¯èƒ½é–‹å•Ÿçš„è¨ºç—‡è¡¨å–®
                if (currentConsultingAppointmentId === consultingAppointment.id) {
                    closeConsultationForm();
                }
                
                showToast(`å·²çµæŸ ${consultingPatientName} çš„è¨ºç—‡`, 'info');
                localStorage.setItem('appointments', JSON.stringify(appointments));
            } else {
                return; // ç”¨æˆ¶å–æ¶ˆæ“ä½œ
            }
        }
        
        // è¨­ç½®ç‚ºç·¨è¼¯æ¨¡å¼
        currentConsultingAppointmentId = appointmentId;
        showConsultationForm(appointment);
        
        showToast(`é€²å…¥ ${patient.name} çš„ç—…æ­·ç·¨è¼¯æ¨¡å¼`, 'info');
        
    } catch (error) {
        console.error('è®€å–ç—…äººè³‡æ–™éŒ¯èª¤:', error);
        showToast('è®€å–ç—…äººè³‡æ–™å¤±æ•—', 'error');
    }
}

// è¼‰å…¥ç—…äººè¨ºç—‡è¨˜éŒ„æ‘˜è¦
async function loadPatientConsultationSummary(patientId) {
    const summaryContainer = document.getElementById('patientConsultationSummary');
    
    try {
        const result = await window.firebaseDataManager.getPatientConsultations(patientId);
        
        if (!result.success) {
            summaryContainer.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <div class="text-4xl mb-2">âŒ</div>
                    <div>ç„¡æ³•è¼‰å…¥è¨ºç—‡è¨˜éŒ„</div>
                </div>
            `;
            return;
        }

        const consultations = result.data;
        const totalConsultations = consultations.length;
        const lastConsultation = consultations[0]; // æœ€æ–°çš„è¨ºç—‡è¨˜éŒ„

        if (totalConsultations === 0) {
            summaryContainer.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="bg-blue-50 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-blue-600">0</div>
                        <div class="text-sm text-blue-800">ç¸½è¨ºç—‡æ¬¡æ•¸</div>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4 text-center">
                        <div class="text-lg font-semibold text-green-600">ç„¡</div>
                        <div class="text-sm text-green-800">æœ€è¿‘è¨ºç—‡</div>
                    </div>
                    <div class="bg-orange-50 rounded-lg p-4 text-center">
                        <div class="text-lg font-semibold text-orange-600">ç„¡å®‰æ’</div>
                        <div class="text-sm text-orange-800">ä¸‹æ¬¡è¤‡è¨º</div>
                    </div>
                </div>
                <div class="text-center py-8 text-gray-500">
                    <div class="text-4xl mb-2">ğŸ“‹</div>
                    <div>å°šç„¡è¨ºç—‡è¨˜éŒ„</div>
                </div>
            `;
            return;
        }

        // æ ¼å¼åŒ–æœ€å¾Œè¨ºç—‡æ—¥æœŸ
        const lastConsultationDate = lastConsultation.date ? 
            new Date(lastConsultation.date.seconds * 1000).toLocaleDateString('zh-TW') : 
            new Date(lastConsultation.createdAt.seconds * 1000).toLocaleDateString('zh-TW');

        // æ ¼å¼åŒ–ä¸‹æ¬¡è¤‡è¨ºæ—¥æœŸ
        const nextFollowUp = lastConsultation.followUpDate ? 
            new Date(lastConsultation.followUpDate).toLocaleDateString('zh-TW') : 'ç„¡å®‰æ’';

        summaryContainer.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div class="bg-blue-50 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-blue-600">${totalConsultations}</div>
                    <div class="text-sm text-blue-800">ç¸½è¨ºç—‡æ¬¡æ•¸</div>
                </div>
                <div class="bg-green-50 rounded-lg p-4 text-center">
                    <div class="text-lg font-semibold text-green-600">${lastConsultationDate}</div>
                    <div class="text-sm text-green-800">æœ€è¿‘è¨ºç—‡</div>
                </div>
                <div class="bg-orange-50 rounded-lg p-4 text-center">
                    <div class="text-lg font-semibold text-orange-600">${nextFollowUp}</div>
                    <div class="text-sm text-orange-800">ä¸‹æ¬¡è¤‡è¨º</div>
                </div>
            </div>
            
            <div class="bg-gray-50 rounded-lg p-4">
                <h5 class="font-medium text-gray-800 mb-2">æœ€è¿‘è¨ºç—‡è¨˜éŒ„</h5>
                <div class="text-sm text-gray-700">
                    <div><span class="font-medium">è¨ºæ–·ï¼š</span>${lastConsultation.diagnosis || 'ç„¡è¨˜éŒ„'}</div>
                    <div class="mt-1"><span class="font-medium">è­‰å‹ï¼š</span>${lastConsultation.syndrome || 'ç„¡è¨˜éŒ„'}</div>
                    ${lastConsultation.instructions ? `<div class="mt-1"><span class="font-medium">é†«å›‘ï¼š</span>${lastConsultation.instructions}</div>` : ''}
                </div>
                <div class="mt-3">
                    <button onclick="viewPatientMedicalHistory('${patientId}')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm transition duration-200">
                        æŸ¥çœ‹å®Œæ•´ç—…æ­·
                    </button>
                </div>
            </div>
        `;

    } catch (error) {
        console.error('è¼‰å…¥è¨ºç—‡è¨˜éŒ„æ‘˜è¦éŒ¯èª¤:', error);
        summaryContainer.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <div class="text-4xl mb-2">âŒ</div>
                <div>è¼‰å…¥è¨ºç—‡è¨˜éŒ„å¤±æ•—</div>
            </div>
        `;
    }
}

        
// 6. ä¿®æ”¹æ›´æ–°çµ±è¨ˆåŠŸèƒ½
async function updateStatistics() {
    try {
        // å¦‚æœ Firebase æ•¸æ“šç®¡ç†å™¨å°šæœªåˆå§‹åŒ–æˆ–å°šæœªæº–å‚™å¥½ï¼Œå‰‡è·³éçµ±è¨ˆæ›´æ–°ã€‚
        if (!window.firebaseDataManager || !window.firebaseDataManager.isReady) {
            console.log('Firebase æ•¸æ“šç®¡ç†å™¨å°šæœªæº–å‚™å°±ç·’ï¼Œçµ±è¨ˆè³‡è¨Šå°‡ç¨å¾Œæ›´æ–°');
            return;
        }
        // å¾ Firebase ç²å–ç—…äººç¸½æ•¸
        const result = await window.firebaseDataManager.getPatients();
        const totalPatients = result.success ? result.data.length : 0;
        
        // æ›´æ–°ç—…äººç¸½æ•¸é¡¯ç¤º
        const totalPatientsElement = document.getElementById('totalPatients');
        if (totalPatientsElement) {
            totalPatientsElement.textContent = totalPatients;
        }
        
        // è¨ˆç®—ä»Šæ—¥è¨ºç—‡æ•¸ï¼ˆå¾æœ¬åœ°appointmentsè¨ˆç®—ï¼Œå› ç‚ºæ›è™Ÿç³»çµ±å°šæœªç§»åˆ°Firebaseï¼‰
        const today = new Date().toDateString();
        const todayConsultations = appointments.filter(apt => 
            apt.status === 'completed' && 
            new Date(apt.appointmentTime).toDateString() === today
        ).length;
        
        const todayConsultationsElement = document.getElementById('todayConsultations');
        if (todayConsultationsElement) {
            todayConsultationsElement.textContent = todayConsultations;
        }
        
        // è¨ˆç®—æœ¬æœˆè¨ºç—‡æ•¸
        const thisMonth = new Date();
        const monthlyConsultations = appointments.filter(apt => 
            apt.status === 'completed' && 
            new Date(apt.appointmentTime).getMonth() === thisMonth.getMonth() &&
            new Date(apt.appointmentTime).getFullYear() === thisMonth.getFullYear()
        ).length;
        
        const monthlyConsultationsElement = document.getElementById('monthlyConsultations');
        if (monthlyConsultationsElement) {
            monthlyConsultationsElement.textContent = monthlyConsultations;
        }
        
    } catch (error) {
        console.error('æ›´æ–°çµ±è¨ˆéŒ¯èª¤:', error);
        // å¦‚æœ Firebase è®€å–å¤±æ•—ï¼Œé¡¯ç¤º 0
        const totalPatientsElement = document.getElementById('totalPatients');
        if (totalPatientsElement) {
            totalPatientsElement.textContent = '0';
        }
    }
}
        function exportData() {
            const data = {
                patients: patients,
                consultations: consultations,
                appointments: appointments,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `è¨ºæ‰€è³‡æ–™_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('è³‡æ–™åŒ¯å‡ºå®Œæˆï¼', 'success');
        }

        function backupData() {
            const backup = {
                patients: patients,
                consultations: consultations,
                appointments: appointments,
                backupDate: new Date().toISOString()
            };
            localStorage.setItem('clinicBackup', JSON.stringify(backup));
            showToast('è³‡æ–™å‚™ä»½å®Œæˆï¼', 'success');
        }

        function clearData() {
            if (confirm('è­¦å‘Šï¼šæ­¤æ“ä½œå°‡æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                if (confirm('æœ€å¾Œç¢ºèªï¼šæ‰€æœ‰ç—…äººè³‡æ–™å’Œè¨ºç—‡è¨˜éŒ„å°‡è¢«æ°¸ä¹…åˆªé™¤ï¼')) {
                    localStorage.removeItem('patients');
                    localStorage.removeItem('consultations');
                    localStorage.removeItem('appointments');
                    patients = [];
                    consultations = [];
                    appointments = [];
                    updateStatistics();
                    showToast('æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤ï¼', 'success');
                }
            }
        }

        // è¨ºæ‰€è¨­å®šç®¡ç†åŠŸèƒ½
        function showClinicSettingsModal() {
            // è¼‰å…¥ç¾æœ‰è¨­å®š
            document.getElementById('clinicChineseName').value = clinicSettings.chineseName || '';
            document.getElementById('clinicEnglishName').value = clinicSettings.englishName || '';
            document.getElementById('clinicBusinessHours').value = clinicSettings.businessHours || '';
            document.getElementById('clinicPhone').value = clinicSettings.phone || '';
            document.getElementById('clinicAddress').value = clinicSettings.address || '';
            
            document.getElementById('clinicSettingsModal').classList.remove('hidden');
        }
        
        function hideClinicSettingsModal() {
            document.getElementById('clinicSettingsModal').classList.add('hidden');
        }
        
        function saveClinicSettings() {
            const chineseName = document.getElementById('clinicChineseName').value.trim();
            const englishName = document.getElementById('clinicEnglishName').value.trim();
            const businessHours = document.getElementById('clinicBusinessHours').value.trim();
            const phone = document.getElementById('clinicPhone').value.trim();
            const address = document.getElementById('clinicAddress').value.trim();
            
            if (!chineseName) {
                showToast('è«‹è¼¸å…¥è¨ºæ‰€ä¸­æ–‡åç¨±ï¼', 'error');
                return;
            }
            
            // æ›´æ–°è¨ºæ‰€è¨­å®š
            clinicSettings.chineseName = chineseName;
            clinicSettings.englishName = englishName;
            clinicSettings.businessHours = businessHours;
            clinicSettings.phone = phone;
            clinicSettings.address = address;
            clinicSettings.updatedAt = new Date().toISOString();
            
            // ä¿å­˜åˆ°æœ¬åœ°å„²å­˜
            localStorage.setItem('clinicSettings', JSON.stringify(clinicSettings));
            
            // æ›´æ–°ç³»çµ±ç®¡ç†é é¢çš„é¡¯ç¤º
            updateClinicSettingsDisplay();
            
            hideClinicSettingsModal();
            showToast('è¨ºæ‰€è³‡æ–™å·²æˆåŠŸæ›´æ–°ï¼', 'success');
        }
        
        function updateClinicSettingsDisplay() {
            // æ›´æ–°ç³»çµ±ç®¡ç†é é¢çš„è¨ºæ‰€è¨­å®šé¡¯ç¤º
            const chineseNameSpan = document.getElementById('displayChineseName');
            const englishNameSpan = document.getElementById('displayEnglishName');
            
            if (chineseNameSpan) {
                chineseNameSpan.textContent = clinicSettings.chineseName || 'ä¸­é†«è¨ºæ‰€ç³»çµ±';
            }
            if (englishNameSpan) {
                englishNameSpan.textContent = clinicSettings.englishName || 'TCM Clinic';
            }
            
            // æ›´æ–°ç™»å…¥é é¢çš„è¨ºæ‰€åç¨±
            const loginTitle = document.getElementById('loginTitle');
            const loginEnglishTitle = document.getElementById('loginEnglishTitle');
            if (loginTitle) {
                loginTitle.textContent = clinicSettings.chineseName || 'ä¸­é†«è¨ºæ‰€ç³»çµ±';
            }
            if (loginEnglishTitle) {
                loginEnglishTitle.textContent = clinicSettings.englishName || 'TCM Clinic';
            }
            
            // æ›´æ–°ä¸»é é¢çš„è¨ºæ‰€åç¨±
            const systemTitle = document.getElementById('systemTitle');
            const systemEnglishTitle = document.getElementById('systemEnglishTitle');
            if (systemTitle) {
                systemTitle.textContent = clinicSettings.chineseName || 'ä¸­é†«è¨ºæ‰€ç³»çµ±';
            }
            if (systemEnglishTitle) {
                systemEnglishTitle.textContent = clinicSettings.englishName || 'TCM Clinic';
            }
            
            // æ›´æ–°æ­¡è¿é é¢çš„è¨ºæ‰€åç¨±
            const welcomeTitle = document.getElementById('welcomeTitle');
            const welcomeEnglishTitle = document.getElementById('welcomeEnglishTitle');
            if (welcomeTitle) {
                welcomeTitle.textContent = `æ­¡è¿ä½¿ç”¨${clinicSettings.chineseName || 'ä¸­é†«è¨ºæ‰€ç³»çµ±'}`;
            }
            if (welcomeEnglishTitle) {
                welcomeEnglishTitle.textContent = `Welcome to ${clinicSettings.englishName || 'TCM Clinic'}`;
            }
        }



        // ä¸­è—¥åº«ç®¡ç†åŠŸèƒ½
        let editingHerbId = null;
        let editingFormulaId = null;
        let currentHerbFilter = 'all';
        
        async function loadHerbLibrary() {
            // é€²å…¥ä¸­è—¥åº«é é¢æ™‚å…ˆå¾ Firestore é‡æ–°è¼‰å…¥è³‡æ–™
            if (typeof initHerbLibrary === 'function') {
                await initHerbLibrary();
            }
            displayHerbLibrary();
            
            // æœå°‹åŠŸèƒ½
            const searchInput = document.getElementById('searchHerb');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    displayHerbLibrary();
                });
            }
        }
        
        function filterHerbLibrary(type) {
            currentHerbFilter = type;
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                btn.className = 'px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200';
            });
            document.getElementById(`filter-${type}`).className = 'px-4 py-2 rounded-lg text-sm font-medium bg-blue-100 text-blue-800 transition duration-200';
            
            displayHerbLibrary();
        }
        
        function displayHerbLibrary() {
            const searchTerm = document.getElementById('searchHerb').value.toLowerCase();
            const listContainer = document.getElementById('herbLibraryList');
            
            // éæ¿¾è³‡æ–™
            let filteredItems = herbLibrary.filter(item => {
                const matchesSearch = item.name.toLowerCase().includes(searchTerm) ||
                                    (item.alias && item.alias.toLowerCase().includes(searchTerm)) ||
                                    (item.effects && item.effects.toLowerCase().includes(searchTerm));
                
                const matchesFilter = currentHerbFilter === 'all' || item.type === currentHerbFilter;
                
                return matchesSearch && matchesFilter;
            });
            
            if (filteredItems.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-4xl mb-4">ğŸŒ¿</div>
                        <div class="text-lg font-medium mb-2">æ²’æœ‰æ‰¾åˆ°ç›¸é—œè³‡æ–™</div>
                        <div class="text-sm">è«‹å˜—è©¦å…¶ä»–æœå°‹æ¢ä»¶æˆ–æ–°å¢ä¸­è—¥æ/æ–¹åŠ‘</div>
                    </div>
                `;
                return;
            }
            
            // æŒ‰é¡å‹åˆ†çµ„é¡¯ç¤º
            const herbs = filteredItems.filter(item => item.type === 'herb');
            const formulas = filteredItems.filter(item => item.type === 'formula');
            
            let html = '';
            
            if (herbs.length > 0 && (currentHerbFilter === 'all' || currentHerbFilter === 'herb')) {
                html += `
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="mr-2">ğŸŒ¿</span>ä¸­è—¥æ (${herbs.length})
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${herbs.map(herb => createHerbCard(herb)).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (formulas.length > 0 && (currentHerbFilter === 'all' || currentHerbFilter === 'formula')) {
                html += `
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="mr-2">ğŸ“‹</span>æ–¹åŠ‘ (${formulas.length})
                        </h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            ${formulas.map(formula => createFormulaCard(formula)).join('')}
                        </div>
                    </div>
                `;
            }
            
            listContainer.innerHTML = html;
        }
        
        function createHerbCard(herb) {
            return `
                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition duration-200">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900">${herb.name}</h4>
                            ${herb.alias ? `<p class="text-sm text-gray-600">${herb.alias}</p>` : ''}
                        </div>
                        <div class="flex space-x-1">
                            <button onclick="editHerb(${herb.id})" class="text-blue-600 hover:text-blue-800 text-sm">ç·¨è¼¯</button>
                            <button onclick="deleteHerbItem(${herb.id})" class="text-red-600 hover:text-red-800 text-sm">åˆªé™¤</button>
                        </div>
                    </div>
                    
                    <div class="space-y-2 text-sm">
                        ${herb.nature ? `<div><span class="font-medium text-gray-700">æ€§å‘³ï¼š</span>${herb.nature}</div>` : ''}
                        ${herb.meridian ? `<div><span class="font-medium text-gray-700">æ­¸ç¶“ï¼š</span>${herb.meridian}</div>` : ''}
                        ${herb.effects ? `<div><span class="font-medium text-gray-700">åŠŸæ•ˆï¼š</span>${herb.effects}</div>` : ''}
                        ${herb.dosage ? `<div><span class="font-medium text-gray-700">åŠ‘é‡ï¼š</span><span class="text-blue-600 font-medium">${herb.dosage}</span></div>` : ''}
                        ${herb.cautions ? `<div><span class="font-medium text-red-600">æ³¨æ„ï¼š</span><span class="text-red-700">${herb.cautions}</span></div>` : ''}
                    </div>
                </div>
            `;
        }
        
        function createFormulaCard(formula) {
            return `
                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition duration-200">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900">${formula.name}</h4>
                            ${formula.source ? `<p class="text-sm text-gray-600">å‡ºè™•ï¼š${formula.source}</p>` : ''}
                        </div>
                        <div class="flex space-x-1">
                            <button onclick="editFormula(${formula.id})" class="text-blue-600 hover:text-blue-800 text-sm">ç·¨è¼¯</button>
                            <button onclick="deleteHerbItem(${formula.id})" class="text-red-600 hover:text-red-800 text-sm">åˆªé™¤</button>
                        </div>
                    </div>
                    
                    <div class="space-y-3 text-sm">
                        ${formula.effects ? `<div><span class="font-medium text-gray-700">åŠŸæ•ˆï¼š</span>${formula.effects}</div>` : ''}
                        ${formula.indications ? `<div><span class="font-medium text-gray-700">ä¸»æ²»ï¼š</span>${formula.indications}</div>` : ''}
                        ${formula.composition ? `
                            <div>
                                <span class="font-medium text-gray-700">çµ„æˆï¼š</span>
                                <div class="mt-1 p-2 bg-yellow-50 rounded text-xs whitespace-pre-line border-l-2 border-yellow-400">${formula.composition}</div>
                            </div>
                        ` : ''}
                        ${formula.usage ? `<div><span class="font-medium text-gray-700">ç”¨æ³•ï¼š</span>${formula.usage}</div>` : ''}
                        ${formula.cautions ? `<div><span class="font-medium text-red-600">æ³¨æ„ï¼š</span><span class="text-red-700">${formula.cautions}</span></div>` : ''}
                    </div>
                </div>
            `;
        }
        
        // ä¸­è—¥æè¡¨å–®åŠŸèƒ½
        function showAddHerbForm() {
            editingHerbId = null;
            document.getElementById('herbFormTitle').textContent = 'æ–°å¢ä¸­è—¥æ';
            document.getElementById('herbSaveButtonText').textContent = 'å„²å­˜';
            clearHerbForm();
            document.getElementById('addHerbModal').classList.remove('hidden');
        }
        
        function hideAddHerbForm() {
            document.getElementById('addHerbModal').classList.add('hidden');
            clearHerbForm();
            editingHerbId = null;
        }
        
        function clearHerbForm() {
            ['herbName', 'herbAlias', 'herbNature', 'herbMeridian', 'herbEffects', 'herbIndications', 'herbDosage', 'herbCautions'].forEach(id => {
                document.getElementById(id).value = '';
            });
        }
        
        function editHerb(id) {
            const herb = herbLibrary.find(item => item.id === id && item.type === 'herb');
            if (!herb) return;
            
            editingHerbId = id;
            document.getElementById('herbFormTitle').textContent = 'ç·¨è¼¯ä¸­è—¥æ';
            document.getElementById('herbSaveButtonText').textContent = 'æ›´æ–°';
            
            document.getElementById('herbName').value = herb.name || '';
            document.getElementById('herbAlias').value = herb.alias || '';
            document.getElementById('herbNature').value = herb.nature || '';
            document.getElementById('herbMeridian').value = herb.meridian || '';
            document.getElementById('herbEffects').value = herb.effects || '';
            document.getElementById('herbIndications').value = herb.indications || '';
            document.getElementById('herbDosage').value = herb.dosage || '';
            document.getElementById('herbCautions').value = herb.cautions || '';
            
            document.getElementById('addHerbModal').classList.remove('hidden');
        }
        
        async function saveHerb() {
            const name = document.getElementById('herbName').value.trim();
            
            if (!name) {
                showToast('è«‹è¼¸å…¥ä¸­è—¥æåç¨±ï¼', 'error');
                return;
            }
            
            const herb = {
                id: editingHerbId || Date.now(),
                type: 'herb',
                name: name,
                alias: document.getElementById('herbAlias').value.trim(),
                nature: document.getElementById('herbNature').value.trim(),
                meridian: document.getElementById('herbMeridian').value.trim(),
                effects: document.getElementById('herbEffects').value.trim(),
                indications: document.getElementById('herbIndications').value.trim(),
                dosage: document.getElementById('herbDosage').value.trim(),
                cautions: document.getElementById('herbCautions').value.trim(),
                createdAt: editingHerbId ? herbLibrary.find(h => h.id === editingHerbId).createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (editingHerbId) {
                const index = herbLibrary.findIndex(item => item.id === editingHerbId);
                herbLibrary[index] = herb;
                showToast('ä¸­è—¥æè³‡æ–™å·²æ›´æ–°ï¼', 'success');
            } else {
                herbLibrary.push(herb);
                showToast('ä¸­è—¥æå·²æ–°å¢ï¼', 'success');
            }
            
            try {
                // å°‡ä¸­è—¥æè³‡æ–™å¯«å…¥ Firestore
                await window.firebase.setDoc(
                    window.firebase.doc(window.firebase.db, 'herbLibrary', String(herb.id)),
                    herb
                );
            } catch (error) {
                console.error('å„²å­˜ä¸­è—¥æè³‡æ–™è‡³ Firestore å¤±æ•—:', error);
            }
            hideAddHerbForm();
            displayHerbLibrary();
        }
        
        // æ–¹åŠ‘è¡¨å–®åŠŸèƒ½
        function showAddFormulaForm() {
            editingFormulaId = null;
            document.getElementById('formulaFormTitle').textContent = 'æ–°å¢æ–¹åŠ‘';
            document.getElementById('formulaSaveButtonText').textContent = 'å„²å­˜';
            clearFormulaForm();
            document.getElementById('addFormulaModal').classList.remove('hidden');
        }
        
        function hideAddFormulaForm() {
            document.getElementById('addFormulaModal').classList.add('hidden');
            clearFormulaForm();
            editingFormulaId = null;
        }
        
        function clearFormulaForm() {
            ['formulaName', 'formulaSource', 'formulaEffects', 'formulaIndications', 'formulaComposition', 'formulaUsage', 'formulaCautions'].forEach(id => {
                document.getElementById(id).value = '';
            });
        }
        
        function editFormula(id) {
            const formula = herbLibrary.find(item => item.id === id && item.type === 'formula');
            if (!formula) return;
            
            editingFormulaId = id;
            document.getElementById('formulaFormTitle').textContent = 'ç·¨è¼¯æ–¹åŠ‘';
            document.getElementById('formulaSaveButtonText').textContent = 'æ›´æ–°';
            
            document.getElementById('formulaName').value = formula.name || '';
            document.getElementById('formulaSource').value = formula.source || '';
            document.getElementById('formulaEffects').value = formula.effects || '';
            document.getElementById('formulaIndications').value = formula.indications || '';
            document.getElementById('formulaComposition').value = formula.composition || '';
            document.getElementById('formulaUsage').value = formula.usage || '';
            document.getElementById('formulaCautions').value = formula.cautions || '';
            
            document.getElementById('addFormulaModal').classList.remove('hidden');
        }
        
        async function saveFormula() {
            const name = document.getElementById('formulaName').value.trim();
            const composition = document.getElementById('formulaComposition').value.trim();
            
            if (!name) {
                showToast('è«‹è¼¸å…¥æ–¹åŠ‘åç¨±ï¼', 'error');
                return;
            }
            
            if (!composition) {
                showToast('è«‹è¼¸å…¥æ–¹åŠ‘çµ„æˆï¼', 'error');
                return;
            }
            
            const formula = {
                id: editingFormulaId || Date.now(),
                type: 'formula',
                name: name,
                source: document.getElementById('formulaSource').value.trim(),
                effects: document.getElementById('formulaEffects').value.trim(),
                indications: document.getElementById('formulaIndications').value.trim(),
                composition: composition,
                usage: document.getElementById('formulaUsage').value.trim(),
                cautions: document.getElementById('formulaCautions').value.trim(),
                createdAt: editingFormulaId ? herbLibrary.find(f => f.id === editingFormulaId).createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (editingFormulaId) {
                const index = herbLibrary.findIndex(item => item.id === editingFormulaId);
                herbLibrary[index] = formula;
                showToast('æ–¹åŠ‘è³‡æ–™å·²æ›´æ–°ï¼', 'success');
            } else {
                herbLibrary.push(formula);
                showToast('æ–¹åŠ‘å·²æ–°å¢ï¼', 'success');
            }
            
            try {
                // å°‡æ–¹åŠ‘è³‡æ–™å¯«å…¥ Firestore
                await window.firebase.setDoc(
                    window.firebase.doc(window.firebase.db, 'herbLibrary', String(formula.id)),
                    formula
                );
            } catch (error) {
                console.error('å„²å­˜æ–¹åŠ‘è³‡æ–™è‡³ Firestore å¤±æ•—:', error);
            }
            hideAddFormulaForm();
            displayHerbLibrary();
        }
        
        // åˆªé™¤ä¸­è—¥ææˆ–æ–¹åŠ‘
        async function deleteHerbItem(id) {
            const item = herbLibrary.find(h => h.id === id);
            if (!item) return;
            
            const itemType = item.type === 'herb' ? 'ä¸­è—¥æ' : 'æ–¹åŠ‘';
            
            if (confirm(`ç¢ºå®šè¦åˆªé™¤${itemType}ã€Œ${item.name}ã€å—ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) {
                herbLibrary = herbLibrary.filter(h => h.id !== id);
                try {
                    await window.firebase.deleteDoc(
                        window.firebase.doc(window.firebase.db, 'herbLibrary', String(id))
                    );
                } catch (error) {
                    console.error('åˆªé™¤ä¸­è—¥æè³‡æ–™è‡³ Firestore å¤±æ•—:', error);
                }
                showToast(`${itemType}ã€Œ${item.name}ã€å·²åˆªé™¤ï¼`, 'success');
                displayHerbLibrary();
            }
        }

        // æ”¶è²»é …ç›®ç®¡ç†åŠŸèƒ½
        let editingBillingItemId = null;
        let currentBillingFilter = 'all';
        
        async function loadBillingManagement() {
            // é€²å…¥æ”¶è²»é …ç›®ç®¡ç†é é¢æ™‚å…ˆå¾ Firestore é‡æ–°è¼‰å…¥è³‡æ–™
            if (typeof initBillingItems === 'function') {
                await initBillingItems();
            }
            displayBillingItems();
            
            // æœå°‹åŠŸèƒ½
            const searchInput = document.getElementById('searchBilling');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    displayBillingItems();
                });
            }
        }
        
        function filterBillingItems(category) {
            currentBillingFilter = category;
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('[id^="billing-filter-"]').forEach(btn => {
                btn.className = 'px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200';
            });
            document.getElementById(`billing-filter-${category}`).className = 'px-4 py-2 rounded-lg text-sm font-medium bg-blue-100 text-blue-800 transition duration-200';
            
            displayBillingItems();
        }
        
        function displayBillingItems() {
            const searchTerm = document.getElementById('searchBilling').value.toLowerCase();
            const listContainer = document.getElementById('billingItemsList');
            
            // éæ¿¾è³‡æ–™
            let filteredItems = billingItems.filter(item => {
                const matchesSearch = item.name.toLowerCase().includes(searchTerm) ||
                                    (item.description && item.description.toLowerCase().includes(searchTerm));
                
                const matchesFilter = currentBillingFilter === 'all' || item.category === currentBillingFilter;
                
                return matchesSearch && matchesFilter;
            });
            
            if (filteredItems.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-4xl mb-4">ğŸ’°</div>
                        <div class="text-lg font-medium mb-2">æ²’æœ‰æ‰¾åˆ°ç›¸é—œæ”¶è²»é …ç›®</div>
                        <div class="text-sm">è«‹å˜—è©¦å…¶ä»–æœå°‹æ¢ä»¶æˆ–æ–°å¢æ”¶è²»é …ç›®</div>
                    </div>
                `;
                return;
            }
            
            // æŒ‰é¡åˆ¥åˆ†çµ„é¡¯ç¤º
            const categories = {
                consultation: { name: 'è¨ºç™‚è²»', icon: 'ğŸ©º', items: [] },
                medicine: { name: 'è—¥è²»', icon: 'ğŸ’Š', items: [] },
                treatment: { name: 'æ²»ç™‚è²»', icon: 'ğŸ”§', items: [] },
                other: { name: 'å…¶ä»–', icon: 'ğŸ“‹', items: [] },
                discount: { name: 'æŠ˜æ‰£é …ç›®', icon: 'ğŸ’¸', items: [] },
                package: { name: 'å¥—ç¥¨é …ç›®', icon: 'ğŸ«', items: [] }
            };
            
            filteredItems.forEach(item => {
                if (categories[item.category]) {
                    categories[item.category].items.push(item);
                }
            });
            
            let html = '';
            
            Object.keys(categories).forEach(categoryKey => {
                const category = categories[categoryKey];
                if (category.items.length > 0 && (currentBillingFilter === 'all' || currentBillingFilter === categoryKey)) {
                    html += `
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="mr-2">${category.icon}</span>${category.name} (${category.items.length})
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${category.items.map(item => createBillingItemCard(item)).join('')}
                            </div>
                        </div>
                    `;
                }
            });
            
            listContainer.innerHTML = html;
        }
        
        function createBillingItemCard(item) {
            const statusClass = item.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
            const statusText = item.active ? 'å•Ÿç”¨' : 'åœç”¨';
            
            // æŠ˜æ‰£é …ç›®ä½¿ç”¨ä¸åŒçš„é¡è‰²é¡¯ç¤º
            const priceColor = item.category === 'discount' ? 'text-red-600' : 'text-green-600';
            let pricePrefix = '$';
            let displayPrice = Math.abs(item.price);
            
            // è™•ç†æŠ˜æ‰£é …ç›®çš„é¡¯ç¤º
            if (item.category === 'discount') {
                if (item.price > 0 && item.price < 1) {
                    // ç™¾åˆ†æ¯”æŠ˜æ‰£ (0.9 = 9æŠ˜)
                    pricePrefix = '';
                    displayPrice = (item.price * 10).toFixed(0);
                } else if (item.price < 0) {
                    // å›ºå®šé‡‘é¡æŠ˜æ‰£
                    pricePrefix = '-$';
                    displayPrice = Math.abs(item.price);
                }
            }
            
            return `
                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition duration-200 ${!item.active ? 'opacity-75' : ''}">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h4 class="text-lg font-semibold text-gray-900">${item.name}</h4>
                            <div class="flex items-center mt-1">
                                <span class="text-2xl font-bold text-green-600">$${Math.abs(item.price)}</span>
                                ${item.unit ? `<span class="text-sm text-gray-500 ml-1">/ ${item.unit}</span>` : ''}
                            </div>
                        </div>
                        <div class="flex flex-col items-end space-y-2">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                                ${statusText}
                            </span>
                            <div class="flex space-x-1">
                                <button onclick="editBillingItem(${item.id})" class="text-blue-600 hover:text-blue-800 text-sm">ç·¨è¼¯</button>
                                <button onclick="deleteBillingItem(${item.id})" class="text-red-600 hover:text-red-800 text-sm">åˆªé™¤</button>
                            </div>
                        </div>
                    </div>
                    
                    ${item.description ? `
                        <div class="text-sm text-gray-600 bg-gray-50 p-2 rounded">
                            ${item.description}
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        // æ”¶è²»é …ç›®è¡¨å–®åŠŸèƒ½
        function showAddBillingItemForm() {
            editingBillingItemId = null;
            document.getElementById('billingItemFormTitle').textContent = 'æ–°å¢æ”¶è²»é …ç›®';
            document.getElementById('billingItemSaveButtonText').textContent = 'å„²å­˜';
            clearBillingItemForm();
            document.getElementById('addBillingItemModal').classList.remove('hidden');
        }
        
        function hideAddBillingItemForm() {
            document.getElementById('addBillingItemModal').classList.add('hidden');
            clearBillingItemForm();
            editingBillingItemId = null;
        }
        
        function clearBillingItemForm() {
            document.getElementById('billingItemPackageUses').value = '';
            document.getElementById('billingItemValidityDays').value = '';
            var pf = document.getElementById('packageFields'); if (pf) pf.classList.add('hidden');
            document.getElementById('billingItemName').value = '';
            document.getElementById('billingItemCategory').value = '';
            document.getElementById('billingItemPrice').value = '';
            document.getElementById('billingItemUnit').value = '';
            document.getElementById('billingItemDescription').value = '';
            document.getElementById('billingItemActive').checked = true;
        }
        
        function editBillingItem(id) {
            const item = billingItems.find(b => b.id === id);
            if (!item) return;
            
            editingBillingItemId = id;
            document.getElementById('billingItemFormTitle').textContent = 'ç·¨è¼¯æ”¶è²»é …ç›®';
            document.getElementById('billingItemSaveButtonText').textContent = 'æ›´æ–°';
            
            document.getElementById('billingItemName').value = item.name || '';
            document.getElementById('billingItemCategory').value = item.category || '';
            document.getElementById('billingItemPrice').value = item.price || '';
            document.getElementById('billingItemUnit').value = item.unit || '';
            document.getElementById('billingItemDescription').value = item.description || '';
            document.getElementById('billingItemActive').checked = item.active !== false;
            document.getElementById('billingItemPackageUses').value = item.packageUses || '';
            document.getElementById('billingItemValidityDays').value = item.validityDays || '';
            {
                const pf = document.getElementById('packageFields');
                if (pf) pf.classList.toggle('hidden', item.category !== 'package');
            }
            
            document.getElementById('addBillingItemModal').classList.remove('hidden');
        }
        
        async function saveBillingItem() {
            const name = document.getElementById('billingItemName').value.trim();
            const category = document.getElementById('billingItemCategory').value;
            let price = parseFloat(document.getElementById('billingItemPrice').value);

            let packageUses = null;
            let validityDays = null;
            if (category === 'package') {
                packageUses = parseInt(document.getElementById('billingItemPackageUses').value);
                validityDays = parseInt(document.getElementById('billingItemValidityDays').value);
                if (!packageUses || packageUses <= 0) {
                    showToast('è«‹è¼¸å…¥å¥—ç¥¨å¯ç”¨æ¬¡æ•¸ï¼', 'error');
                    return;
                }
                if (!validityDays || validityDays <= 0) {
                    showToast('è«‹è¼¸å…¥æœ‰æ•ˆå¤©æ•¸ï¼', 'error');
                    return;
                }
            }
            
            if (!name) {
                showToast('è«‹è¼¸å…¥æ”¶è²»é …ç›®åç¨±ï¼', 'error');
                return;
            }
            
            if (!category) {
                showToast('è«‹é¸æ“‡é …ç›®é¡åˆ¥ï¼', 'error');
                return;
            }
            
            if (isNaN(price)) {
                showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ”¶è²»é‡‘é¡ï¼', 'error');
                return;
            }
            
            // æŠ˜æ‰£é …ç›®å…è¨±è² æ•¸æˆ–0-1ä¹‹é–“çš„å°æ•¸ï¼ˆç™¾åˆ†æ¯”ï¼‰ï¼Œå…¶ä»–é …ç›®ä¸å…è¨±è² æ•¸
            if (category !== 'discount' && price < 0) {
                showToast('é™¤æŠ˜æ‰£é …ç›®å¤–ï¼Œæ”¶è²»é‡‘é¡ä¸èƒ½ç‚ºè² æ•¸ï¼', 'error');
                return;
            }
            
            // æŠ˜æ‰£é …ç›®çš„ç‰¹æ®Šé©—è­‰
            if (category === 'discount') {
                if (price > 0 && price >= 1 && price <= 10) {
                    // å¦‚æœè¼¸å…¥1-10ä¹‹é–“çš„æ•¸å­—ï¼Œè‡ªå‹•è½‰æ›ç‚ºæŠ˜æ‰£æ¯”ä¾‹
                    price = price / 10;
                    document.getElementById('billingItemPrice').value = price;
                    showToast(`å·²è‡ªå‹•è½‰æ›ç‚º${(price * 100).toFixed(0)}æŠ˜`, 'info');
                }
            }
            
            const item = {
                id: editingBillingItemId || Date.now(),
                name: name,
                category: category,
                price: price,
                unit: document.getElementById('billingItemUnit').value.trim(),
                description: document.getElementById('billingItemDescription').value.trim(),
                packageUses: packageUses,
                validityDays: validityDays,
                active: document.getElementById('billingItemActive').checked,
                createdAt: editingBillingItemId ? billingItems.find(b => b.id === editingBillingItemId).createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (editingBillingItemId) {
                const index = billingItems.findIndex(b => b.id === editingBillingItemId);
                billingItems[index] = item;
                showToast('æ”¶è²»é …ç›®å·²æ›´æ–°ï¼', 'success');
            } else {
                billingItems.push(item);
                showToast('æ”¶è²»é …ç›®å·²æ–°å¢ï¼', 'success');
            }
            
            try {
                // å°‡æ”¶è²»é …ç›®å¯«å…¥ Firestore
                await window.firebase.setDoc(
                    window.firebase.doc(window.firebase.db, 'billingItems', String(item.id)),
                    item
                );
            } catch (error) {
                console.error('å„²å­˜æ”¶è²»é …ç›®è‡³ Firestore å¤±æ•—:', error);
            }
            hideAddBillingItemForm();
            displayBillingItems();
        }
        
        async function deleteBillingItem(id) {
            const item = billingItems.find(b => b.id === id);
            if (!item) return;
            
            if (confirm(`ç¢ºå®šè¦åˆªé™¤æ”¶è²»é …ç›®ã€Œ${item.name}ã€å—ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) {
                billingItems = billingItems.filter(b => b.id !== id);
                try {
                    await window.firebase.deleteDoc(
                        window.firebase.doc(window.firebase.db, 'billingItems', String(id))
                    );
                } catch (error) {
                    console.error('åˆªé™¤æ”¶è²»é …ç›®è³‡æ–™è‡³ Firestore å¤±æ•—:', error);
                }
                showToast(`æ”¶è²»é …ç›®ã€Œ${item.name}ã€å·²åˆªé™¤ï¼`, 'success');
                displayBillingItems();
            }
        }

        // è™•æ–¹æœç´¢åŠŸèƒ½
        function searchHerbsForPrescription() {
            const searchTerm = document.getElementById('prescriptionSearch').value.trim().toLowerCase();
            const resultsContainer = document.getElementById('prescriptionSearchResults');
            const resultsList = document.getElementById('prescriptionSearchList');
            
            if (searchTerm.length < 1) {
                resultsContainer.classList.add('hidden');
                return;
            }
            
            // æœç´¢åŒ¹é…çš„ä¸­è—¥æå’Œæ–¹åŠ‘
            const matchedItems = herbLibrary.filter(item => 
                item.name.toLowerCase().includes(searchTerm) ||
                (item.alias && item.alias.toLowerCase().includes(searchTerm)) ||
                (item.effects && item.effects.toLowerCase().includes(searchTerm))
            ).slice(0, 10); // é™åˆ¶é¡¯ç¤ºå‰10å€‹çµæœ
            
            if (matchedItems.length === 0) {
                resultsList.innerHTML = `
                    <div class="p-3 text-center text-gray-500 text-sm">
                        æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„ä¸­è—¥ææˆ–æ–¹åŠ‘
                    </div>
                `;
                resultsContainer.classList.remove('hidden');
                return;
            }
            
            // é¡¯ç¤ºæœç´¢çµæœ
            resultsList.innerHTML = matchedItems.map(item => {
                const typeName = item.type === 'herb' ? 'ä¸­è—¥æ' : 'æ–¹åŠ‘';
                const bgColor = 'bg-yellow-50 hover:bg-yellow-100 border-yellow-200';
                
                return `
                    <div class="p-3 ${bgColor} border rounded-lg cursor-pointer transition duration-200" onclick="addToPrescription('${item.type}', ${item.id})">
                        <div class="text-center">
                            <div class="font-semibold text-gray-900 text-sm mb-1">${item.name}</div>
                            <div class="text-xs bg-white text-gray-600 px-2 py-1 rounded mb-2">${typeName}</div>
                            ${item.type === 'herb' && item.dosage ? `<div class="text-xs text-yellow-600 font-medium">${item.dosage}</div>` : ''}
                            ${item.effects ? `<div class="text-xs text-gray-600 mt-1">${item.effects.substring(0, 30)}${item.effects.length > 30 ? '...' : ''}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            resultsContainer.classList.remove('hidden');
        }
        
        // å­˜å„²å·²é¸æ“‡çš„è™•æ–¹é …ç›®
        let selectedPrescriptionItems = [];
        
        // å­˜å„²å·²é¸æ“‡çš„æ”¶è²»é …ç›®
        let selectedBillingItems = [];
        
        // æ·»åŠ åˆ°è™•æ–¹å…§å®¹
        function addToPrescription(type, itemId) {
            const item = herbLibrary.find(h => h.id === itemId);
            if (!item) return;
            
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“æ·»åŠ é
            const existingIndex = selectedPrescriptionItems.findIndex(p => p.id === itemId);
            if (existingIndex !== -1) {
                showToast(`${item.name} å·²ç¶“åœ¨è™•æ–¹ä¸­ï¼`, 'warning');
                return;
            }
            
            // æ·»åŠ åˆ°å·²é¸æ“‡é …ç›®
            const prescriptionItem = {
                id: itemId,
                type: type,
                name: item.name,
                dosage: type === 'herb' ? (item.dosage || '6g') : null,
                customDosage: '6', // ä¸­è—¥æå’Œæ–¹åŠ‘éƒ½é è¨­6å…‹
                composition: type === 'formula' ? item.composition : null,
                effects: item.effects
            };
            
            selectedPrescriptionItems.push(prescriptionItem);
            
            // æ›´æ–°é¡¯ç¤º
            updatePrescriptionDisplay();
            
            // å¦‚æœæ˜¯ç¬¬ä¸€å€‹è™•æ–¹é …ç›®ï¼Œè‡ªå‹•æ·»åŠ è—¥è²»
            if (selectedPrescriptionItems.length === 1) {
                const days = parseInt(document.getElementById('medicationDays').value) || 5;
                updateMedicineFeeByDays(days);
            }
            
            // æ¸…é™¤æœç´¢
            clearPrescriptionSearch();
            
            showToast(`å·²æ·»åŠ ${type === 'herb' ? 'ä¸­è—¥æ' : 'æ–¹åŠ‘'}ï¼š${item.name}`, 'success');
        }
        

        
        // æ›´æ–°è™•æ–¹é¡¯ç¤º
        function updatePrescriptionDisplay() {
            const container = document.getElementById('selectedPrescriptionItems');
            const hiddenTextarea = document.getElementById('formPrescription');
            const medicationSettings = document.getElementById('medicationSettings');
            
            if (selectedPrescriptionItems.length === 0) {
                container.innerHTML = `
                    <div class="text-sm text-gray-500 text-center py-4">
                        è«‹ä½¿ç”¨ä¸Šæ–¹æœç´¢åŠŸèƒ½æ·»åŠ ä¸­è—¥ææˆ–æ–¹åŠ‘
                    </div>
                `;
                hiddenTextarea.value = '';
                // éš±è—æœè—¥å¤©æ•¸è¨­å®š
                medicationSettings.style.display = 'none';
                return;
            }
            
            // é¡¯ç¤ºæœè—¥å¤©æ•¸è¨­å®š
            medicationSettings.style.display = 'block';
            
            // é¡¯ç¤ºå·²æ·»åŠ çš„é …ç›®
            const displayHtml = `
                <div class="space-y-3">
                    ${selectedPrescriptionItems.map((item, index) => {
                        const bgColor = 'bg-yellow-50 border-yellow-200';
                        
                        return `
                            <div class="${bgColor} border rounded-lg p-3">
                                <div class="flex items-center">
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900">${item.name}</div>
                                        ${item.type === 'formula' ? `<div class="text-xs text-gray-600">æ–¹åŠ‘</div>` : ''}
                                    </div>
                                    <div class="flex items-center space-x-2 mr-3">
                                        <input type="number" 
                                               value="${item.customDosage || '6'}" 
                                               min="0.5" 
                                               max="100" 
                                               step="0.5"
                                               class="w-16 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-yellow-500 focus:border-transparent text-center"
                                               onchange="updatePrescriptionDosage(${index}, this.value)"
                                               onclick="this.select()">
                                        <span class="text-sm text-gray-600 font-medium">g</span>
                                    </div>
                                    <button onclick="removePrescriptionItem(${index})" class="text-red-500 hover:text-red-700 font-bold text-lg px-2">Ã—</button>
                                </div>
                                
                                ${item.type === 'formula' && item.composition ? `
                                    <div class="mt-3 pt-3 border-t border-yellow-200">
                                        <div class="text-xs font-semibold text-gray-700 mb-2">æ–¹åŠ‘çµ„æˆï¼š</div>
                                        <div class="text-xs text-gray-600 bg-white rounded px-3 py-2 border border-yellow-100">
                                            ${item.composition.replace(/\n/g, 'ã€')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            container.innerHTML = displayHtml;
            
            // æ›´æ–°éš±è—çš„æ–‡æœ¬åŸŸ
            let prescriptionText = '';
            
            selectedPrescriptionItems.forEach(item => {
                if (item.type === 'herb') {
                    const dosage = item.customDosage || '6';
                    prescriptionText += `${item.name} ${dosage}g\n`;
                } else if (item.type === 'formula') {
                    const dosage = item.customDosage || '6';
                    prescriptionText += `${item.name} ${dosage}g\n`;
                    if (item.composition) {
                        prescriptionText += `${item.composition.replace(/\n/g, 'ã€')}\n`;
                    }
                    prescriptionText += '\n';
                }
            });
            
            hiddenTextarea.value = prescriptionText.trim();
        }
        
        // æ›´æ–°æœè—¥å¤©æ•¸
        function updateMedicationDays(change) {
            const daysInput = document.getElementById('medicationDays');
            const currentDays = parseInt(daysInput.value) || 5;
            const newDays = Math.max(1, Math.min(30, currentDays + change));
            daysInput.value = newDays;
            
            // æ›´æ–°è™•æ–¹é¡¯ç¤º
            if (selectedPrescriptionItems.length > 0) {
                updatePrescriptionDisplay();
            }
            
            // è‡ªå‹•æ›´æ–°è—¥è²»
            updateMedicineFeeByDays(newDays);
        }
        
        // æ›´æ–°æœè—¥æ¬¡æ•¸
        function updateMedicationFrequency(change) {
            const frequencyInput = document.getElementById('medicationFrequency');
            const currentFrequency = parseInt(frequencyInput.value) || 2;
            const newFrequency = Math.max(1, Math.min(6, currentFrequency + change));
            frequencyInput.value = newFrequency;
            
            // æ›´æ–°è™•æ–¹é¡¯ç¤º
            if (selectedPrescriptionItems.length > 0) {
                updatePrescriptionDisplay();
            }
        }
        
        // æ ¹æ“šé–‹è—¥å¤©æ•¸è‡ªå‹•æ›´æ–°è—¥è²»
        function updateMedicineFeeByDays(days) {
            // åªæœ‰åœ¨æœ‰è™•æ–¹å…§å®¹æ™‚æ‰è‡ªå‹•æ›´æ–°è—¥è²»
            if (selectedPrescriptionItems.length === 0) {
                return;
            }
            
            // å°‹æ‰¾ä¸­è—¥èª¿åŠ‘è²»é …ç›®
            const medicineFeeItem = billingItems.find(item => 
                item.active && 
                item.category === 'medicine' && 
                (item.name.includes('ä¸­è—¥') || item.name.includes('è—¥è²»') || item.name.includes('èª¿åŠ‘'))
            );
            
            if (!medicineFeeItem) {
                return; // å¦‚æœæ²’æœ‰æ‰¾åˆ°è—¥è²»é …ç›®ï¼Œä¸é€²è¡Œè‡ªå‹•æ›´æ–°
            }
            
            // æŸ¥æ‰¾ç¾æœ‰çš„è—¥è²»é …ç›®
            const existingMedicineFeeIndex = selectedBillingItems.findIndex(item => 
                item.id === medicineFeeItem.id
            );
            
            if (existingMedicineFeeIndex !== -1) {
                // æ›´æ–°ç¾æœ‰è—¥è²»é …ç›®çš„æ•¸é‡ç‚ºå¤©æ•¸
                selectedBillingItems[existingMedicineFeeIndex].quantity = days;
                updateBillingDisplay();
                showToast(`å·²æ›´æ–°è—¥è²»ï¼š${medicineFeeItem.name} x${days}å¤©`, 'info');
            } else {
                // å¦‚æœæ²’æœ‰è—¥è²»é …ç›®ï¼Œè‡ªå‹•æ·»åŠ 
                const billingItem = {
                    id: medicineFeeItem.id,
                    name: medicineFeeItem.name,
                    category: medicineFeeItem.category,
                    price: medicineFeeItem.price,
                    unit: medicineFeeItem.unit,
                    description: medicineFeeItem.description,
                    quantity: days
                };
                
                selectedBillingItems.push(billingItem);
                updateBillingDisplay();
                showToast(`å·²è‡ªå‹•æ·»åŠ è—¥è²»ï¼š${medicineFeeItem.name} x${days}å¤©`, 'info');
            }
        }
        
        // è™•ç†å¤©æ•¸è¼¸å…¥æ¡†ç›´æ¥è®Šæ›´
        function updateMedicationDaysFromInput() {
            const daysInput = document.getElementById('medicationDays');
            const days = parseInt(daysInput.value) || 5;
            
            // ç¢ºä¿å¤©æ•¸åœ¨æœ‰æ•ˆç¯„åœå…§
            const validDays = Math.max(1, Math.min(30, days));
            if (validDays !== days) {
                daysInput.value = validDays;
            }
            
            // æ›´æ–°è™•æ–¹é¡¯ç¤º
            if (selectedPrescriptionItems.length > 0) {
                updatePrescriptionDisplay();
            }
            
            // è‡ªå‹•æ›´æ–°è—¥è²»
            updateMedicineFeeByDays(validDays);
        }
        
        // æ›´æ–°ä¼‘æ¯æœŸé–“é¡¯ç¤º
        function updateRestPeriod() {
            const startDateInput = document.getElementById('formRestStartDate');
            const endDateInput = document.getElementById('formRestEndDate');
            const displaySpan = document.getElementById('restPeriodDisplay');
            
            if (!startDateInput || !endDateInput || !displaySpan) return;
            
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            
            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                if (end >= start) {
                    const timeDiff = end.getTime() - start.getTime();
                    const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1; // åŒ…å«é–‹å§‹å’ŒçµæŸæ—¥æœŸ
                    displaySpan.textContent = `å…± ${daysDiff} å¤©`;
                    displaySpan.className = 'text-sm text-blue-600 font-medium';
                } else {
                    displaySpan.textContent = 'çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸ';
                    displaySpan.className = 'text-sm text-red-600 font-medium';
                }
            } else {
                displaySpan.textContent = 'è«‹é¸æ“‡é–‹å§‹å’ŒçµæŸæ—¥æœŸ';
                displaySpan.className = 'text-sm text-gray-500 font-medium';
            }
        }
        

        
        // æ›´æ–°è™•æ–¹è—¥é‡
        function updatePrescriptionDosage(index, newDosage) {
            if (index >= 0 && index < selectedPrescriptionItems.length) {
                const dosage = parseFloat(newDosage);
                if (dosage > 0 && dosage <= 100) {
                    selectedPrescriptionItems[index].customDosage = newDosage;
                    // é‡æ–°ç”Ÿæˆè™•æ–¹æ–‡æœ¬
                    updatePrescriptionDisplay();
                } else {
                    // å¦‚æœè¼¸å…¥ç„¡æ•ˆï¼Œæ¢å¾©åŸå€¼
                    updatePrescriptionDisplay();
                    showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„è—¥é‡ï¼ˆ0.5-100å…‹ï¼‰', 'warning');
                }
            }
        }
        

        
        // ç§»é™¤è™•æ–¹é …ç›®
        function removePrescriptionItem(index) {
            if (index >= 0 && index < selectedPrescriptionItems.length) {
                const removedItem = selectedPrescriptionItems.splice(index, 1)[0];
                updatePrescriptionDisplay();
                
                // å¦‚æœç§»é™¤å¾Œæ²’æœ‰è™•æ–¹é …ç›®äº†ï¼Œç§»é™¤è—¥è²»
                if (selectedPrescriptionItems.length === 0) {
                    // å°‹æ‰¾ä¸¦ç§»é™¤è—¥è²»é …ç›®
                    const medicineFeeItem = billingItems.find(item => 
                        item.active && 
                        item.category === 'medicine' && 
                        (item.name.includes('ä¸­è—¥') || item.name.includes('è—¥è²»') || item.name.includes('èª¿åŠ‘'))
                    );
                    
                    if (medicineFeeItem) {
                        const medicineFeeIndex = selectedBillingItems.findIndex(item => 
                            item.id === medicineFeeItem.id
                        );
                        
                        if (medicineFeeIndex !== -1) {
                            selectedBillingItems.splice(medicineFeeIndex, 1);
                            updateBillingDisplay();
                        }
                    }
                }
            }
        }
        
        // æ¸…é™¤è™•æ–¹æœç´¢
        function clearPrescriptionSearch() {
            document.getElementById('prescriptionSearch').value = '';
            document.getElementById('prescriptionSearchResults').classList.add('hidden');
        }
        
        // æ”¶è²»é …ç›®æœç´¢åŠŸèƒ½
        function searchBillingForConsultation() {
            const searchTerm = document.getElementById('billingSearch').value.trim().toLowerCase();
            const resultsContainer = document.getElementById('billingSearchResults');
            const resultsList = document.getElementById('billingSearchList');
            
            if (searchTerm.length < 1) {
                resultsContainer.classList.add('hidden');
                return;
            }
            
            // æœç´¢åŒ¹é…çš„æ”¶è²»é …ç›®ï¼ˆåªé¡¯ç¤ºå•Ÿç”¨çš„é …ç›®ï¼‰
            const matchedItems = billingItems.filter(item => 
                item.active && (
                    item.name.toLowerCase().includes(searchTerm) ||
                    (item.description && item.description.toLowerCase().includes(searchTerm))
                )
            ).slice(0, 10); // é™åˆ¶é¡¯ç¤ºå‰10å€‹çµæœ
            
            if (matchedItems.length === 0) {
                resultsList.innerHTML = `
                    <div class="p-3 text-center text-gray-500 text-sm">
                        æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„æ”¶è²»é …ç›®
                    </div>
                `;
                resultsContainer.classList.remove('hidden');
                return;
            }
            
            // é¡¯ç¤ºæœç´¢çµæœ
            resultsList.innerHTML = matchedItems.map(item => {
                const categoryNames = {
                    consultation: 'è¨ºç™‚è²»',
                    medicine: 'è—¥è²»',
                    treatment: 'æ²»ç™‚è²»',
                    other: 'å…¶ä»–',
                    discount: 'æŠ˜æ‰£é …ç›®',
                    package: 'å¥—ç¥¨é …ç›®'
                };
                const categoryName = categoryNames[item.category] || 'æœªåˆ†é¡';
                const bgColor = getCategoryBgColor(item.category);
                
                return `
                    <div class="p-3 ${bgColor} border rounded-lg cursor-pointer transition duration-200" onclick="addToBilling(${item.id})">
                        <div class="text-center">
                            <div class="font-semibold text-gray-900 text-sm mb-1">${item.name}</div>
                            <div class="text-xs bg-white text-gray-600 px-2 py-1 rounded mb-2">${categoryName}</div>
                            ${item.category !== 'discount' ? `
                                <div class="text-sm font-bold text-green-600">
                                    $${item.price}
                                </div>
                            ` : ''}
                            ${item.unit ? `<div class="text-xs text-gray-600">/ ${item.unit}</div>` : ''}
                            ${item.description ? `<div class="text-xs text-gray-600 mt-1">${item.description.substring(0, 30)}${item.description.length > 30 ? '...' : ''}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            resultsContainer.classList.remove('hidden');
        }
        
        // ç²å–é¡åˆ¥èƒŒæ™¯é¡è‰²
        function getCategoryBgColor(category) {
            const colors = {
                consultation: 'bg-blue-50 hover:bg-blue-100 border-blue-200',
                medicine: 'bg-green-50 hover:bg-green-100 border-green-200',
                treatment: 'bg-orange-50 hover:bg-orange-100 border-orange-200',
                other: 'bg-gray-50 hover:bg-gray-100 border-gray-200',
                discount: 'bg-red-50 hover:bg-red-100 border-red-200',
                package: 'bg-purple-50 hover:bg-purple-100 border-purple-200'
            };
            return colors[category] || colors.other;
        }
        
        // æ·»åŠ åˆ°æ”¶è²»é …ç›®
        function addToBilling(itemId) {
            const item = billingItems.find(b => b.id === itemId);
            if (!item) return;
            
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“æ·»åŠ é
            const existingIndex = selectedBillingItems.findIndex(b => b.id === itemId);
            if (existingIndex !== -1) {
                // å¦‚æœå·²å­˜åœ¨ï¼Œå¢åŠ æ•¸é‡
                selectedBillingItems[existingIndex].quantity += 1;
            } else {
                // æ·»åŠ æ–°é …ç›®
                const billingItem = {
                    id: itemId,
                    name: item.name,
                    category: item.category,
                    price: item.price,
                    unit: item.unit,
                    description: item.description,
                    packageUses: item.packageUses,
                    validityDays: item.validityDays,
                    quantity: 1
                };
                selectedBillingItems.push(billingItem);
            }
            
            // æ›´æ–°é¡¯ç¤º
            updateBillingDisplay();
            
            // æ¸…é™¤æœç´¢
            clearBillingSearch();
            
            showToast(`å·²æ·»åŠ æ”¶è²»é …ç›®ï¼š${item.name}`, 'success');
        }
        
        // æ›´æ–°æ”¶è²»é …ç›®é¡¯ç¤º
        function updateBillingDisplay() {
            const container = document.getElementById('selectedBillingItems');
            const hiddenTextarea = document.getElementById('formBillingItems');
            const totalAmountSpan = document.getElementById('totalBillingAmount');
            
            if (selectedBillingItems.length === 0) {
                container.innerHTML = `
                    <div class="text-sm text-gray-500 text-center py-4">
                        è«‹ä½¿ç”¨ä¸Šæ–¹æœç´¢åŠŸèƒ½æ·»åŠ æ”¶è²»é …ç›®
                    </div>
                `;
                hiddenTextarea.value = '';
                totalAmountSpan.textContent = '$0';
                return;
            }
            
            // è¨ˆç®—ç¸½è²»ç”¨
            let totalAmount = 0;
            let subtotalBeforeDiscount = 0;
            
            // å…ˆè¨ˆç®—éæŠ˜æ‰£é …ç›®çš„å°è¨ˆ
            selectedBillingItems.forEach(item => {
                if (item.category !== 'discount') {
                    subtotalBeforeDiscount += item.price * item.quantity;
                }
            });
            
            // è¨ˆç®—æŠ˜æ‰£å¾Œçš„ç¸½é‡‘é¡
            totalAmount = subtotalBeforeDiscount;
            selectedBillingItems.forEach(item => {
                if (item.category === 'discount') {
                    if (item.price > 0 && item.price < 1) {
                        // ç™¾åˆ†æ¯”æŠ˜æ‰£ï¼šå°å°è¨ˆé€²è¡ŒæŠ˜æ‰£è¨ˆç®—
                        const discountAmount = subtotalBeforeDiscount * (1 - item.price) * item.quantity;
                        totalAmount -= discountAmount;
                    } else {
                        // å›ºå®šé‡‘é¡æŠ˜æ‰£
                        totalAmount += item.price * item.quantity;
                    }
                }
            });
            totalAmountSpan.textContent = `$${totalAmount}`;
            
            // åˆ†é›¢æŠ˜æ‰£é …ç›®å’ŒéæŠ˜æ‰£é …ç›®ï¼Œä½†ä¿æŒå„è‡ªçš„æ·»åŠ é †åº
            const nonDiscountItems = [];
            const discountItems = [];
            
            selectedBillingItems.forEach((item, originalIndex) => {
                if (item.category === 'discount') {
                    discountItems.push({ item, originalIndex });
                } else {
                    nonDiscountItems.push({ item, originalIndex });
                }
            });
            
            // åˆä½µé¡¯ç¤ºï¼šéæŠ˜æ‰£é …ç›®åœ¨å‰ï¼ŒæŠ˜æ‰£é …ç›®åœ¨å¾Œ
            const displayItems = [...nonDiscountItems, ...discountItems];
            
            // é¡¯ç¤ºå·²é¸æ“‡çš„é …ç›®ï¼ˆéæŠ˜æ‰£é …ç›®åœ¨å‰ï¼ŒæŠ˜æ‰£é …ç›®åœ¨å¾Œï¼‰
            container.innerHTML = `
                <div class="space-y-2">
                    ${displayItems.map(({ item, originalIndex }) => {
                        const categoryNames = {
                            consultation: 'è¨ºç™‚è²»',
                            medicine: 'è—¥è²»',
                            treatment: 'æ²»ç™‚è²»',
                            other: 'å…¶ä»–',
                            discount: 'æŠ˜æ‰£é …ç›®',
                            package: 'å¥—ç¥¨é …ç›®'
                        };
                        const categoryName = categoryNames[item.category] || 'æœªåˆ†é¡';
                        const bgColor = getCategoryBgColor(item.category);
                        let subtotal;
                        let subtotalDisplay;
                        // æª¢æŸ¥æ˜¯å¦ç‚ºå¥—ç¥¨ä½¿ç”¨
                        const isPackageUse = item.category === 'packageUse';
                        // å–æ¶ˆæŒ‰éˆ•ï¼šåªæœ‰åœ¨å¥—ç¥¨ä½¿ç”¨æ™‚é¡¯ç¤º
                        const undoBtn = isPackageUse ? `
                                    <button
                                        type="button"
                                        class="ml-2 text-xs px-2 py-0.5 rounded border border-purple-300 text-purple-700 hover:bg-purple-50"
                                        onclick="undoPackageUse(${item.patientId}, ${item.packageRecordId}, '${item.id}')"
                                    >å–æ¶ˆä½¿ç”¨</button>
                                ` : '';
                        // æ•¸é‡æ§åˆ¶å€ï¼šå¥—ç¥¨ä½¿ç”¨é …ç›®ä¸é¡¯ç¤ºåŠ æ¸›è™Ÿ
                        const quantityControls = isPackageUse ? '' : `
                                <div class="flex items-center space-x-2 mr-3">
                                    <button onclick="updateBillingQuantity(${originalIndex}, -1)" class="w-6 h-6 bg-red-500 text-white rounded-full text-xs hover:bg-red-600 transition duration-200">-</button>
                                    <span class="w-8 text-center font-semibold">${item.quantity}</span>
                                    <button onclick="updateBillingQuantity(${originalIndex}, 1)" class="w-6 h-6 bg-green-500 text-white rounded-full text-xs hover:bg-green-600 transition duration-200">+</button>
                                </div>
                        `;
                        
                        if (item.category === 'discount' && item.price > 0 && item.price < 1) {
                            // ç™¾åˆ†æ¯”æŠ˜æ‰£ï¼šé¡¯ç¤ºæŠ˜æ‰£é‡‘é¡
                            const discountAmount = subtotalBeforeDiscount * (1 - item.price) * item.quantity;
                            subtotal = -discountAmount;
                            subtotalDisplay = `-$${discountAmount.toFixed(0)}`;
                        } else {
                            // ä¸€èˆ¬é …ç›®æˆ–å›ºå®šé‡‘é¡æŠ˜æ‰£
                            subtotal = item.price * item.quantity;
                            subtotalDisplay = `$${subtotal}`;
                        }
                        
                        return `
                            <div class="flex items-center ${bgColor} border rounded-lg p-3">
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-900">${item.name}</div>
                                    <div class="text-xs text-gray-600">${categoryName}</div>
                                    <div class="text-sm font-medium ${item.category === 'discount' ? 'text-red-600' : 'text-green-600'}">
                                        ${(() => {
                                            if (item.category === 'discount') {
                                                if (item.price > 0 && item.price < 1) {
                                                    return `${(item.price * 10).toFixed(1)}æŠ˜`;
                                                } else if (item.price < 0) {
                                                    return `-$${Math.abs(item.price)}`;
                                                } else {
                                                    return `$${item.price}`;
                                                }
                                            }
                                            return `$${item.price}`;
                                        })()}${item.unit ? ` / ${item.unit}` : ''}
                                    </div>
                                </div>
                                ${quantityControls}
                                <div class="mr-3 text-right">
                                    <div class="font-bold ${subtotal < 0 ? 'text-red-600' : 'text-green-600'}">${subtotalDisplay}</div>
                                </div>
                                ${undoBtn}<button onclick="removeBillingItem(${originalIndex})" class="text-red-500 hover:text-red-700 font-bold text-lg px-2">Ã—</button>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <!-- å°è¨ˆå’Œç¸½è¨ˆé¡¯ç¤º -->
                ${subtotalBeforeDiscount > 0 && selectedBillingItems.some(item => item.category === 'discount') ? `
                    <div class="mt-4 pt-3 border-t border-gray-200">
                        <div class="text-right space-y-1">
                            <div class="text-sm text-gray-600">
                                å°è¨ˆï¼š<span class="font-medium">$${subtotalBeforeDiscount}</span>
                            </div>
                            ${selectedBillingItems.filter(item => item.category === 'discount').map(item => {
                                if (item.price > 0 && item.price < 1) {
                                    const discountAmount = subtotalBeforeDiscount * (1 - item.price) * item.quantity;
                                    return `<div class="text-sm text-red-600">
                                        ${item.name}ï¼š<span class="font-medium">-$${discountAmount.toFixed(0)}</span>
                                    </div>`;
                                } else {
                                    return `<div class="text-sm text-red-600">
                                        ${item.name}ï¼š<span class="font-medium">$${item.price * item.quantity}</span>
                                    </div>`;
                                }
                            }).join('')}
                            <div class="text-base font-bold text-green-600 pt-1 border-t border-gray-300">
                                ç¸½è¨ˆï¼š$${Math.round(totalAmount)}
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
            
            // æ›´æ–°éš±è—çš„æ–‡æœ¬åŸŸï¼ˆéæŠ˜æ‰£é …ç›®åœ¨å‰ï¼ŒæŠ˜æ‰£é …ç›®åœ¨å¾Œï¼‰
            let billingText = '';
            
            // å¦‚æœæœ‰æŠ˜æ‰£é …ç›®ï¼Œå…ˆé¡¯ç¤ºå°è¨ˆ
            if (selectedBillingItems.some(item => item.category === 'discount')) {
                billingText += `å°è¨ˆï¼š$${subtotalBeforeDiscount}\n\n`;
            }
            
            // å…ˆè¨˜éŒ„éæŠ˜æ‰£é …ç›®
            selectedBillingItems.forEach(item => {
                if (item.category !== 'discount') {
                    billingText += `${item.name} x${item.quantity} = $${item.price * item.quantity}\n`;
                }
            });
            
            // å†è¨˜éŒ„æŠ˜æ‰£é …ç›®
            selectedBillingItems.forEach(item => {
                if (item.category === 'discount') {
                    if (item.price > 0 && item.price < 1) {
                        // ç™¾åˆ†æ¯”æŠ˜æ‰£
                        const discountAmount = subtotalBeforeDiscount * (1 - item.price) * item.quantity;
                        billingText += `${item.name} x${item.quantity} = -$${discountAmount.toFixed(0)}\n`;
                    } else {
                        // å›ºå®šé‡‘é¡æŠ˜æ‰£
                        billingText += `${item.name} x${item.quantity} = $${item.price * item.quantity}\n`;
                    }
                }
            });
            
            billingText += `\nç¸½è²»ç”¨ï¼š$${Math.round(totalAmount)}`;
            hiddenTextarea.value = billingText.trim();
        }
        
        // æ›´æ–°æ”¶è²»é …ç›®æ•¸é‡
        function updateBillingQuantity(index, change) {
            if (index >= 0 && index < selectedBillingItems.length) {
                const item = selectedBillingItems[index];
                // å¦‚æœæ˜¯å¥—ç¥¨ä½¿ç”¨ï¼Œä¸” change < 0ï¼Œç›´æ¥å–æ¶ˆä½¿ç”¨ä¸¦é€€å›æ¬¡æ•¸
                if (change < 0 && item.category === 'packageUse') {
                    // èª¿ç”¨å–æ¶ˆå‡½å¼ï¼Œé€™æœƒè‡ªå‹•ç§»é™¤è©²ç­†è¨˜éŒ„ä¸¦é€€å›æ¬¡æ•¸
                    undoPackageUse(item.patientId, item.packageRecordId, item.id);
                    return;
                }
                const newQuantity = item.quantity + change;
                if (newQuantity > 0) {
                    selectedBillingItems[index].quantity = newQuantity;
                    updateBillingDisplay();
                } else if (newQuantity === 0) {
                    // æ•¸é‡ç‚º0æ™‚ç§»é™¤é …ç›®
                    removeBillingItem(index);
                }
            }
        }
        
        // ç§»é™¤æ”¶è²»é …ç›®
        function removeBillingItem(index) {
            if (index >= 0 && index < selectedBillingItems.length) {
                const removedItem = selectedBillingItems[index];
                // å¦‚æœæ˜¯å¥—ç¥¨ä½¿ç”¨ï¼Œç§»é™¤æ™‚éœ€è¦é€€å›å‰©é¤˜æ¬¡æ•¸
                if (removedItem.category === 'packageUse') {
                    // ç›´æ¥èª¿ç”¨å–æ¶ˆå‡½å¼ï¼Œå®ƒæœƒè‡ªå‹•å¾é™£åˆ—ç§»é™¤ä¸¦è™•ç†æ¬¡æ•¸
                    undoPackageUse(removedItem.patientId, removedItem.packageRecordId, removedItem.id);
                    return;
                }
                // å¦å‰‡ï¼Œå–®ç´”ç§»é™¤
                selectedBillingItems.splice(index, 1);
                updateBillingDisplay();
                // showToast(`å·²ç§»é™¤ï¼š${removedItem.name}`, 'info');
            }
        }
        
        // æ¸…é™¤æ”¶è²»é …ç›®æœç´¢
        function clearBillingSearch() {
            document.getElementById('billingSearch').value = '';
            document.getElementById('billingSearchResults').classList.add('hidden');
        }
        
        // æ¸…ç©ºæ‰€æœ‰æœå°‹æ¬„ä½
        function clearAllSearchFields() {
            // æ¸…ç©ºç—…äººæœå°‹æ¬„
            const patientSearchInput = document.getElementById('patientSearchInput');
            if (patientSearchInput) {
                patientSearchInput.value = '';
            }
            
            // æ¸…ç©ºè™•æ–¹æœå°‹æ¬„
            clearPrescriptionSearch();
            
            // æ¸…ç©ºæ”¶è²»é …ç›®æœå°‹æ¬„
            clearBillingSearch();
        }
        
        // è‡ªå‹•æ·»åŠ é è¨­è¨ºé‡‘æ”¶è²»
        function addDefaultConsultationFee(patient) {
            // å°‹æ‰¾è¨ºé‡‘æ”¶è²»é …ç›®ï¼ˆå„ªå…ˆå°‹æ‰¾åç¨±åŒ…å«ã€Œè¨ºé‡‘ã€çš„é …ç›®ï¼‰
            let consultationFeeItem = billingItems.find(item => 
                item.active && 
                item.category === 'consultation' && 
                item.name.includes('è¨ºé‡‘')
            );
            
            // å¦‚æœæ²’æœ‰æ‰¾åˆ°è¨ºé‡‘é …ç›®ï¼Œä½¿ç”¨ç¬¬ä¸€å€‹è¨ºç™‚è²»é …ç›®
            if (!consultationFeeItem) {
                consultationFeeItem = billingItems.find(item => 
                    item.active && item.category === 'consultation'
                );
            }
            
            // å¦‚æœæ‰¾åˆ°è¨ºé‡‘é …ç›®ï¼Œè‡ªå‹•æ·»åŠ 
            if (consultationFeeItem) {
                // æ¸…ç©ºç¾æœ‰æ”¶è²»é …ç›®
                selectedBillingItems = [];
                
                // æ·»åŠ è¨ºé‡‘é …ç›®
                const billingItem = {
                    id: consultationFeeItem.id,
                    name: consultationFeeItem.name,
                    category: consultationFeeItem.category,
                    price: consultationFeeItem.price,
                    unit: consultationFeeItem.unit,
                    description: consultationFeeItem.description,
                    quantity: 1
                };
                
                selectedBillingItems.push(billingItem);
                
                // è‡ªå‹•æ·»åŠ é è¨­è—¥è²»ï¼ˆæ ¹æ“šé è¨­5å¤©ï¼‰
                const defaultDays = 5;
                updateMedicineFeeByDays(defaultDays);
                
                // æ›´æ–°é¡¯ç¤º
                updateBillingDisplay();
            } else {
                // å¦‚æœæ²’æœ‰æ‰¾åˆ°ä»»ä½•è¨ºç™‚è²»é …ç›®ï¼Œåªæ¸…ç©ºæ”¶è²»é …ç›®ä¸¦æ›´æ–°é¡¯ç¤º
                selectedBillingItems = [];
                updateBillingDisplay();
            }
        }
        

        
        // è¼‰å…¥ä¸Šæ¬¡è™•æ–¹å…§å®¹ï¼ˆæŒ‰éˆ•è§¸ç™¼ï¼‰
        async function loadPreviousPrescription() {
            if (!currentConsultingAppointmentId) {
                showToast('è«‹å…ˆé–‹å§‹è¨ºç—‡ï¼', 'error');
                return;
            }
            
            const appointment = appointments.find(apt => apt.id === currentConsultingAppointmentId);
            if (!appointment) {
                showToast('æ‰¾ä¸åˆ°ç•¶å‰è¨ºç—‡è¨˜éŒ„ï¼', 'error');
                return;
            }
    try {            
const patientResult = await window.firebaseDataManager.getPatients();
if (!patientResult.success) {
    showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™ï¼', 'error');
    return;
}

const patient = patientResult.data.find(p => p.id === patientId);
if (!patient) {
    showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ï¼', 'error');
    return;
}
            
            // ç²å–è©²ç—…äººçš„æœ€è¿‘ä¸€æ¬¡è¨ºç—‡è¨˜éŒ„ï¼ˆæ’é™¤ç•¶å‰æ­£åœ¨ç·¨è¼¯çš„è¨˜éŒ„ï¼‰
            const patientConsultations = consultations
                .filter(c => c.patientId === patient.id)
                .sort((a, b) => new Date(b.date) - new Date(a.date)); // æŒ‰æ—¥æœŸé™åºæ’åˆ—ï¼ˆæœ€æ–°åœ¨å‰ï¼‰
            
            const lastConsultation = patientConsultations[0]; // æœ€è¿‘ä¸€æ¬¡è¨ºç—‡è¨˜éŒ„
            
            if (!lastConsultation || !lastConsultation.prescription) {
                showToast(`${patient.name} æ²’æœ‰ä¸Šæ¬¡è™•æ–¹è¨˜éŒ„å¯è¼‰å…¥`, 'warning');
                return;
            }
            
            // ç›´æ¥è¼‰å…¥ï¼Œä¸éœ€è¦ç¢ºèª
            // æ¸…ç©ºç¾æœ‰è™•æ–¹é …ç›®
            selectedPrescriptionItems = [];
            
            // è§£æä¸Šæ¬¡è™•æ–¹å…§å®¹ï¼Œé‡å»ºè™•æ–¹é …ç›®
            parsePrescriptionToItems(lastConsultation.prescription);
            
            // æ›´æ–°è™•æ–¹é¡¯ç¤º
            updatePrescriptionDisplay();
            
            // showToast(`å·²è¼‰å…¥ ${patient.name} ä¸Šæ¬¡çš„è™•æ–¹å…§å®¹`, 'success');
            } catch (error) {
        console.error('è®€å–ç—…äººè³‡æ–™éŒ¯èª¤:', error);
        showToast('è®€å–ç—…äººè³‡æ–™å¤±æ•—', 'error');
    }
        }
        
        // è§£æè™•æ–¹å…§å®¹ä¸¦é‡å»ºè™•æ–¹é …ç›®
        function parsePrescriptionToItems(prescriptionText) {
            if (!prescriptionText) return;
            
            const lines = prescriptionText.split('\n');
            let i = 0;
            
            while (i < lines.length) {
                const line = lines[i].trim();
                if (!line) {
                    i++;
                    continue;
                }
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºè—¥æ/æ–¹åŠ‘æ ¼å¼ï¼ˆåç¨± åŠ‘é‡gï¼‰
                const itemMatch = line.match(/^(.+?)\s+(\d+(?:\.\d+)?)g$/);
                if (itemMatch) {
                    const itemName = itemMatch[1].trim();
                    const dosage = itemMatch[2];
                    
                    // å…ˆåœ¨ä¸­è—¥åº«ä¸­å°‹æ‰¾å°æ‡‰çš„é …ç›®ï¼ˆå„ªå…ˆåŒ¹é…ä¸­è—¥æï¼Œå†åŒ¹é…æ–¹åŠ‘ï¼‰
                    let foundItem = herbLibrary.find(item => 
                        item.type === 'herb' && item.name === itemName
                    );
                    
                    if (foundItem) {
                        // æ‰¾åˆ°ä¸­è—¥æ
                        const prescriptionItem = {
                            id: foundItem.id,
                            type: 'herb',
                            name: foundItem.name,
                            dosage: foundItem.dosage || '6g',
                            customDosage: dosage,
                            effects: foundItem.effects
                        };
                        selectedPrescriptionItems.push(prescriptionItem);
                    } else {
                        // æ²’æ‰¾åˆ°ä¸­è—¥æï¼Œå°‹æ‰¾æ–¹åŠ‘
                        foundItem = herbLibrary.find(item => 
                            item.type === 'formula' && item.name === itemName
                        );
                        
                        if (foundItem) {
                            // æ‰¾åˆ°æ–¹åŠ‘
                            const prescriptionItem = {
                                id: foundItem.id,
                                type: 'formula',
                                name: foundItem.name,
                                customDosage: dosage,
                                composition: foundItem.composition,
                                effects: foundItem.effects
                            };
                            selectedPrescriptionItems.push(prescriptionItem);
                        } else {
                            // éƒ½æ²’æ‰¾åˆ°ï¼Œæ ¹æ“šå¸¸è¦‹æ–¹åŠ‘åç¨±ç‰¹å¾µæ™ºèƒ½åˆ¤æ–·é¡å‹
                            const isLikelyFormula = isFormulaName(itemName);
                            
                            const prescriptionItem = {
                                id: Date.now() + Math.random(), // è‡¨æ™‚ID
                                type: isLikelyFormula ? 'formula' : 'herb',
                                name: itemName,
                                customDosage: dosage,
                                effects: 'ï¼ˆå¾ä¸Šæ¬¡è™•æ–¹è¼‰å…¥ï¼‰'
                            };
                            
                            if (isLikelyFormula) {
                                prescriptionItem.composition = 'ï¼ˆå¾ä¸Šæ¬¡è™•æ–¹è¼‰å…¥ï¼‰';
                            } else {
                                prescriptionItem.dosage = `${dosage}g`;
                            }
                            
                            selectedPrescriptionItems.push(prescriptionItem);
                        }
                    }
                }
                
                i++;
            }
        }
        
        // åˆ¤æ–·æ˜¯å¦ç‚ºæ–¹åŠ‘åç¨±çš„è¼”åŠ©å‡½æ•¸
        function isFormulaName(name) {
            // å¸¸è¦‹æ–¹åŠ‘åç¨±ç‰¹å¾µ
            const formulaKeywords = [
                'æ¹¯', 'æ•£', 'ä¸¸', 'è†', 'é£²', 'ä¸¹', 'ç…', 'æ–¹', 'åŠ‘',
                'å››å›å­', 'å…­å›å­', 'å…«ç', 'åå…¨', 'è£œä¸­ç›Šæ°£', 'é€é™',
                'ç”˜éº¥å¤§æ£—', 'å°æŸ´èƒ¡', 'å¤§æŸ´èƒ¡', 'åŠå¤ç€‰å¿ƒ', 'é»ƒé€£è§£æ¯’',
                'æ¸…ç†±è§£æ¯’', 'éŠ€ç¿¹', 'æ¡‘èŠ', 'éº»é»ƒ', 'æ¡‚æ', 'è‘›æ ¹',
                'ç™½è™', 'æ‰¿æ°£', 'ç†ä¸­', 'çœŸæ­¦', 'è‹“æ¡‚', 'äº”è‹“'
            ];
            
            return formulaKeywords.some(keyword => name.includes(keyword));
        }
        

        
        // è¼‰å…¥ä¸Šæ¬¡æ”¶è²»é …ç›®ï¼ˆæŒ‰éˆ•è§¸ç™¼ï¼‰
        async function loadPreviousBillingItems() {
            if (!currentConsultingAppointmentId) {
                showToast('è«‹å…ˆé–‹å§‹è¨ºç—‡ï¼', 'error');
                return;
            }
            
            const appointment = appointments.find(apt => apt.id === currentConsultingAppointmentId);
            if (!appointment) {
                showToast('æ‰¾ä¸åˆ°ç•¶å‰è¨ºç—‡è¨˜éŒ„ï¼', 'error');
                return;
            }
    try {             
const patientResult = await window.firebaseDataManager.getPatients();
if (!patientResult.success) {
    showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™ï¼', 'error');
    return;
}

const patient = patientResult.data.find(p => p.id === patientId);
if (!patient) {
    showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ï¼', 'error');
    return;
}
            
            // ç²å–è©²ç—…äººçš„æœ€è¿‘ä¸€æ¬¡è¨ºç—‡è¨˜éŒ„
            const patientConsultations = consultations
                .filter(c => c.patientId === patient.id)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const lastConsultation = patientConsultations[0];
            
            if (!lastConsultation || !lastConsultation.billingItems) {
                showToast(`${patient.name} æ²’æœ‰ä¸Šæ¬¡æ”¶è²»è¨˜éŒ„å¯è¼‰å…¥`, 'warning');
                return;
            }
            
            // ç›´æ¥è¼‰å…¥ï¼Œä¸éœ€è¦ç¢ºèª
            // æ¸…ç©ºç¾æœ‰æ”¶è²»é …ç›®
            selectedBillingItems = [];
            
            // è§£æä¸¦è¼‰å…¥ä¸Šæ¬¡æ”¶è²»é …ç›®
            parseBillingItemsFromText(lastConsultation.billingItems);
            
            // æ›´æ–°é¡¯ç¤º
            updateBillingDisplay();
            } catch (error) {
        console.error('è®€å–ç—…äººè³‡æ–™éŒ¯èª¤:', error);
        showToast('è®€å–ç—…äººè³‡æ–™å¤±æ•—', 'error');
    }
        }
        
        // è§£ææ”¶è²»é …ç›®æ–‡å­—ä¸¦è¼‰å…¥
        function parseBillingItemsFromText(billingText) {
            if (!billingText) {
                return;
            }
            
            // è§£æä¸Šæ¬¡æ”¶è²»é …ç›®
            const billingLines = billingText.split('\n');
            
            billingLines.forEach(line => {
                line = line.trim();
                if (!line || line.includes('å°è¨ˆ') || line.includes('ç¸½è²»ç”¨')) return;
                
                // è§£ææ”¶è²»é …ç›®æ ¼å¼ï¼šé …ç›®å xæ•¸é‡ = $é‡‘é¡ æˆ– é …ç›®å xæ•¸é‡ = -$é‡‘é¡
                const itemMatch = line.match(/^(.+?)\s+x(\d+)\s+=\s+([\-\$]?\d+)$/);
                if (itemMatch) {
                    const itemName = itemMatch[1].trim();
                    const quantity = parseInt(itemMatch[2]);
                    
                    // åœ¨æ”¶è²»é …ç›®ä¸­å°‹æ‰¾å°æ‡‰çš„é …ç›®
                    const billingItem = billingItems.find(item => 
                        item.active && item.name === itemName
                    );
                    
                    if (billingItem) {
                        const selectedItem = {
                            id: billingItem.id,
                            name: billingItem.name,
                            category: billingItem.category,
                            price: billingItem.price,
                            unit: billingItem.unit,
                            description: billingItem.description,
                            quantity: quantity
                        };
                        selectedBillingItems.push(selectedItem);
                    } else {
                        // å¦‚æœåœ¨æ”¶è²»é …ç›®ä¸­æ‰¾ä¸åˆ°ï¼Œå‰µå»ºä¸€å€‹è‡¨æ™‚é …ç›®ï¼ˆç”¨æ–¼å·²åˆªé™¤çš„æ”¶è²»é …ç›®ï¼‰
                        console.log(`æ‰¾ä¸åˆ°æ”¶è²»é …ç›®ï¼š${itemName}ï¼Œå¯èƒ½å·²è¢«åˆªé™¤`);
                    }
                }
            });
        }
        
        // è¼‰å…¥ä¸Šæ¬¡æ”¶è²»é …ç›®ï¼ˆå…§éƒ¨å‡½æ•¸ - ä¿ç•™å‘å¾Œå…¼å®¹ï¼‰
        function loadPreviousBillingItemsFromConsultation(lastConsultation) {
            selectedBillingItems = [];
            parseBillingItemsFromText(lastConsultation.billingItems);
            updateBillingDisplay();
        }
        
        // è¼‰å…¥æŒ‡å®šç—…æ­·è¨˜éŒ„åˆ°ç•¶å‰è¨ºç—‡
        async function loadMedicalRecordToCurrentConsultation(consultationId) {
            if (!currentConsultingAppointmentId) {
                showToast('è«‹å…ˆé–‹å§‹è¨ºç—‡ï¼', 'error');
                return;
            }
            
            const consultation = consultations.find(c => c.id === consultationId);
            if (!consultation) {
                showToast('æ‰¾ä¸åˆ°æŒ‡å®šçš„è¨ºç—‡è¨˜éŒ„ï¼', 'error');
                return;
            }
            
            const currentAppointment = appointments.find(apt => apt.id === currentConsultingAppointmentId);
            if (!currentAppointment) {
                showToast('æ‰¾ä¸åˆ°ç•¶å‰è¨ºç—‡è¨˜éŒ„ï¼', 'error');
                return;
            }
            
            // ç¢ºèªæ˜¯å¦ç‚ºç›¸åŒç—…äºº
            if (currentAppointment.patientId !== consultation.patientId) {
                showToast('åªèƒ½è¼‰å…¥ç›¸åŒç—…äººçš„ç—…æ­·è¨˜éŒ„ï¼', 'error');
                return;
            }
            
const patientResult = await window.firebaseDataManager.getPatients();
if (!patientResult.success) {
    showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™ï¼', 'error');
    return;
}

const patient = patientResult.data.find(p => p.id === consultation.patientId);
if (!patient) {
    showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ï¼', 'error');
    return;
}

const consultationDate = new Date(consultation.date).toLocaleDateString('zh-TW');
            
            // ç¢ºèªè¼‰å…¥æ“ä½œ
            const confirmMessage = `ç¢ºå®šè¦è¼‰å…¥ ${patient ? patient.name : 'æœªçŸ¥ç—…äºº'} åœ¨ ${consultationDate} çš„ç—…æ­·è¨˜éŒ„å—ï¼Ÿ\n\n` +
                                 `æ­¤æ“ä½œå°‡æœƒè¦†è“‹ç•¶å‰å·²å¡«å¯«çš„è¨ºç—‡å…§å®¹ï¼ŒåŒ…æ‹¬ï¼š\n` +
                                 `â€¢ ä¸»è¨´ã€èˆŒè±¡ã€è„ˆè±¡ç­‰è¨ºç—‡è³‡æ–™\n` +
                                 `â€¢ è¨ºæ–·å’Œè­‰å‹\n` +
                                 `â€¢ è™•æ–¹å…§å®¹\n` +
                                 `â€¢ æ”¶è²»é …ç›®\n` +
                                 `â€¢ é†«å›‘å’Œæ³¨æ„äº‹é …\n\n` +
                                 `æ³¨æ„ï¼šæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // è¼‰å…¥è¨ºç—‡è³‡æ–™
            document.getElementById('formSymptoms').value = consultation.symptoms || '';
            document.getElementById('formTongue').value = consultation.tongue || '';
            document.getElementById('formPulse').value = consultation.pulse || '';
            document.getElementById('formCurrentHistory').value = consultation.currentHistory || '';
            document.getElementById('formDiagnosis').value = consultation.diagnosis || '';
            document.getElementById('formSyndrome').value = consultation.syndrome || '';
            document.getElementById('formAcupunctureNotes').value = consultation.acupunctureNotes || '';
            document.getElementById('formUsage').value = consultation.usage || '';
            document.getElementById('formTreatmentCourse').value = consultation.treatmentCourse || '';
            document.getElementById('formInstructions').value = consultation.instructions || '';
            document.getElementById('formFollowUpDate').value = consultation.followUpDate || '';
            document.getElementById('formVisitTime').value = consultation.visitTime || '';
            
            // è¼‰å…¥ä¼‘æ¯æœŸé–“
            if (consultation.restStartDate && consultation.restEndDate) {
                document.getElementById('formRestStartDate').value = consultation.restStartDate;
                document.getElementById('formRestEndDate').value = consultation.restEndDate;
                updateRestPeriod();
            } else {
                // ä½¿ç”¨é è¨­ä¼‘æ¯æœŸé–“ï¼ˆä»Šå¤©åˆ°å¾Œå¤©ï¼‰
                const startDate = new Date();
                const endDate = new Date();
                endDate.setDate(startDate.getDate() + 2);
                
                const startDateStr = `${startDate.getFullYear()}-${String(startDate.getMonth() + 1).padStart(2, '0')}-${String(startDate.getDate()).padStart(2, '0')}`;
                const endDateStr = `${endDate.getFullYear()}-${String(endDate.getMonth() + 1).padStart(2, '0')}-${String(endDate.getDate()).padStart(2, '0')}`;
                
                document.getElementById('formRestStartDate').value = startDateStr;
                document.getElementById('formRestEndDate').value = endDateStr;
                updateRestPeriod();
            }
            
            // è¼‰å…¥è™•æ–¹å…§å®¹
            selectedPrescriptionItems = [];
            if (consultation.prescription) {
                // ç›´æ¥å°‡è™•æ–¹å…§å®¹è¨­ç½®åˆ°éš±è—æ–‡æœ¬åŸŸ
                document.getElementById('formPrescription').value = consultation.prescription;
                
                // è§£æè™•æ–¹å…§å®¹ä¸¦é‡å»ºè™•æ–¹é …ç›®
                parsePrescriptionToItems(consultation.prescription);
                
                // æ›´æ–°è™•æ–¹é¡¯ç¤º
                updatePrescriptionDisplay();
            } else {
                // æ¸…ç©ºè™•æ–¹
                document.getElementById('formPrescription').value = '';
                updatePrescriptionDisplay();
            }
            
            // è¼‰å…¥æ”¶è²»é …ç›®
            selectedBillingItems = [];
            if (consultation.billingItems) {
                // ç›´æ¥å°‡æ”¶è²»é …ç›®è¨­ç½®åˆ°éš±è—æ–‡æœ¬åŸŸ
                document.getElementById('formBillingItems').value = consultation.billingItems;
                
                // è§£æä¸¦è¼‰å…¥æ”¶è²»é …ç›®
                parseBillingItemsFromText(consultation.billingItems);
                
                // æ›´æ–°æ”¶è²»é¡¯ç¤º
                updateBillingDisplay();
            } else {
                // æ¸…ç©ºæ”¶è²»é …ç›®
                document.getElementById('formBillingItems').value = '';
                updateBillingDisplay();
            }
            
            // æ¸…é™¤æœç´¢æ¡†
            clearPrescriptionSearch();
            clearBillingSearch();
            
            // é—œé–‰ç—…æ­·æŸ¥çœ‹å½ˆçª—
            closeMedicalHistoryModal();
            
            // æ»¾å‹•åˆ°è¨ºç—‡è¡¨å–®
            document.getElementById('consultationForm').scrollIntoView({ behavior: 'smooth' });
            
            showToast(`å·²è¼‰å…¥ ${patient ? patient.name : 'æœªçŸ¥ç—…äºº'} åœ¨ ${consultationDate} çš„å®Œæ•´ç—…æ­·è¨˜éŒ„`, 'success');
        }
        
        // æ¸…ç©ºè¨ºç—‡è¡¨å–®æ™‚ä¹Ÿè¦æ¸…ç©ºè™•æ–¹æœç´¢
        function clearConsultationFormOld() {
            ['formSymptoms', 'formTongue', 'formPulse', 'formCurrentHistory', 'formDiagnosis', 'formSyndrome', 'formAcupunctureNotes', 'formPrescription', 'formUsage', 'formTreatmentCourse', 'formInstructions', 'formFollowUpDate'].forEach(id => {
                document.getElementById(id).value = '';
            });
            
            // æ¸…ç©ºè™•æ–¹é …ç›®
            selectedPrescriptionItems = [];
            updatePrescriptionDisplay();
            clearPrescriptionSearch();
            
            // æ¸…ç©ºæ”¶è²»é …ç›®
            selectedBillingItems = [];
            updateBillingDisplay();
            clearBillingSearch();
        }



        // ç²å–ç”¨æˆ¶é¡¯ç¤ºåç¨±ï¼ˆå§“åå…¨å + è·ä½ï¼‰
        function getUserDisplayName(user) {
            if (!user || !user.name) return 'æœªçŸ¥ç”¨æˆ¶';
            
            const fullName = user.name;
            const position = user.position || 'ç”¨æˆ¶';
            
            return `${fullName}${position}`;
        }
        
        // ç²å–é†«å¸«é¡¯ç¤ºåç¨±
        function getDoctorDisplayName(doctorRole) {
            if (!doctorRole) return 'æœªè¨˜éŒ„';
            
            // å¦‚æœæ˜¯èˆŠçš„å›ºå®šå€¼ï¼Œç›´æ¥è¿”å›
            if (doctorRole === 'doctor') {
                return 'å¼µä¸­é†«å¸«é†«å¸«';
            }
            
            // å°‹æ‰¾å°æ‡‰çš„é†«å¸«ç”¨æˆ¶
            const doctorUser = users.find(u => u.username === doctorRole);
            if (doctorUser) {
                return getUserDisplayName(doctorUser);
            }
            
            // å¦‚æœæ‰¾ä¸åˆ°ï¼Œè¿”å›åŸå€¼
            return doctorRole;
        }
        
        // ç²å–é†«å¸«è¨»å†Šç·¨è™Ÿ
        function getDoctorRegistrationNumber(doctorRole) {
            if (!doctorRole) return null;
            
            // å¦‚æœæ˜¯èˆŠçš„å›ºå®šå€¼ï¼Œè¿”å›é è¨­è¨»å†Šç·¨è™Ÿ
            if (doctorRole === 'doctor') {
                return 'CM001234';
            }
            
            // å°‹æ‰¾å°æ‡‰çš„é†«å¸«ç”¨æˆ¶
            const doctorUser = users.find(u => u.username === doctorRole);
            if (doctorUser && doctorUser.position === 'é†«å¸«') {
                return doctorUser.registrationNumber || null;
            }
            
            return null;
        }
        
// ç”¨æˆ¶ç®¡ç†åŠŸèƒ½
let editingUserId = null;
let currentUserFilter = 'all';
let usersFromFirebase = []; // å„²å­˜å¾ Firebase è®€å–çš„ç”¨æˆ¶æ•¸æ“š

async function loadUserManagement() {
    await loadUsersFromFirebase();
    displayUsers();
    
    // æœå°‹åŠŸèƒ½
    const searchInput = document.getElementById('searchUser');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            displayUsers();
        });
    }
}

// å¾ Firebase è¼‰å…¥ç”¨æˆ¶æ•¸æ“š
async function loadUsersFromFirebase() {
    const tbody = document.getElementById('userList');
    
    // é¡¯ç¤ºè¼‰å…¥ä¸­
    tbody.innerHTML = `
        <tr>
            <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
                <div class="mt-2">è¼‰å…¥ä¸­...</div>
            </td>
        </tr>
    `;

    try {
        const result = await window.firebaseDataManager.getUsers();
        
        if (result.success) {
            usersFromFirebase = result.data;
            // åŒæ™‚æ›´æ–°æœ¬åœ° users è®Šæ•¸ä»¥ä¿æŒå…¼å®¹æ€§
            users = result.data.map(user => ({
                ...user,
                // ç¢ºä¿æ•¸æ“šæ ¼å¼å…¼å®¹æ€§
                createdAt: user.createdAt ? (user.createdAt.seconds ? new Date(user.createdAt.seconds * 1000).toISOString() : user.createdAt) : new Date().toISOString(),
                updatedAt: user.updatedAt ? (user.updatedAt.seconds ? new Date(user.updatedAt.seconds * 1000).toISOString() : user.updatedAt) : new Date().toISOString(),
                lastLogin: user.lastLogin ? (user.lastLogin.seconds ? new Date(user.lastLogin.seconds * 1000).toISOString() : user.lastLogin) : null
            }));
            
            console.log('å·²å¾ Firebase è¼‰å…¥ç”¨æˆ¶æ•¸æ“š:', usersFromFirebase.length, 'ç­†');
        } else {
            // å¦‚æœ Firebase è®€å–å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ° users æ•¸æ“š
            usersFromFirebase = users;
            console.log('Firebase è®€å–å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°ç”¨æˆ¶æ•¸æ“š');
        }
    } catch (error) {
        console.error('è¼‰å…¥ç”¨æˆ¶æ•¸æ“šéŒ¯èª¤:', error);
        usersFromFirebase = users; // ä½¿ç”¨æœ¬åœ°æ•¸æ“šä½œç‚ºå‚™ç”¨
        showToast('è¼‰å…¥ç”¨æˆ¶æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œä½¿ç”¨æœ¬åœ°æ•¸æ“š', 'warning');
    }
}

function filterUsers(status) {
    currentUserFilter = status;
    
    // æ›´æ–°æŒ‰éˆ•æ¨£å¼
    document.querySelectorAll('[id^="user-filter-"]').forEach(btn => {
        btn.className = 'px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200';
    });
    document.getElementById(`user-filter-${status}`).className = 'px-4 py-2 rounded-lg text-sm font-medium bg-blue-100 text-blue-800 transition duration-200';
    
    displayUsers();
}

function displayUsers() {
    const searchTerm = document.getElementById('searchUser').value.toLowerCase();
    const tbody = document.getElementById('userList');
    
    // ä½¿ç”¨ Firebase æ•¸æ“šæˆ–æœ¬åœ°æ•¸æ“š
    const currentUsers = usersFromFirebase.length > 0 ? usersFromFirebase : users;
    
    // éæ¿¾ç”¨æˆ¶è³‡æ–™
    let filteredUsers = currentUsers.filter(user => {
        // åƒ…ä»¥å§“åæˆ–é›»å­éƒµä»¶é€²è¡Œæœå°‹ï¼Œä¸åŒ…å«å¸³è™Ÿ
        const matchesSearch = user.name.toLowerCase().includes(searchTerm) ||
                            (user.email && user.email.toLowerCase().includes(searchTerm));
        
        let matchesFilter = true;
        if (currentUserFilter === 'inactive') {
            matchesFilter = !user.active;
        }
        
        return matchesSearch && matchesFilter;
    });
    
        tbody.innerHTML = '';
    
    if (filteredUsers.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                    ${searchTerm ? 'æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„ç”¨æˆ¶' : 'å°šç„¡ç”¨æˆ¶è³‡æ–™'}
                </td>
            </tr>
        `;
        return;
    }
    
        filteredUsers.forEach(user => {
        const statusClass = user.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
        const statusText = user.active ? 'å•Ÿç”¨' : 'åœç”¨';
        
        // è™•ç† Firebase Timestamp æ ¼å¼
        let lastLogin = 'å¾æœªç™»å…¥';
        if (user.lastLogin) {
            if (user.lastLogin.seconds) {
                lastLogin = new Date(user.lastLogin.seconds * 1000).toLocaleString('zh-TW');
            } else {
                lastLogin = new Date(user.lastLogin).toLocaleString('zh-TW');
            }
        }
        
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
            <td class="px-4 py-3 text-sm text-gray-900">${user.name}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${user.position || 'æœªè¨­å®š'}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${user.position === 'é†«å¸«' ? (user.registrationNumber || 'æœªè¨­å®š') : '-'}</td>
            <td class="px-4 py-3 text-sm text-gray-900">${user.email || 'æœªè¨­å®š'}</td>
            <td class="px-4 py-3">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                    ${statusText}
                </span>
            </td>
            <td class="px-4 py-3 text-sm text-gray-600">${lastLogin}</td>
            <td class="px-4 py-3 text-sm space-x-2">
                <button onclick="editUser('${user.id}')" class="text-blue-600 hover:text-blue-800">ç·¨è¼¯</button>
                ${user.id !== currentUserData.id ? `
                    <button onclick="toggleUserStatus('${user.id}')" class="text-orange-600 hover:text-orange-800">
                        ${user.active ? 'åœç”¨' : 'å•Ÿç”¨'}
                    </button>
                    <button onclick="deleteUser('${user.id}')" class="text-red-600 hover:text-red-800">åˆªé™¤</button>
                ` : `
                    <span class="text-gray-400 text-xs">ç•¶å‰ç”¨æˆ¶</span>
                `}
            </td>
        `;
        tbody.appendChild(row);
    });
}

function showAddUserForm() {
    editingUserId = null;
    // ä½¿ç”¨é˜²å‘†è™•ç†ï¼Œé¿å…ç›®æ¨™å…ƒç´ ä¸å­˜åœ¨æ™‚æ‹‹å‡ºéŒ¯èª¤
    const titleEl = document.getElementById('userFormTitle');
    if (titleEl) {
        titleEl.textContent = 'æ–°å¢ç”¨æˆ¶';
    }
    const saveBtnTextEl = document.getElementById('userSaveButtonText');
    if (saveBtnTextEl) {
        saveBtnTextEl.textContent = 'å„²å­˜';
    }
    clearUserForm();
    const modalEl = document.getElementById('addUserModal');
    if (modalEl) {
        modalEl.classList.remove('hidden');
    }
}

function hideAddUserForm() {
    document.getElementById('addUserModal').classList.add('hidden');
    clearUserForm();
    editingUserId = null;
}

function clearUserForm() {
    ['userDisplayName', 'userPosition', 'userEmail', 'userPhone', 'userRegistrationNumber', 'userUID'].forEach(id => {
        document.getElementById(id).value = '';
    });
    document.getElementById('userActive').checked = true;
    
    // éš±è—è¨»å†Šç·¨è™Ÿæ¬„ä½
    document.getElementById('registrationNumberField').classList.add('hidden');
}

// åˆ‡æ›è¨»å†Šç·¨è™Ÿæ¬„ä½é¡¯ç¤º
function toggleRegistrationNumberField() {
    const positionSelect = document.getElementById('userPosition');
    const registrationField = document.getElementById('registrationNumberField');
    
    if (positionSelect.value === 'é†«å¸«') {
        registrationField.classList.remove('hidden');
    } else {
        registrationField.classList.add('hidden');
        // æ¸…ç©ºè¨»å†Šç·¨è™Ÿæ¬„ä½
        document.getElementById('userRegistrationNumber').value = '';
    }
}

async function editUser(id) {
    const currentUsers = usersFromFirebase.length > 0 ? usersFromFirebase : users;
    const user = currentUsers.find(u => u.id === id);
    if (!user) return;
    
    editingUserId = id;
    // ä½¿ç”¨é˜²å‘†è™•ç†ï¼Œé¿å…ç›®æ¨™å…ƒç´ ä¸å­˜åœ¨æ™‚æ‹‹å‡ºéŒ¯èª¤
    const titleEl = document.getElementById('userFormTitle');
    if (titleEl) {
        titleEl.textContent = 'ç·¨è¼¯ç”¨æˆ¶';
    }
    const saveBtnTextEl = document.getElementById('userSaveButtonText');
    if (saveBtnTextEl) {
        saveBtnTextEl.textContent = 'æ›´æ–°';
    }
    
    // å¸³è™ŸåŠå¯†ç¢¼æ¬„ä½å·²ç§»é™¤ï¼Œç„¡éœ€å¡«å……ç›¸é—œè³‡æ–™
    // å¡«å……è¡¨å–®è³‡æ–™
    const displayNameEl = document.getElementById('userDisplayName');
    if (displayNameEl) displayNameEl.value = user.name || '';
    const positionEl = document.getElementById('userPosition');
    if (positionEl) positionEl.value = user.position || '';
    const emailEl = document.getElementById('userEmail');
    if (emailEl) emailEl.value = user.email || '';
    const phoneEl = document.getElementById('userPhone');
    if (phoneEl) phoneEl.value = user.phone || '';
    const regNumEl = document.getElementById('userRegistrationNumber');
    if (regNumEl) regNumEl.value = user.registrationNumber || '';
    const activeEl = document.getElementById('userActive');
    if (activeEl) activeEl.checked = user.active !== false;

    // å¡«å…¥ Firebase UID
    const uidEl = document.getElementById('userUID');
    if (uidEl) uidEl.value = user.uid || '';
    
    // æ ¹æ“šè·ä½é¡¯ç¤ºæˆ–éš±è—è¨»å†Šç·¨è™Ÿæ¬„ä½
    toggleRegistrationNumberField();
    
    const modalEl = document.getElementById('addUserModal');
    if (modalEl) {
        modalEl.classList.remove('hidden');
    }
}

async function saveUser() {
    // å¸³è™ŸåŠå¯†ç¢¼æ¬„ä½å·²ç§»é™¤ï¼Œä½¿ç”¨ UID æˆ–é›»å­éƒµä»¶è‡ªå‹•ç”¢ç”Ÿå…§éƒ¨è­˜åˆ¥åç¨±
    const name = document.getElementById('userDisplayName').value.trim();
    const position = document.getElementById('userPosition').value.trim();
    const email = document.getElementById('userEmail').value.trim();
    const phone = document.getElementById('userPhone').value.trim();
    const registrationNumber = document.getElementById('userRegistrationNumber').value.trim();
    const active = document.getElementById('userActive').checked;
    const uid = document.getElementById('userUID').value.trim();

    // ç”¢ç”Ÿå…§éƒ¨ç”¨æˆ¶è­˜åˆ¥åç¨±ï¼ˆusernameï¼‰
    let username;
    if (uid) {
        username = uid;
    } else if (email) {
        username = email.split('@')[0];
    } else {
        username = 'user_' + Date.now();
    }
    
    // é©—è­‰å¿…å¡«æ¬„ä½ï¼ˆå§“åèˆ‡è·ä½ï¼‰
    if (!name || !position) {
        showToast('è«‹å¡«å¯«å¿…è¦è³‡æ–™ï¼ˆå§“åã€è·ä½ï¼‰ï¼', 'error');
        return;
    }
    
    // é†«å¸«è·ä½å¿…é ˆå¡«å¯«è¨»å†Šç·¨è™Ÿ
    if (position === 'é†«å¸«' && !registrationNumber) {
        showToast('é†«å¸«è·ä½å¿…é ˆå¡«å¯«ä¸­é†«è¨»å†Šç·¨è™Ÿï¼', 'error');
        return;
    }
    
    // æª¢æŸ¥é›»å­éƒµä»¶æ˜¯å¦é‡è¤‡
    if (email) {
        const currentUsers = usersFromFirebase.length > 0 ? usersFromFirebase : users;
        const existingUserByEmail = currentUsers.find(u => u.email && u.email.toLowerCase() === email.toLowerCase() && u.id !== editingUserId);
        if (existingUserByEmail) {
            showToast('æ­¤é›»å­éƒµä»¶å·²å­˜åœ¨ï¼Œè«‹ä½¿ç”¨å…¶ä»–é›»å­éƒµä»¶ï¼', 'error');
            return;
        }
    }
    
    // é©—è­‰é›»å­éƒµä»¶æ ¼å¼
    if (email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­éƒµä»¶æ ¼å¼ï¼', 'error');
            return;
        }
    }

    // é¡¯ç¤ºä¿å­˜ä¸­ç‹€æ…‹
    const saveButton = document.querySelector('[onclick="saveUser()"]');
    const originalText = saveButton.textContent;
    saveButton.textContent = 'ä¿å­˜ä¸­...';
    saveButton.disabled = true;

    try {
        if (editingUserId) {
            // æ›´æ–°ç¾æœ‰ç”¨æˆ¶
            const userData = {
                name: name,
                position: position,
                registrationNumber: position === 'é†«å¸«' ? registrationNumber : null,
                email: email,
                phone: phone,
                uid: uid || '',
                active: active
            };

            const result = await window.firebaseDataManager.updateUser(editingUserId, userData);
            
            if (result.success) {
                // æ›´æ–°æœ¬åœ°æ•¸æ“š
                const userIndex = users.findIndex(u => u.id === editingUserId);
                if (userIndex !== -1) {
                    users[userIndex] = { ...users[userIndex], ...userData, updatedAt: new Date().toISOString() };
                }

                // æ›´æ–° Firebase æ•¸æ“š
                const firebaseUserIndex = usersFromFirebase.findIndex(u => u.id === editingUserId);
                if (firebaseUserIndex !== -1) {
                    usersFromFirebase[firebaseUserIndex] = { ...usersFromFirebase[firebaseUserIndex], ...userData };
                }
                
                // å¦‚æœæ›´æ–°çš„æ˜¯ç•¶å‰ç™»å…¥ç”¨æˆ¶ï¼ŒåŒæ­¥æ›´æ–° currentUserData
                if (editingUserId === currentUserData.id) {
                    currentUserData = { ...currentUserData, ...userData };
                    currentUser = users[userIndex].username;
                    
                    // æ›´æ–°é¡¯ç¤ºçš„ç”¨æˆ¶è³‡è¨Š
                    document.getElementById('userRole').textContent = `ç•¶å‰ç”¨æˆ¶ï¼š${getUserDisplayName(currentUserData)}`;
                    document.getElementById('sidebarUserRole').textContent = `ç•¶å‰ç”¨æˆ¶ï¼š${getUserDisplayName(currentUserData)}`;
                }
                
                showToast('ç”¨æˆ¶è³‡æ–™å·²æˆåŠŸæ›´æ–°ï¼', 'success');
            } else {
                showToast('æ›´æ–°ç”¨æˆ¶è³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                return;
            }
        } else {
            // æ–°å¢ç”¨æˆ¶
            const userData = {
                username: username,
                name: name,
                position: position,
                registrationNumber: position === 'é†«å¸«' ? registrationNumber : null,
                email: email,
                phone: phone,
                uid: uid || '',
                active: active,
                lastLogin: null
            };

            const result = await window.firebaseDataManager.addUser(userData);
            
            if (result.success) {
                // æ›´æ–°æœ¬åœ°æ•¸æ“š
                const newUser = {
                    id: result.id,
                    ...userData,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                users.push(newUser);
                usersFromFirebase.push(newUser);
                
                showToast('ç”¨æˆ¶å·²æˆåŠŸæ–°å¢ï¼', 'success');
            } else {
                showToast('æ–°å¢ç”¨æˆ¶å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                return;
            }
        }
        
        // ä¿å­˜åˆ°æœ¬åœ°å„²å­˜ä½œç‚ºå‚™ç”¨
        localStorage.setItem('users', JSON.stringify(users));
        displayUsers();
        hideAddUserForm();

    } catch (error) {
        console.error('ä¿å­˜ç”¨æˆ¶è³‡æ–™éŒ¯èª¤:', error);
        showToast('ä¿å­˜æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
    } finally {
        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
        saveButton.textContent = originalText;
        saveButton.disabled = false;
    }
}

async function toggleUserStatus(id) {
    const currentUsers = usersFromFirebase.length > 0 ? usersFromFirebase : users;
    const user = currentUsers.find(u => u.id === id);
    if (!user) return;
    
    // é˜²æ­¢åœç”¨è‡ªå·±çš„å¸³è™Ÿ
    if (user.id === currentUserData.id) {
        showToast('ä¸èƒ½åœç”¨è‡ªå·±çš„å¸³è™Ÿï¼', 'error');
        return;
    }
    
    const action = user.active ? 'åœç”¨' : 'å•Ÿç”¨';
    const confirmMessage = `ç¢ºå®šè¦${action}ç”¨æˆ¶ã€Œ${user.name}ã€å—ï¼Ÿ\n\n${user.active ? 'åœç”¨å¾Œè©²ç”¨æˆ¶å°‡ç„¡æ³•ç™»å…¥ç³»çµ±ã€‚' : 'å•Ÿç”¨å¾Œè©²ç”¨æˆ¶å¯ä»¥æ­£å¸¸ç™»å…¥ç³»çµ±ã€‚'}`;
    
    if (confirm(confirmMessage)) {
        // é¡¯ç¤ºè™•ç†ä¸­ç‹€æ…‹
        showToast('è™•ç†ä¸­...', 'info');

        try {
            const userData = {
                active: !user.active
            };

            const result = await window.firebaseDataManager.updateUser(id, userData);
            
            if (result.success) {
                // æ›´æ–°æœ¬åœ°æ•¸æ“š
                const userIndex = users.findIndex(u => u.id === id);
                if (userIndex !== -1) {
                    users[userIndex].active = !user.active;
                    users[userIndex].updatedAt = new Date().toISOString();
                }

                // æ›´æ–° Firebase æ•¸æ“š
                const firebaseUserIndex = usersFromFirebase.findIndex(u => u.id === id);
                if (firebaseUserIndex !== -1) {
                    usersFromFirebase[firebaseUserIndex].active = !user.active;
                }
                
                localStorage.setItem('users', JSON.stringify(users));
                displayUsers();
                showToast(`ç”¨æˆ¶ã€Œ${user.name}ã€å·²${action}ï¼`, 'success');
            } else {
                showToast(`${action}ç”¨æˆ¶å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦`, 'error');
            }
        } catch (error) {
            console.error('æ›´æ–°ç”¨æˆ¶ç‹€æ…‹éŒ¯èª¤:', error);
            showToast('æ›´æ–°ç”¨æˆ¶ç‹€æ…‹æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
        }
    }
}

async function deleteUser(id) {
    const currentUsers = usersFromFirebase.length > 0 ? usersFromFirebase : users;
    const user = currentUsers.find(u => u.id === id);
    if (!user) return;
    
    // é˜²æ­¢åˆªé™¤è‡ªå·±çš„å¸³è™Ÿ
    if (user.id === currentUserData.id) {
        showToast('ä¸èƒ½åˆªé™¤è‡ªå·±çš„å¸³è™Ÿï¼', 'error');
        return;
    }
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºæœ€å¾Œä¸€å€‹ç®¡ç†å“¡
    const adminUsers = currentUsers.filter(u => u.position === 'è¨ºæ‰€ç®¡ç†' && u.active && u.id !== id);
    if (user.position === 'è¨ºæ‰€ç®¡ç†' && adminUsers.length === 0) {
        showToast('ä¸èƒ½åˆªé™¤æœ€å¾Œä¸€å€‹è¨ºæ‰€ç®¡ç†å¸³è™Ÿï¼', 'error');
        return;
    }
    
    const confirmMessage = `ç¢ºå®šè¦åˆªé™¤ç”¨æˆ¶ã€Œ${user.name}ã€å—ï¼Ÿ\n\n` +
                         `è·ä½ï¼š${user.position}\n` +
                         `é›»å­éƒµä»¶ï¼š${user.email || 'æœªè¨­å®š'}\n\n` +
                         `æ³¨æ„ï¼šæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`;
    
    if (confirm(confirmMessage)) {
        // é¡¯ç¤ºåˆªé™¤ä¸­ç‹€æ…‹
        showToast('åˆªé™¤ä¸­...', 'info');

        try {
            const result = await window.firebaseDataManager.deleteUser(id);
            
            if (result.success) {
                // æ›´æ–°æœ¬åœ°æ•¸æ“š
                users = users.filter(u => u.id !== id);
                usersFromFirebase = usersFromFirebase.filter(u => u.id !== id);
                
                localStorage.setItem('users', JSON.stringify(users));
                displayUsers();
                showToast(`ç”¨æˆ¶ã€Œ${user.name}ã€å·²åˆªé™¤ï¼`, 'success');
            } else {
                showToast('åˆªé™¤ç”¨æˆ¶å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            }
        } catch (error) {
            console.error('åˆªé™¤ç”¨æˆ¶éŒ¯èª¤:', error);
            showToast('åˆªé™¤ç”¨æˆ¶æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
        }
    }
}

// è²¡å‹™å ±è¡¨åŠŸèƒ½
        let currentFinancialTabType = 'summary';
        
        // è¼‰å…¥è²¡å‹™å ±è¡¨é é¢
        function loadFinancialReports() {
            // è¨­ç½®é è¨­æ—¥æœŸç¯„åœï¼ˆæœ¬æœˆï¼‰
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            document.getElementById('startDate').value = formatFinancialDate(firstDayOfMonth);
            document.getElementById('endDate').value = formatFinancialDate(lastDayOfMonth);
            
            // è¼‰å…¥é†«å¸«é¸é …
            loadFinancialDoctorOptions();
            
            // ç”Ÿæˆåˆå§‹å ±è¡¨
            generateFinancialReport();
        }

        // æ ¼å¼åŒ–æ—¥æœŸç‚º YYYY-MM-DD
        function formatFinancialDate(date) {
            return date.toISOString().split('T')[0];
        }

        // è¼‰å…¥é†«å¸«é¸é …
        function loadFinancialDoctorOptions() {
            const doctorSelect = document.getElementById('doctorFilter');
            const doctors = users.filter(user => 
                user.active && user.position === 'é†«å¸«'
            );
            
            // æ¸…ç©ºç¾æœ‰é¸é …ï¼ˆä¿ç•™ã€Œå…¨éƒ¨é†«å¸«ã€ï¼‰
            doctorSelect.innerHTML = '<option value="">å…¨éƒ¨é†«å¸«</option>';
            
            // æ·»åŠ é†«å¸«é¸é …
            doctors.forEach(doctor => {
                const option = document.createElement('option');
                option.value = doctor.username;
                option.textContent = `${doctor.name}`;
                doctorSelect.appendChild(option);
            });
        }

        // å¿«é€Ÿæ—¥æœŸé¸æ“‡
        function setQuickDate() {
            const quickDate = document.getElementById('quickDate').value;
            const today = new Date();
            let startDate, endDate;

            switch (quickDate) {
                case 'today':
                    startDate = endDate = today;
                    document.getElementById('reportType').value = 'daily';
                    break;
                case 'yesterday':
                    startDate = endDate = new Date(today.getTime() - 24 * 60 * 60 * 1000);
                    document.getElementById('reportType').value = 'daily';
                    break;
                case 'thisWeek':
                    const thisWeekStart = new Date(today);
                    thisWeekStart.setDate(today.getDate() - today.getDay());
                    startDate = thisWeekStart;
                    endDate = today;
                    document.getElementById('reportType').value = 'weekly';
                    break;
                case 'lastWeek':
                    const lastWeekStart = new Date(today);
                    lastWeekStart.setDate(today.getDate() - today.getDay() - 7);
                    const lastWeekEnd = new Date(lastWeekStart);
                    lastWeekEnd.setDate(lastWeekStart.getDate() + 6);
                    startDate = lastWeekStart;
                    endDate = lastWeekEnd;
                    document.getElementById('reportType').value = 'weekly';
                    break;
                case 'thisMonth':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    document.getElementById('reportType').value = 'monthly';
                    break;
                case 'lastMonth':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                    document.getElementById('reportType').value = 'monthly';
                    break;
                case 'thisYear':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = new Date(today.getFullYear(), 11, 31);
                    document.getElementById('reportType').value = 'yearly';
                    break;
                case 'lastYear':
                    startDate = new Date(today.getFullYear() - 1, 0, 1);
                    endDate = new Date(today.getFullYear() - 1, 11, 31);
                    document.getElementById('reportType').value = 'yearly';
                    break;
                default:
                    return;
            }

            if (startDate && endDate) {
                document.getElementById('startDate').value = formatFinancialDate(startDate);
                document.getElementById('endDate').value = formatFinancialDate(endDate);
                generateFinancialReport();
            }
        }

        // è§£ææ”¶è²»é …ç›®æ–‡æœ¬
        function parseFinancialBillingItems(billingText) {
            const items = [];
            const lines = billingText.split('\n');
            let totalAmount = 0;

            lines.forEach(line => {
                line = line.trim();
                if (!line || line.includes('å°è¨ˆ') || line.includes('ç¸½è²»ç”¨')) {
                    // æå–ç¸½è²»ç”¨
                    if (line.includes('ç¸½è²»ç”¨')) {
                        const match = line.match(/\$(\d+)/);
                        if (match) {
                            totalAmount = parseInt(match[1]);
                        }
                    }
                    return;
                }

                // è§£ææ”¶è²»é …ç›®æ ¼å¼ï¼šé …ç›®å xæ•¸é‡ = $é‡‘é¡ æˆ– é …ç›®å xæ•¸é‡ = -$é‡‘é¡
                const itemMatch = line.match(/^(.+?)\s+x(\d+)\s+=\s+([\-\$]?\d+)$/);
                if (itemMatch) {
                    const itemName = itemMatch[1].trim();
                    const quantity = parseInt(itemMatch[2]);
                    const amount = parseInt(itemMatch[3].replace(/[\-\$]/g, ''));
                    const isDiscount = itemMatch[3].includes('-');

                    items.push({
                        name: itemName,
                        quantity: quantity,
                        unitPrice: Math.abs(amount / quantity),
                        totalAmount: isDiscount ? -amount : amount,
                        category: getFinancialCategoryFromItemName(itemName)
                    });
                }
            });

            return { items, totalAmount };
        }

        // æ ¹æ“šé …ç›®åç¨±æ¨æ–·é¡åˆ¥
        function getFinancialCategoryFromItemName(itemName) {
            if (itemName.includes('è¨ºé‡‘') || itemName.includes('è¨ºç™‚') || itemName.includes('è¤‡è¨º')) {
                return 'consultation';
            } else if (itemName.includes('è—¥') || itemName.includes('ä¸­è—¥') || itemName.includes('èª¿åŠ‘')) {
                return 'medicine';
            } else if (itemName.includes('é‡ç¸') || itemName.includes('æ¨æ‹¿') || itemName.includes('æ‹”ç½') || itemName.includes('åˆ®ç—§') || itemName.includes('è‰¾ç¸')) {
                return 'treatment';
            } else if (itemName.includes('æŠ˜æ‰£') || itemName.includes('å„ªæƒ ')) {
                return 'discount';
            } else if (itemName.includes('å¥—ç¥¨') || itemName.includes('å¥—é¤') || itemName.includes('ç™‚ç¨‹') || itemName.includes('æ–¹æ¡ˆ')) {
                return 'package';
            } else {
                return 'other';
            }
        }

        // ç”Ÿæˆè²¡å‹™å ±è¡¨
        function generateFinancialReport() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const doctorFilter = document.getElementById('doctorFilter').value;
            const reportType = document.getElementById('reportType').value;

            if (!startDate || !endDate) {
                showToast('è«‹é¸æ“‡æ—¥æœŸç¯„åœï¼', 'error');
                return;
            }

            // éæ¿¾è¨ºç—‡è³‡æ–™
            const filteredConsultations = filterFinancialConsultations(startDate, endDate, doctorFilter);
            
            // è¨ˆç®—çµ±è¨ˆè³‡æ–™
            const stats = calculateFinancialStatistics(filteredConsultations);
            
            // æ›´æ–°é—œéµæŒ‡æ¨™
            updateFinancialKeyMetrics(stats);
            
            // æ›´æ–°è¡¨æ ¼
            updateFinancialTables(filteredConsultations, stats);
            
            // æ›´æ–°æ™‚é–“
            document.getElementById('lastUpdateTime').textContent = new Date().toLocaleString('zh-TW');
            
            showToast('è²¡å‹™å ±è¡¨å·²æ›´æ–°ï¼', 'success');
        }

        // éæ¿¾è¨ºç—‡è³‡æ–™
        function filterFinancialConsultations(startDate, endDate, doctorFilter) {
            const start = new Date(startDate);
            const end = new Date(endDate + 'T23:59:59.999Z');

            return consultations.filter(consultation => {
                const consultationDate = new Date(consultation.date);
                const dateInRange = consultationDate >= start && consultationDate <= end;
                const doctorMatch = !doctorFilter || consultation.doctor === doctorFilter;
                const isCompleted = consultation.status === 'completed';

                return dateInRange && doctorMatch && isCompleted;
            });
        }

        // è¨ˆç®—è²¡å‹™çµ±è¨ˆè³‡æ–™
        function calculateFinancialStatistics(consultations) {
            let totalRevenue = 0;
            let totalConsultations = consultations.length;
            const doctorStats = {};
            const serviceStats = {};
            const dailyStats = {};

            consultations.forEach(consultation => {
                const parsed = parseFinancialBillingItems(consultation.billingItems || '');
                const consultationRevenue = parsed.totalAmount;
                totalRevenue += consultationRevenue;

                // é†«å¸«çµ±è¨ˆ
                if (!doctorStats[consultation.doctor]) {
                    doctorStats[consultation.doctor] = {
                        count: 0,
                        revenue: 0
                    };
                }
                doctorStats[consultation.doctor].count += 1;
                doctorStats[consultation.doctor].revenue += consultationRevenue;

                // æœå‹™çµ±è¨ˆ
                parsed.items.forEach(item => {
                    if (!serviceStats[item.category]) {
                        serviceStats[item.category] = {
                            name: getFinancialCategoryDisplayName(item.category),
                            count: 0,
                            revenue: 0,
                            items: []
                        };
                    }
                    serviceStats[item.category].count += item.quantity;
                    serviceStats[item.category].revenue += item.totalAmount;
                    serviceStats[item.category].items.push(item);
                });

                // æ¯æ—¥çµ±è¨ˆ
                const dateKey = consultation.date.split('T')[0];
                if (!dailyStats[dateKey]) {
                    dailyStats[dateKey] = {
                        count: 0,
                        revenue: 0,
                        services: {}
                    };
                }
                dailyStats[dateKey].count += 1;
                dailyStats[dateKey].revenue += consultationRevenue;
            });

            const averageRevenue = totalConsultations > 0 ? totalRevenue / totalConsultations : 0;
            const activeDoctors = Object.keys(doctorStats).length;

            return {
                totalRevenue,
                totalConsultations,
                averageRevenue,
                activeDoctors,
                doctorStats,
                serviceStats,
                dailyStats
            };
        }

        // ç²å–é¡åˆ¥é¡¯ç¤ºåç¨±
        function getFinancialCategoryDisplayName(category) {
            const names = {
                consultation: 'è¨ºç™‚è²»',
                medicine: 'è—¥è²»',
                treatment: 'æ²»ç™‚è²»',
                other: 'å…¶ä»–è²»ç”¨',
                discount: 'æŠ˜æ‰£',
                package: 'å¥—ç¥¨é …ç›®'
            };
            return names[category] || category;
        }

        // æ›´æ–°é—œéµæŒ‡æ¨™
        function updateFinancialKeyMetrics(stats) {
            document.getElementById('totalRevenue').textContent = `$${stats.totalRevenue.toLocaleString()}`;
            document.getElementById('totalConsultations').textContent = stats.totalConsultations.toLocaleString();
            document.getElementById('averageRevenue').textContent = `$${Math.round(stats.averageRevenue).toLocaleString()}`;
            document.getElementById('activeDoctors').textContent = stats.activeDoctors;
        }

        // æ›´æ–°è²¡å‹™è¡¨æ ¼
        function updateFinancialTables(consultations, stats) {
            updateFinancialSummaryTable(stats);
            updateFinancialDailyTable(stats.dailyStats);
            updateFinancialDoctorTable(stats.doctorStats);
            updateFinancialServiceTable(stats.serviceStats);
        }

        // æ›´æ–°æ”¶å…¥æ‘˜è¦è¡¨æ ¼
        function updateFinancialSummaryTable(stats) {
            const tbody = document.getElementById('financialSummaryTableBody');
            const summaryData = [
                { item: 'è¨ºç™‚è²»æ”¶å…¥', amount: 0, category: 'consultation' },
                { item: 'è—¥è²»æ”¶å…¥', amount: 0, category: 'medicine' },
                { item: 'æ²»ç™‚è²»æ”¶å…¥', amount: 0, category: 'treatment' },
                { item: 'å…¶ä»–æ”¶å…¥', amount: 0, category: 'other' },
                { item: 'å¥—ç¥¨æ”¶å…¥', amount: 0, category: 'package' }
            ];

            // è¨ˆç®—å„é¡åˆ¥æ”¶å…¥
            Object.keys(stats.serviceStats).forEach(category => {
                const stat = stats.serviceStats[category];
                const summaryItem = summaryData.find(item => item.category === category);
                if (summaryItem) {
                    summaryItem.amount = stat.revenue;
                }
            });

            const totalRevenue = stats.totalRevenue;

            tbody.innerHTML = summaryData.map(item => {
                const percentage = totalRevenue > 0 ? ((item.amount / totalRevenue) * 100).toFixed(1) : '0';
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm text-gray-900">${item.item}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-right font-medium">$${item.amount.toLocaleString()}</td>
                        <td class="px-4 py-3 text-sm text-gray-600 text-right">${percentage}%</td>
                        <td class="px-4 py-3 text-sm text-gray-500 text-right">çµ±è¨ˆæœŸé–“</td>
                    </tr>
                `;
            }).join('');
        }

        // æ›´æ–°æ¯æ—¥æ˜ç´°è¡¨æ ¼
        function updateFinancialDailyTable(dailyStats) {
            const tbody = document.getElementById('financialDailyTableBody');
            const sortedDates = Object.keys(dailyStats).sort().reverse();

            if (sortedDates.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                            é¸å®šæœŸé–“å…§æ²’æœ‰è¨ºç—‡è¨˜éŒ„
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = sortedDates.map(date => {
                const stat = dailyStats[date];
                const averageDaily = stat.count > 0 ? Math.round(stat.revenue / stat.count) : 0;
                const formattedDate = new Date(date + 'T00:00:00').toLocaleDateString('zh-TW');

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm text-gray-900">${formattedDate}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-right">${stat.count}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-right font-medium">$${stat.revenue.toLocaleString()}</td>
                        <td class="px-4 py-3 text-sm text-gray-600 text-right">$${averageDaily.toLocaleString()}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">è¨ºç™‚ã€è—¥è²»</td>
                    </tr>
                `;
            }).join('');
        }

        // æ›´æ–°é†«å¸«æ¥­ç¸¾è¡¨æ ¼
        function updateFinancialDoctorTable(doctorStats) {
            const tbody = document.getElementById('financialDoctorTableBody');
            const totalRevenue = Object.values(doctorStats).reduce((sum, stat) => sum + stat.revenue, 0);

            if (Object.keys(doctorStats).length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                            é¸å®šæœŸé–“å…§æ²’æœ‰é†«å¸«è¨ºç—‡è¨˜éŒ„
                        </td>
                    </tr>
                `;
                return;
            }

            const sortedDoctors = Object.entries(doctorStats).sort(([,a], [,b]) => b.revenue - a.revenue);

            tbody.innerHTML = sortedDoctors.map(([doctorUsername, stat]) => {
                const percentage = totalRevenue > 0 ? ((stat.revenue / totalRevenue) * 100).toFixed(1) : '0';
                const average = stat.count > 0 ? Math.round(stat.revenue / stat.count) : 0;
                const doctorName = getDoctorDisplayName(doctorUsername);

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm text-gray-900">${doctorName}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-right">${stat.count}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-right font-medium">$${stat.revenue.toLocaleString()}</td>
                        <td class="px-4 py-3 text-sm text-gray-600 text-right">$${average.toLocaleString()}</td>
                        <td class="px-4 py-3 text-sm text-gray-600 text-right">${percentage}%</td>
                    </tr>
                `;
            }).join('');
        }

        // æ›´æ–°æœå‹™åˆ†æè¡¨æ ¼
        function updateFinancialServiceTable(serviceStats) {
            const tbody = document.getElementById('financialServiceTableBody');
            const totalRevenue = Object.values(serviceStats).reduce((sum, stat) => sum + stat.revenue, 0);

            if (Object.keys(serviceStats).length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                            é¸å®šæœŸé–“å…§æ²’æœ‰æœå‹™è¨˜éŒ„
                        </td>
                    </tr>
                `;
                return;
            }

            const sortedServices = Object.entries(serviceStats).sort(([,a], [,b]) => b.revenue - a.revenue);

            tbody.innerHTML = sortedServices.map(([category, stat]) => {
                const percentage = totalRevenue > 0 ? ((stat.revenue / totalRevenue) * 100).toFixed(1) : '0';
                const average = stat.count > 0 ? Math.round(stat.revenue / stat.count) : 0;

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm text-gray-900">${stat.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-right">${stat.count}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-right font-medium">$${stat.revenue.toLocaleString()}</td>
                        <td class="px-4 py-3 text-sm text-gray-600 text-right">$${average.toLocaleString()}</td>
                        <td class="px-4 py-3 text-sm text-gray-600 text-right">${percentage}%</td>
                    </tr>
                `;
            }).join('');
        }

        // åˆ‡æ›è²¡å‹™æ¨™ç±¤
        function switchFinancialTab(tabType) {
            // æ›´æ–°æ¨™ç±¤æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('[role="tablist"] button').forEach(btn => {
                if (btn.id && btn.id.startsWith('financial')) {
                    btn.className = 'py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm transition duration-200';
                }
            });
            
            document.getElementById(`financial${tabType.charAt(0).toUpperCase() + tabType.slice(1)}Tab`).className = 'py-4 px-1 border-b-2 border-green-500 text-green-600 font-medium text-sm transition duration-200';

            // éš±è—æ‰€æœ‰æ¨™ç±¤å…§å®¹
            document.querySelectorAll('.financial-tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤å…§å®¹
            document.getElementById(`financial${tabType.charAt(0).toUpperCase() + tabType.slice(1)}Content`).classList.remove('hidden');
            
            currentFinancialTabType = tabType;
        }

        // åŒ¯å‡ºè²¡å‹™å ±è¡¨
        function exportFinancialReport() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const reportType = document.getElementById('reportType').value;
            
            // æº–å‚™åŒ¯å‡ºè³‡æ–™
            const reportData = {
                reportInfo: {
                    title: `è²¡å‹™å ±è¡¨ - ${reportType}`,
                    period: `${startDate} è‡³ ${endDate}`,
                    generatedAt: new Date().toLocaleString('zh-TW')
                },
                summary: {
                    totalRevenue: document.getElementById('totalRevenue').textContent,
                    totalConsultations: document.getElementById('totalConsultations').textContent,
                    averageRevenue: document.getElementById('averageRevenue').textContent,
                    activeDoctors: document.getElementById('activeDoctors').textContent
                }
            };

            // è½‰æ›ç‚º JSON å­—ç¬¦ä¸²
            const jsonString = JSON.stringify(reportData, null, 2);
            
            // å‰µå»ºä¸‹è¼‰
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `è²¡å‹™å ±è¡¨_${startDate}_${endDate}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast('è²¡å‹™å ±è¡¨å·²åŒ¯å‡ºï¼', 'success');
        }

// æ·»åŠ èªéŸ³é€šçŸ¥åŠŸèƒ½
function playNotificationSound() {
    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMeCSGS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMeCSGS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMeCSGS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMeCSGS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMeCSGS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMeCSGS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMeCSGS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMeCSGS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMeCSGS1/LNeSs=');
    audio.play().catch(console.error);
}

// æ·»åŠ å¯¦æ™‚çµ±è¨ˆæ›´æ–°
function createRealtimeDashboard() {
    // åœ¨æ­¡è¿é é¢æ·»åŠ å¯¦æ™‚çµ±è¨ˆ
    const welcomePage = document.getElementById('welcomePage');
    const dashboard = document.createElement('div');
    dashboard.innerHTML = `
        <div class="bg-white rounded-xl shadow-lg p-6 mt-8">
            <h3 class="text-xl font-semibold mb-4">å¯¦æ™‚è¨ºæ‰€ç‹€æ…‹</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="text-center p-4 bg-blue-50 rounded-lg">
                    <div class="text-2xl font-bold text-blue-600" id="realtimeOnline">0</div>
                    <div class="text-sm text-blue-800">åœ¨ç·šç”¨æˆ¶</div>
                </div>
                <div class="text-center p-4 bg-yellow-50 rounded-lg">
                    <div class="text-2xl font-bold text-yellow-600" id="realtimeWaiting">0</div>
                    <div class="text-sm text-yellow-800">å€™è¨ºä¸­</div>
                </div>
                <div class="text-center p-4 bg-green-50 rounded-lg">
                    <div class="text-2xl font-bold text-green-600" id="realtimeConsulting">0</div>
                    <div class="text-sm text-green-800">è¨ºç—‡ä¸­</div>
                </div>
                <div class="text-center p-4 bg-purple-50 rounded-lg">
                    <div class="text-2xl font-bold text-purple-600" id="realtimeCompleted">0</div>
                    <div class="text-sm text-purple-800">ä»Šæ—¥å®Œæˆ</div>
                </div>
            </div>
        </div>
    `;
    welcomePage.appendChild(dashboard);
}
        
        // å¥—ç¥¨ç®¡ç†å‡½å¼
        function getPatientPackagesStore() {
            return JSON.parse(localStorage.getItem('patientPackages') || '[]');
        }
        function setPatientPackagesStore(list) {
            localStorage.setItem('patientPackages', JSON.stringify(list));
        }
        function getPatientPackages(patientId) {
            const all = getPatientPackagesStore();
            return all.filter(p => p.patientId === patientId);
        }
        function purchasePackage(patientId, item) {
            const totalUses = Number(item.packageUses || item.totalUses || 0);
            const validityDays = Number(item.validityDays || 0);
            const purchasedAt = new Date();
            const expiresAt = new Date(purchasedAt);
            expiresAt.setDate(expiresAt.getDate() + validityDays);
            const record = {
                id: Date.now(),
                patientId: patientId,
                packageItemId: item.id,
                name: item.name,
                totalUses: totalUses,
                remainingUses: totalUses,
                purchasedAt: purchasedAt.toISOString(),
                expiresAt: expiresAt.toISOString()
            };
            const all = getPatientPackagesStore();
            all.push(record);
            setPatientPackagesStore(all);
            return record;
        }
        function consumePackage(patientId, packageRecordId) {
            const all = getPatientPackagesStore();
            const idx = all.findIndex(p => p.id === packageRecordId && p.patientId === patientId);
            if (idx === -1) return { ok: false, msg: 'æ‰¾ä¸åˆ°å¥—ç¥¨' };
            const now = new Date();
            const exp = new Date(all[idx].expiresAt);
            if (now > exp) return { ok: false, msg: 'å¥—ç¥¨å·²éæœŸ' };
            if (all[idx].remainingUses <= 0) return { ok: false, msg: 'å¥—ç¥¨å·²ç”¨å®Œ' };
            all[idx].remainingUses -= 1;
            setPatientPackagesStore(all);
            return { ok: true, record: all[idx] };
        }
        function formatPackageStatus(pkg) {
            const exp = new Date(pkg.expiresAt);
            const now = new Date();
            const daysLeft = Math.ceil((exp - now) / (1000*60*60*24));
            const expired = daysLeft < 0;
            return expired
              ? `å·²åˆ°æœŸï¼ˆ${exp.toLocaleDateString('zh-TW')}ï¼‰`
              : `å‰©é¤˜ ${pkg.remainingUses}/${pkg.totalUses} æ¬¡ Â· ${exp.toLocaleDateString('zh-TW')} åˆ°æœŸï¼ˆç´„ ${daysLeft} å¤©ï¼‰`;
        }
        function renderPatientPackages(patientId) {
            const container = document.getElementById('patientPackagesList');
            if (!container) return;
            // åƒ…é¡¯ç¤ºå‰©é¤˜æ¬¡æ•¸å¤§æ–¼ 0 çš„å¥—ç¥¨ï¼ˆå·²ç”¨å®Œçš„å¥—ç¥¨ä¸åœ¨è¨ºç—‡è¨˜éŒ„é¡¯ç¤ºï¼‰
            const pkgs = getPatientPackages(patientId).filter(p => p.remainingUses > 0).sort((a,b)=> new Date(a.expiresAt)-new Date(b.expiresAt));
            if (pkgs.length === 0) {
                container.innerHTML = '<div class="text-gray-500">ç„¡å·²è³¼è²·çš„å¥—ç¥¨</div>';
                return;
            }
            container.innerHTML = pkgs.map(pkg => {
                const exp = new Date(pkg.expiresAt);
                const now = new Date();
                const expired = now > exp;
                const disabled = expired || pkg.remainingUses <= 0;
                const badge =
                  expired ? '<span class="ml-2 text-xs text-white px-2 py-0.5 rounded bg-red-500">å·²åˆ°æœŸ</span>' :
                  (pkg.remainingUses <= 0 ? '<span class="ml-2 text-xs text-white px-2 py-0.5 rounded bg-gray-500">å·²ç”¨å®Œ</span>' : '');
                return `
      <div class="flex items-center justify-between bg-white border border-purple-200 rounded p-2">
        <div>
          <div class="font-medium text-purple-900">${pkg.name}${badge}</div>
          <div class="text-xs text-gray-600">${formatPackageStatus(pkg)}</div>
        </div>
        <button type="button" ${disabled ? 'disabled' : ''} 
          onclick="useOnePackage(${pkg.patientId}, ${pkg.id})"
          class="px-3 py-1 rounded ${disabled ? 'bg-gray-300 text-gray-600' : 'bg-purple-600 text-white hover:bg-purple-700'}">
          ä½¿ç”¨ä¸€æ¬¡
        </button>
      </div>
    `;
            }).join('');
        }
        function refreshPatientPackagesUI() {
            const appointment = appointments.find(apt => apt.id === currentConsultingAppointmentId);
            if (!appointment) return;
            renderPatientPackages(appointment.patientId);
        }
        function useOnePackage(patientId, packageRecordId) {
            const res = consumePackage(patientId, packageRecordId);
            if (!res.ok) {
                showToast(res.msg || 'å¥—ç¥¨ä¸å¯ç”¨', 'warning');
                return;
            }
            const usedName = `${res.record.name}ï¼ˆä½¿ç”¨å¥—ç¥¨ï¼‰`;
            // åœ¨æ¨å…¥å¥—ç¥¨ä½¿ç”¨ç´€éŒ„æ™‚ï¼Œé¡å¤–å­˜å…¥ patientId èˆ‡ packageRecordIdï¼Œæ–¹ä¾¿å¾ŒçºŒå–æ¶ˆ
            selectedBillingItems.push({
                id: `use-${res.record.id}-${Date.now()}`,
                name: usedName,
                category: 'packageUse',
                price: 0,
                unit: 'æ¬¡',
                description: 'å¥—ç¥¨æŠµæ‰£ä¸€æ¬¡',
                quantity: 1,
                patientId: patientId,
                packageRecordId: res.record.id
            });
            updateBillingDisplay();
            refreshPatientPackagesUI();
            showToast(`å·²ä½¿ç”¨å¥—ç¥¨ï¼š${res.record.name}ï¼Œå‰©é¤˜ ${res.record.remainingUses} æ¬¡`, 'success');
        }

        // å–æ¶ˆä¸€æ¬¡å¥—ç¥¨ä½¿ç”¨ï¼šé€€å›å‰©é¤˜æ¬¡æ•¸ä¸¦ç§»é™¤è©²ç­†ä½¿ç”¨ç´€éŒ„
        function undoPackageUse(patientId, packageRecordId, usageItemId) {
            // è®€å–æ‰€æœ‰ç—…äººå¥—ç¥¨ç´€éŒ„
            const all = getPatientPackagesStore();
            // æ‰¾åˆ°å°æ‡‰å¥—ç¥¨ç´¢å¼•
            const idx = all.findIndex(p => p.id === packageRecordId && p.patientId === patientId);
            if (idx === -1) {
                showToast('æ‰¾ä¸åˆ°å°æ‡‰çš„å¥—ç¥¨ï¼Œç„¡æ³•å–æ¶ˆ', 'warning');
                return;
            }
            // å¢åŠ å‰©é¤˜æ¬¡æ•¸
            all[idx].remainingUses += 1;
            setPatientPackagesStore(all);
            // ç§»é™¤è©²ç­† $0 ä½¿ç”¨ç´€éŒ„
            selectedBillingItems = selectedBillingItems.filter(it => it.id !== usageItemId);
            // æ›´æ–°é¡¯ç¤º
            updateBillingDisplay();
            if (typeof refreshPatientPackagesUI === 'function') {
                refreshPatientPackagesUI();
            }
            showToast('å·²å–æ¶ˆæœ¬æ¬¡å¥—ç¥¨ä½¿ç”¨ï¼Œæ¬¡æ•¸å·²é€€å›', 'success');
        }

        // ç—…äººè©³ç´°è³‡æ–™å¥—ç¥¨åˆ†é é¡¯ç¤ºçš„è®Šæ•¸èˆ‡å‡½å¼
        let currentPatientPackages = [];
        let currentPatientPackagePage = 0;
        const PACKAGES_PER_PAGE = 5;
        function renderPatientPackagesDetailPage() {
            const start = currentPatientPackagePage * PACKAGES_PER_PAGE;
            const end = start + PACKAGES_PER_PAGE;
            const pkgs = currentPatientPackages.slice(start, end);
            let html = '';
            pkgs.forEach(function(pkg) {
                const purchased = new Date(pkg.purchasedAt);
                const exp = new Date(pkg.expiresAt);
                const now = new Date();
                const expired = now > exp;
                const status = expired ? '<span class="text-red-600">å·²åˆ°æœŸ</span>' :
                    (pkg.remainingUses <= 0 ? '<span class="text-gray-600">å·²ç”¨å®Œ</span>' :
                        '<span class="text-green-600">å‰©é¤˜ ' + pkg.remainingUses + '/' + pkg.totalUses + '</span>');
                html += '<div class="flex justify-between items-start bg-purple-50 border border-purple-200 rounded p-2">';
                html += '<div>';
                html += '<div class="font-medium text-purple-900">' + pkg.name + '</div>';
                html += '<div class="text-xs text-gray-600">è³¼è²·æ—¥ï¼š' + purchased.toLocaleDateString("zh-TW") + ' Â· åˆ°æœŸæ—¥ï¼š' + exp.toLocaleDateString("zh-TW") + '</div>';
                html += '<div class="text-xs text-gray-600">å‰©é¤˜æ¬¡æ•¸ï¼š' + pkg.remainingUses + '/' + pkg.totalUses + '</div>';
                html += '</div>';
                html += '<div class="mt-1">' + status + '</div>';
                html += '</div>';
            });
            const totalPages = Math.ceil(currentPatientPackages.length / PACKAGES_PER_PAGE);
            if (totalPages > 1) {
                html += '<div class="flex justify-end space-x-2 mt-2">';
                const prevDisabled = currentPatientPackagePage <= 0;
                const nextDisabled = currentPatientPackagePage >= totalPages - 1;
                html += '<button type="button" ' + (prevDisabled ? 'disabled' : '') + ' onclick="changePatientPackagePage(-1)" class="px-2 py-1 bg-gray-200 text-gray-700 rounded ' + (prevDisabled ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-300') + '">ä¸Šä¸€é </button>';
                html += '<button type="button" ' + (nextDisabled ? 'disabled' : '') + ' onclick="changePatientPackagePage(1)" class="px-2 py-1 bg-gray-200 text-gray-700 rounded ' + (nextDisabled ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-300') + '">ä¸‹ä¸€é </button>';
                html += '</div>';
            }
            return html;
        }
        function changePatientPackagePage(delta) {
            const totalPages = Math.ceil(currentPatientPackages.length / PACKAGES_PER_PAGE);
            currentPatientPackagePage = Math.min(Math.max(currentPatientPackagePage + delta, 0), totalPages - 1);
            const container = document.getElementById('patientPackagesDetailList');
            if (container) {
                container.innerHTML = renderPatientPackagesDetailPage();
            }
        }

// Firebase æ•¸æ“šç®¡ç†ç³»çµ±
class FirebaseDataManager {
    constructor() {
        this.isReady = false;
        this.initializeWhenReady();
    }

    async initializeWhenReady() {
        // ç­‰å¾… Firebase åˆå§‹åŒ–
        while (!window.firebase) {
            await new Promise(resolve => setTimeout(resolve, 100));
        }
        this.isReady = true;
        console.log('Firebase æ•¸æ“šç®¡ç†å™¨å·²æº–å‚™å°±ç·’');
    }

    // ç—…äººæ•¸æ“šç®¡ç†
    async addPatient(patientData) {
        if (!this.isReady) {
            showToast('æ•¸æ“šç®¡ç†å™¨å°šæœªæº–å‚™å°±ç·’', 'error');
            return { success: false };
        }

        try {
            const docRef = await window.firebase.addDoc(
                window.firebase.collection(window.firebase.db, 'patients'),
                {
                    ...patientData,
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    createdBy: currentUser || 'system'
                }
            );
            
            console.log('ç—…äººæ•¸æ“šå·²æ·»åŠ åˆ° Firebase:', docRef.id);
            return { success: true, id: docRef.id };
        } catch (error) {
            console.error('æ·»åŠ ç—…äººæ•¸æ“šå¤±æ•—:', error);
            showToast('ä¿å­˜ç—…äººæ•¸æ“šå¤±æ•—', 'error');
            return { success: false, error: error.message };
        }
    }

    async getPatients() {
        if (!this.isReady) return { success: false, data: [] };

        try {
            const querySnapshot = await window.firebase.getDocs(
                window.firebase.collection(window.firebase.db, 'patients')
            );
            
            const patients = [];
            querySnapshot.forEach((doc) => {
                patients.push({ id: doc.id, ...doc.data() });
            });
            
            console.log('å·²å¾ Firebase è®€å–ç—…äººæ•¸æ“š:', patients.length, 'ç­†');
            return { success: true, data: patients };
        } catch (error) {
            console.error('è®€å–ç—…äººæ•¸æ“šå¤±æ•—:', error);
            return { success: false, data: [] };
        }
    }

    async updatePatient(patientId, patientData) {
        try {
            await window.firebase.updateDoc(
                window.firebase.doc(window.firebase.db, 'patients', patientId),
                {
                    ...patientData,
                    updatedAt: new Date(),
                    updatedBy: currentUser || 'system'
                }
            );
            return { success: true };
        } catch (error) {
            console.error('æ›´æ–°ç—…äººæ•¸æ“šå¤±æ•—:', error);
            return { success: false, error: error.message };
        }
    }

    async deletePatient(patientId) {
        try {
            await window.firebase.deleteDoc(
                window.firebase.doc(window.firebase.db, 'patients', patientId)
            );
            return { success: true };
        } catch (error) {
            console.error('åˆªé™¤ç—…äººæ•¸æ“šå¤±æ•—:', error);
            return { success: false, error: error.message };
        }
    }
// è¨ºç—‡è¨˜éŒ„ç®¡ç†
    async addConsultation(consultationData) {
        if (!this.isReady) {
            showToast('æ•¸æ“šç®¡ç†å™¨å°šæœªæº–å‚™å°±ç·’', 'error');
            return { success: false };
        }

        try {
            const docRef = await window.firebase.addDoc(
                window.firebase.collection(window.firebase.db, 'consultations'),
                {
                    ...consultationData,
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    createdBy: currentUser
                }
            );
            
            console.log('è¨ºç—‡è¨˜éŒ„å·²æ·»åŠ åˆ° Firebase:', docRef.id);
            return { success: true, id: docRef.id };
        } catch (error) {
            console.error('æ·»åŠ è¨ºç—‡è¨˜éŒ„å¤±æ•—:', error);
            showToast('ä¿å­˜è¨ºç—‡è¨˜éŒ„å¤±æ•—', 'error');
            return { success: false, error: error.message };
        }
    }

    async getConsultations() {
        if (!this.isReady) return { success: false, data: [] };

        try {
            const querySnapshot = await window.firebase.getDocs(
                window.firebase.collection(window.firebase.db, 'consultations')
            );
            
            const consultations = [];
            querySnapshot.forEach((doc) => {
                consultations.push({ id: doc.id, ...doc.data() });
            });
            
            console.log('å·²å¾ Firebase è®€å–è¨ºç—‡è¨˜éŒ„:', consultations.length, 'ç­†');
            return { success: true, data: consultations };
        } catch (error) {
            console.error('è®€å–è¨ºç—‡è¨˜éŒ„å¤±æ•—:', error);
            return { success: false, data: [] };
        }
    }

    async updateConsultation(consultationId, consultationData) {
        try {
            await window.firebase.updateDoc(
                window.firebase.doc(window.firebase.db, 'consultations', consultationId),
                {
                    ...consultationData,
                    updatedAt: new Date(),
                    updatedBy: currentUser
                }
            );
            return { success: true };
        } catch (error) {
            console.error('æ›´æ–°è¨ºç—‡è¨˜éŒ„å¤±æ•—:', error);
            return { success: false, error: error.message };
        }
    }

    async getPatientConsultations(patientId) {
        if (!this.isReady) return { success: false, data: [] };

        try {
            const allConsultations = await this.getConsultations();
            if (!allConsultations.success) {
                return { success: false, data: [] };
            }

            const patientConsultations = allConsultations.data
                .filter(consultation => consultation.patientId === patientId)
                .sort((a, b) => {
                    const dateA = a.date ? new Date(a.date.seconds * 1000) : new Date(a.createdAt.seconds * 1000);
                    const dateB = b.date ? new Date(b.date.seconds * 1000) : new Date(b.createdAt.seconds * 1000);
                    return dateB - dateA; // æœ€æ–°çš„åœ¨å‰é¢
                });

            return { success: true, data: patientConsultations };
        } catch (error) {
            console.error('è®€å–ç—…äººè¨ºç—‡è¨˜éŒ„å¤±æ•—:', error);
            return { success: false, data: [] };
        }
    }
    // ç”¨æˆ¶æ•¸æ“šç®¡ç†
    async addUser(userData) {
        if (!this.isReady) {
            showToast('æ•¸æ“šç®¡ç†å™¨å°šæœªæº–å‚™å°±ç·’', 'error');
            return { success: false };
        }

        try {
            const docRef = await window.firebase.addDoc(
                window.firebase.collection(window.firebase.db, 'users'),
                {
                    ...userData,
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    createdBy: currentUser || 'system'
                }
            );
            
            console.log('ç”¨æˆ¶æ•¸æ“šå·²æ·»åŠ åˆ° Firebase:', docRef.id);
            return { success: true, id: docRef.id };
        } catch (error) {
            console.error('æ·»åŠ ç”¨æˆ¶æ•¸æ“šå¤±æ•—:', error);
            showToast('ä¿å­˜ç”¨æˆ¶æ•¸æ“šå¤±æ•—', 'error');
            return { success: false, error: error.message };
        }
    }

    async getUsers() {
        if (!this.isReady) return { success: false, data: [] };

        try {
            const querySnapshot = await window.firebase.getDocs(
                window.firebase.collection(window.firebase.db, 'users')
            );
            
            const users = [];
            querySnapshot.forEach((doc) => {
                users.push({ id: doc.id, ...doc.data() });
            });
            
            console.log('å·²å¾ Firebase è®€å–ç”¨æˆ¶æ•¸æ“š:', users.length, 'ç­†');
            return { success: true, data: users };
        } catch (error) {
            console.error('è®€å–ç”¨æˆ¶æ•¸æ“šå¤±æ•—:', error);
            return { success: false, data: [] };
        }
    }

    async updateUser(userId, userData) {
        try {
            await window.firebase.updateDoc(
                window.firebase.doc(window.firebase.db, 'users', userId),
                {
                    ...userData,
                    updatedAt: new Date(),
                    updatedBy: currentUser || 'system'
                }
            );
            return { success: true };
        } catch (error) {
            console.error('æ›´æ–°ç”¨æˆ¶æ•¸æ“šå¤±æ•—:', error);
            return { success: false, error: error.message };
        }
    }

    async deleteUser(userId) {
        try {
            await window.firebase.deleteDoc(
                window.firebase.doc(window.firebase.db, 'users', userId)
            );
            return { success: true };
        } catch (error) {
            console.error('åˆªé™¤ç”¨æˆ¶æ•¸æ“šå¤±æ•—:', error);
            return { success: false, error: error.message };
        }
    }
}

// åˆå§‹åŒ–æ•¸æ“šç®¡ç†å™¨
let firebaseDataManager;
window.addEventListener('load', () => {
    firebaseDataManager = new FirebaseDataManager();
    window.firebaseDataManager = firebaseDataManager; // å…¨åŸŸä½¿ç”¨
    // Firebase è³‡æ–™ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆå¾Œæ›´æ–°çµ±è¨ˆ
    updateStatistics();
});
        
// åˆå§‹åŒ–ç³»çµ±
document.addEventListener('DOMContentLoaded', function() {
    // ç³»çµ±å•Ÿå‹•æ™‚æ¸…ç©ºéæœŸæ›è™Ÿ
    clearOldAppointments();
    
    updateClinicSettingsDisplay();
    
    // åˆå§‹åŒ–æ•¸æ“šé·ç§»
    initializeDataMigration();
    
    // è‡ªå‹•èšç„¦åˆ°é›»å­éƒµä»¶è¼¸å…¥æ¡†
    const usernameInput = document.getElementById('mainLoginUsername');
    if (usernameInput) {
        setTimeout(() => {
            usernameInput.focus();
        }, 100);
    }
});

// åˆå§‹åŒ–æ•¸æ“šé·ç§»
async function initializeDataMigration() {
    // ç­‰å¾… Firebase æ•¸æ“šç®¡ç†å™¨æº–å‚™å°±ç·’
    while (!window.firebaseDataManager || !window.firebaseDataManager.isReady) {
        await new Promise(resolve => setTimeout(resolve, 500));
    }

    try {
        // æª¢æŸ¥æ˜¯å¦éœ€è¦é·ç§»ç”¨æˆ¶æ•¸æ“š
        await migrateUserDataToFirebase();
    } catch (error) {
        console.error('æ•¸æ“šé·ç§»åˆå§‹åŒ–éŒ¯èª¤:', error);
    }
}

// é·ç§»ç”¨æˆ¶æ•¸æ“šåˆ° Firebase
async function migrateUserDataToFirebase() {
    try {
        // æª¢æŸ¥ Firebase æ˜¯å¦å·²æœ‰ç”¨æˆ¶æ•¸æ“š
        const firebaseResult = await window.firebaseDataManager.getUsers();
        const hasFirebaseUsers = firebaseResult.success && firebaseResult.data.length > 0;

        // æª¢æŸ¥æœ¬åœ°æ˜¯å¦æœ‰ç”¨æˆ¶æ•¸æ“š
        const localUsers = JSON.parse(localStorage.getItem('users') || '[]');
        const hasLocalUsers = localUsers.length > 0;

        console.log(`Firebase ç”¨æˆ¶æ•¸æ“š: ${hasFirebaseUsers ? firebaseResult.data.length : 0} ç­†`);
        console.log(`æœ¬åœ°ç”¨æˆ¶æ•¸æ“š: ${hasLocalUsers ? localUsers.length : 0} ç­†`);

        if (hasLocalUsers && !hasFirebaseUsers) {
            // æœ‰æœ¬åœ°æ•¸æ“šä½† Firebase æ²’æœ‰æ•¸æ“šï¼Œé€²è¡Œé·ç§»
            console.log('é–‹å§‹é·ç§»ç”¨æˆ¶æ•¸æ“šåˆ° Firebase...');
            
            for (const user of localUsers) {
                try {
                    // ç§»é™¤æœ¬åœ° IDï¼Œè®“ Firebase ç”Ÿæˆæ–°çš„ ID
                    const { id, ...userData } = user;
                    
                    const result = await window.firebaseDataManager.addUser(userData);
                    if (result.success) {
                        console.log(`ç”¨æˆ¶ ${user.name} é·ç§»æˆåŠŸ`);
                    } else {
                        console.error(`ç”¨æˆ¶ ${user.name} é·ç§»å¤±æ•—`);
                    }
                } catch (error) {
                    console.error(`é·ç§»ç”¨æˆ¶ ${user.name} æ™‚ç™¼ç”ŸéŒ¯èª¤:`, error);
                }
            }
            
            console.log('ç”¨æˆ¶æ•¸æ“šé·ç§»å®Œæˆ');
            showToast('ç”¨æˆ¶æ•¸æ“šå·²åŒæ­¥åˆ°é›²ç«¯', 'success');
        } else if (hasFirebaseUsers) {
            // Firebase æœ‰æ•¸æ“šï¼ŒåŒæ­¥åˆ°æœ¬åœ°
            await syncUserDataFromFirebase();
        } else {
            // å…©é‚Šéƒ½æ²’æœ‰æ•¸æ“šï¼Œè¼‰å…¥é è¨­ç”¨æˆ¶æ•¸æ“š
            if (localUsers.length === 0) {
                users = defaultUsers;
                localStorage.setItem('users', JSON.stringify(users));
                
                // é·ç§»é è¨­ç”¨æˆ¶åˆ° Firebase
                for (const user of defaultUsers) {
                    try {
                        const { id, ...userData } = user;
                        await window.firebaseDataManager.addUser(userData);
                    } catch (error) {
                        console.error('é·ç§»é è¨­ç”¨æˆ¶å¤±æ•—:', error);
                    }
                }
            }
        }
    } catch (error) {
        console.error('é·ç§»ç”¨æˆ¶æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
    }
}

// Firebase Realtime Database æ•´åˆæ¨¡çµ„
// åœ¨åŸæœ‰ä»£ç¢¼ä¸­æ·»åŠ ä»¥ä¸‹å…§å®¹

class RealtimeManager {
    constructor() {
        this.isReady = false;
        this.currentSessionId = null;
        this.onlineUsersRef = null;
        this.appointmentsRef = null;
        this.consultationStatusRef = null;
        this.notificationsRef = null;
        this.listeners = new Map(); // å­˜å„²æ‰€æœ‰ç›£è½å™¨
        this.initializeWhenReady();
    }

    async initializeWhenReady() {
        // ç­‰å¾… Firebase åˆå§‹åŒ–
        while (!window.firebase || !window.firebase.rtdb) {
            await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        this.setupReferences();
        this.isReady = true;
        console.log('Realtime Database ç®¡ç†å™¨å·²æº–å‚™å°±ç·’');
    }

    setupReferences() {
        const rtdb = window.firebase.rtdb;
        
        // è¨­ç½®å„ç¨®æ•¸æ“šå¼•ç”¨
        this.onlineUsersRef = window.firebase.ref(rtdb, 'onlineUsers');
        this.appointmentsRef = window.firebase.ref(rtdb, 'appointments');
        this.consultationStatusRef = window.firebase.ref(rtdb, 'consultationStatus');
        this.notificationsRef = window.firebase.ref(rtdb, 'notifications');
        this.clinicStatusRef = window.firebase.ref(rtdb, 'clinicStatus');
    }

    // ========== åœ¨ç·šç”¨æˆ¶ç®¡ç† ==========
    
    async setUserOnline(userId, userData) {
        if (!this.isReady) return;
        
        try {
            this.currentSessionId = `${userId}_${Date.now()}`;
            const userRef = window.firebase.ref(window.firebase.rtdb, `onlineUsers/${userId}`);
            
            const onlineData = {
                sessionId: this.currentSessionId,
                name: userData.name,
                position: userData.position,
                email: userData.email,
                loginTime: new Date().toISOString(),
                lastActivity: new Date().toISOString(),
                status: 'online',
                currentAction: 'idle' // idle, consulting, managing
            };
            
            await window.firebase.set(userRef, onlineData);
            
            // è¨­ç½®é›¢ç·šæ™‚è‡ªå‹•æ¸…é™¤
            await window.firebase.set(
                window.firebase.ref(window.firebase.rtdb, `onlineUsers/${userId}`),
                window.firebase.serverTimestamp ? window.firebase.serverTimestamp() : null
            );
            
            // å®šæœŸæ›´æ–°æ´»å‹•æ™‚é–“
            this.startActivityHeartbeat(userId);
            
            console.log('ç”¨æˆ¶å·²è¨­ç½®ç‚ºåœ¨ç·š:', userId);
            return true;
        } catch (error) {
            console.error('è¨­ç½®ç”¨æˆ¶åœ¨ç·šç‹€æ…‹å¤±æ•—:', error);
            return false;
        }
    }

    async setUserOffline(userId) {
        if (!this.isReady || !userId) return;
        
        try {
            const userRef = window.firebase.ref(window.firebase.rtdb, `onlineUsers/${userId}`);
            await window.firebase.remove(userRef);
            
            // åœæ­¢æ´»å‹•å¿ƒè·³
            this.stopActivityHeartbeat();
            
            console.log('ç”¨æˆ¶å·²è¨­ç½®ç‚ºé›¢ç·š:', userId);
        } catch (error) {
            console.error('è¨­ç½®ç”¨æˆ¶é›¢ç·šç‹€æ…‹å¤±æ•—:', error);
        }
    }

    startActivityHeartbeat(userId) {
        // æ¯30ç§’æ›´æ–°ä¸€æ¬¡æ´»å‹•æ™‚é–“
        this.activityInterval = setInterval(async () => {
            if (this.isReady && userId) {
                try {
                    const userRef = window.firebase.ref(window.firebase.rtdb, `onlineUsers/${userId}/lastActivity`);
                    await window.firebase.set(userRef, new Date().toISOString());
                } catch (error) {
                    console.error('æ›´æ–°æ´»å‹•æ™‚é–“å¤±æ•—:', error);
                }
            }
        }, 30000);
    }

    stopActivityHeartbeat() {
        if (this.activityInterval) {
            clearInterval(this.activityInterval);
            this.activityInterval = null;
        }
    }

    // ç›£è½åœ¨ç·šç”¨æˆ¶è®ŠåŒ–
    subscribeToOnlineUsers(callback) {
        if (!this.isReady) return;
        
        const unsubscribe = window.firebase.onValue(this.onlineUsersRef, (snapshot) => {
            const onlineUsers = snapshot.val() || {};
            const usersList = Object.entries(onlineUsers).map(([userId, userData]) => ({
                userId,
                ...userData
            }));
            callback(usersList);
        });
        
        this.listeners.set('onlineUsers', unsubscribe);
        return unsubscribe;
    }

    // ========== æ›è™Ÿç‹€æ…‹å¯¦æ™‚åŒæ­¥ ==========
    
    async syncAppointmentToRealtime(appointment) {
        if (!this.isReady) return;
        
        try {
            const appointmentRef = window.firebase.ref(
                window.firebase.rtdb, 
                `appointments/${appointment.id}`
            );
            
            const realtimeData = {
                ...appointment,
                lastUpdated: new Date().toISOString(),
                updatedBy: currentUser
            };
            
            await window.firebase.set(appointmentRef, realtimeData);
            console.log('æ›è™Ÿè³‡æ–™å·²åŒæ­¥åˆ° Realtime Database:', appointment.id);
        } catch (error) {
            console.error('åŒæ­¥æ›è™Ÿè³‡æ–™å¤±æ•—:', error);
        }
    }

    async updateAppointmentStatus(appointmentId, status, additionalData = {}) {
        if (!this.isReady) return;
        
        try {
            const statusRef = window.firebase.ref(
                window.firebase.rtdb, 
                `appointments/${appointmentId}`
            );
            
            const updateData = {
                status: status,
                lastUpdated: new Date().toISOString(),
                updatedBy: currentUser,
                ...additionalData
            };
            
            await window.firebase.update(statusRef, updateData);
            
            // ç™¼é€é€šçŸ¥
            await this.sendNotification({
                type: 'appointment_status_change',
                appointmentId: appointmentId,
                status: status,
                message: this.getStatusChangeMessage(status),
                timestamp: new Date().toISOString()
            });
            
            console.log('æ›è™Ÿç‹€æ…‹å·²æ›´æ–°:', appointmentId, status);
        } catch (error) {
            console.error('æ›´æ–°æ›è™Ÿç‹€æ…‹å¤±æ•—:', error);
        }
    }

    // ç›£è½æ›è™Ÿç‹€æ…‹è®ŠåŒ–
    subscribeToAppointments(callback) {
        if (!this.isReady) return;
        
        const unsubscribe = window.firebase.onValue(this.appointmentsRef, (snapshot) => {
            const appointmentsData = snapshot.val() || {};
            const appointmentsList = Object.values(appointmentsData);
            callback(appointmentsList);
        });
        
        this.listeners.set('appointments', unsubscribe);
        return unsubscribe;
    }

    // ========== è¨ºç—‡é€²åº¦å¯¦æ™‚è¿½è¹¤ ==========
    
    async updateConsultationStatus(appointmentId, progressData) {
        if (!this.isReady) return;
        
        try {
            const statusRef = window.firebase.ref(
                window.firebase.rtdb, 
                `consultationStatus/${appointmentId}`
            );
            
            const statusData = {
                appointmentId: appointmentId,
                currentStep: progressData.step, // 'registered', 'waiting', 'consulting', 'completed'
                startTime: progressData.startTime || new Date().toISOString(),
                lastUpdated: new Date().toISOString(),
                doctor: progressData.doctor || currentUser,
                patientId: progressData.patientId,
                estimatedDuration: progressData.estimatedDuration || 30, // åˆ†é˜
                notes: progressData.notes || '',
                priority: progressData.priority || 'normal' // low, normal, high, urgent
            };
            
            await window.firebase.set(statusRef, statusData);
            
            // æ›´æ–°è¨ºæ‰€æ•´é«”ç‹€æ…‹
            await this.updateClinicStatus();
            
            console.log('è¨ºç—‡é€²åº¦å·²æ›´æ–°:', appointmentId, progressData.step);
        } catch (error) {
            console.error('æ›´æ–°è¨ºç—‡é€²åº¦å¤±æ•—:', error);
        }
    }

    async updateClinicStatus() {
        if (!this.isReady) return;
        
        try {
            // ç²å–ç•¶å‰æ‰€æœ‰è¨ºç—‡ç‹€æ…‹
            const statusSnapshot = await window.firebase.get(this.consultationStatusRef);
            const allStatus = statusSnapshot.val() || {};
            
            // çµ±è¨ˆå„ç¨®ç‹€æ…‹çš„æ•¸é‡
            const stats = {
                totalWaiting: 0,
                totalConsulting: 0,
                activeDoctors: new Set(),
                lastUpdated: new Date().toISOString()
            };
            
            Object.values(allStatus).forEach(status => {
                if (status.currentStep === 'waiting') stats.totalWaiting++;
                if (status.currentStep === 'consulting') {
                    stats.totalConsulting++;
                    stats.activeDoctors.add(status.doctor);
                }
            });
            
            stats.activeDoctorsCount = stats.activeDoctors.size;
            delete stats.activeDoctors; // ä¸èƒ½ç›´æ¥å­˜å„² Set
            
            const clinicRef = window.firebase.ref(window.firebase.rtdb, 'clinicStatus/current');
            await window.firebase.set(clinicRef, stats);
            
        } catch (error) {
            console.error('æ›´æ–°è¨ºæ‰€ç‹€æ…‹å¤±æ•—:', error);
        }
    }

    // ç›£è½è¨ºç—‡é€²åº¦è®ŠåŒ–
    subscribeToConsultationStatus(callback) {
        if (!this.isReady) return;
        
        const unsubscribe = window.firebase.onValue(this.consultationStatusRef, (snapshot) => {
            const statusData = snapshot.val() || {};
            callback(statusData);
        });
        
        this.listeners.set('consultationStatus', unsubscribe);
        return unsubscribe;
    }

    // ========== é€šçŸ¥ç³»çµ± ==========
    
    async sendNotification(notificationData) {
        if (!this.isReady) return;
        
        try {
            const notificationRef = window.firebase.push(this.notificationsRef);
            
            const notification = {
                id: notificationRef.key,
                ...notificationData,
                read: false,
                createdAt: new Date().toISOString(),
                createdBy: currentUser
            };
            
            await window.firebase.set(notificationRef, notification);
            console.log('é€šçŸ¥å·²ç™¼é€:', notification.id);
        } catch (error) {
            console.error('ç™¼é€é€šçŸ¥å¤±æ•—:', error);
        }
    }

    // ç›£è½é€šçŸ¥
    subscribeToNotifications(userId, callback) {
        if (!this.isReady) return;
        
        // ç›£è½é‡å°ç‰¹å®šç”¨æˆ¶æˆ–å…¨é«”çš„é€šçŸ¥
        const userNotificationsRef = window.firebase.ref(
            window.firebase.rtdb, 
            'notifications'
        );
        
        const unsubscribe = window.firebase.onValue(userNotificationsRef, (snapshot) => {
            const notifications = snapshot.val() || {};
            const userNotifications = Object.values(notifications)
                .filter(notif => !notif.targetUser || notif.targetUser === userId)
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            callback(userNotifications);
        });
        
        this.listeners.set(`notifications_${userId}`, unsubscribe);
        return unsubscribe;
    }

    // ========== è¼”åŠ©æ–¹æ³• ==========
    
    getStatusChangeMessage(status) {
        const messages = {
            'registered': 'ç—…äººå·²æ›è™Ÿ',
            'waiting': 'ç—…äººå·²åˆ°é”ï¼Œæ­£åœ¨å€™è¨º',
            'consulting': 'é–‹å§‹è¨ºç—‡',
            'completed': 'è¨ºç—‡å·²å®Œæˆ'
        };
        return messages[status] || 'ç‹€æ…‹å·²æ›´æ–°';
    }

    // æ¸…ç†æ‰€æœ‰ç›£è½å™¨
    cleanup() {
        this.listeners.forEach((unsubscribe) => {
            if (typeof unsubscribe === 'function') {
                unsubscribe();
            }
        });
        this.listeners.clear();
        
        this.stopActivityHeartbeat();
        
        if (currentUserData) {
            this.setUserOffline(currentUserData.id);
        }
    }

    // ========== æ•¸æ“šåŒæ­¥æ–¹æ³• ==========
    
    // å°‡æœ¬åœ°æ›è™Ÿæ•¸æ“šåŒæ­¥åˆ° Realtime Database
    async syncLocalAppointmentsToRealtime() {
        if (!this.isReady) return;
        
        try {
            const localAppointments = JSON.parse(localStorage.getItem('appointments') || '[]');
            
            for (const appointment of localAppointments) {
                await this.syncAppointmentToRealtime(appointment);
            }
            
            console.log('æœ¬åœ°æ›è™Ÿæ•¸æ“šå·²åŒæ­¥åˆ° Realtime Database');
        } catch (error) {
            console.error('åŒæ­¥æœ¬åœ°æ›è™Ÿæ•¸æ“šå¤±æ•—:', error);
        }
    }

    // å¾ Realtime Database åŒæ­¥åˆ°æœ¬åœ°
    async syncRealtimeToLocal() {
        if (!this.isReady) return;
        
        try {
            const snapshot = await window.firebase.get(this.appointmentsRef);
            const realtimeAppointments = snapshot.val() || {};
            const appointmentsList = Object.values(realtimeAppointments);
            
            // æ›´æ–°æœ¬åœ°å­˜å„²
            localStorage.setItem('appointments', JSON.stringify(appointmentsList));
            
            // æ›´æ–°å…¨å±€è®Šé‡
            appointments = appointmentsList;
            
            console.log('Realtime Database æ•¸æ“šå·²åŒæ­¥åˆ°æœ¬åœ°');
            return appointmentsList;
        } catch (error) {
            console.error('åŒæ­¥ Realtime Database æ•¸æ“šå¤±æ•—:', error);
            return [];
        }
    }
}

// ========== UI çµ„ä»¶å’Œé¡¯ç¤ºé‚è¼¯ ==========

class RealtimeUI {
    constructor(realtimeManager) {
        this.rtManager = realtimeManager;
        this.setupUI();
        this.subscribeToUpdates();
    }

    setupUI() {
        // å‰µå»ºå¯¦æ™‚ç‹€æ…‹é¡¯ç¤ºé¢æ¿
        this.createStatusPanel();
        this.createNotificationPanel();
    }

    createStatusPanel() {
        // åœ¨å°èˆªæ¬„æ·»åŠ å¯¦æ™‚ç‹€æ…‹æŒ‡ç¤ºå™¨
        const navbar = document.querySelector('nav .max-w-7xl');
        if (navbar) {
            const statusPanel = document.createElement('div');
            statusPanel.id = 'realtimeStatusPanel';
            statusPanel.className = 'flex items-center space-x-4 text-sm';
            statusPanel.innerHTML = `
                <div class="flex items-center space-x-2">
                    <div id="connectionStatus" class="w-3 h-3 rounded-full bg-gray-400"></div>
                    <span class="text-gray-600">é€£æ¥ç‹€æ…‹</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-gray-600">åœ¨ç·šï¼š</span>
                    <span id="onlineUsersCount" class="font-semibold text-blue-600">0</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-gray-600">å€™è¨ºï¼š</span>
                    <span id="waitingCount" class="font-semibold text-yellow-600">0</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-gray-600">è¨ºç—‡ä¸­ï¼š</span>
                    <span id="consultingCount" class="font-semibold text-green-600">0</span>
                </div>
            `;
            
            // æ’å…¥åˆ°ç”¨æˆ¶è§’è‰²ä¿¡æ¯å‰
            const userRole = document.getElementById('userRole');
            if (userRole) {
                userRole.parentNode.insertBefore(statusPanel, userRole);
            }
        }
    }

    createNotificationPanel() {
        // å‰µå»ºé€šçŸ¥é¢æ¿
        const notificationPanel = document.createElement('div');
        notificationPanel.id = 'notificationPanel';
        notificationPanel.className = 'fixed top-4 right-4 z-50 space-y-2 max-w-sm';
        document.body.appendChild(notificationPanel);
    }

    subscribeToUpdates() {
        // è¨‚é–±åœ¨ç·šç”¨æˆ¶æ›´æ–°
        this.rtManager.subscribeToOnlineUsers((users) => {
            this.updateOnlineUsersDisplay(users);
        });

        // è¨‚é–±è¨ºç—‡ç‹€æ…‹æ›´æ–°
        this.rtManager.subscribeToConsultationStatus((statusData) => {
            this.updateConsultationStatusDisplay(statusData);
        });

        // è¨‚é–±é€šçŸ¥
        if (currentUserData) {
            this.rtManager.subscribeToNotifications(currentUserData.id, (notifications) => {
                this.showNotifications(notifications);
            });
        }

        // ç›£è½é€£æ¥ç‹€æ…‹
        this.monitorConnectionStatus();
    }

    updateOnlineUsersDisplay(users) {
        const countElement = document.getElementById('onlineUsersCount');
        if (countElement) {
            countElement.textContent = users.length;
        }

        // åœ¨å´é‚Šæ¬„é¡¯ç¤ºåœ¨ç·šç”¨æˆ¶åˆ—è¡¨ï¼ˆå¯é¸ï¼‰
        this.updateOnlineUsersList(users);
    }

    updateOnlineUsersList(users) {
        // å¯ä»¥åœ¨å´é‚Šæ¬„æˆ–å…¶ä»–åœ°æ–¹é¡¯ç¤ºåœ¨ç·šç”¨æˆ¶åˆ—è¡¨
        const onlineUsersContainer = document.getElementById('onlineUsersList');
        if (onlineUsersContainer) {
            onlineUsersContainer.innerHTML = users.map(user => `
                <div class="flex items-center space-x-2 p-2 bg-green-50 rounded">
                    <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                    <span class="text-sm text-gray-700">${user.name}</span>
                    <span class="text-xs text-gray-500">${user.position}</span>
                </div>
            `).join('');
        }
    }

    updateConsultationStatusDisplay(statusData) {
        let waitingCount = 0;
        let consultingCount = 0;

        Object.values(statusData).forEach(status => {
            if (status.currentStep === 'waiting') waitingCount++;
            if (status.currentStep === 'consulting') consultingCount++;
        });

        const waitingElement = document.getElementById('waitingCount');
        const consultingElement = document.getElementById('consultingCount');

        if (waitingElement) waitingElement.textContent = waitingCount;
        if (consultingElement) consultingElement.textContent = consultingCount;
    }

    showNotifications(notifications) {
        const panel = document.getElementById('notificationPanel');
        if (!panel) return;

        // åªé¡¯ç¤ºæœ€è¿‘5åˆ†é˜çš„æœªè®€é€šçŸ¥
        const recentNotifications = notifications.filter(notif => {
            const notifTime = new Date(notif.createdAt);
            const now = new Date();
            const diffMinutes = (now - notifTime) / (1000 * 60);
            return !notif.read && diffMinutes < 5;
        });

        panel.innerHTML = recentNotifications.map(notif => `
            <div class="bg-white border-l-4 border-blue-500 shadow-lg rounded-lg p-4 mb-2 max-w-sm">
                <div class="flex items-start">
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900">${notif.message}</p>
                        <p class="text-xs text-gray-500">${new Date(notif.createdAt).toLocaleTimeString('zh-TW')}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            class="ml-2 text-gray-400 hover:text-gray-600">Ã—</button>
                </div>
            </div>
        `).join('');
    }

    monitorConnectionStatus() {
        const statusIndicator = document.getElementById('connectionStatus');
        if (!statusIndicator) return;

        // ç›£è½ Firebase é€£æ¥ç‹€æ…‹
        const connectedRef = window.firebase.ref(window.firebase.rtdb, '.info/connected');
        window.firebase.onValue(connectedRef, (snapshot) => {
            const connected = snapshot.val();
            if (connected) {
                statusIndicator.className = 'w-3 h-3 rounded-full bg-green-500';
                statusIndicator.title = 'å·²é€£æ¥åˆ°æœå‹™å™¨';
            } else {
                statusIndicator.className = 'w-3 h-3 rounded-full bg-red-500';
                statusIndicator.title = 'èˆ‡æœå‹™å™¨æ–·é–‹é€£æ¥';
            }
        });
    }
}

// ========== æ•´åˆåˆ°ç¾æœ‰ç³»çµ± ==========

// å…¨å±€å¯¦ä¾‹
let realtimeManager;
let realtimeUI;

// ä¿®æ”¹ç¾æœ‰çš„ç™»å…¥å‡½æ•¸
async function performLoginWithRealtime(user) {
    // åŸæœ‰çš„ç™»å…¥é‚è¼¯
    performLogin(user);
    
    // è¨­ç½®å¯¦æ™‚åŠŸèƒ½
    if (realtimeManager && realtimeManager.isReady) {
        await realtimeManager.setUserOnline(user.id, user);
    }
}

// ä¿®æ”¹ç¾æœ‰çš„ç™»å‡ºå‡½æ•¸
async function logoutWithRealtime() {
    // æ¸…ç†å¯¦æ™‚åŠŸèƒ½
    if (realtimeManager && currentUserData) {
        await realtimeManager.setUserOffline(currentUserData.id);
        realtimeManager.cleanup();
    }
    
    // åŸæœ‰çš„ç™»å‡ºé‚è¼¯
    logout();
}

// ä¿®æ”¹ç¾æœ‰çš„æ›è™Ÿç¢ºèªå‡½æ•¸
async function confirmRegistrationWithRealtime() {
    // åŸæœ‰çš„æ›è™Ÿé‚è¼¯
    confirmRegistration();
    
    // åŒæ­¥åˆ°å¯¦æ™‚æ•¸æ“šåº«
    if (realtimeManager && appointments.length > 0) {
        const latestAppointment = appointments[appointments.length - 1];
        await realtimeManager.syncAppointmentToRealtime(latestAppointment);
    }
}

// ä¿®æ”¹ç¾æœ‰çš„ç‹€æ…‹æ›´æ–°å‡½æ•¸
async function confirmPatientArrivalWithRealtime(appointmentId) {
    // åŸæœ‰çš„é‚è¼¯
    confirmPatientArrival(appointmentId);
    
    // æ›´æ–°å¯¦æ™‚ç‹€æ…‹
    if (realtimeManager) {
        await realtimeManager.updateAppointmentStatus(appointmentId, 'waiting', {
            arrivedAt: new Date().toISOString(),
            confirmedBy: currentUser
        });
    }
}

async function startConsultationWithRealtime(appointmentId) {
    // åŸæœ‰çš„é‚è¼¯
    startConsultation(appointmentId);
    
    // æ›´æ–°å¯¦æ™‚ç‹€æ…‹
    if (realtimeManager) {
        const appointment = appointments.find(apt => apt.id === appointmentId);
        if (appointment) {
            await realtimeManager.updateConsultationStatus(appointmentId, {
                step: 'consulting',
                doctor: currentUser,
                patientId: appointment.patientId,
                startTime: new Date().toISOString()
            });
        }
    }
}

// åˆå§‹åŒ–å¯¦æ™‚åŠŸèƒ½
document.addEventListener('DOMContentLoaded', async function() {
    // ç­‰å¾… Firebase åˆå§‹åŒ–
    while (!window.firebase) {
        await new Promise(resolve => setTimeout(resolve, 100));
    }
    
    // å‰µå»ºå¯¦æ™‚ç®¡ç†å™¨
    realtimeManager = new RealtimeManager();
    window.realtimeManager = realtimeManager; // å…¨å±€ä½¿ç”¨
    
    // ç­‰å¾…å¯¦æ™‚ç®¡ç†å™¨æº–å‚™å°±ç·’
    while (!realtimeManager.isReady) {
        await new Promise(resolve => setTimeout(resolve, 100));
    }
    
    // å‰µå»ºå¯¦æ™‚ UI
    realtimeUI = new RealtimeUI(realtimeManager);
    
    // åŒæ­¥ç¾æœ‰æ•¸æ“š
    await realtimeManager.syncLocalAppointmentsToRealtime();
    
    console.log('å¯¦æ™‚åŠŸèƒ½å·²åˆå§‹åŒ–å®Œæˆ');
});

// é é¢é—œé–‰æ™‚æ¸…ç†
window.addEventListener('beforeunload', () => {
    if (realtimeManager) {
        realtimeManager.cleanup();
    }
});        
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96abf25724ae0514',t:'MTc1NDQ1NjE3NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script><script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"96c38f22ee47ddc3","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.7.0","token":"b2074e7888b746fe9fbbc15492b4c3d4"}' crossorigin="anonymous"></script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"96d90c272a1cdd44","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.7.0","token":"b2074e7888b746fe9fbbc15492b4c3d4"}' crossorigin="anonymous"></script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"96dd51fb1d5d84a2","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.7.0","token":"b2074e7888b746fe9fbbc15492b4c3d4"}' crossorigin="anonymous"></script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"96dd62519b8eb430","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.7.0","token":"b2074e7888b746fe9fbbc15492b4c3d4"}' crossorigin="anonymous"></script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"96deefe9585702cc","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.7.0","token":"b2074e7888b746fe9fbbc15492b4c3d4"}' crossorigin="anonymous"></script>
</body>
</html>
