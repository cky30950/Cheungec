<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2575.6">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
  </style>
</head>
<body>
<p class="p1">&lt;!DOCTYPE html&gt;</p>
<p class="p1">&lt;html lang="zh-TW"&gt;</p>
<p class="p1">&lt;head&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;meta charset="UTF-8"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;title&gt;智慧中醫診療助手&lt;/title&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;script src="https://cdn.tailwindcss.com"&gt;&lt;/script&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;style&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&amp;display=swap');</p>
<p class="p1"><span class="Apple-converted-space">        </span>body { font-family: 'Noto Sans TC', sans-serif; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.pulse-animation { animation: pulse 2s infinite; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>@keyframes pulse {</p>
<p class="p1"><span class="Apple-converted-space">            </span>0%, 100% { opacity: 1; }</p>
<p class="p1"><span class="Apple-converted-space">            </span>50% { opacity: 0.7; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.admin-mode { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); }</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/style&gt;</p>
<p class="p1">&lt;/head&gt;</p>
<p class="p1">&lt;body class="bg-gray-50 min-h-screen"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;!-- Header --&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;header id="mainHeader" class="gradient-bg text-white py-6 shadow-lg"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="container mx-auto px-4"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="flex items-center justify-between"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="flex items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="text-3xl mr-3"&gt;🏥&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;h1 class="text-3xl font-bold"&gt;智慧中醫診療助手&lt;/h1&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;p class="text-blue-100 mt-1"&gt;基於傳統中醫理論的AI診療系統&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="flex items-center space-x-4"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;button onclick="toggleAdminMode()" id="adminToggle" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all duration-300"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>🔐 管理員模式</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/header&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;!-- Admin Login Modal --&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="adminLoginModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="bg-white rounded-xl p-8 max-w-md w-full mx-4"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;h3 class="text-xl font-bold text-gray-800 mb-4 text-center"&gt;管理員登入&lt;/h3&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="space-y-4"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;label class="block text-sm font-medium text-gray-700 mb-1"&gt;帳號&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;input type="text" id="adminUsername" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="請輸入管理員帳號"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;label class="block text-sm font-medium text-gray-700 mb-1"&gt;密碼&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;input type="password" id="adminPassword" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="請輸入密碼"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="flex gap-3"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;button onclick="adminLogin()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-medium"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>登入</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;button onclick="closeAdminLogin()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-lg font-medium"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>取消</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="container mx-auto px-4 py-8 max-w-6xl"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;!-- Navigation Tabs --&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="flex flex-wrap justify-center mb-8 bg-white rounded-lg p-2 card-shadow"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;button onclick="showTab('symptoms')" id="symptomsTab" class="tab-btn bg-blue-500 text-white px-6 py-3 rounded-lg mx-1 mb-2 font-medium transition-all duration-300"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>🔍 症狀分析</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;button onclick="showTab('prescription')" id="prescriptionTab" class="tab-btn bg-gray-200 text-gray-700 px-6 py-3 rounded-lg mx-1 mb-2 font-medium transition-all duration-300"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>💊 方藥建議</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;button onclick="showTab('acupuncture')" id="acupunctureTab" class="tab-btn bg-gray-200 text-gray-700 px-6 py-3 rounded-lg mx-1 mb-2 font-medium transition-all duration-300"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>📍 針灸方案</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;button onclick="showTab('admin')" id="adminTab" class="tab-btn bg-gray-200 text-gray-700 px-6 py-3 rounded-lg mx-1 mb-2 font-medium transition-all duration-300 hidden"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>👨‍💼 後台管理</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;button onclick="showTab('users')" id="usersTab" class="tab-btn bg-gray-200 text-gray-700 px-6 py-3 rounded-lg mx-1 mb-2 font-medium transition-all duration-300 hidden"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>👥 用戶管理</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;!-- Symptoms Analysis Tab --&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div id="symptomsContent" class="tab-content"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="bg-white rounded-xl p-8 card-shadow"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;span class="text-3xl mr-3"&gt;🔍&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>症狀分析與診斷</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/h2&gt;</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="grid md:grid-cols-2 gap-8"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;!-- Personal Information Form --&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg border-l-4 border-blue-500 mb-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;h3 class="text-lg font-semibold text-blue-800 mb-4 flex items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;span class="text-xl mr-2"&gt;👤&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>個人基本資料</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/h3&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div class="grid md:grid-cols-2 gap-4"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;label class="block text-sm font-medium text-gray-700 mb-1"&gt;姓名 *&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;input type="text" id="patientName" class="w-full p-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="請輸入姓名" required&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;label class="block text-sm font-medium text-gray-700 mb-1"&gt;性別 *&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;select id="patientGender" class="w-full p-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>&lt;option value=""&gt;請選擇&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>&lt;option value="male"&gt;男性&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>&lt;option value="female"&gt;女性&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;/select&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;label class="block text-sm font-medium text-gray-700 mb-1"&gt;出生日期 *&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;input type="date" id="patientBirthdate" class="w-full p-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="calculateAge()" required&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;label class="block text-sm font-medium text-gray-700 mb-1"&gt;年齡&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;input type="text" id="patientAge" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50" placeholder="自動計算" readonly&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;label class="block text-sm font-medium text-gray-700 mb-1"&gt;聯絡電話 *&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;input type="tel" id="patientPhone" class="w-full p-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="請輸入電話號碼" required&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;label class="block text-sm font-medium text-gray-700 mb-1"&gt;職業&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;input type="text" id="patientOccupation" class="w-full p-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="請輸入職業"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;!-- Medical History Form --&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="bg-gradient-to-r from-orange-50 to-red-50 p-6 rounded-lg border-l-4 border-orange-500 mb-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;h3 class="text-lg font-semibold text-orange-800 mb-4 flex items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;span class="text-xl mr-2"&gt;📋&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>病史資料</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/h3&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div class="space-y-4"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;label class="block text-sm font-medium text-gray-700 mb-2"&gt;現病史（主要症狀及發病經過）&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;textarea id="currentIllness" class="w-full p-3 border border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" rows="3" placeholder="請詳細描述目前的主要症狀、發病時間、症狀變化等..."&gt;&lt;/textarea&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;label class="block text-sm font-medium text-gray-700 mb-2"&gt;既往史（過去疾病史）&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;textarea id="pastHistory" class="w-full p-3 border border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" rows="3" placeholder="請填寫過去曾患過的疾病、手術史、外傷史等..."&gt;&lt;/textarea&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;label class="block text-sm font-medium text-gray-700 mb-2"&gt;家族史&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;textarea id="familyHistory" class="w-full p-3 border border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" rows="2" placeholder="請填寫家族中的遺傳性疾病或重大疾病史..."&gt;&lt;/textarea&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;label class="block text-sm font-medium text-gray-700 mb-2"&gt;過敏史&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;textarea id="allergyHistory" class="w-full p-3 border border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" rows="2" placeholder="請填寫對藥物、食物或其他物質的過敏反應..."&gt;&lt;/textarea&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;label class="block text-sm font-medium text-gray-700 mb-2"&gt;目前用藥&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;textarea id="currentMedication" class="w-full p-3 border border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" rows="2" placeholder="請列出目前正在服用的藥物（包括中藥、西藥、保健品）..."&gt;&lt;/textarea&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="bg-gradient-to-r from-green-50 to-blue-50 p-4 rounded-lg border-l-4 border-green-500 mb-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;h3 class="text-lg font-semibold text-green-800 mb-2 flex items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;span class="text-xl mr-2"&gt;👨‍⚕️&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>中醫問診</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/h3&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;p class="text-green-700 text-sm"&gt;請回答以下問題，幫助我們了解您的身體狀況&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p2"><span class="Apple-converted-space">                        </span></p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div id="questionnaireContainer" class="space-y-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;!-- Questions will be loaded here --&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p2"><span class="Apple-converted-space">                        </span></p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;!-- Add Custom Question Section --&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;h4 class="font-semibold text-blue-800 mb-3 flex items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;span class="text-lg mr-2"&gt;➕&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>新增自定義問題</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/h4&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div class="space-y-3"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;input type="text" id="customQuestionInput" class="w-full p-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="輸入問題內容..."&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div class="flex gap-2"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;input type="text" id="customAnswerA" class="flex-1 p-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="選項A"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;input type="text" id="customAnswerB" class="flex-1 p-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="選項B"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;input type="text" id="customAnswerC" class="flex-1 p-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="選項C (可選)"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;button onclick="addCustomQuestion()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>新增問題</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p2"><span class="Apple-converted-space">                        </span></p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;!-- Manage Questions Section --&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="mt-4"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;button onclick="toggleManageMode()" id="manageBtn" class="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;span class="mr-1"&gt;⚙️&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;span id="manageBtnText"&gt;管理問題&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p2"><span class="Apple-converted-space">                        </span></p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="mt-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;label class="block text-sm font-medium text-gray-700 mb-2"&gt;其他補充說明：&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;textarea id="additionalSymptoms" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="3" placeholder="請補充任何其他身體不適或特殊情況..."&gt;&lt;/textarea&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p2"><span class="Apple-converted-space">                        </span></p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;button onclick="analyzeSymptoms()" class="w-full mt-6 bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-300"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>🔍 完成問診分析</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p2"><span class="Apple-converted-space">                    </span></p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;h3 class="text-lg font-semibold mb-4 text-gray-700"&gt;中醫診斷結果：&lt;/h3&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div id="diagnosisResult" class="bg-gradient-to-r from-blue-50 to-purple-50 p-6 rounded-lg border-l-4 border-blue-500"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;p class="text-gray-600 italic"&gt;請先選擇症狀進行分析...&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;!-- Prescription Tab --&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div id="prescriptionContent" class="tab-content hidden"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="bg-white rounded-xl p-8 card-shadow"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;span class="text-3xl mr-3"&gt;💊&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>中藥方劑建議</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/h2&gt;</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div id="prescriptionResult" class="space-y-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="text-center text-gray-500 py-8"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="text-6xl mb-4"&gt;💊&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;p&gt;請先在症狀分析頁面完成診斷，然後返回此處查看方藥建議&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;!-- Acupuncture Tab --&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div id="acupunctureContent" class="tab-content hidden"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="bg-white rounded-xl p-8 card-shadow"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;span class="text-3xl mr-3"&gt;📍&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>針灸治療方案</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/h2&gt;</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div id="acupunctureResult" class="space-y-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="text-center text-gray-500 py-8"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="text-6xl mb-4"&gt;📍&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;p&gt;請先在症狀分析頁面完成診斷，然後返回此處查看針灸方案&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;!-- Users Management Tab --&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div id="usersContent" class="tab-content hidden"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="bg-white rounded-xl p-8 card-shadow"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="flex justify-between items-center mb-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;h2 class="text-2xl font-bold text-gray-800 flex items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;span class="text-3xl mr-3"&gt;👥&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>用戶管理系統</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/h2&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="flex items-center space-x-4"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div id="currentUserInfo" class="text-sm text-gray-600"&gt;未登入&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;button onclick="showUserProfile()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>👤 個人資料</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;!-- User Dashboard Stats --&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="grid md:grid-cols-4 gap-6 mb-8"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-lg"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="flex items-center justify-between"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;p class="text-blue-100"&gt;總用戶數&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;p class="text-2xl font-bold" id="totalUsers"&gt;0&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div class="text-3xl"&gt;👥&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-6 rounded-lg"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="flex items-center justify-between"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;p class="text-green-100"&gt;活躍用戶&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;p class="text-2xl font-bold" id="activeUsers"&gt;0&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div class="text-3xl"&gt;✅&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6 rounded-lg"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="flex items-center justify-between"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;p class="text-purple-100"&gt;管理員&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;p class="text-2xl font-bold" id="adminCount"&gt;0&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div class="text-3xl"&gt;👨‍💼&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-6 rounded-lg"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="flex items-center justify-between"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;p class="text-orange-100"&gt;醫護人員&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;p class="text-2xl font-bold" id="medicalStaff"&gt;0&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div class="text-3xl"&gt;👩‍⚕️&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;!-- Search and Filter --&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="bg-gray-50 p-6 rounded-lg mb-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="flex flex-wrap gap-4 items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="flex-1 min-w-64"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;input type="text" id="searchUser" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="搜尋用戶姓名、帳號..." onkeyup="searchUsers()"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;select id="filterRole" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="filterUsers()"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;option value=""&gt;全部角色&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;option value="super_admin"&gt;超級管理員&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;option value="admin"&gt;管理員&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;option value="doctor"&gt;醫師&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;option value="nurse"&gt;護理師&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;option value="staff"&gt;一般職員&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/select&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;select id="filterStatus" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="filterUsers()"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;option value=""&gt;全部狀態&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;option value="active"&gt;啟用&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;option value="inactive"&gt;停用&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/select&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;button onclick="showAddUserModal()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg" ${!hasPermission('manage_users') ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>➕ 新增用戶</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;!-- User List --&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="bg-white border border-gray-200 rounded-lg overflow-hidden"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="bg-gray-50 px-6 py-4 border-b border-gray-200"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;h3 class="text-lg font-semibold text-gray-800"&gt;用戶列表&lt;/h3&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="overflow-x-auto"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;table class="w-full"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;thead class="bg-gray-100"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;tr&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"&gt;用戶資訊&lt;/th&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"&gt;角色權限&lt;/th&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"&gt;部門&lt;/th&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"&gt;最後登入&lt;/th&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"&gt;狀態&lt;/th&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"&gt;操作&lt;/th&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/tr&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/thead&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;tbody id="userTableBody" class="bg-white divide-y divide-gray-200"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;!-- User data will be loaded here --&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/tbody&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/table&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;!-- Admin Panel Tab --&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div id="adminContent" class="tab-content hidden"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="bg-white rounded-xl p-8 card-shadow"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;span class="text-3xl mr-3"&gt;👨‍💼&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>後台管理系統</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/h2&gt;</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;!-- Admin Dashboard Stats --&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="grid md:grid-cols-4 gap-6 mb-8"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-lg"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="flex items-center justify-between"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;p class="text-blue-100"&gt;總病患數&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;p class="text-2xl font-bold" id="totalPatients"&gt;0&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div class="text-3xl"&gt;👥&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-6 rounded-lg"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="flex items-center justify-between"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;p class="text-green-100"&gt;今日新增&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;p class="text-2xl font-bold" id="todayPatients"&gt;0&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div class="text-3xl"&gt;📈&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6 rounded-lg"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="flex items-center justify-between"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;p class="text-purple-100"&gt;本週診療&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;p class="text-2xl font-bold" id="weekPatients"&gt;0&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div class="text-3xl"&gt;📊&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-6 rounded-lg"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="flex items-center justify-between"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;p class="text-orange-100"&gt;待處理&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;p class="text-2xl font-bold" id="pendingPatients"&gt;0&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div class="text-3xl"&gt;⏳&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;!-- Search and Filter --&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="bg-gray-50 p-6 rounded-lg mb-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="flex flex-wrap gap-4 items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="flex-1 min-w-64"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;input type="text" id="searchPatient" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="搜尋病患姓名、電話..." onkeyup="searchPatients()"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;select id="filterStatus" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="filterPatients()"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;option value=""&gt;全部狀態&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;option value="pending"&gt;待處理&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;option value="completed"&gt;已完成&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;option value="follow-up"&gt;需追蹤&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/select&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;select id="filterDate" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="filterPatients()"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;option value=""&gt;全部日期&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;option value="today"&gt;今天&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;option value="week"&gt;本週&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;option value="month"&gt;本月&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/select&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;button onclick="exportPatientData()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg" ${!hasPermission('export_data') ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>📊 匯出資料</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;!-- Patient List --&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="bg-white border border-gray-200 rounded-lg overflow-hidden"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="bg-gray-50 px-6 py-4 border-b border-gray-200"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;h3 class="text-lg font-semibold text-gray-800"&gt;病患資料列表&lt;/h3&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="overflow-x-auto"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;table class="w-full"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;thead class="bg-gray-100"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;tr&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"&gt;病患資訊&lt;/th&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"&gt;診療日期&lt;/th&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"&gt;主要症狀&lt;/th&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"&gt;狀態&lt;/th&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"&gt;操作&lt;/th&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/tr&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/thead&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;tbody id="patientTableBody" class="bg-white divide-y divide-gray-200"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;!-- Patient data will be loaded here --&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/tbody&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/table&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;!-- Add/Edit User Modal --&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="addUserModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="bg-white rounded-xl max-w-2xl w-full mx-4 max-h-screen overflow-y-auto"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="p-6 border-b border-gray-200"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="flex justify-between items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;h3 id="userModalTitle" class="text-xl font-bold text-gray-800"&gt;新增用戶&lt;/h3&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;button onclick="closeAddUserModal()" class="text-gray-400 hover:text-gray-600"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;span class="text-2xl"&gt;×&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="p-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;form id="userForm" class="space-y-4"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;input type="hidden" id="editUserId"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="grid md:grid-cols-2 gap-4"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;label class="block text-sm font-medium text-gray-700 mb-1"&gt;帳號 *&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;input type="text" id="userUsername" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;label class="block text-sm font-medium text-gray-700 mb-1"&gt;姓名 *&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;input type="text" id="userName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;label class="block text-sm font-medium text-gray-700 mb-1"&gt;密碼 *&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;input type="password" id="userPassword" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;label class="block text-sm font-medium text-gray-700 mb-1"&gt;確認密碼 *&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;input type="password" id="userPasswordConfirm" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;label class="block text-sm font-medium text-gray-700 mb-1"&gt;角色 *&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;select id="userRole" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;option value=""&gt;請選擇角色&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;option value="super_admin"&gt;超級管理員&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;option value="admin"&gt;管理員&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;option value="doctor"&gt;醫師&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;option value="nurse"&gt;護理師&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;option value="staff"&gt;一般職員&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/select&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;label class="block text-sm font-medium text-gray-700 mb-1"&gt;部門&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;input type="text" id="userDepartment" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;label class="block text-sm font-medium text-gray-700 mb-1"&gt;電子郵件&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;input type="email" id="userEmail" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;label class="block text-sm font-medium text-gray-700 mb-1"&gt;電話&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;input type="tel" id="userPhone" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="flex gap-3 pt-4"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;button type="submit" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-medium"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>儲存</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;button type="button" onclick="closeAddUserModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-lg font-medium"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>取消</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/form&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;!-- User Profile Modal --&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="userProfileModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="bg-white rounded-xl max-w-3xl w-full mx-4 max-h-screen overflow-y-auto"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="p-6 border-b border-gray-200"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="flex justify-between items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;h3 class="text-xl font-bold text-gray-800"&gt;個人資料&lt;/h3&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;button onclick="closeUserProfile()" class="text-gray-400 hover:text-gray-600"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;span class="text-2xl"&gt;×&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div id="userProfileContent" class="p-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;!-- User profile content will be loaded here --&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;!-- Patient Detail Modal --&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="patientDetailModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="bg-white rounded-xl max-w-4xl w-full mx-4 max-h-screen overflow-y-auto"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="p-6 border-b border-gray-200"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="flex justify-between items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;h3 class="text-xl font-bold text-gray-800"&gt;病患詳細資料&lt;/h3&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;button onclick="closePatientDetail()" class="text-gray-400 hover:text-gray-600"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;span class="text-2xl"&gt;×&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div id="patientDetailContent" class="p-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;!-- Patient detail content will be loaded here --&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;!-- Footer --&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;footer class="bg-gray-800 text-white py-8 mt-12"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="container mx-auto px-4 text-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;p class="mb-2"&gt;⚠️ &lt;strong&gt;重要提醒&lt;/strong&gt;&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;p class="text-gray-300 text-sm"&gt;本系統僅供參考，不能替代專業醫師診斷。如有嚴重症狀請立即就醫。&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/footer&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;script&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>// Global variables</p>
<p class="p1"><span class="Apple-converted-space">        </span>let questions = [</p>
<p class="p1"><span class="Apple-converted-space">            </span>{</p>
<p class="p1"><span class="Apple-converted-space">                </span>id: 1,</p>
<p class="p1"><span class="Apple-converted-space">                </span>question: "您最近的睡眠狀況如何？",</p>
<p class="p1"><span class="Apple-converted-space">                </span>options: ["睡眠良好，精神飽滿", "偶爾失眠，容易驚醒", "經常失眠，難以入睡"],</p>
<p class="p1"><span class="Apple-converted-space">                </span>category: "sleep"</p>
<p class="p1"><span class="Apple-converted-space">            </span>},</p>
<p class="p1"><span class="Apple-converted-space">            </span>{</p>
<p class="p1"><span class="Apple-converted-space">                </span>id: 2,</p>
<p class="p1"><span class="Apple-converted-space">                </span>question: "您的食慾和消化情況怎樣？",</p>
<p class="p1"><span class="Apple-converted-space">                </span>options: ["食慾正常，消化良好", "食慾不振，偶有腹脹", "經常消化不良，胃部不適"],</p>
<p class="p1"><span class="Apple-converted-space">                </span>category: "digestion"</p>
<p class="p1"><span class="Apple-converted-space">            </span>},</p>
<p class="p1"><span class="Apple-converted-space">            </span>{</p>
<p class="p1"><span class="Apple-converted-space">                </span>id: 3,</p>
<p class="p1"><span class="Apple-converted-space">                </span>question: "您最近的精神狀態如何？",</p>
<p class="p1"><span class="Apple-converted-space">                </span>options: ["精力充沛，心情愉快", "偶感疲勞，情緒一般", "經常疲勞，情緒低落"],</p>
<p class="p1"><span class="Apple-converted-space">                </span>category: "energy"</p>
<p class="p1"><span class="Apple-converted-space">            </span>},</p>
<p class="p1"><span class="Apple-converted-space">            </span>{</p>
<p class="p1"><span class="Apple-converted-space">                </span>id: 4,</p>
<p class="p1"><span class="Apple-converted-space">                </span>question: "您是否有頭部不適的症狀？",</p>
<p class="p1"><span class="Apple-converted-space">                </span>options: ["沒有頭痛問題", "偶爾頭痛或頭暈", "經常頭痛，影響日常"],</p>
<p class="p1"><span class="Apple-converted-space">                </span>category: "head"</p>
<p class="p1"><span class="Apple-converted-space">            </span>},</p>
<p class="p1"><span class="Apple-converted-space">            </span>{</p>
<p class="p1"><span class="Apple-converted-space">                </span>id: 5,</p>
<p class="p1"><span class="Apple-converted-space">                </span>question: "您的呼吸系統狀況如何？",</p>
<p class="p1"><span class="Apple-converted-space">                </span>options: ["呼吸順暢，無咳嗽", "偶爾咳嗽或喉嚨不適", "經常咳嗽，痰多或氣喘"],</p>
<p class="p1"><span class="Apple-converted-space">                </span>category: "respiratory"</p>
<p class="p1"><span class="Apple-converted-space">            </span>},</p>
<p class="p1"><span class="Apple-converted-space">            </span>{</p>
<p class="p1"><span class="Apple-converted-space">                </span>id: 6,</p>
<p class="p1"><span class="Apple-converted-space">                </span>question: "您是否有腰背或關節疼痛？",</p>
<p class="p1"><span class="Apple-converted-space">                </span>options: ["沒有疼痛問題", "偶爾腰酸背痛", "經常腰痛或關節不適"],</p>
<p class="p1"><span class="Apple-converted-space">                </span>category: "musculoskeletal"</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>];</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>let isManageMode = false;</p>
<p class="p1"><span class="Apple-converted-space">        </span>let userAnswers = {};</p>
<p class="p1"><span class="Apple-converted-space">        </span>let isAdminMode = false;</p>
<p class="p1"><span class="Apple-converted-space">        </span>let patientDatabase = JSON.parse(localStorage.getItem('patientDatabase')) || [];</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Initialize the app</p>
<p class="p1"><span class="Apple-converted-space">        </span>document.addEventListener('DOMContentLoaded', function() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>loadQuestions();</p>
<p class="p1"><span class="Apple-converted-space">            </span>updateAdminStats();</p>
<p class="p1"><span class="Apple-converted-space">            </span>// Initialize admin users if not exists</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!localStorage.getItem('adminUsers')) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>localStorage.setItem('adminUsers', JSON.stringify(adminUsers));</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Permission checking function</p>
<p class="p1"><span class="Apple-converted-space">        </span>function hasPermission(permission) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!currentUser) return false;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const userRole = rolePermissions[currentUser.role];</p>
<p class="p1"><span class="Apple-converted-space">            </span>return userRole &amp;&amp; userRole.permissions.includes(permission);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// User management system with role-based permissions</p>
<p class="p1"><span class="Apple-converted-space">        </span>let adminUsers = [</p>
<p class="p1"><span class="Apple-converted-space">            </span>{</p>
<p class="p1"><span class="Apple-converted-space">                </span>id: 1,</p>
<p class="p1"><span class="Apple-converted-space">                </span>username: 'admin',</p>
<p class="p1"><span class="Apple-converted-space">                </span>name: '系統管理員',</p>
<p class="p1"><span class="Apple-converted-space">                </span>password: 'admin123',</p>
<p class="p1"><span class="Apple-converted-space">                </span>role: 'super_admin',</p>
<p class="p1"><span class="Apple-converted-space">                </span>department: '資訊部',</p>
<p class="p1"><span class="Apple-converted-space">                </span>email: 'admin@clinic.com',</p>
<p class="p1"><span class="Apple-converted-space">                </span>phone: '02-1234-5678',</p>
<p class="p1"><span class="Apple-converted-space">                </span>createdAt: '2024-01-01T00:00:00.000Z',</p>
<p class="p1"><span class="Apple-converted-space">                </span>lastLogin: null,</p>
<p class="p1"><span class="Apple-converted-space">                </span>status: 'active'</p>
<p class="p1"><span class="Apple-converted-space">            </span>},</p>
<p class="p1"><span class="Apple-converted-space">            </span>{</p>
<p class="p1"><span class="Apple-converted-space">                </span>id: 2,</p>
<p class="p1"><span class="Apple-converted-space">                </span>username: 'doctor1',</p>
<p class="p1"><span class="Apple-converted-space">                </span>name: '張醫師',</p>
<p class="p1"><span class="Apple-converted-space">                </span>password: 'doctor123',</p>
<p class="p1"><span class="Apple-converted-space">                </span>role: 'doctor',</p>
<p class="p1"><span class="Apple-converted-space">                </span>department: '中醫科',</p>
<p class="p1"><span class="Apple-converted-space">                </span>email: 'doctor1@clinic.com',</p>
<p class="p1"><span class="Apple-converted-space">                </span>phone: '02-1234-5679',</p>
<p class="p1"><span class="Apple-converted-space">                </span>createdAt: '2024-01-01T00:00:00.000Z',</p>
<p class="p1"><span class="Apple-converted-space">                </span>lastLogin: null,</p>
<p class="p1"><span class="Apple-converted-space">                </span>status: 'active'</p>
<p class="p1"><span class="Apple-converted-space">            </span>},</p>
<p class="p1"><span class="Apple-converted-space">            </span>{</p>
<p class="p1"><span class="Apple-converted-space">                </span>id: 3,</p>
<p class="p1"><span class="Apple-converted-space">                </span>username: 'nurse1',</p>
<p class="p1"><span class="Apple-converted-space">                </span>name: '李護理師',</p>
<p class="p1"><span class="Apple-converted-space">                </span>password: 'nurse123',</p>
<p class="p1"><span class="Apple-converted-space">                </span>role: 'nurse',</p>
<p class="p1"><span class="Apple-converted-space">                </span>department: '護理部',</p>
<p class="p1"><span class="Apple-converted-space">                </span>email: 'nurse1@clinic.com',</p>
<p class="p1"><span class="Apple-converted-space">                </span>phone: '02-1234-5680',</p>
<p class="p1"><span class="Apple-converted-space">                </span>createdAt: '2024-01-01T00:00:00.000Z',</p>
<p class="p1"><span class="Apple-converted-space">                </span>lastLogin: null,</p>
<p class="p1"><span class="Apple-converted-space">                </span>status: 'active'</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>];</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>let rolePermissions = {</p>
<p class="p1"><span class="Apple-converted-space">            </span>super_admin: {</p>
<p class="p1"><span class="Apple-converted-space">                </span>name: '超級管理員',</p>
<p class="p1"><span class="Apple-converted-space">                </span>color: 'bg-red-500',</p>
<p class="p1"><span class="Apple-converted-space">                </span>permissions: ['view_patients', 'edit_patients', 'delete_patients', 'export_data', 'manage_users', 'system_settings']</p>
<p class="p1"><span class="Apple-converted-space">            </span>},</p>
<p class="p1"><span class="Apple-converted-space">            </span>admin: {</p>
<p class="p1"><span class="Apple-converted-space">                </span>name: '管理員',</p>
<p class="p1"><span class="Apple-converted-space">                </span>color: 'bg-purple-500',</p>
<p class="p1"><span class="Apple-converted-space">                </span>permissions: ['view_patients', 'edit_patients', 'delete_patients', 'export_data', 'manage_users']</p>
<p class="p1"><span class="Apple-converted-space">            </span>},</p>
<p class="p1"><span class="Apple-converted-space">            </span>doctor: {</p>
<p class="p1"><span class="Apple-converted-space">                </span>name: '醫師',</p>
<p class="p1"><span class="Apple-converted-space">                </span>color: 'bg-blue-500',</p>
<p class="p1"><span class="Apple-converted-space">                </span>permissions: ['view_patients', 'edit_patients', 'export_data']</p>
<p class="p1"><span class="Apple-converted-space">            </span>},</p>
<p class="p1"><span class="Apple-converted-space">            </span>nurse: {</p>
<p class="p1"><span class="Apple-converted-space">                </span>name: '護理師',</p>
<p class="p1"><span class="Apple-converted-space">                </span>color: 'bg-green-500',</p>
<p class="p1"><span class="Apple-converted-space">                </span>permissions: ['view_patients', 'edit_patients']</p>
<p class="p1"><span class="Apple-converted-space">            </span>},</p>
<p class="p1"><span class="Apple-converted-space">            </span>staff: {</p>
<p class="p1"><span class="Apple-converted-space">                </span>name: '一般職員',</p>
<p class="p1"><span class="Apple-converted-space">                </span>color: 'bg-gray-500',</p>
<p class="p1"><span class="Apple-converted-space">                </span>permissions: ['view_patients']</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>};</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>let currentUser = null;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// User management functions</p>
<p class="p1"><span class="Apple-converted-space">        </span>function updateUserStats() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const totalUsers = adminUsers.length;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const activeUsers = adminUsers.filter(u =&gt; u.status === 'active').length;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const adminCount = adminUsers.filter(u =&gt; ['super_admin', 'admin'].includes(u.role)).length;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const medicalStaff = adminUsers.filter(u =&gt; ['doctor', 'nurse'].includes(u.role)).length;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('totalUsers').textContent = totalUsers;</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('activeUsers').textContent = activeUsers;</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('adminCount').textContent = adminCount;</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('medicalStaff').textContent = medicalStaff;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>loadUserData();</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function loadUserData() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const tbody = document.getElementById('userTableBody');</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!tbody) return;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>tbody.innerHTML = '';</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>adminUsers.sort((a, b) =&gt; new Date(b.createdAt) - new Date(a.createdAt)).forEach(user =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const row = document.createElement('tr');</p>
<p class="p1"><span class="Apple-converted-space">                </span>row.className = 'hover:bg-gray-50';</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>const roleInfo = rolePermissions[user.role];</p>
<p class="p1"><span class="Apple-converted-space">                </span>const statusColor = user.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';</p>
<p class="p1"><span class="Apple-converted-space">                </span>const statusText = user.status === 'active' ? '啟用' : '停用';</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>// 檢查是否可以編輯此用戶</p>
<p class="p1"><span class="Apple-converted-space">                </span>const canEdit = hasPermission('manage_users') &amp;&amp; (currentUser.role === 'super_admin' || user.role !== 'super_admin');</p>
<p class="p1"><span class="Apple-converted-space">                </span>const canToggleStatus = canEdit &amp;&amp; user.id !== currentUser.id;</p>
<p class="p1"><span class="Apple-converted-space">                </span>const canResetPassword = canEdit;</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>row.innerHTML = `</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;td class="px-6 py-4 whitespace-nowrap"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="flex items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div class="text-sm font-medium text-gray-900"&gt;${user.name}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div class="text-sm text-gray-500"&gt;@${user.username}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div class="text-sm text-gray-500"&gt;${user.email || '未設定'}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/td&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;td class="px-6 py-4 whitespace-nowrap"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${roleInfo.color} text-white"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>${roleInfo.name}</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="text-xs text-gray-500 mt-1"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>${roleInfo.permissions.length} 項權限</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/td&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>${user.department || '未設定'}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/td&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>${user.lastLogin ? new Date(user.lastLogin).toLocaleString('zh-TW') : '從未登入'}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/td&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;td class="px-6 py-4 whitespace-nowrap"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>${statusText}</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/td&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;td class="px-6 py-4 whitespace-nowrap text-sm font-medium"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;button onclick="editUser(${user.id})" class="text-indigo-600 hover:text-indigo-900 mr-3 ${!canEdit ? 'opacity-50 cursor-not-allowed' : ''}" ${!canEdit ? 'disabled' : ''}&gt;編輯&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;button onclick="toggleUserStatus(${user.id})" class="text-${user.status === 'active' ? 'red' : 'green'}-600 hover:text-${user.status === 'active' ? 'red' : 'green'}-900 mr-3 ${!canToggleStatus ? 'opacity-50 cursor-not-allowed' : ''}" ${!canToggleStatus ? 'disabled' : ''}&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>${user.status === 'active' ? '停用' : '啟用'}</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;button onclick="resetPassword(${user.id})" class="text-yellow-600 hover:text-yellow-900 ${!canResetPassword ? 'opacity-50 cursor-not-allowed' : ''}" ${!canResetPassword ? 'disabled' : ''}&gt;重設密碼&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/td&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>`;</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>tbody.appendChild(row);</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function showAddUserModal() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!hasPermission('manage_users')) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>showNotification('您沒有權限執行此操作！', 'error');</p>
<p class="p1"><span class="Apple-converted-space">                </span>return;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('userModalTitle').textContent = '新增用戶';</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('userForm').reset();</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('editUserId').value = '';</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// 限制角色選項：非超級管理員不能建立超級管理員</p>
<p class="p1"><span class="Apple-converted-space">            </span>const roleSelect = document.getElementById('userRole');</p>
<p class="p1"><span class="Apple-converted-space">            </span>const superAdminOption = roleSelect.querySelector('option[value="super_admin"]');</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (currentUser.role !== 'super_admin') {</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (superAdminOption) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>superAdminOption.style.display = 'none';</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (superAdminOption) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>superAdminOption.style.display = 'block';</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('addUserModal').classList.remove('hidden');</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function closeAddUserModal() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('addUserModal').classList.add('hidden');</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function editUser(userId) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!hasPermission('manage_users')) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>showNotification('您沒有權限執行此操作！', 'error');</p>
<p class="p1"><span class="Apple-converted-space">                </span>return;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const user = adminUsers.find(u =&gt; u.id === userId);</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!user) return;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// 超級管理員可以編輯所有用戶，其他管理員不能編輯超級管理員</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (currentUser.role !== 'super_admin' &amp;&amp; user.role === 'super_admin') {</p>
<p class="p1"><span class="Apple-converted-space">                </span>showNotification('您沒有權限編輯超級管理員！', 'error');</p>
<p class="p1"><span class="Apple-converted-space">                </span>return;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('userModalTitle').textContent = '編輯用戶';</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('editUserId').value = user.id;</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('userUsername').value = user.username;</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('userName').value = user.name;</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('userPassword').value = user.password;</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('userPasswordConfirm').value = user.password;</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('userRole').value = user.role;</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('userDepartment').value = user.department || '';</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('userEmail').value = user.email || '';</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('userPhone').value = user.phone || '';</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// 限制角色選項：非超級管理員不能設定超級管理員角色</p>
<p class="p1"><span class="Apple-converted-space">            </span>const roleSelect = document.getElementById('userRole');</p>
<p class="p1"><span class="Apple-converted-space">            </span>const superAdminOption = roleSelect.querySelector('option[value="super_admin"]');</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (currentUser.role !== 'super_admin') {</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (superAdminOption) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>superAdminOption.style.display = 'none';</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (superAdminOption) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>superAdminOption.style.display = 'block';</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('addUserModal').classList.remove('hidden');</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function toggleUserStatus(userId) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!hasPermission('manage_users')) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>showNotification('您沒有權限執行此操作！', 'error');</p>
<p class="p1"><span class="Apple-converted-space">                </span>return;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const user = adminUsers.find(u =&gt; u.id === userId);</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!user) return;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (user.id === currentUser.id) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>showNotification('不能停用自己的帳號！', 'error');</p>
<p class="p1"><span class="Apple-converted-space">                </span>return;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// 非超級管理員不能停用超級管理員</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (currentUser.role !== 'super_admin' &amp;&amp; user.role === 'super_admin') {</p>
<p class="p1"><span class="Apple-converted-space">                </span>showNotification('您沒有權限操作超級管理員帳號！', 'error');</p>
<p class="p1"><span class="Apple-converted-space">                </span>return;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const action = user.status === 'active' ? '停用' : '啟用';</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (confirm(`確定要${action}用戶「${user.name}」嗎？`)) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>user.status = user.status === 'active' ? 'inactive' : 'active';</p>
<p class="p1"><span class="Apple-converted-space">                </span>localStorage.setItem('adminUsers', JSON.stringify(adminUsers));</p>
<p class="p1"><span class="Apple-converted-space">                </span>updateUserStats();</p>
<p class="p1"><span class="Apple-converted-space">                </span>showNotification(`用戶已${action}！`, 'success');</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function resetPassword(userId) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!hasPermission('manage_users')) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>showNotification('您沒有權限執行此操作！', 'error');</p>
<p class="p1"><span class="Apple-converted-space">                </span>return;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const user = adminUsers.find(u =&gt; u.id === userId);</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!user) return;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// 非超級管理員不能重設超級管理員密碼</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (currentUser.role !== 'super_admin' &amp;&amp; user.role === 'super_admin') {</p>
<p class="p1"><span class="Apple-converted-space">                </span>showNotification('您沒有權限重設超級管理員密碼！', 'error');</p>
<p class="p1"><span class="Apple-converted-space">                </span>return;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const newPassword = prompt('請輸入新密碼（至少6個字元）：', '123456');</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (newPassword &amp;&amp; newPassword.trim()) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (newPassword.trim().length &lt; 6) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>showNotification('密碼至少需要6個字元！', 'error');</p>
<p class="p1"><span class="Apple-converted-space">                    </span>return;</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">                </span>user.password = newPassword.trim();</p>
<p class="p1"><span class="Apple-converted-space">                </span>localStorage.setItem('adminUsers', JSON.stringify(adminUsers));</p>
<p class="p1"><span class="Apple-converted-space">                </span>showNotification(`用戶「${user.name}」的密碼已重設！`, 'success');</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function searchUsers() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const searchTerm = document.getElementById('searchUser').value.toLowerCase();</p>
<p class="p1"><span class="Apple-converted-space">            </span>const rows = document.querySelectorAll('#userTableBody tr');</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>rows.forEach(row =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const text = row.textContent.toLowerCase();</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (text.includes(searchTerm)) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>row.style.display = '';</p>
<p class="p1"><span class="Apple-converted-space">                </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>row.style.display = 'none';</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function filterUsers() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const roleFilter = document.getElementById('filterRole').value;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const statusFilter = document.getElementById('filterStatus').value;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>let filteredData = [...adminUsers];</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (roleFilter) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>filteredData = filteredData.filter(u =&gt; u.role === roleFilter);</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (statusFilter) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>filteredData = filteredData.filter(u =&gt; u.status === statusFilter);</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Temporarily replace database for display</p>
<p class="p1"><span class="Apple-converted-space">            </span>const originalData = [...adminUsers];</p>
<p class="p1"><span class="Apple-converted-space">            </span>adminUsers = filteredData;</p>
<p class="p1"><span class="Apple-converted-space">            </span>loadUserData();</p>
<p class="p1"><span class="Apple-converted-space">            </span>adminUsers = originalData;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function showUserProfile() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!currentUser) return;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const roleInfo = rolePermissions[currentUser.role];</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('userProfileContent').innerHTML = `</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="space-y-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="grid md:grid-cols-2 gap-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="bg-blue-50 p-4 rounded-lg"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;h4 class="font-semibold text-blue-800 mb-3"&gt;👤 基本資料&lt;/h4&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div class="space-y-2 text-sm"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div&gt;&lt;strong&gt;姓名：&lt;/strong&gt;${currentUser.name}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div&gt;&lt;strong&gt;帳號：&lt;/strong&gt;${currentUser.username}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div&gt;&lt;strong&gt;角色：&lt;/strong&gt;&lt;span class="px-2 py-1 text-xs ${roleInfo.color} text-white rounded-full"&gt;${roleInfo.name}&lt;/span&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div&gt;&lt;strong&gt;部門：&lt;/strong&gt;${currentUser.department || '未設定'}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div&gt;&lt;strong&gt;電子郵件：&lt;/strong&gt;${currentUser.email || '未設定'}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div&gt;&lt;strong&gt;電話：&lt;/strong&gt;${currentUser.phone || '未設定'}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p2"><span class="Apple-converted-space">                        </span></p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="bg-green-50 p-4 rounded-lg"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;h4 class="font-semibold text-green-800 mb-3"&gt;🔐 權限列表&lt;/h4&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div class="space-y-1 text-sm"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>${roleInfo.permissions.map(perm =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>const permNames = {</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>'view_patients': '查看病患資料',</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>'edit_patients': '編輯病患資料',</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>'delete_patients': '刪除病患資料',</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>'export_data': '匯出資料',</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>'manage_users': '管理用戶',</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>'system_settings': '系統設定'</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>};</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>return `&lt;div class="flex items-center"&gt;&lt;span class="text-green-600 mr-2"&gt;✓&lt;/span&gt;${permNames[perm] || perm}&lt;/div&gt;`;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>}).join('')}</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p2"><span class="Apple-converted-space">                    </span></p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="bg-orange-50 p-4 rounded-lg"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;h4 class="font-semibold text-orange-800 mb-3"&gt;🔧 修改密碼&lt;/h4&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;form onsubmit="changePassword(event)" class="space-y-3"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;label class="block text-sm font-medium text-gray-700 mb-1"&gt;目前密碼&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;input type="password" id="currentPassword" class="w-full p-2 border border-gray-300 rounded-lg" required&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;label class="block text-sm font-medium text-gray-700 mb-1"&gt;新密碼&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;input type="password" id="newPassword" class="w-full p-2 border border-gray-300 rounded-lg" required&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;label class="block text-sm font-medium text-gray-700 mb-1"&gt;確認新密碼&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;input type="password" id="confirmNewPassword" class="w-full p-2 border border-gray-300 rounded-lg" required&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;button type="submit" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>更新密碼</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/form&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p2"><span class="Apple-converted-space">                    </span></p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="flex gap-3"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;button onclick="closeUserProfile()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>關閉</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>`;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('userProfileModal').classList.remove('hidden');</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function closeUserProfile() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('userProfileModal').classList.add('hidden');</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function changePassword(event) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>event.preventDefault();</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const currentPassword = document.getElementById('currentPassword').value;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const newPassword = document.getElementById('newPassword').value;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const confirmNewPassword = document.getElementById('confirmNewPassword').value;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (currentPassword !== currentUser.password) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>showNotification('目前密碼不正確！', 'error');</p>
<p class="p1"><span class="Apple-converted-space">                </span>return;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (newPassword !== confirmNewPassword) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>showNotification('新密碼確認不一致！', 'error');</p>
<p class="p1"><span class="Apple-converted-space">                </span>return;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (newPassword.length &lt; 6) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>showNotification('新密碼至少需要6個字元！', 'error');</p>
<p class="p1"><span class="Apple-converted-space">                </span>return;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Update password</p>
<p class="p1"><span class="Apple-converted-space">            </span>currentUser.password = newPassword;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const userIndex = adminUsers.findIndex(u =&gt; u.id === currentUser.id);</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (userIndex !== -1) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>adminUsers[userIndex].password = newPassword;</p>
<p class="p1"><span class="Apple-converted-space">                </span>localStorage.setItem('adminUsers', JSON.stringify(adminUsers));</p>
<p class="p1"><span class="Apple-converted-space">                </span>showNotification('密碼已成功更新！', 'success');</p>
<p class="p1"><span class="Apple-converted-space">                </span>closeUserProfile();</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Handle user form submission</p>
<p class="p1"><span class="Apple-converted-space">        </span>document.addEventListener('DOMContentLoaded', function() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const userForm = document.getElementById('userForm');</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (userForm) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>userForm.addEventListener('submit', function(event) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>event.preventDefault();</p>
<p class="p2"><span class="Apple-converted-space">                    </span></p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (!hasPermission('manage_users')) {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>showNotification('您沒有權限執行此操作！', 'error');</p>
<p class="p1"><span class="Apple-converted-space">                        </span>return;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p2"><span class="Apple-converted-space">                    </span></p>
<p class="p1"><span class="Apple-converted-space">                    </span>const editUserId = document.getElementById('editUserId').value;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const username = document.getElementById('userUsername').value;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const name = document.getElementById('userName').value;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const password = document.getElementById('userPassword').value;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const passwordConfirm = document.getElementById('userPasswordConfirm').value;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const role = document.getElementById('userRole').value;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const department = document.getElementById('userDepartment').value;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const email = document.getElementById('userEmail').value;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const phone = document.getElementById('userPhone').value;</p>
<p class="p2"><span class="Apple-converted-space">                    </span></p>
<p class="p1"><span class="Apple-converted-space">                    </span>// Validation</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (password !== passwordConfirm) {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>showNotification('密碼確認不一致！', 'error');</p>
<p class="p1"><span class="Apple-converted-space">                        </span>return;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p2"><span class="Apple-converted-space">                    </span></p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (password.length &lt; 6) {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>showNotification('密碼至少需要6個字元！', 'error');</p>
<p class="p1"><span class="Apple-converted-space">                        </span>return;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p2"><span class="Apple-converted-space">                    </span></p>
<p class="p1"><span class="Apple-converted-space">                    </span>// Check if username already exists (for new users or different user)</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const existingUser = adminUsers.find(u =&gt; u.username === username &amp;&amp; u.id != editUserId);</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (existingUser) {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>showNotification('帳號已存在！', 'error');</p>
<p class="p1"><span class="Apple-converted-space">                        </span>return;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p2"><span class="Apple-converted-space">                    </span></p>
<p class="p1"><span class="Apple-converted-space">                    </span>// 檢查角色權限：非超級管理員不能建立或編輯為超級管理員</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (currentUser.role !== 'super_admin' &amp;&amp; role === 'super_admin') {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>showNotification('您沒有權限設定超級管理員角色！', 'error');</p>
<p class="p1"><span class="Apple-converted-space">                        </span>return;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p2"><span class="Apple-converted-space">                    </span></p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (editUserId) {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>// Edit existing user</p>
<p class="p1"><span class="Apple-converted-space">                        </span>const userIndex = adminUsers.findIndex(u =&gt; u.id == editUserId);</p>
<p class="p1"><span class="Apple-converted-space">                        </span>if (userIndex !== -1) {</p>
<p class="p1"><span class="Apple-converted-space">                            </span>const targetUser = adminUsers[userIndex];</p>
<p class="p2"><span class="Apple-converted-space">                            </span></p>
<p class="p1"><span class="Apple-converted-space">                            </span>// 檢查是否有權限編輯此用戶</p>
<p class="p1"><span class="Apple-converted-space">                            </span>if (currentUser.role !== 'super_admin' &amp;&amp; targetUser.role === 'super_admin') {</p>
<p class="p1"><span class="Apple-converted-space">                                </span>showNotification('您沒有權限編輯超級管理員！', 'error');</p>
<p class="p1"><span class="Apple-converted-space">                                </span>return;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>}</p>
<p class="p2"><span class="Apple-converted-space">                            </span></p>
<p class="p1"><span class="Apple-converted-space">                            </span>adminUsers[userIndex] = {</p>
<p class="p1"><span class="Apple-converted-space">                                </span>...adminUsers[userIndex],</p>
<p class="p1"><span class="Apple-converted-space">                                </span>username,</p>
<p class="p1"><span class="Apple-converted-space">                                </span>name,</p>
<p class="p1"><span class="Apple-converted-space">                                </span>password,</p>
<p class="p1"><span class="Apple-converted-space">                                </span>role,</p>
<p class="p1"><span class="Apple-converted-space">                                </span>department,</p>
<p class="p1"><span class="Apple-converted-space">                                </span>email,</p>
<p class="p1"><span class="Apple-converted-space">                                </span>phone</p>
<p class="p1"><span class="Apple-converted-space">                            </span>};</p>
<p class="p1"><span class="Apple-converted-space">                            </span>showNotification('用戶資料已更新！', 'success');</p>
<p class="p1"><span class="Apple-converted-space">                        </span>}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>// Add new user</p>
<p class="p1"><span class="Apple-converted-space">                        </span>const newUser = {</p>
<p class="p1"><span class="Apple-converted-space">                            </span>id: Date.now(),</p>
<p class="p1"><span class="Apple-converted-space">                            </span>username,</p>
<p class="p1"><span class="Apple-converted-space">                            </span>name,</p>
<p class="p1"><span class="Apple-converted-space">                            </span>password,</p>
<p class="p1"><span class="Apple-converted-space">                            </span>role,</p>
<p class="p1"><span class="Apple-converted-space">                            </span>department,</p>
<p class="p1"><span class="Apple-converted-space">                            </span>email,</p>
<p class="p1"><span class="Apple-converted-space">                            </span>phone,</p>
<p class="p1"><span class="Apple-converted-space">                            </span>createdAt: new Date().toISOString(),</p>
<p class="p1"><span class="Apple-converted-space">                            </span>lastLogin: null,</p>
<p class="p1"><span class="Apple-converted-space">                            </span>status: 'active'</p>
<p class="p1"><span class="Apple-converted-space">                        </span>};</p>
<p class="p1"><span class="Apple-converted-space">                        </span>adminUsers.push(newUser);</p>
<p class="p1"><span class="Apple-converted-space">                        </span>showNotification('新用戶已成功建立！', 'success');</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p2"><span class="Apple-converted-space">                    </span></p>
<p class="p1"><span class="Apple-converted-space">                    </span>localStorage.setItem('adminUsers', JSON.stringify(adminUsers));</p>
<p class="p1"><span class="Apple-converted-space">                    </span>updateUserStats();</p>
<p class="p1"><span class="Apple-converted-space">                    </span>closeAddUserModal();</p>
<p class="p1"><span class="Apple-converted-space">                </span>});</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Admin functionality</p>
<p class="p1"><span class="Apple-converted-space">        </span>function toggleAdminMode() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!isAdminMode) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>document.getElementById('adminLoginModal').classList.remove('hidden');</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                </span>exitAdminMode();</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function adminLogin() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const username = document.getElementById('adminUsername').value;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const password = document.getElementById('adminPassword').value;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Find user in admin database</p>
<p class="p1"><span class="Apple-converted-space">            </span>const user = adminUsers.find(u =&gt; u.username === username &amp;&amp; u.password === password &amp;&amp; u.status === 'active');</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (user) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>isAdminMode = true;</p>
<p class="p1"><span class="Apple-converted-space">                </span>currentUser = user;</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>// Update last login time</p>
<p class="p1"><span class="Apple-converted-space">                </span>user.lastLogin = new Date().toISOString();</p>
<p class="p1"><span class="Apple-converted-space">                </span>localStorage.setItem('adminUsers', JSON.stringify(adminUsers));</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>// Show admin tabs based on permissions</p>
<p class="p1"><span class="Apple-converted-space">                </span>document.getElementById('adminTab').classList.remove('hidden');</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (hasPermission('manage_users')) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>document.getElementById('usersTab').classList.remove('hidden');</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>document.getElementById('adminToggle').textContent = '🚪 退出管理';</p>
<p class="p1"><span class="Apple-converted-space">                </span>document.getElementById('mainHeader').classList.remove('gradient-bg');</p>
<p class="p1"><span class="Apple-converted-space">                </span>document.getElementById('mainHeader').classList.add('admin-mode');</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>// Update current user info</p>
<p class="p1"><span class="Apple-converted-space">                </span>const roleInfo = rolePermissions[user.role];</p>
<p class="p1"><span class="Apple-converted-space">                </span>document.getElementById('currentUserInfo').innerHTML = `</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="text-right"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="font-medium"&gt;${user.name}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="text-xs ${roleInfo.color} text-white px-2 py-1 rounded-full inline-block"&gt;${roleInfo.name}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>`;</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>closeAdminLogin();</p>
<p class="p1"><span class="Apple-converted-space">                </span>showTab('admin');</p>
<p class="p1"><span class="Apple-converted-space">                </span>loadPatientData();</p>
<p class="p1"><span class="Apple-converted-space">                </span>updateUserStats();</p>
<p class="p1"><span class="Apple-converted-space">                </span>showNotification(`歡迎回來，${user.name}！`, 'success');</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                </span>showNotification('帳號或密碼�誤，或帳號已被停用！', 'error');</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function closeAdminLogin() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('adminLoginModal').classList.add('hidden');</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('adminUsername').value = '';</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('adminPassword').value = '';</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function exitAdminMode() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>isAdminMode = false;</p>
<p class="p1"><span class="Apple-converted-space">            </span>currentUser = null;</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('adminTab').classList.add('hidden');</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('usersTab').classList.add('hidden');</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('adminToggle').textContent = '🔐 管理員模式';</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('mainHeader').classList.remove('admin-mode');</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('mainHeader').classList.add('gradient-bg');</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('currentUserInfo').textContent = '未登入';</p>
<p class="p1"><span class="Apple-converted-space">            </span>showTab('symptoms');</p>
<p class="p1"><span class="Apple-converted-space">            </span>showNotification('已退出管理員模式', 'info');</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Calculate age from birthdate</p>
<p class="p1"><span class="Apple-converted-space">        </span>function calculateAge() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const birthdateInput = document.getElementById('patientBirthdate');</p>
<p class="p1"><span class="Apple-converted-space">            </span>const ageInput = document.getElementById('patientAge');</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (birthdateInput.value) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const birthDate = new Date(birthdateInput.value);</p>
<p class="p1"><span class="Apple-converted-space">                </span>const today = new Date();</p>
<p class="p1"><span class="Apple-converted-space">                </span>let age = today.getFullYear() - birthDate.getFullYear();</p>
<p class="p1"><span class="Apple-converted-space">                </span>const monthDiff = today.getMonth() - birthDate.getMonth();</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>if (monthDiff &lt; 0 || (monthDiff === 0 &amp;&amp; today.getDate() &lt; birthDate.getDate())) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>age--;</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>ageInput.value = age + ' 歲';</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                </span>ageInput.value = '';</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Tab switching functionality</p>
<p class="p1"><span class="Apple-converted-space">        </span>function showTab(tabName) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>// Hide all tab contents</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.querySelectorAll('.tab-content').forEach(content =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>content.classList.add('hidden');</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Remove active class from all tabs</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.querySelectorAll('.tab-btn').forEach(btn =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>btn.classList.remove('bg-blue-500', 'text-white');</p>
<p class="p1"><span class="Apple-converted-space">                </span>btn.classList.add('bg-gray-200', 'text-gray-700');</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Show selected tab content</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById(tabName + 'Content').classList.remove('hidden');</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Add active class to selected tab</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById(tabName + 'Tab').classList.remove('bg-gray-200', 'text-gray-700');</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById(tabName + 'Tab').classList.add('bg-blue-500', 'text-white');</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Load questions into the questionnaire</p>
<p class="p1"><span class="Apple-converted-space">        </span>function loadQuestions() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const container = document.getElementById('questionnaireContainer');</p>
<p class="p1"><span class="Apple-converted-space">            </span>container.innerHTML = '';</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>questions.forEach((q, index) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const questionDiv = document.createElement('div');</p>
<p class="p1"><span class="Apple-converted-space">                </span>questionDiv.className = 'bg-white p-5 rounded-lg border border-gray-200 shadow-sm';</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>if (isManageMode) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>questionDiv.innerHTML = `</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="flex justify-between items-start mb-4"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;h4 class="text-lg font-medium text-gray-800 flex-1"&gt;${q.question}&lt;/h4&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div class="flex gap-2 ml-4"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;button onclick="editQuestion(${index})" class="text-blue-600 hover:text-blue-800 px-2 py-1 text-sm"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>✏️ 編輯</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;button onclick="deleteQuestion(${index})" class="text-red-600 hover:text-red-800 px-2 py-1 text-sm"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>🗑️ 刪除</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="space-y-2"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>${q.options.map((option, optIndex) =&gt; `</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;label class="flex items-center p-2 bg-gray-50 rounded cursor-pointer hover:bg-blue-50 transition-colors"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;input type="radio" name="question_${q.id}" value="${optIndex}" class="mr-3" onchange="recordAnswer(${q.id}, ${optIndex}, '${q.category}')"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;span class="text-gray-700"&gt;${option}&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>`).join('')}</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>questionDiv.innerHTML = `</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;h4 class="text-lg font-medium text-gray-800 mb-4 flex items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;span class="bg-green-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold mr-3"&gt;${index + 1}&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>${q.question}</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/h4&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="space-y-2"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>${q.options.map((option, optIndex) =&gt; `</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;label class="flex items-center p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-green-50 transition-colors border-2 border-transparent hover:border-green-200"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;input type="radio" name="question_${q.id}" value="${optIndex}" class="mr-3 text-green-500" onchange="recordAnswer(${q.id}, ${optIndex}, '${q.category}')"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;span class="text-gray-700"&gt;${option}&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>`).join('')}</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>container.appendChild(questionDiv);</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Record user answer</p>
<p class="p1"><span class="Apple-converted-space">        </span>function recordAnswer(questionId, answerIndex, category) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>userAnswers[questionId] = {</p>
<p class="p1"><span class="Apple-converted-space">                </span>answerIndex: answerIndex,</p>
<p class="p1"><span class="Apple-converted-space">                </span>category: category</p>
<p class="p1"><span class="Apple-converted-space">            </span>};</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Add custom question</p>
<p class="p1"><span class="Apple-converted-space">        </span>function addCustomQuestion() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const questionInput = document.getElementById('customQuestionInput');</p>
<p class="p1"><span class="Apple-converted-space">            </span>const answerA = document.getElementById('customAnswerA');</p>
<p class="p1"><span class="Apple-converted-space">            </span>const answerB = document.getElementById('customAnswerB');</p>
<p class="p1"><span class="Apple-converted-space">            </span>const answerC = document.getElementById('customAnswerC');</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const question = questionInput.value.trim();</p>
<p class="p1"><span class="Apple-converted-space">            </span>const optionA = answerA.value.trim();</p>
<p class="p1"><span class="Apple-converted-space">            </span>const optionB = answerB.value.trim();</p>
<p class="p1"><span class="Apple-converted-space">            </span>const optionC = answerC.value.trim();</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!question || !optionA || !optionB) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>alert('請填寫問題內容和至少兩個選項');</p>
<p class="p1"><span class="Apple-converted-space">                </span>return;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const options = [optionA, optionB];</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (optionC) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>options.push(optionC);</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const newQuestion = {</p>
<p class="p1"><span class="Apple-converted-space">                </span>id: Date.now(),</p>
<p class="p1"><span class="Apple-converted-space">                </span>question: question,</p>
<p class="p1"><span class="Apple-converted-space">                </span>options: options,</p>
<p class="p1"><span class="Apple-converted-space">                </span>category: "custom"</p>
<p class="p1"><span class="Apple-converted-space">            </span>};</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>questions.push(newQuestion);</p>
<p class="p1"><span class="Apple-converted-space">            </span>loadQuestions();</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Clear inputs</p>
<p class="p1"><span class="Apple-converted-space">            </span>questionInput.value = '';</p>
<p class="p1"><span class="Apple-converted-space">            </span>answerA.value = '';</p>
<p class="p1"><span class="Apple-converted-space">            </span>answerB.value = '';</p>
<p class="p1"><span class="Apple-converted-space">            </span>answerC.value = '';</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>showNotification('問題已成功新增！', 'success');</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Toggle manage mode</p>
<p class="p1"><span class="Apple-converted-space">        </span>function toggleManageMode() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>isManageMode = !isManageMode;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const manageBtnText = document.getElementById('manageBtnText');</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (isManageMode) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>manageBtnText.textContent = '完成管理';</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                </span>manageBtnText.textContent = '管理問題';</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>loadQuestions();</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Edit question</p>
<p class="p1"><span class="Apple-converted-space">        </span>function editQuestion(index) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const question = questions[index];</p>
<p class="p1"><span class="Apple-converted-space">            </span>const newQuestion = prompt('編輯問題內容:', question.question);</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (newQuestion &amp;&amp; newQuestion.trim()) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>questions[index].question = newQuestion.trim();</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>for (let i = 0; i &lt; question.options.length; i++) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const newOption = prompt(`編輯選項 ${i + 1}:`, question.options[i]);</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (newOption &amp;&amp; newOption.trim()) {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>questions[index].options[i] = newOption.trim();</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>loadQuestions();</p>
<p class="p1"><span class="Apple-converted-space">                </span>showNotification('問題已更新！', 'success');</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Delete question</p>
<p class="p1"><span class="Apple-converted-space">        </span>function deleteQuestion(index) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (confirm('確定要刪除此問題嗎？')) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>questions.splice(index, 1);</p>
<p class="p1"><span class="Apple-converted-space">                </span>loadQuestions();</p>
<p class="p1"><span class="Apple-converted-space">                </span>showNotification('問題已刪除！', 'warning');</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Show notification</p>
<p class="p1"><span class="Apple-converted-space">        </span>function showNotification(message, type = 'info') {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const notification = document.createElement('div');</p>
<p class="p1"><span class="Apple-converted-space">            </span>const colors = {</p>
<p class="p1"><span class="Apple-converted-space">                </span>success: 'bg-green-500 text-white',</p>
<p class="p1"><span class="Apple-converted-space">                </span>error: 'bg-red-500 text-white',</p>
<p class="p1"><span class="Apple-converted-space">                </span>warning: 'bg-yellow-500 text-white',</p>
<p class="p1"><span class="Apple-converted-space">                </span>info: 'bg-blue-500 text-white'</p>
<p class="p1"><span class="Apple-converted-space">            </span>};</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all duration-300 ${colors[type]}`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>notification.textContent = message;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>document.body.appendChild(notification);</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>setTimeout(() =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>notification.style.opacity = '0';</p>
<p class="p1"><span class="Apple-converted-space">                </span>setTimeout(() =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (document.body.contains(notification)) {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>document.body.removeChild(notification);</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                </span>}, 300);</p>
<p class="p1"><span class="Apple-converted-space">            </span>}, 3000);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Save patient data to database</p>
<p class="p1"><span class="Apple-converted-space">        </span>function savePatientData(patientData) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const patientRecord = {</p>
<p class="p1"><span class="Apple-converted-space">                </span>id: Date.now(),</p>
<p class="p1"><span class="Apple-converted-space">                </span>timestamp: new Date().toISOString(),</p>
<p class="p1"><span class="Apple-converted-space">                </span>...patientData,</p>
<p class="p1"><span class="Apple-converted-space">                </span>status: 'pending'</p>
<p class="p1"><span class="Apple-converted-space">            </span>};</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>patientDatabase.push(patientRecord);</p>
<p class="p1"><span class="Apple-converted-space">            </span>localStorage.setItem('patientDatabase', JSON.stringify(patientDatabase));</p>
<p class="p1"><span class="Apple-converted-space">            </span>updateAdminStats();</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>return patientRecord.id;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Questionnaire analysis functionality</p>
<p class="p1"><span class="Apple-converted-space">        </span>function analyzeSymptoms() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>// Validate required fields</p>
<p class="p1"><span class="Apple-converted-space">            </span>const requiredFields = ['patientName', 'patientGender', 'patientBirthdate', 'patientPhone'];</p>
<p class="p1"><span class="Apple-converted-space">            </span>const missingFields = [];</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>requiredFields.forEach(fieldId =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const field = document.getElementById(fieldId);</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (!field.value.trim()) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>missingFields.push(field.previousElementSibling.textContent.replace(' *', ''));</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (missingFields.length &gt; 0) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>alert(`請填寫必填欄位：${missingFields.join('、')}`);</p>
<p class="p1"><span class="Apple-converted-space">                </span>return;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const additionalInfo = document.getElementById('additionalSymptoms').value;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (Object.keys(userAnswers).length === 0 &amp;&amp; !additionalInfo.trim()) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>alert('請至少回答一個問題或填寫補充說明');</p>
<p class="p1"><span class="Apple-converted-space">                </span>return;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Collect personal information</p>
<p class="p1"><span class="Apple-converted-space">            </span>const personalInfo = {</p>
<p class="p1"><span class="Apple-converted-space">                </span>name: document.getElementById('patientName').value,</p>
<p class="p1"><span class="Apple-converted-space">                </span>gender: document.getElementById('patientGender').value,</p>
<p class="p1"><span class="Apple-converted-space">                </span>birthdate: document.getElementById('patientBirthdate').value,</p>
<p class="p1"><span class="Apple-converted-space">                </span>age: document.getElementById('patientAge').value,</p>
<p class="p1"><span class="Apple-converted-space">                </span>phone: document.getElementById('patientPhone').value,</p>
<p class="p1"><span class="Apple-converted-space">                </span>occupation: document.getElementById('patientOccupation').value,</p>
<p class="p1"><span class="Apple-converted-space">                </span>currentIllness: document.getElementById('currentIllness').value,</p>
<p class="p1"><span class="Apple-converted-space">                </span>pastHistory: document.getElementById('pastHistory').value,</p>
<p class="p1"><span class="Apple-converted-space">                </span>familyHistory: document.getElementById('familyHistory').value,</p>
<p class="p1"><span class="Apple-converted-space">                </span>allergyHistory: document.getElementById('allergyHistory').value,</p>
<p class="p1"><span class="Apple-converted-space">                </span>currentMedication: document.getElementById('currentMedication').value,</p>
<p class="p1"><span class="Apple-converted-space">                </span>additionalSymptoms: additionalInfo,</p>
<p class="p1"><span class="Apple-converted-space">                </span>answers: userAnswers</p>
<p class="p1"><span class="Apple-converted-space">            </span>};</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Save to database</p>
<p class="p1"><span class="Apple-converted-space">            </span>const patientId = savePatientData(personalInfo);</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Analyze answers and generate diagnosis</p>
<p class="p1"><span class="Apple-converted-space">            </span>const analysisResult = analyzeAnswers(userAnswers, additionalInfo, personalInfo);</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('diagnosisResult').innerHTML = analysisResult.diagnosis;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Generate prescription and acupuncture recommendations</p>
<p class="p1"><span class="Apple-converted-space">            </span>generatePrescription(analysisResult.symptoms, personalInfo);</p>
<p class="p1"><span class="Apple-converted-space">            </span>generateAcupuncture(analysisResult.symptoms, personalInfo);</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>showNotification('問診資料已成功提交並保存！', 'success');</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Analyze user answers to determine symptoms and patterns</p>
<p class="p1"><span class="Apple-converted-space">        </span>function analyzeAnswers(answers, additionalInfo, personalInfo) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const symptoms = [];</p>
<p class="p1"><span class="Apple-converted-space">            </span>const severityScores = {</p>
<p class="p1"><span class="Apple-converted-space">                </span>sleep: 0,</p>
<p class="p1"><span class="Apple-converted-space">                </span>digestion: 0,</p>
<p class="p1"><span class="Apple-converted-space">                </span>energy: 0,</p>
<p class="p1"><span class="Apple-converted-space">                </span>head: 0,</p>
<p class="p1"><span class="Apple-converted-space">                </span>respiratory: 0,</p>
<p class="p1"><span class="Apple-converted-space">                </span>musculoskeletal: 0</p>
<p class="p1"><span class="Apple-converted-space">            </span>};</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Analyze each answer</p>
<p class="p1"><span class="Apple-converted-space">            </span>Object.values(answers).forEach(answer =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (severityScores.hasOwnProperty(answer.category)) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>severityScores[answer.category] = answer.answerIndex;</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Determine symptoms based on severity scores</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (severityScores.sleep &gt;= 1) symptoms.push('失眠');</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (severityScores.digestion &gt;= 1) symptoms.push('消化不良');</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (severityScores.energy &gt;= 1) symptoms.push('疲勞');</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (severityScores.head &gt;= 1) symptoms.push('頭痛');</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (severityScores.respiratory &gt;= 1) symptoms.push('咳嗽');</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (severityScores.musculoskeletal &gt;= 1) symptoms.push('腰痛');</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Generate diagnosis based on dominant patterns</p>
<p class="p1"><span class="Apple-converted-space">            </span>const diagnosis = generateDiagnosisFromAnswers(severityScores, symptoms, additionalInfo, personalInfo);</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>return {</p>
<p class="p1"><span class="Apple-converted-space">                </span>symptoms: symptoms,</p>
<p class="p1"><span class="Apple-converted-space">                </span>diagnosis: diagnosis</p>
<p class="p1"><span class="Apple-converted-space">            </span>};</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function generateDiagnosisFromAnswers(severityScores, symptoms, additionalInfo, personalInfo) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>// Determine primary pattern based on most severe symptoms</p>
<p class="p1"><span class="Apple-converted-space">            </span>let primaryPattern = '氣血不調';</p>
<p class="p1"><span class="Apple-converted-space">            </span>let description = '整體氣血運行不暢，需要調理';</p>
<p class="p1"><span class="Apple-converted-space">            </span>let severity = '輕度';</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Calculate overall severity</p>
<p class="p1"><span class="Apple-converted-space">            </span>const totalSeverity = Object.values(severityScores).reduce((sum, score) =&gt; sum + score, 0);</p>
<p class="p1"><span class="Apple-converted-space">            </span>const avgSeverity = totalSeverity / Object.keys(severityScores).length;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (avgSeverity &gt;= 1.5) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>severity = '重度';</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else if (avgSeverity &gt;= 0.8) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>severity = '中度';</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Determine primary pattern based on dominant symptoms</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (severityScores.sleep &gt;= 2 || severityScores.energy &gt;= 2) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>primaryPattern = '心腎不交';</p>
<p class="p1"><span class="Apple-converted-space">                </span>description = '心火亢盛，腎水不足，心腎不能相交';</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else if (severityScores.digestion &gt;= 2) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>primaryPattern = '脾胃虛弱';</p>
<p class="p1"><span class="Apple-converted-space">                </span>description = '脾胃功能失調，運化失常';</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else if (severityScores.head &gt;= 2) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>primaryPattern = '肝陽上亢';</p>
<p class="p1"><span class="Apple-converted-space">                </span>description = '肝火旺盛，陽氣上逆';</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else if (severityScores.respiratory &gt;= 2) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>primaryPattern = '肺氣不宣';</p>
<p class="p1"><span class="Apple-converted-space">                </span>description = '肺氣壅滯，宣降失常';</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else if (severityScores.musculoskeletal &gt;= 2) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>primaryPattern = '腎虛腰痛';</p>
<p class="p1"><span class="Apple-converted-space">                </span>description = '腎氣不足，腰府失養';</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Generate detailed analysis</p>
<p class="p1"><span class="Apple-converted-space">            </span>const answeredQuestions = Object.keys(userAnswers).length;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const symptomsList = symptoms.length &gt; 0 ? symptoms.join('、') : '無明顯症狀';</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>return `</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="space-y-4"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>${personalInfo.name ? `</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="bg-indigo-50 border-l-4 border-indigo-400 p-4 rounded"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;h4 class="font-semibold text-indigo-800 mb-2 flex items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;span class="text-lg mr-2"&gt;👤&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>患者資料</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/h4&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="grid md:grid-cols-2 gap-2 text-sm text-indigo-700"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>${personalInfo.name ? `&lt;div&gt;&lt;strong&gt;姓名：&lt;/strong&gt;${personalInfo.name}&lt;/div&gt;` : ''}</p>
<p class="p1"><span class="Apple-converted-space">                            </span>${personalInfo.gender ? `&lt;div&gt;&lt;strong&gt;性別：&lt;/strong&gt;${personalInfo.gender === 'male' ? '男性' : '女性'}&lt;/div&gt;` : ''}</p>
<p class="p1"><span class="Apple-converted-space">                            </span>${personalInfo.age ? `&lt;div&gt;&lt;strong&gt;年齡：&lt;/strong&gt;${personalInfo.age}&lt;/div&gt;` : ''}</p>
<p class="p1"><span class="Apple-converted-space">                            </span>${personalInfo.occupation ? `&lt;div&gt;&lt;strong&gt;職業：&lt;/strong&gt;${personalInfo.occupation}&lt;/div&gt;` : ''}</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>` : ''}</p>
<p class="p2"><span class="Apple-converted-space">                    </span></p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="flex items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;span class="text-2xl mr-3"&gt;🎯&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;h4 class="text-lg font-semibold text-gray-800"&gt;中醫證型：${primaryPattern}&lt;/h4&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;span class="ml-3 px-2 py-1 text-xs font-medium rounded-full ${</p>
<p class="p1"><span class="Apple-converted-space">                            </span>severity === '重度' ? 'bg-red-100 text-red-800' :</p>
<p class="p1"><span class="Apple-converted-space">                            </span>severity === '中度' ? 'bg-yellow-100 text-yellow-800' :</p>
<p class="p1"><span class="Apple-converted-space">                            </span>'bg-green-100 text-green-800'</p>
<p class="p1"><span class="Apple-converted-space">                        </span>}"&gt;${severity}&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;p class="text-gray-700"&gt;&lt;strong&gt;病機分析：&lt;/strong&gt;${description}&lt;/p&gt;</p>
<p class="p2"><span class="Apple-converted-space">                    </span></p>
<p class="p1"><span class="Apple-converted-space">                    </span>${personalInfo.currentIllness || personalInfo.pastHistory || personalInfo.allergyHistory || personalInfo.currentMedication ? `</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="bg-orange-50 border-l-4 border-orange-400 p-4 rounded"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;h5 class="font-semibold text-orange-800 mb-2"&gt;📋 病史摘要&lt;/h5&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="text-sm text-orange-700 space-y-1"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>${personalInfo.currentIllness ? `&lt;div&gt;&lt;strong&gt;現病史：&lt;/strong&gt;${personalInfo.currentIllness}&lt;/div&gt;` : ''}</p>
<p class="p1"><span class="Apple-converted-space">                            </span>${personalInfo.pastHistory ? `&lt;div&gt;&lt;strong&gt;既往史：&lt;/strong&gt;${personalInfo.pastHistory}&lt;/div&gt;` : ''}</p>
<p class="p1"><span class="Apple-converted-space">                            </span>${personalInfo.allergyHistory ? `&lt;div&gt;&lt;strong&gt;過敏史：&lt;/strong&gt;${personalInfo.allergyHistory}&lt;/div&gt;` : ''}</p>
<p class="p1"><span class="Apple-converted-space">                            </span>${personalInfo.currentMedication ? `&lt;div&gt;&lt;strong&gt;目前用藥：&lt;/strong&gt;${personalInfo.currentMedication}&lt;/div&gt;` : ''}</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>` : ''}</p>
<p class="p2"><span class="Apple-converted-space">                    </span></p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;p class="text-sm text-blue-800"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;strong&gt;問診結果：&lt;/strong&gt;已回答 ${answeredQuestions} 個問題&lt;br&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;strong&gt;主要症狀：&lt;/strong&gt;${symptomsList}</p>
<p class="p1"><span class="Apple-converted-space">                            </span>${additionalInfo ? `&lt;br&gt;&lt;strong&gt;補充說明：&lt;/strong&gt;${additionalInfo}` : ''}</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="grid md:grid-cols-2 gap-4"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="bg-green-50 p-4 rounded-lg"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;h5 class="font-semibold text-green-800 mb-2"&gt;📊 症狀評估：&lt;/h5&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div class="space-y-2 text-sm"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>${Object.entries(severityScores).map(([category, score]) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>const categoryNames = {</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>sleep: '睡眠',</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>digestion: '消化',</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>energy: '精神',</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>head: '頭部',</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>respiratory: '呼吸',</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>musculoskeletal: '筋骨'</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>};</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>const level = score === 0 ? '正常' : score === 1 ? '輕度' : '重度';</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>const color = score === 0 ? 'text-green-600' : score === 1 ? 'text-yellow-600' : 'text-red-600';</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>return `&lt;div class="flex justify-between"&gt;&lt;span&gt;${categoryNames[category]}：&lt;/span&gt;&lt;span class="${color}"&gt;${level}&lt;/span&gt;&lt;/div&gt;`;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>}).join('')}</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="bg-purple-50 p-4 rounded-lg"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;h5 class="font-semibold text-purple-800 mb-2"&gt;💡 調理建議：&lt;/h5&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;ul class="text-sm text-purple-700 space-y-1"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;li&gt;• 規律作息，早睡早起&lt;/li&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;li&gt;• 飲食清淡，避免生冷&lt;/li&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;li&gt;• 適度運動，舒緩壓力&lt;/li&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;li&gt;• 配合中藥調理體質&lt;/li&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/ul&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="mt-4 p-4 bg-green-50 rounded-lg"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;p class="text-green-800 font-medium"&gt;✅ 問診分析完成！資料已提交至後台系統。請切換到「方藥建議」和「針灸方案」查看詳細治療建議&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>`;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function generatePrescription(symptoms, personalInfo = {}) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const prescriptions = {</p>
<p class="p1"><span class="Apple-converted-space">                </span>'頭痛': {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>formula: '天麻鉤藤飲',</p>
<p class="p1"><span class="Apple-converted-space">                    </span>ingredients: ['天麻 10g', '鉤藤 15g', '石決明 20g', '梔子 10g', '黃芩 10g', '川牛膝 12g', '杜仲 15g', '益母草 15g', '桑寄生 15g', '夜交藤 15g', '茯神 12g'],</p>
<p class="p1"><span class="Apple-converted-space">                    </span>usage: '水煎服，每日一劑，分早晚兩次溫服'</p>
<p class="p1"><span class="Apple-converted-space">                </span>},</p>
<p class="p1"><span class="Apple-converted-space">                </span>'失眠': {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>formula: '甘麥大棗湯合交泰丸',</p>
<p class="p1"><span class="Apple-converted-space">                    </span>ingredients: ['甘草 6g', '小麥 30g', '大棗 10枚', '黃連 3g', '肉桂 1g', '酸棗仁 15g', '龍骨 20g', '牡蠣 20g'],</p>
<p class="p1"><span class="Apple-converted-space">                    </span>usage: '水煎服，每日一劑，睡前溫服'</p>
<p class="p1"><span class="Apple-converted-space">                </span>},</p>
<p class="p1"><span class="Apple-converted-space">                </span>'消化不良': {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>formula: '香砂六君子湯',</p>
<p class="p1"><span class="Apple-converted-space">                    </span>ingredients: ['人參 10g', '白朮 12g', '茯苓 15g', '甘草 6g', '陳皮 10g', '半夏 10g', '木香 6g', '砂仁 6g'],</p>
<p class="p1"><span class="Apple-converted-space">                    </span>usage: '水煎服，每日一劑，飯前溫服'</p>
<p class="p1"><span class="Apple-converted-space">                </span>},</p>
<p class="p1"><span class="Apple-converted-space">                </span>'疲勞': {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>formula: '補中益氣湯',</p>
<p class="p1"><span class="Apple-converted-space">                    </span>ingredients: ['黃耆 30g', '人參 10g', '白朮 12g', '甘草 6g', '當歸 10g', '陳皮 6g', '升麻 6g', '柴胡 6g'],</p>
<p class="p1"><span class="Apple-converted-space">                    </span>usage: '水煎服，每日一劑，分早晚兩次溫服'</p>
<p class="p1"><span class="Apple-converted-space">                </span>},</p>
<p class="p1"><span class="Apple-converted-space">                </span>'咳嗽': {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>formula: '清肺湯',</p>
<p class="p1"><span class="Apple-converted-space">                    </span>ingredients: ['桑葉 12g', '菊花 10g', '杏仁 10g', '連翹 12g', '薄荷 6g', '桔梗 10g', '甘草 6g', '蘆根 20g'],</p>
<p class="p1"><span class="Apple-converted-space">                    </span>usage: '水煎服，每日一劑，分早晚兩次溫服'</p>
<p class="p1"><span class="Apple-converted-space">                </span>},</p>
<p class="p1"><span class="Apple-converted-space">                </span>'腰痛': {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>formula: '右歸丸',</p>
<p class="p1"><span class="Apple-converted-space">                    </span>ingredients: ['熟地黃 24g', '山藥 12g', '山茱萸 9g', '枸杞子 12g', '鹿角膠 12g', '菟絲子 12g', '杜仲 12g', '當歸 9g'],</p>
<p class="p1"><span class="Apple-converted-space">                    </span>usage: '蜜丸，每次9g，每日兩次，溫開水送服'</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>};</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>let prescription = prescriptions['疲勞']; // Default</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (symptoms.length &gt; 0 &amp;&amp; prescriptions[symptoms[0]]) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>prescription = prescriptions[symptoms[0]];</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('prescriptionResult').innerHTML = `</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="space-y-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="bg-gradient-to-r from-green-50 to-blue-50 p-6 rounded-lg border-l-4 border-green-500"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;span class="text-2xl mr-3"&gt;📜&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>推薦方劑：${prescription.formula}</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/h3&gt;</p>
<p class="p2"><span class="Apple-converted-space">                        </span></p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="grid md:grid-cols-2 gap-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;h4 class="font-semibold text-gray-700 mb-3"&gt;🌿 藥物組成：&lt;/h4&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div class="space-y-2"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>${prescription.ingredients.map(ingredient =&gt;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                                        </span>`&lt;div class="bg-white p-2 rounded border-l-2 border-green-300"&gt;${ingredient}&lt;/div&gt;`</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>).join('')}</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p2"><span class="Apple-converted-space">                            </span></p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;h4 class="font-semibold text-gray-700 mb-3"&gt;💡 服用方法：&lt;/h4&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div class="bg-white p-4 rounded border-l-2 border-blue-300"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;p class="text-gray-700"&gt;${prescription.usage}&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/div&gt;</p>
<p class="p2"><span class="Apple-converted-space">                                </span></p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div class="mt-4 p-4 bg-yellow-50 rounded-lg border border-yellow-200"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;h5 class="font-semibold text-yellow-800 mb-2"&gt;⚠️ 注意事項：&lt;/h5&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;ul class="text-sm text-yellow-700 space-y-1"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>&lt;li&gt;• 請在中醫師指導下使用&lt;/li&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>&lt;li&gt;• 孕婦、哺乳期婦女慎用&lt;/li&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>&lt;li&gt;• 如有不適請立即停藥就醫&lt;/li&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>&lt;li&gt;• 服藥期間忌食生冷、辛辣食物&lt;/li&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>${personalInfo.allergyHistory ? `&lt;li&gt;• &lt;strong&gt;過敏提醒：&lt;/strong&gt;患者有過敏史，請特別注意&lt;/li&gt;` : ''}</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>${personalInfo.currentMedication ? `&lt;li&gt;• &lt;strong&gt;用藥提醒：&lt;/strong&gt;患者目前有服用其他藥物，請注意藥物交互作用&lt;/li&gt;` : ''}</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;/ul&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>`;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function generateAcupuncture(symptoms, personalInfo = {}) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const acupuncturePoints = {</p>
<p class="p1"><span class="Apple-converted-space">                </span>'頭痛': {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>mainPoints: ['百會', '太陽', '風池', '合谷'],</p>
<p class="p1"><span class="Apple-converted-space">                    </span>auxiliaryPoints: ['印堂', '頭維', '率谷'],</p>
<p class="p1"><span class="Apple-converted-space">                    </span>method: '平補平瀉法，留針30分鐘'</p>
<p class="p1"><span class="Apple-converted-space">                </span>},</p>
<p class="p1"><span class="Apple-converted-space">                </span>'失眠': {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>mainPoints: ['神門', '三陰交', '百會', '安眠'],</p>
<p class="p1"><span class="Apple-converted-space">                    </span>auxiliaryPoints: ['心俞', '腎俞', '太溪'],</p>
<p class="p1"><span class="Apple-converted-space">                    </span>method: '補法為主，留針30-40分鐘'</p>
<p class="p1"><span class="Apple-converted-space">                </span>},</p>
<p class="p1"><span class="Apple-converted-space">                </span>'消化不良': {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>mainPoints: ['中脘', '足三里', '天樞', '脾俞'],</p>
<p class="p1"><span class="Apple-converted-space">                    </span>auxiliaryPoints: ['胃俞', '太白', '公孫'],</p>
<p class="p1"><span class="Apple-converted-space">                    </span>method: '平補平瀉法，留針25-30分鐘'</p>
<p class="p1"><span class="Apple-converted-space">                </span>},</p>
<p class="p1"><span class="Apple-converted-space">                </span>'疲勞': {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>mainPoints: ['氣海', '關元', '足三里', '百會'],</p>
<p class="p1"><span class="Apple-converted-space">                    </span>auxiliaryPoints: ['脾俞', '腎俞', '太溪'],</p>
<p class="p1"><span class="Apple-converted-space">                    </span>method: '補法，可配合艾灸，留針30分鐘'</p>
<p class="p1"><span class="Apple-converted-space">                </span>},</p>
<p class="p1"><span class="Apple-converted-space">                </span>'咳嗽': {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>mainPoints: ['肺俞', '列缺', '太淵', '定喘'],</p>
<p class="p1"><span class="Apple-converted-space">                    </span>auxiliaryPoints: ['風門', '大椎', '膻中'],</p>
<p class="p1"><span class="Apple-converted-space">                    </span>method: '瀉法為主，留針20-25分鐘'</p>
<p class="p1"><span class="Apple-converted-space">                </span>},</p>
<p class="p1"><span class="Apple-converted-space">                </span>'腰痛': {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>mainPoints: ['腎俞', '委中', '腰陽關', '阿是穴'],</p>
<p class="p1"><span class="Apple-converted-space">                    </span>auxiliaryPoints: ['太溪', '崑崙', '申脈'],</p>
<p class="p1"><span class="Apple-converted-space">                    </span>method: '補瀉兼施，留針30分鐘'</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>};</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>let acupoints = acupuncturePoints['疲勞']; // Default</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (symptoms.length &gt; 0 &amp;&amp; acupuncturePoints[symptoms[0]]) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>acupoints = acupuncturePoints[symptoms[0]];</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('acupunctureResult').innerHTML = `</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="space-y-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="bg-gradient-to-r from-purple-50 to-pink-50 p-6 rounded-lg border-l-4 border-purple-500"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;span class="text-2xl mr-3"&gt;🎯&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>針灸治療方案</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/h3&gt;</p>
<p class="p2"><span class="Apple-converted-space">                        </span></p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="grid md:grid-cols-2 gap-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;h4 class="font-semibold text-gray-700 mb-3 flex items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;span class="text-lg mr-2"&gt;📍&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>主要穴位：</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/h4&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div class="space-y-2"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>${acupoints.mainPoints.map(point =&gt;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                                        </span>`&lt;div class="bg-white p-3 rounded-lg border-l-3 border-purple-300 flex items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                            </span>&lt;span class="w-2 h-2 bg-purple-500 rounded-full mr-3"&gt;&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                            </span>&lt;span class="font-medium"&gt;${point}&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>&lt;/div&gt;`</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>).join('')}</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/div&gt;</p>
<p class="p2"><span class="Apple-converted-space">                                </span></p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;h4 class="font-semibold text-gray-700 mb-3 mt-6 flex items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;span class="text-lg mr-2"&gt;⭐&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>配穴：</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/h4&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div class="space-y-2"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>${acupoints.auxiliaryPoints.map(point =&gt;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                                        </span>`&lt;div class="bg-white p-3 rounded-lg border-l-3 border-pink-300 flex items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                            </span>&lt;span class="w-2 h-2 bg-pink-500 rounded-full mr-3"&gt;&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                            </span>&lt;span class="font-medium"&gt;${point}&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>&lt;/div&gt;`</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>).join('')}</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p2"><span class="Apple-converted-space">                            </span></p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;h4 class="font-semibold text-gray-700 mb-3 flex items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;span class="text-lg mr-2"&gt;⚡&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>針刺方法：</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/h4&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div class="bg-white p-4 rounded-lg border-l-3 border-blue-300"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;p class="text-gray-700"&gt;${acupoints.method}&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/div&gt;</p>
<p class="p2"><span class="Apple-converted-space">                                </span></p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div class="mt-6 space-y-4"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;div class="bg-blue-50 p-4 rounded-lg"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>&lt;h5 class="font-semibold text-blue-800 mb-2"&gt;📅 療程建議：&lt;/h5&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>&lt;p class="text-blue-700 text-sm"&gt;每週2-3次，10次為一療程&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;/div&gt;</p>
<p class="p2"><span class="Apple-converted-space">                                    </span></p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;div class="bg-orange-50 p-4 rounded-lg"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>&lt;h5 class="font-semibold text-orange-800 mb-2"&gt;⚠️ 注意事項：&lt;/h5&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>&lt;ul class="text-sm text-orange-700 space-y-1"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                            </span>&lt;li&gt;• 請由專業針灸師操作&lt;/li&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                            </span>&lt;li&gt;• 針具必須嚴格消毒&lt;/li&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                            </span>&lt;li&gt;• 孕婦特殊穴位需避免&lt;/li&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                            </span>&lt;li&gt;• 如有暈針現象立即處理&lt;/li&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                            </span>${personalInfo.gender === 'female' ? `&lt;li&gt;• &lt;strong&gt;女性患者：&lt;/strong&gt;請告知是否懷孕或月經期&lt;/li&gt;` : ''}</p>
<p class="p1"><span class="Apple-converted-space">                                            </span>${personalInfo.pastHistory ? `&lt;li&gt;• &lt;strong&gt;病史提醒：&lt;/strong&gt;患者有既往病史，請評估針灸適應症&lt;/li&gt;` : ''}</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>&lt;/ul&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>`;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Admin panel functions</p>
<p class="p1"><span class="Apple-converted-space">        </span>function updateAdminStats() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const today = new Date().toDateString();</p>
<p class="p1"><span class="Apple-converted-space">            </span>const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const totalPatients = patientDatabase.length;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const todayPatients = patientDatabase.filter(p =&gt; new Date(p.timestamp).toDateString() === today).length;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const weekPatients = patientDatabase.filter(p =&gt; new Date(p.timestamp) &gt;= weekAgo).length;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const pendingPatients = patientDatabase.filter(p =&gt; p.status === 'pending').length;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('totalPatients').textContent = totalPatients;</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('todayPatients').textContent = todayPatients;</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('weekPatients').textContent = weekPatients;</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('pendingPatients').textContent = pendingPatients;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function loadPatientData() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const tbody = document.getElementById('patientTableBody');</p>
<p class="p1"><span class="Apple-converted-space">            </span>tbody.innerHTML = '';</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>patientDatabase.sort((a, b) =&gt; new Date(b.timestamp) - new Date(a.timestamp)).forEach(patient =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const row = document.createElement('tr');</p>
<p class="p1"><span class="Apple-converted-space">                </span>row.className = 'hover:bg-gray-50';</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>const statusColors = {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>pending: 'bg-yellow-100 text-yellow-800',</p>
<p class="p1"><span class="Apple-converted-space">                    </span>completed: 'bg-green-100 text-green-800',</p>
<p class="p1"><span class="Apple-converted-space">                    </span>'follow-up': 'bg-blue-100 text-blue-800'</p>
<p class="p1"><span class="Apple-converted-space">                </span>};</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>const statusTexts = {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>pending: '待處理',</p>
<p class="p1"><span class="Apple-converted-space">                    </span>completed: '已完成',</p>
<p class="p1"><span class="Apple-converted-space">                    </span>'follow-up': '需追蹤'</p>
<p class="p1"><span class="Apple-converted-space">                </span>};</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>row.innerHTML = `</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;td class="px-6 py-4 whitespace-nowrap"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="flex items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div class="text-sm font-medium text-gray-900"&gt;${patient.name}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div class="text-sm text-gray-500"&gt;${patient.phone}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div class="text-sm text-gray-500"&gt;${patient.gender === 'male' ? '男性' : '女性'} • ${patient.age}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/td&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>${new Date(patient.timestamp).toLocaleString('zh-TW')}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/td&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>${patient.currentIllness ? patient.currentIllness.substring(0, 50) + '...' : '無特殊症狀'}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/td&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;td class="px-6 py-4 whitespace-nowrap"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColors[patient.status]}"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>${statusTexts[patient.status]}</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/td&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;td class="px-6 py-4 whitespace-nowrap text-sm font-medium"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;button onclick="viewPatientDetail(${patient.id})" class="text-indigo-600 hover:text-indigo-900 mr-3" ${!hasPermission('view_patients') ? 'disabled' : ''}&gt;查看&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;button onclick="editPatientStatus(${patient.id})" class="text-green-600 hover:text-green-900 mr-3" ${!hasPermission('edit_patients') ? 'disabled' : ''}&gt;編輯&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;button onclick="deletePatient(${patient.id})" class="text-red-600 hover:text-red-900" ${!hasPermission('delete_patients') ? 'disabled' : ''}&gt;刪除&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/td&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>`;</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>tbody.appendChild(row);</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function viewPatientDetail(patientId) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const patient = patientDatabase.find(p =&gt; p.id === patientId);</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!patient) return;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const detailContent = document.getElementById('patientDetailContent');</p>
<p class="p1"><span class="Apple-converted-space">            </span>detailContent.innerHTML = `</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="space-y-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="grid md:grid-cols-2 gap-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="bg-blue-50 p-4 rounded-lg"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;h4 class="font-semibold text-blue-800 mb-3"&gt;👤 基本資料&lt;/h4&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div class="space-y-2 text-sm"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div&gt;&lt;strong&gt;姓名：&lt;/strong&gt;${patient.name}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div&gt;&lt;strong&gt;性別：&lt;/strong&gt;${patient.gender === 'male' ? '男性' : '女性'}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div&gt;&lt;strong&gt;年齡：&lt;/strong&gt;${patient.age}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div&gt;&lt;strong&gt;電話：&lt;/strong&gt;${patient.phone}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div&gt;&lt;strong&gt;職業：&lt;/strong&gt;${patient.occupation || '未填寫'}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div&gt;&lt;strong&gt;診療時間：&lt;/strong&gt;${new Date(patient.timestamp).toLocaleString('zh-TW')}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p2"><span class="Apple-converted-space">                        </span></p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="bg-orange-50 p-4 rounded-lg"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;h4 class="font-semibold text-orange-800 mb-3"&gt;📋 病史資料&lt;/h4&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div class="space-y-2 text-sm"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div&gt;&lt;strong&gt;現病史：&lt;/strong&gt;${patient.currentIllness || '無'}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div&gt;&lt;strong&gt;既往史：&lt;/strong&gt;${patient.pastHistory || '無'}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div&gt;&lt;strong&gt;家族史：&lt;/strong&gt;${patient.familyHistory || '無'}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div&gt;&lt;strong&gt;過敏史：&lt;/strong&gt;${patient.allergyHistory || '無'}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div&gt;&lt;strong&gt;目前用藥：&lt;/strong&gt;${patient.currentMedication || '無'}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p2"><span class="Apple-converted-space">                    </span></p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="bg-green-50 p-4 rounded-lg"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;h4 class="font-semibold text-green-800 mb-3"&gt;🔍 問診結果&lt;/h4&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="text-sm"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div&gt;&lt;strong&gt;補充說明：&lt;/strong&gt;${patient.additionalSymptoms || '無'}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div class="mt-2"&gt;&lt;strong&gt;問診回答：&lt;/strong&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div class="ml-4 mt-1"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>${Object.keys(patient.answers || {}).length &gt; 0 ?<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                                    </span>`已回答 ${Object.keys(patient.answers).length} 個問題` :<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                                    </span>'未回答問題'</p>
<p class="p1"><span class="Apple-converted-space">                                </span>}</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p2"><span class="Apple-converted-space">                    </span></p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="flex gap-3"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;button onclick="editPatientStatus(${patient.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>編輯狀態</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;button onclick="exportSinglePatient(${patient.id})" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>匯出資料</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;button onclick="closePatientDetail()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>關閉</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>`;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('patientDetailModal').classList.remove('hidden');</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function closePatientDetail() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('patientDetailModal').classList.add('hidden');</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function editPatientStatus(patientId) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!hasPermission('edit_patients')) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>showNotification('您沒有權限執行此操作！', 'error');</p>
<p class="p1"><span class="Apple-converted-space">                </span>return;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const patient = patientDatabase.find(p =&gt; p.id === patientId);</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!patient) return;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const newStatus = prompt('請選擇新狀態：\n1. pending (待處理)\n2. completed (已完成)\n3. follow-up (需追蹤)', patient.status);</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (newStatus &amp;&amp; ['pending', 'completed', 'follow-up'].includes(newStatus)) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>patient.status = newStatus;</p>
<p class="p1"><span class="Apple-converted-space">                </span>localStorage.setItem('patientDatabase', JSON.stringify(patientDatabase));</p>
<p class="p1"><span class="Apple-converted-space">                </span>loadPatientData();</p>
<p class="p1"><span class="Apple-converted-space">                </span>updateAdminStats();</p>
<p class="p1"><span class="Apple-converted-space">                </span>showNotification('狀態已更新！', 'success');</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function deletePatient(patientId) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!hasPermission('delete_patients')) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>showNotification('您沒有權限執行此操作！', 'error');</p>
<p class="p1"><span class="Apple-converted-space">                </span>return;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (confirm('確定要刪除此病患資料嗎？此操作無法復原。')) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>patientDatabase = patientDatabase.filter(p =&gt; p.id !== patientId);</p>
<p class="p1"><span class="Apple-converted-space">                </span>localStorage.setItem('patientDatabase', JSON.stringify(patientDatabase));</p>
<p class="p1"><span class="Apple-converted-space">                </span>loadPatientData();</p>
<p class="p1"><span class="Apple-converted-space">                </span>updateAdminStats();</p>
<p class="p1"><span class="Apple-converted-space">                </span>showNotification('病患資料已刪除！', 'warning');</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function exportPatientData() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!hasPermission('export_data')) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>showNotification('您沒有權限執行此操作！', 'error');</p>
<p class="p1"><span class="Apple-converted-space">                </span>return;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const csvContent = generateCSV(patientDatabase);</p>
<p class="p1"><span class="Apple-converted-space">            </span>downloadCSV(csvContent, 'patient_data.csv');</p>
<p class="p1"><span class="Apple-converted-space">            </span>showNotification('資料匯出完成！', 'success');</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function searchPatients() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const searchTerm = document.getElementById('searchPatient').value.toLowerCase();</p>
<p class="p1"><span class="Apple-converted-space">            </span>const rows = document.querySelectorAll('#patientTableBody tr');</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>rows.forEach(row =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const text = row.textContent.toLowerCase();</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (text.includes(searchTerm)) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>row.style.display = '';</p>
<p class="p1"><span class="Apple-converted-space">                </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>row.style.display = 'none';</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function filterPatients() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const statusFilter = document.getElementById('filterStatus').value;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const dateFilter = document.getElementById('filterDate').value;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>let filteredData = [...patientDatabase];</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (statusFilter) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>filteredData = filteredData.filter(p =&gt; p.status === statusFilter);</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (dateFilter) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const now = new Date();</p>
<p class="p1"><span class="Apple-converted-space">                </span>let filterDate;</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>switch(dateFilter) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>case 'today':</p>
<p class="p1"><span class="Apple-converted-space">                        </span>filterDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());</p>
<p class="p1"><span class="Apple-converted-space">                        </span>filteredData = filteredData.filter(p =&gt; new Date(p.timestamp) &gt;= filterDate);</p>
<p class="p1"><span class="Apple-converted-space">                        </span>break;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>case 'week':</p>
<p class="p1"><span class="Apple-converted-space">                        </span>filterDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);</p>
<p class="p1"><span class="Apple-converted-space">                        </span>filteredData = filteredData.filter(p =&gt; new Date(p.timestamp) &gt;= filterDate);</p>
<p class="p1"><span class="Apple-converted-space">                        </span>break;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>case 'month':</p>
<p class="p1"><span class="Apple-converted-space">                        </span>filterDate = new Date(now.getFullYear(), now.getMonth(), 1);</p>
<p class="p1"><span class="Apple-converted-space">                        </span>filteredData = filteredData.filter(p =&gt; new Date(p.timestamp) &gt;= filterDate);</p>
<p class="p1"><span class="Apple-converted-space">                        </span>break;</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Temporarily replace database for display</p>
<p class="p1"><span class="Apple-converted-space">            </span>const originalData = [...patientDatabase];</p>
<p class="p1"><span class="Apple-converted-space">            </span>patientDatabase = filteredData;</p>
<p class="p1"><span class="Apple-converted-space">            </span>loadPatientData();</p>
<p class="p1"><span class="Apple-converted-space">            </span>patientDatabase = originalData;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function exportSinglePatient(patientId) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const patient = patientDatabase.find(p =&gt; p.id === patientId);</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (patient) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const csvContent = generateCSV([patient]);</p>
<p class="p1"><span class="Apple-converted-space">                </span>downloadCSV(csvContent, `patient_${patient.name}_${patient.id}.csv`);</p>
<p class="p1"><span class="Apple-converted-space">                </span>showNotification('病患資料匯出完成！', 'success');</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function generateCSV(data) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const headers = ['姓名', '性別', '年齡', '電話', '職業', '診療時間', '現病史', '既往史', '家族史', '過敏史', '目前用藥', '補充說明', '狀態'];</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const csvRows = [headers.join(',')];</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>data.forEach(patient =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const row = [</p>
<p class="p1"><span class="Apple-converted-space">                    </span>patient.name,</p>
<p class="p1"><span class="Apple-converted-space">                    </span>patient.gender === 'male' ? '男性' : '女性',</p>
<p class="p1"><span class="Apple-converted-space">                    </span>patient.age,</p>
<p class="p1"><span class="Apple-converted-space">                    </span>patient.phone,</p>
<p class="p1"><span class="Apple-converted-space">                    </span>patient.occupation || '',</p>
<p class="p1"><span class="Apple-converted-space">                    </span>new Date(patient.timestamp).toLocaleString('zh-TW'),</p>
<p class="p1"><span class="Apple-converted-space">                    </span>patient.currentIllness || '',</p>
<p class="p1"><span class="Apple-converted-space">                    </span>patient.pastHistory || '',</p>
<p class="p1"><span class="Apple-converted-space">                    </span>patient.familyHistory || '',</p>
<p class="p1"><span class="Apple-converted-space">                    </span>patient.allergyHistory || '',</p>
<p class="p1"><span class="Apple-converted-space">                    </span>patient.currentMedication || '',</p>
<p class="p1"><span class="Apple-converted-space">                    </span>patient.additionalSymptoms || '',</p>
<p class="p1"><span class="Apple-converted-space">                    </span>patient.status</p>
<p class="p1"><span class="Apple-converted-space">                </span>];</p>
<p class="p1"><span class="Apple-converted-space">                </span>csvRows.push(row.map(field =&gt; `"${field}"`).join(','));</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>return csvRows.join('\n');</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function downloadCSV(csvContent, filename) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });</p>
<p class="p1"><span class="Apple-converted-space">            </span>const link = document.createElement('a');</p>
<p class="p1"><span class="Apple-converted-space">            </span>const url = URL.createObjectURL(blob);</p>
<p class="p1"><span class="Apple-converted-space">            </span>link.setAttribute('href', url);</p>
<p class="p1"><span class="Apple-converted-space">            </span>link.setAttribute('download', filename);</p>
<p class="p1"><span class="Apple-converted-space">            </span>link.style.visibility = 'hidden';</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.body.appendChild(link);</p>
<p class="p1"><span class="Apple-converted-space">            </span>link.click();</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.body.removeChild(link);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/script&gt;</p>
<p class="p1">&lt;script&gt;(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96106450a10fcb25',t:'MTc1MjgyNTA2NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&amp;&amp;(document.onreadystatechange=e,c())}}}})();&lt;/script&gt;&lt;/body&gt;</p>
<p class="p1">&lt;/html&gt;</p>
</body>
</html>
