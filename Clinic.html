<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­é†«è¨ºæ‰€ç®¡ç†ç³»çµ± v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase v9 SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .sidebar-transition { transition: transform 0.3s ease-in-out; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card-hover { transition: all 0.2s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .glass-effect { backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.9); }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Firebase Configuration -->
    <script>
        // Firebase configuration - ä¿®å¾©ç‰ˆæœ¬
        const firebaseConfig = {
            apiKey: "AIzaSyBx6RQt7wA2DDnxkQiIfh8ubzpzKYfXWGg",
            authDomain: "clinic-bb064.firebaseapp.com",
            databaseURL: "https://clinic-bb064-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "clinic-bb064",
            storageBucket: "clinic-bb064.firebasestorage.app",
            messagingSenderId: "387800418575",
            appId: "1:387800418575:web:4dc6baafbedf640ac1567a",
            measurementId: "G-1KW4XQX10N"
        };
        
        // Initialize Firebase - æ··åˆæ•¸æ“šåº«æ¶æ§‹
        let database;        // Realtime Database (å³æ™‚åŠŸèƒ½)
        let firestore;       // Firestore (ä¸»è¦æ•¸æ“š) - asia-east2
        let auth;           // Authentication
        let isFirebaseConnected = false;
        let isFirestoreConnected = false;
        
        const CLINIC_ID = 'main-clinic'; // è¨ºæ‰€ID
        const VERSION = '2.0'; // ç³»çµ±ç‰ˆæœ¬
        
        // Initialize Firebase with hybrid setup
        function initializeFirebase() {
            console.log('ğŸš€ åˆå§‹åŒ–ä¸­é†«è¨ºæ‰€ç®¡ç†ç³»çµ± v' + VERSION);
            console.log('ğŸ“Š Firestore: ç—…äººè³‡æ–™ã€é ç´„ã€è™•æ–¹ã€è¨ºç™‚è¨˜éŒ„');
            console.log('âš¡ Realtime DB: æ’è™Ÿç³»çµ±ã€å³æ™‚é€šçŸ¥ã€åœ¨ç·šç‹€æ…‹');
            console.log('ğŸ”§ é…ç½®æª¢æŸ¥:', firebaseConfig);
            
            try {
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDKæœªè¼‰å…¥');
                }
                
                // Initialize Firebase app
                const app = firebase.initializeApp(firebaseConfig);
                console.log('âœ… Firebase App åˆå§‹åŒ–æˆåŠŸ');
                
                // Initialize services with error handling
                try {
                    database = firebase.database();
                    console.log('âœ… Realtime Database æœå‹™åˆå§‹åŒ–');
                } catch (dbError) {
                    console.error('âŒ Realtime Database åˆå§‹åŒ–å¤±æ•—:', dbError);
                }
                
                try {
                    firestore = firebase.firestore();
                    console.log('âœ… Firestore æœå‹™åˆå§‹åŒ–');
                    
                    // Configure Firestore
                    firestore.settings({
                        ignoreUndefinedProperties: true,
                        cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED
                    });
                    console.log('âœ… Firestore è¨­å®šå®Œæˆ');
                } catch (fsError) {
                    console.error('âŒ Firestore åˆå§‹åŒ–å¤±æ•—:', fsError);
                }
                
                try {
                    auth = firebase.auth();
                    console.log('âœ… Authentication æœå‹™åˆå§‹åŒ–');
                } catch (authError) {
                    console.error('âŒ Authentication åˆå§‹åŒ–å¤±æ•—:', authError);
                }
                
                // Test connections with detailed logging
                testConnections();
                
            } catch (error) {
                console.error('âŒ Firebaseåˆå§‹åŒ–å¤±æ•—:', error);
                console.error('éŒ¯èª¤è©³æƒ…:', error.message);
                console.error('éŒ¯èª¤å †ç–Š:', error.stack);
                updateConnectionStatus(false, false);
                
                // Show error to user
                setTimeout(() => {
                    alert('Firebaseåˆå§‹åŒ–å¤±æ•—ï¼š' + error.message + '\n\nè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥æˆ–é‡æ–°è¼‰å…¥é é¢');
                }, 1000);
            }
        }
        
        // Test both database connections
        function testConnections() {
            let realtimeConnected = false;
            let firestoreConnected = false;
            
            console.log('ğŸ” é–‹å§‹æ¸¬è©¦æ•¸æ“šåº«é€£æ¥...');
            
            // Test Realtime Database
            if (database) {
                console.log('âš¡ æ¸¬è©¦ Realtime Database é€£æ¥...');
                
                database.ref('.info/connected').on('value', (snapshot) => {
                    realtimeConnected = snapshot.val() === true;
                    console.log('âš¡ Realtime Database ç‹€æ…‹:', realtimeConnected ? 'âœ… å·²é€£æ¥' : 'âŒ æœªé€£æ¥');
                    updateConnectionStatus(realtimeConnected, firestoreConnected);
                    
                    if (realtimeConnected) {
                        console.log('âš¡ åˆå§‹åŒ– Realtime Database æ•¸æ“š...');
                        initializeRealtimeData();
                    }
                }, (error) => {
                    console.error('âš¡ Realtime Database é€£æ¥éŒ¯èª¤:', error);
                    updateConnectionStatus(false, firestoreConnected);
                });
                
                // Additional test - try to write a test value
                database.ref('connection_test').set({
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    status: 'testing'
                }).then(() => {
                    console.log('âš¡ Realtime Database å¯«å…¥æ¸¬è©¦æˆåŠŸ');
                }).catch((error) => {
                    console.error('âš¡ Realtime Database å¯«å…¥æ¸¬è©¦å¤±æ•—:', error);
                });
            } else {
                console.error('âš¡ Realtime Database æœå‹™æœªåˆå§‹åŒ–');
                updateConnectionStatus(false, firestoreConnected);
            }
            
            // Test Firestore
            if (firestore) {
                console.log('ğŸ“Š æ¸¬è©¦ Firestore é€£æ¥...');
                
                // Enable network first
                firestore.enableNetwork().then(() => {
                    console.log('ğŸ“Š Firestore ç¶²è·¯å·²å•Ÿç”¨');
                    
                    // Try to read from a test collection
                    return firestore.collection('connection_test').limit(1).get();
                }).then((querySnapshot) => {
                    firestoreConnected = true;
                    console.log('ğŸ“Š Firestore ç‹€æ…‹: âœ… å·²é€£æ¥');
                    console.log('ğŸ“Š Firestore æŸ¥è©¢çµæœ:', querySnapshot.size, 'å€‹æ–‡æª”');
                    updateConnectionStatus(realtimeConnected, firestoreConnected);
                    
                    console.log('ğŸ“Š åˆå§‹åŒ– Firestore æ•¸æ“š...');
                    initializeFirestoreData();
                }).catch((error) => {
                    console.error('ğŸ“Š Firestore é€£æ¥å¤±æ•—:', error);
                    console.error('ğŸ“Š éŒ¯èª¤ä»£ç¢¼:', error.code);
                    console.error('ğŸ“Š éŒ¯èª¤è¨Šæ¯:', error.message);
                    
                    firestoreConnected = false;
                    updateConnectionStatus(realtimeConnected, firestoreConnected);
                    
                    // Try alternative connection test
                    console.log('ğŸ“Š å˜—è©¦æ›¿ä»£é€£æ¥æ¸¬è©¦...');
                    firestore.collection('connection_test').doc('test').set({
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        status: 'testing'
                    }).then(() => {
                        console.log('ğŸ“Š Firestore å¯«å…¥æ¸¬è©¦æˆåŠŸ');
                        firestoreConnected = true;
                        updateConnectionStatus(realtimeConnected, firestoreConnected);
                        initializeFirestoreData();
                    }).catch((writeError) => {
                        console.error('ğŸ“Š Firestore å¯«å…¥æ¸¬è©¦ä¹Ÿå¤±æ•—:', writeError);
                    });
                });
            } else {
                console.error('ğŸ“Š Firestore æœå‹™æœªåˆå§‹åŒ–');
                updateConnectionStatus(realtimeConnected, false);
            }
            
            // Set a timeout to show connection status after 10 seconds
            setTimeout(() => {
                console.log('ğŸ” é€£æ¥æ¸¬è©¦å®Œæˆ');
                console.log('âš¡ Realtime Database:', realtimeConnected ? 'âœ…' : 'âŒ');
                console.log('ğŸ“Š Firestore:', firestoreConnected ? 'âœ…' : 'âŒ');
                
                if (!realtimeConnected && !firestoreConnected) {
                    console.error('âŒ æ‰€æœ‰æ•¸æ“šåº«é€£æ¥å¤±æ•—');
                    alert('æ•¸æ“šåº«é€£æ¥å¤±æ•—\n\nå¯èƒ½åŸå› ï¼š\n1. ç¶²è·¯é€£æ¥å•é¡Œ\n2. Firebase é…ç½®éŒ¯èª¤\n3. é˜²ç«ç‰†é˜»æ“‹\n\nè«‹æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°ç²å–è©³ç´°éŒ¯èª¤ä¿¡æ¯');
                }
            }, 10000);
        }
        
        // Update connection status display
        function updateConnectionStatus(realtime, firestore) {
            const indicator = document.getElementById('firebaseIndicator');
            const statusText = document.getElementById('firebaseStatusText');
            const versionText = document.getElementById('versionText');
            
            if (versionText) {
                versionText.textContent = `v${VERSION}`;
            }
            
            if (!indicator || !statusText) {
                console.log('ğŸ” ç‹€æ…‹é¡¯ç¤ºå…ƒç´ å°šæœªè¼‰å…¥');
                return;
            }
            
            if (realtime && firestore) {
                indicator.className = 'w-3 h-3 bg-green-500 rounded-full animate-pulse';
                statusText.textContent = 'æ··åˆDBå·²é€£æ¥';
                statusText.className = 'text-sm text-green-600 font-medium';
                isFirebaseConnected = true;
                isFirestoreConnected = true;
                console.log('âœ… ç‹€æ…‹æ›´æ–°: æ‰€æœ‰æ•¸æ“šåº«å·²é€£æ¥');
            } else if (realtime || firestore) {
                indicator.className = 'w-3 h-3 bg-yellow-500 rounded-full animate-pulse';
                statusText.textContent = `${realtime ? 'Realtime' : 'Firestore'} å·²é€£æ¥`;
                statusText.className = 'text-sm text-yellow-600 font-medium';
                isFirebaseConnected = realtime;
                isFirestoreConnected = firestore;
                console.log('âš ï¸ ç‹€æ…‹æ›´æ–°: éƒ¨åˆ†æ•¸æ“šåº«å·²é€£æ¥');
            } else {
                indicator.className = 'w-3 h-3 bg-red-500 rounded-full animate-pulse';
                statusText.textContent = 'é€£æ¥å¤±æ•—';
                statusText.className = 'text-sm text-red-600 font-medium';
                isFirebaseConnected = false;
                isFirestoreConnected = false;
                console.log('âŒ ç‹€æ…‹æ›´æ–°: æ•¸æ“šåº«é€£æ¥å¤±æ•—');
            }
        }
        
        // Initialize Realtime Database data (å³æ™‚åŠŸèƒ½)
        function initializeRealtimeData() {
            console.log('âš¡ åˆå§‹åŒ–Realtime Databaseæ•¸æ“š...');
            
            const realtimeData = {
                queue: {
                    currentNumber: 1,
                    maxNumber: 1,
                    lastUpdated: firebase.database.ServerValue.TIMESTAMP,
                    status: 'active'
                },
                notifications: {
                    system: {
                        message: 'ç³»çµ±æ­£å¸¸é‹è¡Œ v' + VERSION,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        type: 'info'
                    }
                },
                realtime: {
                    activeUsers: 0,
                    lastActivity: firebase.database.ServerValue.TIMESTAMP,
                    systemStatus: 'online'
                },
                stats: {
                    todayPatients: 0,
                    todayAppointments: 0,
                    lastUpdated: firebase.database.ServerValue.TIMESTAMP
                }
            };
            
            // æª¢æŸ¥æ˜¯å¦å·²æœ‰æ•¸æ“š
            database.ref('queue').once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    return database.ref().update(realtimeData);
                }
            }).then(() => {
                console.log('âš¡ Realtime Databaseæ•¸æ“šåˆå§‹åŒ–å®Œæˆ');
                setupRealtimeListeners();
            }).catch((error) => {
                console.error('âš¡ Realtime Databaseåˆå§‹åŒ–å¤±æ•—:', error);
            });
        }
        
        // Initialize Firestore data (ä¸»è¦æ•¸æ“š - asia-east2)
        function initializeFirestoreData() {
            console.log('ğŸ“Š åˆå§‹åŒ–Firestoreæ•¸æ“š (asia-east2)...');
            
            const clinicRef = firestore.collection('clinics').doc(CLINIC_ID);
            
            // æª¢æŸ¥è¨ºæ‰€æ–‡æª”æ˜¯å¦å­˜åœ¨
            clinicRef.get().then((doc) => {
                if (!doc.exists) {
                    console.log('ğŸ“Š å‰µå»ºæ–°çš„è¨ºæ‰€æ•¸æ“šçµæ§‹ (asia-east2)...');
                    return createInitialFirestoreData();
                } else {
                    console.log('ğŸ“Š Firestoreæ•¸æ“šå·²å­˜åœ¨ (asia-east2)');
                }
            }).catch((error) => {
                console.error('ğŸ“Š Firestoreåˆå§‹åŒ–æª¢æŸ¥å¤±æ•—:', error);
            });
        }
        
        // Create initial Firestore data structure
        function createInitialFirestoreData() {
            const batch = firestore.batch();
            const clinicRef = firestore.collection('clinics').doc(CLINIC_ID);
            
            // è¨ºæ‰€åŸºæœ¬è³‡è¨Š
            batch.set(clinicRef, {
                name: 'ä»å¿ƒä¸­é†«è¨ºæ‰€',
                address: 'å°åŒ—å¸‚ä¿¡ç¾©å€ä¿¡ç¾©è·¯äº”æ®µ7è™Ÿ',
                phone: '02-2345-6789',
                version: VERSION,
                region: 'asia-east2',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // å‰µå»ºç”¨æˆ¶
            const users = [
                { 
                    id: 'admin', 
                    name: 'ç³»çµ±ç®¡ç†å“¡', 
                    role: 'admin', 
                    username: 'admin', 
                    email: 'admin@clinic.com',
                    permissions: ['all']
                },
                { 
                    id: 'doctor', 
                    name: 'ç‹é†«å¸«', 
                    role: 'doctor', 
                    username: 'doctor', 
                    email: 'doctor@clinic.com',
                    permissions: ['consultation', 'prescription', 'patient_view']
                },
                { 
                    id: 'assistant', 
                    name: 'æåŠ©ç†', 
                    role: 'assistant', 
                    username: 'assistant', 
                    email: 'assistant@clinic.com',
                    permissions: ['patient_register', 'appointment', 'queue']
                }
            ];
            
            users.forEach(user => {
                const userRef = clinicRef.collection('users').doc(user.id);
                batch.set(userRef, {
                    ...user,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: null,
                    isActive: true
                });
            });
            
            // å‰µå»ºç¤ºä¾‹ç—…äºº
            const patients = [
                { 
                    id: 'p001', 
                    name: 'é™³å°æ˜', 
                    phone: '0912345678', 
                    birthDate: '1980-05-15', 
                    address: 'å°åŒ—å¸‚ä¿¡ç¾©å€ä¿¡ç¾©è·¯100è™Ÿ',
                    gender: 'male',
                    idNumber: 'A123456789',
                    emergencyContact: 'é™³å¤ªå¤ª 0987654321'
                },
                { 
                    id: 'p002', 
                    name: 'æ—ç¾è¯', 
                    phone: '0923456789', 
                    birthDate: '1975-08-22', 
                    address: 'å°åŒ—å¸‚å¤§å®‰å€æ•¦åŒ–å—è·¯200è™Ÿ',
                    gender: 'female',
                    idNumber: 'B987654321',
                    emergencyContact: 'æ—å…ˆç”Ÿ 0976543210'
                },
                { 
                    id: 'p003', 
                    name: 'å¼µå¿—å¼·', 
                    phone: '0934567890', 
                    birthDate: '1990-12-10', 
                    address: 'å°åŒ—å¸‚ä¸­å±±å€ä¸­å±±åŒ—è·¯300è™Ÿ',
                    gender: 'male',
                    idNumber: 'C456789123',
                    emergencyContact: 'å¼µåª½åª½ 0965432109'
                }
            ];
            
            patients.forEach(patient => {
                const patientRef = clinicRef.collection('patients').doc(patient.id);
                batch.set(patientRef, {
                    ...patient,
                    registrationDate: firebase.firestore.FieldValue.serverTimestamp(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    visitCount: 0,
                    lastVisit: null
                });
            });
            
            // å‰µå»ºç¤ºä¾‹é ç´„
            const today = new Date().toISOString().split('T')[0];
            const appointments = [
                {
                    id: 'a001',
                    patientId: 'p001',
                    patientName: 'é™³å°æ˜',
                    doctorId: 'doctor',
                    doctorName: 'ç‹é†«å¸«',
                    date: today,
                    time: '09:00',
                    status: 'å·²é ç´„',
                    type: 'consultation',
                    queueNumber: '001',
                    symptoms: 'é ­ç—›ã€å¤±çœ ',
                    notes: 'åˆè¨º'
                },
                {
                    id: 'a002',
                    patientId: 'p002',
                    patientName: 'æ—ç¾è¯',
                    doctorId: 'doctor',
                    doctorName: 'ç‹é†«å¸«',
                    date: today,
                    time: '10:00',
                    status: 'å·²å®Œæˆ',
                    type: 'acupuncture',
                    queueNumber: '002',
                    symptoms: 'è…°ç—›',
                    notes: 'è¤‡è¨º'
                },
                {
                    id: 'a003',
                    patientId: 'p003',
                    patientName: 'å¼µå¿—å¼·',
                    doctorId: 'doctor',
                    doctorName: 'ç‹é†«å¸«',
                    date: today,
                    time: '11:00',
                    status: 'å·²é ç´„',
                    type: 'massage',
                    queueNumber: '003',
                    symptoms: 'è‚©é ¸åƒµç¡¬',
                    notes: 'æ¨æ‹¿æ²»ç™‚'
                }
            ];
            
            appointments.forEach(appointment => {
                const appointmentRef = clinicRef.collection('appointments').doc(appointment.id);
                batch.set(appointmentRef, {
                    ...appointment,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            });
            
            // å‰µå»ºç¤ºä¾‹è™•æ–¹
            const prescriptions = [
                {
                    id: 'pr001',
                    patientId: 'p001',
                    patientName: 'é™³å°æ˜',
                    doctorId: 'doctor',
                    doctorName: 'ç‹é†«å¸«',
                    date: today,
                    medicines: [
                        { name: 'ç”˜éº¥å¤§æ£—æ¹¯', dosage: 'ä¸€æ—¥ä¸‰æ¬¡ï¼Œé£¯å¾Œæœç”¨', days: 7 },
                        { name: 'å®‰ç¥å®šå¿—ä¸¸', dosage: 'ä¸€æ—¥å…©æ¬¡ï¼Œç¡å‰æœç”¨', days: 7 }
                    ],
                    instructions: 'é¿å…ç†¬å¤œï¼Œä¿æŒå¿ƒæƒ…æ„‰å¿«',
                    totalAmount: 850
                }
            ];
            
            prescriptions.forEach(prescription => {
                const prescriptionRef = clinicRef.collection('prescriptions').doc(prescription.id);
                batch.set(prescriptionRef, {
                    ...prescription,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            });
            
            // åŸ·è¡Œæ‰¹æ¬¡å¯«å…¥
            return batch.commit().then(() => {
                console.log('ğŸ“Š Firestoreåˆå§‹æ•¸æ“šå‰µå»ºå®Œæˆ (asia-east2)');
            });
        }
        
        // Setup real-time listeners
        function setupRealtimeListeners() {
            // ç›£è½æ’è™Ÿç³»çµ±è®ŠåŒ–
            database.ref('queue').on('value', (snapshot) => {
                const queueData = snapshot.val();
                if (queueData) {
                    updateQueueDisplay(queueData);
                }
            });
            
            // ç›£è½é€šçŸ¥
            database.ref('notifications').on('child_added', (snapshot) => {
                const notification = snapshot.val();
                if (notification && notification.timestamp > Date.now() - 5000) {
                    showNotification(notification);
                }
            });
            
            // ç›£è½ç³»çµ±ç‹€æ…‹
            database.ref('realtime/systemStatus').on('value', (snapshot) => {
                const status = snapshot.val();
                console.log('âš¡ ç³»çµ±ç‹€æ…‹:', status);
            });
        }
        
        // Update queue display
        function updateQueueDisplay(queueData) {
            const currentNumberEl = document.getElementById('currentNumber');
            const dashboardCurrentNumberEl = document.getElementById('dashboardCurrentNumber');
            
            if (currentNumberEl && queueData.currentNumber) {
                currentNumberEl.textContent = String(queueData.currentNumber).padStart(3, '0');
            }
            
            if (dashboardCurrentNumberEl && queueData.currentNumber) {
                dashboardCurrentNumberEl.textContent = String(queueData.currentNumber).padStart(3, '0');
            }
        }
        
        // Show notification
        function showNotification(notification) {
            console.log('ğŸ“¢ é€šçŸ¥:', notification.message);
            
            // å‰µå»ºé€šçŸ¥å…ƒç´ 
            const notificationEl = document.createElement('div');
            notificationEl.className = 'fixed top-20 right-4 z-50 bg-blue-600 text-white p-4 rounded-lg shadow-lg max-w-sm';
            notificationEl.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="fas fa-bell"></i>
                    <span class="text-sm">${notification.message}</span>
                </div>
            `;
            
            document.body.appendChild(notificationEl);
            
            // 3ç§’å¾Œè‡ªå‹•ç§»é™¤
            setTimeout(() => {
                if (notificationEl.parentNode) {
                    notificationEl.parentNode.removeChild(notificationEl);
                }
            }, 3000);
        }
        
        // Firestore æ•¸æ“šæ“ä½œå‡½æ•¸
        
        // ç²å–ç—…äººåˆ—è¡¨
        function getPatients(callback) {
            if (!isFirestoreConnected) {
                alert('Firestoreæœªé€£æ¥ï¼Œç„¡æ³•ç²å–ç—…äººè³‡æ–™');
                return;
            }
            
            firestore.collection('clinics').doc(CLINIC_ID).collection('patients')
                .orderBy('createdAt', 'desc')
                .get()
                .then((querySnapshot) => {
                    const patients = {};
                    querySnapshot.forEach((doc) => {
                        patients[doc.id] = { id: doc.id, ...doc.data() };
                    });
                    callback(patients);
                })
                .catch((error) => {
                    console.error('ç²å–ç—…äººè³‡æ–™å¤±æ•—:', error);
                    alert('ç²å–ç—…äººè³‡æ–™å¤±æ•—');
                });
        }
        
        // æ·»åŠ ç—…äºº
        function addPatient(patientData, callback) {
            if (!isFirestoreConnected) {
                alert('Firestoreæœªé€£æ¥ï¼Œç„¡æ³•æ·»åŠ ç—…äºº');
                return;
            }
            
            const patientRef = firestore.collection('clinics').doc(CLINIC_ID).collection('patients').doc();
            
            patientRef.set({
                ...patientData,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                registrationDate: firebase.firestore.FieldValue.serverTimestamp(),
                visitCount: 0,
                lastVisit: null
            }).then(() => {
                console.log('âœ… ç—…äººè³‡æ–™å·²æ·»åŠ åˆ°Firestore (asia-east2)');
                
                // æ›´æ–°å³æ™‚çµ±è¨ˆ
                if (isFirebaseConnected) {
                    database.ref('stats/todayPatients').transaction((current) => {
                        return (current || 0) + 1;
                    });
                }
                
                callback(true, patientRef.id);
            }).catch((error) => {
                console.error('âŒ æ·»åŠ ç—…äººå¤±æ•—:', error);
                callback(false);
            });
        }
        
        // ç²å–é ç´„åˆ—è¡¨
        function getAppointments(callback) {
            if (!isFirestoreConnected) {
                alert('Firestoreæœªé€£æ¥ï¼Œç„¡æ³•ç²å–é ç´„è³‡æ–™');
                return;
            }
            
            firestore.collection('clinics').doc(CLINIC_ID).collection('appointments')
                .orderBy('date', 'desc')
                .orderBy('time', 'asc')
                .get()
                .then((querySnapshot) => {
                    const appointments = {};
                    querySnapshot.forEach((doc) => {
                        appointments[doc.id] = { id: doc.id, ...doc.data() };
                    });
                    callback(appointments);
                })
                .catch((error) => {
                    console.error('ç²å–é ç´„è³‡æ–™å¤±æ•—:', error);
                    alert('ç²å–é ç´„è³‡æ–™å¤±æ•—');
                });
        }
        
        // ç²å–è™•æ–¹åˆ—è¡¨
        function getPrescriptions(callback) {
            if (!isFirestoreConnected) {
                alert('Firestoreæœªé€£æ¥ï¼Œç„¡æ³•ç²å–è™•æ–¹è³‡æ–™');
                return;
            }
            
            firestore.collection('clinics').doc(CLINIC_ID).collection('prescriptions')
                .orderBy('date', 'desc')
                .get()
                .then((querySnapshot) => {
                    const prescriptions = {};
                    querySnapshot.forEach((doc) => {
                        prescriptions[doc.id] = { id: doc.id, ...doc.data() };
                    });
                    callback(prescriptions);
                })
                .catch((error) => {
                    console.error('ç²å–è™•æ–¹è³‡æ–™å¤±æ•—:', error);
                    alert('ç²å–è™•æ–¹è³‡æ–™å¤±æ•—');
                });
        }
        
        // Realtime Database æ“ä½œå‡½æ•¸
        
        // æ›´æ–°æ’è™Ÿ
        function updateQueue(newCurrentNumber, callback) {
            if (!isFirebaseConnected) {
                alert('Realtime Databaseæœªé€£æ¥ï¼Œç„¡æ³•æ›´æ–°æ’è™Ÿ');
                return;
            }
            
            database.ref('queue').update({
                currentNumber: newCurrentNumber,
                lastUpdated: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                console.log('âš¡ æ’è™Ÿå·²æ›´æ–°');
                if (callback) callback(true);
            }).catch((error) => {
                console.error('âš¡ æ›´æ–°æ’è™Ÿå¤±æ•—:', error);
                if (callback) callback(false);
            });
        }
        
        // æ·»åŠ æ–°è™Ÿç¢¼
        function addToQueue(patientData, callback) {
            if (!isFirebaseConnected) {
                alert('Realtime Databaseæœªé€£æ¥ï¼Œç„¡æ³•å–è™Ÿ');
                return;
            }
            
            database.ref('queue').transaction((currentQueue) => {
                if (currentQueue) {
                    const newNumber = (currentQueue.maxNumber || 0) + 1;
                    return {
                        ...currentQueue,
                        maxNumber: newNumber,
                        lastUpdated: firebase.database.ServerValue.TIMESTAMP
                    };
                } else {
                    return {
                        currentNumber: 1,
                        maxNumber: 1,
                        lastUpdated: firebase.database.ServerValue.TIMESTAMP
                    };
                }
            }).then((result) => {
                if (result.committed) {
                    const newNumber = result.snapshot.val().maxNumber;
                    console.log('âš¡ æ–°è™Ÿç¢¼:', newNumber);
                    
                    // åŒæ™‚åœ¨Firestoreå‰µå»ºé ç´„è¨˜éŒ„
                    const appointmentData = {
                        ...patientData,
                        queueNumber: String(newNumber).padStart(3, '0'),
                        status: 'å·²é ç´„',
                        date: new Date().toISOString().split('T')[0],
                        time: new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' }),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    firestore.collection('clinics').doc(CLINIC_ID).collection('appointments').add(appointmentData)
                        .then(() => {
                            console.log('ğŸ“Š é ç´„è¨˜éŒ„å·²åŒæ­¥åˆ°Firestore (asia-east2)');
                            
                            // æ›´æ–°å³æ™‚çµ±è¨ˆ
                            database.ref('stats/todayAppointments').transaction((current) => {
                                return (current || 0) + 1;
                            });
                            
                            if (callback) callback(true, newNumber);
                        });
                } else {
                    if (callback) callback(false);
                }
            }).catch((error) => {
                console.error('âš¡ å–è™Ÿå¤±æ•—:', error);
                if (callback) callback(false);
            });
        }
        
        // ç”¨æˆ¶èªè­‰
        function authenticateUser(username, password, role) {
            const loginBtn = document.querySelector('button[type="submit"]');
            const originalText = loginBtn.innerHTML;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ç™»å…¥ä¸­...';
            loginBtn.disabled = true;
            
            if (!isFirestoreConnected) {
                loginBtn.innerHTML = originalText;
                loginBtn.disabled = false;
                alert('Firestoreæœªé€£æ¥ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥å¾Œé‡æ–°è¼‰å…¥é é¢');
                return;
            }
            
            // å¾Firestoreé©—è­‰ç”¨æˆ¶
            firestore.collection('clinics').doc(CLINIC_ID).collection('users')
                .where('username', '==', username)
                .where('role', '==', role)
                .get()
                .then((querySnapshot) => {
                    if (!querySnapshot.empty) {
                        const userDoc = querySnapshot.docs[0];
                        const userData = userDoc.data();
                        
                        // ç™»å…¥æˆåŠŸ
                        currentUser = { 
                            id: userDoc.id,
                            ...userData
                        };
                        userRole = role;
                        
                        // æ›´æ–°æœ€å¾Œç™»å…¥æ™‚é–“
                        userDoc.ref.update({
                            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // æ›´æ–°åœ¨ç·šç‹€æ…‹
                        if (isFirebaseConnected) {
                            database.ref('realtime/activeUsers').transaction((current) => {
                                return (current || 0) + 1;
                            });
                        }
                        
                        console.log('âœ… ç™»å…¥æˆåŠŸ:', currentUser);
                        showMainApp();
                    } else {
                        throw new Error(`æ‰¾ä¸åˆ°ç”¨æˆ¶åç‚º "${username}" ä¸”èº«ä»½ç‚º "${getRoleName(role)}" çš„ç”¨æˆ¶`);
                    }
                })
                .catch((error) => {
                    console.error('âŒ ç™»å…¥å¤±æ•—:', error);
                    loginBtn.innerHTML = originalText;
                    loginBtn.disabled = false;
                    alert(error.message || 'ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç”¨æˆ¶åå’Œèº«ä»½é¸æ“‡');
                });
        }
        
        // Helper function to get role display name
        function getRoleName(role) {
            const roleNames = {
                'admin': 'ç³»çµ±ç®¡ç†å“¡',
                'doctor': 'é†«å¸«',
                'assistant': 'è¨ºæ‰€åŠ©ç†'
            };
            return roleNames[role] || role;
        }
        
        // Demo data structure
        let currentUser = null;
        let userRole = 'admin';
        
        // Initialize Firebase when page loads
        initializeFirebase();
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“± ä¸­é†«è¨ºæ‰€ç®¡ç†ç³»çµ± v' + VERSION + ' è¼‰å…¥å®Œæˆ');
            
            // Start time updates
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // Initialize connection status display
            updateConnectionStatus(false, false);
            
            // Set up login form handler
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const username = document.getElementById('loginUsername').value.trim();
                    const password = document.getElementById('loginPassword').value.trim();
                    const role = document.getElementById('userRole').value;
                    
                    if (!username || !password || !role) {
                        alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');
                        return;
                    }
                    
                    authenticateUser(username, password, role);
                });
            }
            
            // Set up logout handler
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
            }
            
            // Set up sidebar toggle
            const sidebarToggle = document.getElementById('sidebarToggle');
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', toggleSidebar);
            }
        });
        
        function updateDateTime() {
            const now = new Date();
            const options = { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit', 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            };
            const dateTimeEl = document.getElementById('currentDateTime');
            if (dateTimeEl) {
                dateTimeEl.textContent = now.toLocaleDateString('zh-TW', options);
            }
        }
        
        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            const roleNames = {
                'admin': 'ç³»çµ±ç®¡ç†å“¡',
                'doctor': 'é†«å¸«',
                'assistant': 'è¨ºæ‰€åŠ©ç†'
            };
            
            document.getElementById('currentUserName').textContent = currentUser.name || roleNames[userRole];
            document.getElementById('currentUserRole').textContent = roleNames[userRole];
            
            setupNavigation();
            showDashboard();
        }
        
        function logout() {
            // æ›´æ–°åœ¨ç·šç‹€æ…‹
            if (isFirebaseConnected) {
                database.ref('realtime/activeUsers').transaction((current) => {
                    return Math.max(0, (current || 1) - 1);
                });
            }
            
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('loginForm').reset();
            currentUser = null;
        }
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('-translate-x-full');
        }
        
        function setupNavigation() {
            const navigationMenu = document.getElementById('navigationMenu');
            let menuItems = [];
            
            menuItems.push(
                { icon: 'fas fa-tachometer-alt', text: 'å„€è¡¨æ¿', action: 'showDashboard' }
            );
            
            if (userRole === 'admin') {
                menuItems.push(
                    { icon: 'fas fa-users-cog', text: 'ç”¨æˆ¶ç®¡ç†', action: 'showUserManagement' },
                    { icon: 'fas fa-cog', text: 'ç³»çµ±è¨­ç½®', action: 'showSystemSettings' },
                    { icon: 'fas fa-chart-bar', text: 'çµ±è¨ˆå ±è¡¨', action: 'showReports' }
                );
            }
            
            if (userRole === 'doctor' || userRole === 'admin') {
                menuItems.push(
                    { icon: 'fas fa-stethoscope', text: 'è¨ºç—‡ç®¡ç†', action: 'showConsultation' },
                    { icon: 'fas fa-prescription-bottle-alt', text: 'è™•æ–¹ç®¡ç†', action: 'showPrescriptions' }
                );
            }
            
            if (userRole === 'assistant' || userRole === 'admin') {
                menuItems.push(
                    { icon: 'fas fa-user-plus', text: 'ç—…äººç™»è¨˜', action: 'showPatientRegistration' },
                    { icon: 'fas fa-calendar-alt', text: 'é ç´„ç®¡ç†', action: 'showAppointments' },
                    { icon: 'fas fa-list-ol', text: 'æ’è™Ÿç³»çµ±', action: 'showQueueSystem' }
                );
            }
            
            menuItems.push(
                { icon: 'fas fa-users', text: 'ç—…äººè³‡æ–™', action: 'showPatients' }
            );
            
            navigationMenu.innerHTML = menuItems.map(item => `
                <li>
                    <button onclick="${item.action}()" class="w-full flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition duration-200">
                        <i class="${item.icon}"></i>
                        <span>${item.text}</span>
                    </button>
                </li>
            `).join('');
        }
        
        function showDashboard() {
            // ä½¿ç”¨æ··åˆæ•¸æ“šåº«ç²å–å„€è¡¨æ¿æ•¸æ“š
            Promise.all([
                new Promise(resolve => getPatients(resolve)),
                new Promise(resolve => getAppointments(resolve)),
                new Promise(resolve => {
                    if (isFirebaseConnected) {
                        database.ref('queue').once('value').then(snapshot => {
                            resolve(snapshot.val() || { currentNumber: 1, maxNumber: 1 });
                        });
                    } else {
                        resolve({ currentNumber: 1, maxNumber: 1 });
                    }
                }),
                new Promise(resolve => {
                    if (isFirebaseConnected) {
                        database.ref('stats').once('value').then(snapshot => {
                            resolve(snapshot.val() || { todayPatients: 0, todayAppointments: 0 });
                        });
                    } else {
                        resolve({ todayPatients: 0, todayAppointments: 0 });
                    }
                })
            ]).then(([patients, appointments, queueData, stats]) => {
                const patientCount = Object.keys(patients || {}).length;
                const appointmentCount = Object.keys(appointments || {}).length;
                const waitingCount = Math.max(0, queueData.maxNumber - queueData.currentNumber + 1);
                
                // éæ¿¾ä»Šæ—¥é ç´„
                const today = new Date().toISOString().split('T')[0];
                const todayAppointments = Object.entries(appointments || {}).filter(([id, apt]) => apt.date === today);
                
                document.getElementById('contentArea').innerHTML = `
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">å„€è¡¨æ¿</h2>
                        <div class="text-sm text-gray-500">
                            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">v${VERSION}</span>
                            <span class="ml-2">us-central1 + é è¨­å€åŸŸ</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-xl shadow-lg card-hover">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-blue-100">ç¸½ç—…äººæ•¸</p>
                                    <p class="text-3xl font-bold">${patientCount}</p>
                                    <p class="text-xs text-blue-200">ğŸ“Š Firestore</p>
                                </div>
                                <div class="bg-white bg-opacity-20 p-3 rounded-full">
                                    <i class="fas fa-users text-2xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-6 rounded-xl shadow-lg card-hover">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-green-100">ä»Šæ—¥é ç´„</p>
                                    <p class="text-3xl font-bold">${todayAppointments.length}</p>
                                    <p class="text-xs text-green-200">ğŸ“Š Firestore</p>
                                </div>
                                <div class="bg-white bg-opacity-20 p-3 rounded-full">
                                    <i class="fas fa-calendar-check text-2xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6 rounded-xl shadow-lg card-hover">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-purple-100">ç•¶å‰è™Ÿç¢¼</p>
                                    <p class="text-3xl font-bold">${String(queueData.currentNumber).padStart(3, '0')}</p>
                                    <p class="text-xs text-purple-200">âš¡ Realtime</p>
                                </div>
                                <div class="bg-white bg-opacity-20 p-3 rounded-full">
                                    <i class="fas fa-list-ol text-2xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-6 rounded-xl shadow-lg card-hover">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-orange-100">ç­‰å€™äººæ•¸</p>
                                    <p class="text-3xl font-bold">${waitingCount}</p>
                                    <p class="text-xs text-orange-200">âš¡ Realtime</p>
                                </div>
                                <div class="bg-white bg-opacity-20 p-3 rounded-full">
                                    <i class="fas fa-clock text-2xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-calendar-alt mr-2 text-blue-600"></i>
                                ä»Šæ—¥é ç´„ 
                                <span class="text-sm text-gray-500 ml-2">(Firestore)</span>
                            </h3>
                            <div class="space-y-3 max-h-64 overflow-y-auto">
                                ${todayAppointments.slice(0, 8).map(([id, appointment]) => `
                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                                <i class="fas fa-user text-blue-600"></i>
                                            </div>
                                            <div>
                                                <p class="font-medium text-gray-800">${appointment.patientName || 'æœªçŸ¥ç—…äºº'}</p>
                                                <p class="text-sm text-gray-600">${appointment.time} | ${appointment.queueNumber || '-'}</p>
                                            </div>
                                        </div>
                                        <span class="px-3 py-1 text-xs rounded-full ${appointment.status === 'å·²å®Œæˆ' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">${appointment.status}</span>
                                    </div>
                                `).join('')}
                                ${todayAppointments.length === 0 ? '<p class="text-gray-500 text-center py-4">ä»Šæ—¥æš«ç„¡é ç´„</p>' : ''}
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-list-ol mr-2 text-purple-600"></i>
                                å³æ™‚æ’è™Ÿ 
                                <span class="text-sm text-gray-500 ml-2">(Realtime DB)</span>
                            </h3>
                            <div class="text-center py-8">
                                <div class="text-5xl font-bold text-purple-600 mb-4 pulse" id="dashboardCurrentNumber">${String(queueData.currentNumber).padStart(3, '0')}</div>
                                <p class="text-gray-600 mb-6">ç•¶å‰è™Ÿç¢¼</p>
                                <div class="grid grid-cols-2 gap-4 text-center">
                                    <div class="bg-green-50 p-4 rounded-lg">
                                        <p class="text-2xl font-bold text-green-600">${queueData.maxNumber}</p>
                                        <p class="text-sm text-gray-600">æœ€å¤§è™Ÿç¢¼</p>
                                    </div>
                                    <div class="bg-orange-50 p-4 rounded-lg">
                                        <p class="text-2xl font-bold text-orange-600">${waitingCount}</p>
                                        <p class="text-sm text-gray-600">ç­‰å€™äººæ•¸</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-chart-line mr-2 text-green-600"></i>
                            ç³»çµ±ç‹€æ…‹
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="text-center p-4 bg-blue-50 rounded-lg">
                                <div class="text-2xl font-bold text-blue-600">${isFirestoreConnected ? 'æ­£å¸¸' : 'ç•°å¸¸'}</div>
                                <p class="text-sm text-gray-600">Firestore (é è¨­å€åŸŸ)</p>
                            </div>
                            <div class="text-center p-4 bg-green-50 rounded-lg">
                                <div class="text-2xl font-bold text-green-600">${isFirebaseConnected ? 'æ­£å¸¸' : 'ç•°å¸¸'}</div>
                                <p class="text-sm text-gray-600">Realtime Database</p>
                            </div>
                            <div class="text-center p-4 bg-purple-50 rounded-lg">
                                <div class="text-2xl font-bold text-purple-600">v${VERSION}</div>
                                <p class="text-sm text-gray-600">ç³»çµ±ç‰ˆæœ¬</p>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).catch(error => {
                console.error('è¼‰å…¥å„€è¡¨æ¿æ•¸æ“šå¤±æ•—:', error);
                document.getElementById('contentArea').innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-exclamation-triangle text-yellow-500 text-4xl mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">è¼‰å…¥æ•¸æ“šå¤±æ•—</h3>
                        <p class="text-gray-600">è«‹æª¢æŸ¥ç¶²è·¯é€£æ¥æˆ–é‡æ–°è¼‰å…¥é é¢</p>
                        <button onclick="showDashboard()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                            é‡æ–°è¼‰å…¥
                        </button>
                    </div>
                `;
            });
        }
        
        function showPatientRegistration() {
            document.getElementById('contentArea').innerHTML = `
                <div class="fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-user-plus mr-3 text-blue-600"></i>
                        ç—…äººç™»è¨˜ 
                        <span class="text-sm text-gray-500 ml-2">(å­˜å„²è‡³ Firestore é è¨­å€åŸŸ)</span>
                    </h2>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <form id="patientForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-user mr-1"></i>å§“å *
                                </label>
                                <input type="text" id="patientName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-phone mr-1"></i>é›»è©± *
                                </label>
                                <input type="tel" id="patientPhone" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-id-card mr-1"></i>èº«ä»½è­‰è™Ÿ
                                </label>
                                <input type="text" id="patientIdNumber" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="A123456789">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-calendar mr-1"></i>å‡ºç”Ÿæ—¥æœŸ
                                </label>
                                <input type="date" id="patientBirthDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-venus-mars mr-1"></i>æ€§åˆ¥
                                </label>
                                <select id="patientGender" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">è«‹é¸æ“‡</option>
                                    <option value="male">ç”·</option>
                                    <option value="female">å¥³</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-phone-alt mr-1"></i>ç·Šæ€¥è¯çµ¡äºº
                                </label>
                                <input type="text" id="patientEmergencyContact" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="å§“å é›»è©±">
                            </div>
                            
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-map-marker-alt mr-1"></i>åœ°å€
                                </label>
                                <input type="text" id="patientAddress" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-notes-medical mr-1"></i>ç—…å²
                                </label>
                                <textarea id="patientHistory" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="è«‹è¼¸å…¥ç›¸é—œç—…å²..."></textarea>
                            </div>
                            
                            <div class="md:col-span-2 flex space-x-4">
                                <button type="submit" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center">
                                    <i class="fas fa-save mr-2"></i>å„²å­˜ç—…äººè³‡æ–™
                                </button>
                                <button type="button" onclick="showPatients()" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition duration-200 flex items-center">
                                    <i class="fas fa-times mr-2"></i>å–æ¶ˆ
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.getElementById('patientForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const patientData = {
                    name: document.getElementById('patientName').value,
                    phone: document.getElementById('patientPhone').value,
                    idNumber: document.getElementById('patientIdNumber').value,
                    birthDate: document.getElementById('patientBirthDate').value,
                    gender: document.getElementById('patientGender').value,
                    emergencyContact: document.getElementById('patientEmergencyContact').value,
                    address: document.getElementById('patientAddress').value,
                    history: document.getElementById('patientHistory').value
                };
                
                addPatient(patientData, (success, patientId) => {
                    if (success) {
                        alert('ç—…äººè³‡æ–™å·²æˆåŠŸå„²å­˜åˆ° Firestore (asia-east2)ï¼');
                        showPatients();
                    } else {
                        alert('å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥');
                    }
                });
            });
        }
        
        function showPatients() {
            getPatients((patients) => {
                document.getElementById('contentArea').innerHTML = `
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                            <i class="fas fa-users mr-3 text-blue-600"></i>
                            ç—…äººè³‡æ–™ 
                            <span class="text-sm text-gray-500 ml-2">(ä¾†è‡ª Firestore é è¨­å€åŸŸ)</span>
                        </h2>
                        <button onclick="showPatientRegistration()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center">
                            <i class="fas fa-plus mr-2"></i>æ–°å¢ç—…äºº
                        </button>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-500">å§“å</th>
                                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-500">é›»è©±</th>
                                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-500">èº«ä»½è­‰è™Ÿ</th>
                                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-500">å‡ºç”Ÿæ—¥æœŸ</th>
                                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-500">æ€§åˆ¥</th>
                                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-500">å°±è¨ºæ¬¡æ•¸</th>
                                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-500">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${Object.entries(patients || {}).map(([id, patient]) => `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-6 py-4 text-sm font-medium text-gray-900">${patient.name}</td>
                                            <td class="px-6 py-4 text-sm text-gray-600">${patient.phone}</td>
                                            <td class="px-6 py-4 text-sm text-gray-600">${patient.idNumber || '-'}</td>
                                            <td class="px-6 py-4 text-sm text-gray-600">${patient.birthDate || '-'}</td>
                                            <td class="px-6 py-4 text-sm text-gray-600">${patient.gender === 'male' ? 'ç”·' : patient.gender === 'female' ? 'å¥³' : '-'}</td>
                                            <td class="px-6 py-4 text-sm text-gray-600">${patient.visitCount || 0}</td>
                                            <td class="px-6 py-4 text-sm">
                                                <button onclick="editPatient('${id}')" class="text-blue-600 hover:text-blue-800 mr-3" title="ç·¨è¼¯">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button onclick="viewPatientHistory('${id}')" class="text-green-600 hover:text-green-800" title="ç—…å²">
                                                    <i class="fas fa-history"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        ${Object.keys(patients || {}).length === 0 ? 
                            '<div class="text-center py-8 text-gray-500">æš«ç„¡ç—…äººè³‡æ–™</div>' : ''
                        }
                    </div>
                </div>
                `;
            });
        }
        
        function showQueueSystem() {
            if (userRole !== 'assistant' && userRole !== 'admin') {
                alert('æ‚¨æ²’æœ‰æ¬Šé™è¨ªå•æ­¤åŠŸèƒ½');
                return;
            }
            
            // ç²å–å³æ™‚æ’è™Ÿæ•¸æ“š
            if (isFirebaseConnected) {
                database.ref('queue').once('value').then((snapshot) => {
                    const queueData = snapshot.val() || { currentNumber: 1, maxNumber: 1 };
                    
                    document.getElementById('contentArea').innerHTML = `
                        <div class="fade-in">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                                <i class="fas fa-list-ol mr-3 text-purple-600"></i>
                                æ’è™Ÿç³»çµ± 
                                <span class="text-sm text-gray-500 ml-2">(Realtime Database + Firestore)</span>
                            </h2>
                            
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div class="bg-white rounded-xl shadow-lg p-6">
                                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                        <i class="fas fa-tv mr-2 text-purple-600"></i>
                                        ç•¶å‰è™Ÿç¢¼ 
                                        <span class="text-sm text-gray-500 ml-2">(âš¡ å³æ™‚æ›´æ–°)</span>
                                    </h3>
                                    <div class="text-center py-8">
                                        <div class="text-6xl font-bold text-purple-600 mb-4 pulse" id="currentNumber">${String(queueData.currentNumber).padStart(3, '0')}</div>
                                        <p class="text-gray-600 mb-6">è«‹ ${String(queueData.currentNumber).padStart(3, '0')} è™Ÿç—…äººåˆ°è¨ºé–“</p>
                                        <div class="space-x-4">
                                            <button onclick="nextNumber()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center mx-auto mb-2">
                                                <i class="fas fa-forward mr-2"></i>ä¸‹ä¸€è™Ÿ
                                            </button>
                                            <button onclick="callNumber()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition duration-200 flex items-center mx-auto">
                                                <i class="fas fa-volume-up mr-2"></i>å‘¼å«
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-white rounded-xl shadow-lg p-6">
                                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                        <i class="fas fa-ticket-alt mr-2 text-blue-600"></i>
                                        å–è™Ÿ 
                                        <span class="text-sm text-gray-500 ml-2">(åŒæ­¥è‡³å…©å€‹DB)</span>
                                    </h3>
                                    <form id="queueForm" class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                <i class="fas fa-user mr-1"></i>ç—…äººå§“å
                                            </label>
                                            <input type="text" id="queuePatientName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                <i class="fas fa-phone mr-1"></i>è¯çµ¡é›»è©±
                                            </label>
                                            <input type="tel" id="queuePatientPhone" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                <i class="fas fa-stethoscope mr-1"></i>è¨ºç™‚é¡å‹
                                            </label>
                                            <select id="queueType" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                                <option value="consultation">ä¸€èˆ¬è¨ºç—‡</option>
                                                <option value="acupuncture">é‡ç¸æ²»ç™‚</option>
                                                <option value="massage">æ¨æ‹¿æŒ‰æ‘©</option>
                                                <option value="followup">è¤‡è¨º</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                <i class="fas fa-notes-medical mr-1"></i>ç—‡ç‹€æè¿°
                                            </label>
                                            <textarea id="queueSymptoms" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="è«‹ç°¡è¿°ç—‡ç‹€..."></textarea>
                                        </div>
                                        
                                        <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center justify-center">
                                            <i class="fas fa-ticket-alt mr-2"></i>å–è™Ÿ
                                        </button>
                                    </form>
                                    
                                    <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                                        <h4 class="font-medium text-gray-800 mb-3 flex items-center">
                                            <i class="fas fa-chart-bar mr-2"></i>æ’è™Ÿç‹€æ…‹
                                        </h4>
                                        <div class="grid grid-cols-2 gap-4 text-center">
                                            <div class="bg-blue-100 p-3 rounded-lg">
                                                <p class="text-2xl font-bold text-blue-600">${queueData.currentNumber}</p>
                                                <p class="text-sm text-gray-600">ç•¶å‰è™Ÿç¢¼</p>
                                            </div>
                                            <div class="bg-green-100 p-3 rounded-lg">
                                                <p class="text-2xl font-bold text-green-600">${queueData.maxNumber}</p>
                                                <p class="text-sm text-gray-600">æœ€å¤§è™Ÿç¢¼</p>
                                            </div>
                                        </div>
                                        <div class="mt-4 text-center bg-orange-100 p-3 rounded-lg">
                                            <p class="text-2xl font-bold text-orange-600">${Math.max(0, queueData.maxNumber - queueData.currentNumber + 1)}</p>
                                            <p class="text-sm text-gray-600">ç­‰å€™äººæ•¸</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('queueForm').addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        const patientData = {
                            patientName: document.getElementById('queuePatientName').value,
                            patientPhone: document.getElementById('queuePatientPhone').value,
                            type: document.getElementById('queueType').value,
                            symptoms: document.getElementById('queueSymptoms').value,
                            doctorId: 'doctor',
                            doctorName: 'ç‹é†«å¸«'
                        };
                        
                        addToQueue(patientData, (success, newNumber) => {
                            if (success) {
                                alert(`å–è™ŸæˆåŠŸï¼æ‚¨çš„è™Ÿç¢¼æ˜¯ï¼š${String(newNumber).padStart(3, '0')}\n\næ•¸æ“šå·²åŒæ­¥è‡³ï¼š\nâš¡ Realtime Database (æ’è™Ÿ)\nğŸ“Š Firestore (é ç´„è¨˜éŒ„)`);
                                this.reset();
                                showQueueSystem(); // Refresh the view
                            } else {
                                alert('å–è™Ÿå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥');
                            }
                        });
                    });
                });
            } else {
                document.getElementById('contentArea').innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-exclamation-triangle text-yellow-500 text-4xl mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Realtime Database æœªé€£æ¥</h3>
                        <p class="text-gray-600">æ’è™Ÿç³»çµ±éœ€è¦å³æ™‚æ•¸æ“šåº«æ”¯æŒ</p>
                        <button onclick="location.reload()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                            é‡æ–°è¼‰å…¥é é¢
                        </button>
                    </div>
                `;
            }
        }
        
        // æ›´æ–°æ’è™Ÿå‡½æ•¸
        function nextNumber() {
            if (!isFirebaseConnected) {
                alert('Realtime Databaseæœªé€£æ¥ï¼Œç„¡æ³•æ›´æ–°æ’è™Ÿ');
                return;
            }
            
            database.ref('queue').transaction((currentQueue) => {
                if (currentQueue && currentQueue.currentNumber < currentQueue.maxNumber) {
                    return {
                        ...currentQueue,
                        currentNumber: currentQueue.currentNumber + 1,
                        lastUpdated: firebase.database.ServerValue.TIMESTAMP
                    };
                }
                return currentQueue;
            }).then((result) => {
                if (result.committed) {
                    const newNumber = result.snapshot.val().currentNumber;
                    console.log('âš¡ è™Ÿç¢¼å·²æ›´æ–°è‡³:', newNumber);
                    
                    // ç™¼é€é€šçŸ¥
                    database.ref('notifications').push({
                        message: `è«‹ ${String(newNumber).padStart(3, '0')} è™Ÿç—…äººåˆ°è¨ºé–“`,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        type: 'queue_update'
                    });
                } else {
                    alert('å·²ç¶“æ˜¯æœ€å¾Œä¸€è™Ÿäº†');
                }
            }).catch((error) => {
                console.error('âš¡ æ›´æ–°æ’è™Ÿå¤±æ•—:', error);
                alert('æ›´æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥');
            });
        }
        
        function callNumber() {
            if (isFirebaseConnected) {
                database.ref('queue/currentNumber').once('value').then((snapshot) => {
                    const currentNumber = snapshot.val();
                    
                    // ç™¼é€å‘¼å«é€šçŸ¥
                    database.ref('notifications').push({
                        message: `æ­£åœ¨å‘¼å« ${String(currentNumber).padStart(3, '0')} è™Ÿç—…äººåˆ°è¨ºé–“`,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        type: 'call_patient'
                    });
                    
                    alert(`æ­£åœ¨å‘¼å« ${String(currentNumber).padStart(3, '0')} è™Ÿç—…äººåˆ°è¨ºé–“`);
                });
            } else {
                alert('Realtime Databaseæœªé€£æ¥ï¼Œç„¡æ³•å‘¼å«');
            }
        }
        
        function showAppointments() { 
            getAppointments((appointments) => {
                document.getElementById('contentArea').innerHTML = `
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                            <i class="fas fa-calendar-alt mr-3 text-green-600"></i>
                            é ç´„ç®¡ç† 
                            <span class="text-sm text-gray-500 ml-2">(ä¾†è‡ª Firestore é è¨­å€åŸŸ)</span>
                        </h2>
                        <button onclick="showNewAppointment()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center">
                            <i class="fas fa-plus mr-2"></i>æ–°å¢é ç´„
                        </button>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-500">ç—…äººå§“å</th>
                                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-500">æ—¥æœŸæ™‚é–“</th>
                                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-500">é†«å¸«</th>
                                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-500">é¡å‹</th>
                                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-500">è™Ÿç¢¼</th>
                                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-500">ç—‡ç‹€</th>
                                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-500">ç‹€æ…‹</th>
                                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-500">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${Object.entries(appointments || {}).map(([id, appointment]) => `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-6 py-4 text-sm font-medium text-gray-900">${appointment.patientName || 'æœªçŸ¥ç—…äºº'}</td>
                                            <td class="px-6 py-4 text-sm text-gray-600">${appointment.date} ${appointment.time}</td>
                                            <td class="px-6 py-4 text-sm text-gray-600">${appointment.doctorName || 'ç‹é†«å¸«'}</td>
                                            <td class="px-6 py-4 text-sm text-gray-600">
                                                ${appointment.type === 'consultation' ? 'ä¸€èˆ¬è¨ºç—‡' : 
                                                  appointment.type === 'acupuncture' ? 'é‡ç¸æ²»ç™‚' : 
                                                  appointment.type === 'massage' ? 'æ¨æ‹¿æŒ‰æ‘©' : 
                                                  appointment.type === 'followup' ? 'è¤‡è¨º' : appointment.type}
                                            </td>
                                            <td class="px-6 py-4 text-sm text-gray-600 font-mono">${appointment.queueNumber || '-'}</td>
                                            <td class="px-6 py-4 text-sm text-gray-600">${appointment.symptoms || '-'}</td>
                                            <td class="px-6 py-4 text-sm">
                                                <span class="px-3 py-1 text-xs rounded-full ${
                                                    appointment.status === 'å·²å®Œæˆ' ? 'bg-green-100 text-green-800' : 
                                                    appointment.status === 'é€²è¡Œä¸­' ? 'bg-blue-100 text-blue-800' :
                                                    'bg-yellow-100 text-yellow-800'
                                                }">${appointment.status}</span>
                                            </td>
                                            <td class="px-6 py-4 text-sm">
                                                <button onclick="editAppointment('${id}')" class="text-blue-600 hover:text-blue-800 mr-2" title="ç·¨è¼¯">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button onclick="completeAppointment('${id}')" class="text-green-600 hover:text-green-800" title="å®Œæˆ">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        ${Object.keys(appointments || {}).length === 0 ? 
                            '<div class="text-center py-8 text-gray-500">æš«ç„¡é ç´„è¨˜éŒ„</div>' : ''
                        }
                    </div>
                </div>
                `;
            });
        }
        
        function showPrescriptions() {
            getPrescriptions((prescriptions) => {
                document.getElementById('contentArea').innerHTML = `
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                            <i class="fas fa-prescription-bottle-alt mr-3 text-green-600"></i>
                            è™•æ–¹ç®¡ç† 
                            <span class="text-sm text-gray-500 ml-2">(ä¾†è‡ª Firestore é è¨­å€åŸŸ)</span>
                        </h2>
                        <button onclick="showNewPrescription()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center">
                            <i class="fas fa-plus mr-2"></i>æ–°å¢è™•æ–¹
                        </button>
                    </div>
                    
                    <div class="grid gap-6">
                        ${Object.entries(prescriptions || {}).map(([id, prescription]) => `
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-800">${prescription.patientName}</h3>
                                        <p class="text-sm text-gray-600">é†«å¸«ï¼š${prescription.doctorName} | æ—¥æœŸï¼š${prescription.date}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-lg font-bold text-green-600">$${prescription.totalAmount}</p>
                                        <p class="text-sm text-gray-500">ç¸½é‡‘é¡</p>
                                    </div>
                                </div>
                                
                                <div class="mb-4">
                                    <h4 class="font-medium text-gray-800 mb-2">è™•æ–¹è—¥ç‰©ï¼š</h4>
                                    <div class="space-y-2">
                                        ${prescription.medicines.map(medicine => `
                                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                                <div>
                                                    <p class="font-medium text-gray-800">${medicine.name}</p>
                                                    <p class="text-sm text-gray-600">${medicine.dosage}</p>
                                                </div>
                                                <span class="text-sm text-gray-500">${medicine.days}å¤©</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                ${prescription.instructions ? `
                                    <div class="mb-4">
                                        <h4 class="font-medium text-gray-800 mb-2">ç”¨è—¥æŒ‡ç¤ºï¼š</h4>
                                        <p class="text-gray-600 bg-blue-50 p-3 rounded-lg">${prescription.instructions}</p>
                                    </div>
                                ` : ''}
                                
                                <div class="flex space-x-2">
                                    <button onclick="editPrescription('${id}')" class="text-blue-600 hover:text-blue-800 px-3 py-1 rounded border border-blue-200 hover:bg-blue-50">
                                        <i class="fas fa-edit mr-1"></i>ç·¨è¼¯
                                    </button>
                                    <button onclick="printPrescription('${id}')" class="text-green-600 hover:text-green-800 px-3 py-1 rounded border border-green-200 hover:bg-green-50">
                                        <i class="fas fa-print mr-1"></i>åˆ—å°
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                        
                        ${Object.keys(prescriptions || {}).length === 0 ? 
                            '<div class="text-center py-12 text-gray-500">æš«ç„¡è™•æ–¹è¨˜éŒ„</div>' : ''
                        }
                    </div>
                </div>
                `;
            });
        }
        
        // å…¶ä»–åŠŸèƒ½ä¿æŒä¸è®Š...
        function showConsultation() { alert('è¨ºç—‡ç®¡ç†åŠŸèƒ½é–‹ç™¼ä¸­...'); }
        function showUserManagement() { alert('ç”¨æˆ¶ç®¡ç†åŠŸèƒ½é–‹ç™¼ä¸­...'); }
        function showSystemSettings() { alert('ç³»çµ±è¨­ç½®åŠŸèƒ½é–‹ç™¼ä¸­...'); }
        function showReports() { alert('çµ±è¨ˆå ±è¡¨åŠŸèƒ½é–‹ç™¼ä¸­...'); }
        function showNewAppointment() { alert('æ–°å¢é ç´„åŠŸèƒ½é–‹ç™¼ä¸­...'); }
        function showNewPrescription() { alert('æ–°å¢è™•æ–¹åŠŸèƒ½é–‹ç™¼ä¸­...'); }
        function editPatient(id) { alert(`ç·¨è¼¯ç—…äºº ${id} åŠŸèƒ½é–‹ç™¼ä¸­...`); }
        function viewPatientHistory(id) { alert(`æŸ¥çœ‹ç—…äºº ${id} ç—…å²åŠŸèƒ½é–‹ç™¼ä¸­...`); }
        function editAppointment(id) { alert(`ç·¨è¼¯é ç´„ ${id} åŠŸèƒ½é–‹ç™¼ä¸­...`); }
        function completeAppointment(id) { alert(`å®Œæˆé ç´„ ${id} åŠŸèƒ½é–‹ç™¼ä¸­...`); }
        function editPrescription(id) { alert(`ç·¨è¼¯è™•æ–¹ ${id} åŠŸèƒ½é–‹ç™¼ä¸­...`); }
        function printPrescription(id) { alert(`åˆ—å°è™•æ–¹ ${id} åŠŸèƒ½é–‹ç™¼ä¸­...`); }
    </script>

    <!-- Connection Status -->
    <div id="firebaseStatus" class="fixed top-4 right-4 z-50 glass-effect rounded-lg shadow-lg p-3 border">
        <div class="flex items-center space-x-2">
            <div id="firebaseIndicator" class="w-3 h-3 bg-gray-400 rounded-full"></div>
            <div>
                <span id="firebaseStatusText" class="text-sm text-gray-600">é€£æ¥ä¸­...</span>
                <div class="text-xs text-gray-500">
                    <span id="versionText">v2.0</span> | é è¨­å€åŸŸ
                </div>
            </div>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-600 via-purple-600 to-blue-800">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <div class="bg-blue-600 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-clinic-medical text-white text-3xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">ä¸­é†«è¨ºæ‰€ç®¡ç†ç³»çµ±</h1>
                <p class="text-gray-600">æ··åˆæ•¸æ“šåº«æ¶æ§‹ v2.0</p>
                <div class="mt-3 text-sm text-gray-500 bg-gray-50 p-3 rounded-lg">
                    <p>ğŸ“Š Firestore (é è¨­å€åŸŸ): ç—…äººã€é ç´„ã€è™•æ–¹</p>
                    <p>âš¡ Realtime DB: æ’è™Ÿã€é€šçŸ¥ã€çµ±è¨ˆ</p>
                </div>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ç”¨æˆ¶å</label>
                    <input type="text" id="loginUsername" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="è«‹è¼¸å…¥ç”¨æˆ¶å">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">å¯†ç¢¼</label>
                    <input type="password" id="loginPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">èº«ä»½</label>
                    <select id="userRole" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="admin">ç³»çµ±ç®¡ç†å“¡</option>
                        <option value="doctor">é†«å¸«</option>
                        <option value="assistant">è¨ºæ‰€åŠ©ç†</option>
                    </select>
                </div>
                
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
                    ç™»å…¥ç³»çµ±
                </button>
            </form>
            
            <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                <p class="text-sm text-gray-700 mb-2 font-medium">æ¸¬è©¦å¸³è™Ÿï¼š</p>
                <div class="text-xs text-gray-600 space-y-1">
                    <p><strong>ç®¡ç†å“¡:</strong> admin (å®Œæ•´æ¬Šé™)</p>
                    <p><strong>é†«å¸«:</strong> doctor (è¨ºç—‡ã€è™•æ–¹)</p>
                    <p><strong>åŠ©ç†:</strong> assistant (ç™»è¨˜ã€é ç´„ã€æ’è™Ÿ)</p>
                    <p class="mt-2 text-orange-600 font-medium">å¯†ç¢¼: ä»»æ„è¼¸å…¥</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200">
            <div class="flex items-center justify-between px-6 py-4">
                <div class="flex items-center space-x-4">
                    <button id="sidebarToggle" class="lg:hidden text-gray-600 hover:text-gray-800">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <div class="flex items-center space-x-3">
                        <div class="bg-gradient-to-r from-blue-500 to-purple-600 w-12 h-12 rounded-full flex items-center justify-center">
                            <i class="fas fa-clinic-medical text-white text-lg"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-800">ä¸­é†«è¨ºæ‰€ç®¡ç†ç³»çµ±</h1>
                            <p class="text-sm text-gray-600" id="currentDateTime"></p>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <p class="text-sm font-medium text-gray-800" id="currentUserName">ç³»çµ±ç®¡ç†å“¡</p>
                        <p class="text-xs text-gray-600" id="currentUserRole">ç®¡ç†å“¡</p>
                    </div>
                    <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-200 flex items-center">
                        <i class="fas fa-sign-out-alt mr-2"></i>ç™»å‡º
                    </button>
                </div>
            </div>
        </header>

        <div class="flex">
            <!-- Sidebar -->
            <aside id="sidebar" class="bg-white w-64 min-h-screen shadow-lg sidebar-transition">
                <nav class="p-4">
                    <ul class="space-y-2" id="navigationMenu">
                        <!-- Navigation items will be populated by JavaScript -->
                    </ul>
                </nav>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 p-6 bg-gray-50">
                <div id="contentArea" class="fade-in">
                    <!-- Content will be loaded here -->
                </div>
            </main>
        </div>
    </div>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'966bf7ac40f284cc',t:'MTc1Mzc4NTMwNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
