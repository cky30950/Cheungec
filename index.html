<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中醫診症輔助工具 - 雲端同步版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
        
        // Firebase 配置 (請替換為您的實際配置)
        const firebaseConfig = {
            apiKey: "demo-api-key",
            authDomain: "tcm-tool-demo.firebaseapp.com",
            projectId: "tcm-tool-demo",
            storageBucket: "tcm-tool-demo.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };
        
        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // 將 Firebase 實例掛載到 window 供其他腳本使用
        window.firebaseApp = app;
        window.firebaseDb = db;
        window.firebaseAuth = auth;
        window.firebaseModules = {
            doc, setDoc, getDoc, onSnapshot, serverTimestamp,
            signInAnonymously, onAuthStateChanged
        };
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .search-highlight {
            background: linear-gradient(120deg, #fbbf24 0%, #f59e0b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .sync-animation {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .pulse-dot {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .cloud-status {
            transition: all 0.3s ease;
        }
        .cloud-status.connected {
            color: #10b981;
        }
        .cloud-status.disconnected {
            color: #ef4444;
        }
        .cloud-status.syncing {
            color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="max-w-4xl mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <h1 class="text-xl font-bold text-gray-800">中藥資料庫</h1>
                    <div class="flex items-center space-x-2 text-sm">
                        <div id="cloudStatus" class="cloud-status disconnected flex items-center space-x-1">
                            <span id="cloudIcon">☁️</span>
                            <span id="cloudText">連接中...</span>
                        </div>
                        <div id="userInfo" class="text-xs text-gray-500 hidden">
                            設備ID: <span id="deviceId">-</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="syncBtn" class="px-3 py-1.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm flex items-center space-x-1">
                        <span id="syncIcon">🔄</span>
                        <span id="syncText">立即同步</span>
                    </button>
                    <button id="shareBtn" class="px-3 py-1.5 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors text-sm">
                        🔗 分享資料
                    </button>
                    <button id="backupBtn" class="px-3 py-1.5 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors text-sm">
                        💾 備份
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-4xl mx-auto px-4 py-6">
        <!-- Connection Status Banner -->
        <div id="connectionBanner" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 hidden">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div id="connectionIndicator" class="w-3 h-3 bg-blue-500 rounded-full pulse-dot"></div>
                    <div>
                        <div id="connectionMessage" class="text-sm font-medium text-blue-800">正在連接雲端服務...</div>
                        <div id="connectionDetails" class="text-xs text-blue-600">初始化 Firebase 連接</div>
                    </div>
                </div>
                <button id="dismissBanner" class="text-blue-400 hover:text-blue-600">×</button>
            </div>
        </div>

        <!-- Search Section -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="relative">
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="搜尋症狀或中藥..." 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                    autocomplete="off"
                >
                <button id="searchBtn" class="absolute right-2 top-2 px-4 py-1.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm">
                    搜尋
                </button>
                <div id="searchSuggestions" class="absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-lg shadow-lg mt-1 hidden z-10 max-h-64 overflow-y-auto"></div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="bg-white rounded-lg shadow-sm p-6 mb-6 hidden">
            <div id="searchResults" class="space-y-4"></div>
        </div>

        <!-- Data Management Section -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex flex-wrap gap-3 mb-4">
                <button id="fileImportBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm">
                    📁 導入檔案
                </button>
                <button id="textImportBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors text-sm">
                    ✏️ 手動輸入
                </button>

                <div class="ml-auto flex items-center space-x-4 text-sm text-gray-600">
                    <span>中藥: <span id="herbCount" class="font-medium">0</span></span>
                    <span>症狀: <span id="symptomCount" class="font-medium">0</span></span>
                    <span class="flex items-center">
                        <span id="dataStatusIndicator" class="w-2 h-2 bg-gray-500 rounded-full mr-1" title="資料狀態"></span>
                        <span id="syncStatusText" class="text-xs">本地</span>
                    </span>
                    <span class="text-xs text-gray-400">
                        最後同步: <span id="lastSyncTime">從未</span>
                    </span>
                </div>
            </div>
            
            <!-- Manual Input Section -->
            <div id="manualInputSection" class="hidden">
                <textarea 
                    id="importData" 
                    rows="6" 
                    placeholder="格式：中藥名：症狀1,症狀2,症狀3&#10;範例：當歸：血虛,月經不調,便秘"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:border-blue-500 focus:outline-none resize-none text-sm mb-3"
                ></textarea>
                <button id="processImport" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm">
                    導入資料
                </button>
            </div>
            
            <!-- File Import Status -->
            <div id="importStatus" class="hidden p-3 rounded-md">
                <div class="flex items-center space-x-2">
                    <span id="statusIcon">✅</span>
                    <span id="statusText" class="text-sm"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Data Modal -->
    <div id="shareModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    🔗 分享資料
                </h3>
                <button id="closeShareModal" class="text-gray-400 hover:text-gray-600 text-xl">×</button>
            </div>
            
            <!-- Share Options -->
            <div class="space-y-4">
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="text-sm font-medium text-gray-800 mb-2">您的分享代碼</div>
                    <div class="flex items-center space-x-2">
                        <input 
                            type="text" 
                            id="shareCode" 
                            readonly 
                            class="flex-1 px-3 py-2 bg-white border border-gray-300 rounded text-sm font-mono"
                            value="載入中..."
                        >
                        <button id="copyShareCode" class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                            複製
                        </button>
                    </div>
                    <div class="text-xs text-gray-500 mt-2">
                        其他設備可使用此代碼存取您的資料
                    </div>
                </div>
                
                <div class="border-t pt-4">
                    <div class="text-sm font-medium text-gray-800 mb-2">存取他人分享的資料</div>
                    <div class="flex items-center space-x-2">
                        <input 
                            type="text" 
                            id="accessCode" 
                            placeholder="輸入分享代碼"
                            class="flex-1 px-3 py-2 border border-gray-300 rounded text-sm"
                        >
                        <button id="accessSharedData" class="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm">
                            存取
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Status Message -->
            <div id="shareStatus" class="hidden mt-4 p-3 rounded-lg text-sm">
                <div class="flex items-center space-x-2">
                    <span id="shareStatusIcon">✅</span>
                    <span id="shareStatusText"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Backup Modal -->
    <div id="backupModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    💾 資料備份
                </h3>
                <button id="closeBackupModal" class="text-gray-400 hover:text-gray-600 text-xl">×</button>
            </div>
            
            <!-- Backup Info -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600" id="backupHerbCount">0</div>
                        <div class="text-gray-600">中藥</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600" id="backupSymptomCount">0</div>
                        <div class="text-gray-600">症狀</div>
                    </div>
                </div>
                <div class="text-center mt-3 text-xs text-gray-500">
                    雲端同步: <span id="cloudSyncStatus" class="font-medium">-</span>
                </div>
            </div>
            
            <!-- Backup Options -->
            <div class="space-y-3">
                <button id="downloadBackup" class="w-full px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center justify-center space-x-2">
                    <span>📥</span>
                    <span>下載備份檔案</span>
                </button>
                
                <button id="copyBackup" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center space-x-2">
                    <span>📋</span>
                    <span>複製到剪貼簿</span>
                </button>
                
                <div class="border-t pt-3">
                    <div class="text-sm text-gray-600 mb-2">或者恢復備份：</div>
                    <button id="restoreBackup" class="w-full px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors flex items-center justify-center space-x-2">
                        <span>📤</span>
                        <span>選擇備份檔案恢復</span>
                    </button>
                </div>
            </div>
            
            <!-- Status Message -->
            <div id="backupStatus" class="hidden mt-4 p-3 rounded-lg text-sm">
                <div class="flex items-center space-x-2">
                    <span id="backupStatusIcon">✅</span>
                    <span id="backupStatusText"></span>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".txt,.json" class="hidden">
    <input type="file" id="backupFileInput" accept=".json" class="hidden">

    <script>
        class CloudTCMTool {
            constructor() {
                this.storageKey = 'tcmData_v4';
                this.currentVersion = '4.0';
                
                // Firebase 相關
                this.isFirebaseReady = false;
                this.currentUser = null;
                this.deviceId = this.getOrCreateDeviceId();
                this.unsubscribeSnapshot = null;
                
                // 資料狀態
                this.data = {
                    herbs: {},
                    symptoms: {}
                };
                
                this.isOnline = navigator.onLine;
                this.lastSyncTime = null;
                this.syncInProgress = false;
                
                // 初始化
                this.initializeApp();
            }

            async initializeApp() {
                // 顯示連接橫幅
                this.showConnectionBanner('正在初始化雲端服務...', '連接 Firebase');
                
                // 載入本地資料
                this.loadLocalData();
                this.updateUI();
                
                // 初始化事件監聽器
                this.initializeEventListeners();
                
                // 等待 Firebase 初始化
                await this.waitForFirebase();
                
                // 初始化 Firebase 認證和資料庫
                await this.initializeFirebase();
                
                // 隱藏連接橫幅
                setTimeout(() => {
                    this.hideConnectionBanner();
                }, 2000);
            }

            async waitForFirebase() {
                return new Promise((resolve) => {
                    const checkFirebase = () => {
                        if (window.firebaseDb && window.firebaseAuth && window.firebaseModules) {
                            resolve();
                        } else {
                            setTimeout(checkFirebase, 100);
                        }
                    };
                    checkFirebase();
                });
            }

            async initializeFirebase() {
                try {
                    const { onAuthStateChanged, signInAnonymously } = window.firebaseModules;
                    
                    // 監聽認證狀態
                    onAuthStateChanged(window.firebaseAuth, async (user) => {
                        if (user) {
                            this.currentUser = user;
                            this.isFirebaseReady = true;
                            this.updateCloudStatus('connected', '雲端已連接');
                            
                            // 設置即時資料監聽
                            await this.setupRealtimeListener();
                            
                            // 執行初始同步
                            await this.performInitialSync();
                            
                        } else {
                            this.updateCloudStatus('disconnected', '未連接');
                        }
                    });
                    
                    // 匿名登入
                    await signInAnonymously(window.firebaseAuth);
                    
                } catch (error) {
                    console.error('Firebase 初始化失敗:', error);
                    this.updateCloudStatus('disconnected', '連接失敗');
                    this.showSystemNotification('❌', 'Firebase 連接失敗，使用離線模式', 'bg-red-100 text-red-800');
                }
            }

            async setupRealtimeListener() {
                if (!this.isFirebaseReady || this.unsubscribeSnapshot) return;
                
                try {
                    const { doc, onSnapshot } = window.firebaseModules;
                    const docRef = doc(window.firebaseDb, 'tcmData', this.deviceId);
                    
                    this.unsubscribeSnapshot = onSnapshot(docRef, (docSnapshot) => {
                        if (docSnapshot.exists() && !this.syncInProgress) {
                            const cloudData = docSnapshot.data();
                            if (cloudData && cloudData.data) {
                                const cloudChecksum = this.generateChecksum(cloudData.data);
                                const localChecksum = this.generateChecksum(this.data);
                                
                                if (cloudChecksum !== localChecksum) {
                                    this.handleCloudDataUpdate(cloudData);
                                }
                            }
                        }
                    }, (error) => {
                        console.error('即時監聽錯誤:', error);
                    });
                    
                } catch (error) {
                    console.error('設置即時監聽失敗:', error);
                }
            }

            handleCloudDataUpdate(cloudData) {
                if (confirm('檢測到雲端資料更新，是否同步到本地？')) {
                    this.data = cloudData.data;
                    this.saveLocalData();
                    this.updateUI();
                    this.lastSyncTime = new Date();
                    this.updateSyncStatus();
                    this.showSystemNotification('🔄', '已同步雲端資料更新', 'bg-blue-100 text-blue-800');
                }
            }

            async performInitialSync() {
                if (!this.isFirebaseReady) return;
                
                try {
                    const { doc, getDoc } = window.firebaseModules;
                    const docRef = doc(window.firebaseDb, 'tcmData', this.deviceId);
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        const cloudData = docSnap.data();
                        const cloudTimestamp = cloudData.lastModified?.toDate() || new Date(0);
                        const localTimestamp = new Date(localStorage.getItem('tcmLastModified') || 0);
                        
                        if (cloudTimestamp > localTimestamp) {
                            this.data = cloudData.data;
                            this.saveLocalData();
                            this.updateUI();
                            this.showSystemNotification('📥', '已載入雲端資料', 'bg-green-100 text-green-800');
                        } else if (localTimestamp > cloudTimestamp) {
                            await this.syncToCloud();
                        }
                    } else {
                        // 雲端沒有資料，上傳本地資料
                        if (Object.keys(this.data.herbs).length > 0) {
                            await this.syncToCloud();
                        }
                    }
                    
                    this.lastSyncTime = new Date();
                    this.updateSyncStatus();
                    
                } catch (error) {
                    console.error('初始同步失敗:', error);
                }
            }

            async syncToCloud() {
                if (!this.isFirebaseReady || this.syncInProgress) return;
                
                this.syncInProgress = true;
                this.updateCloudStatus('syncing', '同步中...');
                
                try {
                    const { doc, setDoc, serverTimestamp } = window.firebaseModules;
                    const docRef = doc(window.firebaseDb, 'tcmData', this.deviceId);
                    
                    const cloudData = {
                        data: this.data,
                        lastModified: serverTimestamp(),
                        version: this.currentVersion,
                        deviceId: this.deviceId,
                        checksum: this.generateChecksum(this.data)
                    };
                    
                    await setDoc(docRef, cloudData);
                    
                    this.lastSyncTime = new Date();
                    localStorage.setItem('tcmLastModified', this.lastSyncTime.toISOString());
                    
                    this.updateCloudStatus('connected', '雲端已連接');
                    this.updateSyncStatus();
                    
                    return true;
                } catch (error) {
                    console.error('同步到雲端失敗:', error);
                    this.updateCloudStatus('disconnected', '同步失敗');
                    throw error;
                } finally {
                    this.syncInProgress = false;
                }
            }

            async accessSharedData(shareCode) {
                if (!this.isFirebaseReady) {
                    throw new Error('雲端服務未就緒');
                }
                
                try {
                    const { doc, getDoc } = window.firebaseModules;
                    const docRef = doc(window.firebaseDb, 'tcmData', shareCode);
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        const sharedData = docSnap.data();
                        return sharedData.data;
                    } else {
                        throw new Error('分享代碼無效或資料不存在');
                    }
                } catch (error) {
                    console.error('存取分享資料失敗:', error);
                    throw error;
                }
            }

            getOrCreateDeviceId() {
                let deviceId = localStorage.getItem('tcmDeviceId');
                if (!deviceId) {
                    deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('tcmDeviceId', deviceId);
                }
                return deviceId;
            }

            loadLocalData() {
                try {
                    const stored = localStorage.getItem(this.storageKey);
                    if (stored) {
                        this.data = JSON.parse(stored);
                    }
                } catch (error) {
                    console.error('載入本地資料失敗:', error);
                }
            }

            saveLocalData() {
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(this.data));
                    localStorage.setItem('tcmLastModified', new Date().toISOString());
                } catch (error) {
                    console.error('保存本地資料失敗:', error);
                }
            }

            updateCloudStatus(status, message) {
                const cloudStatus = document.getElementById('cloudStatus');
                const cloudIcon = document.getElementById('cloudIcon');
                const cloudText = document.getElementById('cloudText');
                
                cloudStatus.className = `cloud-status ${status} flex items-center space-x-1`;
                
                switch (status) {
                    case 'connected':
                        cloudIcon.textContent = '☁️';
                        break;
                    case 'disconnected':
                        cloudIcon.textContent = '⚠️';
                        break;
                    case 'syncing':
                        cloudIcon.textContent = '🔄';
                        cloudIcon.classList.add('sync-animation');
                        break;
                }
                
                cloudText.textContent = message;
                
                if (status !== 'syncing') {
                    cloudIcon.classList.remove('sync-animation');
                }
                
                // 更新用戶信息
                document.getElementById('deviceId').textContent = this.deviceId.substring(0, 12) + '...';
                document.getElementById('userInfo').classList.remove('hidden');
            }

            updateSyncStatus() {
                const indicator = document.getElementById('dataStatusIndicator');
                const statusText = document.getElementById('syncStatusText');
                const lastSyncElement = document.getElementById('lastSyncTime');
                
                if (this.isFirebaseReady && this.lastSyncTime) {
                    const now = new Date();
                    const diffMinutes = Math.floor((now - this.lastSyncTime) / 60000);
                    
                    if (diffMinutes < 5) {
                        indicator.className = 'w-2 h-2 bg-green-500 rounded-full mr-1 pulse-dot';
                        statusText.textContent = '已同步';
                    } else if (diffMinutes < 60) {
                        indicator.className = 'w-2 h-2 bg-yellow-500 rounded-full mr-1';
                        statusText.textContent = '需同步';
                    } else {
                        indicator.className = 'w-2 h-2 bg-orange-500 rounded-full mr-1';
                        statusText.textContent = '過期';
                    }
                    
                    lastSyncElement.textContent = this.lastSyncTime.toLocaleTimeString('zh-TW');
                } else {
                    indicator.className = 'w-2 h-2 bg-gray-500 rounded-full mr-1';
                    statusText.textContent = '本地';
                    lastSyncElement.textContent = '從未';
                }
            }

            showConnectionBanner(message, details) {
                const banner = document.getElementById('connectionBanner');
                const messageElement = document.getElementById('connectionMessage');
                const detailsElement = document.getElementById('connectionDetails');
                
                messageElement.textContent = message;
                detailsElement.textContent = details;
                banner.classList.remove('hidden');
            }

            hideConnectionBanner() {
                document.getElementById('connectionBanner').classList.add('hidden');
            }

            generateChecksum(data) {
                const str = JSON.stringify(data);
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return hash.toString(16);
            }

            showSystemNotification(icon, message, className, duration = 3000) {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 ${className} p-4 rounded-lg shadow-lg z-50 max-w-sm`;
                notification.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <span class="text-xl">${icon}</span>
                        <div class="flex-1">
                            <div class="text-sm font-medium">${message}</div>
                            <div class="text-xs opacity-75 mt-1">${new Date().toLocaleTimeString('zh-TW')}</div>
                        </div>
                        <button class="text-lg opacity-50 hover:opacity-100" onclick="this.parentElement.parentElement.remove()">×</button>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, duration);
            }

            initializeEventListeners() {
                // 搜尋功能
                document.getElementById('searchBtn').addEventListener('click', () => this.search());
                document.getElementById('searchInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.search();
                });
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.showSearchSuggestions(e.target.value);
                });

                // 同步功能
                document.getElementById('syncBtn').addEventListener('click', () => this.handleSyncClick());

                // 分享功能
                document.getElementById('shareBtn').addEventListener('click', () => this.showShareModal());
                document.getElementById('closeShareModal').addEventListener('click', () => this.hideShareModal());
                document.getElementById('copyShareCode').addEventListener('click', () => this.copyShareCode());
                document.getElementById('accessSharedData').addEventListener('click', () => this.handleAccessSharedData());

                // 備份功能
                document.getElementById('backupBtn').addEventListener('click', () => this.showBackupModal());
                document.getElementById('closeBackupModal').addEventListener('click', () => this.hideBackupModal());
                document.getElementById('downloadBackup').addEventListener('click', () => this.downloadBackup());
                document.getElementById('copyBackup').addEventListener('click', () => this.copyBackupToClipboard());
                document.getElementById('restoreBackup').addEventListener('click', () => this.triggerBackupRestore());
                document.getElementById('backupFileInput').addEventListener('change', (e) => this.handleBackupRestore(e));

                // 資料管理
                document.getElementById('fileImportBtn').addEventListener('click', () => this.triggerFileImport());
                document.getElementById('textImportBtn').addEventListener('click', () => this.toggleManualInput());
                document.getElementById('processImport').addEventListener('click', () => this.processImportData());
                document.getElementById('fileInput').addEventListener('change', (e) => this.handleFileImport(e));

                // 連接橫幅
                document.getElementById('dismissBanner').addEventListener('click', () => this.hideConnectionBanner());

                // 點擊外部隱藏建議
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#searchInput') && !e.target.closest('#searchSuggestions')) {
                        this.hideSearchSuggestions();
                    }
                });
            }

            async handleSyncClick() {
                if (!this.isFirebaseReady) {
                    this.showSystemNotification('⚠️', '雲端服務未就緒', 'bg-yellow-100 text-yellow-800');
                    return;
                }

                const syncIcon = document.getElementById('syncIcon');
                const syncText = document.getElementById('syncText');
                
                syncIcon.classList.add('sync-animation');
                syncText.textContent = '同步中...';
                
                try {
                    await this.syncToCloud();
                    this.showSystemNotification('✅', '資料同步成功', 'bg-green-100 text-green-800');
                } catch (error) {
                    this.showSystemNotification('❌', '同步失敗: ' + error.message, 'bg-red-100 text-red-800');
                } finally {
                    setTimeout(() => {
                        syncIcon.classList.remove('sync-animation');
                        syncText.textContent = '立即同步';
                    }, 1000);
                }
            }

            showShareModal() {
                document.getElementById('shareCode').value = this.deviceId;
                document.getElementById('shareModal').classList.remove('hidden');
                document.getElementById('shareModal').classList.add('flex');
            }

            hideShareModal() {
                document.getElementById('shareModal').classList.add('hidden');
                document.getElementById('shareModal').classList.remove('flex');
                document.getElementById('shareStatus').classList.add('hidden');
            }

            async copyShareCode() {
                try {
                    await navigator.clipboard.writeText(this.deviceId);
                    this.showShareStatus('✅', '分享代碼已複製', 'bg-green-100 text-green-800');
                } catch (error) {
                    this.showShareStatus('❌', '複製失敗', 'bg-red-100 text-red-800');
                }
            }

            async handleAccessSharedData() {
                const shareCode = document.getElementById('accessCode').value.trim();
                if (!shareCode) {
                    this.showShareStatus('⚠️', '請輸入分享代碼', 'bg-yellow-100 text-yellow-800');
                    return;
                }

                this.showShareStatus('⏳', '正在存取分享資料...', 'bg-blue-100 text-blue-800');

                try {
                    const sharedData = await this.accessSharedData(shareCode);
                    
                    if (confirm('確定要載入分享的資料嗎？這將覆蓋現有資料。')) {
                        this.data = sharedData;
                        this.saveLocalData();
                        await this.syncToCloud();
                        this.updateUI();
                        
                        this.showShareStatus('✅', '分享資料載入成功', 'bg-green-100 text-green-800');
                        
                        setTimeout(() => {
                            this.hideShareModal();
                        }, 2000);
                    } else {
                        this.showShareStatus('ℹ️', '載入已取消', 'bg-gray-100 text-gray-800');
                    }
                } catch (error) {
                    this.showShareStatus('❌', error.message, 'bg-red-100 text-red-800');
                }
            }

            showShareStatus(icon, text, className) {
                const statusDiv = document.getElementById('shareStatus');
                const statusIcon = document.getElementById('shareStatusIcon');
                const statusText = document.getElementById('shareStatusText');
                
                statusIcon.textContent = icon;
                statusText.textContent = text;
                statusDiv.className = `mt-4 p-3 rounded-lg text-sm ${className}`;
                statusDiv.classList.remove('hidden');
                
                if (icon === '✅') {
                    setTimeout(() => {
                        statusDiv.classList.add('hidden');
                    }, 3000);
                }
            }

            // 搜尋相關方法
            search() {
                const query = document.getElementById('searchInput').value.trim();
                if (!query) return;

                const results = this.performSearch(query);
                this.displaySearchResults(query, results);
            }

            performSearch(query) {
                const results = {
                    herbResults: [],
                    symptomResults: []
                };

                const normalizedQuery = query.toLowerCase();

                // 搜尋中藥
                Object.keys(this.data.herbs).forEach(herb => {
                    if (herb.toLowerCase().includes(normalizedQuery)) {
                        results.herbResults.push({
                            name: herb,
                            symptoms: this.data.herbs[herb],
                            score: 100
                        });
                    }
                });

                // 搜尋症狀
                Object.keys(this.data.symptoms).forEach(symptom => {
                    if (symptom.toLowerCase().includes(normalizedQuery)) {
                        results.symptomResults.push({
                            name: symptom,
                            herbs: this.data.symptoms[symptom],
                            score: 100
                        });
                    }
                });

                return results;
            }

            displaySearchResults(query, results) {
                const resultsSection = document.getElementById('resultsSection');
                const searchResults = document.getElementById('searchResults');
                
                resultsSection.classList.remove('hidden');
                searchResults.innerHTML = '';

                const totalResults = results.herbResults.length + results.symptomResults.length;

                if (totalResults === 0) {
                    searchResults.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <div class="text-4xl mb-4">🔍</div>
                            <p class="text-lg">未找到相關結果</p>
                            <p class="text-sm mt-2">請嘗試其他關鍵字或檢查拼寫</p>
                        </div>
                    `;
                    return;
                }

                // 顯示中藥結果
                if (results.herbResults.length > 0) {
                    const herbSection = document.createElement('div');
                    herbSection.className = 'mb-8';
                    herbSection.innerHTML = `
                        <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                            <span class="mr-2">🌿</span>
                            <span>中藥</span>
                            <span class="ml-2 text-xs text-gray-500">(${results.herbResults.length})</span>
                        </h4>
                    `;

                    results.herbResults.forEach(herb => {
                        const herbCard = document.createElement('div');
                        herbCard.className = `bg-gradient-to-r from-green-50 to-green-25 border-l-4 border-green-500 p-4 rounded-lg mb-3`;
                        herbCard.innerHTML = `
                            <div class="flex justify-between items-start mb-3">
                                <h5 class="font-bold text-green-800 text-lg">${herb.name}</h5>
                                <div class="text-sm font-medium text-gray-700">${herb.score}%</div>
                            </div>
                            <div class="mb-2">
                                <div class="text-xs text-gray-600 mb-1">主治症狀：</div>
                                <div class="flex flex-wrap gap-1">
                                    ${herb.symptoms.map(symptom => 
                                        `<span class="px-2 py-1 text-xs rounded bg-green-100 text-green-800">${symptom}</span>`
                                    ).join('')}
                                </div>
                            </div>
                        `;
                        herbSection.appendChild(herbCard);
                    });

                    searchResults.appendChild(herbSection);
                }

                // 顯示症狀結果
                if (results.symptomResults.length > 0) {
                    const symptomSection = document.createElement('div');
                    symptomSection.className = 'mb-8';
                    symptomSection.innerHTML = `
                        <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                            <span class="mr-2">🩺</span>
                            <span>症狀</span>
                            <span class="ml-2 text-xs text-gray-500">(${results.symptomResults.length})</span>
                        </h4>
                    `;

                    results.symptomResults.forEach(symptom => {
                        const symptomCard = document.createElement('div');
                        symptomCard.className = `bg-gradient-to-r from-blue-50 to-blue-25 border-l-4 border-blue-500 p-4 rounded-lg mb-3`;
                        symptomCard.innerHTML = `
                            <div class="flex justify-between items-start mb-3">
                                <h5 class="font-bold text-blue-800 text-lg">${symptom.name}</h5>
                                <div class="text-sm font-medium text-gray-700">${symptom.score}%</div>
                            </div>
                            <div class="mb-2">
                                <div class="text-xs text-gray-600 mb-1">相關中藥：</div>
                                <div class="flex flex-wrap gap-1">
                                    ${symptom.herbs.map(herb => 
                                        `<span class="px-2 py-1 text-xs rounded bg-blue-100 text-blue-800">${herb}</span>`
                                    ).join('')}
                                </div>
                            </div>
                        `;
                        symptomSection.appendChild(symptomCard);
                    });

                    searchResults.appendChild(symptomSection);
                }
            }

            showSearchSuggestions(query) {
                const suggestionsDiv = document.getElementById('searchSuggestions');
                
                if (!query || query.length < 1) {
                    this.hideSearchSuggestions();
                    return;
                }

                const suggestions = this.generateSuggestions(query);
                
                if (suggestions.length === 0) {
                    this.hideSearchSuggestions();
                    return;
                }

                suggestionsDiv.innerHTML = '';
                suggestions.forEach(suggestion => {
                    const suggestionItem = document.createElement('div');
                    suggestionItem.className = 'px-4 py-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0 flex items-center justify-between';
                    suggestionItem.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <span class="text-lg">${suggestion.icon}</span>
                            <div>
                                <div class="font-medium text-gray-800">${suggestion.text}</div>
                                <div class="text-xs text-gray-500">${suggestion.type} • ${suggestion.count} 個相關項目</div>
                            </div>
                        </div>
                    `;
                    
                    suggestionItem.addEventListener('click', () => {
                        document.getElementById('searchInput').value = suggestion.text;
                        this.hideSearchSuggestions();
                        this.search();
                    });
                    
                    suggestionsDiv.appendChild(suggestionItem);
                });

                suggestionsDiv.classList.remove('hidden');
            }

            generateSuggestions(query) {
                const suggestions = [];
                const normalizedQuery = query.toLowerCase();

                // 從中藥獲取建議
                Object.keys(this.data.herbs).forEach(herb => {
                    if (herb.toLowerCase().includes(normalizedQuery)) {
                        suggestions.push({
                            text: herb,
                            type: '中藥',
                            icon: '🌿',
                            count: this.data.herbs[herb].length,
                            category: 'herb'
                        });
                    }
                });

                // 從症狀獲取建議
                Object.keys(this.data.symptoms).forEach(symptom => {
                    if (symptom.toLowerCase().includes(normalizedQuery)) {
                        suggestions.push({
                            text: symptom,
                            type: '症狀',
                            icon: '🩺',
                            count: this.data.symptoms[symptom].length,
                            category: 'symptom'
                        });
                    }
                });

                return suggestions.slice(0, 8);
            }

            hideSearchSuggestions() {
                document.getElementById('searchSuggestions').classList.add('hidden');
            }

            // 資料管理方法
            triggerFileImport() {
                document.getElementById('fileInput').click();
            }

            toggleManualInput() {
                const manualSection = document.getElementById('manualInputSection');
                const isHidden = manualSection.classList.contains('hidden');
                
                if (isHidden) {
                    manualSection.classList.remove('hidden');
                    document.getElementById('textImportBtn').textContent = '✏️ 隱藏輸入';
                } else {
                    manualSection.classList.add('hidden');
                    document.getElementById('textImportBtn').innerHTML = '✏️ 手動輸入';
                }
            }

            async processImportData() {
                const importText = document.getElementById('importData').value.trim();
                if (!importText) {
                    this.showImportStatus('⚠️', '請輸入要導入的資料', 'bg-yellow-100 text-yellow-800');
                    return;
                }

                this.showImportStatus('⏳', '正在處理資料...', 'bg-blue-100 text-blue-800');

                const lines = importText.split('\n').filter(line => line.trim());
                let successCount = 0;

                lines.forEach(line => {
                    const parts = line.split('：');
                    if (parts.length === 2) {
                        const herb = parts[0].trim();
                        const symptoms = parts[1].split(',').map(s => s.trim()).filter(s => s);
                        
                        if (herb && symptoms.length > 0) {
                            this.addHerbData(herb, symptoms);
                            successCount++;
                        }
                    }
                });

                this.saveLocalData();
                this.updateUI();
                document.getElementById('importData').value = '';
                
                this.showImportStatus('✅', `成功導入 ${successCount} 條中藥資料`, 'bg-green-100 text-green-800');
                
                // 自動同步到雲端
                if (this.isFirebaseReady) {
                    try {
                        await this.syncToCloud();
                    } catch (error) {
                        console.error('自動同步失敗:', error);
                    }
                }
                
                setTimeout(() => {
                    document.getElementById('manualInputSection').classList.add('hidden');
                    document.getElementById('textImportBtn').innerHTML = '✏️ 手動輸入';
                    document.getElementById('importStatus').classList.add('hidden');
                }, 2000);
            }

            addHerbData(herb, symptoms) {
                if (!this.data.herbs[herb]) {
                    this.data.herbs[herb] = [];
                }
                
                symptoms.forEach(symptom => {
                    if (!this.data.herbs[herb].includes(symptom)) {
                        this.data.herbs[herb].push(symptom);
                    }
                    
                    if (!this.data.symptoms[symptom]) {
                        this.data.symptoms[symptom] = [];
                    }
                    if (!this.data.symptoms[symptom].includes(herb)) {
                        this.data.symptoms[symptom].push(herb);
                    }
                });
            }

            handleFileImport(event) {
                const file = event.target.files[0];
                if (!file) return;

                this.showImportStatus('⏳', '正在處理檔案...', 'bg-blue-100 text-blue-800');

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const content = e.target.result;
                        let successCount = 0;
                        
                        if (file.name.endsWith('.json')) {
                            const importedData = JSON.parse(content);
                            if (importedData.data) {
                                this.data = importedData.data;
                                successCount = Object.keys(importedData.data.herbs || {}).length;
                            } else {
                                this.data = importedData;
                                successCount = Object.keys(importedData.herbs || {}).length;
                            }
                        } else {
                            const lines = content.split('\n').filter(line => line.trim());
                            lines.forEach(line => {
                                const parts = line.split('：');
                                if (parts.length === 2) {
                                    const herb = parts[0].trim();
                                    const symptoms = parts[1].split(',').map(s => s.trim()).filter(s => s);
                                    
                                    if (herb && symptoms.length > 0) {
                                        this.addHerbData(herb, symptoms);
                                        successCount++;
                                    }
                                }
                            });
                        }
                        
                        this.saveLocalData();
                        this.updateUI();
                        this.showImportStatus('✅', `成功導入 ${successCount} 條資料`, 'bg-green-100 text-green-800');
                        
                        // 自動同步到雲端
                        if (this.isFirebaseReady) {
                            try {
                                await this.syncToCloud();
                            } catch (error) {
                                console.error('自動同步失敗:', error);
                            }
                        }
                        
                        setTimeout(() => {
                            document.getElementById('importStatus').classList.add('hidden');
                        }, 3000);
                        
                    } catch (error) {
                        this.showImportStatus('❌', '檔案格式錯誤，請檢查檔案內容', 'bg-red-100 text-red-800');
                    }
                };
                reader.readAsText(file);
                
                event.target.value = '';
            }

            showImportStatus(icon, text, className) {
                const statusDiv = document.getElementById('importStatus');
                const statusIcon = document.getElementById('statusIcon');
                const statusText = document.getElementById('statusText');
                
                statusIcon.textContent = icon;
                statusText.textContent = text;
                statusDiv.className = `p-3 rounded-lg ${className}`;
                statusDiv.classList.remove('hidden');
            }

            // 備份相關方法
            showBackupModal() {
                const herbCount = Object.keys(this.data.herbs).length;
                const symptomCount = Object.keys(this.data.symptoms).length;
                const cloudStatus = this.isFirebaseReady ? '已連接' : '未連接';
                
                document.getElementById('backupHerbCount').textContent = herbCount;
                document.getElementById('backupSymptomCount').textContent = symptomCount;
                document.getElementById('cloudSyncStatus').textContent = cloudStatus;
                
                document.getElementById('backupModal').classList.remove('hidden');
                document.getElementById('backupModal').classList.add('flex');
            }

            hideBackupModal() {
                document.getElementById('backupModal').classList.add('hidden');
                document.getElementById('backupModal').classList.remove('flex');
                document.getElementById('backupStatus').classList.add('hidden');
            }

            downloadBackup() {
                try {
                    const backupData = this.createBackupData();
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
                    const filename = `TCM_CloudBackup_${timestamp}.json`;
                    
                    const blob = new Blob([JSON.stringify(backupData, null, 2)], { 
                        type: 'application/json' 
                    });
                    
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    link.click();
                    
                    URL.revokeObjectURL(url);
                    
                    this.showBackupStatus('✅', '備份檔案已下載完成！', 'bg-green-100 text-green-800');
                } catch (error) {
                    this.showBackupStatus('❌', '下載失敗，請重試', 'bg-red-100 text-red-800');
                }
            }

            async copyBackupToClipboard() {
                try {
                    const backupData = this.createBackupData();
                    const backupText = JSON.stringify(backupData, null, 2);
                    
                    await navigator.clipboard.writeText(backupText);
                    this.showBackupStatus('✅', '備份資料已複製到剪貼簿！', 'bg-green-100 text-green-800');
                } catch (error) {
                    const textArea = document.createElement('textarea');
                    textArea.value = JSON.stringify(this.createBackupData(), null, 2);
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    this.showBackupStatus('✅', '備份資料已複製到剪貼簿！', 'bg-green-100 text-green-800');
                }
            }

            triggerBackupRestore() {
                document.getElementById('backupFileInput').click();
            }

            async handleBackupRestore(event) {
                const file = event.target.files[0];
                if (!file) return;

                this.showBackupStatus('⏳', '正在恢復備份...', 'bg-blue-100 text-blue-800');

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        if (this.validateBackupData(backupData)) {
                            if (confirm('確定要恢復此備份嗎？這將覆蓋現有的所有資料。')) {
                                this.restoreFromBackup(backupData);
                                
                                // 同步到雲端
                                if (this.isFirebaseReady) {
                                    try {
                                        await this.syncToCloud();
                                    } catch (error) {
                                        console.error('恢復後同步失敗:', error);
                                    }
                                }
                                
                                this.showBackupStatus('✅', '備份恢復成功！', 'bg-green-100 text-green-800');
                                
                                setTimeout(() => {
                                    this.hideBackupModal();
                                    this.updateUI();
                                }, 1500);
                            } else {
                                this.showBackupStatus('ℹ️', '恢復已取消', 'bg-gray-100 text-gray-800');
                            }
                        } else {
                            this.showBackupStatus('❌', '備份檔案格式不正確', 'bg-red-100 text-red-800');
                        }
                    } catch (error) {
                        this.showBackupStatus('❌', '備份檔案損壞或格式錯誤', 'bg-red-100 text-red-800');
                    }
                };
                
                reader.readAsText(file);
                event.target.value = '';
            }

            createBackupData() {
                return {
                    version: this.currentVersion,
                    appName: '中醫診症輔助工具 - 雲端同步版',
                    backupDate: new Date().toISOString(),
                    backupTime: new Date().toLocaleString('zh-TW'),
                    deviceId: this.deviceId,
                    cloudSync: this.isFirebaseReady,
                    statistics: {
                        herbCount: Object.keys(this.data.herbs).length,
                        symptomCount: Object.keys(this.data.symptoms).length,
                        totalRelations: Object.values(this.data.herbs).reduce((sum, symptoms) => sum + symptoms.length, 0)
                    },
                    data: {
                        herbs: this.data.herbs,
                        symptoms: this.data.symptoms
                    },
                    checksum: this.generateChecksum(this.data)
                };
            }

            validateBackupData(backupData) {
                if (!backupData.data || !backupData.data.herbs || !backupData.data.symptoms) {
                    return false;
                }
                
                if (typeof backupData.data.herbs !== 'object' || typeof backupData.data.symptoms !== 'object') {
                    return false;
                }
                
                if (backupData.checksum) {
                    const calculatedChecksum = this.generateChecksum(backupData.data);
                    if (calculatedChecksum !== backupData.checksum) {
                        console.warn('Backup checksum mismatch - data may be corrupted');
                    }
                }
                
                return true;
            }

            restoreFromBackup(backupData) {
                this.data = {
                    herbs: backupData.data.herbs,
                    symptoms: backupData.data.symptoms
                };
                
                this.saveLocalData();
                
                document.getElementById('resultsSection').classList.add('hidden');
                document.getElementById('searchInput').value = '';
            }

            showBackupStatus(icon, text, className) {
                const statusDiv = document.getElementById('backupStatus');
                const statusIcon = document.getElementById('backupStatusIcon');
                const statusText = document.getElementById('backupStatusText');
                
                statusIcon.textContent = icon;
                statusText.textContent = text;
                statusDiv.className = `mt-4 p-3 rounded-lg text-sm ${className}`;
                statusDiv.classList.remove('hidden');
                
                if (icon === '✅') {
                    setTimeout(() => {
                        statusDiv.classList.add('hidden');
                    }, 3000);
                }
            }

            updateUI() {
                const herbCount = Object.keys(this.data.herbs).length;
                const symptomCount = Object.keys(this.data.symptoms).length;
                
                document.getElementById('herbCount').textContent = herbCount;
                document.getElementById('symptomCount').textContent = symptomCount;
                
                this.updateSyncStatus();
            }
        }

        // 初始化應用程式
        document.addEventListener('DOMContentLoaded', () => {
            new CloudTCMTool();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9652d95cf50184ab',t:'MTc1MzUyMTkxOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
