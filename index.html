<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­é†«è™•æ–¹æ¨è–¦å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-5xl">
        <!-- æ¨™é¡Œ -->
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸŒ¿ ä¸­é†«è™•æ–¹å·¥å…·</h1>
        </div>

        <!-- å®Œæ•´æ•¸æ“šå‚™ä»½ç³»çµ± -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-4">
            <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ’¾ æ•¸æ“šå‚™ä»½ä¸­å¿ƒ</h2>
            
            <!-- å‚™ä»½æ“ä½œå€ -->
            <div class="grid md:grid-cols-3 gap-4 mb-6">
                <!-- å°å‡ºå‚™ä»½ -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h3 class="font-bold text-blue-800 mb-3">ğŸ“¤ å°å‡ºå‚™ä»½</h3>
                    <div class="space-y-2">
                        <button onclick="exportFullBackup()" 
                                class="w-full bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg font-medium text-sm">
                            ğŸ’¾ å®Œæ•´å‚™ä»½
                        </button>
                        <button onclick="exportCompressedBackup()" 
                                class="w-full bg-blue-400 hover:bg-blue-500 text-white px-3 py-2 rounded-lg font-medium text-sm">
                            ğŸ—œï¸ å£“ç¸®å‚™ä»½
                        </button>
                        <button onclick="exportReadableBackup()" 
                                class="w-full bg-blue-300 hover:bg-blue-400 text-white px-3 py-2 rounded-lg font-medium text-sm">
                            ğŸ“„ å¯è®€æ ¼å¼
                        </button>
                    </div>
                </div>
                
                <!-- å°å…¥æ¢å¾© -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <h3 class="font-bold text-green-800 mb-3">ğŸ“¥ å°å…¥æ¢å¾©</h3>
                    <div class="space-y-2">
                        <button onclick="document.getElementById('importBackupFile').click()" 
                                class="w-full bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg font-medium text-sm">
                            ğŸ“‚ é¸æ“‡å‚™ä»½æ–‡ä»¶
                        </button>
                        <button onclick="showImportOptions()" 
                                class="w-full bg-green-400 hover:bg-green-500 text-white px-3 py-2 rounded-lg font-medium text-sm">
                            âš™ï¸ å°å…¥é¸é …
                        </button>
                        <button onclick="validateBackupFile()" 
                                class="w-full bg-green-300 hover:bg-green-400 text-white px-3 py-2 rounded-lg font-medium text-sm">
                            ğŸ” é©—è­‰å‚™ä»½
                        </button>
                    </div>
                </div>
                
                <!-- è‡ªå‹•å‚™ä»½ -->
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                    <h3 class="font-bold text-purple-800 mb-3">ğŸ”„ è‡ªå‹•å‚™ä»½</h3>
                    <div class="space-y-2">
                        <button onclick="toggleAutoBackup()" id="autoBackupBtn"
                                class="w-full bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded-lg font-medium text-sm">
                            ğŸ”„ å•Ÿç”¨è‡ªå‹•å‚™ä»½
                        </button>
                        <button onclick="showBackupHistory()" 
                                class="w-full bg-purple-400 hover:bg-purple-500 text-white px-3 py-2 rounded-lg font-medium text-sm">
                            ğŸ“š å‚™ä»½æ­·å²
                        </button>
                        <button onclick="cleanupBackups()" 
                                class="w-full bg-purple-300 hover:bg-purple-400 text-white px-3 py-2 rounded-lg font-medium text-sm">
                            ğŸ§¹ æ¸…ç†å‚™ä»½
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- å‚™ä»½ç‹€æ…‹é¡¯ç¤º -->
            <div class="bg-gray-50 rounded-lg p-4 mb-4">
                <div class="grid md:grid-cols-4 gap-4 text-center">
                    <div>
                        <div class="text-2xl font-bold text-blue-600" id="totalBackups">0</div>
                        <div class="text-sm text-gray-600">ç¸½å‚™ä»½æ•¸</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-green-600" id="lastBackupTime">å¾æœª</div>
                        <div class="text-sm text-gray-600">æœ€å¾Œå‚™ä»½</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-purple-600" id="autoBackupStatus">é—œé–‰</div>
                        <div class="text-sm text-gray-600">è‡ªå‹•å‚™ä»½</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-orange-600" id="dataSize">0KB</div>
                        <div class="text-sm text-gray-600">æ•¸æ“šå¤§å°</div>
                    </div>
                </div>
            </div>
            
            <!-- æ“ä½œçµæœé¡¯ç¤º -->
            <div id="backupResult" class="hidden p-4 rounded-lg mb-4"></div>
            
            <!-- å±éšªæ“ä½œå€ -->
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <h3 class="font-bold text-red-800 mb-3">âš ï¸ å±éšªæ“ä½œ</h3>
                <div class="flex flex-wrap gap-2">
                    <button onclick="clearAllData()" 
                            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium text-sm">
                        ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•¸æ“š
                    </button>
                    <button onclick="resetToDefaults()" 
                            class="bg-red-400 hover:bg-red-500 text-white px-4 py-2 rounded-lg font-medium text-sm">
                        ğŸ”„ é‡ç½®ç‚ºé»˜èª
                    </button>
                    <button onclick="emergencyBackup()" 
                            class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-medium text-sm">
                        ğŸš¨ ç·Šæ€¥å‚™ä»½
                    </button>
                </div>
            </div>
            
            <!-- éš±è—çš„æ–‡ä»¶è¼¸å…¥ -->
            <input type="file" id="importBackupFile" accept=".json,.txt" style="display: none;" onchange="importBackupFile(event)">
        </div>

        <!-- æ‰¹é‡å°å…¥å€ -->
        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border border-yellow-200 rounded-lg p-4 mb-4">
            <h3 class="text-lg font-bold text-gray-700 mb-3">ğŸ“‹ æ‰¹é‡å°å…¥ä¸­è—¥ç—‡ç‹€</h3>
            <div class="space-y-3">
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“ æ–‡æœ¬å°å…¥</label>
                        <textarea id="bulkImportText" 
                                  placeholder="æ ¼å¼ï¼šä¸­è—¥åï¼šç—‡ç‹€1,ç—‡ç‹€2,ç—‡ç‹€3&#10;ä¾‹å¦‚ï¼š&#10;ç•¶æ­¸ï¼šè¡€è™›,æœˆç¶“ä¸èª¿,ä¾¿ç§˜&#10;é»ƒèŠªï¼šæ°£è™›,ç–²å‹,è‡ªæ±—&#10;ç”˜è‰ï¼šå’³å—½,èƒƒç—›,è§£æ¯’&#10;&#10;ğŸ’¡ æ”¯æŒå¤§é‡æ•¸æ“šå°å…¥ï¼ˆå»ºè­°å–®æ¬¡ä¸è¶…é10è¬å­—ï¼‰"
                                  rows="6" 
                                  maxlength="100000"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm resize-y"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“ æ–‡ä»¶å°å…¥</label>
                        <div class="space-y-2">
                            <button onclick="document.getElementById('bulkImportFile').click()" 
                                    class="w-full bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded-lg font-medium text-sm">
                                ğŸ“ é¸æ“‡æ–‡ä»¶å°å…¥
                            </button>
                            <button onclick="downloadTemplate()" 
                                    class="w-full bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg font-medium text-sm">
                                ğŸ“„ ä¸‹è¼‰æ¨¡æ¿æ–‡ä»¶
                            </button>
                        </div>
                    </div>
                </div>
                <div class="flex justify-between items-center">
                    <div class="flex gap-2">
                        <button onclick="processBulkImport()" 
                                class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium text-sm">
                            âš¡ é–‹å§‹å°å…¥
                        </button>
                        <button onclick="clearBulkImport()" 
                                class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium text-sm">
                            ğŸ§¹ æ¸…ç©ºè¼¸å…¥
                        </button>
                    </div>
                    <div id="charCount" class="text-sm text-gray-500">
                        å­—æ•¸ï¼š0 / 100,000
                    </div>
                </div>
            </div>
            <input type="file" id="bulkImportFile" accept=".txt,.csv" style="display: none;" onchange="loadBulkImportFile(event)">
        </div>

        <!-- ä¸»æœç´¢å€ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="space-y-4">
                <input type="text" id="symptomSearch" placeholder="è¼¸å…¥ç—‡ç‹€æœç´¢è™•æ–¹ï¼Œä¾‹å¦‚ï¼šé ­ç—›,ç™¼ç†±" 
                       class="w-full px-4 py-3 text-lg border-2 border-gray-200 rounded-lg focus:border-green-500 focus:outline-none">
                
                <!-- å¿«é€Ÿé¸æ“‡æŒ‰éˆ• -->
                <div class="flex flex-wrap gap-2" id="quickSelectGroups"></div>
                
                <button onclick="searchPrescriptions()" 
                        class="w-full bg-green-500 hover:bg-green-600 text-white text-lg font-medium py-3 rounded-lg">
                    ğŸ” æœç´¢è™•æ–¹
                </button>
            </div>

            <!-- æœç´¢çµæœ -->
            <div id="searchResults" class="mt-6 hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4">æ¨è–¦è™•æ–¹</h3>
                <div id="resultsList" class="space-y-4"></div>
            </div>
        </div>

        <!-- æ¨™ç±¤é å°èˆª -->
        <div class="bg-white rounded-lg shadow-md mb-6">
            <div class="flex border-b">
                <button onclick="showTab('groups')" id="groupsTab" 
                        class="flex-1 py-3 px-4 text-center font-medium border-b-2 border-green-500 text-green-600">
                    ç—‡ç‹€åˆ†çµ„
                </button>
                <button onclick="showTab('symptoms')" id="symptomsTab" 
                        class="flex-1 py-3 px-4 text-center font-medium text-gray-500 hover:text-gray-700">
                    ç—‡ç‹€ç®¡ç†
                </button>
                <button onclick="showTab('prescriptions')" id="prescriptionsTab" 
                        class="flex-1 py-3 px-4 text-center font-medium text-gray-500 hover:text-gray-700">
                    è™•æ–¹ç®¡ç†
                </button>
            </div>

            <!-- ç—‡ç‹€åˆ†çµ„æ¨™ç±¤é  -->
            <div id="groupsContent" class="p-6">
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- å‰µå»ºåˆ†çµ„ -->
                    <div>
                        <h3 class="text-lg font-bold mb-4">å‰µå»ºæ–°åˆ†çµ„</h3>
                        <div class="space-y-3">
                            <input type="text" id="newGroupName" placeholder="åˆ†çµ„åç¨±" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <input type="text" id="newGroupSymptoms" placeholder="ç—‡ç‹€ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <select id="groupColor" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="red">ğŸ”´ ç´…è‰²</option>
                                <option value="blue">ğŸ”µ è—è‰²</option>
                                <option value="green">ğŸŸ¢ ç¶ è‰²</option>
                                <option value="orange">ğŸŸ  æ©™è‰²</option>
                                <option value="purple">ğŸŸ£ ç´«è‰²</option>
                                <option value="pink">ğŸ©· ç²‰è‰²</option>
                            </select>
                            <button onclick="addSymptomGroup()" 
                                    class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg">
                                â• å‰µå»ºåˆ†çµ„
                            </button>
                        </div>
                    </div>
                    
                    <!-- ç¾æœ‰åˆ†çµ„ -->
                    <div>
                        <h3 class="text-lg font-bold mb-4">ç¾æœ‰åˆ†çµ„</h3>
                        <div id="symptomGroupsList" class="space-y-3 max-h-80 overflow-y-auto"></div>
                    </div>
                </div>
            </div>

            <!-- ç—‡ç‹€ç®¡ç†æ¨™ç±¤é  -->
            <div id="symptomsContent" class="p-6 hidden">
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-bold mb-4">æ·»åŠ ç—‡ç‹€</h3>
                        <div class="flex gap-2">
                            <input type="text" id="newSymptom" placeholder="è¼¸å…¥æ–°ç—‡ç‹€" 
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg">
                            <button onclick="addSymptom()" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                                â• æ·»åŠ 
                            </button>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold mb-4">æ‰€æœ‰ç—‡ç‹€ (<span id="symptomCount">0</span>)</h3>
                        <div id="symptomsList" class="max-h-80 overflow-y-auto space-y-2"></div>
                    </div>
                </div>
            </div>

            <!-- è™•æ–¹ç®¡ç†æ¨™ç±¤é  -->
            <div id="prescriptionsContent" class="p-6 hidden">
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-bold mb-4">æ·»åŠ è™•æ–¹</h3>
                        <div class="space-y-3">
                            <input type="text" id="prescriptionName" placeholder="è™•æ–¹åç¨±" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <textarea id="prescriptionIngredients" placeholder="è—¥æçµ„æˆï¼ˆæ¯è¡Œä¸€å‘³è—¥ï¼‰" rows="4"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
                            <input type="text" id="prescriptionSymptoms" placeholder="é©ç”¨ç—‡ç‹€ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <button onclick="addPrescription()" 
                                    class="w-full bg-purple-500 hover:bg-purple-600 text-white py-2 rounded-lg">
                                â• æ·»åŠ è™•æ–¹
                            </button>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold mb-4">ç¾æœ‰è™•æ–¹ (<span id="prescriptionCount">0</span>)</h3>
                        <div id="prescriptionsList" class="max-h-80 overflow-y-auto space-y-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å°å…¥é¸é …æ¨¡æ…‹æ¡† -->
        <div id="importOptionsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-lg p-6 max-w-md w-full">
                    <h3 class="text-lg font-bold mb-4">âš™ï¸ å°å…¥é¸é …</h3>
                    <div class="space-y-3">
                        <label class="flex items-center">
                            <input type="radio" name="importMode" value="replace" checked class="mr-2">
                            <span>ğŸ”„ å®Œå…¨æ›¿æ›ï¼ˆæ¸…ç©ºç¾æœ‰æ•¸æ“šï¼‰</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="importMode" value="merge" class="mr-2">
                            <span>ğŸ”— åˆä½µæ•¸æ“šï¼ˆä¿ç•™ç¾æœ‰æ•¸æ“šï¼‰</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="importMode" value="append" class="mr-2">
                            <span>â• åƒ…æ·»åŠ æ–°æ•¸æ“š</span>
                        </label>
                    </div>
                    <div class="flex gap-2 mt-6">
                        <button onclick="closeImportOptions()" 
                                class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg">
                            å–æ¶ˆ
                        </button>
                        <button onclick="confirmImportOptions()" 
                                class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg">
                            ç¢ºå®š
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- å‚™ä»½æ­·å²æ¨¡æ…‹æ¡† -->
        <div id="backupHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-lg p-6 max-w-2xl w-full max-h-96 overflow-y-auto">
                    <h3 class="text-lg font-bold mb-4">ğŸ“š å‚™ä»½æ­·å²</h3>
                    <div id="backupHistoryList" class="space-y-2"></div>
                    <div class="flex justify-end mt-6">
                        <button onclick="closeBackupHistory()" 
                                class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                            é—œé–‰
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ•¸æ“šå­˜å„²
        let symptoms = JSON.parse(localStorage.getItem('tcm_symptoms') || '[]');
        let symptomGroups = JSON.parse(localStorage.getItem('tcm_symptom_groups') || '[]');
        let prescriptions = JSON.parse(localStorage.getItem('tcm_prescriptions') || '[]');

        // å‚™ä»½ç³»çµ±é…ç½®
        const BACKUP_CONFIG = {
            maxBackups: 50,
            autoBackupInterval: 5 * 60 * 1000, // 5åˆ†é˜
            compressionLevel: 9,
            encryptionEnabled: false
        };

        let autoBackupEnabled = localStorage.getItem('tcm_auto_backup_enabled') === 'true';
        let autoBackupTimer = null;

        // åˆå§‹åŒ–ç¤ºä¾‹æ•¸æ“š
        if (symptoms.length === 0) {
            symptoms = ['é ­ç—›', 'ç™¼ç†±', 'å’³å—½', 'è…¹ç—›', 'å¤±çœ ', 'ç–²å‹', 'é£Ÿæ…¾ä¸æŒ¯', 'å™å¿ƒ', 'åé ­ç—›', 'é ­æšˆ', 'é«˜ç†±', 'ä½ç†±', 'ä¹¾å’³', 'æ¿•å’³', 'èƒƒç—›', 'è…¹è„¹'];
            localStorage.setItem('tcm_symptoms', JSON.stringify(symptoms));
        }

        if (symptomGroups.length === 0) {
            symptomGroups = [
                {
                    name: 'é ­éƒ¨ç—‡ç‹€',
                    symptoms: ['é ­ç—›', 'åé ­ç—›', 'é ­æšˆ'],
                    color: 'red'
                },
                {
                    name: 'ç™¼ç†±ç—‡ç‹€',
                    symptoms: ['ç™¼ç†±', 'é«˜ç†±', 'ä½ç†±'],
                    color: 'orange'
                },
                {
                    name: 'å’³å—½ç—‡ç‹€',
                    symptoms: ['å’³å—½', 'ä¹¾å’³', 'æ¿•å’³'],
                    color: 'blue'
                },
                {
                    name: 'è…¸èƒƒç—‡ç‹€',
                    symptoms: ['è…¹ç—›', 'èƒƒç—›', 'è…¹è„¹', 'é£Ÿæ…¾ä¸æŒ¯', 'å™å¿ƒ'],
                    color: 'green'
                }
            ];
            localStorage.setItem('tcm_symptom_groups', JSON.stringify(symptomGroups));
        }

        if (prescriptions.length === 0) {
            prescriptions = [
                {
                    name: 'éŠ€ç¿¹æ•£',
                    ingredients: 'é‡‘éŠ€èŠ± 15g\né€£ç¿¹ 15g\nè–„è· 6g\nç‰›è’¡å­ 9g\næ¡”æ¢— 6g\nç”˜è‰ 5g',
                    symptoms: ['ç™¼ç†±', 'å’³å—½', 'é ­ç—›']
                },
                {
                    name: 'é€é™æ•£',
                    ingredients: 'æŸ´èƒ¡ 6g\nç•¶æ­¸ 9g\nç™½èŠ 9g\nç™½æœ® 9g\nèŒ¯è‹“ 9g\nç”˜è‰ 3g',
                    symptoms: ['è…¹ç—›', 'ç–²å‹', 'å¤±çœ ']
                },
                {
                    name: 'å¹³èƒƒæ•£',
                    ingredients: 'è’¼æœ® 12g\nåšæœ´ 9g\né™³çš® 6g\nç”˜è‰ 3g',
                    symptoms: ['è…¹ç—›', 'é£Ÿæ…¾ä¸æŒ¯', 'å™å¿ƒ']
                }
            ];
            localStorage.setItem('tcm_prescriptions', JSON.stringify(prescriptions));
        }

        // ==================== å®Œæ•´å‚™ä»½ç³»çµ± ====================

        // ç”Ÿæˆå‚™ä»½æ•¸æ“š
        function generateBackupData(includeMetadata = true) {
            const backupData = {
                symptoms: symptoms,
                symptomGroups: symptomGroups,
                prescriptions: prescriptions
            };

            if (includeMetadata) {
                backupData.metadata = {
                    version: '2.0',
                    timestamp: new Date().toISOString(),
                    dataCount: {
                        symptoms: symptoms.length,
                        symptomGroups: symptomGroups.length,
                        prescriptions: prescriptions.length
                    },
                    checksum: generateChecksum(backupData),
                    userAgent: navigator.userAgent,
                    exportType: 'full'
                };
            }

            return backupData;
        }

        // ç”Ÿæˆæ ¡é©—å’Œ
        function generateChecksum(data) {
            const str = JSON.stringify(data);
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // è½‰æ›ç‚º32ä½æ•´æ•¸
            }
            return Math.abs(hash).toString(16);
        }

        // å®Œæ•´å‚™ä»½å°å‡º
        function exportFullBackup() {
            try {
                const backupData = generateBackupData(true);
                const dataStr = JSON.stringify(backupData, null, 2);
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                
                downloadFile(dataStr, `ä¸­é†«è™•æ–¹å®Œæ•´å‚™ä»½_${timestamp}.json`, 'application/json');
                
                // ä¿å­˜åˆ°å‚™ä»½æ­·å²
                saveToBackupHistory(backupData, 'full');
                
                showBackupResult('âœ… å®Œæ•´å‚™ä»½å·²æˆåŠŸå°å‡ºï¼åŒ…å«æ‰€æœ‰æ•¸æ“šå’Œå…ƒæ•¸æ“šã€‚', 'success');
                updateBackupStatus();
                
            } catch (error) {
                showBackupResult('âŒ å®Œæ•´å‚™ä»½å¤±æ•—ï¼š' + error.message, 'error');
            }
        }

        // å£“ç¸®å‚™ä»½å°å‡º
        function exportCompressedBackup() {
            try {
                const backupData = generateBackupData(false);
                const compressedData = compressData(backupData);
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                
                downloadFile(compressedData, `ä¸­é†«è™•æ–¹å£“ç¸®å‚™ä»½_${timestamp}.json`, 'application/json');
                
                showBackupResult('âœ… å£“ç¸®å‚™ä»½å·²æˆåŠŸå°å‡ºï¼æ–‡ä»¶å¤§å°å·²å„ªåŒ–ã€‚', 'success');
                updateBackupStatus();
                
            } catch (error) {
                showBackupResult('âŒ å£“ç¸®å‚™ä»½å¤±æ•—ï¼š' + error.message, 'error');
            }
        }

        // å¯è®€æ ¼å¼å°å‡º
        function exportReadableBackup() {
            try {
                let readableContent = '# ä¸­é†«è™•æ–¹æ•¸æ“šå‚™ä»½\n';
                readableContent += `å°å‡ºæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}\n\n`;
                
                // ç—‡ç‹€åˆ—è¡¨
                readableContent += '## ç—‡ç‹€åˆ—è¡¨\n';
                symptoms.forEach((symptom, index) => {
                    readableContent += `${index + 1}. ${symptom}\n`;
                });
                
                // ç—‡ç‹€åˆ†çµ„
                readableContent += '\n## ç—‡ç‹€åˆ†çµ„\n';
                symptomGroups.forEach((group, index) => {
                    readableContent += `${index + 1}. ${group.name}ï¼ˆ${group.color}ï¼‰\n`;
                    readableContent += `   ç—‡ç‹€ï¼š${group.symptoms.join('ã€')}\n\n`;
                });
                
                // è™•æ–¹åˆ—è¡¨
                readableContent += '## è™•æ–¹åˆ—è¡¨\n';
                prescriptions.forEach((prescription, index) => {
                    readableContent += `${index + 1}. ${prescription.name}\n`;
                    readableContent += `   è—¥æï¼š\n${prescription.ingredients.split('\n').map(ing => '   - ' + ing).join('\n')}\n`;
                    readableContent += `   é©ç”¨ç—‡ç‹€ï¼š${prescription.symptoms.join('ã€')}\n\n`;
                });
                
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                downloadFile(readableContent, `ä¸­é†«è™•æ–¹å¯è®€å‚™ä»½_${timestamp}.txt`, 'text/plain');
                
                showBackupResult('âœ… å¯è®€æ ¼å¼å‚™ä»½å·²æˆåŠŸå°å‡ºï¼å¯ç”¨æ–‡æœ¬ç·¨è¼¯å™¨æŸ¥çœ‹ã€‚', 'success');
                
            } catch (error) {
                showBackupResult('âŒ å¯è®€æ ¼å¼å°å‡ºå¤±æ•—ï¼š' + error.message, 'error');
            }
        }

        // æ•¸æ“šå£“ç¸®
        function compressData(data) {
            // ç§»é™¤ä¸å¿…è¦çš„ç©ºæ ¼å’Œæ ¼å¼åŒ–
            const compressed = {
                s: data.symptoms,
                sg: data.symptomGroups.map(g => ({
                    n: g.name,
                    s: g.symptoms,
                    c: g.color
                })),
                p: data.prescriptions.map(p => ({
                    n: p.name,
                    i: p.ingredients,
                    s: p.symptoms
                })),
                t: new Date().toISOString()
            };
            
            return JSON.stringify(compressed);
        }

        // è§£å£“ç¸®æ•¸æ“š
        function decompressData(compressedStr) {
            try {
                const compressed = JSON.parse(compressedStr);
                
                if (compressed.s && compressed.sg && compressed.p) {
                    // å£“ç¸®æ ¼å¼
                    return {
                        symptoms: compressed.s,
                        symptomGroups: compressed.sg.map(g => ({
                            name: g.n,
                            symptoms: g.s,
                            color: g.c
                        })),
                        prescriptions: compressed.p.map(p => ({
                            name: p.n,
                            ingredients: p.i,
                            symptoms: p.s
                        })),
                        metadata: {
                            timestamp: compressed.t,
                            exportType: 'compressed'
                        }
                    };
                } else {
                    // æ¨™æº–æ ¼å¼
                    return compressed;
                }
            } catch (error) {
                throw new Error('æ•¸æ“šæ ¼å¼ç„¡æ³•è­˜åˆ¥');
            }
        }

        // æ–‡ä»¶ä¸‹è¼‰
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType + ';charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(link.href);
        }

        // å°å…¥å‚™ä»½æ–‡ä»¶
        function importBackupFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showBackupResult('ğŸ“‚ æ­£åœ¨è®€å–å‚™ä»½æ–‡ä»¶...', 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const backupData = decompressData(content);
                    
                    // é©—è­‰æ•¸æ“šå®Œæ•´æ€§
                    if (!validateBackupData(backupData)) {
                        throw new Error('å‚™ä»½æ–‡ä»¶æ•¸æ“šä¸å®Œæ•´æˆ–æ ¼å¼éŒ¯èª¤');
                    }
                    
                    // æ ¹æ“šå°å…¥æ¨¡å¼è™•ç†æ•¸æ“š
                    const importMode = getImportMode();
                    processImportData(backupData, importMode);
                    
                } catch (error) {
                    showBackupResult('âŒ å°å…¥å¤±æ•—ï¼š' + error.message, 'error');
                }
            };
            
            reader.onerror = function() {
                showBackupResult('âŒ æ–‡ä»¶è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ–‡ä»¶æ˜¯å¦æå£', 'error');
            };
            
            reader.readAsText(file, 'UTF-8');
            event.target.value = '';
        }

        // é©—è­‰å‚™ä»½æ•¸æ“š
        function validateBackupData(data) {
            if (!data || typeof data !== 'object') return false;
            
            // æª¢æŸ¥å¿…è¦å­—æ®µ
            if (!Array.isArray(data.symptoms) || 
                !Array.isArray(data.symptomGroups) || 
                !Array.isArray(data.prescriptions)) {
                return false;
            }
            
            // æª¢æŸ¥ç—‡ç‹€åˆ†çµ„æ ¼å¼
            for (let group of data.symptomGroups) {
                if (!group.name || !Array.isArray(group.symptoms) || !group.color) {
                    return false;
                }
            }
            
            // æª¢æŸ¥è™•æ–¹æ ¼å¼
            for (let prescription of data.prescriptions) {
                if (!prescription.name || !prescription.ingredients || !Array.isArray(prescription.symptoms)) {
                    return false;
                }
            }
            
            return true;
        }

        // è™•ç†å°å…¥æ•¸æ“š
        function processImportData(backupData, mode) {
            let importStats = {
                symptoms: { added: 0, updated: 0, skipped: 0 },
                symptomGroups: { added: 0, updated: 0, skipped: 0 },
                prescriptions: { added: 0, updated: 0, skipped: 0 }
            };
            
            if (mode === 'replace') {
                // å®Œå…¨æ›¿æ›
                symptoms = [...backupData.symptoms];
                symptomGroups = [...backupData.symptomGroups];
                prescriptions = [...backupData.prescriptions];
                
                importStats.symptoms.added = symptoms.length;
                importStats.symptomGroups.added = symptomGroups.length;
                importStats.prescriptions.added = prescriptions.length;
                
            } else if (mode === 'merge') {
                // åˆä½µæ•¸æ“š
                importStats = mergeData(backupData);
                
            } else if (mode === 'append') {
                // åƒ…æ·»åŠ æ–°æ•¸æ“š
                importStats = appendNewData(backupData);
            }
            
            // ä¿å­˜æ•¸æ“š
            saveAllData();
            
            // é‡æ–°æ¸²æŸ“ç•Œé¢
            renderAll();
            
            // å‰µå»ºç·Šæ€¥å‚™ä»½
            createEmergencyBackup('import');
            
            // é¡¯ç¤ºå°å…¥çµæœ
            showImportResults(importStats, backupData.metadata);
        }

        // åˆä½µæ•¸æ“š
        function mergeData(backupData) {
            let stats = {
                symptoms: { added: 0, updated: 0, skipped: 0 },
                symptomGroups: { added: 0, updated: 0, skipped: 0 },
                prescriptions: { added: 0, updated: 0, skipped: 0 }
            };
            
            // åˆä½µç—‡ç‹€
            backupData.symptoms.forEach(symptom => {
                if (!symptoms.includes(symptom)) {
                    symptoms.push(symptom);
                    stats.symptoms.added++;
                } else {
                    stats.symptoms.skipped++;
                }
            });
            
            // åˆä½µç—‡ç‹€åˆ†çµ„
            backupData.symptomGroups.forEach(newGroup => {
                const existingIndex = symptomGroups.findIndex(g => g.name === newGroup.name);
                if (existingIndex >= 0) {
                    // æ›´æ–°ç¾æœ‰åˆ†çµ„
                    symptomGroups[existingIndex] = { ...newGroup };
                    stats.symptomGroups.updated++;
                } else {
                    // æ·»åŠ æ–°åˆ†çµ„
                    symptomGroups.push({ ...newGroup });
                    stats.symptomGroups.added++;
                }
            });
            
            // åˆä½µè™•æ–¹
            backupData.prescriptions.forEach(newPrescription => {
                const existingIndex = prescriptions.findIndex(p => p.name === newPrescription.name);
                if (existingIndex >= 0) {
                    // æ›´æ–°ç¾æœ‰è™•æ–¹
                    prescriptions[existingIndex] = { ...newPrescription };
                    stats.prescriptions.updated++;
                } else {
                    // æ·»åŠ æ–°è™•æ–¹
                    prescriptions.push({ ...newPrescription });
                    stats.prescriptions.added++;
                }
            });
            
            return stats;
        }

        // åƒ…æ·»åŠ æ–°æ•¸æ“š
        function appendNewData(backupData) {
            let stats = {
                symptoms: { added: 0, updated: 0, skipped: 0 },
                symptomGroups: { added: 0, updated: 0, skipped: 0 },
                prescriptions: { added: 0, updated: 0, skipped: 0 }
            };
            
            // æ·»åŠ æ–°ç—‡ç‹€
            backupData.symptoms.forEach(symptom => {
                if (!symptoms.includes(symptom)) {
                    symptoms.push(symptom);
                    stats.symptoms.added++;
                } else {
                    stats.symptoms.skipped++;
                }
            });
            
            // æ·»åŠ æ–°ç—‡ç‹€åˆ†çµ„
            backupData.symptomGroups.forEach(newGroup => {
                const exists = symptomGroups.some(g => g.name === newGroup.name);
                if (!exists) {
                    symptomGroups.push({ ...newGroup });
                    stats.symptomGroups.added++;
                } else {
                    stats.symptomGroups.skipped++;
                }
            });
            
            // æ·»åŠ æ–°è™•æ–¹
            backupData.prescriptions.forEach(newPrescription => {
                const exists = prescriptions.some(p => p.name === newPrescription.name);
                if (!exists) {
                    prescriptions.push({ ...newPrescription });
                    stats.prescriptions.added++;
                } else {
                    stats.prescriptions.skipped++;
                }
            });
            
            return stats;
        }

        // é¡¯ç¤ºå°å…¥çµæœ
        function showImportResults(stats, metadata) {
            let message = 'âœ… æ•¸æ“šå°å…¥å®Œæˆï¼\n\n';
            
            message += `ğŸ“Š ç—‡ç‹€ï¼šæ–°å¢ ${stats.symptoms.added}ï¼Œæ›´æ–° ${stats.symptoms.updated}ï¼Œè·³é ${stats.symptoms.skipped}\n`;
            message += `ğŸ“‹ åˆ†çµ„ï¼šæ–°å¢ ${stats.symptomGroups.added}ï¼Œæ›´æ–° ${stats.symptomGroups.updated}ï¼Œè·³é ${stats.symptomGroups.skipped}\n`;
            message += `ğŸ’Š è™•æ–¹ï¼šæ–°å¢ ${stats.prescriptions.added}ï¼Œæ›´æ–° ${stats.prescriptions.updated}ï¼Œè·³é ${stats.prescriptions.skipped}\n`;
            
            if (metadata) {
                message += `\nğŸ“… å‚™ä»½æ™‚é–“ï¼š${new Date(metadata.timestamp).toLocaleString('zh-TW')}`;
                if (metadata.exportType) {
                    message += `\nğŸ“¦ å‚™ä»½é¡å‹ï¼š${metadata.exportType}`;
                }
            }
            
            showBackupResult(message, 'success', 8000);
            updateBackupStatus();
        }

        // è‡ªå‹•å‚™ä»½åŠŸèƒ½
        function toggleAutoBackup() {
            autoBackupEnabled = !autoBackupEnabled;
            localStorage.setItem('tcm_auto_backup_enabled', autoBackupEnabled.toString());
            
            if (autoBackupEnabled) {
                startAutoBackup();
                document.getElementById('autoBackupBtn').textContent = 'ğŸ”„ åœç”¨è‡ªå‹•å‚™ä»½';
                showBackupResult('âœ… è‡ªå‹•å‚™ä»½å·²å•Ÿç”¨ï¼Œæ¯5åˆ†é˜è‡ªå‹•å‚™ä»½ä¸€æ¬¡', 'success');
            } else {
                stopAutoBackup();
                document.getElementById('autoBackupBtn').textContent = 'ğŸ”„ å•Ÿç”¨è‡ªå‹•å‚™ä»½';
                showBackupResult('â¸ï¸ è‡ªå‹•å‚™ä»½å·²åœç”¨', 'info');
            }
            
            updateBackupStatus();
        }

        function startAutoBackup() {
            if (autoBackupTimer) {
                clearInterval(autoBackupTimer);
            }
            
            autoBackupTimer = setInterval(() => {
                try {
                    const backupData = generateBackupData(true);
                    saveToBackupHistory(backupData, 'auto');
                    console.log('è‡ªå‹•å‚™ä»½å®Œæˆï¼š', new Date().toLocaleString());
                } catch (error) {
                    console.error('è‡ªå‹•å‚™ä»½å¤±æ•—ï¼š', error);
                }
            }, BACKUP_CONFIG.autoBackupInterval);
        }

        function stopAutoBackup() {
            if (autoBackupTimer) {
                clearInterval(autoBackupTimer);
                autoBackupTimer = null;
            }
        }

        // ä¿å­˜åˆ°å‚™ä»½æ­·å²
        function saveToBackupHistory(backupData, type) {
            try {
                const historyKey = 'tcm_backup_history';
                let history = JSON.parse(localStorage.getItem(historyKey) || '[]');
                
                const backupEntry = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    type: type,
                    data: backupData,
                    size: JSON.stringify(backupData).length
                };
                
                history.unshift(backupEntry);
                
                // é™åˆ¶å‚™ä»½æ•¸é‡
                if (history.length > BACKUP_CONFIG.maxBackups) {
                    history = history.slice(0, BACKUP_CONFIG.maxBackups);
                }
                
                localStorage.setItem(historyKey, JSON.stringify(history));
                
            } catch (error) {
                console.error('ä¿å­˜å‚™ä»½æ­·å²å¤±æ•—ï¼š', error);
            }
        }

        // é¡¯ç¤ºå‚™ä»½æ­·å²
        function showBackupHistory() {
            try {
                const history = JSON.parse(localStorage.getItem('tcm_backup_history') || '[]');
                const historyList = document.getElementById('backupHistoryList');
                
                if (history.length === 0) {
                    historyList.innerHTML = '<div class="text-gray-500 text-center py-4">æš«ç„¡å‚™ä»½æ­·å²</div>';
                } else {
                    historyList.innerHTML = history.map((backup, index) => `
                        <div class="bg-gray-50 border rounded-lg p-3 flex items-center justify-between">
                            <div>
                                <div class="font-medium">${getBackupTypeLabel(backup.type)} #${history.length - index}</div>
                                <div class="text-sm text-gray-600">
                                    ${new Date(backup.timestamp).toLocaleString('zh-TW')} 
                                    (${formatFileSize(backup.size)})
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="restoreFromHistory(${backup.id})" 
                                        class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                                    æ¢å¾©
                                </button>
                                <button onclick="downloadFromHistory(${backup.id})" 
                                        class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">
                                    ä¸‹è¼‰
                                </button>
                                <button onclick="deleteFromHistory(${backup.id})" 
                                        class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                                    åˆªé™¤
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
                
                document.getElementById('backupHistoryModal').classList.remove('hidden');
                
            } catch (error) {
                showBackupResult('âŒ ç„¡æ³•è¼‰å…¥å‚™ä»½æ­·å²ï¼š' + error.message, 'error');
            }
        }

        // å¾æ­·å²æ¢å¾©
        function restoreFromHistory(backupId) {
            if (!confirm('ç¢ºå®šè¦æ¢å¾©æ­¤å‚™ä»½å—ï¼Ÿç•¶å‰æ•¸æ“šå°‡è¢«æ›¿æ›ï¼')) return;
            
            try {
                const history = JSON.parse(localStorage.getItem('tcm_backup_history') || '[]');
                const backup = history.find(b => b.id === backupId);
                
                if (!backup) {
                    throw new Error('å‚™ä»½ä¸å­˜åœ¨');
                }
                
                // å‰µå»ºç·Šæ€¥å‚™ä»½
                createEmergencyBackup('restore');
                
                // æ¢å¾©æ•¸æ“š
                symptoms = [...backup.data.symptoms];
                symptomGroups = [...backup.data.symptomGroups];
                prescriptions = [...backup.data.prescriptions];
                
                saveAllData();
                renderAll();
                
                closeBackupHistory();
                showBackupResult('âœ… æ•¸æ“šå·²å¾å‚™ä»½æ­·å²æ¢å¾©ï¼', 'success');
                
            } catch (error) {
                showBackupResult('âŒ æ¢å¾©å¤±æ•—ï¼š' + error.message, 'error');
            }
        }

        // å¾æ­·å²ä¸‹è¼‰
        function downloadFromHistory(backupId) {
            try {
                const history = JSON.parse(localStorage.getItem('tcm_backup_history') || '[]');
                const backup = history.find(b => b.id === backupId);
                
                if (!backup) {
                    throw new Error('å‚™ä»½ä¸å­˜åœ¨');
                }
                
                const timestamp = new Date(backup.timestamp).toISOString().replace(/[:.]/g, '-');
                const filename = `ä¸­é†«è™•æ–¹æ­·å²å‚™ä»½_${timestamp}.json`;
                
                downloadFile(JSON.stringify(backup.data, null, 2), filename, 'application/json');
                showBackupResult('âœ… æ­·å²å‚™ä»½å·²ä¸‹è¼‰ï¼', 'success');
                
            } catch (error) {
                showBackupResult('âŒ ä¸‹è¼‰å¤±æ•—ï¼š' + error.message, 'error');
            }
        }

        // å¾æ­·å²åˆªé™¤
        function deleteFromHistory(backupId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å‚™ä»½å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ï¼')) return;
            
            try {
                let history = JSON.parse(localStorage.getItem('tcm_backup_history') || '[]');
                history = history.filter(b => b.id !== backupId);
                
                localStorage.setItem('tcm_backup_history', JSON.stringify(history));
                showBackupHistory(); // é‡æ–°é¡¯ç¤ºåˆ—è¡¨
                showBackupResult('âœ… å‚™ä»½å·²åˆªé™¤ï¼', 'success');
                updateBackupStatus();
                
            } catch (error) {
                showBackupResult('âŒ åˆªé™¤å¤±æ•—ï¼š' + error.message, 'error');
            }
        }

        // æ¸…ç†å‚™ä»½
        function cleanupBackups() {
            if (!confirm('ç¢ºå®šè¦æ¸…ç†èˆŠå‚™ä»½å—ï¼Ÿå°‡åªä¿ç•™æœ€æ–°çš„10å€‹å‚™ä»½ã€‚')) return;
            
            try {
                let history = JSON.parse(localStorage.getItem('tcm_backup_history') || '[]');
                const originalCount = history.length;
                
                if (history.length > 10) {
                    history = history.slice(0, 10);
                    localStorage.setItem('tcm_backup_history', JSON.stringify(history));
                    
                    const deletedCount = originalCount - history.length;
                    showBackupResult(`âœ… å·²æ¸…ç† ${deletedCount} å€‹èˆŠå‚™ä»½ï¼Œä¿ç•™æœ€æ–°çš„ ${history.length} å€‹`, 'success');
                } else {
                    showBackupResult('â„¹ï¸ å‚™ä»½æ•¸é‡æœªè¶…éé™åˆ¶ï¼Œç„¡éœ€æ¸…ç†', 'info');
                }
                
                updateBackupStatus();
                
            } catch (error) {
                showBackupResult('âŒ æ¸…ç†å¤±æ•—ï¼š' + error.message, 'error');
            }
        }

        // ç·Šæ€¥å‚™ä»½
        function emergencyBackup() {
            try {
                const backupData = generateBackupData(true);
                backupData.metadata.exportType = 'emergency';
                
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                downloadFile(JSON.stringify(backupData, null, 2), `ç·Šæ€¥å‚™ä»½_${timestamp}.json`, 'application/json');
                
                // åŒæ™‚ä¿å­˜åˆ°æ­·å²
                saveToBackupHistory(backupData, 'emergency');
                
                showBackupResult('ğŸš¨ ç·Šæ€¥å‚™ä»½å·²å®Œæˆï¼æ–‡ä»¶å·²ä¸‹è¼‰ä¸¦ä¿å­˜åˆ°æ­·å²è¨˜éŒ„ã€‚', 'success');
                updateBackupStatus();
                
            } catch (error) {
                showBackupResult('âŒ ç·Šæ€¥å‚™ä»½å¤±æ•—ï¼š' + error.message, 'error');
            }
        }

        // å‰µå»ºç·Šæ€¥å‚™ä»½ï¼ˆå…§éƒ¨ä½¿ç”¨ï¼‰
        function createEmergencyBackup(reason) {
            try {
                const backupData = generateBackupData(true);
                backupData.metadata.exportType = 'emergency';
                backupData.metadata.reason = reason;
                
                saveToBackupHistory(backupData, 'emergency');
                console.log('ç·Šæ€¥å‚™ä»½å·²å‰µå»ºï¼š', reason);
                
            } catch (error) {
                console.error('å‰µå»ºç·Šæ€¥å‚™ä»½å¤±æ•—ï¼š', error);
            }
        }

        // é©—è­‰å‚™ä»½æ–‡ä»¶
        function validateBackupFile() {
            document.getElementById('importBackupFile').click();
            // é©—è­‰é‚è¼¯åœ¨ importBackupFile å‡½æ•¸ä¸­è™•ç†
        }

        // æ›´æ–°å‚™ä»½ç‹€æ…‹é¡¯ç¤º
        function updateBackupStatus() {
            try {
                const history = JSON.parse(localStorage.getItem('tcm_backup_history') || '[]');
                const dataSize = calculateDataSize();
                
                document.getElementById('totalBackups').textContent = history.length;
                document.getElementById('dataSize').textContent = formatFileSize(dataSize);
                document.getElementById('autoBackupStatus').textContent = autoBackupEnabled ? 'é–‹å•Ÿ' : 'é—œé–‰';
                
                if (history.length > 0) {
                    const lastBackup = new Date(history[0].timestamp);
                    document.getElementById('lastBackupTime').textContent = formatRelativeTime(lastBackup);
                } else {
                    document.getElementById('lastBackupTime').textContent = 'å¾æœª';
                }
                
            } catch (error) {
                console.error('æ›´æ–°å‚™ä»½ç‹€æ…‹å¤±æ•—ï¼š', error);
            }
        }

        // è¨ˆç®—æ•¸æ“šå¤§å°
        function calculateDataSize() {
            const data = generateBackupData(false);
            return JSON.stringify(data).length;
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + sizes[i];
        }

        // æ ¼å¼åŒ–ç›¸å°æ™‚é–“
        function formatRelativeTime(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) return `${days}å¤©å‰`;
            if (hours > 0) return `${hours}å°æ™‚å‰`;
            if (minutes > 0) return `${minutes}åˆ†é˜å‰`;
            return 'å‰›å‰›';
        }

        // ç²å–å‚™ä»½é¡å‹æ¨™ç±¤
        function getBackupTypeLabel(type) {
            const labels = {
                'full': 'ğŸ”„ å®Œæ•´å‚™ä»½',
                'auto': 'â° è‡ªå‹•å‚™ä»½',
                'emergency': 'ğŸš¨ ç·Šæ€¥å‚™ä»½',
                'manual': 'ğŸ‘¤ æ‰‹å‹•å‚™ä»½',
                'compressed': 'ğŸ—œï¸ å£“ç¸®å‚™ä»½'
            };
            return labels[type] || 'ğŸ“¦ å‚™ä»½';
        }

        // é¡¯ç¤ºå‚™ä»½çµæœ
        function showBackupResult(message, type = 'info', duration = 5000) {
            const resultDiv = document.getElementById('backupResult');
            resultDiv.classList.remove('hidden', 'bg-blue-50', 'bg-green-50', 'bg-red-50', 'bg-yellow-50');
            resultDiv.classList.remove('text-blue-600', 'text-green-600', 'text-red-600', 'text-yellow-600');
            
            switch (type) {
                case 'success':
                    resultDiv.classList.add('bg-green-50', 'text-green-600');
                    break;
                case 'error':
                    resultDiv.classList.add('bg-red-50', 'text-red-600');
                    break;
                case 'warning':
                    resultDiv.classList.add('bg-yellow-50', 'text-yellow-600');
                    break;
                default:
                    resultDiv.classList.add('bg-blue-50', 'text-blue-600');
            }
            
            resultDiv.innerHTML = message.replace(/\n/g, '<br>');
            
            if (duration > 0) {
                setTimeout(() => {
                    resultDiv.classList.add('hidden');
                }, duration);
            }
        }

        // æ¨¡æ…‹æ¡†æ§åˆ¶
        function showImportOptions() {
            document.getElementById('importOptionsModal').classList.remove('hidden');
        }

        function closeImportOptions() {
            document.getElementById('importOptionsModal').classList.add('hidden');
        }

        function confirmImportOptions() {
            closeImportOptions();
            document.getElementById('importBackupFile').click();
        }

        function getImportMode() {
            const selectedMode = document.querySelector('input[name="importMode"]:checked');
            return selectedMode ? selectedMode.value : 'replace';
        }

        function closeBackupHistory() {
            document.getElementById('backupHistoryModal').classList.add('hidden');
        }

        // ä¿å­˜æ‰€æœ‰æ•¸æ“š
        function saveAllData() {
            localStorage.setItem('tcm_symptoms', JSON.stringify(symptoms));
            localStorage.setItem('tcm_symptom_groups', JSON.stringify(symptomGroups));
            localStorage.setItem('tcm_prescriptions', JSON.stringify(prescriptions));
        }

        // é‡æ–°æ¸²æŸ“æ‰€æœ‰ç•Œé¢
        function renderAll() {
            renderSymptomGroups();
            renderSymptoms();
            renderPrescriptions();
            updateStats();
        }

        // æ¸…ç©ºæ‰€æœ‰æ•¸æ“š
        function clearAllData() {
            if (!confirm('âš ï¸ ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ•¸æ“šå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ï¼\n\nå»ºè­°å…ˆé€²è¡Œç·Šæ€¥å‚™ä»½ã€‚')) return;
            
            // å‰µå»ºç·Šæ€¥å‚™ä»½
            createEmergencyBackup('clear_all');
            
            localStorage.removeItem('tcm_symptoms');
            localStorage.removeItem('tcm_symptom_groups');
            localStorage.removeItem('tcm_prescriptions');
            
            symptoms = [];
            symptomGroups = [];
            prescriptions = [];
            
            renderAll();
            document.getElementById('searchResults').classList.add('hidden');
            document.getElementById('symptomSearch').value = '';
            
            showBackupResult('âœ… æ‰€æœ‰æ•¸æ“šå·²æ¸…ç©ºï¼ç·Šæ€¥å‚™ä»½å·²è‡ªå‹•å‰µå»ºã€‚', 'success');
            updateBackupStatus();
        }

        // é‡ç½®ç‚ºé»˜èªæ•¸æ“š
        function resetToDefaults() {
            if (!confirm('ç¢ºå®šè¦é‡ç½®ç‚ºé»˜èªæ•¸æ“šå—ï¼Ÿç•¶å‰æ•¸æ“šå°‡è¢«æ›¿æ›ï¼')) return;
            
            // å‰µå»ºç·Šæ€¥å‚™ä»½
            createEmergencyBackup('reset_defaults');
            
            // é‡ç½®ç‚ºåˆå§‹æ•¸æ“š
            symptoms = ['é ­ç—›', 'ç™¼ç†±', 'å’³å—½', 'è…¹ç—›', 'å¤±çœ ', 'ç–²å‹', 'é£Ÿæ…¾ä¸æŒ¯', 'å™å¿ƒ', 'åé ­ç—›', 'é ­æšˆ', 'é«˜ç†±', 'ä½ç†±', 'ä¹¾å’³', 'æ¿•å’³', 'èƒƒç—›', 'è…¹è„¹'];
            
            symptomGroups = [
                { name: 'é ­éƒ¨ç—‡ç‹€', symptoms: ['é ­ç—›', 'åé ­ç—›', 'é ­æšˆ'], color: 'red' },
                { name: 'ç™¼ç†±ç—‡ç‹€', symptoms: ['ç™¼ç†±', 'é«˜ç†±', 'ä½ç†±'], color: 'orange' },
                { name: 'å’³å—½ç—‡ç‹€', symptoms: ['å’³å—½', 'ä¹¾å’³', 'æ¿•å’³'], color: 'blue' },
                { name: 'è…¸èƒƒç—‡ç‹€', symptoms: ['è…¹ç—›', 'èƒƒç—›', 'è…¹è„¹', 'é£Ÿæ…¾ä¸æŒ¯', 'å™å¿ƒ'], color: 'green' }
            ];
            
            prescriptions = [
                { name: 'éŠ€ç¿¹æ•£', ingredients: 'é‡‘éŠ€èŠ± 15g\né€£ç¿¹ 15g\nè–„è· 6g\nç‰›è’¡å­ 9g\næ¡”æ¢— 6g\nç”˜è‰ 5g', symptoms: ['ç™¼ç†±', 'å’³å—½', 'é ­ç—›'] },
                { name: 'é€é™æ•£', ingredients: 'æŸ´èƒ¡ 6g\nç•¶æ­¸ 9g\nç™½èŠ 9g\nç™½æœ® 9g\nèŒ¯è‹“ 9g\nç”˜è‰ 3g', symptoms: ['è…¹ç—›', 'ç–²å‹', 'å¤±çœ '] },
                { name: 'å¹³èƒƒæ•£', ingredients: 'è’¼æœ® 12g\nåšæœ´ 9g\né™³çš® 6g\nç”˜è‰ 3g', symptoms: ['è…¹ç—›', 'é£Ÿæ…¾ä¸æŒ¯', 'å™å¿ƒ'] }
            ];
            
            saveAllData();
            renderAll();
            
            showBackupResult('âœ… å·²é‡ç½®ç‚ºé»˜èªæ•¸æ“šï¼åŸæ•¸æ“šçš„ç·Šæ€¥å‚™ä»½å·²å‰µå»ºã€‚', 'success');
            updateBackupStatus();
        }

        // ==================== åŸæœ‰åŠŸèƒ½ä¿æŒä¸è®Š ====================

        // æ›´æ–°çµ±è¨ˆ
        function updateStats() {
            document.getElementById('symptomCount').textContent = symptoms.length;
            document.getElementById('prescriptionCount').textContent = prescriptions.length;
        }

        // æ¸²æŸ“ç—‡ç‹€åˆ†çµ„
        function renderSymptomGroups() {
            const container = document.getElementById('symptomGroupsList');
            const colorMap = {
                red: 'bg-red-100 text-red-800 border-red-300',
                blue: 'bg-blue-100 text-blue-800 border-blue-300',
                green: 'bg-green-100 text-green-800 border-green-300',
                orange: 'bg-orange-100 text-orange-800 border-orange-300',
                purple: 'bg-purple-100 text-purple-800 border-purple-300',
                pink: 'bg-pink-100 text-pink-800 border-pink-300'
            };
            
            container.innerHTML = symptomGroups.map((group, index) => `
                <div class="border-2 rounded-lg p-4 ${colorMap[group.color] || 'bg-gray-100 text-gray-800 border-gray-300'}">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-bold text-lg">${group.name}</h4>
                        <button onclick="removeSymptomGroup(${index})" 
                                class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm">
                            âŒ åˆªé™¤
                        </button>
                    </div>
                    <div class="text-sm font-medium">
                        ${group.symptoms.join('ã€')}
                    </div>
                </div>
            `).join('');
            
            renderQuickSelectGroups();
        }

        // æ¸²æŸ“å¿«é€Ÿé¸æ“‡åˆ†çµ„æŒ‰éˆ•
        function renderQuickSelectGroups() {
            const container = document.getElementById('quickSelectGroups');
            const colorMap = {
                red: 'bg-red-200 hover:bg-red-300 text-red-900',
                blue: 'bg-blue-200 hover:bg-blue-300 text-blue-900',
                green: 'bg-green-200 hover:bg-green-300 text-green-900',
                orange: 'bg-orange-200 hover:bg-orange-300 text-orange-900',
                purple: 'bg-purple-200 hover:bg-purple-300 text-purple-900',
                pink: 'bg-pink-200 hover:bg-pink-300 text-pink-900'
            };
            
            container.innerHTML = symptomGroups.map(group => `
                <button onclick="selectSymptomGroup('${group.name}')" 
                        class="px-4 py-2 rounded-lg font-medium transition duration-200 ${colorMap[group.color] || 'bg-gray-200 hover:bg-gray-300 text-gray-900'}">
                    ${group.name}
                </button>
            `).join('');
        }

        // æ¸²æŸ“ç—‡ç‹€åˆ—è¡¨
        function renderSymptoms() {
            const container = document.getElementById('symptomsList');
            container.innerHTML = symptoms.map((symptom, index) => `
                <div class="flex items-center justify-between bg-gray-100 px-4 py-3 rounded-lg">
                    <span class="text-gray-800 font-medium">${symptom}</span>
                    <button onclick="removeSymptom(${index})" 
                            class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm">
                        âŒ
                    </button>
                </div>
            `).join('');
        }

        // æ¸²æŸ“è™•æ–¹åˆ—è¡¨
        function renderPrescriptions() {
            const container = document.getElementById('prescriptionsList');
            container.innerHTML = prescriptions.map((prescription, index) => `
                <div class="bg-purple-50 border border-purple-200 p-4 rounded-lg">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="font-bold text-lg text-gray-800">${prescription.name}</h4>
                        <button onclick="removePrescription(${index})" 
                                class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm">
                            âŒ åˆªé™¤
                        </button>
                    </div>
                    <div class="mb-3">
                        <div class="font-medium text-gray-700 mb-1">ğŸ’Š è—¥æï¼š</div>
                        <div class="text-gray-600 bg-white p-2 rounded border text-sm">
                            ${prescription.ingredients.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                    <div>
                        <div class="font-medium text-gray-700 mb-1">ğŸ¯ é©ç”¨ç—‡ç‹€ï¼š</div>
                        <div class="text-gray-600">${prescription.symptoms.join('ã€')}</div>
                    </div>
                </div>
            `).join('');
        }

        // æ·»åŠ ç—‡ç‹€åˆ†çµ„
        function addSymptomGroup() {
            const name = document.getElementById('newGroupName').value.trim();
            const symptomsInput = document.getElementById('newGroupSymptoms').value.trim();
            const color = document.getElementById('groupColor').value;
            
            if (name && symptomsInput) {
                const groupSymptoms = symptomsInput.split(',').map(s => s.trim()).filter(s => s);
                
                groupSymptoms.forEach(symptom => {
                    if (!symptoms.includes(symptom)) {
                        symptoms.push(symptom);
                    }
                });
                
                symptomGroups.push({
                    name: name,
                    symptoms: groupSymptoms,
                    color: color
                });
                
                saveAllData();
                
                document.getElementById('newGroupName').value = '';
                document.getElementById('newGroupSymptoms').value = '';
                
                renderSymptomGroups();
                renderSymptoms();
                updateStats();
            }
        }

        // åˆªé™¤ç—‡ç‹€åˆ†çµ„
        function removeSymptomGroup(index) {
            symptomGroups.splice(index, 1);
            saveAllData();
            renderSymptomGroups();
        }

        // é¸æ“‡ç—‡ç‹€åˆ†çµ„
        function selectSymptomGroup(groupName) {
            const searchInput = document.getElementById('symptomSearch');
            const currentValue = searchInput.value.trim();
            
            if (currentValue) {
                searchInput.value = currentValue + ',' + groupName;
            } else {
                searchInput.value = groupName;
            }
        }

        // æ·»åŠ ç—‡ç‹€
        function addSymptom() {
            const input = document.getElementById('newSymptom');
            const symptom = input.value.trim();
            
            if (symptom && !symptoms.includes(symptom)) {
                symptoms.push(symptom);
                saveAllData();
                input.value = '';
                renderSymptoms();
                updateStats();
            }
        }

        // åˆªé™¤ç—‡ç‹€
        function removeSymptom(index) {
            symptoms.splice(index, 1);
            saveAllData();
            renderSymptoms();
            updateStats();
        }

        // æ·»åŠ è™•æ–¹
        function addPrescription() {
            const name = document.getElementById('prescriptionName').value.trim();
            const ingredients = document.getElementById('prescriptionIngredients').value.trim();
            const symptomsInput = document.getElementById('prescriptionSymptoms').value.trim();
            
            if (name && ingredients && symptomsInput) {
                const prescriptionSymptoms = symptomsInput.split(',').map(s => s.trim()).filter(s => s);
                
                prescriptions.push({
                    name: name,
                    ingredients: ingredients,
                    symptoms: prescriptionSymptoms
                });
                
                saveAllData();
                
                document.getElementById('prescriptionName').value = '';
                document.getElementById('prescriptionIngredients').value = '';
                document.getElementById('prescriptionSymptoms').value = '';
                
                renderPrescriptions();
                updateStats();
            }
        }

        // åˆªé™¤è™•æ–¹
        function removePrescription(index) {
            prescriptions.splice(index, 1);
            saveAllData();
            renderPrescriptions();
            updateStats();
        }

        // æœç´¢è™•æ–¹
        function searchPrescriptions() {
            const searchInput = document.getElementById('symptomSearch').value.trim();
            if (!searchInput) return;
            
            const searchTerms = searchInput.split(',').map(s => s.trim()).filter(s => s);
            let allSearchSymptoms = [];
            
            searchTerms.forEach(term => {
                const termLower = term.toLowerCase();
                
                const matchingGroup = symptomGroups.find(group => 
                    group.name.toLowerCase() === termLower
                );
                
                if (matchingGroup) {
                    allSearchSymptoms.push(...matchingGroup.symptoms.map(s => s.toLowerCase()));
                } else {
                    allSearchSymptoms.push(termLower);
                }
            });
            
            allSearchSymptoms = [...new Set(allSearchSymptoms)];
            
            const results = [];
            
            prescriptions.forEach(prescription => {
                const matchCount = prescription.symptoms.filter(symptom => 
                    allSearchSymptoms.some(searchSymptom => 
                        symptom.toLowerCase().includes(searchSymptom)
                    )
                ).length;
                
                if (matchCount > 0) {
                    results.push({
                        ...prescription,
                        matchCount: matchCount,
                        matchPercentage: (matchCount / allSearchSymptoms.length * 100).toFixed(0)
                    });
                }
            });
            
            results.sort((a, b) => b.matchCount - a.matchCount);
            
            const resultsContainer = document.getElementById('searchResults');
            const resultsList = document.getElementById('resultsList');
            
            if (results.length > 0) {
                resultsList.innerHTML = results.map(result => `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-xl font-bold text-gray-800">${result.name}</h4>
                            <span class="bg-green-500 text-white text-sm px-3 py-1 rounded-full">
                                ${result.matchPercentage}% åŒ¹é…
                            </span>
                        </div>
                        <div class="mb-3">
                            <div class="text-gray-700 font-medium mb-1">ğŸ’Š è—¥æçµ„æˆï¼š</div>
                            <div class="text-gray-600 bg-white p-3 rounded border">
                                ${result.ingredients.replace(/\n/g, '<br>')}
                            </div>
                        </div>
                        <div>
                            <div class="text-gray-700 font-medium mb-1">ğŸ¯ é©ç”¨ç—‡ç‹€ï¼š</div>
                            <div class="text-gray-600">${result.symptoms.join('ã€')}</div>
                        </div>
                    </div>
                `).join('');
                resultsContainer.classList.remove('hidden');
            } else {
                resultsList.innerHTML = '<div class="text-gray-500 text-center py-8 text-lg">ğŸ˜” æœªæ‰¾åˆ°ç›¸é—œè™•æ–¹</div>';
                resultsContainer.classList.remove('hidden');
            }
        }

        // æ¨™ç±¤é åˆ‡æ›
        function showTab(tabName) {
            document.getElementById('groupsContent').classList.add('hidden');
            document.getElementById('symptomsContent').classList.add('hidden');
            document.getElementById('prescriptionsContent').classList.add('hidden');
            
            document.getElementById('groupsTab').className = 'flex-1 py-3 px-4 text-center font-medium text-gray-500 hover:text-gray-700';
            document.getElementById('symptomsTab').className = 'flex-1 py-3 px-4 text-center font-medium text-gray-500 hover:text-gray-700';
            document.getElementById('prescriptionsTab').className = 'flex-1 py-3 px-4 text-center font-medium text-gray-500 hover:text-gray-700';
            
            document.getElementById(tabName + 'Content').classList.remove('hidden');
            document.getElementById(tabName + 'Tab').className = 'flex-1 py-3 px-4 text-center font-medium border-b-2 border-green-500 text-green-600';
        }

        // æ‰¹é‡å°å…¥åŠŸèƒ½
        function downloadTemplate() {
            const template = `ç•¶æ­¸ï¼šè¡€è™›,æœˆç¶“ä¸èª¿,ä¾¿ç§˜
é»ƒèŠªï¼šæ°£è™›,ç–²å‹,è‡ªæ±—
ç”˜è‰ï¼šå’³å—½,èƒƒç—›,è§£æ¯’
äººåƒï¼šæ°£è™›,å¿ƒæ‚¸,å¤±çœ 
ç™½æœ®ï¼šè„¾è™›,è…¹è„¹,æ³„ç€‰
èŒ¯è‹“ï¼šæ°´è…«,å¤±çœ ,å¿ƒæ‚¸
å·èŠï¼šé ­ç—›,æœˆç¶“ä¸èª¿,èƒ¸ç—›
ç™½èŠï¼šè…¹ç—›,æœˆç¶“ä¸èª¿,è‚é¬±
ç†Ÿåœ°é»ƒï¼šè¡€è™›,è…è™›,é ­æšˆ
ä½•é¦–çƒï¼šè¡€è™›,è„«é«®,ä¾¿ç§˜`;
            
            downloadFile(template, 'ä¸­è—¥ç—‡ç‹€å°å…¥æ¨¡æ¿.txt', 'text/plain');
            showBackupResult('âœ… æ¨¡æ¿æ–‡ä»¶å·²ä¸‹è¼‰ï¼', 'success');
        }
        
        function loadBulkImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('bulkImportText').value = e.target.result;
                updateCharCount();
                showBackupResult('âœ… æ–‡ä»¶å…§å®¹å·²è¼‰å…¥ï¼', 'success');
            };
            reader.readAsText(file, 'UTF-8');
            event.target.value = '';
        }
        
        function clearBulkImport() {
            document.getElementById('bulkImportText').value = '';
            updateCharCount();
        }
        
        function updateCharCount() {
            const textarea = document.getElementById('bulkImportText');
            const charCountDiv = document.getElementById('charCount');
            const currentLength = textarea.value.length;
            const maxLength = 100000;
            
            charCountDiv.textContent = `å­—æ•¸ï¼š${currentLength.toLocaleString()} / ${maxLength.toLocaleString()}`;
            
            if (currentLength > maxLength * 0.9) {
                charCountDiv.className = 'text-sm text-red-500 font-medium';
            } else if (currentLength > maxLength * 0.7) {
                charCountDiv.className = 'text-sm text-yellow-600 font-medium';
            } else {
                charCountDiv.className = 'text-sm text-gray-500';
            }
        }
        
        function processBulkImport() {
            const text = document.getElementById('bulkImportText').value.trim();
            if (!text) {
                showBackupResult('âš ï¸ è«‹å…ˆè¼¸å…¥è¦å°å…¥çš„å…§å®¹ï¼', 'warning');
                return;
            }
            
            if (text.length > 100000) {
                showBackupResult('âŒ æ•¸æ“šéå¤§ï¼è«‹åˆ†æ‰¹å°å…¥', 'error');
                return;
            }
            
            // å‰µå»ºå°å…¥å‰å‚™ä»½
            createEmergencyBackup('bulk_import');
            
            showBackupResult('âš¡ æ­£åœ¨è™•ç†æ•¸æ“š...', 'info');
            
            setTimeout(() => {
                const lines = text.split('\n').filter(line => line.trim());
                let successCount = 0;
                let errorCount = 0;
                
                lines.forEach((line, index) => {
                    const trimmedLine = line.trim();
                    if (!trimmedLine) return;
                    
                    const separators = ['ï¼š', ':'];
                    let parts = null;
                    
                    for (let sep of separators) {
                        if (trimmedLine.includes(sep)) {
                            parts = trimmedLine.split(sep);
                            break;
                        }
                    }
                    
                    if (!parts || parts.length !== 2) {
                        errorCount++;
                        return;
                    }
                    
                    const herbName = parts[0].trim();
                    const symptomsText = parts[1].trim();
                    
                    if (!herbName || !symptomsText) {
                        errorCount++;
                        return;
                    }
                    
                    const symptomSeparators = [',', 'ï¼Œ', ';', 'ï¼›', 'ã€'];
                    let herbSymptoms = [symptomsText];
                    
                    for (let sep of symptomSeparators) {
                        if (symptomsText.includes(sep)) {
                            herbSymptoms = symptomsText.split(sep).map(s => s.trim()).filter(s => s);
                            break;
                        }
                    }
                    
                    herbSymptoms.forEach(symptom => {
                        if (symptom && !symptoms.includes(symptom)) {
                            symptoms.push(symptom);
                        }
                    });
                    
                    const existingIndex = prescriptions.findIndex(p => p.name === herbName);
                    
                    if (existingIndex >= 0) {
                        const existingSymptoms = prescriptions[existingIndex].symptoms;
                        const combinedSymptoms = [...new Set([...existingSymptoms, ...herbSymptoms])];
                        prescriptions[existingIndex].symptoms = combinedSymptoms;
                    } else {
                        const newPrescription = {
                            name: herbName,
                            ingredients: `${herbName} é©é‡\nï¼ˆè«‹è«®è©¢ä¸­é†«å¸«ç¢ºå®šå…·é«”ç”¨é‡ï¼‰`,
                            symptoms: herbSymptoms
                        };
                        prescriptions.push(newPrescription);
                    }
                    
                    successCount++;
                });
                
                saveAllData();
                renderAll();
                
                let resultMessage = `ğŸ“Š å°å…¥å®Œæˆï¼\nâœ… æˆåŠŸï¼š${successCount} æ¢`;
                if (errorCount > 0) {
                    resultMessage += `\nâŒ éŒ¯èª¤ï¼š${errorCount} æ¢`;
                }
                
                showBackupResult(resultMessage, successCount > 0 ? 'success' : 'error', 8000);
                
                if (successCount > 0) {
                    document.getElementById('bulkImportText').value = '';
                    updateCharCount();
                }
                
            }, 100);
        }

        // äº‹ä»¶ç›£è½
        document.getElementById('symptomSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchPrescriptions();
            }
        });

        document.getElementById('newSymptom').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addSymptom();
            }
        });

        document.getElementById('bulkImportText').addEventListener('input', updateCharCount);
        document.getElementById('bulkImportText').addEventListener('paste', function() {
            setTimeout(updateCharCount, 10);
        });

        // åˆå§‹åŒ–æ‡‰ç”¨
        function initApp() {
            renderAll();
            updateBackupStatus();
            
            // å•Ÿå‹•è‡ªå‹•å‚™ä»½ï¼ˆå¦‚æœå·²å•Ÿç”¨ï¼‰
            if (autoBackupEnabled) {
                startAutoBackup();
                document.getElementById('autoBackupBtn').textContent = 'ğŸ”„ åœç”¨è‡ªå‹•å‚™ä»½';
            }
        }

        // é é¢å¸è¼‰æ™‚åœæ­¢è‡ªå‹•å‚™ä»½
        window.addEventListener('beforeunload', function() {
            stopAutoBackup();
        });

        // å•Ÿå‹•æ‡‰ç”¨
        initApp();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'964b4d9281f103e9',t:'MTc1MzQ0Mjc5My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
