<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中醫處方推薦工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-5xl">
        <!-- 標題 -->
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">🌿 中醫處方工具</h1>
        </div>

        <!-- 數據備份區 -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-4">
            <div class="grid md:grid-cols-2 gap-4">
                <!-- 本地備份 -->
                <div class="space-y-2">
                    <h3 class="text-sm font-bold text-gray-700 mb-2">📱 本地備份</h3>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="exportData()" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg font-medium text-sm">
                            💾 下載備份
                        </button>
                        <button onclick="document.getElementById('importFile').click()" 
                                class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg font-medium text-sm">
                            📂 恢復數據
                        </button>
                        <button onclick="clearAllData()" 
                                class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg font-medium text-sm">
                            🗑️ 清空數據
                        </button>
                    </div>
                </div>
                
                <!-- 雲端同步 -->
                <div class="space-y-2">
                    <h3 class="text-sm font-bold text-gray-700 mb-2">☁️ 雲端同步</h3>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="saveToCloud()" 
                                class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded-lg font-medium text-sm">
                            ☁️ 保存到雲端
                        </button>
                        <button onclick="loadFromCloud()" 
                                class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-2 rounded-lg font-medium text-sm">
                            📥 從雲端載入
                        </button>
                        <button onclick="showCloudStatus()" 
                                class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-lg font-medium text-sm">
                            📊 同步狀態
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 批量導入區 -->
            <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border border-yellow-200 rounded-lg p-4 mt-4">
                <h3 class="text-sm font-bold text-gray-700 mb-3">📋 批量導入中藥症狀</h3>
                <div class="space-y-3">
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">📝 文本導入</label>
                            <textarea id="bulkImportText" 
                                      placeholder="格式：中藥名：症狀1,症狀2,症狀3&#10;例如：&#10;當歸：血虛,月經不調,便秘&#10;黃芪：氣虛,疲勞,自汗&#10;甘草：咳嗽,胃痛,解毒&#10;&#10;💡 支持大量數據導入（建議單次不超過10萬字）"
                                      rows="6" 
                                      maxlength="100000"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm resize-y"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">📁 文件導入</label>
                            <div class="space-y-2">
                                <button onclick="document.getElementById('bulkImportFile').click()" 
                                        class="w-full bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded-lg font-medium text-sm">
                                    📁 選擇文件導入
                                </button>
                                <button onclick="downloadTemplate()" 
                                        class="w-full bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg font-medium text-sm">
                                    📄 下載模板文件
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="flex gap-2">
                            <button onclick="processBulkImport()" 
                                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium text-sm">
                                ⚡ 開始導入
                            </button>
                            <button onclick="clearBulkImport()" 
                                    class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium text-sm">
                                🧹 清空輸入
                            </button>
                        </div>
                        <div id="charCount" class="text-sm text-gray-500">
                            字數：0 / 100,000
                        </div>
                    </div>
                </div>
                <input type="file" id="bulkImportFile" accept=".txt,.csv" style="display: none;" onchange="loadBulkImportFile(event)">
            </div>
            
            <!-- 狀態顯示 -->
            <div id="backupStatus" class="mt-3 p-3 bg-gray-50 rounded-lg text-sm text-gray-600 hidden"></div>
            
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
        </div>

        <!-- 主搜索區 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="space-y-4">
                <input type="text" id="symptomSearch" placeholder="輸入症狀搜索處方，例如：頭痛,發熱" 
                       class="w-full px-4 py-3 text-lg border-2 border-gray-200 rounded-lg focus:border-green-500 focus:outline-none">
                
                <!-- 快速選擇按鈕 -->
                <div class="flex flex-wrap gap-2" id="quickSelectGroups"></div>
                
                <button onclick="searchPrescriptions()" 
                        class="w-full bg-green-500 hover:bg-green-600 text-white text-lg font-medium py-3 rounded-lg">
                    🔍 搜索處方
                </button>
            </div>

            <!-- 搜索結果 -->
            <div id="searchResults" class="mt-6 hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4">推薦處方</h3>
                <div id="resultsList" class="space-y-4"></div>
            </div>
        </div>

        <!-- 標籤頁導航 -->
        <div class="bg-white rounded-lg shadow-md mb-6">
            <div class="flex border-b">
                <button onclick="showTab('groups')" id="groupsTab" 
                        class="flex-1 py-3 px-4 text-center font-medium border-b-2 border-green-500 text-green-600">
                    症狀分組
                </button>
                <button onclick="showTab('symptoms')" id="symptomsTab" 
                        class="flex-1 py-3 px-4 text-center font-medium text-gray-500 hover:text-gray-700">
                    症狀管理
                </button>
                <button onclick="showTab('prescriptions')" id="prescriptionsTab" 
                        class="flex-1 py-3 px-4 text-center font-medium text-gray-500 hover:text-gray-700">
                    處方管理
                </button>
            </div>

            <!-- 症狀分組標籤頁 -->
            <div id="groupsContent" class="p-6">
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- 創建分組 -->
                    <div>
                        <h3 class="text-lg font-bold mb-4">創建新分組</h3>
                        <div class="space-y-3">
                            <input type="text" id="newGroupName" placeholder="分組名稱" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <input type="text" id="newGroupSymptoms" placeholder="症狀（用逗號分隔）" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <select id="groupColor" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="red">🔴 紅色</option>
                                <option value="blue">🔵 藍色</option>
                                <option value="green">🟢 綠色</option>
                                <option value="orange">🟠 橙色</option>
                                <option value="purple">🟣 紫色</option>
                                <option value="pink">🩷 粉色</option>
                            </select>
                            <button onclick="addSymptomGroup()" 
                                    class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg">
                                ➕ 創建分組
                            </button>
                        </div>
                    </div>
                    
                    <!-- 現有分組 -->
                    <div>
                        <h3 class="text-lg font-bold mb-4">現有分組</h3>
                        <div id="symptomGroupsList" class="space-y-3 max-h-80 overflow-y-auto"></div>
                    </div>
                </div>
            </div>

            <!-- 症狀管理標籤頁 -->
            <div id="symptomsContent" class="p-6 hidden">
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-bold mb-4">添加症狀</h3>
                        <div class="flex gap-2">
                            <input type="text" id="newSymptom" placeholder="輸入新症狀" 
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg">
                            <button onclick="addSymptom()" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                                ➕ 添加
                            </button>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold mb-4">所有症狀 (<span id="symptomCount">0</span>)</h3>
                        <div id="symptomsList" class="max-h-80 overflow-y-auto space-y-2"></div>
                    </div>
                </div>
            </div>

            <!-- 處方管理標籤頁 -->
            <div id="prescriptionsContent" class="p-6 hidden">
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-bold mb-4">添加處方</h3>
                        <div class="space-y-3">
                            <input type="text" id="prescriptionName" placeholder="處方名稱" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <textarea id="prescriptionIngredients" placeholder="藥材組成（每行一味藥）" rows="4"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
                            <input type="text" id="prescriptionSymptoms" placeholder="適用症狀（用逗號分隔）" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <button onclick="addPrescription()" 
                                    class="w-full bg-purple-500 hover:bg-purple-600 text-white py-2 rounded-lg">
                                ➕ 添加處方
                            </button>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold mb-4">現有處方 (<span id="prescriptionCount">0</span>)</h3>
                        <div id="prescriptionsList" class="max-h-80 overflow-y-auto space-y-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 數據存儲
        let symptoms = JSON.parse(localStorage.getItem('tcm_symptoms') || '[]');
        let symptomGroups = JSON.parse(localStorage.getItem('tcm_symptom_groups') || '[]');
        let prescriptions = JSON.parse(localStorage.getItem('tcm_prescriptions') || '[]');

        // 初始化示例數據
        if (symptoms.length === 0) {
            symptoms = ['頭痛', '發熱', '咳嗽', '腹痛', '失眠', '疲勞', '食慾不振', '噁心', '偏頭痛', '頭暈', '高熱', '低熱', '乾咳', '濕咳', '胃痛', '腹脹'];
            localStorage.setItem('tcm_symptoms', JSON.stringify(symptoms));
        }

        if (symptomGroups.length === 0) {
            symptomGroups = [
                {
                    name: '頭部症狀',
                    symptoms: ['頭痛', '偏頭痛', '頭暈'],
                    color: 'red'
                },
                {
                    name: '發熱症狀',
                    symptoms: ['發熱', '高熱', '低熱'],
                    color: 'orange'
                },
                {
                    name: '咳嗽症狀',
                    symptoms: ['咳嗽', '乾咳', '濕咳'],
                    color: 'blue'
                },
                {
                    name: '腸胃症狀',
                    symptoms: ['腹痛', '胃痛', '腹脹', '食慾不振', '噁心'],
                    color: 'green'
                }
            ];
            localStorage.setItem('tcm_symptom_groups', JSON.stringify(symptomGroups));
        }

        if (prescriptions.length === 0) {
            prescriptions = [
                {
                    name: '銀翹散',
                    ingredients: '金銀花 15g\n連翹 15g\n薄荷 6g\n牛蒡子 9g\n桔梗 6g\n甘草 5g',
                    symptoms: ['發熱', '咳嗽', '頭痛']
                },
                {
                    name: '逍遙散',
                    ingredients: '柴胡 6g\n當歸 9g\n白芍 9g\n白朮 9g\n茯苓 9g\n甘草 3g',
                    symptoms: ['腹痛', '疲勞', '失眠']
                },
                {
                    name: '平胃散',
                    ingredients: '蒼朮 12g\n厚朴 9g\n陳皮 6g\n甘草 3g',
                    symptoms: ['腹痛', '食慾不振', '噁心']
                }
            ];
            localStorage.setItem('tcm_prescriptions', JSON.stringify(prescriptions));
        }

        // 更新統計
        function updateStats() {
            document.getElementById('symptomCount').textContent = symptoms.length;
            document.getElementById('prescriptionCount').textContent = prescriptions.length;
        }

        // 渲染症狀分組
        function renderSymptomGroups() {
            const container = document.getElementById('symptomGroupsList');
            const colorMap = {
                red: 'bg-red-100 text-red-800 border-red-300',
                blue: 'bg-blue-100 text-blue-800 border-blue-300',
                green: 'bg-green-100 text-green-800 border-green-300',
                orange: 'bg-orange-100 text-orange-800 border-orange-300',
                purple: 'bg-purple-100 text-purple-800 border-purple-300',
                pink: 'bg-pink-100 text-pink-800 border-pink-300'
            };
            
            container.innerHTML = symptomGroups.map((group, index) => `
                <div class="border-2 rounded-lg p-4 ${colorMap[group.color] || 'bg-gray-100 text-gray-800 border-gray-300'}">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-bold text-lg">${group.name}</h4>
                        <button onclick="removeSymptomGroup(${index})" 
                                class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm">
                            ❌ 刪除
                        </button>
                    </div>
                    <div class="text-sm font-medium">
                        ${group.symptoms.join('、')}
                    </div>
                </div>
            `).join('');
            
            // 更新快速選擇按鈕
            renderQuickSelectGroups();
        }

        // 渲染快速選擇分組按鈕
        function renderQuickSelectGroups() {
            const container = document.getElementById('quickSelectGroups');
            const colorMap = {
                red: 'bg-red-200 hover:bg-red-300 text-red-900',
                blue: 'bg-blue-200 hover:bg-blue-300 text-blue-900',
                green: 'bg-green-200 hover:bg-green-300 text-green-900',
                orange: 'bg-orange-200 hover:bg-orange-300 text-orange-900',
                purple: 'bg-purple-200 hover:bg-purple-300 text-purple-900',
                pink: 'bg-pink-200 hover:bg-pink-300 text-pink-900'
            };
            
            container.innerHTML = symptomGroups.map(group => `
                <button onclick="selectSymptomGroup('${group.name}')" 
                        class="px-4 py-2 rounded-lg font-medium transition duration-200 ${colorMap[group.color] || 'bg-gray-200 hover:bg-gray-300 text-gray-900'}">
                    ${group.name}
                </button>
            `).join('');
        }

        // 渲染症狀列表
        function renderSymptoms() {
            const container = document.getElementById('symptomsList');
            container.innerHTML = symptoms.map((symptom, index) => `
                <div class="flex items-center justify-between bg-gray-100 px-4 py-3 rounded-lg">
                    <span class="text-gray-800 font-medium">${symptom}</span>
                    <button onclick="removeSymptom(${index})" 
                            class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm">
                        ❌
                    </button>
                </div>
            `).join('');
        }

        // 渲染處方列表
        function renderPrescriptions() {
            const container = document.getElementById('prescriptionsList');
            container.innerHTML = prescriptions.map((prescription, index) => `
                <div class="bg-purple-50 border border-purple-200 p-4 rounded-lg">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="font-bold text-lg text-gray-800">${prescription.name}</h4>
                        <button onclick="removePrescription(${index})" 
                                class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm">
                            ❌ 刪除
                        </button>
                    </div>
                    <div class="mb-3">
                        <div class="font-medium text-gray-700 mb-1">💊 藥材：</div>
                        <div class="text-gray-600 bg-white p-2 rounded border text-sm">
                            ${prescription.ingredients.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                    <div>
                        <div class="font-medium text-gray-700 mb-1">🎯 適用症狀：</div>
                        <div class="text-gray-600">${prescription.symptoms.join('、')}</div>
                    </div>
                </div>
            `).join('');
        }

        // 添加症狀分組
        function addSymptomGroup() {
            const name = document.getElementById('newGroupName').value.trim();
            const symptomsInput = document.getElementById('newGroupSymptoms').value.trim();
            const color = document.getElementById('groupColor').value;
            
            if (name && symptomsInput) {
                const groupSymptoms = symptomsInput.split(',').map(s => s.trim()).filter(s => s);
                
                // 將分組中的症狀添加到總症狀列表中
                groupSymptoms.forEach(symptom => {
                    if (!symptoms.includes(symptom)) {
                        symptoms.push(symptom);
                    }
                });
                
                symptomGroups.push({
                    name: name,
                    symptoms: groupSymptoms,
                    color: color
                });
                
                localStorage.setItem('tcm_symptoms', JSON.stringify(symptoms));
                localStorage.setItem('tcm_symptom_groups', JSON.stringify(symptomGroups));
                
                // 清空輸入框
                document.getElementById('newGroupName').value = '';
                document.getElementById('newGroupSymptoms').value = '';
                
                renderSymptomGroups();
                renderSymptoms();
                updateStats();
                enhancedAutoBackup();
            }
        }

        // 刪除症狀分組
        function removeSymptomGroup(index) {
            symptomGroups.splice(index, 1);
            localStorage.setItem('tcm_symptom_groups', JSON.stringify(symptomGroups));
            renderSymptomGroups();
            autoBackup();
        }

        // 選擇症狀分組（快速添加到搜索框）
        function selectSymptomGroup(groupName) {
            const searchInput = document.getElementById('symptomSearch');
            const currentValue = searchInput.value.trim();
            
            if (currentValue) {
                searchInput.value = currentValue + ',' + groupName;
            } else {
                searchInput.value = groupName;
            }
        }

        // 添加症狀
        function addSymptom() {
            const input = document.getElementById('newSymptom');
            const symptom = input.value.trim();
            
            if (symptom && !symptoms.includes(symptom)) {
                symptoms.push(symptom);
                localStorage.setItem('tcm_symptoms', JSON.stringify(symptoms));
                input.value = '';
                renderSymptoms();
                updateStats();
                enhancedAutoBackup();
            }
        }

        // 刪除症狀
        function removeSymptom(index) {
            symptoms.splice(index, 1);
            localStorage.setItem('tcm_symptoms', JSON.stringify(symptoms));
            renderSymptoms();
            updateStats();
            autoBackup();
        }

        // 添加處方
        function addPrescription() {
            const name = document.getElementById('prescriptionName').value.trim();
            const ingredients = document.getElementById('prescriptionIngredients').value.trim();
            const symptomsInput = document.getElementById('prescriptionSymptoms').value.trim();
            
            if (name && ingredients && symptomsInput) {
                const prescriptionSymptoms = symptomsInput.split(',').map(s => s.trim()).filter(s => s);
                
                prescriptions.push({
                    name: name,
                    ingredients: ingredients,
                    symptoms: prescriptionSymptoms
                });
                
                localStorage.setItem('tcm_prescriptions', JSON.stringify(prescriptions));
                
                // 清空輸入框
                document.getElementById('prescriptionName').value = '';
                document.getElementById('prescriptionIngredients').value = '';
                document.getElementById('prescriptionSymptoms').value = '';
                
                renderPrescriptions();
                updateStats();
                enhancedAutoBackup();
            }
        }

        // 刪除處方
        function removePrescription(index) {
            prescriptions.splice(index, 1);
            localStorage.setItem('tcm_prescriptions', JSON.stringify(prescriptions));
            renderPrescriptions();
            updateStats();
            autoBackup();
        }

        // 搜索處方
        function searchPrescriptions() {
            const searchInput = document.getElementById('symptomSearch').value.trim();
            if (!searchInput) return;
            
            const searchTerms = searchInput.split(',').map(s => s.trim()).filter(s => s);
            let allSearchSymptoms = [];
            
            // 處理搜索詞，包括症狀分組
            searchTerms.forEach(term => {
                const termLower = term.toLowerCase();
                
                // 檢查是否為症狀分組
                const matchingGroup = symptomGroups.find(group => 
                    group.name.toLowerCase() === termLower
                );
                
                if (matchingGroup) {
                    // 如果是分組，添加分組中的所有症狀
                    allSearchSymptoms.push(...matchingGroup.symptoms.map(s => s.toLowerCase()));
                } else {
                    // 如果不是分組，直接添加症狀
                    allSearchSymptoms.push(termLower);
                }
            });
            
            // 去重
            allSearchSymptoms = [...new Set(allSearchSymptoms)];
            
            const results = [];
            
            prescriptions.forEach(prescription => {
                const matchCount = prescription.symptoms.filter(symptom => 
                    allSearchSymptoms.some(searchSymptom => 
                        symptom.toLowerCase().includes(searchSymptom)
                    )
                ).length;
                
                if (matchCount > 0) {
                    results.push({
                        ...prescription,
                        matchCount: matchCount,
                        matchPercentage: (matchCount / allSearchSymptoms.length * 100).toFixed(0)
                    });
                }
            });
            
            // 按匹配度排序
            results.sort((a, b) => b.matchCount - a.matchCount);
            
            // 顯示結果
            const resultsContainer = document.getElementById('searchResults');
            const resultsList = document.getElementById('resultsList');
            
            if (results.length > 0) {
                resultsList.innerHTML = results.map(result => `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-xl font-bold text-gray-800">${result.name}</h4>
                            <span class="bg-green-500 text-white text-sm px-3 py-1 rounded-full">
                                ${result.matchPercentage}% 匹配
                            </span>
                        </div>
                        <div class="mb-3">
                            <div class="text-gray-700 font-medium mb-1">💊 藥材組成：</div>
                            <div class="text-gray-600 bg-white p-3 rounded border">
                                ${result.ingredients.replace(/\n/g, '<br>')}
                            </div>
                        </div>
                        <div>
                            <div class="text-gray-700 font-medium mb-1">🎯 適用症狀：</div>
                            <div class="text-gray-600">${result.symptoms.join('、')}</div>
                        </div>
                    </div>
                `).join('');
                resultsContainer.classList.remove('hidden');
            } else {
                resultsList.innerHTML = '<div class="text-gray-500 text-center py-8 text-lg">😔 未找到相關處方</div>';
                resultsContainer.classList.remove('hidden');
            }
        }

        // 回車搜索
        document.getElementById('symptomSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchPrescriptions();
            }
        });

        // 回車添加
        document.getElementById('newSymptom').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addSymptom();
            }
        });

        // 標籤頁切換功能
        function showTab(tabName) {
            // 隱藏所有內容
            document.getElementById('groupsContent').classList.add('hidden');
            document.getElementById('symptomsContent').classList.add('hidden');
            document.getElementById('prescriptionsContent').classList.add('hidden');
            
            // 重置所有標籤樣式
            document.getElementById('groupsTab').className = 'flex-1 py-3 px-4 text-center font-medium text-gray-500 hover:text-gray-700';
            document.getElementById('symptomsTab').className = 'flex-1 py-3 px-4 text-center font-medium text-gray-500 hover:text-gray-700';
            document.getElementById('prescriptionsTab').className = 'flex-1 py-3 px-4 text-center font-medium text-gray-500 hover:text-gray-700';
            
            // 顯示選中的內容和標籤
            document.getElementById(tabName + 'Content').classList.remove('hidden');
            document.getElementById(tabName + 'Tab').className = 'flex-1 py-3 px-4 text-center font-medium border-b-2 border-green-500 text-green-600';
        }

        // 數據備份和恢復功能
        function exportData() {
            const data = {
                symptoms: symptoms,
                symptomGroups: symptomGroups,
                prescriptions: prescriptions,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `中醫處方數據_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            alert('✅ 數據已成功備份到下載文件夾！');
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // 驗證數據格式
                    if (data.symptoms && data.symptomGroups && data.prescriptions) {
                        symptoms = data.symptoms;
                        symptomGroups = data.symptomGroups;
                        prescriptions = data.prescriptions;
                        
                        // 保存到本地存儲
                        localStorage.setItem('tcm_symptoms', JSON.stringify(symptoms));
                        localStorage.setItem('tcm_symptom_groups', JSON.stringify(symptomGroups));
                        localStorage.setItem('tcm_prescriptions', JSON.stringify(prescriptions));
                        
                        // 重新渲染界面
                        renderSymptomGroups();
                        renderSymptoms();
                        renderPrescriptions();
                        updateStats();
                        
                        alert('✅ 數據恢復成功！');
                    } else {
                        alert('❌ 文件格式不正確，請選擇正確的備份文件！');
                    }
                } catch (error) {
                    alert('❌ 文件讀取失敗，請檢查文件是否損壞！');
                }
            };
            reader.readAsText(file);
            
            // 清空文件選擇器
            event.target.value = '';
        }
        
        function clearAllData() {
            if (confirm('⚠️ 確定要清空所有數據嗎？此操作無法撤銷！\n\n建議先備份數據再進行清空操作。')) {
                localStorage.removeItem('tcm_symptoms');
                localStorage.removeItem('tcm_symptom_groups');
                localStorage.removeItem('tcm_prescriptions');
                
                symptoms = [];
                symptomGroups = [];
                prescriptions = [];
                
                renderSymptomGroups();
                renderSymptoms();
                renderPrescriptions();
                updateStats();
                
                // 隱藏搜索結果
                document.getElementById('searchResults').classList.add('hidden');
                document.getElementById('symptomSearch').value = '';
                
                alert('✅ 所有數據已清空！');
            }
        }
        
        // 自動備份功能（每次數據變更時）
        function autoBackup() {
            const data = {
                symptoms: symptoms,
                symptomGroups: symptomGroups,
                prescriptions: prescriptions,
                lastBackup: new Date().toISOString()
            };
            localStorage.setItem('tcm_auto_backup', JSON.stringify(data));
        }
        
        // 檢查並恢復自動備份
        function checkAutoBackup() {
            const backup = localStorage.getItem('tcm_auto_backup');
            if (backup) {
                try {
                    const data = JSON.parse(backup);
                    const backupDate = new Date(data.lastBackup);
                    const now = new Date();
                    const daysDiff = (now - backupDate) / (1000 * 60 * 60 * 24);
                    
                    // 如果備份超過7天，提醒用戶
                    if (daysDiff > 7) {
                        if (confirm('💡 檢測到您的數據已經超過7天未備份，建議立即備份數據以防丟失。\n\n是否現在備份？')) {
                            exportData();
                        }
                    }
                } catch (error) {
                    console.log('自動備份檢查失敗');
                }
            }
        }

        // 雲端存儲功能（使用瀏覽器的IndexedDB作為持久化存儲）
        let db;
        
        // 初始化IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('TCMDatabase', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('backups')) {
                        const store = db.createObjectStore('backups', { keyPath: 'id' });
                        store.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                };
            });
        }
        
        // 保存到雲端（實際是IndexedDB持久化存儲）
        async function saveToCloud() {
            try {
                showStatus('正在保存到雲端...', 'info');
                
                if (!db) await initDB();
                
                const data = {
                    id: 'main_backup',
                    symptoms: symptoms,
                    symptomGroups: symptomGroups,
                    prescriptions: prescriptions,
                    timestamp: new Date().toISOString(),
                    version: '1.0'
                };
                
                const transaction = db.transaction(['backups'], 'readwrite');
                const store = transaction.objectStore('backups');
                await store.put(data);
                
                // 同時創建一個帶時間戳的歷史備份
                const historyData = {
                    ...data,
                    id: `backup_${Date.now()}`
                };
                await store.put(historyData);
                
                showStatus('✅ 數據已成功保存到雲端！', 'success');
                
                // 自動清理超過30天的歷史備份
                cleanOldBackups();
                
            } catch (error) {
                showStatus('❌ 雲端保存失敗：' + error.message, 'error');
            }
        }
        
        // 從雲端載入
        async function loadFromCloud() {
            try {
                showStatus('正在從雲端載入...', 'info');
                
                if (!db) await initDB();
                
                const transaction = db.transaction(['backups'], 'readonly');
                const store = transaction.objectStore('backups');
                const request = store.get('main_backup');
                
                request.onsuccess = () => {
                    const data = request.result;
                    if (data) {
                        symptoms = data.symptoms || [];
                        symptomGroups = data.symptomGroups || [];
                        prescriptions = data.prescriptions || [];
                        
                        // 保存到本地存儲
                        localStorage.setItem('tcm_symptoms', JSON.stringify(symptoms));
                        localStorage.setItem('tcm_symptom_groups', JSON.stringify(symptomGroups));
                        localStorage.setItem('tcm_prescriptions', JSON.stringify(prescriptions));
                        
                        // 重新渲染界面
                        renderSymptomGroups();
                        renderSymptoms();
                        renderPrescriptions();
                        updateStats();
                        
                        showStatus('✅ 數據已從雲端成功載入！', 'success');
                    } else {
                        showStatus('⚠️ 雲端沒有找到備份數據', 'warning');
                    }
                };
                
                request.onerror = () => {
                    showStatus('❌ 雲端載入失敗：' + request.error, 'error');
                };
                
            } catch (error) {
                showStatus('❌ 雲端載入失敗：' + error.message, 'error');
            }
        }
        
        // 顯示雲端狀態
        async function showCloudStatus() {
            try {
                if (!db) await initDB();
                
                const transaction = db.transaction(['backups'], 'readonly');
                const store = transaction.objectStore('backups');
                
                // 獲取主備份
                const mainRequest = store.get('main_backup');
                
                // 獲取所有歷史備份
                const allRequest = store.getAll();
                
                Promise.all([
                    new Promise(resolve => { mainRequest.onsuccess = () => resolve(mainRequest.result); }),
                    new Promise(resolve => { allRequest.onsuccess = () => resolve(allRequest.result); })
                ]).then(([mainBackup, allBackups]) => {
                    let statusText = '';
                    
                    if (mainBackup) {
                        const lastSync = new Date(mainBackup.timestamp);
                        statusText += `📅 最後同步：${lastSync.toLocaleString('zh-TW')}\n`;
                        statusText += `📊 症狀數量：${mainBackup.symptoms?.length || 0}\n`;
                        statusText += `📋 分組數量：${mainBackup.symptomGroups?.length || 0}\n`;
                        statusText += `💊 處方數量：${mainBackup.prescriptions?.length || 0}\n`;
                    } else {
                        statusText += '⚠️ 尚未進行雲端備份\n';
                    }
                    
                    const historyBackups = allBackups.filter(b => b.id !== 'main_backup');
                    statusText += `🗂️ 歷史備份：${historyBackups.length} 個\n`;
                    
                    // 計算存儲使用情況
                    const dataSize = JSON.stringify(allBackups).length;
                    statusText += `💾 存儲使用：${(dataSize / 1024).toFixed(1)} KB`;
                    
                    showStatus(statusText, 'info', 8000);
                });
                
            } catch (error) {
                showStatus('❌ 無法獲取雲端狀態：' + error.message, 'error');
            }
        }
        
        // 清理舊備份
        async function cleanOldBackups() {
            try {
                if (!db) return;
                
                const transaction = db.transaction(['backups'], 'readwrite');
                const store = transaction.objectStore('backups');
                const index = store.index('timestamp');
                
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                const range = IDBKeyRange.upperBound(thirtyDaysAgo.toISOString());
                const request = index.openCursor(range);
                
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        if (cursor.value.id !== 'main_backup') {
                            cursor.delete();
                        }
                        cursor.continue();
                    }
                };
            } catch (error) {
                console.log('清理舊備份失敗：', error);
            }
        }
        
        // 顯示狀態信息
        function showStatus(message, type = 'info', duration = 3000) {
            const statusDiv = document.getElementById('backupStatus');
            statusDiv.classList.remove('hidden', 'bg-blue-50', 'bg-green-50', 'bg-red-50', 'bg-yellow-50');
            statusDiv.classList.remove('text-blue-600', 'text-green-600', 'text-red-600', 'text-yellow-600');
            
            switch (type) {
                case 'success':
                    statusDiv.classList.add('bg-green-50', 'text-green-600');
                    break;
                case 'error':
                    statusDiv.classList.add('bg-red-50', 'text-red-600');
                    break;
                case 'warning':
                    statusDiv.classList.add('bg-yellow-50', 'text-yellow-600');
                    break;
                default:
                    statusDiv.classList.add('bg-blue-50', 'text-blue-600');
            }
            
            statusDiv.innerHTML = message.replace(/\n/g, '<br>');
            
            if (duration > 0) {
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, duration);
            }
        }
        
        // 增強的自動備份（同時備份到雲端）
        async function enhancedAutoBackup() {
            autoBackup(); // 本地備份
            
            // 每10次操作自動雲端備份一次
            const operationCount = parseInt(localStorage.getItem('tcm_operation_count') || '0') + 1;
            localStorage.setItem('tcm_operation_count', operationCount.toString());
            
            if (operationCount % 10 === 0) {
                try {
                    await saveToCloud();
                } catch (error) {
                    console.log('自動雲端備份失敗：', error);
                }
            }
        }

        // 初始化頁面
        async function initApp() {
            await initDB();
            renderSymptomGroups();
            renderSymptoms();
            renderPrescriptions();
            updateStats();
            checkAutoBackup();
        }
        
        // 批量導入功能
        function downloadTemplate() {
            const template = `當歸：血虛,月經不調,便秘
黃芪：氣虛,疲勞,自汗
甘草：咳嗽,胃痛,解毒
人參：氣虛,心悸,失眠
白朮：脾虛,腹脹,泄瀉
茯苓：水腫,失眠,心悸
川芎：頭痛,月經不調,胸痛
白芍：腹痛,月經不調,肝鬱
熟地黃：血虛,腎虛,頭暈
何首烏：血虛,脫髮,便秘`;
            
            const blob = new Blob([template], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = '中藥症狀導入模板.txt';
            link.click();
            
            showStatus('✅ 模板文件已下載！請按照格式填寫後導入。', 'success');
        }
        
        function loadBulkImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('bulkImportText').value = e.target.result;
                showStatus('✅ 文件內容已載入到文本框！', 'success');
            };
            reader.readAsText(file, 'UTF-8');
            
            // 清空文件選擇器
            event.target.value = '';
        }
        
        function clearBulkImport() {
            document.getElementById('bulkImportText').value = '';
            updateCharCount();
            showStatus('🧹 輸入框已清空', 'info');
        }
        
        // 更新字數統計
        function updateCharCount() {
            const textarea = document.getElementById('bulkImportText');
            const charCountDiv = document.getElementById('charCount');
            const currentLength = textarea.value.length;
            const maxLength = 100000;
            
            charCountDiv.textContent = `字數：${currentLength.toLocaleString()} / ${maxLength.toLocaleString()}`;
            
            // 根據字數變化顏色
            if (currentLength > maxLength * 0.9) {
                charCountDiv.className = 'text-sm text-red-500 font-medium';
            } else if (currentLength > maxLength * 0.7) {
                charCountDiv.className = 'text-sm text-yellow-600 font-medium';
            } else {
                charCountDiv.className = 'text-sm text-gray-500';
            }
        }
        
        function processBulkImport() {
            const text = document.getElementById('bulkImportText').value.trim();
            if (!text) {
                showStatus('⚠️ 請先輸入或選擇要導入的內容！', 'warning');
                return;
            }
            
            // 檢查數據大小
            const textLength = text.length;
            if (textLength > 100000) {
                showStatus('❌ 數據過大！請分批導入或減少內容（當前：' + textLength.toLocaleString() + ' 字）', 'error');
                return;
            }
            
            showStatus('⚡ 正在處理大量數據，請稍候...', 'info');
            
            // 使用 setTimeout 避免阻塞 UI
            setTimeout(() => {
                const lines = text.split('\n').filter(line => line.trim());
                let successCount = 0;
                let errorCount = 0;
                let newSymptoms = [];
                let newPrescriptions = [];
                let errorMessages = [];
                
                // 批量處理，每次處理100行
                const batchSize = 100;
                let currentBatch = 0;
                
                function processBatch() {
                    const start = currentBatch * batchSize;
                    const end = Math.min(start + batchSize, lines.length);
                    
                        const line = lines[i];
                        const trimmedLine = line.trim();
                        if (!trimmedLine) continue;
                        
                        // 支持多種分隔符：冒號、全形冒號
                        const separators = ['：', ':'];
                        let separator = null;
                        let parts = null;
                        
                        for (let sep of separators) {
                            if (trimmedLine.includes(sep)) {
                                parts = trimmedLine.split(sep);
                                separator = sep;
                                break;
                            }
                        }
                        
                        if (!parts || parts.length !== 2) {
                            errorMessages.push(`第${i + 1}行格式錯誤：${trimmedLine}`);
                            errorCount++;
                            continue;
                        }
                        
                        const herbName = parts[0].trim();
                        const symptomsText = parts[1].trim();
                        
                        if (!herbName || !symptomsText) {
                            errorMessages.push(`第${i + 1}行內容不完整：${trimmedLine}`);
                            errorCount++;
                            continue;
                        }
                        
                        // 解析症狀，支持多種分隔符
                        const symptomSeparators = [',', '，', ';', '；', '、'];
                        let herbSymptoms = [symptomsText];
                        
                        for (let sep of symptomSeparators) {
                            if (symptomsText.includes(sep)) {
                                herbSymptoms = symptomsText.split(sep).map(s => s.trim()).filter(s => s);
                                break;
                            }
                        }
                        
                        // 添加症狀到總列表
                        herbSymptoms.forEach(symptom => {
                            if (symptom && !symptoms.includes(symptom)) {
                                symptoms.push(symptom);
                                newSymptoms.push(symptom);
                            }
                        });
                        
                        // 檢查是否已存在同名處方
                        const existingIndex = prescriptions.findIndex(p => p.name === herbName);
                        
                        if (existingIndex >= 0) {
                            // 更新現有處方的症狀
                            const existingSymptoms = prescriptions[existingIndex].symptoms;
                            const combinedSymptoms = [...new Set([...existingSymptoms, ...herbSymptoms])];
                            prescriptions[existingIndex].symptoms = combinedSymptoms;
                        } else {
                            // 創建新處方
                            const newPrescription = {
                                name: herbName,
                                ingredients: `${herbName} 適量\n（請諮詢中醫師確定具體用量）`,
                                symptoms: herbSymptoms
                            };
                            prescriptions.push(newPrescription);
                            newPrescriptions.push(herbName);
                        }
                        
                        successCount++;
                    }
                    
                    currentBatch++;
                    
                    // 更新進度
                    const progress = Math.round((end / lines.length) * 100);
                    showStatus(`⚡ 處理進度：${progress}% (${end}/${lines.length})`, 'info');
                    
                    // 如果還有更多批次，繼續處理
                    if (end < lines.length) {
                        setTimeout(processBatch, 10); // 短暫延遲避免阻塞
                    } else {
                        // 處理完成，保存數據並顯示結果
                        finishImport();
                    }
                }
                
                function finishImport() {
                    // 保存數據
                    localStorage.setItem('tcm_symptoms', JSON.stringify(symptoms));
                    localStorage.setItem('tcm_prescriptions', JSON.stringify(prescriptions));
                    
                    // 重新渲染界面
                    renderSymptoms();
                    renderPrescriptions();
                    updateStats();
                    enhancedAutoBackup();
                    
                    // 顯示導入結果
                    let resultMessage = `📊 導入完成！\n`;
                    resultMessage += `✅ 成功處理：${successCount} 條\n`;
                    resultMessage += `📝 新增症狀：${newSymptoms.length} 個\n`;
                    resultMessage += `💊 新增/更新處方：${newPrescriptions.length} 個\n`;
                    
                    if (errorCount > 0) {
                        resultMessage += `❌ 錯誤：${errorCount} 條\n`;
                        if (errorMessages.length > 0) {
                            resultMessage += `\n錯誤詳情：\n${errorMessages.slice(0, 5).join('\n')}`;
                            if (errorMessages.length > 5) {
                                resultMessage += `\n...還有 ${errorMessages.length - 5} 個錯誤`;
                            }
                        }
                    }
                    
                    showStatus(resultMessage, successCount > 0 ? 'success' : 'error', 10000);
                    
                    // 清空輸入框
                    if (successCount > 0) {
                        document.getElementById('bulkImportText').value = '';
                        updateCharCount();
                    }
                }
                
                // 開始處理第一批
                processBatch();
                
            }, 100); // 延遲100ms開始處理
        }

        // 啟動應用
        initApp();
        
        // 監聽文本框輸入，實時更新字數統計
        document.getElementById('bulkImportText').addEventListener('input', updateCharCount);
        document.getElementById('bulkImportText').addEventListener('paste', function() {
            setTimeout(updateCharCount, 10); // 延遲一點確保粘貼內容已處理
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'964a675ae4bb1082',t:'MTc1MzQzMzM2My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
