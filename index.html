<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰∏≠ÈÜ´Ë®∫ÊâÄÁÆ°ÁêÜÁ≥ªÁµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">
    <!-- ÁôªÂÖ•È†ÅÈù¢ -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-white text-2xl">üè•</span>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">‰∏≠ÈÜ´Ë®∫ÊâÄÁÆ°ÁêÜÁ≥ªÁµ±</h1>
                <p class="text-gray-600 mt-2">Ë´ãÈÅ∏ÊìáÊÇ®ÁöÑË∫´‰ªΩÁôªÂÖ•</p>
            </div>
            
            <div class="space-y-4">
                <button onclick="login('admin')" class="w-full bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded-lg font-medium transition-colors">
                    ÁÆ°ÁêÜÂì°ÁôªÂÖ•
                </button>
                <button onclick="login('doctor')" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-medium transition-colors">
                    ÈÜ´Â∏´ÁôªÂÖ•
                </button>
                <button onclick="login('assistant')" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg font-medium transition-colors">
                    Ë®∫ÊâÄÂä©ÁêÜÁôªÂÖ•
                </button>
            </div>
        </div>
    </div>

    <!-- ‰∏ªÁ≥ªÁµ±È†ÅÈù¢ -->
    <div id="mainSystem" class="hidden min-h-screen">
        <!-- ÂÅ¥ÈÇäÈÅ∏ÂñÆ -->
        <div id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-2xl transform -translate-x-full transition-transform duration-300 ease-in-out">
            <div class="flex flex-col h-full">
                <!-- ÈÅ∏ÂñÆÊ®ôÈ°å -->
                <div class="bg-green-600 text-white p-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <span class="text-lg">üè•</span>
                            </div>
                            <div>
                                <h2 class="font-bold text-lg">Ë®∫ÊâÄÁ≥ªÁµ±</h2>
                                <p class="text-green-100 text-sm" id="sidebarUserRole"></p>
                            </div>
                        </div>
                        <button onclick="closeSidebar()" class="text-white hover:text-green-200 text-2xl">√ó</button>
                    </div>
                </div>
                
                <!-- ÈÅ∏ÂñÆÈ†ÖÁõÆ -->
                <div class="flex-1 py-4" id="sidebarMenu">
                    <!-- ÈÅ∏ÂñÆÈ†ÖÁõÆÊúÉÂãïÊÖãËºâÂÖ• -->
                </div>
                
                <!-- Â∫ïÈÉ®ÁôªÂá∫ -->
                <div class="p-4 border-t border-gray-200">
                    <button onclick="logout()" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg font-medium transition-colors">
                        ÁôªÂá∫Á≥ªÁµ±
                    </button>
                </div>
            </div>
        </div>

        <!-- ÈÅ∏ÂñÆÈÅÆÁΩ© -->
        <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden" onclick="closeSidebar()"></div>

        <!-- È†ÇÈÉ®Â∞éËà™ -->
        <nav class="bg-white shadow-lg border-b-4 border-green-500">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-4">
                        <button onclick="openSidebar()" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                            </svg>
                        </button>
                        <div class="w-10 h-10 bg-green-600 rounded-full flex items-center justify-center">
                            <span class="text-white text-lg">üè•</span>
                        </div>
                        <h1 class="text-xl font-bold text-gray-800">‰∏≠ÈÜ´Ë®∫ÊâÄÁÆ°ÁêÜÁ≥ªÁµ±</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="userRole" class="text-sm text-gray-600 bg-gray-100 px-3 py-1 rounded-full"></span>
                        <button onclick="logout()" class="text-red-600 hover:text-red-800 font-medium">ÁôªÂá∫</button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- ‰∏ªË¶ÅÂÖßÂÆπÂçÄÂüü -->
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div id="welcomeMessage" class="bg-white rounded-xl shadow-lg p-8 text-center">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-4xl">üè•</span>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Ê≠°Ëøé‰ΩøÁî®‰∏≠ÈÜ´Ë®∫ÊâÄÁÆ°ÁêÜÁ≥ªÁµ±</h2>
                <p class="text-gray-600">Ë´ã‰ΩøÁî®Â∑¶ÂÅ¥ÈÅ∏ÂñÆÈñãÂßã‰ΩøÁî®Á≥ªÁµ±ÂäüËÉΩ</p>
            </div>
        </div>

        <!-- ÁóÖ‰∫∫Ë≥áÊñôÁÆ°ÁêÜ -->
        <div id="patientManagement" class="hidden max-w-7xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">ÁóÖ‰∫∫Ë≥áÊñôÁÆ°ÁêÜ</h2>
                    <button onclick="showAddPatientForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">
                        Êñ∞Â¢ûÁóÖ‰∫∫
                    </button>
                </div>
                
                <!-- ÊêúÁ¥¢ÂäüËÉΩ -->
                <div class="mb-6">
                    <div class="relative">
                        <input type="text" id="patientSearchInput" placeholder="ÊêúÁ¥¢ÁóÖ‰∫∫ÂßìÂêç„ÄÅÈõªË©±..." 
                               onkeyup="searchPatients()" 
                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <!-- ÁóÖ‰∫∫ÂàóË°® -->
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">ÁóÖ‰∫∫Á∑®Ëôü</th>
                                <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">ÂßìÂêç</th>
                                <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">ÊÄßÂà•</th>
                                <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">Âπ¥ÈΩ°</th>
                                <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">ÈõªË©±</th>
                                <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody id="patientList">
                            <!-- ÁóÖ‰∫∫Ë≥áÊñôÊúÉÂãïÊÖãËºâÂÖ• -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Êñ∞Â¢ûÁóÖ‰∫∫Ë°®ÂñÆ -->
        <div id="addPatientForm" class="hidden max-w-2xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Êñ∞Â¢ûÁóÖ‰∫∫Ë≥áÊñô</h2>
                <form onsubmit="addPatient(event)" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÂßìÂêç *</label>
                            <input type="text" id="patientName" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ë∫´‰ªΩË≠âÂ≠óËôü *</label>
                            <input type="text" id="patientIdNumber" required pattern="[A-Z][0-9]{9}" maxlength="10" placeholder="Â¶ÇÔºöA123456789" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÊÄßÂà• *</label>
                            <select id="patientGender" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="">Ë´ãÈÅ∏Êìá</option>
                                <option value="Áî∑">Áî∑</option>
                                <option value="Â•≥">Â•≥</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Âá∫ÁîüÊó•Êúü *</label>
                            <input type="date" id="patientBirthDate" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÈõªË©± *</label>
                            <input type="tel" id="patientPhone" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Âú∞ÂùÄ</label>
                            <input type="text" id="patientAddress" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                    </div>
                    <div class="flex space-x-4 pt-4">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium">
                            ÂÑ≤Â≠ò
                        </button>
                        <button type="button" onclick="showPatientManagement()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium">
                            ÂèñÊ∂à
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Á∑®ËºØÁóÖ‰∫∫Ë°®ÂñÆ -->
        <div id="editPatientForm" class="hidden max-w-2xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Á∑®ËºØÁóÖ‰∫∫Ë≥áÊñô</h2>
                <form onsubmit="updatePatient(event)" class="space-y-4">
                    <input type="hidden" id="editPatientId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÂßìÂêç *</label>
                            <input type="text" id="editPatientName" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ë∫´‰ªΩË≠âÂ≠óËôü *</label>
                            <input type="text" id="editPatientIdNumber" required pattern="[A-Z][0-9]{9}" maxlength="10" placeholder="Â¶ÇÔºöA123456789" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÊÄßÂà• *</label>
                            <select id="editPatientGender" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Ë´ãÈÅ∏Êìá</option>
                                <option value="Áî∑">Áî∑</option>
                                <option value="Â•≥">Â•≥</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Âá∫ÁîüÊó•Êúü *</label>
                            <input type="date" id="editPatientBirthDate" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÈõªË©± *</label>
                            <input type="tel" id="editPatientPhone" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Âú∞ÂùÄ</label>
                            <input type="text" id="editPatientAddress" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                    <div class="flex space-x-4 pt-4">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium">
                            Êõ¥Êñ∞Ë≥áÊñô
                        </button>
                        <button type="button" onclick="showPatientManagement()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium">
                            ÂèñÊ∂à
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Ë®∫ÁóáÁ≥ªÁµ± -->
        <div id="consultationSystem" class="hidden max-w-7xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Ë®∫ÁóáÁ≥ªÁµ±</h2>
                    <button onclick="showAppointmentForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">
                        ÁóÖ‰∫∫ÊéõËôü
                    </button>
                </div>
                
                <!-- ‰ªäÊó•ÊéõËôüÁóÖ‰∫∫ÂàóË°® -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">‰ªäÊó•ÊéõËôüÁóÖ‰∫∫</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">ÊéõËôüÊôÇÈñì</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">ÁóÖ‰∫∫Á∑®Ëôü</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">ÁóÖ‰∫∫ÂßìÂêç</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">Âπ¥ÈΩ°</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">ÁãÄÊÖã</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody id="appointmentList">
                                <!-- ÊéõËôüÂàóË°®ÊúÉÂãïÊÖãËºâÂÖ• -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÊéõËôüË°®ÂñÆ -->
        <div id="appointmentForm" class="hidden max-w-2xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">ÁóÖ‰∫∫ÊéõËôü</h2>
                
                <!-- ÊêúÁ¥¢ÁóÖ‰∫∫ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ÊêúÁ¥¢‰∏¶ÈÅ∏ÊìáÁóÖ‰∫∫</label>
                    <div class="relative">
                        <input type="text" id="appointmentSearchInput" placeholder="ÊêúÁ¥¢ÁóÖ‰∫∫ÂßìÂêç„ÄÅÈõªË©±..." 
                               oninput="searchAppointmentPatients()" 
                               onfocus="showSearchResults()"
                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        
                        <!-- ÊêúÁ¥¢ÁµêÊûú‰∏ãÊãâÈÅ∏ÂñÆ -->
                        <div id="searchResults" class="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-60 overflow-y-auto z-10 hidden">
                            <div id="searchResultsList" class="py-1">
                                <!-- ÊêúÁ¥¢ÁµêÊûúÊúÉÂãïÊÖãËºâÂÖ• -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- ÈÅ∏‰∏≠ÁöÑÁóÖ‰∫∫È°ØÁ§∫ -->
                    <div id="selectedPatientInfo" class="hidden mt-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex justify-between items-center">
                            <div>
                                <span class="text-sm text-green-700">Â∑≤ÈÅ∏ÊìáÁóÖ‰∫∫Ôºö</span>
                                <span id="selectedPatientDisplay" class="font-medium text-green-800"></span>
                            </div>
                            <button type="button" onclick="clearSelectedPatient()" class="text-green-600 hover:text-green-800 text-sm">
                                ÈáçÊñ∞ÈÅ∏Êìá
                            </button>
                        </div>
                    </div>
                </div>
                
                <form onsubmit="addAppointment(event)" class="space-y-4">
                    <input type="hidden" id="selectedPatientId" required>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÊéõËôüÊôÇÈñì *</label>
                        <input type="datetime-local" id="appointmentTime" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÁóáÁãÄÊèèËø∞</label>
                        <textarea id="appointmentSymptoms" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Á∞°Ëø∞ÁóÖ‰∫∫‰∏ªË¶ÅÁóáÁãÄ"></textarea>
                    </div>
                    
                    <div class="flex space-x-4 pt-4">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium">
                            Á¢∫Ë™çÊéõËôü
                        </button>
                        <button type="button" onclick="showConsultationSystem()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium">
                            ÂèñÊ∂à
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ‰∏≠Ëó•ÂèäÊñπÂäëÂ∫´ -->
        <div id="herbalLibrary" class="hidden max-w-7xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">üåø ‰∏≠Ëó•ÂèäÊñπÂäëÂ∫´</h2>
                    <div class="flex space-x-2">
                        <button onclick="showAddHerbForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">
                            Êñ∞Â¢û‰∏≠Ëó•
                        </button>
                        <button onclick="showAddFormulaForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">
                            Êñ∞Â¢ûÊñπÂäë
                        </button>
                    </div>
                </div>
                
                <!-- ÂàÜÈ°ûÊ®ôÁ±§ -->
                <div class="mb-6">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterHerbalItems('all')" class="px-4 py-2 bg-amber-600 text-white rounded-lg text-sm font-medium hover:bg-amber-700" id="herbal-filter-all">
                            ÂÖ®ÈÉ®
                        </button>
                        <button onclick="filterHerbalItems('herb')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300" id="herbal-filter-herb">
                            üåø ‰∏≠Ëó•
                        </button>
                        <button onclick="filterHerbalItems('formula')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300" id="herbal-filter-formula">
                            üìú ÊñπÂäë
                        </button>
                    </div>
                </div>
                
                <!-- ÊêúÁ¥¢ÂäüËÉΩ -->
                <div class="mb-6">
                    <div class="relative">
                        <input type="text" id="herbalSearchInput" placeholder="ÊêúÁ¥¢‰∏≠Ëó•ÂêçÁ®±„ÄÅÊñπÂäëÂêçÁ®±..." 
                               onkeyup="searchHerbalItems()" 
                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <!-- ‰∏≠Ëó•ÂèäÊñπÂäëÂàóË°® -->
                <div class="bg-white rounded-lg border border-gray-200">
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">È°ûÂûã</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">ÂêçÁ®±</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody id="herbalItemsList">
                                <!-- ‰∏≠Ëó•ÂèäÊñπÂäëÂàóË°®ÊúÉÂãïÊÖãËºâÂÖ• -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Êñ∞Â¢û‰∏≠Ëó•Ë°®ÂñÆ -->
        <div id="addHerbForm" class="hidden max-w-2xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Êñ∞Â¢û‰∏≠Ëó•</h2>
                <form onsubmit="addHerb(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‰∏≠Ëó•ÂêçÁ®± *</label>
                        <input type="text" id="herbName" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                    <div class="flex space-x-4 pt-4">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium">
                            ÂÑ≤Â≠ò‰∏≠Ëó•
                        </button>
                        <button type="button" onclick="showHerbalLibrary()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium">
                            ÂèñÊ∂à
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Á∑®ËºØ‰∏≠Ëó•Ë°®ÂñÆ -->
        <div id="editHerbForm" class="hidden max-w-2xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Á∑®ËºØ‰∏≠Ëó•</h2>
                <form onsubmit="updateHerb(event)" class="space-y-4">
                    <input type="hidden" id="editHerbId">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‰∏≠Ëó•ÂêçÁ®± *</label>
                        <input type="text" id="editHerbName" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="flex space-x-4 pt-4">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium">
                            Êõ¥Êñ∞‰∏≠Ëó•
                        </button>
                        <button type="button" onclick="showHerbalLibrary()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium">
                            ÂèñÊ∂à
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Êñ∞Â¢ûÊñπÂäëË°®ÂñÆ -->
        <div id="addFormulaForm" class="hidden max-w-4xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Êñ∞Â¢ûÊñπÂäë</h2>
                <form onsubmit="addFormula(event)" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÊñπÂäëÂêçÁ®± *</label>
                            <input type="text" id="formulaName" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Âá∫Ëôï</label>
                            <input type="text" id="formulaSource" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Â¶ÇÔºö„ÄäÂÇ∑ÂØíË´ñ„Äã">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÁµÑÊàê *</label>
                            
                            <!-- ‰∏≠Ëó•ÊêúÂ∞ãÂíåÊ∑ªÂä† -->
                            <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                                <div class="flex items-center space-x-2 mb-3">
                                    <div class="relative flex-1">
                                        <input type="text" id="herbSearchInput" placeholder="ÊêúÂ∞ã‰∏≠Ëó•ÂêçÁ®±..." 
                                               oninput="searchHerbsForFormula()" 
                                               onfocus="showHerbSearchResults()"
                                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                            </svg>
                                        </div>
                                        
                                        <!-- ÊêúÂ∞ãÁµêÊûú‰∏ãÊãâÈÅ∏ÂñÆ -->
                                        <div id="herbSearchResults" class="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-40 overflow-y-auto z-10 hidden">
                                            <div id="herbSearchResultsList" class="py-1">
                                                <!-- ÊêúÂ∞ãÁµêÊûúÊúÉÂãïÊÖãËºâÂÖ• -->
                                            </div>
                                        </div>
                                    </div>
                                    <input type="number" id="herbDosageInput" placeholder="ÂäëÈáè(g)" min="0.1" step="0.1" 
                                           class="w-24 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <button type="button" onclick="addHerbToFormula()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">
                                        Ê∑ªÂä†
                                    </button>
                                </div>
                                
                                <!-- Â∑≤ÈÅ∏‰∏≠Ëó•È°ØÁ§∫ -->
                                <div id="selectedHerbsDisplay" class="space-y-2">
                                    <!-- Â∑≤ÈÅ∏‰∏≠Ëó•ÊúÉÂãïÊÖãÈ°ØÁ§∫ -->
                                </div>
                            </div>
                            
                            <!-- ÊúÄÁµÇÁµÑÊàêÊñáÂ≠ó -->
                            <textarea id="formulaComposition" rows="3" required readonly 
                                      class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                      placeholder="Ë´ã‰ΩøÁî®‰∏äÊñπÊêúÂ∞ãÂäüËÉΩÊ∑ªÂä†‰∏≠Ëó•..."></textarea>
                            <p class="text-xs text-gray-500 mt-1">üí° ‰ΩøÁî®‰∏äÊñπÊêúÂ∞ãÂäüËÉΩÊ∑ªÂä†‰∏≠Ëó•ÔºåÁ≥ªÁµ±ÊúÉËá™ÂãïÁîüÊàêÁµÑÊàêÊñáÂ≠ó</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ê≥®ÊÑè‰∫ãÈ†Ö</label>
                            <input type="text" id="formulaPrecautions" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Á¶ÅÂøåÊàñÊ≥®ÊÑè‰∫ãÈ†Ö">
                        </div>
                    </div>
                    <div class="flex space-x-4 pt-4">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium">
                            ÂÑ≤Â≠òÊñπÂäë
                        </button>
                        <button type="button" onclick="showHerbalLibrary()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium">
                            ÂèñÊ∂à
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Á∑®ËºØÊñπÂäëË°®ÂñÆ -->
        <div id="editFormulaForm" class="hidden max-w-4xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Á∑®ËºØÊñπÂäë</h2>
                <form onsubmit="updateFormula(event)" class="space-y-4">
                    <input type="hidden" id="editFormulaId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÊñπÂäëÂêçÁ®± *</label>
                            <input type="text" id="editFormulaName" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Âá∫Ëôï</label>
                            <input type="text" id="editFormulaSource" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="Â¶ÇÔºö„ÄäÂÇ∑ÂØíË´ñ„Äã">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÁµÑÊàê *</label>
                            
                            <!-- ‰∏≠Ëó•ÊêúÂ∞ãÂíåÊ∑ªÂä† -->
                            <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                                <div class="flex items-center space-x-2 mb-3">
                                    <div class="relative flex-1">
                                        <input type="text" id="editHerbSearchInput" placeholder="ÊêúÂ∞ã‰∏≠Ëó•ÂêçÁ®±..." 
                                               oninput="searchHerbsForEditFormula()" 
                                               onfocus="showEditHerbSearchResults()"
                                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                            </svg>
                                        </div>
                                        
                                        <!-- ÊêúÂ∞ãÁµêÊûú‰∏ãÊãâÈÅ∏ÂñÆ -->
                                        <div id="editHerbSearchResults" class="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-40 overflow-y-auto z-10 hidden">
                                            <div id="editHerbSearchResultsList" class="py-1">
                                                <!-- ÊêúÂ∞ãÁµêÊûúÊúÉÂãïÊÖãËºâÂÖ• -->
                                            </div>
                                        </div>
                                    </div>
                                    <input type="number" id="editHerbDosageInput" placeholder="ÂäëÈáè(g)" min="0.1" step="0.1" 
                                           class="w-24 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                    <button type="button" onclick="addHerbToEditFormula()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">
                                        Ê∑ªÂä†
                                    </button>
                                </div>
                                
                                <!-- Â∑≤ÈÅ∏‰∏≠Ëó•È°ØÁ§∫ -->
                                <div id="editSelectedHerbsDisplay" class="space-y-2">
                                    <!-- Â∑≤ÈÅ∏‰∏≠Ëó•ÊúÉÂãïÊÖãÈ°ØÁ§∫ -->
                                </div>
                            </div>
                            
                            <!-- ÊúÄÁµÇÁµÑÊàêÊñáÂ≠ó -->
                            <textarea id="editFormulaComposition" rows="3" required readonly 
                                      class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-50 focus:ring-2 focus:ring-orange-500 focus:border-transparent" 
                                      placeholder="Ë´ã‰ΩøÁî®‰∏äÊñπÊêúÂ∞ãÂäüËÉΩÊ∑ªÂä†‰∏≠Ëó•..."></textarea>
                            <p class="text-xs text-gray-500 mt-1">üí° ‰ΩøÁî®‰∏äÊñπÊêúÂ∞ãÂäüËÉΩÊ∑ªÂä†‰∏≠Ëó•ÔºåÁ≥ªÁµ±ÊúÉËá™ÂãïÁîüÊàêÁµÑÊàêÊñáÂ≠ó</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ê≥®ÊÑè‰∫ãÈ†Ö</label>
                            <input type="text" id="editFormulaPrecautions" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="Á¶ÅÂøåÊàñÊ≥®ÊÑè‰∫ãÈ†Ö">
                        </div>
                    </div>
                    <div class="flex space-x-4 pt-4">
                        <button type="submit" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-lg font-medium">
                            Êõ¥Êñ∞ÊñπÂäë
                        </button>
                        <button type="button" onclick="showHerbalLibrary()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium">
                            ÂèñÊ∂à
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ÁóÖÊ≠∑Â°´ÂØ´È†ÅÈù¢ -->
        <div id="medicalRecordForm" class="hidden max-w-4xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">üìã ÁóÖÊ≠∑Â°´ÂØ´</h2>
                        <div id="currentPatientInfo" class="text-sm text-gray-600 mt-1">
                            <!-- ÁóÖ‰∫∫Ë≥áË®äÊúÉÂãïÊÖãËºâÂÖ• -->
                        </div>
                    </div>
                    <button onclick="showConsultationSystem()" class="text-gray-600 hover:text-gray-800">‚Üê ËøîÂõûË®∫ÁóáÁ≥ªÁµ±</button>
                </div>
                
                <form onsubmit="saveMedicalRecord(event)" class="space-y-6">
                    <input type="hidden" id="recordPatientId">
                    <input type="hidden" id="recordAppointmentId">
                    
                    <!-- Âü∫Êú¨Ë≥áË®ä -->
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-blue-800 mb-4">Âü∫Êú¨Ë≥áË®ä</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ë®∫ÁóáÊó•Êúü *</label>
                                <input type="date" id="consultationDate" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ë®∫ÁóáÊôÇÈñì *</label>
                                <input type="time" id="consultationTime" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‰∏ªË®∫ÈÜ´Â∏´ *</label>
                                <input type="text" id="consultingDoctor" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" value="Êùé‰∏≠ÈÜ´Â∏´" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ‰∏ªË®¥ -->
                    <div class="bg-green-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-green-800 mb-4">‰∏ªË®¥ (Chief Complaint)</h3>
                        <textarea id="chiefComplaint" rows="3" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="ÁóÖ‰∫∫‰∏ªË¶ÅÁóáÁãÄÂèäÊåÅÁ∫åÊôÇÈñìÔºåÂ¶ÇÔºöÈ†≠Áóõ3Â§©Ôºå‰º¥Èö®ÂôÅÂøÉÂòîÂêê..."></textarea>
                    </div>
                    
                    <!-- ÁèæÁóÖÂè≤ -->
                    <div class="bg-amber-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-amber-800 mb-4">ÁèæÁóÖÂè≤ (Present Illness)</h3>
                        <textarea id="presentIllness" rows="4" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-amber-500 focus:border-transparent" placeholder="Ë©≥Á¥∞ÊèèËø∞ÁóÖÊÉÖÁôºÂ±ïÈÅéÁ®ã„ÄÅÁóáÁãÄËÆäÂåñ„ÄÅÁõ∏ÈóúÊ™¢Êü•ÁµêÊûúÁ≠â..."></textarea>
                    </div>
                    
                    <!-- Êó¢ÂæÄÂè≤ -->
                    <div class="bg-purple-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-purple-800 mb-4">Êó¢ÂæÄÂè≤ (Past History)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ÈÅéÂæÄÁñæÁóÖÂè≤</label>
                                <textarea id="pastMedicalHistory" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="È´òË°ÄÂ£ì„ÄÅÁ≥ñÂ∞øÁóÖ„ÄÅÊâãË°ìÂè≤Á≠â..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ëó•Áâ©ÈÅéÊïèÂè≤</label>
                                <textarea id="allergyHistory" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Â∞çÁâπÂÆöËó•Áâ©ÊàñÈ£üÁâ©ÁöÑÈÅéÊïèÂèçÊáâ..."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ‰∏≠ÈÜ´ÂõõË®∫ -->
                    <div class="bg-red-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-red-800 mb-4">‰∏≠ÈÜ´ÂõõË®∫</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ÊúõË®∫ (Inspection)</label>
                                <textarea id="inspection" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Èù¢Ëâ≤„ÄÅÁ•ûÊÖã„ÄÅËàåË±°Á≠â..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ËÅûË®∫ (Auscultation & Olfaction)</label>
                                <textarea id="auscultation" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="ËÅ≤Èü≥„ÄÅÊ∞£Âë≥Á≠â..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ÂïèË®∫ (Inquiry)</label>
                                <textarea id="inquiry" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="ÂØíÁÜ±„ÄÅÊ±óÂá∫„ÄÅÈ£≤È£ü„ÄÅÁù°Áú†„ÄÅ‰∫å‰æøÁ≠â..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ÂàáË®∫ (Palpation)</label>
                                <textarea id="palpation" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="ËÑàË±°„ÄÅÊåâË®∫Á≠â..."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ‰∏≠ÈÜ´Ë®∫Êñ∑ -->
                    <div class="bg-indigo-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-indigo-800 mb-4">‰∏≠ÈÜ´Ë®∫Êñ∑</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ÁóÖÂêçË®∫Êñ∑ *</label>
                                <input type="text" id="tcmDiagnosis" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Â¶ÇÔºöÈ†≠Áóõ„ÄÅËÉÉËÑòÁóõÁ≠â...">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ë≠âÂûãË®∫Êñ∑ *</label>
                                <input type="text" id="syndromePattern" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Â¶ÇÔºöËÇùÈôΩ‰∏ä‰∫¢Ë≠â„ÄÅËÑæËÉÉËôõÂØíË≠âÁ≠â...">
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ë®∫Êñ∑‰æùÊìö</label>
                            <textarea id="diagnosisBasis" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Ê†πÊìöÂõõË®∫Ë≥áÊñôÂàÜÊûêË®∫Êñ∑‰æùÊìö..."></textarea>
                        </div>
                    </div>
                    
                    <!-- Ê≤ªÁôÇÊñπÊ°à -->
                    <div class="bg-teal-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-teal-800 mb-4">Ê≤ªÁôÇÊñπÊ°à</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ê≤ªÊ≥ï *</label>
                                <input type="text" id="treatmentPrinciple" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 focus:border-transparent" placeholder="Â¶ÇÔºöÂπ≥ËÇùÊΩõÈôΩ„ÄÅÊ∫´‰∏≠ÂÅ•ËÑæÁ≠â...">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ÊñπÂäëÂêçÁ®±</label>
                                <input type="text" id="prescriptionName" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 focus:border-transparent" placeholder="Â¶ÇÔºöÂ§©È∫ªÈâ§Ëó§È£≤Âä†Ê∏õ„ÄÅÁêÜ‰∏≠ÊπØÂä†Ê∏õÁ≠â...">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ËôïÊñπÂÖßÂÆπ *</label>
                                <textarea id="prescriptionContent" rows="5" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 focus:border-transparent" placeholder="Ë©≥Á¥∞Ëó•Áâ©ÁµÑÊàêÂèäÂäëÈáèÔºåÂ¶ÇÔºö&#10;Â§©È∫ª 10g&#10;Èâ§Ëó§ 15g&#10;Áü≥Ê±∫Êòé 30g&#10;..."></textarea>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ÊúçÁî®ÊñπÊ≥ï *</label>
                                    <input type="text" id="dosageInstructions" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 focus:border-transparent" placeholder="Â¶ÇÔºöÊ∞¥ÁÖéÊúçÔºåÊó•‰∫åÊ¨°ÔºåÈ£ØÂæåÊ∫´Êúç">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ÁôÇÁ®ã</label>
                                    <input type="text" id="treatmentDuration" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 focus:border-transparent" placeholder="Â¶ÇÔºö7ÂäëÔºå‰∏ÄÈÄ±ÂæåË§áË®∫">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ÈÜ´ÂõëÂèäÊ≥®ÊÑè‰∫ãÈ†Ö -->
                    <div class="bg-orange-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-orange-800 mb-4">ÈÜ´ÂõëÂèäÊ≥®ÊÑè‰∫ãÈ†Ö</h3>
                        <textarea id="medicalAdvice" rows="4" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="È£≤È£üÂÆúÂøå„ÄÅÁîüÊ¥ªË™øÁêÜ„ÄÅË§áË®∫ÊôÇÈñìÁ≠âÊ≥®ÊÑè‰∫ãÈ†Ö..."></textarea>
                    </div>
                    
                    <!-- Êìç‰ΩúÊåâÈàï -->
                    <div class="flex space-x-4 pt-6 border-t border-gray-200">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-medium text-lg">
                            ÂÑ≤Â≠òÁóÖÊ≠∑
                        </button>
                        <button type="button" onclick="saveDraftRecord()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium">
                            ÂÑ≤Â≠òËçâÁ®ø
                        </button>
                        <button type="button" onclick="showConsultationSystem()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium">
                            ÂèñÊ∂à
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Á≥ªÁµ±ÁÆ°ÁêÜ -->
        <div id="systemManagement" class="hidden max-w-7xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Á≥ªÁµ±ÁÆ°ÁêÜ</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg p-6 text-white">
                        <h3 class="text-lg font-semibold mb-2">Áî®Êà∂ÁÆ°ÁêÜ</h3>
                        <p class="text-blue-100 mb-4">ÁÆ°ÁêÜÁ≥ªÁµ±Áî®Êà∂Ê¨äÈôê</p>
                        <button onclick="showFeatureModal('Áî®Êà∂ÁÆ°ÁêÜÂäüËÉΩÔºöÊ≠§ÂäüËÉΩÂèØ‰ª•Êñ∞Â¢û„ÄÅÁ∑®ËºØ„ÄÅÂà™Èô§Á≥ªÁµ±Áî®Êà∂Ôºå‰∏¶Ë®≠ÂÆö‰∏çÂêåÁöÑÊ¨äÈôêÁ≠âÁ¥ö„ÄÇ')" class="bg-white text-blue-600 px-4 py-2 rounded font-medium hover:bg-blue-50">
                            ÁÆ°ÁêÜÁî®Êà∂
                        </button>
                    </div>
                    
                    <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg p-6 text-white">
                        <h3 class="text-lg font-semibold mb-2">Êï∏ÊìöÁµ±Ë®à</h3>
                        <p class="text-green-100 mb-4">Êü•ÁúãË®∫ÊâÄÁáüÈÅãÊï∏Êìö</p>
                        <button onclick="showStatistics()" class="bg-white text-green-600 px-4 py-2 rounded font-medium hover:bg-green-50">
                            Êü•ÁúãÁµ±Ë®à
                        </button>
                    </div>
                    
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg p-6 text-white">
                        <h3 class="text-lg font-semibold mb-2">Á≥ªÁµ±Ë®≠ÂÆö</h3>
                        <p class="text-purple-100 mb-4">Ë™øÊï¥Á≥ªÁµ±ÂèÉÊï∏</p>
                        <button onclick="showFeatureModal('Á≥ªÁµ±Ë®≠ÂÆöÂäüËÉΩÔºöÊ≠§ÂäüËÉΩÂèØ‰ª•Ë™øÊï¥Á≥ªÁµ±ÂèÉÊï∏„ÄÅÂÇô‰ªΩË≥áÊñô„ÄÅË®≠ÂÆöË®∫ÊâÄÂü∫Êú¨Ë≥áË®äÁ≠â„ÄÇ')" class="bg-white text-purple-600 px-4 py-2 rounded font-medium hover:bg-purple-50">
                            Á≥ªÁµ±Ë®≠ÂÆö
                        </button>
                    </div>
                </div>
            </div>
        </div>



        <!-- ÁóÖ‰∫∫ÁóÖÊ≠∑Ë®òÈåÑÈ†ÅÈù¢ -->
        <div id="patientMedicalRecords" class="hidden max-w-7xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">üìã ÁóÖÊ≠∑Ë®òÈåÑ</h2>
                        <p id="currentPatientName" class="text-sm text-gray-600 mt-1"></p>
                    </div>
                    <button onclick="showPatientManagement()" class="text-gray-600 hover:text-gray-800">‚Üê ËøîÂõûÁóÖ‰∫∫ÁÆ°ÁêÜ</button>
                </div>
                
                <!-- ÊêúÁ¥¢ÂíåÁØ©ÈÅ∏ÂäüËÉΩ -->
                <div class="mb-6 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <input type="date" id="patientRecordDateFrom" 
                                   onchange="filterPatientMedicalRecords()" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                   placeholder="ÈñãÂßãÊó•Êúü">
                        </div>
                        <div>
                            <input type="date" id="patientRecordDateTo" 
                                   onchange="filterPatientMedicalRecords()" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                   placeholder="ÁµêÊùüÊó•Êúü">
                        </div>
                    </div>
                    
                    <!-- Âø´ÈÄüÁØ©ÈÅ∏ÊåâÈàï -->
                    <div class="flex flex-wrap gap-2">
                        <button onclick="setPatientDateFilter('today')" class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg text-sm font-medium hover:bg-purple-200">
                            ‰ªäÊó•
                        </button>
                        <button onclick="setPatientDateFilter('week')" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium hover:bg-blue-200">
                            Êú¨ÈÄ±
                        </button>
                        <button onclick="setPatientDateFilter('month')" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg text-sm font-medium hover:bg-green-200">
                            Êú¨Êúà
                        </button>
                        <button onclick="clearPatientDateFilter()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200">
                            Ê∏ÖÈô§ÁØ©ÈÅ∏
                        </button>
                    </div>
                </div>
                
                <!-- ÁóÖÊ≠∑ÂàóË°® -->
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">Ë®∫ÁóáÊó•Êúü</th>
                                <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">‰∏ªË®¥</th>
                                <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">Ë®∫Êñ∑</th>
                                <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">ÈÜ´Â∏´</th>
                                <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody id="patientMedicalRecordsList">
                            <!-- ÁóÖÊ≠∑Ë®òÈåÑÊúÉÂãïÊÖãËºâÂÖ• -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Áµ±Ë®àÈ†ÅÈù¢ -->
        <div id="statisticsPage" class="hidden max-w-7xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Ë®∫ÊâÄÁµ±Ë®àÊï∏Êìö</h2>
                    <button onclick="showSystemManagement()" class="text-gray-600 hover:text-gray-800">‚Üê ËøîÂõû</button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-blue-50 rounded-lg p-6 text-center">
                        <div class="text-3xl font-bold text-blue-600" id="totalPatients">0</div>
                        <div class="text-gray-600 mt-2">Á∏ΩÁóÖ‰∫∫Êï∏</div>
                    </div>
                    <div class="bg-green-50 rounded-lg p-6 text-center">
                        <div class="text-3xl font-bold text-green-600" id="totalConsultations">0</div>
                        <div class="text-gray-600 mt-2">Á∏ΩË®∫ÁóáÊ¨°Êï∏</div>
                    </div>
                    <div class="bg-yellow-50 rounded-lg p-6 text-center">
                        <div class="text-3xl font-bold text-yellow-600" id="todayConsultations">0</div>
                        <div class="text-gray-600 mt-2">‰ªäÊó•Ë®∫Áóá</div>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-6 text-center">
                        <div class="text-3xl font-bold text-purple-600" id="activeUsers">3</div>
                        <div class="text-gray-600 mt-2">Á≥ªÁµ±Áî®Êà∂</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÊµÆÂãïË¶ñÁ™ó -->
    <!-- ÁóÖ‰∫∫Ë©≥ÊÉÖË¶ñÁ™ó -->
    <div id="patientDetailModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto fade-in">
            <div class="bg-blue-600 text-white p-6 rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">üë§ ÁóÖ‰∫∫Ë©≥ÊÉÖ</h3>
                    <button onclick="closeModal('patientDetailModal')" class="text-white hover:text-blue-200 text-2xl">√ó</button>
                </div>
            </div>
            <div class="p-6">
                <div id="patientDetailContent" class="space-y-4">
                    <!-- ÁóÖ‰∫∫Ë©≥ÊÉÖÂÖßÂÆπÊúÉÂãïÊÖãËºâÂÖ• -->
                </div>
                <div class="flex justify-end mt-6">
                    <button onclick="closeModal('patientDetailModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium">
                        ÈóúÈñâ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ‰∏≠Ëó•Ë©≥ÊÉÖË¶ñÁ™ó -->
    <div id="herbDetailModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto fade-in">
            <div class="bg-amber-600 text-white p-6 rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">üåø ‰∏≠Ëó•Ë©≥ÊÉÖ</h3>
                    <button onclick="closeModal('herbDetailModal')" class="text-white hover:text-amber-200 text-2xl">√ó</button>
                </div>
            </div>
            <div class="p-6">
                <div id="herbDetailContent" class="space-y-4">
                    <!-- ‰∏≠Ëó•Ë©≥ÊÉÖÂÖßÂÆπÊúÉÂãïÊÖãËºâÂÖ• -->
                </div>
                <div class="flex justify-end mt-6">
                    <button onclick="closeModal('herbDetailModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium">
                        ÈóúÈñâ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÊñπÂäëË©≥ÊÉÖË¶ñÁ™ó -->
    <div id="formulaDetailModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto fade-in">
            <div class="bg-blue-600 text-white p-6 rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">üìú ÊñπÂäëË©≥ÊÉÖ</h3>
                    <button onclick="closeModal('formulaDetailModal')" class="text-white hover:text-blue-200 text-2xl">√ó</button>
                </div>
            </div>
            <div class="p-6">
                <div id="formulaDetailContent" class="space-y-4">
                    <!-- ÊñπÂäëË©≥ÊÉÖÂÖßÂÆπÊúÉÂãïÊÖãËºâÂÖ• -->
                </div>
                <div class="flex justify-end mt-6">
                    <button onclick="closeModal('formulaDetailModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium">
                        ÈóúÈñâ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÊµÆÂãïÈÄöÁü• -->
    <div id="floatingNotification" class="fixed top-4 right-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-2xl border-l-4 p-4 max-w-sm transform translate-x-full transition-transform duration-300 ease-out">
            <div class="flex items-start">
                <div id="notificationIcon" class="flex-shrink-0 w-6 h-6 mr-3 mt-0.5"></div>
                <div class="flex-1">
                    <p id="notificationMessage" class="text-sm text-gray-800 font-medium"></p>
                </div>
                <button onclick="hideNotification()" class="flex-shrink-0 ml-2 text-gray-400 hover:text-gray-600">
                    <span class="text-lg">√ó</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Á¢∫Ë™çÂà™Èô§Ë¶ñÁ™ó -->
    <div id="confirmDeleteModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full fade-in">
            <div class="bg-red-600 text-white p-6 rounded-t-2xl text-center">
                <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-3xl">‚ö†Ô∏è</span>
                </div>
                <h3 class="text-xl font-bold">Á¢∫Ë™çÂà™Èô§</h3>
            </div>
            <div class="p-6 text-center">
                <p class="text-gray-700 mb-6">Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§È†ÖÁõÆÂóéÔºü<br>Ê≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ</p>
                <div class="flex space-x-4">
                    <button onclick="closeModal('confirmDeleteModal')" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg font-medium">
                        ÂèñÊ∂à
                    </button>
                    <button id="confirmDeleteBtn" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg font-medium">
                        Á¢∫ÂÆöÂà™Èô§
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Êí§ÂõûÁ¢∫Ë™çË¶ñÁ™ó -->
    <div id="withdrawModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full fade-in">
            <div class="bg-orange-600 text-white p-6 rounded-t-2xl text-center">
                <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-3xl">‚Ü©Ô∏è</span>
                </div>
                <h3 class="text-xl font-bold">Á¢∫Ë™çÊí§ÂõûÊéõËôü</h3>
            </div>
            <div class="p-6">
                <div id="withdrawInfo" class="bg-orange-50 rounded-lg p-4 mb-6">
                    <!-- Êí§ÂõûË≥áË®äÊúÉÂãïÊÖãËºâÂÖ• -->
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                    <div class="flex items-start">
                        <span class="text-yellow-600 text-lg mr-2">‚ö†Ô∏è</span>
                        <div class="text-sm text-yellow-800">
                            <p class="font-medium mb-1">Êí§ÂõûË™™ÊòéÔºö</p>
                            <ul class="list-disc list-inside space-y-1 text-xs">
                                <li>Êí§ÂõûÂæåÁãÄÊÖãÂ∞áÈáçÁΩÆÁÇ∫„ÄåÂ∑≤ÊéõËôü„Äç</li>
                                <li>Â¶ÇÊúâÂ°´ÂØ´ÁöÑÁóÖÊ≠∑ËçâÁ®øÂ∞áË¢´‰øùÁïô</li>
                                <li>Êìç‰ΩúË®òÈåÑÂ∞áË¢´ÂÆåÊï¥‰øùÂ≠ò</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="flex space-x-4">
                    <button onclick="closeModal('withdrawModal')" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 px-4 rounded-lg font-medium">
                        ÂèñÊ∂à
                    </button>
                    <button id="confirmWithdrawBtn" class="flex-1 bg-orange-600 hover:bg-orange-700 text-white py-3 px-4 rounded-lg font-medium">
                        Á¢∫Ë™çÊí§Âõû
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÁóÖÊ≠∑Ë©≥ÊÉÖË¶ñÁ™ó -->
    <div id="medicalRecordDetailModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto fade-in">
            <div class="bg-blue-600 text-white p-6 rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">üìã ÁóÖÊ≠∑Ë©≥ÊÉÖ</h3>
                    <button onclick="closeModal('medicalRecordDetailModal')" class="text-white hover:text-blue-200 text-2xl">√ó</button>
                </div>
            </div>
            <div class="p-6">
                <div id="medicalRecordDetailContent" class="space-y-6">
                    <!-- ÁóÖÊ≠∑Ë©≥ÊÉÖÂÖßÂÆπÊúÉÂãïÊÖãËºâÂÖ• -->
                </div>
                <div class="flex justify-end mt-6 pt-6 border-t border-gray-200">
                    <button onclick="closeModal('medicalRecordDetailModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium">
                        ÈóúÈñâ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Á∑®ËºØ‰∏≠Ëó•Ë¶ñÁ™ó -->
    <div id="editHerbModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full fade-in">
            <div class="bg-green-600 text-white p-6 rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">üåø Á∑®ËºØ‰∏≠Ëó•</h3>
                    <button onclick="closeModal('editHerbModal')" class="text-white hover:text-green-200 text-2xl">√ó</button>
                </div>
            </div>
            <div class="p-6">
                <form onsubmit="updateHerbModal(event)" class="space-y-4">
                    <input type="hidden" id="modalEditHerbId">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‰∏≠Ëó•ÂêçÁ®± *</label>
                        <input type="text" id="modalEditHerbName" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                    <div class="flex space-x-4 pt-4">
                        <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium">
                            Êõ¥Êñ∞‰∏≠Ëó•
                        </button>
                        <button type="button" onclick="closeModal('editHerbModal')" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium">
                            ÂèñÊ∂à
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Á∑®ËºØÊñπÂäëË¶ñÁ™ó -->
    <div id="editFormulaModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto fade-in">
            <div class="bg-blue-600 text-white p-6 rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">üìú Á∑®ËºØÊñπÂäë</h3>
                    <button onclick="closeModal('editFormulaModal')" class="text-white hover:text-blue-200 text-2xl">√ó</button>
                </div>
            </div>
            <div class="p-6">
                <form onsubmit="updateFormulaModal(event)" class="space-y-4">
                    <input type="hidden" id="modalEditFormulaId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÊñπÂäëÂêçÁ®± *</label>
                            <input type="text" id="modalEditFormulaName" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Âá∫Ëôï</label>
                            <input type="text" id="modalEditFormulaSource" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Â¶ÇÔºö„ÄäÂÇ∑ÂØíË´ñ„Äã">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÁµÑÊàê *</label>
                            
                            <!-- ‰∏≠Ëó•ÊêúÂ∞ãÂíåÊ∑ªÂä† -->
                            <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                                <div class="flex items-center space-x-2 mb-3">
                                    <div class="relative flex-1">
                                        <input type="text" id="modalEditHerbSearchInput" placeholder="ÊêúÂ∞ã‰∏≠Ëó•ÂêçÁ®±..." 
                                               oninput="searchHerbsForModalEditFormula()" 
                                               onfocus="showModalEditHerbSearchResults()"
                                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                            </svg>
                                        </div>
                                        
                                        <!-- ÊêúÂ∞ãÁµêÊûú‰∏ãÊãâÈÅ∏ÂñÆ -->
                                        <div id="modalEditHerbSearchResults" class="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-40 overflow-y-auto z-10 hidden">
                                            <div id="modalEditHerbSearchResultsList" class="py-1">
                                                <!-- ÊêúÂ∞ãÁµêÊûúÊúÉÂãïÊÖãËºâÂÖ• -->
                                            </div>
                                        </div>
                                    </div>
                                    <input type="number" id="modalEditHerbDosageInput" placeholder="ÂäëÈáè(g)" min="0.1" step="0.1" 
                                           class="w-24 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <button type="button" onclick="addHerbToModalEditFormula()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">
                                        Ê∑ªÂä†
                                    </button>
                                </div>
                                
                                <!-- Â∑≤ÈÅ∏‰∏≠Ëó•È°ØÁ§∫ -->
                                <div id="modalEditSelectedHerbsDisplay" class="space-y-2">
                                    <!-- Â∑≤ÈÅ∏‰∏≠Ëó•ÊúÉÂãïÊÖãÈ°ØÁ§∫ -->
                                </div>
                            </div>
                            
                            <!-- ÊúÄÁµÇÁµÑÊàêÊñáÂ≠ó -->
                            <textarea id="modalEditFormulaComposition" rows="3" required readonly 
                                      class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                      placeholder="Ë´ã‰ΩøÁî®‰∏äÊñπÊêúÂ∞ãÂäüËÉΩÊ∑ªÂä†‰∏≠Ëó•..."></textarea>
                            <p class="text-xs text-gray-500 mt-1">üí° ‰ΩøÁî®‰∏äÊñπÊêúÂ∞ãÂäüËÉΩÊ∑ªÂä†‰∏≠Ëó•ÔºåÁ≥ªÁµ±ÊúÉËá™ÂãïÁîüÊàêÁµÑÊàêÊñáÂ≠ó</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ê≥®ÊÑè‰∫ãÈ†Ö</label>
                            <input type="text" id="modalEditFormulaPrecautions" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Á¶ÅÂøåÊàñÊ≥®ÊÑè‰∫ãÈ†Ö">
                        </div>
                    </div>
                    <div class="flex space-x-4 pt-4">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium">
                            Êõ¥Êñ∞ÊñπÂäë
                        </button>
                        <button type="button" onclick="closeModal('editFormulaModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium">
                            ÂèñÊ∂à
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ÂäüËÉΩË™™ÊòéË¶ñÁ™ó -->
    <div id="featureModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full fade-in">
            <div class="bg-purple-600 text-white p-6 rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">üîß ÂäüËÉΩË™™Êòé</h3>
                    <button onclick="closeModal('featureModal')" class="text-white hover:text-purple-200 text-2xl">√ó</button>
                </div>
            </div>
            <div class="p-6">
                <div class="text-center mb-4">
                    <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-3xl">‚öôÔ∏è</span>
                    </div>
                </div>
                <p id="featureMessage" class="text-gray-700 text-center mb-6"></p>
                <div class="flex justify-center">
                    <button onclick="closeModal('featureModal')" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-medium">
                        ‰∫ÜËß£
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Á≥ªÁµ±Êï∏Êìö
        let currentUser = null;
        let patients = [
            { id: 1, patientNumber: 'P001', name: 'ÁéãÂ∞èÊòé', gender: 'Áî∑', birthDate: '1988-05-15', phone: '0912-345-678', address: 'Âè∞ÂåóÂ∏Ç‰ø°Áæ©ÂçÄ', idNumber: 'A123456789' },
            { id: 2, patientNumber: 'P002', name: 'ÊùéÂ∞èËèØ', gender: 'Â•≥', birthDate: '1995-08-22', phone: '0923-456-789', address: 'Âè∞ÂåóÂ∏ÇÂ§ßÂÆâÂçÄ', idNumber: 'B234567890' },
            { id: 3, patientNumber: 'P003', name: 'ÂºµÂ§ßÂêå', gender: 'Áî∑', birthDate: '1978-12-03', phone: '0934-567-890', address: 'Êñ∞ÂåóÂ∏ÇÊùøÊ©ãÂçÄ', idNumber: 'C345678901' }
        ];
        let appointments = []; // ÊéõËôüË®òÈåÑ
        let patientStatus = {}; // ÁóÖ‰∫∫Ë®∫ÁóáÁãÄÊÖã
        let consultations = [];
        let nextPatientId = 4;

        // ‰∏≠Ëó•Â∫´Êï∏Êìö
        let herbs = [
            {
                id: 1,
                name: 'ÁîòËçâ'
            },
            {
                id: 2,
                name: '‰∫∫ÂèÉ'
            },
            {
                id: 3,
                name: 'Áï∂Ê≠∏'
            }
        ];
        let nextHerbId = 4;

        // ÊñπÂäëÂ∫´Êï∏Êìö
        let formulas = [
            {
                id: 1,
                name: 'ÂõõÂêõÂ≠êÊπØ',
                source: '„ÄäÂ§™Âπ≥ÊÉ†Ê∞ëÂíåÂäëÂ±ÄÊñπ„Äã',
                composition: '‰∫∫ÂèÉ9gÔºåÁôΩÊúÆ9gÔºåËåØËãì9gÔºåÁîòËçâ6g',
                precautions: 'Èô∞ËôõÁÅ´Êó∫ÊàñÂØ¶ÁÜ±Ë≠âÂøåÁî®'
            },
            {
                id: 2,
                name: 'ÂõõÁâ©ÊπØ',
                source: '„ÄäÂ§™Âπ≥ÊÉ†Ê∞ëÂíåÂäëÂ±ÄÊñπ„Äã',
                composition: 'Áï∂Ê≠∏10gÔºåÂ∑ùËäé8gÔºåÁôΩËäç12gÔºåÁÜüÂú∞ÈªÉ12g',
                precautions: 'Èô∞ËôõÊúâÁÜ±„ÄÅË°ÄÂ¥©Ê∞£ËÑ´ËÄÖÂøåÁî®'
            },
            {
                id: 3,
                name: 'ÈÄçÈÅôÊï£',
                source: '„ÄäÂ§™Âπ≥ÊÉ†Ê∞ëÂíåÂäëÂ±ÄÊñπ„Äã',
                composition: 'Êü¥ËÉ°8gÔºåÁï∂Ê≠∏10gÔºåÁôΩËäç12gÔºåÁôΩÊúÆ10gÔºåËåØËãì12gÔºåÁîòËçâ6gÔºåËñÑËç∑3gÔºåÁîüËñë3Áâá',
                precautions: 'Èô∞ËôõÁÅ´Êó∫ËÄÖÊÖéÁî®'
            }
        ];
        let nextFormulaId = 4;

        let currentFilter = 'all';
        
        // ÊñπÂäëÁµÑÊàêÁÆ°ÁêÜ
        let selectedHerbsForFormula = []; // ÂÑ≤Â≠òÈÅ∏‰∏≠ÁöÑ‰∏≠Ëó•ÂíåÂäëÈáè
        let selectedHerbsForEditFormula = []; // Á∑®ËºØÊñπÂäëÊôÇÂÑ≤Â≠òÈÅ∏‰∏≠ÁöÑ‰∏≠Ëó•ÂíåÂäëÈáè
        let selectedHerbsForModalEditFormula = []; // Ë¶ñÁ™óÁ∑®ËºØÊñπÂäëÊôÇÂÑ≤Â≠òÈÅ∏‰∏≠ÁöÑ‰∏≠Ëó•ÂíåÂäëÈáè
        
        // ÁóÖÊ≠∑Ë®òÈåÑ
        let medicalRecords = [];
        let nextRecordId = 1;

        // Ë®àÁÆóÂπ¥ÈΩ°ÂáΩÊï∏
        function calculateAge(birthDate) {
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            
            return age;
        }

        // Áî®Êà∂Ê¨äÈôêË®≠ÂÆö
        const userPermissions = {
            admin: ['patientManagement', 'consultationSystem', 'herbalLibrary', 'systemManagement'],
            doctor: ['patientManagement', 'consultationSystem', 'herbalLibrary', 'systemManagement'],
            assistant: ['patientManagement', 'consultationSystem', 'herbalLibrary', 'systemManagement']
        };

        const userNames = {
            admin: 'ÁÆ°ÁêÜÂì°',
            doctor: 'ÈÜ´Â∏´',
            assistant: 'Ë®∫ÊâÄÂä©ÁêÜ'
        };

        // ÁôªÂÖ•ÂäüËÉΩ
        function login(userType) {
            currentUser = userType;
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainSystem').classList.remove('hidden');
            document.getElementById('userRole').textContent = userNames[userType];
            document.getElementById('sidebarUserRole').textContent = userNames[userType];
            loadSidebarMenu();
            showWelcome(); // È†êË®≠È°ØÁ§∫Ê≠°ËøéÈ†ÅÈù¢
        }

        // ÁôªÂá∫ÂäüËÉΩ
        function logout() {
            currentUser = null;
            document.getElementById('mainSystem').classList.add('hidden');
            document.getElementById('loginPage').classList.remove('hidden');
            closeSidebar();
            hideAllPages();
        }

        // ÈñãÂïüÂÅ¥ÈÇäÈÅ∏ÂñÆ
        function openSidebar() {
            document.getElementById('sidebar').classList.remove('-translate-x-full');
            document.getElementById('sidebarOverlay').classList.remove('hidden');
        }

        // ÈóúÈñâÂÅ¥ÈÇäÈÅ∏ÂñÆ
        function closeSidebar() {
            document.getElementById('sidebar').classList.add('-translate-x-full');
            document.getElementById('sidebarOverlay').classList.add('hidden');
        }

        // ËºâÂÖ•ÂÅ¥ÈÇäÈÅ∏ÂñÆ
        function loadSidebarMenu() {
            const menuContainer = document.getElementById('sidebarMenu');
            const permissions = userPermissions[currentUser];
            
            const menuItems = {
                patientManagement: {
                    title: 'ÁóÖ‰∫∫Ë≥áÊñôÁÆ°ÁêÜ',
                    desc: 'Êñ∞Â¢û„ÄÅÊü•Áúã„ÄÅÁ∑®ËºØÁóÖ‰∫∫Ë≥áÊñô',
                    action: 'showPatientManagement()'
                },
                consultationSystem: {
                    title: 'Ë®∫ÁóáÁ≥ªÁµ±',
                    desc: 'ÈÄ≤Ë°åË®∫Áóá„ÄÅÈñãÁ´ãËôïÊñπ',
                    action: 'showConsultationSystem()'
                },
                herbalLibrary: {
                    title: '‰∏≠Ëó•ÂèäÊñπÂäëÂ∫´',
                    desc: 'Êü•Áúã‰∏≠Ëó•Ë≥áË®äÂèäÊñπÂäë',
                    action: 'showHerbalLibrary()'
                },

                systemManagement: {
                    title: 'Á≥ªÁµ±ÁÆ°ÁêÜ',
                    desc: 'Áî®Êà∂ÁÆ°ÁêÜ„ÄÅÊï∏ÊìöÁµ±Ë®à',
                    action: 'showSystemManagement()'
                }
            };

            menuContainer.innerHTML = permissions.map(permission => {
                const item = menuItems[permission];
                return `
                    <div class="px-4 mb-2">
                        <button onclick="${item.action}; closeSidebar();" class="w-full text-left p-4 rounded-lg hover:bg-gray-100 transition-colors group">
                            <div class="font-medium text-gray-800 group-hover:text-green-600">${item.title}</div>
                            <div class="text-sm text-gray-500 mt-1">${item.desc}</div>
                        </button>
                    </div>
                `;
            }).join('');
        }

        // È°ØÁ§∫Ê≠°ËøéÈ†ÅÈù¢
        function showWelcome() {
            hideAllPages();
            document.getElementById('welcomeMessage').classList.remove('hidden');
        }

        // Èö±ËóèÊâÄÊúâÈ†ÅÈù¢
        function hideAllPages() {
            const pages = ['welcomeMessage', 'patientManagement', 'addPatientForm', 'editPatientForm', 'consultationSystem', 'appointmentForm', 'medicalRecordForm', 'herbalLibrary', 'addHerbForm', 'editHerbForm', 'addFormulaForm', 'editFormulaForm', 'patientMedicalRecords', 'systemManagement', 'statisticsPage'];
            pages.forEach(page => {
                document.getElementById(page).classList.add('hidden');
            });
        }

        // È°ØÁ§∫ÁóÖ‰∫∫ÁÆ°ÁêÜ
        function showPatientManagement() {
            hideAllPages();
            document.getElementById('patientManagement').classList.remove('hidden');
            document.getElementById('patientSearchInput').value = '';
            loadPatientList();
        }

        // ËºâÂÖ•ÁóÖ‰∫∫ÂàóË°®
        function loadPatientList(filteredPatients = null) {
            const tbody = document.getElementById('patientList');
            const patientsToShow = filteredPatients || patients;
            
            if (patientsToShow.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="border border-gray-200 px-4 py-8 text-center text-gray-500">
                            ${filteredPatients ? 'Ê≤íÊúâÊâæÂà∞Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑÁóÖ‰∫∫' : 'Êö´ÁÑ°ÁóÖ‰∫∫Ë≥áÊñô'}
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = patientsToShow.map(patient => `
                <tr class="hover:bg-gray-50">
                    <td class="border border-gray-200 px-4 py-3 font-mono text-blue-600">${patient.patientNumber}</td>
                    <td class="border border-gray-200 px-4 py-3">${patient.name}</td>
                    <td class="border border-gray-200 px-4 py-3">${patient.gender}</td>
                    <td class="border border-gray-200 px-4 py-3">${calculateAge(patient.birthDate)}</td>
                    <td class="border border-gray-200 px-4 py-3">${patient.phone}</td>
                    <td class="border border-gray-200 px-4 py-3">
                        <button onclick="viewPatient(${patient.id})" class="text-blue-600 hover:text-blue-800 mr-2">Êü•Áúã</button>
                        <button onclick="viewPatientMedicalRecords(${patient.id})" class="text-purple-600 hover:text-purple-800 mr-2">ÁóÖÊ≠∑Ë®òÈåÑ</button>
                        <button onclick="editPatient(${patient.id})" class="text-green-600 hover:text-green-800 mr-2">Á∑®ËºØ</button>
                        <button onclick="deletePatient(${patient.id})" class="text-red-600 hover:text-red-800">Âà™Èô§</button>
                    </td>
                </tr>
            `).join('');
        }

        // ÊêúÁ¥¢ÁóÖ‰∫∫ÂäüËÉΩ
        function searchPatients() {
            const searchTerm = document.getElementById('patientSearchInput').value.toLowerCase().trim();
            
            if (searchTerm === '') {
                loadPatientList();
                return;
            }
            
            const filteredPatients = patients.filter(patient => 
                patient.name.toLowerCase().includes(searchTerm) ||
                patient.phone.includes(searchTerm) ||
                patient.gender.includes(searchTerm) ||
                patient.patientNumber.toLowerCase().includes(searchTerm) ||
                calculateAge(patient.birthDate).toString().includes(searchTerm)
            );
            
            loadPatientList(filteredPatients);
        }

        // È°ØÁ§∫Êñ∞Â¢ûÁóÖ‰∫∫Ë°®ÂñÆ
        function showAddPatientForm() {
            hideAllPages();
            document.getElementById('addPatientForm').classList.remove('hidden');
            // Ê∏ÖÁ©∫Ë°®ÂñÆ
            document.getElementById('patientName').value = '';
            document.getElementById('patientIdNumber').value = '';
            document.getElementById('patientGender').value = '';
            document.getElementById('patientBirthDate').value = '';
            document.getElementById('patientPhone').value = '';
            document.getElementById('patientAddress').value = '';
        }

        // Êñ∞Â¢ûÁóÖ‰∫∫
        function addPatient(event) {
            event.preventDefault();
            
            const newPatient = {
                id: nextPatientId++,
                patientNumber: 'P' + (nextPatientId - 1).toString().padStart(3, '0'),
                name: document.getElementById('patientName').value,
                idNumber: document.getElementById('patientIdNumber').value.toUpperCase(),
                gender: document.getElementById('patientGender').value,
                birthDate: document.getElementById('patientBirthDate').value,
                phone: document.getElementById('patientPhone').value,
                address: document.getElementById('patientAddress').value
            };
            
            patients.push(newPatient);
            showNotification('ÁóÖ‰∫∫Ë≥áÊñôÊñ∞Â¢ûÊàêÂäüÔºÅÁóÖ‰∫∫Á∑®ËôüÔºö' + newPatient.patientNumber);
            showPatientManagement();
        }

        // Êü•ÁúãÁóÖ‰∫∫Ë©≥ÊÉÖ
        function viewPatient(id) {
            const patient = patients.find(p => p.id === id);
            if (patient) {
                const content = `
                    <div class="space-y-3">
                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                            <span class="font-medium text-gray-600">ÁóÖ‰∫∫Á∑®ËôüÔºö</span>
                            <span class="text-blue-600 font-mono font-bold">${patient.patientNumber}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                            <span class="font-medium text-gray-600">ÂßìÂêçÔºö</span>
                            <span class="text-gray-800">${patient.name}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                            <span class="font-medium text-gray-600">Ë∫´‰ªΩË≠âÔºö</span>
                            <span class="text-gray-800">${patient.idNumber}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                            <span class="font-medium text-gray-600">ÊÄßÂà•Ôºö</span>
                            <span class="text-gray-800">${patient.gender}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                            <span class="font-medium text-gray-600">Âá∫ÁîüÊó•ÊúüÔºö</span>
                            <span class="text-gray-800">${patient.birthDate}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                            <span class="font-medium text-gray-600">Âπ¥ÈΩ°Ôºö</span>
                            <span class="text-gray-800">${calculateAge(patient.birthDate)} Ê≠≤</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                            <span class="font-medium text-gray-600">ÈõªË©±Ôºö</span>
                            <span class="text-gray-800">${patient.phone}</span>
                        </div>
                        <div class="py-2">
                            <span class="font-medium text-gray-600">Âú∞ÂùÄÔºö</span>
                            <div class="text-gray-800 mt-1">${patient.address || 'Êú™Â°´ÂØ´'}</div>
                        </div>
                    </div>
                `;
                document.getElementById('patientDetailContent').innerHTML = content;
                showModal('patientDetailModal');
            }
        }

        // Á∑®ËºØÁóÖ‰∫∫ÔºàÂÉÖÁÆ°ÁêÜÂì°Ôºâ
        function editPatient(id) {
            const patient = patients.find(p => p.id === id);
            if (patient) {
                hideAllPages();
                document.getElementById('editPatientForm').classList.remove('hidden');
                
                // Â°´ÂÖ•ÁèæÊúâË≥áÊñô
                document.getElementById('editPatientId').value = patient.id;
                document.getElementById('editPatientName').value = patient.name;
                document.getElementById('editPatientIdNumber').value = patient.idNumber;
                document.getElementById('editPatientGender').value = patient.gender;
                document.getElementById('editPatientBirthDate').value = patient.birthDate;
                document.getElementById('editPatientPhone').value = patient.phone;
                document.getElementById('editPatientAddress').value = patient.address || '';
            }
        }

        // Êõ¥Êñ∞ÁóÖ‰∫∫Ë≥áÊñô
        function updatePatient(event) {
            event.preventDefault();
            
            const patientId = parseInt(document.getElementById('editPatientId').value);
            const patientIndex = patients.findIndex(p => p.id === patientId);
            
            if (patientIndex !== -1) {
                patients[patientIndex] = {
                    id: patientId,
                    patientNumber: patients[patientIndex].patientNumber, // ‰øùÁïôÂéüÁ∑®Ëôü
                    name: document.getElementById('editPatientName').value,
                    idNumber: document.getElementById('editPatientIdNumber').value.toUpperCase(),
                    gender: document.getElementById('editPatientGender').value,
                    birthDate: document.getElementById('editPatientBirthDate').value,
                    phone: document.getElementById('editPatientPhone').value,
                    address: document.getElementById('editPatientAddress').value
                };
                
                showNotification('ÁóÖ‰∫∫Ë≥áÊñôÊõ¥Êñ∞ÊàêÂäüÔºÅ');
                showPatientManagement();
            }
        }

        // Âà™Èô§ÁóÖ‰∫∫ÔºàÂÉÖÁÆ°ÁêÜÂì°Ôºâ
        function deletePatient(id) {
            document.getElementById('confirmDeleteBtn').onclick = function() {
                patients = patients.filter(p => p.id !== id);
                loadPatientList();
                closeModal('confirmDeleteModal');
                showNotification('ÁóÖ‰∫∫Ë≥áÊñôÂ∑≤Âà™Èô§');
            };
            showModal('confirmDeleteModal');
        }

        // È°ØÁ§∫Ë®∫ÁóáÁ≥ªÁµ±
        function showConsultationSystem() {
            hideAllPages();
            document.getElementById('consultationSystem').classList.remove('hidden');
            loadAppointmentList();
        }

        // È°ØÁ§∫ÊéõËôüË°®ÂñÆ
        function showAppointmentForm() {
            hideAllPages();
            document.getElementById('appointmentForm').classList.remove('hidden');
            document.getElementById('appointmentSearchInput').value = '';
            document.getElementById('selectedPatientId').value = '';
            document.getElementById('selectedPatientInfo').classList.add('hidden');
            document.getElementById('searchResults').classList.add('hidden');
            document.getElementById('appointmentSymptoms').value = ''; // Ê∏ÖÁ©∫ÁóáÁãÄÊèèËø∞Ê¨Ñ‰Ωç
            
            // Ë®≠ÂÆöÈ†êË®≠ÊôÇÈñìÁÇ∫ÁèæÂú®
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('appointmentTime').value = now.toISOString().slice(0, 16);
        }

        // ÊêúÁ¥¢ÊéõËôüÁóÖ‰∫∫ÂäüËÉΩ
        function searchAppointmentPatients() {
            const searchTerm = document.getElementById('appointmentSearchInput').value.toLowerCase().trim();
            const searchResults = document.getElementById('searchResults');
            const searchResultsList = document.getElementById('searchResultsList');
            
            if (searchTerm === '') {
                searchResults.classList.add('hidden');
                return;
            }
            
            const filteredPatients = patients.filter(patient => 
                patient.name.toLowerCase().includes(searchTerm) ||
                patient.phone.includes(searchTerm) ||
                patient.gender.includes(searchTerm) ||
                patient.patientNumber.toLowerCase().includes(searchTerm) ||
                calculateAge(patient.birthDate).toString().includes(searchTerm)
            );
            
            if (filteredPatients.length === 0) {
                searchResultsList.innerHTML = '<div class="px-4 py-3 text-gray-500 text-sm">Ê≤íÊúâÊâæÂà∞Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑÁóÖ‰∫∫</div>';
            } else {
                searchResultsList.innerHTML = filteredPatients.map(patient => `
                    <div class="px-4 py-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0" 
                         onclick="selectPatient(${patient.id})">
                        <div class="font-medium text-gray-900">
                            <span class="text-blue-600 font-mono">${patient.patientNumber}</span> - ${patient.name}
                        </div>
                        <div class="text-sm text-gray-500">
                            ${patient.gender} ¬∑ ${calculateAge(patient.birthDate)}Ê≠≤ ¬∑ ${patient.phone}
                        </div>
                    </div>
                `).join('');
            }
            
            searchResults.classList.remove('hidden');
        }

        // È°ØÁ§∫ÊêúÁ¥¢ÁµêÊûú
        function showSearchResults() {
            const searchTerm = document.getElementById('appointmentSearchInput').value.trim();
            if (searchTerm !== '') {
                searchAppointmentPatients();
            }
        }

        // ÈÅ∏ÊìáÁóÖ‰∫∫
        function selectPatient(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (patient) {
                document.getElementById('selectedPatientId').value = patientId;
                document.getElementById('appointmentSearchInput').value = '';
                document.getElementById('searchResults').classList.add('hidden');
                document.getElementById('selectedPatientInfo').classList.remove('hidden');
                document.getElementById('selectedPatientDisplay').textContent = 
                    `${patient.patientNumber} - ${patient.name} (${patient.gender}, ${calculateAge(patient.birthDate)}Ê≠≤)`;
            }
        }

        // Ê∏ÖÈô§ÈÅ∏‰∏≠ÁöÑÁóÖ‰∫∫
        function clearSelectedPatient() {
            document.getElementById('selectedPatientId').value = '';
            document.getElementById('selectedPatientInfo').classList.add('hidden');
            document.getElementById('appointmentSearchInput').focus();
        }

        // Êñ∞Â¢ûÊéõËôü
        function addAppointment(event) {
            event.preventDefault();
            
            const patientId = parseInt(document.getElementById('selectedPatientId').value);
            if (!patientId) {
                showNotification('Ë´ãÂÖàÈÅ∏ÊìáÁóÖ‰∫∫', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === patientId);
            
            // Ê™¢Êü•‰ªäÊó•ÊòØÂê¶Â∑≤ÊéõËôü
            const today = new Date().toDateString();
            const existingAppointment = appointments.find(apt => 
                apt.patientId === patientId && 
                new Date(apt.appointmentTime).toDateString() === today &&
                apt.status !== 'Â∑≤ÂÆåÊàê'
            );
            
            if (existingAppointment) {
                showNotification(`ÁóÖ‰∫∫ ${patient.patientNumber} - ${patient.name} ‰ªäÊó•Â∑≤ÊéõËôüÔºÅÁãÄÊÖãÔºö${existingAppointment.status}`, 'info');
                return;
            }
            
            const appointment = {
                id: appointments.length + 1,
                patientId: patientId,
                patientName: patient.name,
                patientNumber: patient.patientNumber,
                appointmentTime: document.getElementById('appointmentTime').value,
                symptoms: document.getElementById('appointmentSymptoms').value,
                status: 'Â∑≤ÊéõËôü',
                createdAt: new Date().toISOString()
            };
            
            appointments.push(appointment);
            patientStatus[patientId] = 'Â∑≤ÊéõËôü';
            
            showNotification(`ÊéõËôüÊàêÂäüÔºÅÁóÖ‰∫∫Ôºö${patient.patientNumber} - ${patient.name}`);
            showConsultationSystem();
        }

        // ËºâÂÖ•ÊéõËôüÂàóË°®
        function loadAppointmentList() {
            const tbody = document.getElementById('appointmentList');
            const today = new Date().toDateString();
            const todayAppointments = appointments.filter(apt => 
                new Date(apt.appointmentTime).toDateString() === today
            );
            
            if (todayAppointments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="border border-gray-200 px-4 py-8 text-center text-gray-500">
                            ‰ªäÊó•Êö´ÁÑ°ÊéõËôüÁóÖ‰∫∫
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = todayAppointments.map(appointment => {
                const patient = patients.find(p => p.id === appointment.patientId);
                const appointmentDate = new Date(appointment.appointmentTime);
                const timeString = appointmentDate.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-200 px-4 py-3">${timeString}</td>
                        <td class="border border-gray-200 px-4 py-3">
                            <span class="font-mono text-blue-600 font-bold">${appointment.patientNumber || patient.patientNumber}</span>
                        </td>
                        <td class="border border-gray-200 px-4 py-3">${appointment.patientName}</td>
                        <td class="border border-gray-200 px-4 py-3">${calculateAge(patient.birthDate)}</td>
                        <td class="border border-gray-200 px-4 py-3">
                            ${getStatusBadge(appointment.status)}
                        </td>
                        <td class="border border-gray-200 px-4 py-3">
                            ${getStatusActions(appointment)}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Áç≤ÂèñÁãÄÊÖãÂæΩÁ´†
        function getStatusBadge(status) {
            const statusConfig = {
                'Â∑≤ÊéõËôü': { bg: 'bg-blue-500', text: 'text-white' },
                '‰æØË®∫‰∏≠': { bg: 'bg-yellow-500', text: 'text-white' },
                'Ë®∫Áóá‰∏≠': { bg: 'bg-green-500', text: 'text-white' },
                'Â∑≤ÂÆåÊàê': { bg: 'bg-gray-500', text: 'text-white' }
            };
            
            const config = statusConfig[status] || statusConfig['Â∑≤ÊéõËôü'];
            return `
                <span class="px-3 py-1 rounded-full text-sm font-medium ${config.bg} ${config.text}">
                    ${status}
                </span>
            `;
        }

        // Áç≤ÂèñÁãÄÊÖãÊìç‰ΩúÊåâÈàï
        function getStatusActions(appointment) {
            // Ê™¢Êü•ÊòØÂê¶ÊúâÂÖ∂‰ªñÁóÖ‰∫∫Ê≠£Âú®Ë®∫Áóá‰∏≠
            const hasActiveConsultation = appointments.some(apt => 
                apt.status === 'Ë®∫Áóá‰∏≠' && apt.id !== appointment.id
            );
            
            // Ê™¢Êü•ÊòØÂê¶ÊúâÁóÖÊ≠∑Ë®òÈåÑÔºàÂåÖÊã¨ËçâÁ®øÔºâ
            const hasRecord = medicalRecords.some(record => 
                record.appointmentId === appointment.id && 
                (record.status === 'completed' || record.status === 'draft')
            );
            
            const actions = {
                'Â∑≤ÊéõËôü': `
                    <div class="flex flex-col space-y-1">
                        <button onclick="updateAppointmentStatus(${appointment.id}, '‰æØË®∫‰∏≠')" 
                                ${hasActiveConsultation ? 'disabled' : ''} 
                                class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded-md text-xs font-medium transition-colors ${hasActiveConsultation ? 'opacity-50 cursor-not-allowed' : ''}">
                            ÈñãÂßã‰æØË®∫
                        </button>
                        <button onclick="deleteAppointment(${appointment.id})" 
                                ${hasActiveConsultation ? 'disabled' : ''} 
                                class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md text-xs font-medium transition-colors ${hasActiveConsultation ? 'opacity-50 cursor-not-allowed' : ''}">
                            Âà™Èô§ÊéõËôü
                        </button>
                        <button onclick="viewMedicalRecord(${appointment.id})" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded-md text-xs font-medium transition-colors">
                            ${hasRecord ? 'Êü•ÁúãÁóÖÊ≠∑' : 'Êü•ÁúãÁóÖÊ≠∑'}
                        </button>
                    </div>
                `,
                '‰æØË®∫‰∏≠': `
                    <div class="flex flex-col space-y-1">
                        <button onclick="startConsultation(${appointment.id})" 
                                ${hasActiveConsultation ? 'disabled' : ''} 
                                class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-md text-xs font-medium transition-colors ${hasActiveConsultation ? 'opacity-50 cursor-not-allowed' : ''}">
                            ÈñãÂßãË®∫Áóá
                        </button>
                        <button onclick="viewMedicalRecord(${appointment.id})" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded-md text-xs font-medium transition-colors">
                            ${hasRecord ? 'Êü•ÁúãÁóÖÊ≠∑' : 'Êü•ÁúãÁóÖÊ≠∑'}
                        </button>
                    </div>
                `,
                'Ë®∫Áóá‰∏≠': `
                    <div class="flex flex-col space-y-1">
                        <div class="bg-green-100 border border-green-300 rounded-md px-3 py-2">
                            <div class="flex items-center">
                                <div class="animate-pulse w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                                <span class="text-xs text-green-700 font-medium">Ë®∫ÁóáÈÄ≤Ë°å‰∏≠</span>
                            </div>
                        </div>
                        <button onclick="viewMedicalRecord(${appointment.id})" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded-md text-xs font-medium transition-colors">
                            ${hasRecord ? 'Êü•ÁúãÁóÖÊ≠∑' : 'Êü•ÁúãÁóÖÊ≠∑'}
                        </button>
                    </div>
                `,
                'Â∑≤ÂÆåÊàê': `
                    <div class="flex flex-col space-y-1">
                        <button onclick="editMedicalRecord(${appointment.id})" 
                                ${hasActiveConsultation ? 'disabled' : ''} 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md text-xs font-medium transition-colors ${hasActiveConsultation ? 'opacity-50 cursor-not-allowed' : ''}">
                            ‰øÆÊîπÁóÖÊ≠∑
                        </button>
                        <button onclick="withdrawAppointment(${appointment.id})" 
                                ${hasActiveConsultation ? 'disabled' : ''} 
                                class="bg-amber-500 hover:bg-amber-600 text-white px-3 py-1 rounded-md text-xs font-medium transition-colors ${hasActiveConsultation ? 'opacity-50 cursor-not-allowed' : ''}">
                            Êí§ÂõûÊéõËôü
                        </button>
                        <button onclick="viewMedicalRecord(${appointment.id})" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded-md text-xs font-medium transition-colors">
                            Êü•ÁúãÁóÖÊ≠∑
                        </button>
                    </div>
                `
            };
            
            return actions[appointment.status] || actions['Â∑≤ÊéõËôü'];
        }

        // ÈñãÂßãË®∫ÁóáÔºàÂ±ïÈñãÁóÖÊ≠∑Â°´ÂØ´Ôºâ
        function startConsultation(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (appointment) {
                // Êõ¥Êñ∞ÁãÄÊÖãÁÇ∫Ë®∫Áóá‰∏≠
                updateAppointmentStatus(appointmentId, 'Ë®∫Áóá‰∏≠');
                
                // Âú®Áï∂ÂâçÈ†ÅÈù¢Â±ïÈñãÁóÖÊ≠∑Â°´ÂØ´Ë°®ÂñÆ
                showInlineMedicalRecordForm(appointment);
            }
        }

        // Êõ¥Êñ∞ÊéõËôüÁãÄÊÖã
        function updateAppointmentStatus(appointmentId, newStatus) {
            // Ê™¢Êü•ÊòØÂê¶ÊúâÂÖ∂‰ªñÁóÖ‰∫∫Ê≠£Âú®Ë®∫Áóá‰∏≠
            const hasActiveConsultation = appointments.some(apt => 
                apt.status === 'Ë®∫Áóá‰∏≠' && apt.id !== appointmentId
            );
            
            if (hasActiveConsultation && (newStatus === '‰æØË®∫‰∏≠' || newStatus === 'Ë®∫Áóá‰∏≠')) {
                showNotification('ÁõÆÂâçÊúâÂÖ∂‰ªñÁóÖ‰∫∫Ê≠£Âú®Ë®∫Áóá‰∏≠ÔºåË´ãÁ≠âÂæÖË®∫ÁóáÂÆåÊàêÂæåÂÜçÈÄ≤Ë°åÊìç‰Ωú', 'error');
                return;
            }
            
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (appointment) {
                const oldStatus = appointment.status;
                appointment.status = newStatus;
                appointment.lastUpdated = new Date().toISOString();
                
                // Ë®òÈåÑÁãÄÊÖãËÆäÊõ¥Ê≠∑Âè≤
                if (!appointment.statusHistory) {
                    appointment.statusHistory = [];
                }
                appointment.statusHistory.push({
                    from: oldStatus,
                    to: newStatus,
                    timestamp: new Date().toISOString(),
                    updatedBy: currentUser
                });
                
                // Êõ¥Êñ∞ÁóÖ‰∫∫ÁãÄÊÖã
                patientStatus[appointment.patientId] = newStatus;
                
                // È°ØÁ§∫ÈÄöÁü•
                const patient = patients.find(p => p.id === appointment.patientId);
                showNotification(`${patient.name} ÁöÑÁãÄÊÖãÂ∑≤Êõ¥Êñ∞ÁÇ∫Ôºö${newStatus}`);
                
                // ÈáçÊñ∞ËºâÂÖ•ÂàóË°®
                loadAppointmentList();
            }
        }

        // Âà™Èô§ÊéõËôü
        function deleteAppointment(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (appointment) {
                const patient = patients.find(p => p.id === appointment.patientId);
                
                if (confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§ ${patient.name} ÁöÑÊéõËôüË®òÈåÑÂóéÔºü\n\nÊ≠§Êìç‰ΩúÂ∞áÊ∞∏‰πÖÂà™Èô§ÊéõËôüË®òÈåÑÔºåÁÑ°Ê≥ïÂæ©Âéü„ÄÇ`)) {
                    // Âà™Èô§ÊéõËôüË®òÈåÑ
                    appointments = appointments.filter(apt => apt.id !== appointmentId);
                    
                    // Ê∏ÖÈô§ÁóÖ‰∫∫ÁãÄÊÖã
                    delete patientStatus[appointment.patientId];
                    
                    // Âà™Èô§Áõ∏ÈóúÁöÑÁóÖÊ≠∑ËçâÁ®øÔºàÂ¶ÇÊûúÊúâÔºâ
                    medicalRecords = medicalRecords.filter(record => 
                        !(record.appointmentId === appointmentId && record.status === 'draft')
                    );
                    
                    showNotification(`Â∑≤Âà™Èô§ ${patient.name} ÁöÑÊéõËôüË®òÈåÑ`, 'info');
                    loadAppointmentList();
                }
            }
        }

        // Êí§ÂõûÊéõËôü
        function withdrawAppointment(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (appointment) {
                const patient = patients.find(p => p.id === appointment.patientId);
                const appointmentTime = new Date(appointment.appointmentTime);
                
                // Â°´ÂÖ•Êí§ÂõûË≥áË®ä
                const withdrawInfo = document.getElementById('withdrawInfo');
                withdrawInfo.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="font-medium text-gray-700">ÁóÖ‰∫∫ÂßìÂêçÔºö</span>
                            <span class="text-gray-900 font-semibold">${patient.name}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="font-medium text-gray-700">ÁóÖ‰∫∫Á∑®ËôüÔºö</span>
                            <span class="text-blue-600 font-mono">${patient.patientNumber}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="font-medium text-gray-700">Áï∂ÂâçÁãÄÊÖãÔºö</span>
                            <span class="px-2 py-1 rounded-full text-sm font-medium ${getStatusColor(appointment.status)}">${appointment.status}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="font-medium text-gray-700">ÊéõËôüÊôÇÈñìÔºö</span>
                            <span class="text-gray-900">${appointmentTime.toLocaleString('zh-TW')}</span>
                        </div>
                        ${appointment.symptoms ? `
                        <div class="pt-2 border-t border-orange-200">
                            <span class="font-medium text-gray-700">ÁóáÁãÄÊèèËø∞Ôºö</span>
                            <p class="text-gray-900 text-sm mt-1">${appointment.symptoms}</p>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                // Ë®≠ÂÆöÁ¢∫Ë™çÊåâÈàï‰∫ã‰ª∂
                document.getElementById('confirmWithdrawBtn').onclick = function() {
                    // Êí§ÂõûÂà∞Â∑≤ÊéõËôüÁãÄÊÖã
                    const oldStatus = appointment.status;
                    appointment.status = 'Â∑≤ÊéõËôü';
                    appointment.lastUpdated = new Date().toISOString();
                    
                    // Ë®òÈåÑÊí§ÂõûÊìç‰Ωú
                    if (!appointment.statusHistory) {
                        appointment.statusHistory = [];
                    }
                    appointment.statusHistory.push({
                        from: oldStatus,
                        to: 'Â∑≤ÊéõËôü',
                        timestamp: new Date().toISOString(),
                        updatedBy: currentUser,
                        action: 'withdraw'
                    });
                    
                    // Êõ¥Êñ∞ÁóÖ‰∫∫ÁãÄÊÖã
                    patientStatus[appointment.patientId] = 'Â∑≤ÊéõËôü';
                    
                    // Èö±ËóèÂÖßÂµåÁóÖÊ≠∑Ë°®ÂñÆÔºàÂ¶ÇÊûúÊ≠£Âú®È°ØÁ§∫Ôºâ
                    const inlineForm = document.getElementById('inlineMedicalRecord');
                    if (inlineForm) {
                        inlineForm.remove();
                    }
                    
                    closeModal('withdrawModal');
                    showNotification(`Â∑≤Êí§Âõû ${patient.name} ÁöÑÊéõËôüÔºåÁãÄÊÖãÈáçÁΩÆÁÇ∫„ÄåÂ∑≤ÊéõËôü„Äç`, 'info');
                    loadAppointmentList();
                };
                
                showModal('withdrawModal');
            }
        }
        
        // Áç≤ÂèñÁãÄÊÖãÈ°èËâ≤
        function getStatusColor(status) {
            const statusColors = {
                'Â∑≤ÊéõËôü': 'bg-blue-100 text-blue-800',
                '‰æØË®∫‰∏≠': 'bg-yellow-100 text-yellow-800',
                'Ë®∫Áóá‰∏≠': 'bg-green-100 text-green-800',
                'Â∑≤ÂÆåÊàê': 'bg-gray-100 text-gray-800'
            };
            return statusColors[status] || 'bg-blue-100 text-blue-800';
        }
        
        // ‰øÆÊîπÁóÖÊ≠∑ÂäüËÉΩ
        function editMedicalRecord(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            const existingRecord = medicalRecords.find(record => record.appointmentId === appointmentId);
            
            if (appointment && existingRecord) {
                // È°ØÁ§∫ÂÖßÂµåÁ∑®ËºØË°®ÂñÆÔºå‰∏¶Â°´ÂÖ•ÁèæÊúâË≥áÊñô
                showInlineMedicalRecordForm(appointment, existingRecord);
            } else {
                showNotification('Êâæ‰∏çÂà∞Áõ∏ÈóúÁöÑÁóÖÊ≠∑Ë®òÈåÑ', 'error');
            }
        }

        // Âú®Ë®∫ÁóáÁ≥ªÁµ±È†ÅÈù¢ÂÖßÂ±ïÈñãÁóÖÊ≠∑Â°´ÂØ´Ë°®ÂñÆ
        function showInlineMedicalRecordForm(appointment, existingRecord = null) {
            const patient = patients.find(p => p.id === appointment.patientId);
            
            // ÂâµÂª∫ÂÖßÂµåÁóÖÊ≠∑Â°´ÂØ´Ë°®ÂñÆ
            const medicalRecordHtml = `
                <div id="inlineMedicalRecord" class="mt-6 bg-blue-50 rounded-xl p-6 border-2 border-blue-200 fade-in">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-blue-800">üìã ${existingRecord ? '‰øÆÊîπÁóÖÊ≠∑' : 'ÁóÖÊ≠∑Â°´ÂØ´'}</h3>
                            <p class="text-sm text-blue-600 mt-1">
                                ÁóÖ‰∫∫Ôºö<strong>${patient.patientNumber} - ${patient.name}</strong> 
                                (${patient.gender}, ${calculateAge(patient.birthDate)}Ê≠≤)
                            </p>
                            ${existingRecord ? '<p class="text-xs text-orange-600 mt-1">‚ö†Ô∏è ‰øÆÊîπÊ®°ÂºèÔºöÊ≠£Âú®Á∑®ËºØÁèæÊúâÁóÖÊ≠∑</p>' : ''}
                        </div>

                    </div>
                    

                    
                    <form onsubmit="saveInlineMedicalRecord(event)" class="space-y-4">
                        <input type="hidden" id="inlineRecordPatientId" value="${appointment.patientId}">
                        <input type="hidden" id="inlineRecordAppointmentId" value="${appointment.id}">
                        
                        <!-- Á∞°ÂåñÁöÑÁóÖÊ≠∑Ë°®ÂñÆ -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">‰∏ªË®¥ *</label>
                                <textarea id="inlineChiefComplaint" rows="2" required 
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                    placeholder="ÁóÖ‰∫∫‰∏ªË¶ÅÁóáÁãÄ...">${existingRecord ? existingRecord.chiefComplaint : (appointment.symptoms || '')}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ÁèæÁóÖÂè≤</label>
                                <textarea id="inlinePresentIllness" rows="2" 
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                    placeholder="ÁóÖÊÉÖÁôºÂ±ïÈÅéÁ®ã...">${existingRecord ? existingRecord.presentIllness || '' : ''}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">‰∏≠ÈÜ´Ë®∫Êñ∑ *</label>
                                <input type="text" id="inlineTcmDiagnosis" required 
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                    placeholder="Â¶ÇÔºöÈ†≠Áóõ„ÄÅËÉÉËÑòÁóõÁ≠â..." value="${existingRecord ? existingRecord.tcmDiagnosis || '' : ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Ë≠âÂûãË®∫Êñ∑ *</label>
                                <input type="text" id="inlineSyndromePattern" required 
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                    placeholder="Â¶ÇÔºöËÇùÈôΩ‰∏ä‰∫¢Ë≠âÁ≠â..." value="${existingRecord ? existingRecord.syndromePattern || '' : ''}">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ËôïÊñπÂÖßÂÆπ *</label>
                            <textarea id="inlinePrescriptionContent" rows="4" required 
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                placeholder="Ë©≥Á¥∞Ëó•Áâ©ÁµÑÊàêÂèäÂäëÈáèÔºåÂ¶ÇÔºö&#10;Â§©È∫ª 10g&#10;Èâ§Ëó§ 15g&#10;Áü≥Ê±∫Êòé 30g&#10;...">${existingRecord ? existingRecord.prescriptionContent || '' : ''}</textarea>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ÊúçÁî®ÊñπÊ≥ï *</label>
                                <input type="text" id="inlineDosageInstructions" required 
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                    placeholder="Â¶ÇÔºöÊ∞¥ÁÖéÊúçÔºåÊó•‰∫åÊ¨°ÔºåÈ£ØÂæåÊ∫´Êúç" value="${existingRecord ? existingRecord.dosageInstructions || '' : ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ÁôÇÁ®ã</label>
                                <input type="text" id="inlineTreatmentDuration" 
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                    placeholder="Â¶ÇÔºö7ÂäëÔºå‰∏ÄÈÄ±ÂæåË§áË®∫" value="${existingRecord ? existingRecord.treatmentDuration || '' : ''}">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ÈÜ´ÂõëÂèäÊ≥®ÊÑè‰∫ãÈ†Ö</label>
                            <textarea id="inlineMedicalAdvice" rows="2" 
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                placeholder="È£≤È£üÂÆúÂøå„ÄÅÁîüÊ¥ªË™øÁêÜÁ≠â...">${existingRecord ? existingRecord.medicalAdvice || '' : ''}</textarea>
                        </div>
                        
                        <!-- Êìç‰ΩúÊåâÈàï -->
                        <div class="flex space-x-3 pt-4 border-t border-blue-200">
                            ${existingRecord ? `
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium text-sm">
                                Êõ¥Êñ∞ÁóÖÊ≠∑
                            </button>
                            ` : `
                            <button type="button" onclick="saveInlineDraft()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium text-sm">
                                ÂÑ≤Â≠òÁóÖÊ≠∑
                            </button>
                            `}
                            <button type="button" onclick="hideInlineMedicalRecord()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium text-sm">
                                ÂèñÊ∂à
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            // Â∞áË°®ÂñÆÊèíÂÖ•Âà∞Ë®∫ÁóáÁ≥ªÁµ±È†ÅÈù¢
            const consultationDiv = document.getElementById('consultationSystem').querySelector('.bg-white');
            
            // ÁßªÈô§ÁèæÊúâÁöÑÂÖßÂµåË°®ÂñÆÔºàÂ¶ÇÊûúÊúâÔºâ
            const existingForm = document.getElementById('inlineMedicalRecord');
            if (existingForm) {
                existingForm.remove();
            }
            
            consultationDiv.insertAdjacentHTML('beforeend', medicalRecordHtml);
            
            // ÊªæÂãïÂà∞Ë°®ÂñÆ‰ΩçÁΩÆ
            setTimeout(() => {
                document.getElementById('inlineMedicalRecord').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }, 100);
        }
        
        // Ê∏ÖÁ©∫ÁóÖÊ≠∑Ë°®ÂñÆ
        function clearMedicalRecordForm() {
            const fieldsToKeep = ['recordPatientId', 'recordAppointmentId', 'consultationDate', 'consultationTime', 'consultingDoctor', 'chiefComplaint'];
            const form = document.querySelector('#medicalRecordForm form');
            const inputs = form.querySelectorAll('input, textarea');
            
            inputs.forEach(input => {
                if (!fieldsToKeep.includes(input.id)) {
                    input.value = '';
                }
            });
        }
        
        // ÂÑ≤Â≠òÁóÖÊ≠∑
        function saveMedicalRecord(event) {
            event.preventDefault();
            
            // È©óË≠âÂøÖÂ°´Ê¨Ñ‰Ωç
            const requiredFields = [
                { id: 'consultationDate', name: 'Ë®∫ÁóáÊó•Êúü' },
                { id: 'consultationTime', name: 'Ë®∫ÁóáÊôÇÈñì' },
                { id: 'consultingDoctor', name: '‰∏ªË®∫ÈÜ´Â∏´' },
                { id: 'chiefComplaint', name: '‰∏ªË®¥' },
                { id: 'tcmDiagnosis', name: '‰∏≠ÈÜ´Ë®∫Êñ∑' },
                { id: 'syndromePattern', name: 'Ë≠âÂûãË®∫Êñ∑' },
                { id: 'treatmentPrinciple', name: 'Ê≤ªÊ≥ï' },
                { id: 'prescriptionContent', name: 'ËôïÊñπÂÖßÂÆπ' },
                { id: 'dosageInstructions', name: 'ÊúçÁî®ÊñπÊ≥ï' }
            ];
            
            const missingFields = [];
            
            // ÂÖàÊ∏ÖÈô§ÊâÄÊúâÈåØË™§Ê®£Âºè
            requiredFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    element.classList.remove('border-red-500', 'bg-red-50');
                }
            });
            
            for (const field of requiredFields) {
                const element = document.getElementById(field.id);
                if (!element || !element.value.trim()) {
                    missingFields.push(field.name);
                    // ÁÇ∫Áº∫Â§±ÁöÑÊ¨Ñ‰ΩçÊ∑ªÂä†Á¥ÖËâ≤ÈÇäÊ°ÜÊèêÁ§∫
                    if (element) {
                        element.classList.add('border-red-500', 'bg-red-50');
                        element.addEventListener('input', function() {
                            if (this.value.trim()) {
                                this.classList.remove('border-red-500', 'bg-red-50');
                            }
                        }, { once: true });
                    }
                }
            }
            
            if (missingFields.length > 0) {
                showNotification(`Ë´ãÂ°´ÂØ´‰ª•‰∏ãÂøÖÂ°´Ê¨Ñ‰ΩçÔºö${missingFields.join('„ÄÅ')}`, 'error');
                // ÊªæÂãïÂà∞Á¨¨‰∏ÄÂÄãÁº∫Â§±ÁöÑÊ¨Ñ‰Ωç
                const firstMissingFieldId = requiredFields.find(field => {
                    const element = document.getElementById(field.id);
                    return !element || !element.value.trim();
                })?.id;
                
                if (firstMissingFieldId) {
                    const firstMissingField = document.getElementById(firstMissingFieldId);
                    if (firstMissingField) {
                        firstMissingField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        firstMissingField.focus();
                    }
                }
                return;
            }
            
            const patientId = parseInt(document.getElementById('recordPatientId').value);
            const appointmentId = parseInt(document.getElementById('recordAppointmentId').value);
            const patient = patients.find(p => p.id === patientId);
            
            const medicalRecord = {
                id: nextRecordId++,
                patientId: patientId,
                appointmentId: appointmentId,
                patientName: patient.name,
                patientNumber: patient.patientNumber,
                consultationDate: document.getElementById('consultationDate').value,
                consultationTime: document.getElementById('consultationTime').value,
                consultingDoctor: document.getElementById('consultingDoctor').value,
                chiefComplaint: document.getElementById('chiefComplaint').value,
                presentIllness: document.getElementById('presentIllness').value,
                pastMedicalHistory: document.getElementById('pastMedicalHistory').value,
                allergyHistory: document.getElementById('allergyHistory').value,
                inspection: document.getElementById('inspection').value,
                auscultation: document.getElementById('auscultation').value,
                inquiry: document.getElementById('inquiry').value,
                palpation: document.getElementById('palpation').value,
                tcmDiagnosis: document.getElementById('tcmDiagnosis').value,
                syndromePattern: document.getElementById('syndromePattern').value,
                diagnosisBasis: document.getElementById('diagnosisBasis').value,
                treatmentPrinciple: document.getElementById('treatmentPrinciple').value,
                prescriptionName: document.getElementById('prescriptionName').value,
                prescriptionContent: document.getElementById('prescriptionContent').value,
                dosageInstructions: document.getElementById('dosageInstructions').value,
                treatmentDuration: document.getElementById('treatmentDuration').value,
                medicalAdvice: document.getElementById('medicalAdvice').value,
                createdAt: new Date().toISOString(),
                createdBy: currentUser,
                status: 'completed'
            };
            
            medicalRecords.push(medicalRecord);
            
            // Êõ¥Êñ∞ÊéõËôüÁãÄÊÖãÁÇ∫Â∑≤ÂÆåÊàê
            updateAppointmentStatus(appointmentId, 'Â∑≤ÂÆåÊàê');
            
            showNotification(`ÁóÖÊ≠∑Â∑≤ÊàêÂäüÂÑ≤Â≠òÔºÅÁóÖ‰∫∫Ôºö${patient.name}`);
            showConsultationSystem();
        }
        
        // Èö±ËóèÂÖßÂµåÁóÖÊ≠∑Ë°®ÂñÆ
        function hideInlineMedicalRecord() {
            const inlineForm = document.getElementById('inlineMedicalRecord');
            if (inlineForm) {
                inlineForm.remove();
            }
        }
        
        // ÂÑ≤Â≠òÂÖßÂµåÁóÖÊ≠∑
        function saveInlineMedicalRecord(event) {
            event.preventDefault();
            
            const patientId = parseInt(document.getElementById('inlineRecordPatientId').value);
            const appointmentId = parseInt(document.getElementById('inlineRecordAppointmentId').value);
            const patient = patients.find(p => p.id === patientId);
            
            // È©óË≠âÂøÖÂ°´Ê¨Ñ‰Ωç
            const requiredFields = [
                { id: 'inlineChiefComplaint', name: '‰∏ªË®¥' },
                { id: 'inlineTcmDiagnosis', name: '‰∏≠ÈÜ´Ë®∫Êñ∑' },
                { id: 'inlineSyndromePattern', name: 'Ë≠âÂûãË®∫Êñ∑' },
                { id: 'inlinePrescriptionContent', name: 'ËôïÊñπÂÖßÂÆπ' },
                { id: 'inlineDosageInstructions', name: 'ÊúçÁî®ÊñπÊ≥ï' }
            ];
            
            const missingFields = [];
            
            // ÂÖàÊ∏ÖÈô§ÊâÄÊúâÈåØË™§Ê®£Âºè
            requiredFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    element.classList.remove('border-red-500', 'bg-red-50');
                }
            });
            
            for (const field of requiredFields) {
                const element = document.getElementById(field.id);
                if (!element || !element.value.trim()) {
                    missingFields.push(field.name);
                    // ÁÇ∫Áº∫Â§±ÁöÑÊ¨Ñ‰ΩçÊ∑ªÂä†Á¥ÖËâ≤ÈÇäÊ°ÜÊèêÁ§∫
                    if (element) {
                        element.classList.add('border-red-500', 'bg-red-50');
                        element.addEventListener('input', function() {
                            if (this.value.trim()) {
                                this.classList.remove('border-red-500', 'bg-red-50');
                            }
                        }, { once: true });
                    }
                }
            }
            
            if (missingFields.length > 0) {
                showNotification(`Ë´ãÂ°´ÂØ´‰ª•‰∏ãÂøÖÂ°´Ê¨Ñ‰ΩçÔºö${missingFields.join('„ÄÅ')}`, 'error');
                // ÊªæÂãïÂà∞Á¨¨‰∏ÄÂÄãÁº∫Â§±ÁöÑÊ¨Ñ‰Ωç
                const firstMissingFieldId = requiredFields.find(field => {
                    const element = document.getElementById(field.id);
                    return !element || !element.value.trim();
                })?.id;
                
                if (firstMissingFieldId) {
                    const firstMissingField = document.getElementById(firstMissingFieldId);
                    if (firstMissingField) {
                        firstMissingField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        firstMissingField.focus();
                    }
                }
                return;
            }
            
            // Ê™¢Êü•ÊòØÂê¶ÁÇ∫‰øÆÊîπÊ®°Âºè
            const existingRecordIndex = medicalRecords.findIndex(record => record.appointmentId === appointmentId && record.status === 'completed');
            const isEditMode = existingRecordIndex >= 0;
            
            if (isEditMode) {
                // ‰øÆÊîπÊ®°ÂºèÔºöÊõ¥Êñ∞ÁèæÊúâÁóÖÊ≠∑Ôºå‰øùÁïôÂéüÂßãË≥áË®ä
                const existingRecord = medicalRecords[existingRecordIndex];
                
                // Ë®òÈåÑ‰øÆÊîπÊ≠∑Âè≤
                if (!existingRecord.modificationHistory) {
                    existingRecord.modificationHistory = [];
                }
                
                // ‰øùÂ≠ò‰øÆÊîπÂâçÁöÑÁãÄÊÖã
                existingRecord.modificationHistory.push({
                    modifiedAt: new Date().toISOString(),
                    modifiedBy: currentUser,
                    changes: {
                        chiefComplaint: { from: existingRecord.chiefComplaint, to: document.getElementById('inlineChiefComplaint').value },
                        presentIllness: { from: existingRecord.presentIllness, to: document.getElementById('inlinePresentIllness').value },
                        tcmDiagnosis: { from: existingRecord.tcmDiagnosis, to: document.getElementById('inlineTcmDiagnosis').value },
                        syndromePattern: { from: existingRecord.syndromePattern, to: document.getElementById('inlineSyndromePattern').value },
                        prescriptionContent: { from: existingRecord.prescriptionContent, to: document.getElementById('inlinePrescriptionContent').value },
                        dosageInstructions: { from: existingRecord.dosageInstructions, to: document.getElementById('inlineDosageInstructions').value },
                        treatmentDuration: { from: existingRecord.treatmentDuration, to: document.getElementById('inlineTreatmentDuration').value },
                        medicalAdvice: { from: existingRecord.medicalAdvice, to: document.getElementById('inlineMedicalAdvice').value }
                    }
                });
                
                // Êõ¥Êñ∞ÁóÖÊ≠∑ÂÖßÂÆπ
                existingRecord.chiefComplaint = document.getElementById('inlineChiefComplaint').value;
                existingRecord.presentIllness = document.getElementById('inlinePresentIllness').value;
                existingRecord.tcmDiagnosis = document.getElementById('inlineTcmDiagnosis').value;
                existingRecord.syndromePattern = document.getElementById('inlineSyndromePattern').value;
                existingRecord.prescriptionContent = document.getElementById('inlinePrescriptionContent').value;
                existingRecord.dosageInstructions = document.getElementById('inlineDosageInstructions').value;
                existingRecord.treatmentDuration = document.getElementById('inlineTreatmentDuration').value;
                existingRecord.medicalAdvice = document.getElementById('inlineMedicalAdvice').value;
                existingRecord.lastModified = new Date().toISOString();
                existingRecord.modifiedBy = currentUser;
                
                showNotification(`ÁóÖÊ≠∑Â∑≤Êõ¥Êñ∞ÔºÅÁóÖ‰∫∫Ôºö${patient.name}`, 'info');
            } else {
                // Êñ∞Â¢ûÊ®°ÂºèÔºöÂâµÂª∫Êñ∞ÁóÖÊ≠∑
                const medicalRecord = {
                    id: nextRecordId++,
                    patientId: patientId,
                    appointmentId: appointmentId,
                    patientName: patient.name,
                    patientNumber: patient.patientNumber,
                    consultationDate: new Date().toISOString().split('T')[0],
                    consultationTime: new Date().toTimeString().slice(0, 5),
                    consultingDoctor: 'Êùé‰∏≠ÈÜ´Â∏´',
                    chiefComplaint: document.getElementById('inlineChiefComplaint').value,
                    presentIllness: document.getElementById('inlinePresentIllness').value,
                    tcmDiagnosis: document.getElementById('inlineTcmDiagnosis').value,
                    syndromePattern: document.getElementById('inlineSyndromePattern').value,
                    prescriptionContent: document.getElementById('inlinePrescriptionContent').value,
                    dosageInstructions: document.getElementById('inlineDosageInstructions').value,
                    treatmentDuration: document.getElementById('inlineTreatmentDuration').value,
                    medicalAdvice: document.getElementById('inlineMedicalAdvice').value,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser,
                    status: 'completed'
                };
                
                medicalRecords.push(medicalRecord);
                
                // Êõ¥Êñ∞ÊéõËôüÁãÄÊÖãÁÇ∫Â∑≤ÂÆåÊàê
                updateAppointmentStatus(appointmentId, 'Â∑≤ÂÆåÊàê');
                showNotification(`Ë®∫ÁóáÂÆåÊàêÔºÅÁóÖÊ≠∑Â∑≤ÂÑ≤Â≠ò - ÁóÖ‰∫∫Ôºö${patient.name}`);
            }
            
            // Èö±ËóèË°®ÂñÆ
            hideInlineMedicalRecord();
        }
        
        // ÂÑ≤Â≠òÂÖßÂµåËçâÁ®ø
        function saveInlineDraft() {
            const patientId = parseInt(document.getElementById('inlineRecordPatientId').value);
            const appointmentId = parseInt(document.getElementById('inlineRecordAppointmentId').value);
            const patient = patients.find(p => p.id === patientId);
            
            // È©óË≠âÂøÖÂ°´Ê¨Ñ‰Ωç
            const requiredFields = [
                { id: 'inlineChiefComplaint', name: '‰∏ªË®¥' },
                { id: 'inlineTcmDiagnosis', name: '‰∏≠ÈÜ´Ë®∫Êñ∑' },
                { id: 'inlineSyndromePattern', name: 'Ë≠âÂûãË®∫Êñ∑' },
                { id: 'inlinePrescriptionContent', name: 'ËôïÊñπÂÖßÂÆπ' },
                { id: 'inlineDosageInstructions', name: 'ÊúçÁî®ÊñπÊ≥ï' }
            ];
            
            const missingFields = [];
            
            // ÂÖàÊ∏ÖÈô§ÊâÄÊúâÈåØË™§Ê®£Âºè
            requiredFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    element.classList.remove('border-red-500', 'bg-red-50');
                }
            });
            
            for (const field of requiredFields) {
                const element = document.getElementById(field.id);
                if (!element || !element.value.trim()) {
                    missingFields.push(field.name);
                    // ÁÇ∫Áº∫Â§±ÁöÑÊ¨Ñ‰ΩçÊ∑ªÂä†Á¥ÖËâ≤ÈÇäÊ°ÜÊèêÁ§∫
                    if (element) {
                        element.classList.add('border-red-500', 'bg-red-50');
                        element.addEventListener('input', function() {
                            if (this.value.trim()) {
                                this.classList.remove('border-red-500', 'bg-red-50');
                            }
                        }, { once: true });
                    }
                }
            }
            
            if (missingFields.length > 0) {
                showNotification(`Ë´ãÂ°´ÂØ´‰ª•‰∏ãÂøÖÂ°´Ê¨Ñ‰ΩçÔºö${missingFields.join('„ÄÅ')}`, 'error');
                // ÊªæÂãïÂà∞Á¨¨‰∏ÄÂÄãÁº∫Â§±ÁöÑÊ¨Ñ‰Ωç
                const firstMissingFieldId = requiredFields.find(field => {
                    const element = document.getElementById(field.id);
                    return !element || !element.value.trim();
                })?.id;
                
                if (firstMissingFieldId) {
                    const firstMissingField = document.getElementById(firstMissingFieldId);
                    if (firstMissingField) {
                        firstMissingField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        firstMissingField.focus();
                    }
                }
                return;
            }
            
            // ÊâÄÊúâÂøÖÂ°´Ê¨Ñ‰ΩçÈÉΩÂ∑≤Â°´ÂØ´ÔºåÂÆåÊàêË®∫Áóá
            const medicalRecord = {
                id: nextRecordId++,
                patientId: patientId,
                appointmentId: appointmentId,
                patientName: patient.name,
                patientNumber: patient.patientNumber,
                consultationDate: new Date().toISOString().split('T')[0],
                consultationTime: new Date().toTimeString().slice(0, 5),
                consultingDoctor: 'Êùé‰∏≠ÈÜ´Â∏´',
                chiefComplaint: document.getElementById('inlineChiefComplaint').value,
                presentIllness: document.getElementById('inlinePresentIllness').value,
                tcmDiagnosis: document.getElementById('inlineTcmDiagnosis').value,
                syndromePattern: document.getElementById('inlineSyndromePattern').value,
                prescriptionContent: document.getElementById('inlinePrescriptionContent').value,
                dosageInstructions: document.getElementById('inlineDosageInstructions').value,
                treatmentDuration: document.getElementById('inlineTreatmentDuration').value,
                medicalAdvice: document.getElementById('inlineMedicalAdvice').value,
                createdAt: new Date().toISOString(),
                createdBy: currentUser,
                status: 'completed'
            };
            
            // Âà™Èô§ÁèæÊúâËçâÁ®øÔºàÂ¶ÇÊûúÊúâÔºâ
            medicalRecords = medicalRecords.filter(record => 
                !(record.appointmentId === appointmentId && record.status === 'draft')
            );
            
            medicalRecords.push(medicalRecord);
            
            // Êõ¥Êñ∞ÊéõËôüÁãÄÊÖãÁÇ∫Â∑≤ÂÆåÊàê
            updateAppointmentStatus(appointmentId, 'Â∑≤ÂÆåÊàê');
            
            showNotification(`Ë®∫ÁóáÂÆåÊàêÔºÅÁóÖÊ≠∑Â∑≤ÂÑ≤Â≠ò - ÁóÖ‰∫∫Ôºö${patient.name}`);
            
            // Èö±ËóèË°®ÂñÆ
            hideInlineMedicalRecord();
        }

        // È°ØÁ§∫‰∏≠Ëó•ÂèäÊñπÂäëÂ∫´
        function showHerbalLibrary() {
            hideAllPages();
            document.getElementById('herbalLibrary').classList.remove('hidden');
            loadHerbalItems();
        }

        // ËºâÂÖ•‰∏≠Ëó•ÂèäÊñπÂäëÂàóË°®
        function loadHerbalItems(filteredItems = null) {
            const tbody = document.getElementById('herbalItemsList');
            
            let itemsToShow = [];
            
            if (filteredItems) {
                itemsToShow = filteredItems;
            } else {
                if (currentFilter === 'all') {
                    itemsToShow = [
                        ...herbs.map(herb => ({...herb, type: 'herb'})),
                        ...formulas.map(formula => ({...formula, type: 'formula'}))
                    ];
                } else if (currentFilter === 'herb') {
                    itemsToShow = herbs.map(herb => ({...herb, type: 'herb'}));
                } else if (currentFilter === 'formula') {
                    itemsToShow = formulas.map(formula => ({...formula, type: 'formula'}));
                }
            }
            
            if (itemsToShow.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" class="border border-gray-200 px-4 py-8 text-center text-gray-500">
                            Ê≤íÊúâÊâæÂà∞Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑÈ†ÖÁõÆ
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = itemsToShow.map(item => {
                const typeDisplay = item.type === 'herb' ? 'üåø ‰∏≠Ëó•' : 'üìú ÊñπÂäë';
                const typeColor = item.type === 'herb' ? 'text-green-600' : 'text-blue-600';
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-200 px-4 py-3">
                            <span class="${typeColor} font-medium">${typeDisplay}</span>
                        </td>
                        <td class="border border-gray-200 px-4 py-3">
                            <span class="font-medium text-gray-800">${item.name}</span>
                            ${item.source ? `<div class="text-sm text-gray-500">${item.source}</div>` : ''}
                        </td>
                        <td class="border border-gray-200 px-4 py-3">
                            <div class="flex space-x-2">
                                <button onclick="${item.type === 'herb' ? `viewHerbDetail(${item.id})` : `viewFormulaDetail(${item.id})`}" 
                                        class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                    Êü•Áúã
                                </button>
                                <button onclick="${item.type === 'herb' ? `editHerb(${item.id})` : `editFormula(${item.id})`}" 
                                        class="text-green-600 hover:text-green-800 text-sm font-medium">
                                    Á∑®ËºØ
                                </button>
                                <button onclick="${item.type === 'herb' ? `deleteHerb(${item.id})` : `deleteFormula(${item.id})`}" 
                                        class="text-red-600 hover:text-red-800 text-sm font-medium">
                                    Âà™Èô§
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ÂâµÂª∫‰∏≠Ëó•Âç°Áâá
        function createHerbCard(herb) {
            return `
                <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-6 border border-green-200 hover:shadow-lg transition-shadow">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-bold text-green-800">${herb.name}</h3>
                            <p class="text-sm text-green-600">${herb.pinyin || ''}</p>
                        </div>
                        <span class="bg-green-600 text-white px-2 py-1 rounded-full text-xs">üåø ‰∏≠Ëó•</span>
                    </div>
                    
                    <div class="space-y-2 text-sm">
                        <div>
                            <span class="font-medium text-gray-700">ÊÄßÂë≥Ôºö</span>
                            <span class="text-gray-600">${herb.nature}</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">Ê≠∏Á∂ìÔºö</span>
                            <span class="text-gray-600">${herb.meridian}</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">ÂäüÊïàÔºö</span>
                            <span class="text-gray-600">${herb.effects.length > 50 ? herb.effects.substring(0, 50) + '...' : herb.effects}</span>
                        </div>
                        ${herb.dosage ? `
                        <div>
                            <span class="font-medium text-gray-700">Áî®ÈáèÔºö</span>
                            <span class="text-gray-600">${herb.dosage}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="flex space-x-2 mt-4">
                        <button onclick="viewHerbDetail(${herb.id})" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm font-medium">
                            Êü•ÁúãË©≥ÊÉÖ
                        </button>
                        <button onclick="showNotification('Á∑®ËºØÂäüËÉΩÈñãÁôº‰∏≠...', 'info')" class="bg-amber-600 hover:bg-amber-700 text-white px-3 py-2 rounded text-sm font-medium">
                            Á∑®ËºØ
                        </button>
                        <button onclick="deleteHerb(${herb.id})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm font-medium">
                            Âà™Èô§
                        </button>
                    </div>
                </div>
            `;
        }

        // ÂâµÂª∫ÊñπÂäëÂç°Áâá
        function createFormulaCard(formula) {
            return `
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-6 border border-blue-200 hover:shadow-lg transition-shadow">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-bold text-blue-800">${formula.name}</h3>
                            <p class="text-sm text-blue-600">${formula.source || ''}</p>
                        </div>
                        <span class="bg-blue-600 text-white px-2 py-1 rounded-full text-xs">üìú ÊñπÂäë</span>
                    </div>
                    
                    <div class="space-y-2 text-sm">
                        <div>
                            <span class="font-medium text-gray-700">ÁµÑÊàêÔºö</span>
                            <span class="text-gray-600">${formula.composition.length > 50 ? formula.composition.substring(0, 50) + '...' : formula.composition}</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">ÂäüÊïàÔºö</span>
                            <span class="text-gray-600">${formula.effects}</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">‰∏ªÊ≤ªÔºö</span>
                            <span class="text-gray-600">${formula.indications.length > 50 ? formula.indications.substring(0, 50) + '...' : formula.indications}</span>
                        </div>
                    </div>
                    
                    <div class="flex space-x-2 mt-4">
                        <button onclick="viewFormulaDetail(${formula.id})" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm font-medium">
                            Êü•ÁúãË©≥ÊÉÖ
                        </button>
                        <button onclick="showNotification('Á∑®ËºØÂäüËÉΩÈñãÁôº‰∏≠...', 'info')" class="bg-amber-600 hover:bg-amber-700 text-white px-3 py-2 rounded text-sm font-medium">
                            Á∑®ËºØ
                        </button>
                        <button onclick="deleteFormula(${formula.id})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm font-medium">
                            Âà™Èô§
                        </button>
                    </div>
                </div>
            `;
        }

        // ÁØ©ÈÅ∏ÂäüËÉΩ
        function filterHerbalItems(filter) {
            currentFilter = filter;
            
            // Êõ¥Êñ∞ÊåâÈàïÊ®£Âºè
            document.querySelectorAll('[id^="herbal-filter-"]').forEach(btn => {
                btn.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300';
            });
            document.getElementById(`herbal-filter-${filter}`).className = 'px-4 py-2 bg-amber-600 text-white rounded-lg text-sm font-medium hover:bg-amber-700';
            
            loadHerbalItems();
        }

        // ÊêúÁ¥¢ÂäüËÉΩ
        function searchHerbalItems() {
            const searchTerm = document.getElementById('herbalSearchInput').value.toLowerCase().trim();
            
            if (searchTerm === '') {
                loadHerbalItems();
                return;
            }
            
            let allItems = [
                ...herbs.map(herb => ({...herb, type: 'herb'})),
                ...formulas.map(formula => ({...formula, type: 'formula'}))
            ];
            
            const filteredItems = allItems.filter(item => {
                if (item.type === 'herb') {
                    return item.name.toLowerCase().includes(searchTerm);
                } else {
                    return item.name.toLowerCase().includes(searchTerm) ||
                           (item.composition && item.composition.toLowerCase().includes(searchTerm)) ||
                           (item.source && item.source.toLowerCase().includes(searchTerm));
                }
            });
            
            loadHerbalItems(filteredItems);
        }

        // È°ØÁ§∫Êñ∞Â¢û‰∏≠Ëó•Ë°®ÂñÆ
        function showAddHerbForm() {
            hideAllPages();
            document.getElementById('addHerbForm').classList.remove('hidden');
            
            // Ê∏ÖÁ©∫Ë°®ÂñÆ
            document.getElementById('herbName').value = '';
        }

        // È°ØÁ§∫Êñ∞Â¢ûÊñπÂäëË°®ÂñÆ
        function showAddFormulaForm() {
            hideAllPages();
            document.getElementById('addFormulaForm').classList.remove('hidden');
            
            // Ê∏ÖÁ©∫Ë°®ÂñÆ
            document.getElementById('formulaName').value = '';
            document.getElementById('formulaSource').value = '';
            document.getElementById('formulaComposition').value = '';
            document.getElementById('formulaPrecautions').value = '';
            document.getElementById('herbSearchInput').value = '';
            document.getElementById('herbDosageInput').value = '';
            
            // ÈáçÁΩÆÈÅ∏‰∏≠ÁöÑ‰∏≠Ëó•
            selectedHerbsForFormula = [];
            updateSelectedHerbsDisplay();
            updateFormulaCompositionText();
        }

        // ÊêúÂ∞ã‰∏≠Ëó•ÂäüËÉΩÔºàÁî®ÊñºÊñπÂäëÁµÑÊàêÔºâ
        function searchHerbsForFormula() {
            const searchTerm = document.getElementById('herbSearchInput').value.toLowerCase().trim();
            const searchResults = document.getElementById('herbSearchResults');
            const searchResultsList = document.getElementById('herbSearchResultsList');
            
            if (searchTerm === '') {
                searchResults.classList.add('hidden');
                return;
            }
            
            const filteredHerbs = herbs.filter(herb => 
                herb.name.toLowerCase().includes(searchTerm)
            );
            
            if (filteredHerbs.length === 0) {
                searchResultsList.innerHTML = '<div class="px-4 py-3 text-gray-500 text-sm">Ê≤íÊúâÊâæÂà∞Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑ‰∏≠Ëó•</div>';
            } else {
                searchResultsList.innerHTML = filteredHerbs.map(herb => `
                    <div class="px-4 py-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0" 
                         onclick="selectHerbForFormula('${herb.name}')">
                        <div class="font-medium text-gray-900">${herb.name}</div>
                    </div>
                `).join('');
            }
            
            searchResults.classList.remove('hidden');
        }

        // È°ØÁ§∫‰∏≠Ëó•ÊêúÂ∞ãÁµêÊûú
        function showHerbSearchResults() {
            const searchTerm = document.getElementById('herbSearchInput').value.trim();
            if (searchTerm !== '') {
                searchHerbsForFormula();
            }
        }

        // ÈÅ∏Êìá‰∏≠Ëó•ÔºàÁî®ÊñºÊñπÂäëÁµÑÊàêÔºâ
        function selectHerbForFormula(herbName) {
            document.getElementById('herbSearchInput').value = herbName;
            document.getElementById('herbSearchResults').classList.add('hidden');
            document.getElementById('herbDosageInput').focus();
        }

        // Ê∑ªÂä†‰∏≠Ëó•Âà∞ÊñπÂäëÁµÑÊàê
        function addHerbToFormula() {
            const herbName = document.getElementById('herbSearchInput').value.trim();
            const dosage = parseFloat(document.getElementById('herbDosageInput').value);
            
            if (!herbName) {
                showNotification('Ë´ãÈÅ∏Êìá‰∏≠Ëó•', 'error');
                return;
            }
            
            if (!dosage || dosage <= 0) {
                showNotification('Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÂäëÈáè', 'error');
                return;
            }
            
            // Ê™¢Êü•‰∏≠Ëó•ÊòØÂê¶Â≠òÂú®
            const herbExists = herbs.some(herb => herb.name === herbName);
            if (!herbExists) {
                showNotification('Ë´ãÂæûÊêúÂ∞ãÁµêÊûú‰∏≠ÈÅ∏Êìá‰∏≠Ëó•', 'error');
                return;
            }
            
            // Ê™¢Êü•ÊòØÂê¶Â∑≤Á∂ìÊ∑ªÂä†ÈÅé
            const existingIndex = selectedHerbsForFormula.findIndex(item => item.name === herbName);
            if (existingIndex >= 0) {
                // Êõ¥Êñ∞ÂäëÈáè
                selectedHerbsForFormula[existingIndex].dosage = dosage;
                showNotification(`Â∑≤Êõ¥Êñ∞ ${herbName} ÁöÑÂäëÈáèÁÇ∫ ${dosage}g`, 'info');
            } else {
                // Ê∑ªÂä†Êñ∞‰∏≠Ëó•
                selectedHerbsForFormula.push({
                    name: herbName,
                    dosage: dosage
                });
                showNotification(`Â∑≤Ê∑ªÂä† ${herbName} ${dosage}g`);
            }
            
            // Ê∏ÖÁ©∫Ëº∏ÂÖ•Ê°Ü
            document.getElementById('herbSearchInput').value = '';
            document.getElementById('herbDosageInput').value = '';
            document.getElementById('herbSearchResults').classList.add('hidden');
            
            // Êõ¥Êñ∞È°ØÁ§∫
            updateSelectedHerbsDisplay();
            updateFormulaCompositionText();
        }

        // Êõ¥Êñ∞Â∑≤ÈÅ∏‰∏≠Ëó•È°ØÁ§∫
        function updateSelectedHerbsDisplay() {
            const container = document.getElementById('selectedHerbsDisplay');
            
            if (selectedHerbsForFormula.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Â∞öÊú™Ê∑ªÂä†‰ªª‰Ωï‰∏≠Ëó•</p>';
                return;
            }
            
            container.innerHTML = selectedHerbsForFormula.map((herb, index) => `
                <div class="flex items-center justify-between bg-white rounded-lg p-3 border border-gray-200">
                    <div class="flex items-center space-x-3">
                        <span class="w-6 h-6 bg-green-100 text-green-600 rounded-full flex items-center justify-center text-xs font-bold">
                            ${index + 1}
                        </span>
                        <span class="font-medium text-gray-800">${herb.name}</span>
                        <span class="text-blue-600 font-mono">${herb.dosage}g</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="editHerbInFormula(${index})" class="text-blue-600 hover:text-blue-800 text-sm">
                            Á∑®ËºØ
                        </button>
                        <button onclick="removeHerbFromFormula(${index})" class="text-red-600 hover:text-red-800 text-sm">
                            ÁßªÈô§
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Êõ¥Êñ∞ÊñπÂäëÁµÑÊàêÊñáÂ≠ó
        function updateFormulaCompositionText() {
            const compositionText = selectedHerbsForFormula
                .map(herb => `${herb.name} ${herb.dosage}g`)
                .join('Ôºå');
            
            document.getElementById('formulaComposition').value = compositionText;
        }

        // Á∑®ËºØÊñπÂäë‰∏≠ÁöÑ‰∏≠Ëó•
        function editHerbInFormula(index) {
            const herb = selectedHerbsForFormula[index];
            const newDosage = prompt(`Ë´ãËº∏ÂÖ• ${herb.name} ÁöÑÊñ∞ÂäëÈáè (g):`, herb.dosage);
            
            if (newDosage !== null) {
                const dosage = parseFloat(newDosage);
                if (dosage && dosage > 0) {
                    selectedHerbsForFormula[index].dosage = dosage;
                    updateSelectedHerbsDisplay();
                    updateFormulaCompositionText();
                    showNotification(`Â∑≤Êõ¥Êñ∞ ${herb.name} ÁöÑÂäëÈáèÁÇ∫ ${dosage}g`, 'info');
                } else {
                    showNotification('Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÂäëÈáè', 'error');
                }
            }
        }

        // ÂæûÊñπÂäë‰∏≠ÁßªÈô§‰∏≠Ëó•
        function removeHerbFromFormula(index) {
            const herb = selectedHerbsForFormula[index];
            if (confirm(`Á¢∫ÂÆöË¶ÅÁßªÈô§ ${herb.name} ÂóéÔºü`)) {
                selectedHerbsForFormula.splice(index, 1);
                updateSelectedHerbsDisplay();
                updateFormulaCompositionText();
                showNotification(`Â∑≤ÁßªÈô§ ${herb.name}`, 'info');
            }
        }

        // Á∑®ËºØÊñπÂäëÁöÑÊêúÂ∞ã‰∏≠Ëó•ÂäüËÉΩ
        function searchHerbsForEditFormula() {
            const searchTerm = document.getElementById('editHerbSearchInput').value.toLowerCase().trim();
            const searchResults = document.getElementById('editHerbSearchResults');
            const searchResultsList = document.getElementById('editHerbSearchResultsList');
            
            if (searchTerm === '') {
                searchResults.classList.add('hidden');
                return;
            }
            
            const filteredHerbs = herbs.filter(herb => 
                herb.name.toLowerCase().includes(searchTerm)
            );
            
            if (filteredHerbs.length === 0) {
                searchResultsList.innerHTML = '<div class="px-4 py-3 text-gray-500 text-sm">Ê≤íÊúâÊâæÂà∞Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑ‰∏≠Ëó•</div>';
            } else {
                searchResultsList.innerHTML = filteredHerbs.map(herb => `
                    <div class="px-4 py-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0" 
                         onclick="selectHerbForEditFormula('${herb.name}')">
                        <div class="font-medium text-gray-900">${herb.name}</div>
                    </div>
                `).join('');
            }
            
            searchResults.classList.remove('hidden');
        }

        // È°ØÁ§∫Á∑®ËºØÊñπÂäëÁöÑ‰∏≠Ëó•ÊêúÂ∞ãÁµêÊûú
        function showEditHerbSearchResults() {
            const searchTerm = document.getElementById('editHerbSearchInput').value.trim();
            if (searchTerm !== '') {
                searchHerbsForEditFormula();
            }
        }

        // ÈÅ∏Êìá‰∏≠Ëó•ÔºàÁ∑®ËºØÊñπÂäëÁî®Ôºâ
        function selectHerbForEditFormula(herbName) {
            document.getElementById('editHerbSearchInput').value = herbName;
            document.getElementById('editHerbSearchResults').classList.add('hidden');
            document.getElementById('editHerbDosageInput').focus();
        }

        // Ê∑ªÂä†‰∏≠Ëó•Âà∞Á∑®ËºØÊñπÂäëÁµÑÊàê
        function addHerbToEditFormula() {
            const herbName = document.getElementById('editHerbSearchInput').value.trim();
            const dosage = parseFloat(document.getElementById('editHerbDosageInput').value);
            
            if (!herbName) {
                showNotification('Ë´ãÈÅ∏Êìá‰∏≠Ëó•', 'error');
                return;
            }
            
            if (!dosage || dosage <= 0) {
                showNotification('Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÂäëÈáè', 'error');
                return;
            }
            
            // Ê™¢Êü•‰∏≠Ëó•ÊòØÂê¶Â≠òÂú®
            const herbExists = herbs.some(herb => herb.name === herbName);
            if (!herbExists) {
                showNotification('Ë´ãÂæûÊêúÂ∞ãÁµêÊûú‰∏≠ÈÅ∏Êìá‰∏≠Ëó•', 'error');
                return;
            }
            
            // Ê™¢Êü•ÊòØÂê¶Â∑≤Á∂ìÊ∑ªÂä†ÈÅé
            const existingIndex = selectedHerbsForEditFormula.findIndex(item => item.name === herbName);
            if (existingIndex >= 0) {
                // Êõ¥Êñ∞ÂäëÈáè
                selectedHerbsForEditFormula[existingIndex].dosage = dosage;
                showNotification(`Â∑≤Êõ¥Êñ∞ ${herbName} ÁöÑÂäëÈáèÁÇ∫ ${dosage}g`, 'info');
            } else {
                // Ê∑ªÂä†Êñ∞‰∏≠Ëó•
                selectedHerbsForEditFormula.push({
                    name: herbName,
                    dosage: dosage
                });
                showNotification(`Â∑≤Ê∑ªÂä† ${herbName} ${dosage}g`);
            }
            
            // Ê∏ÖÁ©∫Ëº∏ÂÖ•Ê°Ü
            document.getElementById('editHerbSearchInput').value = '';
            document.getElementById('editHerbDosageInput').value = '';
            document.getElementById('editHerbSearchResults').classList.add('hidden');
            
            // Êõ¥Êñ∞È°ØÁ§∫
            updateEditSelectedHerbsDisplay();
            updateEditFormulaCompositionText();
        }

        // Êõ¥Êñ∞Á∑®ËºØÊñπÂäëÁöÑÂ∑≤ÈÅ∏‰∏≠Ëó•È°ØÁ§∫
        function updateEditSelectedHerbsDisplay() {
            const container = document.getElementById('editSelectedHerbsDisplay');
            
            if (selectedHerbsForEditFormula.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Â∞öÊú™Ê∑ªÂä†‰ªª‰Ωï‰∏≠Ëó•</p>';
                return;
            }
            
            container.innerHTML = selectedHerbsForEditFormula.map((herb, index) => `
                <div class="flex items-center justify-between bg-white rounded-lg p-3 border border-gray-200">
                    <div class="flex items-center space-x-3">
                        <span class="w-6 h-6 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center text-xs font-bold">
                            ${index + 1}
                        </span>
                        <span class="font-medium text-gray-800">${herb.name}</span>
                        <span class="text-blue-600 font-mono">${herb.dosage}g</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="editHerbInEditFormula(${index})" class="text-blue-600 hover:text-blue-800 text-sm">
                            Á∑®ËºØ
                        </button>
                        <button onclick="removeHerbFromEditFormula(${index})" class="text-red-600 hover:text-red-800 text-sm">
                            ÁßªÈô§
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Êõ¥Êñ∞Á∑®ËºØÊñπÂäëÁöÑÁµÑÊàêÊñáÂ≠ó
        function updateEditFormulaCompositionText() {
            const compositionText = selectedHerbsForEditFormula
                .map(herb => `${herb.name} ${herb.dosage}g`)
                .join('Ôºå');
            
            document.getElementById('editFormulaComposition').value = compositionText;
        }

        // Á∑®ËºØÁ∑®ËºØÊñπÂäë‰∏≠ÁöÑ‰∏≠Ëó•
        function editHerbInEditFormula(index) {
            const herb = selectedHerbsForEditFormula[index];
            const newDosage = prompt(`Ë´ãËº∏ÂÖ• ${herb.name} ÁöÑÊñ∞ÂäëÈáè (g):`, herb.dosage);
            
            if (newDosage !== null) {
                const dosage = parseFloat(newDosage);
                if (dosage && dosage > 0) {
                    selectedHerbsForEditFormula[index].dosage = dosage;
                    updateEditSelectedHerbsDisplay();
                    updateEditFormulaCompositionText();
                    showNotification(`Â∑≤Êõ¥Êñ∞ ${herb.name} ÁöÑÂäëÈáèÁÇ∫ ${dosage}g`, 'info');
                } else {
                    showNotification('Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÂäëÈáè', 'error');
                }
            }
        }

        // ÂæûÁ∑®ËºØÊñπÂäë‰∏≠ÁßªÈô§‰∏≠Ëó•
        function removeHerbFromEditFormula(index) {
            const herb = selectedHerbsForEditFormula[index];
            if (confirm(`Á¢∫ÂÆöË¶ÅÁßªÈô§ ${herb.name} ÂóéÔºü`)) {
                selectedHerbsForEditFormula.splice(index, 1);
                updateEditSelectedHerbsDisplay();
                updateEditFormulaCompositionText();
                showNotification(`Â∑≤ÁßªÈô§ ${herb.name}`, 'info');
            }
        }

        // Êñ∞Â¢û‰∏≠Ëó•
        function addHerb(event) {
            event.preventDefault();
            
            const newHerb = {
                id: nextHerbId++,
                name: document.getElementById('herbName').value
            };
            
            herbs.push(newHerb);
            showNotification(`‰∏≠Ëó• "${newHerb.name}" Êñ∞Â¢ûÊàêÂäüÔºÅ`);
            showHerbalLibrary();
        }

        // Á∑®ËºØ‰∏≠Ëó•Ôºà‰ΩøÁî®Ë¶ñÁ™óÔºâ
        function editHerb(id) {
            const herb = herbs.find(h => h.id === id);
            if (herb) {
                // Â°´ÂÖ•ÁèæÊúâË≥áÊñô
                document.getElementById('modalEditHerbId').value = herb.id;
                document.getElementById('modalEditHerbName').value = herb.name;
                
                showModal('editHerbModal');
            }
        }

        // Êõ¥Êñ∞‰∏≠Ëó•ÔºàË¶ñÁ™óÁâàÊú¨Ôºâ
        function updateHerbModal(event) {
            event.preventDefault();
            
            const herbId = parseInt(document.getElementById('modalEditHerbId').value);
            const herbIndex = herbs.findIndex(h => h.id === herbId);
            
            if (herbIndex !== -1) {
                const oldName = herbs[herbIndex].name;
                herbs[herbIndex].name = document.getElementById('modalEditHerbName').value;
                
                closeModal('editHerbModal');
                loadHerbalItems();
                showNotification(`‰∏≠Ëó• "${oldName}" Â∑≤Êõ¥Êñ∞ÁÇ∫ "${herbs[herbIndex].name}"`);
            }
        }

        // Êõ¥Êñ∞‰∏≠Ëó•ÔºàÂéüÁâàÊú¨‰øùÁïôÔºâ
        function updateHerb(event) {
            event.preventDefault();
            
            const herbId = parseInt(document.getElementById('editHerbId').value);
            const herbIndex = herbs.findIndex(h => h.id === herbId);
            
            if (herbIndex !== -1) {
                const oldName = herbs[herbIndex].name;
                herbs[herbIndex].name = document.getElementById('editHerbName').value;
                
                showNotification(`‰∏≠Ëó• "${oldName}" Â∑≤Êõ¥Êñ∞ÁÇ∫ "${herbs[herbIndex].name}"`);
                showHerbalLibrary();
            }
        }

        // Êñ∞Â¢ûÊñπÂäë
        function addFormula(event) {
            event.preventDefault();
            
            // È©óË≠âÊòØÂê¶ÊúâÊ∑ªÂä†‰∏≠Ëó•
            if (selectedHerbsForFormula.length === 0) {
                showNotification('Ë´ãËá≥Â∞ëÊ∑ªÂä†‰∏ÄÂë≥‰∏≠Ëó•', 'error');
                return;
            }
            
            const newFormula = {
                id: nextFormulaId++,
                name: document.getElementById('formulaName').value,
                source: document.getElementById('formulaSource').value,
                composition: document.getElementById('formulaComposition').value,
                precautions: document.getElementById('formulaPrecautions').value,
                herbs: [...selectedHerbsForFormula] // ÂÑ≤Â≠ò‰∏≠Ëó•ÁµÑÊàêË©≥Á¥∞Ë≥áË®ä
            };
            
            formulas.push(newFormula);
            showNotification(`ÊñπÂäë "${newFormula.name}" Êñ∞Â¢ûÊàêÂäüÔºÅÂåÖÂê´ ${selectedHerbsForFormula.length} Âë≥‰∏≠Ëó•`);
            showHerbalLibrary();
        }

        // Á∑®ËºØÊñπÂäëÔºà‰ΩøÁî®Ë¶ñÁ™óÔºâ
        function editFormula(id) {
            const formula = formulas.find(f => f.id === id);
            if (formula) {
                // Â°´ÂÖ•ÁèæÊúâË≥áÊñô
                document.getElementById('modalEditFormulaId').value = formula.id;
                document.getElementById('modalEditFormulaName').value = formula.name;
                document.getElementById('modalEditFormulaSource').value = formula.source || '';
                document.getElementById('modalEditFormulaPrecautions').value = formula.precautions || '';
                
                // ÈáçÁΩÆÁ∑®ËºØÁî®ÁöÑÈÅ∏‰∏≠‰∏≠Ëó•ÂàóË°®
                selectedHerbsForModalEditFormula = formula.herbs ? [...formula.herbs] : [];
                updateModalEditSelectedHerbsDisplay();
                updateModalEditFormulaCompositionText();
                
                // Ê∏ÖÁ©∫ÊêúÂ∞ãÊ¨Ñ‰Ωç
                document.getElementById('modalEditHerbSearchInput').value = '';
                document.getElementById('modalEditHerbDosageInput').value = '';
                
                showModal('editFormulaModal');
            }
        }

        // Êõ¥Êñ∞ÊñπÂäëÔºàË¶ñÁ™óÁâàÊú¨Ôºâ
        function updateFormulaModal(event) {
            event.preventDefault();
            
            // È©óË≠âÊòØÂê¶ÊúâÊ∑ªÂä†‰∏≠Ëó•
            if (selectedHerbsForModalEditFormula.length === 0) {
                showNotification('Ë´ãËá≥Â∞ëÊ∑ªÂä†‰∏ÄÂë≥‰∏≠Ëó•', 'error');
                return;
            }
            
            const formulaId = parseInt(document.getElementById('modalEditFormulaId').value);
            const formulaIndex = formulas.findIndex(f => f.id === formulaId);
            
            if (formulaIndex !== -1) {
                const oldName = formulas[formulaIndex].name;
                formulas[formulaIndex] = {
                    id: formulaId,
                    name: document.getElementById('modalEditFormulaName').value,
                    source: document.getElementById('modalEditFormulaSource').value,
                    composition: document.getElementById('modalEditFormulaComposition').value,
                    precautions: document.getElementById('modalEditFormulaPrecautions').value,
                    herbs: [...selectedHerbsForModalEditFormula]
                };
                
                closeModal('editFormulaModal');
                loadHerbalItems();
                showNotification(`ÊñπÂäë "${oldName}" Â∑≤Êõ¥Êñ∞ÁÇ∫ "${formulas[formulaIndex].name}"`);
            }
        }

        // Êõ¥Êñ∞ÊñπÂäëÔºàÂéüÁâàÊú¨‰øùÁïôÔºâ
        function updateFormula(event) {
            event.preventDefault();
            
            // È©óË≠âÊòØÂê¶ÊúâÊ∑ªÂä†‰∏≠Ëó•
            if (selectedHerbsForEditFormula.length === 0) {
                showNotification('Ë´ãËá≥Â∞ëÊ∑ªÂä†‰∏ÄÂë≥‰∏≠Ëó•', 'error');
                return;
            }
            
            const formulaId = parseInt(document.getElementById('editFormulaId').value);
            const formulaIndex = formulas.findIndex(f => f.id === formulaId);
            
            if (formulaIndex !== -1) {
                const oldName = formulas[formulaIndex].name;
                formulas[formulaIndex] = {
                    id: formulaId,
                    name: document.getElementById('editFormulaName').value,
                    source: document.getElementById('editFormulaSource').value,
                    composition: document.getElementById('editFormulaComposition').value,
                    precautions: document.getElementById('editFormulaPrecautions').value,
                    herbs: [...selectedHerbsForEditFormula]
                };
                
                showNotification(`ÊñπÂäë "${oldName}" Â∑≤Êõ¥Êñ∞ÁÇ∫ "${formulas[formulaIndex].name}"`);
                showHerbalLibrary();
            }
        }

        // Êü•Áúã‰∏≠Ëó•Ë©≥ÊÉÖ
        function viewHerbDetail(id) {
            const herb = herbs.find(h => h.id === id);
            if (herb) {
                const content = `
                    <div class="space-y-4">
                        <div class="text-center border-b border-gray-200 pb-4">
                            <h4 class="text-2xl font-bold text-amber-800">${herb.name}</h4>
                        </div>
                        
                        <div class="bg-amber-50 rounded-lg p-4 text-center">
                            <p class="text-gray-700">‰∏≠Ëó•ÂêçÁ®±Ôºö${herb.name}</p>
                        </div>
                    </div>
                `;
                document.getElementById('herbDetailContent').innerHTML = content;
                showModal('herbDetailModal');
            }
        }

        // Êü•ÁúãÊñπÂäëË©≥ÊÉÖ
        function viewFormulaDetail(id) {
            const formula = formulas.find(f => f.id === id);
            if (formula) {
                const content = `
                    <div class="space-y-4">
                        <div class="text-center border-b border-gray-200 pb-4">
                            <h4 class="text-2xl font-bold text-blue-800">${formula.name}</h4>
                            ${formula.source ? `<p class="text-blue-600 mt-1">Âá∫ËôïÔºö${formula.source}</p>` : ''}
                        </div>
                        
                        <div class="bg-blue-50 rounded-lg p-4">
                            <h5 class="font-semibold text-blue-800 mb-2">ÁµÑÊàê</h5>
                            <p class="text-gray-700">${formula.composition}</p>
                        </div>
                        
                        ${formula.precautions ? `
                        <div class="bg-red-50 rounded-lg p-4">
                            <h5 class="font-semibold text-red-800 mb-2">Ê≥®ÊÑè‰∫ãÈ†Ö</h5>
                            <p class="text-gray-700">${formula.precautions}</p>
                        </div>
                        ` : ''}
                    </div>
                `;
                document.getElementById('formulaDetailContent').innerHTML = content;
                showModal('formulaDetailModal');
            }
        }

        // Âà™Èô§‰∏≠Ëó•
        function deleteHerb(id) {
            const herb = herbs.find(h => h.id === id);
            if (herb) {
                // Ë®≠ÂÆöÁ¢∫Ë™çÂà™Èô§ÊåâÈàïÁöÑ‰∫ã‰ª∂
                document.getElementById('confirmDeleteBtn').onclick = function() {
                    herbs = herbs.filter(h => h.id !== id);
                    loadHerbalItems();
                    closeModal('confirmDeleteModal');
                    showNotification(`‰∏≠Ëó• "${herb.name}" Â∑≤Âà™Èô§`);
                };
                showModal('confirmDeleteModal');
            }
        }

        // Âà™Èô§ÊñπÂäë
        function deleteFormula(id) {
            const formula = formulas.find(f => f.id === id);
            if (formula) {
                // Ë®≠ÂÆöÁ¢∫Ë™çÂà™Èô§ÊåâÈàïÁöÑ‰∫ã‰ª∂
                document.getElementById('confirmDeleteBtn').onclick = function() {
                    formulas = formulas.filter(f => f.id !== id);
                    loadHerbalItems();
                    closeModal('confirmDeleteModal');
                    showNotification(`ÊñπÂäë "${formula.name}" Â∑≤Âà™Èô§`);
                };
                showModal('confirmDeleteModal');
            }
        }

        // È°ØÁ§∫Á≥ªÁµ±ÁÆ°ÁêÜ
        function showSystemManagement() {
            hideAllPages();
            document.getElementById('systemManagement').classList.remove('hidden');
        }



        // Êü•ÁúãÁóÖÊ≠∑Ë®òÈåÑ
        function viewMedicalRecord(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) {
                showNotification('Êâæ‰∏çÂà∞ÊéõËôüË®òÈåÑ', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            if (!patient) {
                showNotification('Êâæ‰∏çÂà∞ÁóÖ‰∫∫Ë≥áÊñô', 'error');
                return;
            }
            
            // Áç≤ÂèñË©≤ÁóÖ‰∫∫ÁöÑÊâÄÊúâÁóÖÊ≠∑Ë®òÈåÑÔºàÊåâÊó•ÊúüÊéíÂ∫èÔºåÊúÄÊó©ÁöÑÂú®ÂâçÔºâ
            const patientRecords = medicalRecords
                .filter(record => record.patientId === appointment.patientId && record.status === 'completed')
                .sort((a, b) => new Date(a.consultationDate) - new Date(b.consultationDate));
            
            if (patientRecords.length === 0) {
                showNotification('Ê≠§ÁóÖ‰∫∫Êö´ÁÑ°ÁóÖÊ≠∑Ë®òÈåÑ', 'info');
                return;
            }
            
            // È°ØÁ§∫ÁóÖ‰∫∫ÊâÄÊúâÁóÖÊ≠∑Ë®òÈåÑÔºàÂ∏∂ÂàÜÈ†ÅÂäüËÉΩÔºâÔºåÈ†êË®≠È°ØÁ§∫Ë©≤Ê¨°Ë®∫ÁóáÁöÑÁóÖÊ≠∑
            viewPatientAllMedicalRecordsWithPagination(patient, patientRecords, appointmentId);
        }

        // Êü•ÁúãÁóÖ‰∫∫ÊâÄÊúâÁóÖÊ≠∑Ë®òÈåÑÔºàÁ∞°ÂåñÁâàÔºâ
        function viewPatientAllMedicalRecordsWithPagination(patient, records, currentAppointmentId = null) {
            // ÊØèÊ¨°ÁóÖÊ≠∑ÈÉΩÁÆó‰∏ÄÈ†ÅÔºåÊúÄÊñ∞ÁöÑÂú®ÊúÄÂæå‰∏ÄÈ†Å
            let currentPage = records.length; // È†êË®≠È°ØÁ§∫ÊúÄÊñ∞ÁöÑÁóÖÊ≠∑ÔºàÊúÄÂæå‰∏ÄÈ†ÅÔºâ
            const totalPages = records.length;
            
            // Â¶ÇÊûúÊúâÊåáÂÆöÁöÑappointmentIdÔºåÊâæÂà∞Â∞çÊáâÁöÑÁóÖÊ≠∑Ë®òÈåÑ‰∏¶Ë®≠ÁÇ∫Áï∂ÂâçÈ†Å
            if (currentAppointmentId) {
                const targetRecordIndex = records.findIndex(record => record.appointmentId === currentAppointmentId);
                if (targetRecordIndex >= 0) {
                    currentPage = targetRecordIndex + 1; // ËΩâÊèõÁÇ∫È†ÅÁ¢ºÔºàÂæû1ÈñãÂßãÔºâ
                }
            }
            
            function renderPage(page) {
                // Á¨¨1È†Å = ÊúÄÊó©ÁöÑÁóÖÊ≠∑ÔºåÊúÄÂæå‰∏ÄÈ†Å = ÊúÄÊñ∞ÁöÑÁóÖÊ≠∑
                const record = records[page - 1]; // Áõ¥Êé•Á¥¢ÂºïÔºåÂõ†ÁÇ∫recordsÂ∑≤Á∂ìÊåâÊó•ÊúüÊéíÂ∫è
                
                if (!record) return;
                
                const consultationDate = new Date(record.consultationDate);
                const isCurrentAppointment = record.appointmentId === currentAppointmentId;
                const isDraft = record.status === 'draft';
                
                const content = `
                    <div class="space-y-4">
                        <!-- ÁóÖ‰∫∫Âü∫Êú¨Ë≥áË®ä -->
                        <div class="bg-blue-50 rounded-lg p-4">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h4 class="text-lg font-semibold text-blue-800">${patient.patientNumber} - ${patient.name}</h4>
                                    <p class="text-sm text-blue-600">${patient.gender} ¬∑ ${calculateAge(patient.birthDate)}Ê≠≤ ¬∑ Á∏ΩË®∫Áóá ${records.length} Ê¨°</p>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm text-gray-600">Á¨¨ ${page} Ê¨°Ë®∫Áóá</div>
                                    <div class="text-xs text-gray-500">${consultationDate.toLocaleDateString('zh-TW')}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ÂàÜÈ†ÅÊéßÂà∂ -->
                        <div class="bg-white rounded-lg border border-gray-200">
                            <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex justify-between items-center">
                                <h4 class="text-lg font-semibold text-gray-800">üìã ÁóÖÊ≠∑Ë®òÈåÑ</h4>
                                <div class="flex items-center space-x-2">
                                    <button onclick="changePage(1)" 
                                            ${page === 1 ? 'disabled' : ''} 
                                            class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed">
                                        Á¨¨1Ê¨°
                                    </button>
                                    <button onclick="changePage(${page - 1})" 
                                            ${page === 1 ? 'disabled' : ''} 
                                            class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed">
                                        ‰∏ä‰∏ÄÊ¨°
                                    </button>
                                    <span class="px-3 py-1 text-sm bg-gray-100 rounded">
                                        Á¨¨ ${page} Ê¨°Ë®∫Áóá
                                    </span>
                                    <button onclick="changePage(${page + 1})" 
                                            ${page === totalPages ? 'disabled' : ''} 
                                            class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed">
                                        ‰∏ã‰∏ÄÊ¨°
                                    </button>
                                    <button onclick="changePage(${totalPages})" 
                                            ${page === totalPages ? 'disabled' : ''} 
                                            class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed">
                                        ÊúÄÊñ∞
                                    </button>
                                </div>
                            </div>
                            
                            <!-- ÂñÆÁ≠ÜÁóÖÊ≠∑Ë®òÈåÑ -->
                            <div class="p-6 ${isCurrentAppointment ? 'bg-yellow-50' : ''}">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="flex items-center space-x-3">
                                        <h5 class="text-xl font-semibold text-gray-800">Á¨¨ ${page} Ê¨°Ë®∫Áóá</h5>
                                        ${isDraft ? `
                                            <span class="bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-xs font-medium">ËçâÁ®ø</span>
                                        ` : `
                                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium">Â∑≤ÂÆåÊàê</span>
                                        `}
                                        ${isCurrentAppointment ? `
                                            <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-medium">Êú¨Ê¨°Ë®∫Áóá</span>
                                        ` : ''}
                                    </div>
                                    <div class="text-right text-sm text-gray-600">
                                        <div>${consultationDate.toLocaleDateString('zh-TW')} ${record.consultationTime}</div>
                                        <div>ÈÜ´Â∏´Ôºö${record.consultingDoctor}</div>
                                    </div>
                                </div>
                                
                                <!-- ÁóÖÊ≠∑ÂÖßÂÆπ -->
                                <div class="space-y-4">
                                    <div class="bg-green-50 rounded-lg p-4">
                                        <h6 class="font-semibold text-green-800 mb-2">‰∏ªË®¥</h6>
                                        <p class="text-gray-700">${record.chiefComplaint}</p>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="bg-indigo-50 rounded-lg p-4">
                                            <h6 class="font-semibold text-indigo-800 mb-2">‰∏≠ÈÜ´Ë®∫Êñ∑</h6>
                                            <p class="text-gray-700">${record.tcmDiagnosis}</p>
                                            ${record.syndromePattern ? `<p class="text-gray-600 text-sm mt-1">Ë≠âÂûãÔºö${record.syndromePattern}</p>` : ''}
                                        </div>
                                        
                                        ${record.presentIllness ? `
                                        <div class="bg-amber-50 rounded-lg p-4">
                                            <h6 class="font-semibold text-amber-800 mb-2">ÁèæÁóÖÂè≤</h6>
                                            <p class="text-gray-700 text-sm">${record.presentIllness}</p>
                                        </div>
                                        ` : ''}
                                    </div>
                                    
                                    <div class="bg-teal-50 rounded-lg p-4">
                                        <h6 class="font-semibold text-teal-800 mb-2">ËôïÊñπ</h6>
                                        <div class="bg-white rounded border p-3 mb-3">
                                            <pre class="text-sm text-gray-800 whitespace-pre-wrap">${record.prescriptionContent}</pre>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                            <div>
                                                <span class="font-medium text-gray-700">ÊúçÁî®ÊñπÊ≥ïÔºö</span>
                                                <span class="text-gray-600">${record.dosageInstructions}</span>
                                            </div>
                                            ${record.treatmentDuration ? `
                                            <div>
                                                <span class="font-medium text-gray-700">ÁôÇÁ®ãÔºö</span>
                                                <span class="text-gray-600">${record.treatmentDuration}</span>
                                            </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                    
                                    ${record.medicalAdvice ? `
                                    <div class="bg-orange-50 rounded-lg p-4">
                                        <h6 class="font-semibold text-orange-800 mb-2">ÈÜ´Âõë</h6>
                                        <p class="text-gray-700 text-sm">${record.medicalAdvice}</p>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('medicalRecordDetailContent').innerHTML = content;
            }
            
            // ÂàÜÈ†ÅÂàáÊèõÂáΩÊï∏
            window.changePage = function(page) {
                if (page >= 1 && page <= totalPages) {
                    currentPage = page;
                    renderPage(currentPage);
                }
            };
            
            // ÂàùÂßãÂåñÈ°ØÁ§∫ÊúÄÊñ∞ÁöÑÁóÖÊ≠∑ÔºàÊúÄÂæå‰∏ÄÈ†ÅÔºâ
            renderPage(currentPage);
            showModal('medicalRecordDetailModal');
        }

        // Êü•ÁúãÁóÖ‰∫∫ÊâÄÊúâÁóÖÊ≠∑Ë®òÈåÑ
        function viewPatientAllMedicalRecords(patient, records, currentAppointmentId = null) {
            const content = `
                <div class="space-y-6">
                    <!-- ÁóÖ‰∫∫Âü∫Êú¨Ë≥áË®ä -->
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-blue-800 mb-3">ÁóÖ‰∫∫Âü∫Êú¨Ë≥áË®ä</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <span class="text-sm font-medium text-gray-600">ÁóÖ‰∫∫Á∑®ËôüÔºö</span>
                                <span class="text-blue-600 font-mono font-bold">${patient.patientNumber}</span>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-600">ÂßìÂêçÔºö</span>
                                <span class="text-gray-800">${patient.name}</span>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-600">ÊÄßÂà•Ôºö</span>
                                <span class="text-gray-800">${patient.gender}</span>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-600">Âπ¥ÈΩ°Ôºö</span>
                                <span class="text-gray-800">${calculateAge(patient.birthDate)} Ê≠≤</span>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-600">ÈõªË©±Ôºö</span>
                                <span class="text-gray-800">${patient.phone}</span>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-600">Á∏ΩË®∫ÁóáÊ¨°Êï∏Ôºö</span>
                                <span class="text-green-600 font-bold">${records.filter(r => r.status === 'completed').length} Ê¨°</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ÁóÖÊ≠∑Ë®òÈåÑÂàóË°® -->
                    <div class="bg-white rounded-lg border border-gray-200">
                        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                            <h4 class="text-lg font-semibold text-gray-800">üìã ÁóÖÊ≠∑Ë®òÈåÑ (ÂÖ± ${records.length} Á≠Ü)</h4>
                            <p class="text-sm text-gray-600 mt-1">ÊåâË®∫ÁóáÊó•ÊúüÊéíÂ∫èÔºåÊúÄÊñ∞ÁöÑÂú®Ââç</p>
                        </div>
                        
                        <div class="divide-y divide-gray-200">
                            ${records.map((record, index) => {
                                const consultationDate = new Date(record.consultationDate);
                                const isCurrentAppointment = record.appointmentId === currentAppointmentId;
                                const isDraft = record.status === 'draft';
                                
                                return `
                                    <div class="p-6 ${isCurrentAppointment ? 'bg-yellow-50 border-l-4 border-yellow-400' : ''} hover:bg-gray-50 transition-colors">
                                        <div class="flex justify-between items-start mb-4">
                                            <div class="flex-1">
                                                <div class="flex items-center space-x-3 mb-2">
                                                    <h5 class="text-lg font-semibold text-gray-800">
                                                        Á¨¨ ${records.length - index} Ê¨°Ë®∫Áóá
                                                    </h5>
                                                    ${isDraft ? `
                                                        <span class="bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-xs font-medium">
                                                            ËçâÁ®ø
                                                        </span>
                                                    ` : `
                                                        <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium">
                                                            Â∑≤ÂÆåÊàê
                                                        </span>
                                                    `}
                                                    ${isCurrentAppointment ? `
                                                        <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-medium">
                                                            Êú¨Ê¨°Ë®∫Áóá
                                                        </span>
                                                    ` : ''}
                                                </div>
                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                                    <div>
                                                        <span class="font-medium text-gray-600">Ë®∫ÁóáÊó•ÊúüÔºö</span>
                                                        <span class="text-gray-800">${consultationDate.toLocaleDateString('zh-TW')}</span>
                                                    </div>
                                                    <div>
                                                        <span class="font-medium text-gray-600">Ë®∫ÁóáÊôÇÈñìÔºö</span>
                                                        <span class="text-gray-800">${record.consultationTime}</span>
                                                    </div>
                                                    <div>
                                                        <span class="font-medium text-gray-600">‰∏ªË®∫ÈÜ´Â∏´Ôºö</span>
                                                        <span class="text-gray-800">${record.consultingDoctor}</span>
                                                    </div>
                                                    <div>
                                                        <span class="font-medium text-gray-600">Âª∫Á´ãÊôÇÈñìÔºö</span>
                                                        <span class="text-gray-800">${new Date(record.createdAt).toLocaleDateString('zh-TW')}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <button onclick="viewMedicalRecordDetail(${record.id})" 
                                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                                Êü•ÁúãË©≥ÊÉÖ
                                            </button>
                                        </div>
                                        
                                        <!-- ÁóÖÊ≠∑ÊëòË¶Å -->
                                        <div class="bg-gray-50 rounded-lg p-4">
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div>
                                                    <h6 class="font-medium text-gray-700 mb-1">‰∏ªË®¥</h6>
                                                    <p class="text-gray-600 text-sm line-clamp-2">${record.chiefComplaint}</p>
                                                </div>
                                                <div>
                                                    <h6 class="font-medium text-gray-700 mb-1">Ë®∫Êñ∑</h6>
                                                    <p class="text-gray-600 text-sm">
                                                        ${record.tcmDiagnosis}${record.syndromePattern ? ` - ${record.syndromePattern}` : ''}
                                                    </p>
                                                </div>
                                            </div>
                                            ${record.prescriptionContent ? `
                                                <div class="mt-3 pt-3 border-t border-gray-200">
                                                    <h6 class="font-medium text-gray-700 mb-1">ËôïÊñπÊëòË¶Å</h6>
                                                    <p class="text-gray-600 text-sm line-clamp-2">${record.prescriptionContent.split('\n').slice(0, 3).join(', ')}${record.prescriptionContent.split('\n').length > 3 ? '...' : ''}</p>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- Áµ±Ë®àË≥áË®ä -->
                    <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">üìä Ë®∫ÁôÇÁµ±Ë®à</h4>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
                            <div class="bg-white rounded-lg p-3">
                                <div class="text-2xl font-bold text-blue-600">${records.filter(r => r.status === 'completed').length}</div>
                                <div class="text-sm text-gray-600">ÂÆåÊàêË®∫Áóá</div>
                            </div>
                            <div class="bg-white rounded-lg p-3">
                                <div class="text-2xl font-bold text-orange-600">${records.filter(r => r.status === 'draft').length}</div>
                                <div class="text-sm text-gray-600">ËçâÁ®øË®òÈåÑ</div>
                            </div>
                            <div class="bg-white rounded-lg p-3">
                                <div class="text-2xl font-bold text-green-600">
                                    ${records.length > 0 ? Math.round((new Date() - new Date(records[records.length - 1].consultationDate)) / (1000 * 60 * 60 * 24)) : 0}
                                </div>
                                <div class="text-sm text-gray-600">È¶ñË®∫Ëá≥‰ªäÂ§©Êï∏</div>
                            </div>
                            <div class="bg-white rounded-lg p-3">
                                <div class="text-2xl font-bold text-purple-600">
                                    ${records.length > 1 ? Math.round((new Date(records[0].consultationDate) - new Date(records[records.length - 1].consultationDate)) / (1000 * 60 * 60 * 24 * (records.length - 1))) : 0}
                                </div>
                                <div class="text-sm text-gray-600">Âπ≥ÂùáË®∫ÁôÇÈñìÈöî(Â§©)</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('medicalRecordDetailContent').innerHTML = content;
            showModal('medicalRecordDetailModal');
        }

        // Êü•ÁúãÁóÖÊ≠∑Ë©≥ÊÉÖ
        function viewMedicalRecordDetail(recordId) {
            const record = medicalRecords.find(r => r.id === recordId);
            if (!record) {
                showNotification('Êâæ‰∏çÂà∞ÁóÖÊ≠∑Ë®òÈåÑ', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === record.patientId);
            const consultationDate = new Date(record.consultationDate);
            
            const content = `
                <div class="space-y-6">
                    <!-- ÁóÖ‰∫∫Âü∫Êú¨Ë≥áË®ä -->
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-blue-800 mb-3">ÁóÖ‰∫∫Âü∫Êú¨Ë≥áË®ä</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <span class="text-sm font-medium text-gray-600">ÁóÖ‰∫∫Á∑®ËôüÔºö</span>
                                <span class="text-blue-600 font-mono font-bold">${record.patientNumber}</span>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-600">ÂßìÂêçÔºö</span>
                                <span class="text-gray-800">${record.patientName}</span>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-600">Âπ¥ÈΩ°Ôºö</span>
                                <span class="text-gray-800">${patient ? calculateAge(patient.birthDate) : 'Êú™Áü•'} Ê≠≤</span>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-600">Ë®∫ÁóáÊó•ÊúüÔºö</span>
                                <span class="text-gray-800">${consultationDate.toLocaleDateString('zh-TW')}</span>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-600">Ë®∫ÁóáÊôÇÈñìÔºö</span>
                                <span class="text-gray-800">${record.consultationTime}</span>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-600">‰∏ªË®∫ÈÜ´Â∏´Ôºö</span>
                                <span class="text-gray-800">${record.consultingDoctor}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ‰∏ªË®¥ -->
                    <div class="bg-green-50 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-green-800 mb-3">‰∏ªË®¥</h4>
                        <p class="text-gray-700">${record.chiefComplaint}</p>
                    </div>
                    
                    ${record.presentIllness ? `
                    <!-- ÁèæÁóÖÂè≤ -->
                    <div class="bg-amber-50 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-amber-800 mb-3">ÁèæÁóÖÂè≤</h4>
                        <p class="text-gray-700">${record.presentIllness}</p>
                    </div>
                    ` : ''}
                    
                    ${record.pastMedicalHistory || record.allergyHistory ? `
                    <!-- Êó¢ÂæÄÂè≤ -->
                    <div class="bg-purple-50 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-purple-800 mb-3">Êó¢ÂæÄÂè≤</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${record.pastMedicalHistory ? `
                            <div>
                                <h5 class="font-medium text-gray-700 mb-2">ÈÅéÂæÄÁñæÁóÖÂè≤</h5>
                                <p class="text-gray-600 text-sm">${record.pastMedicalHistory}</p>
                            </div>
                            ` : ''}
                            ${record.allergyHistory ? `
                            <div>
                                <h5 class="font-medium text-gray-700 mb-2">Ëó•Áâ©ÈÅéÊïèÂè≤</h5>
                                <p class="text-gray-600 text-sm">${record.allergyHistory}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${record.inspection || record.auscultation || record.inquiry || record.palpation ? `
                    <!-- ‰∏≠ÈÜ´ÂõõË®∫ -->
                    <div class="bg-red-50 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-red-800 mb-3">‰∏≠ÈÜ´ÂõõË®∫</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${record.inspection ? `
                            <div>
                                <h5 class="font-medium text-gray-700 mb-2">ÊúõË®∫</h5>
                                <p class="text-gray-600 text-sm">${record.inspection}</p>
                            </div>
                            ` : ''}
                            ${record.auscultation ? `
                            <div>
                                <h5 class="font-medium text-gray-700 mb-2">ËÅûË®∫</h5>
                                <p class="text-gray-600 text-sm">${record.auscultation}</p>
                            </div>
                            ` : ''}
                            ${record.inquiry ? `
                            <div>
                                <h5 class="font-medium text-gray-700 mb-2">ÂïèË®∫</h5>
                                <p class="text-gray-600 text-sm">${record.inquiry}</p>
                            </div>
                            ` : ''}
                            ${record.palpation ? `
                            <div>
                                <h5 class="font-medium text-gray-700 mb-2">ÂàáË®∫</h5>
                                <p class="text-gray-600 text-sm">${record.palpation}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- ‰∏≠ÈÜ´Ë®∫Êñ∑ -->
                    <div class="bg-indigo-50 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-indigo-800 mb-3">‰∏≠ÈÜ´Ë®∫Êñ∑</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <h5 class="font-medium text-gray-700 mb-2">ÁóÖÂêçË®∫Êñ∑</h5>
                                <p class="text-gray-800 font-medium">${record.tcmDiagnosis}</p>
                            </div>
                            <div>
                                <h5 class="font-medium text-gray-700 mb-2">Ë≠âÂûãË®∫Êñ∑</h5>
                                <p class="text-gray-800 font-medium">${record.syndromePattern || 'Êú™Â°´ÂØ´'}</p>
                            </div>
                        </div>
                        ${record.diagnosisBasis ? `
                        <div>
                            <h5 class="font-medium text-gray-700 mb-2">Ë®∫Êñ∑‰æùÊìö</h5>
                            <p class="text-gray-600 text-sm">${record.diagnosisBasis}</p>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Ê≤ªÁôÇÊñπÊ°à -->
                    <div class="bg-teal-50 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-teal-800 mb-3">Ê≤ªÁôÇÊñπÊ°à</h4>
                        ${record.treatmentPrinciple ? `
                        <div class="mb-4">
                            <h5 class="font-medium text-gray-700 mb-2">Ê≤ªÊ≥ï</h5>
                            <p class="text-gray-800">${record.treatmentPrinciple}</p>
                        </div>
                        ` : ''}
                        ${record.prescriptionName ? `
                        <div class="mb-4">
                            <h5 class="font-medium text-gray-700 mb-2">ÊñπÂäëÂêçÁ®±</h5>
                            <p class="text-gray-800">${record.prescriptionName}</p>
                        </div>
                        ` : ''}
                        <div class="mb-4">
                            <h5 class="font-medium text-gray-700 mb-2">ËôïÊñπÂÖßÂÆπ</h5>
                            <div class="bg-white rounded border p-3">
                                <pre class="text-sm text-gray-800 whitespace-pre-wrap font-mono">${record.prescriptionContent}</pre>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h5 class="font-medium text-gray-700 mb-2">ÊúçÁî®ÊñπÊ≥ï</h5>
                                <p class="text-gray-800">${record.dosageInstructions}</p>
                            </div>
                            ${record.treatmentDuration ? `
                            <div>
                                <h5 class="font-medium text-gray-700 mb-2">ÁôÇÁ®ã</h5>
                                <p class="text-gray-800">${record.treatmentDuration}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    ${record.medicalAdvice ? `
                    <!-- ÈÜ´ÂõëÂèäÊ≥®ÊÑè‰∫ãÈ†Ö -->
                    <div class="bg-orange-50 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-orange-800 mb-3">ÈÜ´ÂõëÂèäÊ≥®ÊÑè‰∫ãÈ†Ö</h4>
                        <p class="text-gray-700">${record.medicalAdvice}</p>
                    </div>
                    ` : ''}
                    
                    <!-- Ë®òÈåÑË≥áË®ä -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">Ë®òÈåÑË≥áË®ä</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="font-medium text-gray-600">Âª∫Á´ãÊôÇÈñìÔºö</span>
                                <span class="text-gray-800">${new Date(record.createdAt).toLocaleString('zh-TW')}</span>
                            </div>
                            <div>
                                <span class="font-medium text-gray-600">Âª∫Á´ãËÄÖÔºö</span>
                                <span class="text-gray-800">${userNames[record.createdBy] || record.createdBy}</span>
                            </div>
                            ${record.lastModified ? `
                            <div>
                                <span class="font-medium text-gray-600">ÊúÄÂæå‰øÆÊîπÔºö</span>
                                <span class="text-gray-800">${new Date(record.lastModified).toLocaleString('zh-TW')}</span>
                            </div>
                            <div>
                                <span class="font-medium text-gray-600">‰øÆÊîπËÄÖÔºö</span>
                                <span class="text-gray-800">${userNames[record.modifiedBy] || record.modifiedBy}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    ${record.modificationHistory && record.modificationHistory.length > 0 ? `
                    <!-- ‰øÆÊîπÊ≠∑Âè≤ -->
                    <div class="bg-yellow-50 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-semibold text-yellow-800">üìù ‰øÆÊîπÊ≠∑Âè≤</h4>
                            <button onclick="toggleModificationHistory()" id="toggleHistoryBtn" class="text-yellow-600 hover:text-yellow-800 text-sm font-medium">
                                Â±ïÈñãÊ≠∑Âè≤ ‚ñº
                            </button>
                        </div>
                        <div id="modificationHistoryContent" class="hidden">
                            <div class="space-y-4">
                                ${record.modificationHistory.map((history, index) => `
                                    <div class="bg-white rounded-lg p-4 border border-yellow-200">
                                        <div class="flex justify-between items-center mb-3">
                                            <h5 class="font-medium text-gray-800">‰øÆÊîπË®òÈåÑ #${record.modificationHistory.length - index}</h5>
                                            <div class="text-sm text-gray-600">
                                                ${new Date(history.modifiedAt).toLocaleString('zh-TW')} 
                                                by ${userNames[history.modifiedBy] || history.modifiedBy}
                                            </div>
                                        </div>
                                        <div class="space-y-3">
                                            ${Object.entries(history.changes).map(([field, change]) => {
                                                if (change.from !== change.to) {
                                                    const fieldNames = {
                                                        chiefComplaint: '‰∏ªË®¥',
                                                        presentIllness: 'ÁèæÁóÖÂè≤',
                                                        tcmDiagnosis: '‰∏≠ÈÜ´Ë®∫Êñ∑',
                                                        syndromePattern: 'Ë≠âÂûãË®∫Êñ∑',
                                                        prescriptionContent: 'ËôïÊñπÂÖßÂÆπ',
                                                        dosageInstructions: 'ÊúçÁî®ÊñπÊ≥ï',
                                                        treatmentDuration: 'ÁôÇÁ®ã',
                                                        medicalAdvice: 'ÈÜ´ÂõëÂèäÊ≥®ÊÑè‰∫ãÈ†Ö'
                                                    };
                                                    return `
                                                        <div class="border-l-4 border-yellow-400 pl-4">
                                                            <div class="font-medium text-gray-700 mb-1">${fieldNames[field] || field}</div>
                                                            <div class="text-sm">
                                                                <div class="text-red-600 mb-1">
                                                                    <span class="font-medium">‰øÆÊîπÂâçÔºö</span>
                                                                    <span class="bg-red-50 px-2 py-1 rounded">${change.from || '(Á©∫ÁôΩ)'}</span>
                                                                </div>
                                                                <div class="text-green-600">
                                                                    <span class="font-medium">‰øÆÊîπÂæåÔºö</span>
                                                                    <span class="bg-green-50 px-2 py-1 rounded">${change.to || '(Á©∫ÁôΩ)'}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    `;
                                                }
                                                return '';
                                            }).filter(item => item !== '').join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('medicalRecordDetailContent').innerHTML = content;
            showModal('medicalRecordDetailModal');
        }

        // Êü•ÁúãÁóÖ‰∫∫ÁóÖÊ≠∑Ë®òÈåÑ
        function viewPatientMedicalRecords(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) {
                showNotification('Êâæ‰∏çÂà∞ÁóÖ‰∫∫Ë≥áÊñô', 'error');
                return;
            }
            
            hideAllPages();
            document.getElementById('patientMedicalRecords').classList.remove('hidden');
            document.getElementById('currentPatientName').textContent = `ÁóÖ‰∫∫Ôºö${patient.patientNumber} - ${patient.name}`;
            
            // Ê∏ÖÁ©∫ÁØ©ÈÅ∏Ê¢ù‰ª∂
            document.getElementById('patientRecordDateFrom').value = '';
            document.getElementById('patientRecordDateTo').value = '';
            
            // ÂÑ≤Â≠òÁï∂ÂâçÁóÖ‰∫∫ID
            window.currentPatientId = patientId;
            
            loadPatientMedicalRecordsList();
        }

        // ËºâÂÖ•ÁóÖ‰∫∫ÁóÖÊ≠∑Ë®òÈåÑÂàóË°®
        function loadPatientMedicalRecordsList(filteredRecords = null) {
            const tbody = document.getElementById('patientMedicalRecordsList');
            const patientRecords = medicalRecords.filter(record => 
                record.patientId === window.currentPatientId && record.status === 'completed'
            );
            
            const recordsToShow = filteredRecords || patientRecords;
            
            if (recordsToShow.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="border border-gray-200 px-4 py-8 text-center text-gray-500">
                            ${filteredRecords ? 'Ê≤íÊúâÊâæÂà∞Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑÁóÖÊ≠∑Ë®òÈåÑ' : 'Ê≠§ÁóÖ‰∫∫Êö´ÁÑ°ÁóÖÊ≠∑Ë®òÈåÑ'}
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = recordsToShow.map(record => {
                const consultationDate = new Date(record.consultationDate);
                const dateString = consultationDate.toLocaleDateString('zh-TW');
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-200 px-4 py-3">${dateString}</td>
                        <td class="border border-gray-200 px-4 py-3">
                            <div class="max-w-xs truncate" title="${record.chiefComplaint}">
                                ${record.chiefComplaint}
                            </div>
                        </td>
                        <td class="border border-gray-200 px-4 py-3">
                            <div class="max-w-xs truncate" title="${record.tcmDiagnosis}">
                                ${record.tcmDiagnosis}
                            </div>
                        </td>
                        <td class="border border-gray-200 px-4 py-3">${record.consultingDoctor}</td>
                        <td class="border border-gray-200 px-4 py-3">
                            <button onclick="viewMedicalRecordDetail(${record.id})" class="text-purple-600 hover:text-purple-800 text-sm font-medium">
                                Êü•ÁúãË©≥ÊÉÖ
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ÁØ©ÈÅ∏ÁóÖ‰∫∫ÁóÖÊ≠∑Ë®òÈåÑÔºàÊåâÊó•ÊúüÔºâ
        function filterPatientMedicalRecords() {
            const dateFrom = document.getElementById('patientRecordDateFrom').value;
            const dateTo = document.getElementById('patientRecordDateTo').value;
            
            let filteredRecords = medicalRecords.filter(record => 
                record.patientId === window.currentPatientId && record.status === 'completed'
            );
            
            // ÊáâÁî®Êó•ÊúüÁØ©ÈÅ∏
            if (dateFrom || dateTo) {
                filteredRecords = filteredRecords.filter(record => {
                    const recordDate = new Date(record.consultationDate);
                    const fromDate = dateFrom ? new Date(dateFrom) : null;
                    const toDate = dateTo ? new Date(dateTo) : null;
                    
                    if (fromDate && recordDate < fromDate) return false;
                    if (toDate && recordDate > toDate) return false;
                    return true;
                });
            }
            
            loadPatientMedicalRecordsList(filteredRecords);
        }

        // Ë®≠ÂÆöÁóÖ‰∫∫ÁóÖÊ≠∑Êó•ÊúüÁØ©ÈÅ∏
        function setPatientDateFilter(period) {
            const today = new Date();
            const dateFromInput = document.getElementById('patientRecordDateFrom');
            const dateToInput = document.getElementById('patientRecordDateTo');
            
            let fromDate;
            
            switch (period) {
                case 'today':
                    fromDate = new Date(today);
                    break;
                case 'week':
                    fromDate = new Date(today);
                    fromDate.setDate(today.getDate() - 7);
                    break;
                case 'month':
                    fromDate = new Date(today);
                    fromDate.setMonth(today.getMonth() - 1);
                    break;
                default:
                    return;
            }
            
            dateFromInput.value = fromDate.toISOString().split('T')[0];
            dateToInput.value = today.toISOString().split('T')[0];
            
            filterPatientMedicalRecords();
        }

        // Ê∏ÖÈô§ÁóÖ‰∫∫ÁóÖÊ≠∑Êó•ÊúüÁØ©ÈÅ∏
        function clearPatientDateFilter() {
            document.getElementById('patientRecordDateFrom').value = '';
            document.getElementById('patientRecordDateTo').value = '';
            filterPatientMedicalRecords();
        }



        // ÂÑ≤Â≠òÁóÖÊ≠∑ÔºàÂéüÂÑ≤Â≠òËçâÁ®øÂäüËÉΩÔºâ
        function saveDraftRecord() {
            // È©óË≠âÂøÖÂ°´Ê¨Ñ‰Ωç
            const requiredFields = [
                { id: 'consultationDate', name: 'Ë®∫ÁóáÊó•Êúü' },
                { id: 'consultationTime', name: 'Ë®∫ÁóáÊôÇÈñì' },
                { id: 'consultingDoctor', name: '‰∏ªË®∫ÈÜ´Â∏´' },
                { id: 'chiefComplaint', name: '‰∏ªË®¥' },
                { id: 'tcmDiagnosis', name: '‰∏≠ÈÜ´Ë®∫Êñ∑' },
                { id: 'syndromePattern', name: 'Ë≠âÂûãË®∫Êñ∑' },
                { id: 'treatmentPrinciple', name: 'Ê≤ªÊ≥ï' },
                { id: 'prescriptionContent', name: 'ËôïÊñπÂÖßÂÆπ' },
                { id: 'dosageInstructions', name: 'ÊúçÁî®ÊñπÊ≥ï' }
            ];
            
            const missingFields = [];
            
            // ÂÖàÊ∏ÖÈô§ÊâÄÊúâÈåØË™§Ê®£Âºè
            requiredFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    element.classList.remove('border-red-500', 'bg-red-50');
                }
            });
            
            for (const field of requiredFields) {
                const element = document.getElementById(field.id);
                if (!element || !element.value.trim()) {
                    missingFields.push(field.name);
                    // ÁÇ∫Áº∫Â§±ÁöÑÊ¨Ñ‰ΩçÊ∑ªÂä†Á¥ÖËâ≤ÈÇäÊ°ÜÊèêÁ§∫
                    if (element) {
                        element.classList.add('border-red-500', 'bg-red-50');
                        element.addEventListener('input', function() {
                            if (this.value.trim()) {
                                this.classList.remove('border-red-500', 'bg-red-50');
                            }
                        }, { once: true });
                    }
                }
            }
            
            if (missingFields.length > 0) {
                showNotification(`Ë´ãÂ°´ÂØ´‰ª•‰∏ãÂøÖÂ°´Ê¨Ñ‰ΩçÔºö${missingFields.join('„ÄÅ')}`, 'error');
                // ÊªæÂãïÂà∞Á¨¨‰∏ÄÂÄãÁº∫Â§±ÁöÑÊ¨Ñ‰Ωç
                const firstMissingFieldId = requiredFields.find(field => {
                    const element = document.getElementById(field.id);
                    return !element || !element.value.trim();
                })?.id;
                
                if (firstMissingFieldId) {
                    const firstMissingField = document.getElementById(firstMissingFieldId);
                    if (firstMissingField) {
                        firstMissingField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        firstMissingField.focus();
                    }
                }
                return;
            }
            
            const patientId = parseInt(document.getElementById('recordPatientId').value);
            const appointmentId = parseInt(document.getElementById('recordAppointmentId').value);
            const patient = patients.find(p => p.id === patientId);
            
            const medicalRecord = {
                id: nextRecordId++,
                patientId: patientId,
                appointmentId: appointmentId,
                patientName: patient.name,
                patientNumber: patient.patientNumber,
                consultationDate: document.getElementById('consultationDate').value,
                consultationTime: document.getElementById('consultationTime').value,
                consultingDoctor: document.getElementById('consultingDoctor').value,
                chiefComplaint: document.getElementById('chiefComplaint').value,
                presentIllness: document.getElementById('presentIllness').value,
                pastMedicalHistory: document.getElementById('pastMedicalHistory').value,
                allergyHistory: document.getElementById('allergyHistory').value,
                inspection: document.getElementById('inspection').value,
                auscultation: document.getElementById('auscultation').value,
                inquiry: document.getElementById('inquiry').value,
                palpation: document.getElementById('palpation').value,
                tcmDiagnosis: document.getElementById('tcmDiagnosis').value,
                syndromePattern: document.getElementById('syndromePattern').value,
                diagnosisBasis: document.getElementById('diagnosisBasis').value,
                treatmentPrinciple: document.getElementById('treatmentPrinciple').value,
                prescriptionName: document.getElementById('prescriptionName').value,
                prescriptionContent: document.getElementById('prescriptionContent').value,
                dosageInstructions: document.getElementById('dosageInstructions').value,
                treatmentDuration: document.getElementById('treatmentDuration').value,
                medicalAdvice: document.getElementById('medicalAdvice').value,
                createdAt: new Date().toISOString(),
                createdBy: currentUser,
                status: 'completed'
            };
            
            medicalRecords.push(medicalRecord);
            
            // Êõ¥Êñ∞ÊéõËôüÁãÄÊÖãÁÇ∫Â∑≤ÂÆåÊàê
            updateAppointmentStatus(appointmentId, 'Â∑≤ÂÆåÊàê');
            
            showNotification(`ÁóÖÊ≠∑Â∑≤ÊàêÂäüÂÑ≤Â≠òÔºÅÁóÖ‰∫∫Ôºö${patient.name}`);
            showConsultationSystem();
        }

        // È°ØÁ§∫Áµ±Ë®àÈ†ÅÈù¢
        function showStatistics() {
            hideAllPages();
            document.getElementById('statisticsPage').classList.remove('hidden');
            
            // Êõ¥Êñ∞Áµ±Ë®àÊï∏Êìö
            document.getElementById('totalPatients').textContent = patients.length;
            document.getElementById('totalConsultations').textContent = medicalRecords.filter(r => r.status === 'completed').length;
            document.getElementById('todayConsultations').textContent = appointments.filter(apt => 
                new Date(apt.appointmentTime).toDateString() === new Date().toDateString()
            ).length;
        }

        // È°ØÁ§∫Ê®°ÊÖãË¶ñÁ™ó
        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        // ÈóúÈñâÊ®°ÊÖãË¶ñÁ™ó
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // È°ØÁ§∫ÂäüËÉΩË™™Êòé
        function showFeatureModal(message) {
            document.getElementById('featureMessage').textContent = message;
            showModal('featureModal');
        }

        // È°ØÁ§∫ÈÄöÁü•
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('floatingNotification');
            const messageEl = document.getElementById('notificationMessage');
            const iconEl = document.getElementById('notificationIcon');
            
            messageEl.textContent = message;
            
            // Ë®≠ÂÆöÂúñÁ§∫ÂíåÈ°èËâ≤
            if (type === 'success') {
                iconEl.innerHTML = '‚úÖ';
                notification.querySelector('.border-l-4').className = 'bg-white rounded-lg shadow-2xl border-l-4 border-green-500 p-4 max-w-sm transform translate-x-full transition-transform duration-300 ease-out';
            } else if (type === 'error') {
                iconEl.innerHTML = '‚ùå';
                notification.querySelector('.border-l-4').className = 'bg-white rounded-lg shadow-2xl border-l-4 border-red-500 p-4 max-w-sm transform translate-x-full transition-transform duration-300 ease-out';
            } else {
                iconEl.innerHTML = '‚ÑπÔ∏è';
                notification.querySelector('.border-l-4').className = 'bg-white rounded-lg shadow-2xl border-l-4 border-blue-500 p-4 max-w-sm transform translate-x-full transition-transform duration-300 ease-out';
            }
            
            notification.classList.remove('hidden');
            
            // ÂãïÁï´ÊïàÊûú
            setTimeout(() => {
                notification.querySelector('.transform').classList.remove('translate-x-full');
            }, 100);
            
            // Ëá™ÂãïÈö±Ëóè
            setTimeout(() => {
                hideNotification();
            }, 3000);
        }

        // Èö±ËóèÈÄöÁü•
        function hideNotification() {
            const notification = document.getElementById('floatingNotification');
            notification.querySelector('.transform').classList.add('translate-x-full');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 300);
        }

        // ÂàáÊèõ‰øÆÊîπÊ≠∑Âè≤È°ØÁ§∫
        function toggleModificationHistory() {
            const content = document.getElementById('modificationHistoryContent');
            const btn = document.getElementById('toggleHistoryBtn');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                btn.textContent = 'Êî∂Ëµ∑Ê≠∑Âè≤ ‚ñ≤';
            } else {
                content.classList.add('hidden');
                btn.textContent = 'Â±ïÈñãÊ≠∑Âè≤ ‚ñº';
            }
        }

        // Ë¶ñÁ™óÁ∑®ËºØÊñπÂäëÁöÑÊêúÂ∞ã‰∏≠Ëó•ÂäüËÉΩ
        function searchHerbsForModalEditFormula() {
            const searchTerm = document.getElementById('modalEditHerbSearchInput').value.toLowerCase().trim();
            const searchResults = document.getElementById('modalEditHerbSearchResults');
            const searchResultsList = document.getElementById('modalEditHerbSearchResultsList');
            
            if (searchTerm === '') {
                searchResults.classList.add('hidden');
                return;
            }
            
            const filteredHerbs = herbs.filter(herb => 
                herb.name.toLowerCase().includes(searchTerm)
            );
            
            if (filteredHerbs.length === 0) {
                searchResultsList.innerHTML = '<div class="px-4 py-3 text-gray-500 text-sm">Ê≤íÊúâÊâæÂà∞Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑ‰∏≠Ëó•</div>';
            } else {
                searchResultsList.innerHTML = filteredHerbs.map(herb => `
                    <div class="px-4 py-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0" 
                         onclick="selectHerbForModalEditFormula('${herb.name}')">
                        <div class="font-medium text-gray-900">${herb.name}</div>
                    </div>
                `).join('');
            }
            
            searchResults.classList.remove('hidden');
        }

        // È°ØÁ§∫Ë¶ñÁ™óÁ∑®ËºØÊñπÂäëÁöÑ‰∏≠Ëó•ÊêúÂ∞ãÁµêÊûú
        function showModalEditHerbSearchResults() {
            const searchTerm = document.getElementById('modalEditHerbSearchInput').value.trim();
            if (searchTerm !== '') {
                searchHerbsForModalEditFormula();
            }
        }

        // ÈÅ∏Êìá‰∏≠Ëó•ÔºàË¶ñÁ™óÁ∑®ËºØÊñπÂäëÁî®Ôºâ
        function selectHerbForModalEditFormula(herbName) {
            document.getElementById('modalEditHerbSearchInput').value = herbName;
            document.getElementById('modalEditHerbSearchResults').classList.add('hidden');
            document.getElementById('modalEditHerbDosageInput').focus();
        }

        // Ê∑ªÂä†‰∏≠Ëó•Âà∞Ë¶ñÁ™óÁ∑®ËºØÊñπÂäëÁµÑÊàê
        function addHerbToModalEditFormula() {
            const herbName = document.getElementById('modalEditHerbSearchInput').value.trim();
            const dosage = parseFloat(document.getElementById('modalEditHerbDosageInput').value);
            
            if (!herbName) {
                showNotification('Ë´ãÈÅ∏Êìá‰∏≠Ëó•', 'error');
                return;
            }
            
            if (!dosage || dosage <= 0) {
                showNotification('Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÂäëÈáè', 'error');
                return;
            }
            
            // Ê™¢Êü•‰∏≠Ëó•ÊòØÂê¶Â≠òÂú®
            const herbExists = herbs.some(herb => herb.name === herbName);
            if (!herbExists) {
                showNotification('Ë´ãÂæûÊêúÂ∞ãÁµêÊûú‰∏≠ÈÅ∏Êìá‰∏≠Ëó•', 'error');
                return;
            }
            
            // Ê™¢Êü•ÊòØÂê¶Â∑≤Á∂ìÊ∑ªÂä†ÈÅé
            const existingIndex = selectedHerbsForModalEditFormula.findIndex(item => item.name === herbName);
            if (existingIndex >= 0) {
                // Êõ¥Êñ∞ÂäëÈáè
                selectedHerbsForModalEditFormula[existingIndex].dosage = dosage;
                showNotification(`Â∑≤Êõ¥Êñ∞ ${herbName} ÁöÑÂäëÈáèÁÇ∫ ${dosage}g`, 'info');
            } else {
                // Ê∑ªÂä†Êñ∞‰∏≠Ëó•
                selectedHerbsForModalEditFormula.push({
                    name: herbName,
                    dosage: dosage
                });
                showNotification(`Â∑≤Ê∑ªÂä† ${herbName} ${dosage}g`);
            }
            
            // Ê∏ÖÁ©∫Ëº∏ÂÖ•Ê°Ü
            document.getElementById('modalEditHerbSearchInput').value = '';
            document.getElementById('modalEditHerbDosageInput').value = '';
            document.getElementById('modalEditHerbSearchResults').classList.add('hidden');
            
            // Êõ¥Êñ∞È°ØÁ§∫
            updateModalEditSelectedHerbsDisplay();
            updateModalEditFormulaCompositionText();
        }

        // Êõ¥Êñ∞Ë¶ñÁ™óÁ∑®ËºØÊñπÂäëÁöÑÂ∑≤ÈÅ∏‰∏≠Ëó•È°ØÁ§∫
        function updateModalEditSelectedHerbsDisplay() {
            const container = document.getElementById('modalEditSelectedHerbsDisplay');
            
            if (selectedHerbsForModalEditFormula.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Â∞öÊú™Ê∑ªÂä†‰ªª‰Ωï‰∏≠Ëó•</p>';
                return;
            }
            
            container.innerHTML = selectedHerbsForModalEditFormula.map((herb, index) => `
                <div class="flex items-center justify-between bg-white rounded-lg p-3 border border-gray-200">
                    <div class="flex items-center space-x-3">
                        <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-bold">
                            ${index + 1}
                        </span>
                        <span class="font-medium text-gray-800">${herb.name}</span>
                        <span class="text-blue-600 font-mono">${herb.dosage}g</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="editHerbInModalEditFormula(${index})" class="text-blue-600 hover:text-blue-800 text-sm">
                            Á∑®ËºØ
                        </button>
                        <button onclick="removeHerbFromModalEditFormula(${index})" class="text-red-600 hover:text-red-800 text-sm">
                            ÁßªÈô§
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Êõ¥Êñ∞Ë¶ñÁ™óÁ∑®ËºØÊñπÂäëÁöÑÁµÑÊàêÊñáÂ≠ó
        function updateModalEditFormulaCompositionText() {
            const compositionText = selectedHerbsForModalEditFormula
                .map(herb => `${herb.name} ${herb.dosage}g`)
                .join('Ôºå');
            
            document.getElementById('modalEditFormulaComposition').value = compositionText;
        }

        // Á∑®ËºØË¶ñÁ™óÁ∑®ËºØÊñπÂäë‰∏≠ÁöÑ‰∏≠Ëó•
        function editHerbInModalEditFormula(index) {
            const herb = selectedHerbsForModalEditFormula[index];
            const newDosage = prompt(`Ë´ãËº∏ÂÖ• ${herb.name} ÁöÑÊñ∞ÂäëÈáè (g):`, herb.dosage);
            
            if (newDosage !== null) {
                const dosage = parseFloat(newDosage);
                if (dosage && dosage > 0) {
                    selectedHerbsForModalEditFormula[index].dosage = dosage;
                    updateModalEditSelectedHerbsDisplay();
                    updateModalEditFormulaCompositionText();
                    showNotification(`Â∑≤Êõ¥Êñ∞ ${herb.name} ÁöÑÂäëÈáèÁÇ∫ ${dosage}g`, 'info');
                } else {
                    showNotification('Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÂäëÈáè', 'error');
                }
            }
        }

        // ÂæûË¶ñÁ™óÁ∑®ËºØÊñπÂäë‰∏≠ÁßªÈô§‰∏≠Ëó•
        function removeHerbFromModalEditFormula(index) {
            const herb = selectedHerbsForModalEditFormula[index];
            if (confirm(`Á¢∫ÂÆöË¶ÅÁßªÈô§ ${herb.name} ÂóéÔºü`)) {
                selectedHerbsForModalEditFormula.splice(index, 1);
                updateModalEditSelectedHerbsDisplay();
                updateModalEditFormulaCompositionText();
                showNotification(`Â∑≤ÁßªÈô§ ${herb.name}`, 'info');
            }
        }

        // ÈªûÊìäÂ§ñÈÉ®ÈóúÈñâÊêúÂ∞ãÁµêÊûú
        document.addEventListener('click', function(event) {
            const herbSearchResults = document.getElementById('herbSearchResults');
            const herbSearchInput = document.getElementById('herbSearchInput');
            
            if (herbSearchResults && herbSearchInput && 
                !herbSearchResults.contains(event.target) && 
                !herbSearchInput.contains(event.target)) {
                herbSearchResults.classList.add('hidden');
            }
        });


    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'967cf425e2780443',t:'MTc1Mzk2MzQxOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
