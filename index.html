<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­é†«è¨ºæ‰€ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">
    <!-- ç™»å…¥é é¢ -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-white text-2xl">ğŸ¥</span>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">ä¸­é†«è¨ºæ‰€ç®¡ç†ç³»çµ±</h1>
                <p class="text-gray-600 mt-2">è«‹é¸æ“‡æ‚¨çš„èº«ä»½ç™»å…¥</p>
            </div>
            
            <div class="space-y-4">
                <button onclick="login('admin')" class="w-full bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded-lg font-medium transition-colors">
                    ğŸ‘¨â€ğŸ’¼ ç®¡ç†å“¡ç™»å…¥
                </button>
                <button onclick="login('doctor')" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-medium transition-colors">
                    ğŸ‘¨â€âš•ï¸ é†«å¸«ç™»å…¥
                </button>
                <button onclick="login('assistant')" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg font-medium transition-colors">
                    ğŸ‘©â€ğŸ’» è¨ºæ‰€åŠ©ç†ç™»å…¥
                </button>
            </div>
        </div>
    </div>

    <!-- ä¸»ç³»çµ±é é¢ -->
    <div id="mainSystem" class="hidden min-h-screen">
        <!-- å´é‚Šé¸å–® -->
        <div id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-2xl transform -translate-x-full transition-transform duration-300 ease-in-out">
            <div class="flex flex-col h-full">
                <!-- é¸å–®æ¨™é¡Œ -->
                <div class="bg-green-600 text-white p-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <span class="text-lg">ğŸ¥</span>
                            </div>
                            <div>
                                <h2 class="font-bold text-lg">è¨ºæ‰€ç³»çµ±</h2>
                                <p class="text-green-100 text-sm" id="sidebarUserRole"></p>
                            </div>
                        </div>
                        <button onclick="closeSidebar()" class="text-white hover:text-green-200 text-2xl">Ã—</button>
                    </div>
                </div>
                
                <!-- é¸å–®é …ç›® -->
                <div class="flex-1 py-4" id="sidebarMenu">
                    <!-- é¸å–®é …ç›®æœƒå‹•æ…‹è¼‰å…¥ -->
                </div>
                
                <!-- åº•éƒ¨ç™»å‡º -->
                <div class="p-4 border-t border-gray-200">
                    <button onclick="logout()" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg font-medium transition-colors">
                        ğŸšª ç™»å‡ºç³»çµ±
                    </button>
                </div>
            </div>
        </div>

        <!-- é¸å–®é®ç½© -->
        <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden" onclick="closeSidebar()"></div>

        <!-- é ‚éƒ¨å°èˆª -->
        <nav class="bg-white shadow-lg border-b-4 border-green-500">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-4">
                        <button onclick="openSidebar()" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                            </svg>
                        </button>
                        <div class="w-10 h-10 bg-green-600 rounded-full flex items-center justify-center">
                            <span class="text-white text-lg">ğŸ¥</span>
                        </div>
                        <h1 class="text-xl font-bold text-gray-800">ä¸­é†«è¨ºæ‰€ç®¡ç†ç³»çµ±</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="userRole" class="text-sm text-gray-600 bg-gray-100 px-3 py-1 rounded-full"></span>
                        <button onclick="logout()" class="text-red-600 hover:text-red-800 font-medium">ç™»å‡º</button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div id="welcomeMessage" class="bg-white rounded-xl shadow-lg p-8 text-center">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-4xl">ğŸ¥</span>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">æ­¡è¿ä½¿ç”¨ä¸­é†«è¨ºæ‰€ç®¡ç†ç³»çµ±</h2>
                <p class="text-gray-600">è«‹ä½¿ç”¨å·¦å´é¸å–®é–‹å§‹ä½¿ç”¨ç³»çµ±åŠŸèƒ½</p>
            </div>
        </div>

        <!-- ç—…äººè³‡æ–™ç®¡ç† -->
        <div id="patientManagement" class="hidden max-w-7xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">ç—…äººè³‡æ–™ç®¡ç†</h2>
                    <button onclick="showAddPatientForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">
                        â• æ–°å¢ç—…äºº
                    </button>
                </div>
                
                <!-- æœç´¢åŠŸèƒ½ -->
                <div class="mb-6">
                    <div class="relative">
                        <input type="text" id="patientSearchInput" placeholder="æœç´¢ç—…äººå§“åã€é›»è©±..." 
                               onkeyup="searchPatients()" 
                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <!-- ç—…äººåˆ—è¡¨ -->
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">ç—…äººç·¨è™Ÿ</th>
                                <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">å§“å</th>
                                <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">æ€§åˆ¥</th>
                                <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">å¹´é½¡</th>
                                <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">é›»è©±</th>
                                <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="patientList">
                            <!-- ç—…äººè³‡æ–™æœƒå‹•æ…‹è¼‰å…¥ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- æ–°å¢ç—…äººè¡¨å–® -->
        <div id="addPatientForm" class="hidden max-w-2xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">æ–°å¢ç—…äººè³‡æ–™</h2>
                <form onsubmit="addPatient(event)" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å§“å *</label>
                            <input type="text" id="patientName" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">èº«ä»½è­‰å­—è™Ÿ *</label>
                            <input type="text" id="patientIdNumber" required pattern="[A-Z][0-9]{9}" maxlength="10" placeholder="å¦‚ï¼šA123456789" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ€§åˆ¥ *</label>
                            <select id="patientGender" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="ç”·">ç”·</option>
                                <option value="å¥³">å¥³</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å‡ºç”Ÿæ—¥æœŸ *</label>
                            <input type="date" id="patientBirthDate" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">é›»è©± *</label>
                            <input type="tel" id="patientPhone" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">åœ°å€</label>
                            <input type="text" id="patientAddress" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                    </div>
                    <div class="flex space-x-4 pt-4">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium">
                            ğŸ’¾ å„²å­˜
                        </button>
                        <button type="button" onclick="showPatientManagement()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium">
                            âŒ å–æ¶ˆ
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ç·¨è¼¯ç—…äººè¡¨å–® -->
        <div id="editPatientForm" class="hidden max-w-2xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">ç·¨è¼¯ç—…äººè³‡æ–™</h2>
                <form onsubmit="updatePatient(event)" class="space-y-4">
                    <input type="hidden" id="editPatientId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å§“å *</label>
                            <input type="text" id="editPatientName" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">èº«ä»½è­‰å­—è™Ÿ *</label>
                            <input type="text" id="editPatientIdNumber" required pattern="[A-Z][0-9]{9}" maxlength="10" placeholder="å¦‚ï¼šA123456789" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ€§åˆ¥ *</label>
                            <select id="editPatientGender" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="ç”·">ç”·</option>
                                <option value="å¥³">å¥³</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å‡ºç”Ÿæ—¥æœŸ *</label>
                            <input type="date" id="editPatientBirthDate" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">é›»è©± *</label>
                            <input type="tel" id="editPatientPhone" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">åœ°å€</label>
                            <input type="text" id="editPatientAddress" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                    <div class="flex space-x-4 pt-4">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium">
                            ğŸ’¾ æ›´æ–°è³‡æ–™
                        </button>
                        <button type="button" onclick="showPatientManagement()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium">
                            âŒ å–æ¶ˆ
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- è¨ºç—‡ç³»çµ± -->
        <div id="consultationSystem" class="hidden max-w-7xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">è¨ºç—‡ç³»çµ±</h2>
                    <button onclick="showAppointmentForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">
                        ğŸ“‹ ç—…äººæ›è™Ÿ
                    </button>
                </div>
                
                <!-- ä»Šæ—¥æ›è™Ÿç—…äººåˆ—è¡¨ -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">ä»Šæ—¥æ›è™Ÿç—…äºº</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">æ›è™Ÿæ™‚é–“</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">ç—…äººç·¨è™Ÿ</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">ç—…äººå§“å</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">å¹´é½¡</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">ç‹€æ…‹</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="appointmentList">
                                <!-- æ›è™Ÿåˆ—è¡¨æœƒå‹•æ…‹è¼‰å…¥ -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ç—…äººè©³ç´°è³‡æ–™è¡¨å–® -->
                <div id="consultationForm" class="hidden mt-8 border-t pt-6">
                    <div class="bg-blue-50 rounded-lg p-6 mb-6">
                        <h3 class="text-lg font-semibold text-blue-800 mb-4">ğŸ‘¤ ç—…äººè©³ç´°è³‡æ–™</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                            <div class="bg-white rounded-lg p-3">
                                <span class="text-gray-600 font-medium">ç—…äººç·¨è™Ÿï¼š</span>
                                <span class="text-blue-600 font-mono font-bold" id="currentPatientNumber"></span>
                            </div>
                            <div class="bg-white rounded-lg p-3">
                                <span class="text-gray-600 font-medium">å§“åï¼š</span>
                                <span class="text-gray-800 font-medium" id="currentPatientName"></span>
                            </div>
                            <div class="bg-white rounded-lg p-3">
                                <span class="text-gray-600 font-medium">æ€§åˆ¥ï¼š</span>
                                <span class="text-gray-800" id="currentPatientGender"></span>
                            </div>
                            <div class="bg-white rounded-lg p-3">
                                <span class="text-gray-600 font-medium">å¹´é½¡ï¼š</span>
                                <span class="text-gray-800" id="currentPatientAge"></span>
                            </div>
                            <div class="bg-white rounded-lg p-3">
                                <span class="text-gray-600 font-medium">å‡ºç”Ÿæ—¥æœŸï¼š</span>
                                <span class="text-gray-800" id="currentPatientBirthDate"></span>
                            </div>
                            <div class="bg-white rounded-lg p-3">
                                <span class="text-gray-600 font-medium">é›»è©±ï¼š</span>
                                <span class="text-gray-800" id="currentPatientPhone"></span>
                            </div>
                            <div class="bg-white rounded-lg p-3 md:col-span-2 lg:col-span-3">
                                <span class="text-gray-600 font-medium">åœ°å€ï¼š</span>
                                <span class="text-gray-800" id="currentPatientAddress"></span>
                            </div>
                            <div class="bg-white rounded-lg p-3">
                                <span class="text-gray-600 font-medium">èº«ä»½è­‰ï¼š</span>
                                <span class="text-gray-800 font-mono" id="currentPatientIdNumber"></span>
                            </div>
                        </div>
                    </div>
                    
                    <form onsubmit="saveConsultation(event)" class="space-y-6">
                        <input type="hidden" id="currentAppointmentId">
                        <input type="hidden" id="currentPatientId">
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ä¸»è¨´ *</label>
                                <textarea id="chiefComplaint" rows="3" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ç—…äººä¸»è¦ç—‡ç‹€æè¿°"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ç¾ç—…å²</label>
                                <textarea id="presentIllness" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ç—‡ç‹€ç™¼å±•éç¨‹"></textarea>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">è„ˆè±¡</label>
                                <input type="text" id="pulse" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="å¦‚ï¼šæ»‘è„ˆã€å¼¦è„ˆ">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">èˆŒè±¡</label>
                                <input type="text" id="tongue" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="å¦‚ï¼šèˆŒç´…è‹”é»ƒ">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ä¸­é†«è¨ºæ–· *</label>
                            <textarea id="diagnosis" rows="2" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ä¸­é†«ç—…ååŠè­‰å‹"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">è™•æ–¹</label>
                            <textarea id="prescription" rows="4" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="è—¥ç‰©åç¨±ã€åŠ‘é‡ã€æœç”¨æ–¹æ³•"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">é†«å›‘</label>
                            <textarea id="instructions" rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ç”Ÿæ´»æ³¨æ„äº‹é …ã€å¾©è¨ºæ™‚é–“ç­‰"></textarea>
                        </div>

                        <div class="flex space-x-4 pt-4">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium">
                                ğŸ’¾ å®Œæˆè¨ºç—‡ä¸¦å„²å­˜è¨˜éŒ„
                            </button>
                            <button type="button" onclick="cancelConsultation()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium">
                                âŒ å–æ¶ˆè¨ºç—‡
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- æ›è™Ÿè¡¨å–® -->
        <div id="appointmentForm" class="hidden max-w-2xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">ç—…äººæ›è™Ÿ</h2>
                
                <!-- æœç´¢ç—…äºº -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">æœç´¢ä¸¦é¸æ“‡ç—…äºº</label>
                    <div class="relative">
                        <input type="text" id="appointmentSearchInput" placeholder="æœç´¢ç—…äººå§“åã€é›»è©±..." 
                               oninput="searchAppointmentPatients()" 
                               onfocus="showSearchResults()"
                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        
                        <!-- æœç´¢çµæœä¸‹æ‹‰é¸å–® -->
                        <div id="searchResults" class="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-60 overflow-y-auto z-10 hidden">
                            <div id="searchResultsList" class="py-1">
                                <!-- æœç´¢çµæœæœƒå‹•æ…‹è¼‰å…¥ -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- é¸ä¸­çš„ç—…äººé¡¯ç¤º -->
                    <div id="selectedPatientInfo" class="hidden mt-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex justify-between items-center">
                            <div>
                                <span class="text-sm text-green-700">å·²é¸æ“‡ç—…äººï¼š</span>
                                <span id="selectedPatientDisplay" class="font-medium text-green-800"></span>
                            </div>
                            <button type="button" onclick="clearSelectedPatient()" class="text-green-600 hover:text-green-800 text-sm">
                                é‡æ–°é¸æ“‡
                            </button>
                        </div>
                    </div>
                </div>
                
                <form onsubmit="addAppointment(event)" class="space-y-4">
                    <input type="hidden" id="selectedPatientId" required>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ›è™Ÿæ™‚é–“ *</label>
                        <input type="datetime-local" id="appointmentTime" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç—‡ç‹€æè¿°</label>
                        <textarea id="appointmentSymptoms" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="ç°¡è¿°ç—…äººä¸»è¦ç—‡ç‹€"></textarea>
                    </div>
                    
                    <div class="flex space-x-4 pt-4">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium">
                            ğŸ“‹ ç¢ºèªæ›è™Ÿ
                        </button>
                        <button type="button" onclick="showConsultationSystem()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium">
                            âŒ å–æ¶ˆ
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ç³»çµ±ç®¡ç† -->
        <div id="systemManagement" class="hidden max-w-7xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">ç³»çµ±ç®¡ç†</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg p-6 text-white">
                        <h3 class="text-lg font-semibold mb-2">ğŸ‘¥ ç”¨æˆ¶ç®¡ç†</h3>
                        <p class="text-blue-100 mb-4">ç®¡ç†ç³»çµ±ç”¨æˆ¶æ¬Šé™</p>
                        <button onclick="showFeatureModal('ç”¨æˆ¶ç®¡ç†åŠŸèƒ½ï¼šæ­¤åŠŸèƒ½å¯ä»¥æ–°å¢ã€ç·¨è¼¯ã€åˆªé™¤ç³»çµ±ç”¨æˆ¶ï¼Œä¸¦è¨­å®šä¸åŒçš„æ¬Šé™ç­‰ç´šã€‚')" class="bg-white text-blue-600 px-4 py-2 rounded font-medium hover:bg-blue-50">
                            ç®¡ç†ç”¨æˆ¶
                        </button>
                    </div>
                    
                    <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg p-6 text-white">
                        <h3 class="text-lg font-semibold mb-2">ğŸ“Š æ•¸æ“šçµ±è¨ˆ</h3>
                        <p class="text-green-100 mb-4">æŸ¥çœ‹è¨ºæ‰€ç‡Ÿé‹æ•¸æ“š</p>
                        <button onclick="showStatistics()" class="bg-white text-green-600 px-4 py-2 rounded font-medium hover:bg-green-50">
                            æŸ¥çœ‹çµ±è¨ˆ
                        </button>
                    </div>
                    
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg p-6 text-white">
                        <h3 class="text-lg font-semibold mb-2">âš™ï¸ ç³»çµ±è¨­å®š</h3>
                        <p class="text-purple-100 mb-4">èª¿æ•´ç³»çµ±åƒæ•¸</p>
                        <button onclick="showFeatureModal('ç³»çµ±è¨­å®šåŠŸèƒ½ï¼šæ­¤åŠŸèƒ½å¯ä»¥èª¿æ•´ç³»çµ±åƒæ•¸ã€å‚™ä»½è³‡æ–™ã€è¨­å®šè¨ºæ‰€åŸºæœ¬è³‡è¨Šç­‰ã€‚')" class="bg-white text-purple-600 px-4 py-2 rounded font-medium hover:bg-purple-50">
                            ç³»çµ±è¨­å®š
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- çµ±è¨ˆé é¢ -->
        <div id="statisticsPage" class="hidden max-w-7xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">è¨ºæ‰€çµ±è¨ˆæ•¸æ“š</h2>
                    <button onclick="showSystemManagement()" class="text-gray-600 hover:text-gray-800">â† è¿”å›</button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-blue-50 rounded-lg p-6 text-center">
                        <div class="text-3xl font-bold text-blue-600" id="totalPatients">0</div>
                        <div class="text-gray-600 mt-2">ç¸½ç—…äººæ•¸</div>
                    </div>
                    <div class="bg-green-50 rounded-lg p-6 text-center">
                        <div class="text-3xl font-bold text-green-600" id="totalConsultations">0</div>
                        <div class="text-gray-600 mt-2">ç¸½è¨ºç—‡æ¬¡æ•¸</div>
                    </div>
                    <div class="bg-yellow-50 rounded-lg p-6 text-center">
                        <div class="text-3xl font-bold text-yellow-600" id="todayConsultations">0</div>
                        <div class="text-gray-600 mt-2">ä»Šæ—¥è¨ºç—‡</div>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-6 text-center">
                        <div class="text-3xl font-bold text-purple-600" id="activeUsers">3</div>
                        <div class="text-gray-600 mt-2">ç³»çµ±ç”¨æˆ¶</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æµ®å‹•è¦–çª— -->
    <!-- ç—…äººè©³æƒ…è¦–çª— -->
    <div id="patientDetailModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto fade-in">
            <div class="bg-blue-600 text-white p-6 rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">ğŸ‘¤ ç—…äººè©³æƒ…</h3>
                    <button onclick="closeModal('patientDetailModal')" class="text-white hover:text-blue-200 text-2xl">Ã—</button>
                </div>
            </div>
            <div class="p-6">
                <div id="patientDetailContent" class="space-y-4">
                    <!-- ç—…äººè©³æƒ…å…§å®¹æœƒå‹•æ…‹è¼‰å…¥ -->
                </div>
                <div class="flex justify-end mt-6">
                    <button onclick="closeModal('patientDetailModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium">
                        é—œé–‰
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æµ®å‹•é€šçŸ¥ -->
    <div id="floatingNotification" class="fixed top-4 right-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-2xl border-l-4 p-4 max-w-sm transform translate-x-full transition-transform duration-300 ease-out">
            <div class="flex items-start">
                <div id="notificationIcon" class="flex-shrink-0 w-6 h-6 mr-3 mt-0.5"></div>
                <div class="flex-1">
                    <p id="notificationMessage" class="text-sm text-gray-800 font-medium"></p>
                </div>
                <button onclick="hideNotification()" class="flex-shrink-0 ml-2 text-gray-400 hover:text-gray-600">
                    <span class="text-lg">Ã—</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ç¢ºèªåˆªé™¤è¦–çª— -->
    <div id="confirmDeleteModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full fade-in">
            <div class="bg-red-600 text-white p-6 rounded-t-2xl text-center">
                <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-3xl">âš ï¸</span>
                </div>
                <h3 class="text-xl font-bold">ç¢ºèªåˆªé™¤</h3>
            </div>
            <div class="p-6 text-center">
                <p class="text-gray-700 mb-6">ç¢ºå®šè¦åˆªé™¤æ­¤ç—…äººè³‡æ–™å—ï¼Ÿ<br>æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p>
                <div class="flex space-x-4">
                    <button onclick="closeModal('confirmDeleteModal')" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg font-medium">
                        å–æ¶ˆ
                    </button>
                    <button id="confirmDeleteBtn" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg font-medium">
                        ç¢ºå®šåˆªé™¤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠŸèƒ½èªªæ˜è¦–çª— -->
    <div id="featureModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full fade-in">
            <div class="bg-purple-600 text-white p-6 rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">ğŸ”§ åŠŸèƒ½èªªæ˜</h3>
                    <button onclick="closeModal('featureModal')" class="text-white hover:text-purple-200 text-2xl">Ã—</button>
                </div>
            </div>
            <div class="p-6">
                <div class="text-center mb-4">
                    <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-3xl">âš™ï¸</span>
                    </div>
                </div>
                <p id="featureMessage" class="text-gray-700 text-center mb-6"></p>
                <div class="flex justify-center">
                    <button onclick="closeModal('featureModal')" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-medium">
                        äº†è§£
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç—…æ­·è¨˜éŒ„è¦–çª— -->
    <div id="patientHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden fade-in">
            <div class="bg-indigo-600 text-white p-6 rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="text-xl font-bold">ğŸ“‹ ç—…æ­·è¨˜éŒ„</h3>
                        <p id="historyPatientInfo" class="text-indigo-100 text-sm mt-1"></p>
                    </div>
                    <button onclick="closeModal('patientHistoryModal')" class="text-white hover:text-indigo-200 text-2xl">Ã—</button>
                </div>
            </div>
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                <div id="patientHistoryContent">
                    <!-- ç—…æ­·å…§å®¹æœƒå‹•æ…‹è¼‰å…¥ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ç³»çµ±æ•¸æ“š
        let currentUser = null;
        let patients = [
            { id: 1, patientNumber: 'P001', name: 'ç‹å°æ˜', gender: 'ç”·', birthDate: '1988-05-15', phone: '0912-345-678', address: 'å°åŒ—å¸‚ä¿¡ç¾©å€', idNumber: 'A123456789' },
            { id: 2, patientNumber: 'P002', name: 'æå°è¯', gender: 'å¥³', birthDate: '1995-08-22', phone: '0923-456-789', address: 'å°åŒ—å¸‚å¤§å®‰å€', idNumber: 'B234567890' },
            { id: 3, patientNumber: 'P003', name: 'å¼µå¤§åŒ', gender: 'ç”·', birthDate: '1978-12-03', phone: '0934-567-890', address: 'æ–°åŒ—å¸‚æ¿æ©‹å€', idNumber: 'C345678901' }
        ];
        let appointments = []; // æ›è™Ÿè¨˜éŒ„
        let patientStatus = {}; // ç—…äººè¨ºç—‡ç‹€æ…‹
        let consultations = [];
        let nextPatientId = 4;

        // è¨ˆç®—å¹´é½¡å‡½æ•¸
        function calculateAge(birthDate) {
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            
            return age;
        }

        // ç”¨æˆ¶æ¬Šé™è¨­å®š
        const userPermissions = {
            admin: ['patientManagement', 'consultationSystem', 'systemManagement'],
            doctor: ['patientManagement', 'consultationSystem'],
            assistant: ['patientManagement', 'consultationSystem']
        };

        const userNames = {
            admin: 'ğŸ‘¨â€ğŸ’¼ ç®¡ç†å“¡',
            doctor: 'ğŸ‘¨â€âš•ï¸ é†«å¸«',
            assistant: 'ğŸ‘©â€ğŸ’»  è¨ºæ‰€åŠ©ç†'
        };

        // ç™»å…¥åŠŸèƒ½
        function login(userType) {
            currentUser = userType;
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainSystem').classList.remove('hidden');
            document.getElementById('userRole').textContent = userNames[userType];
            document.getElementById('sidebarUserRole').textContent = userNames[userType];
            loadSidebarMenu();
            showWelcome(); // é è¨­é¡¯ç¤ºæ­¡è¿é é¢
        }

        // ç™»å‡ºåŠŸèƒ½
        function logout() {
            currentUser = null;
            document.getElementById('mainSystem').classList.add('hidden');
            document.getElementById('loginPage').classList.remove('hidden');
            closeSidebar();
            hideAllPages();
        }

        // é–‹å•Ÿå´é‚Šé¸å–®
        function openSidebar() {
            document.getElementById('sidebar').classList.remove('-translate-x-full');
            document.getElementById('sidebarOverlay').classList.remove('hidden');
        }

        // é—œé–‰å´é‚Šé¸å–®
        function closeSidebar() {
            document.getElementById('sidebar').classList.add('-translate-x-full');
            document.getElementById('sidebarOverlay').classList.add('hidden');
        }

        // è¼‰å…¥å´é‚Šé¸å–®
        function loadSidebarMenu() {
            const menuContainer = document.getElementById('sidebarMenu');
            const permissions = userPermissions[currentUser];
            
            const menuItems = {
                patientManagement: {
                    title: 'ğŸ‘¥ ç—…äººè³‡æ–™ç®¡ç†',
                    desc: 'æ–°å¢ã€æŸ¥çœ‹ã€ç·¨è¼¯ç—…äººè³‡æ–™',
                    action: 'showPatientManagement()'
                },
                consultationSystem: {
                    title: 'ğŸ©º è¨ºç—‡ç³»çµ±',
                    desc: 'é€²è¡Œè¨ºç—‡ã€é–‹ç«‹è™•æ–¹',
                    action: 'showConsultationSystem()'
                },
                systemManagement: {
                    title: 'âš™ï¸ ç³»çµ±ç®¡ç†',
                    desc: 'ç”¨æˆ¶ç®¡ç†ã€æ•¸æ“šçµ±è¨ˆ',
                    action: 'showSystemManagement()'
                }
            };

            menuContainer.innerHTML = permissions.map(permission => {
                const item = menuItems[permission];
                return `
                    <div class="px-4 mb-2">
                        <button onclick="${item.action}; closeSidebar();" class="w-full text-left p-4 rounded-lg hover:bg-gray-100 transition-colors group">
                            <div class="font-medium text-gray-800 group-hover:text-green-600">${item.title}</div>
                            <div class="text-sm text-gray-500 mt-1">${item.desc}</div>
                        </button>
                    </div>
                `;
            }).join('');
        }

        // é¡¯ç¤ºæ­¡è¿é é¢
        function showWelcome() {
            hideAllPages();
            document.getElementById('welcomeMessage').classList.remove('hidden');
        }

        // éš±è—æ‰€æœ‰é é¢
        function hideAllPages() {
            const pages = ['welcomeMessage', 'patientManagement', 'addPatientForm', 'editPatientForm', 'consultationSystem', 'appointmentForm', 'systemManagement', 'statisticsPage'];
            pages.forEach(page => {
                document.getElementById(page).classList.add('hidden');
            });
        }

        // é¡¯ç¤ºç—…äººç®¡ç†
        function showPatientManagement() {
            hideAllPages();
            document.getElementById('patientManagement').classList.remove('hidden');
            document.getElementById('patientSearchInput').value = '';
            loadPatientList();
        }

        // è¼‰å…¥ç—…äººåˆ—è¡¨
        function loadPatientList(filteredPatients = null) {
            const tbody = document.getElementById('patientList');
            const patientsToShow = filteredPatients || patients;
            
            if (patientsToShow.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="border border-gray-200 px-4 py-8 text-center text-gray-500">
                            ${filteredPatients ? 'æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„ç—…äºº' : 'æš«ç„¡ç—…äººè³‡æ–™'}
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = patientsToShow.map(patient => `
                <tr class="hover:bg-gray-50">
                    <td class="border border-gray-200 px-4 py-3 font-mono text-blue-600">${patient.patientNumber}</td>
                    <td class="border border-gray-200 px-4 py-3">${patient.name}</td>
                    <td class="border border-gray-200 px-4 py-3">${patient.gender}</td>
                    <td class="border border-gray-200 px-4 py-3">${calculateAge(patient.birthDate)}</td>
                    <td class="border border-gray-200 px-4 py-3">${patient.phone}</td>
                    <td class="border border-gray-200 px-4 py-3">
                        <button onclick="viewPatient(${patient.id})" class="text-blue-600 hover:text-blue-800 mr-2">æŸ¥çœ‹</button>
                        <button onclick="viewPatientHistory(${patient.id})" class="text-indigo-600 hover:text-indigo-800 mr-2">ç—…æ­·</button>
                        ${currentUser === 'admin' || currentUser === 'assistant' ? `<button onclick="editPatient(${patient.id})" class="text-green-600 hover:text-green-800 mr-2">ç·¨è¼¯</button>` : ''}
                        ${currentUser === 'admin' ? `<button onclick="deletePatient(${patient.id})" class="text-red-600 hover:text-red-800">åˆªé™¤</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }

        // æœç´¢ç—…äººåŠŸèƒ½
        function searchPatients() {
            const searchTerm = document.getElementById('patientSearchInput').value.toLowerCase().trim();
            
            if (searchTerm === '') {
                loadPatientList();
                return;
            }
            
            const filteredPatients = patients.filter(patient => 
                patient.name.toLowerCase().includes(searchTerm) ||
                patient.phone.includes(searchTerm) ||
                patient.gender.includes(searchTerm) ||
                patient.patientNumber.toLowerCase().includes(searchTerm) ||
                calculateAge(patient.birthDate).toString().includes(searchTerm)
            );
            
            loadPatientList(filteredPatients);
        }

        // é¡¯ç¤ºæ–°å¢ç—…äººè¡¨å–®
        function showAddPatientForm() {
            hideAllPages();
            document.getElementById('addPatientForm').classList.remove('hidden');
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('patientName').value = '';
            document.getElementById('patientIdNumber').value = '';
            document.getElementById('patientGender').value = '';
            document.getElementById('patientBirthDate').value = '';
            document.getElementById('patientPhone').value = '';
            document.getElementById('patientAddress').value = '';
        }

        // æ–°å¢ç—…äºº
        function addPatient(event) {
            event.preventDefault();
            
            const newPatient = {
                id: nextPatientId++,
                patientNumber: 'P' + (nextPatientId - 1).toString().padStart(3, '0'),
                name: document.getElementById('patientName').value,
                idNumber: document.getElementById('patientIdNumber').value.toUpperCase(),
                gender: document.getElementById('patientGender').value,
                birthDate: document.getElementById('patientBirthDate').value,
                phone: document.getElementById('patientPhone').value,
                address: document.getElementById('patientAddress').value
            };
            
            patients.push(newPatient);
            showNotification('ç—…äººè³‡æ–™æ–°å¢æˆåŠŸï¼ç—…äººç·¨è™Ÿï¼š' + newPatient.patientNumber);
            showPatientManagement();
        }

        // æŸ¥çœ‹ç—…äººè©³æƒ…
        function viewPatient(id) {
            const patient = patients.find(p => p.id === id);
            if (patient) {
                const content = `
                    <div class="space-y-3">
                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                            <span class="font-medium text-gray-600">ç—…äººç·¨è™Ÿï¼š</span>
                            <span class="text-blue-600 font-mono font-bold">${patient.patientNumber}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                            <span class="font-medium text-gray-600">å§“åï¼š</span>
                            <span class="text-gray-800">${patient.name}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                            <span class="font-medium text-gray-600">èº«ä»½è­‰ï¼š</span>
                            <span class="text-gray-800">${patient.idNumber}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                            <span class="font-medium text-gray-600">æ€§åˆ¥ï¼š</span>
                            <span class="text-gray-800">${patient.gender}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                            <span class="font-medium text-gray-600">å‡ºç”Ÿæ—¥æœŸï¼š</span>
                            <span class="text-gray-800">${patient.birthDate}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                            <span class="font-medium text-gray-600">å¹´é½¡ï¼š</span>
                            <span class="text-gray-800">${calculateAge(patient.birthDate)} æ­²</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                            <span class="font-medium text-gray-600">é›»è©±ï¼š</span>
                            <span class="text-gray-800">${patient.phone}</span>
                        </div>
                        <div class="py-2">
                            <span class="font-medium text-gray-600">åœ°å€ï¼š</span>
                            <div class="text-gray-800 mt-1">${patient.address || 'æœªå¡«å¯«'}</div>
                        </div>
                    </div>
                `;
                document.getElementById('patientDetailContent').innerHTML = content;
                showModal('patientDetailModal');
            }
        }

        // ç·¨è¼¯ç—…äººï¼ˆåƒ…ç®¡ç†å“¡ï¼‰
        function editPatient(id) {
            const patient = patients.find(p => p.id === id);
            if (patient) {
                hideAllPages();
                document.getElementById('editPatientForm').classList.remove('hidden');
                
                // å¡«å…¥ç¾æœ‰è³‡æ–™
                document.getElementById('editPatientId').value = patient.id;
                document.getElementById('editPatientName').value = patient.name;
                document.getElementById('editPatientIdNumber').value = patient.idNumber;
                document.getElementById('editPatientGender').value = patient.gender;
                document.getElementById('editPatientBirthDate').value = patient.birthDate;
                document.getElementById('editPatientPhone').value = patient.phone;
                document.getElementById('editPatientAddress').value = patient.address || '';
            }
        }

        // æ›´æ–°ç—…äººè³‡æ–™
        function updatePatient(event) {
            event.preventDefault();
            
            const patientId = parseInt(document.getElementById('editPatientId').value);
            const patientIndex = patients.findIndex(p => p.id === patientId);
            
            if (patientIndex !== -1) {
                patients[patientIndex] = {
                    id: patientId,
                    patientNumber: patients[patientIndex].patientNumber, // ä¿ç•™åŸç·¨è™Ÿ
                    name: document.getElementById('editPatientName').value,
                    idNumber: document.getElementById('editPatientIdNumber').value.toUpperCase(),
                    gender: document.getElementById('editPatientGender').value,
                    birthDate: document.getElementById('editPatientBirthDate').value,
                    phone: document.getElementById('editPatientPhone').value,
                    address: document.getElementById('editPatientAddress').value
                };
                
                showNotification('ç—…äººè³‡æ–™æ›´æ–°æˆåŠŸï¼');
                showPatientManagement();
            }
        }

        // åˆªé™¤ç—…äººï¼ˆåƒ…ç®¡ç†å“¡ï¼‰
        function deletePatient(id) {
            document.getElementById('confirmDeleteBtn').onclick = function() {
                patients = patients.filter(p => p.id !== id);
                loadPatientList();
                closeModal('confirmDeleteModal');
                showNotification('ç—…äººè³‡æ–™å·²åˆªé™¤');
            };
            showModal('confirmDeleteModal');
        }

        // é¡¯ç¤ºè¨ºç—‡ç³»çµ±
        function showConsultationSystem() {
            hideAllPages();
            document.getElementById('consultationSystem').classList.remove('hidden');
            loadAppointmentList();
        }

        // é¡¯ç¤ºæ›è™Ÿè¡¨å–®
        function showAppointmentForm() {
            hideAllPages();
            document.getElementById('appointmentForm').classList.remove('hidden');
            document.getElementById('appointmentSearchInput').value = '';
            document.getElementById('selectedPatientId').value = '';
            document.getElementById('selectedPatientInfo').classList.add('hidden');
            document.getElementById('searchResults').classList.add('hidden');
            document.getElementById('appointmentSymptoms').value = ''; // æ¸…ç©ºç—‡ç‹€æè¿°æ¬„ä½
            
            // è¨­å®šé è¨­æ™‚é–“ç‚ºç¾åœ¨
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('appointmentTime').value = now.toISOString().slice(0, 16);
        }

        // æœç´¢æ›è™Ÿç—…äººåŠŸèƒ½
        function searchAppointmentPatients() {
            const searchTerm = document.getElementById('appointmentSearchInput').value.toLowerCase().trim();
            const searchResults = document.getElementById('searchResults');
            const searchResultsList = document.getElementById('searchResultsList');
            
            if (searchTerm === '') {
                searchResults.classList.add('hidden');
                return;
            }
            
            const filteredPatients = patients.filter(patient => 
                patient.name.toLowerCase().includes(searchTerm) ||
                patient.phone.includes(searchTerm) ||
                patient.gender.includes(searchTerm) ||
                patient.patientNumber.toLowerCase().includes(searchTerm) ||
                calculateAge(patient.birthDate).toString().includes(searchTerm)
            );
            
            if (filteredPatients.length === 0) {
                searchResultsList.innerHTML = '<div class="px-4 py-3 text-gray-500 text-sm">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„ç—…äºº</div>';
            } else {
                searchResultsList.innerHTML = filteredPatients.map(patient => `
                    <div class="px-4 py-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0" 
                         onclick="selectPatient(${patient.id})">
                        <div class="font-medium text-gray-900">
                            <span class="text-blue-600 font-mono">${patient.patientNumber}</span> - ${patient.name}
                        </div>
                        <div class="text-sm text-gray-500">
                            ${patient.gender} Â· ${calculateAge(patient.birthDate)}æ­² Â· ${patient.phone}
                        </div>
                    </div>
                `).join('');
            }
            
            searchResults.classList.remove('hidden');
        }

        // é¡¯ç¤ºæœç´¢çµæœ
        function showSearchResults() {
            const searchTerm = document.getElementById('appointmentSearchInput').value.trim();
            if (searchTerm !== '') {
                searchAppointmentPatients();
            }
        }

        // é¸æ“‡ç—…äºº
        function selectPatient(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (patient) {
                document.getElementById('selectedPatientId').value = patientId;
                document.getElementById('appointmentSearchInput').value = '';
                document.getElementById('searchResults').classList.add('hidden');
                document.getElementById('selectedPatientInfo').classList.remove('hidden');
                document.getElementById('selectedPatientDisplay').textContent = 
                    `${patient.patientNumber} - ${patient.name} (${patient.gender}, ${calculateAge(patient.birthDate)}æ­²)`;
            }
        }

        // æ¸…é™¤é¸ä¸­çš„ç—…äºº
        function clearSelectedPatient() {
            document.getElementById('selectedPatientId').value = '';
            document.getElementById('selectedPatientInfo').classList.add('hidden');
            document.getElementById('appointmentSearchInput').focus();
        }

        // æ–°å¢æ›è™Ÿ
        function addAppointment(event) {
            event.preventDefault();
            
            const patientId = parseInt(document.getElementById('selectedPatientId').value);
            if (!patientId) {
                showNotification('è«‹å…ˆé¸æ“‡ç—…äºº', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === patientId);
            
            // æª¢æŸ¥ä»Šæ—¥æ˜¯å¦å·²æ›è™Ÿ
            const today = new Date().toDateString();
            const existingAppointment = appointments.find(apt => 
                apt.patientId === patientId && 
                new Date(apt.appointmentTime).toDateString() === today &&
                apt.status !== 'å·²å®Œæˆ'
            );
            
            if (existingAppointment) {
                showNotification(`ç—…äºº ${patient.patientNumber} - ${patient.name} ä»Šæ—¥å·²æ›è™Ÿï¼ç‹€æ…‹ï¼š${existingAppointment.status}`, 'info');
                return;
            }
            
            const appointment = {
                id: appointments.length + 1,
                patientId: patientId,
                patientName: patient.name,
                patientNumber: patient.patientNumber,
                appointmentTime: document.getElementById('appointmentTime').value,
                symptoms: document.getElementById('appointmentSymptoms').value,
                status: 'å·²æ›è™Ÿ',
                createdAt: new Date().toISOString()
            };
            
            appointments.push(appointment);
            patientStatus[patientId] = 'å·²æ›è™Ÿ';
            
            showNotification(`æ›è™ŸæˆåŠŸï¼ç—…äººï¼š${patient.patientNumber} - ${patient.name}`);
            showConsultationSystem();
        }

        // è¼‰å…¥æ›è™Ÿåˆ—è¡¨
        function loadAppointmentList() {
            const tbody = document.getElementById('appointmentList');
            const today = new Date().toDateString();
            const todayAppointments = appointments.filter(apt => 
                new Date(apt.appointmentTime).toDateString() === today
            );
            
            if (todayAppointments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="border border-gray-200 px-4 py-8 text-center text-gray-500">
                            ä»Šæ—¥æš«ç„¡æ›è™Ÿç—…äºº
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = todayAppointments.map(appointment => {
                const patient = patients.find(p => p.id === appointment.patientId);
                const statusColor = getStatusColor(appointment.status);
                const appointmentDate = new Date(appointment.appointmentTime);
                const timeString = appointmentDate.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-200 px-4 py-3">${timeString}</td>
                        <td class="border border-gray-200 px-4 py-3">
                            <span class="font-mono text-blue-600 font-bold">${appointment.patientNumber || patient.patientNumber}</span>
                        </td>
                        <td class="border border-gray-200 px-4 py-3">${appointment.patientName}</td>
                        <td class="border border-gray-200 px-4 py-3">${calculateAge(patient.birthDate)}</td>
                        <td class="border border-gray-200 px-4 py-3">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColor}">
                                ${appointment.status}
                            </span>
                        </td>
                        <td class="border border-gray-200 px-4 py-3">
                            ${appointment.status === 'å·²æ›è™Ÿ' ? 
                                `<button onclick="changeToWaiting(${appointment.id})" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm mr-2">è½‰ç‚ºç­‰å¾…è¨ºç—‡</button>` :
                                appointment.status === 'ç­‰å¾…è¨ºç—‡' ? 
                                `<button onclick="startConsultation(${appointment.id})" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm mr-2">é–‹å§‹è¨ºç—‡</button>` :
                                appointment.status === 'è¨ºç—‡ä¸­' ?
                                `<button onclick="showConsultationRecord(${appointment.id})" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm mr-2">å¡«å¯«è¨ºç—‡è¨˜éŒ„</button>` :
                                appointment.status === 'å·²å®Œæˆ' ?
                                `<button onclick="viewPatientHistory(${appointment.patientId})" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded text-sm">æŸ¥çœ‹ç—…æ­·</button>` :
                                '<span class="text-gray-500 text-sm">è™•ç†ä¸­</span>'
                            }
                            ${appointment.status !== 'å·²å®Œæˆ' ? 
                                `<button onclick="viewPatientHistory(${appointment.patientId})" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded text-sm ml-2">æŸ¥çœ‹ç—…æ­·</button>` : ''
                            }
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ç²å–ç‹€æ…‹é¡è‰²
        function getStatusColor(status) {
            switch(status) {
                case 'å·²æ›è™Ÿ': return 'bg-gray-100 text-gray-800';
                case 'ç­‰å¾…è¨ºç—‡': return 'bg-yellow-100 text-yellow-800';
                case 'è¨ºç—‡ä¸­': return 'bg-blue-100 text-blue-800';
                case 'å·²å®Œæˆ': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // è½‰ç‚ºç­‰å¾…è¨ºç—‡ç‹€æ…‹
        function changeToWaiting(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (appointment) {
                const patient = patients.find(p => p.id === appointment.patientId);
                appointment.status = 'ç­‰å¾…è¨ºç—‡';
                patientStatus[appointment.patientId] = 'ç­‰å¾…è¨ºç—‡';
                loadAppointmentList();
                
                showNotification(`${patient.patientNumber} - ${patient.name} å·²è½‰ç‚ºç­‰å¾…è¨ºç—‡ç‹€æ…‹`, 'info');
            }
        }

        // é–‹å§‹è¨ºç—‡
        function startConsultation(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (appointment) {
                const patient = patients.find(p => p.id === appointment.patientId);
                appointment.status = 'è¨ºç—‡ä¸­';
                patientStatus[appointment.patientId] = 'è¨ºç—‡ä¸­';
                loadAppointmentList();
                
                // é¡¯ç¤ºé–‹å§‹è¨ºç—‡é€šçŸ¥
                showNotification(`é–‹å§‹è¨ºç—‡ï¼š${patient.patientNumber} - ${patient.name}`, 'info');
                
                // ç›´æ¥è·³è½‰åˆ°è¨ºç—‡è¨˜éŒ„è¡¨å–®
                showConsultationRecord(appointmentId);
            }
        }

        // é¡¯ç¤ºç—…äººè©³ç´°è³‡æ–™è¡¨å–®
        function showConsultationRecord(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            const patient = patients.find(p => p.id === appointment.patientId);
            
            if (appointment && patient) {
                // å¡«å…¥å®Œæ•´ç—…äººè³‡è¨Š
                document.getElementById('currentPatientNumber').textContent = patient.patientNumber;
                document.getElementById('currentPatientName').textContent = patient.name;
                document.getElementById('currentPatientGender').textContent = patient.gender;
                document.getElementById('currentPatientAge').textContent = calculateAge(patient.birthDate) + 'æ­²';
                document.getElementById('currentPatientBirthDate').textContent = patient.birthDate;
                document.getElementById('currentPatientPhone').textContent = patient.phone;
                document.getElementById('currentPatientAddress').textContent = patient.address || 'æœªå¡«å¯«';
                document.getElementById('currentPatientIdNumber').textContent = patient.idNumber;
                
                // è¨­å®šéš±è—æ¬„ä½
                document.getElementById('currentAppointmentId').value = appointmentId;
                document.getElementById('currentPatientId').value = patient.id;
                
                // ç²å–è©²ç—…äººæœ€è¿‘çš„è¨ºç—‡è¨˜éŒ„
                const patientConsultations = consultations.filter(c => c.patientId === patient.id);
                const lastConsultation = patientConsultations.length > 0 ? 
                    patientConsultations[patientConsultations.length - 1] : null;
                
                // é å¡«ä¸Šä¸€æ¬¡çš„ç—…æ­·è³‡æ–™ï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨ç©ºå€¼
                // ä¸»è¨´æ¬„ä½æœƒé å¡«æ›è™Ÿæ™‚çš„ç—‡ç‹€æè¿°ï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨ä¸Šæ¬¡çš„ä¸»è¨´
                document.getElementById('chiefComplaint').value = appointment.symptoms || (lastConsultation ? lastConsultation.chiefComplaint : '');
                document.getElementById('presentIllness').value = lastConsultation ? lastConsultation.presentIllness : '';
                document.getElementById('pulse').value = lastConsultation ? lastConsultation.pulse : '';
                document.getElementById('tongue').value = lastConsultation ? lastConsultation.tongue : '';
                document.getElementById('diagnosis').value = lastConsultation ? lastConsultation.diagnosis : '';
                document.getElementById('prescription').value = lastConsultation ? lastConsultation.prescription : '';
                document.getElementById('instructions').value = lastConsultation ? lastConsultation.instructions : '';
                
                // é¡¯ç¤ºç—…äººè©³ç´°è³‡æ–™è¡¨å–®
                document.getElementById('consultationForm').classList.remove('hidden');
                
                // æ»¾å‹•åˆ°è¡¨å–®ä½ç½®
                document.getElementById('consultationForm').scrollIntoView({ behavior: 'smooth' });
            }
        }

        // å„²å­˜è¨ºç—‡è¨˜éŒ„
        function saveConsultation(event) {
            event.preventDefault();
            
            const appointmentId = parseInt(document.getElementById('currentAppointmentId').value);
            const patientId = parseInt(document.getElementById('currentPatientId').value);
            
            // è¨˜éŒ„å®Œæˆè¨ºç—‡çš„æ™‚é–“
            const completionTime = new Date();
            
            const consultation = {
                id: consultations.length + 1,
                appointmentId: appointmentId,
                patientId: patientId,
                date: completionTime.toLocaleDateString('zh-TW'),
                time: completionTime.toLocaleTimeString('zh-TW'),
                chiefComplaint: document.getElementById('chiefComplaint').value,
                presentIllness: document.getElementById('presentIllness').value,
                pulse: document.getElementById('pulse').value,
                tongue: document.getElementById('tongue').value,
                diagnosis: document.getElementById('diagnosis').value,
                prescription: document.getElementById('prescription').value,
                instructions: document.getElementById('instructions').value,
                doctor: userNames[currentUser]
            };
            
            consultations.push(consultation);
            
            // è‡ªå‹•å°‡æ›è™Ÿç‹€æ…‹æ›´æ–°ç‚ºå·²å®Œæˆï¼Œä¸¦å„²å­˜è¨ºç—‡è¨˜éŒ„ID
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (appointment) {
                appointment.status = 'å·²å®Œæˆ';
                appointment.consultationId = consultation.id; // é—œè¯è¨ºç—‡è¨˜éŒ„
                patientStatus[patientId] = 'å·²å®Œæˆ';
            }
            
            showNotification('è¨ºç—‡è¨˜éŒ„å„²å­˜æˆåŠŸï¼ç—…äººç‹€æ…‹å·²æ›´æ–°ç‚ºã€Œå·²å®Œæˆã€ã€‚');
            clearConsultationForm();
            loadAppointmentList();
        }

        // å–æ¶ˆè¨ºç—‡
        function cancelConsultation() {
            const appointmentId = parseInt(document.getElementById('currentAppointmentId').value);
            const appointment = appointments.find(apt => apt.id === appointmentId);
            
            if (appointment) {
                // å°‡ç‹€æ…‹æ”¹å›ç­‰å¾…è¨ºç—‡
                appointment.status = 'ç­‰å¾…è¨ºç—‡';
                patientStatus[appointment.patientId] = 'ç­‰å¾…è¨ºç—‡';
            }
            
            clearConsultationForm();
            loadAppointmentList();
            showNotification('å·²å–æ¶ˆè¨ºç—‡ï¼Œç—…äººç‹€æ…‹å·²æ¢å¾©ç‚ºã€Œç­‰å¾…è¨ºç—‡ã€ã€‚', 'info');
        }

        // æ¸…é™¤ç—…äººè©³ç´°è³‡æ–™è¡¨å–®
        function clearConsultationForm() {
            document.getElementById('consultationForm').classList.add('hidden');
            const inputs = ['chiefComplaint', 'presentIllness', 'pulse', 'tongue', 'diagnosis', 'prescription', 'instructions'];
            inputs.forEach(id => document.getElementById(id).value = '');
            document.getElementById('currentAppointmentId').value = '';
            document.getElementById('currentPatientId').value = '';
        }

        // é¡¯ç¤ºç³»çµ±ç®¡ç†
        function showSystemManagement() {
            hideAllPages();
            document.getElementById('systemManagement').classList.remove('hidden');
        }

        // é¡¯ç¤ºçµ±è¨ˆé é¢
        function showStatistics() {
            hideAllPages();
            document.getElementById('statisticsPage').classList.remove('hidden');
            updateStatistics();
        }

        // æ›´æ–°çµ±è¨ˆæ•¸æ“š
        function updateStatistics() {
            document.getElementById('totalPatients').textContent = patients.length;
            document.getElementById('totalConsultations').textContent = consultations.length;
            
            const today = new Date().toLocaleDateString('zh-TW');
            const todayConsultations = consultations.filter(c => c.date === today).length;
            document.getElementById('todayConsultations').textContent = todayConsultations;
        }

        // æµ®å‹•é€šçŸ¥ç³»çµ±
        let notificationTimeout;

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('floatingNotification');
            const messageEl = document.getElementById('notificationMessage');
            const iconEl = document.getElementById('notificationIcon');
            const container = notification.querySelector('div');
            
            // æ¸…é™¤ä¹‹å‰çš„å®šæ™‚å™¨
            if (notificationTimeout) {
                clearTimeout(notificationTimeout);
            }
            
            // è¨­å®šè¨Šæ¯å’Œåœ–ç¤º
            messageEl.textContent = message;
            
            // æ ¹æ“šé¡å‹è¨­å®šæ¨£å¼
            switch(type) {
                case 'success':
                    container.className = 'bg-white rounded-lg shadow-2xl border-l-4 border-green-500 p-4 max-w-sm transform translate-x-full transition-transform duration-300 ease-out';
                    iconEl.innerHTML = '<span class="text-green-500 text-xl">âœ…</span>';
                    break;
                case 'error':
                    container.className = 'bg-white rounded-lg shadow-2xl border-l-4 border-red-500 p-4 max-w-sm transform translate-x-full transition-transform duration-300 ease-out';
                    iconEl.innerHTML = '<span class="text-red-500 text-xl">âŒ</span>';
                    break;
                case 'info':
                    container.className = 'bg-white rounded-lg shadow-2xl border-l-4 border-blue-500 p-4 max-w-sm transform translate-x-full transition-transform duration-300 ease-out';
                    iconEl.innerHTML = '<span class="text-blue-500 text-xl">â„¹ï¸</span>';
                    break;
            }
            
            // é¡¯ç¤ºé€šçŸ¥
            notification.classList.remove('hidden');
            
            // å»¶é²ä¸€é»è®“å‹•ç•«ç”Ÿæ•ˆ
            setTimeout(() => {
                container.classList.remove('translate-x-full');
            }, 10);
            
            // 2ç§’å¾Œè‡ªå‹•éš±è—
            notificationTimeout = setTimeout(() => {
                hideNotification();
            }, 2000);
        }

        function hideNotification() {
            const notification = document.getElementById('floatingNotification');
            const container = notification.querySelector('div');
            
            container.classList.add('translate-x-full');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 300);
            
            if (notificationTimeout) {
                clearTimeout(notificationTimeout);
            }
        }

        // æµ®å‹•è¦–çª—æ§åˆ¶å‡½æ•¸
        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function showFeatureModal(message) {
            document.getElementById('featureMessage').textContent = message;
            showModal('featureModal');
        }



        // ç—…æ­·åˆ†é è®Šæ•¸
        let currentHistoryPatientId = null;
        let currentHistoryPage = 0;
        let historyConsultations = [];

        // æŸ¥çœ‹ç—…äººç—…æ­·è¨˜éŒ„
        function viewPatientHistory(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) return;
            
            // ç²å–è©²ç—…äººçš„æ‰€æœ‰è¨ºç—‡è¨˜éŒ„
            historyConsultations = consultations.filter(c => c.patientId === patientId);
            
            // è¨­å®šå…¨åŸŸè®Šæ•¸
            currentHistoryPatientId = patientId;
            
            // è¨­å®šç—…äººè³‡è¨Š
            document.getElementById('historyPatientInfo').textContent = 
                `${patient.patientNumber} - ${patient.name} (${patient.gender}, ${calculateAge(patient.birthDate)}æ­²)`;
            
            if (historyConsultations.length === 0) {
                document.getElementById('patientHistoryContent').innerHTML = `
                    <div class="text-center py-12">
                        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-4xl text-gray-400">ğŸ“‹</span>
                        </div>
                        <h3 class="text-lg font-medium text-gray-600 mb-2">æš«ç„¡ç—…æ­·è¨˜éŒ„</h3>
                        <p class="text-gray-500">æ­¤ç—…äººå°šæœªæœ‰è¨ºç—‡è¨˜éŒ„</p>
                    </div>
                `;
            } else {
                // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€èˆŠçš„åœ¨å‰ï¼Œæœ€æ–°çš„åœ¨å¾Œï¼‰
                historyConsultations.sort((a, b) => {
                    const dateA = new Date(a.date + ' ' + a.time);
                    const dateB = new Date(b.date + ' ' + b.time);
                    return dateA - dateB;
                });
                
                // è¨­å®šç‚ºæœ€å¾Œä¸€é ï¼ˆæœ€æ–°è¨˜éŒ„ï¼‰
                currentHistoryPage = historyConsultations.length - 1;
                
                displayHistoryPage();
            }
            
            showModal('patientHistoryModal');
        }

        // é¡¯ç¤ºç—…æ­·é é¢
        function displayHistoryPage() {
            if (historyConsultations.length === 0) return;
            
            const consultation = historyConsultations[currentHistoryPage];
            const totalPages = historyConsultations.length;
            // è¨ºç—‡æ¬¡æ•¸ï¼šç¬¬1æ¬¡æ˜¯æœ€èˆŠçš„ï¼Œæœ€å¾Œä¸€æ¬¡æ˜¯æœ€æ–°çš„
            const consultationNumber = currentHistoryPage + 1;
            const currentPageDisplay = `ç¬¬ ${consultationNumber} æ¬¡è¨ºç—‡ (ç¬¬ ${currentHistoryPage + 1} é  / å…± ${totalPages} é )`;
            
            document.getElementById('patientHistoryContent').innerHTML = `
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h4 class="text-lg font-semibold text-gray-800">è¨ºç—‡è¨˜éŒ„</h4>
                        <div class="flex items-center space-x-4">
                            <span class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm font-medium">
                                ${currentPageDisplay}
                            </span>
                            <div class="flex space-x-2">
                                <button onclick="previousHistoryPage()" 
                                        ${currentHistoryPage === 0 ? 'disabled' : ''} 
                                        class="px-3 py-1 bg-gray-500 hover:bg-gray-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white rounded text-sm">
                                    â† è¼ƒèˆŠè¨˜éŒ„
                                </button>
                                <button onclick="nextHistoryPage()" 
                                        ${currentHistoryPage === totalPages - 1 ? 'disabled' : ''} 
                                        class="px-3 py-1 bg-gray-500 hover:bg-gray-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white rounded text-sm">
                                    è¼ƒæ–°è¨˜éŒ„ â†’
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-6 border-l-4 border-indigo-500">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h5 class="text-lg font-semibold text-gray-800">ç¬¬ ${consultationNumber} æ¬¡è¨ºç—‡</h5>
                                <p class="text-sm text-gray-600">${consultation.date} ${consultation.time}</p>
                                <p class="text-sm text-indigo-600 font-medium">${consultation.doctor}</p>
                            </div>
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-medium">å·²å®Œæˆ</span>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div class="bg-white rounded-lg p-4">
                                <h6 class="font-medium text-gray-700 mb-2">ğŸ—£ï¸ ä¸»è¨´</h6>
                                <p class="text-gray-600">${consultation.chiefComplaint || 'æœªè¨˜éŒ„'}</p>
                            </div>
                            
                            <div class="bg-white rounded-lg p-4">
                                <h6 class="font-medium text-gray-700 mb-2">ğŸ“ ç¾ç—…å²</h6>
                                <p class="text-gray-600">${consultation.presentIllness || 'æœªè¨˜éŒ„'}</p>
                            </div>
                            
                            <div class="bg-white rounded-lg p-4">
                                <h6 class="font-medium text-gray-700 mb-2">ğŸ«€ è„ˆè±¡</h6>
                                <p class="text-gray-600">${consultation.pulse || 'æœªè¨˜éŒ„'}</p>
                            </div>
                            
                            <div class="bg-white rounded-lg p-4">
                                <h6 class="font-medium text-gray-700 mb-2">ğŸ‘… èˆŒè±¡</h6>
                                <p class="text-gray-600">${consultation.tongue || 'æœªè¨˜éŒ„'}</p>
                            </div>
                            
                            <div class="bg-white rounded-lg p-4 md:col-span-2">
                                <h6 class="font-medium text-gray-700 mb-2">ğŸ¯ ä¸­é†«è¨ºæ–·</h6>
                                <p class="text-gray-600">${consultation.diagnosis || 'æœªè¨˜éŒ„'}</p>
                            </div>
                            
                            <div class="bg-white rounded-lg p-4 md:col-span-2">
                                <h6 class="font-medium text-gray-700 mb-2">ğŸ’Š è™•æ–¹</h6>
                                <p class="text-gray-600 whitespace-pre-line">${consultation.prescription || 'æœªè¨˜éŒ„'}</p>
                            </div>
                            
                            <div class="bg-white rounded-lg p-4 md:col-span-2">
                                <h6 class="font-medium text-gray-700 mb-2">ğŸ“‹ é†«å›‘</h6>
                                <p class="text-gray-600 whitespace-pre-line">${consultation.instructions || 'æœªè¨˜éŒ„'}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ä¸Šä¸€é ç—…æ­·ï¼ˆè¼ƒèˆŠè¨˜éŒ„ï¼‰
        function previousHistoryPage() {
            if (currentHistoryPage > 0) {
                currentHistoryPage--;
                displayHistoryPage();
            }
        }

        // ä¸‹ä¸€é ç—…æ­·ï¼ˆè¼ƒæ–°è¨˜éŒ„ï¼‰
        function nextHistoryPage() {
            if (currentHistoryPage < historyConsultations.length - 1) {
                currentHistoryPage++;
                displayHistoryPage();
            }
        }

        // é»æ“Šè¦–çª—å¤–å€åŸŸé—œé–‰è¦–çª—
        document.addEventListener('click', function(event) {
            const modals = ['patientDetailModal', 'confirmDeleteModal', 'featureModal', 'patientHistoryModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    closeModal(modalId);
                }
            });
            
            // é»æ“Šå¤–éƒ¨é—œé–‰æœç´¢çµæœ
            const searchResults = document.getElementById('searchResults');
            const searchInput = document.getElementById('appointmentSearchInput');
            if (searchResults && !searchResults.contains(event.target) && event.target !== searchInput) {
                searchResults.classList.add('hidden');
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'967491e603f8ddbe',t:'MTc1Mzg3NTUwOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
