<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­é†«è¨ºç—‡è¼”åŠ©å·¥å…· - é›²ç«¯åŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
        
        // Firebase é…ç½® (è«‹æ›¿æ›ç‚ºæ‚¨çš„å¯¦éš›é…ç½®)
        const firebaseConfig = {
            apiKey: "demo-api-key",
            authDomain: "tcm-tool-demo.firebaseapp.com",
            projectId: "tcm-tool-demo",
            storageBucket: "tcm-tool-demo.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };
        
        // åˆå§‹åŒ– Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // å°‡ Firebase å¯¦ä¾‹æ›è¼‰åˆ° window ä¾›å…¶ä»–è…³æœ¬ä½¿ç”¨
        window.firebaseApp = app;
        window.firebaseDb = db;
        window.firebaseAuth = auth;
        window.firebaseModules = {
            doc, setDoc, getDoc, onSnapshot, serverTimestamp,
            signInAnonymously, onAuthStateChanged
        };
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .search-highlight {
            background: linear-gradient(120deg, #fbbf24 0%, #f59e0b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .sync-animation {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .pulse-dot {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .cloud-status {
            transition: all 0.3s ease;
        }
        .cloud-status.connected {
            color: #10b981;
        }
        .cloud-status.disconnected {
            color: #ef4444;
        }
        .cloud-status.syncing {
            color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="max-w-4xl mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <h1 class="text-xl font-bold text-gray-800">ä¸­è—¥è³‡æ–™åº«</h1>
                    <div class="flex items-center space-x-2 text-sm">
                        <div id="cloudStatus" class="cloud-status disconnected flex items-center space-x-1">
                            <span id="cloudIcon">â˜ï¸</span>
                            <span id="cloudText">é€£æ¥ä¸­...</span>
                        </div>
                        <div id="userInfo" class="text-xs text-gray-500 hidden">
                            è¨­å‚™ID: <span id="deviceId">-</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="syncBtn" class="px-3 py-1.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm flex items-center space-x-1">
                        <span id="syncIcon">ğŸ”„</span>
                        <span id="syncText">ç«‹å³åŒæ­¥</span>
                    </button>
                    <button id="shareBtn" class="px-3 py-1.5 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors text-sm">
                        ğŸ”— åˆ†äº«è³‡æ–™
                    </button>
                    <button id="backupBtn" class="px-3 py-1.5 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors text-sm">
                        ğŸ’¾ å‚™ä»½
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-4xl mx-auto px-4 py-6">
        <!-- Connection Status Banner -->
        <div id="connectionBanner" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 hidden">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div id="connectionIndicator" class="w-3 h-3 bg-blue-500 rounded-full pulse-dot"></div>
                    <div>
                        <div id="connectionMessage" class="text-sm font-medium text-blue-800">æ­£åœ¨é€£æ¥é›²ç«¯æœå‹™...</div>
                        <div id="connectionDetails" class="text-xs text-blue-600">åˆå§‹åŒ– Firebase é€£æ¥</div>
                    </div>
                </div>
                <button id="dismissBanner" class="text-blue-400 hover:text-blue-600">Ã—</button>
            </div>
        </div>

        <!-- Search Section -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="relative">
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="æœå°‹ç—‡ç‹€æˆ–ä¸­è—¥..." 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                    autocomplete="off"
                >
                <button id="searchBtn" class="absolute right-2 top-2 px-4 py-1.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm">
                    æœå°‹
                </button>
                <div id="searchSuggestions" class="absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-lg shadow-lg mt-1 hidden z-10 max-h-64 overflow-y-auto"></div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="bg-white rounded-lg shadow-sm p-6 mb-6 hidden">
            <div id="searchResults" class="space-y-4"></div>
        </div>

        <!-- Data Management Section -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex flex-wrap gap-3 mb-4">
                <button id="fileImportBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm">
                    ğŸ“ å°å…¥æª”æ¡ˆ
                </button>
                <button id="textImportBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors text-sm">
                    âœï¸ æ‰‹å‹•è¼¸å…¥
                </button>

                <div class="ml-auto flex items-center space-x-4 text-sm text-gray-600">
                    <span>ä¸­è—¥: <span id="herbCount" class="font-medium">0</span></span>
                    <span>ç—‡ç‹€: <span id="symptomCount" class="font-medium">0</span></span>
                    <span class="flex items-center">
                        <span id="dataStatusIndicator" class="w-2 h-2 bg-gray-500 rounded-full mr-1" title="è³‡æ–™ç‹€æ…‹"></span>
                        <span id="syncStatusText" class="text-xs">æœ¬åœ°</span>
                    </span>
                    <span class="text-xs text-gray-400">
                        æœ€å¾ŒåŒæ­¥: <span id="lastSyncTime">å¾æœª</span>
                    </span>
                </div>
            </div>
            
            <!-- Manual Input Section -->
            <div id="manualInputSection" class="hidden">
                <textarea 
                    id="importData" 
                    rows="6" 
                    placeholder="æ ¼å¼ï¼šä¸­è—¥åï¼šç—‡ç‹€1,ç—‡ç‹€2,ç—‡ç‹€3&#10;ç¯„ä¾‹ï¼šç•¶æ­¸ï¼šè¡€è™›,æœˆç¶“ä¸èª¿,ä¾¿ç§˜"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:border-blue-500 focus:outline-none resize-none text-sm mb-3"
                ></textarea>
                <button id="processImport" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm">
                    å°å…¥è³‡æ–™
                </button>
            </div>
            
            <!-- File Import Status -->
            <div id="importStatus" class="hidden p-3 rounded-md">
                <div class="flex items-center space-x-2">
                    <span id="statusIcon">âœ…</span>
                    <span id="statusText" class="text-sm"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Data Modal -->
    <div id="shareModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    ğŸ”— åˆ†äº«è³‡æ–™
                </h3>
                <button id="closeShareModal" class="text-gray-400 hover:text-gray-600 text-xl">Ã—</button>
            </div>
            
            <!-- Share Options -->
            <div class="space-y-4">
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="text-sm font-medium text-gray-800 mb-2">æ‚¨çš„åˆ†äº«ä»£ç¢¼</div>
                    <div class="flex items-center space-x-2">
                        <input 
                            type="text" 
                            id="shareCode" 
                            readonly 
                            class="flex-1 px-3 py-2 bg-white border border-gray-300 rounded text-sm font-mono"
                            value="è¼‰å…¥ä¸­..."
                        >
                        <button id="copyShareCode" class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                            è¤‡è£½
                        </button>
                    </div>
                    <div class="text-xs text-gray-500 mt-2">
                        å…¶ä»–è¨­å‚™å¯ä½¿ç”¨æ­¤ä»£ç¢¼å­˜å–æ‚¨çš„è³‡æ–™
                    </div>
                </div>
                
                <div class="border-t pt-4">
                    <div class="text-sm font-medium text-gray-800 mb-2">å­˜å–ä»–äººåˆ†äº«çš„è³‡æ–™</div>
                    <div class="flex items-center space-x-2">
                        <input 
                            type="text" 
                            id="accessCode" 
                            placeholder="è¼¸å…¥åˆ†äº«ä»£ç¢¼"
                            class="flex-1 px-3 py-2 border border-gray-300 rounded text-sm"
                        >
                        <button id="accessSharedData" class="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm">
                            å­˜å–
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Status Message -->
            <div id="shareStatus" class="hidden mt-4 p-3 rounded-lg text-sm">
                <div class="flex items-center space-x-2">
                    <span id="shareStatusIcon">âœ…</span>
                    <span id="shareStatusText"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Backup Modal -->
    <div id="backupModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    ğŸ’¾ è³‡æ–™å‚™ä»½
                </h3>
                <button id="closeBackupModal" class="text-gray-400 hover:text-gray-600 text-xl">Ã—</button>
            </div>
            
            <!-- Backup Info -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600" id="backupHerbCount">0</div>
                        <div class="text-gray-600">ä¸­è—¥</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600" id="backupSymptomCount">0</div>
                        <div class="text-gray-600">ç—‡ç‹€</div>
                    </div>
                </div>
                <div class="text-center mt-3 text-xs text-gray-500">
                    é›²ç«¯åŒæ­¥: <span id="cloudSyncStatus" class="font-medium">-</span>
                </div>
            </div>
            
            <!-- Backup Options -->
            <div class="space-y-3">
                <button id="downloadBackup" class="w-full px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center justify-center space-x-2">
                    <span>ğŸ“¥</span>
                    <span>ä¸‹è¼‰å‚™ä»½æª”æ¡ˆ</span>
                </button>
                
                <button id="copyBackup" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center space-x-2">
                    <span>ğŸ“‹</span>
                    <span>è¤‡è£½åˆ°å‰ªè²¼ç°¿</span>
                </button>
                
                <div class="border-t pt-3">
                    <div class="text-sm text-gray-600 mb-2">æˆ–è€…æ¢å¾©å‚™ä»½ï¼š</div>
                    <button id="restoreBackup" class="w-full px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors flex items-center justify-center space-x-2">
                        <span>ğŸ“¤</span>
                        <span>é¸æ“‡å‚™ä»½æª”æ¡ˆæ¢å¾©</span>
                    </button>
                </div>
            </div>
            
            <!-- Status Message -->
            <div id="backupStatus" class="hidden mt-4 p-3 rounded-lg text-sm">
                <div class="flex items-center space-x-2">
                    <span id="backupStatusIcon">âœ…</span>
                    <span id="backupStatusText"></span>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".txt,.json" class="hidden">
    <input type="file" id="backupFileInput" accept=".json" class="hidden">

    <script>
        class CloudTCMTool {
            constructor() {
                this.storageKey = 'tcmData_v4';
                this.currentVersion = '4.0';
                
                // Firebase ç›¸é—œ
                this.isFirebaseReady = false;
                this.currentUser = null;
                this.deviceId = this.getOrCreateDeviceId();
                this.unsubscribeSnapshot = null;
                
                // è³‡æ–™ç‹€æ…‹
                this.data = {
                    herbs: {},
                    symptoms: {}
                };
                
                this.isOnline = navigator.onLine;
                this.lastSyncTime = null;
                this.syncInProgress = false;
                
                // åˆå§‹åŒ–
                this.initializeApp();
            }

            async initializeApp() {
                // é¡¯ç¤ºé€£æ¥æ©«å¹…
                this.showConnectionBanner('æ­£åœ¨åˆå§‹åŒ–é›²ç«¯æœå‹™...', 'é€£æ¥ Firebase');
                
                // è¼‰å…¥æœ¬åœ°è³‡æ–™
                this.loadLocalData();
                this.updateUI();
                
                // åˆå§‹åŒ–äº‹ä»¶ç›£è½å™¨
                this.initializeEventListeners();
                
                // ç­‰å¾… Firebase åˆå§‹åŒ–
                await this.waitForFirebase();
                
                // åˆå§‹åŒ– Firebase èªè­‰å’Œè³‡æ–™åº«
                await this.initializeFirebase();
                
                // éš±è—é€£æ¥æ©«å¹…
                setTimeout(() => {
                    this.hideConnectionBanner();
                }, 2000);
            }

            async waitForFirebase() {
                return new Promise((resolve) => {
                    const checkFirebase = () => {
                        if (window.firebaseDb && window.firebaseAuth && window.firebaseModules) {
                            resolve();
                        } else {
                            setTimeout(checkFirebase, 100);
                        }
                    };
                    checkFirebase();
                });
            }

            async initializeFirebase() {
                try {
                    const { onAuthStateChanged, signInAnonymously } = window.firebaseModules;
                    
                    // ç›£è½èªè­‰ç‹€æ…‹
                    onAuthStateChanged(window.firebaseAuth, async (user) => {
                        if (user) {
                            this.currentUser = user;
                            this.isFirebaseReady = true;
                            this.updateCloudStatus('connected', 'é›²ç«¯å·²é€£æ¥');
                            
                            // è¨­ç½®å³æ™‚è³‡æ–™ç›£è½
                            await this.setupRealtimeListener();
                            
                            // åŸ·è¡Œåˆå§‹åŒæ­¥
                            await this.performInitialSync();
                            
                        } else {
                            this.updateCloudStatus('disconnected', 'æœªé€£æ¥');
                        }
                    });
                    
                    // åŒ¿åç™»å…¥
                    await signInAnonymously(window.firebaseAuth);
                    
                } catch (error) {
                    console.error('Firebase åˆå§‹åŒ–å¤±æ•—:', error);
                    this.updateCloudStatus('disconnected', 'é€£æ¥å¤±æ•—');
                    this.showSystemNotification('âŒ', 'Firebase é€£æ¥å¤±æ•—ï¼Œä½¿ç”¨é›¢ç·šæ¨¡å¼', 'bg-red-100 text-red-800');
                }
            }

            async setupRealtimeListener() {
                if (!this.isFirebaseReady || this.unsubscribeSnapshot) return;
                
                try {
                    const { doc, onSnapshot } = window.firebaseModules;
                    const docRef = doc(window.firebaseDb, 'tcmData', this.deviceId);
                    
                    this.unsubscribeSnapshot = onSnapshot(docRef, (docSnapshot) => {
                        if (docSnapshot.exists() && !this.syncInProgress) {
                            const cloudData = docSnapshot.data();
                            if (cloudData && cloudData.data) {
                                const cloudChecksum = this.generateChecksum(cloudData.data);
                                const localChecksum = this.generateChecksum(this.data);
                                
                                if (cloudChecksum !== localChecksum) {
                                    this.handleCloudDataUpdate(cloudData);
                                }
                            }
                        }
                    }, (error) => {
                        console.error('å³æ™‚ç›£è½éŒ¯èª¤:', error);
                    });
                    
                } catch (error) {
                    console.error('è¨­ç½®å³æ™‚ç›£è½å¤±æ•—:', error);
                }
            }

            handleCloudDataUpdate(cloudData) {
                if (confirm('æª¢æ¸¬åˆ°é›²ç«¯è³‡æ–™æ›´æ–°ï¼Œæ˜¯å¦åŒæ­¥åˆ°æœ¬åœ°ï¼Ÿ')) {
                    this.data = cloudData.data;
                    this.saveLocalData();
                    this.updateUI();
                    this.lastSyncTime = new Date();
                    this.updateSyncStatus();
                    this.showSystemNotification('ğŸ”„', 'å·²åŒæ­¥é›²ç«¯è³‡æ–™æ›´æ–°', 'bg-blue-100 text-blue-800');
                }
            }

            async performInitialSync() {
                if (!this.isFirebaseReady) return;
                
                try {
                    const { doc, getDoc } = window.firebaseModules;
                    const docRef = doc(window.firebaseDb, 'tcmData', this.deviceId);
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        const cloudData = docSnap.data();
                        const cloudTimestamp = cloudData.lastModified?.toDate() || new Date(0);
                        const localTimestamp = new Date(localStorage.getItem('tcmLastModified') || 0);
                        
                        if (cloudTimestamp > localTimestamp) {
                            this.data = cloudData.data;
                            this.saveLocalData();
                            this.updateUI();
                            this.showSystemNotification('ğŸ“¥', 'å·²è¼‰å…¥é›²ç«¯è³‡æ–™', 'bg-green-100 text-green-800');
                        } else if (localTimestamp > cloudTimestamp) {
                            await this.syncToCloud();
                        }
                    } else {
                        // é›²ç«¯æ²’æœ‰è³‡æ–™ï¼Œä¸Šå‚³æœ¬åœ°è³‡æ–™
                        if (Object.keys(this.data.herbs).length > 0) {
                            await this.syncToCloud();
                        }
                    }
                    
                    this.lastSyncTime = new Date();
                    this.updateSyncStatus();
                    
                } catch (error) {
                    console.error('åˆå§‹åŒæ­¥å¤±æ•—:', error);
                }
            }

            async syncToCloud() {
                if (!this.isFirebaseReady || this.syncInProgress) return;
                
                this.syncInProgress = true;
                this.updateCloudStatus('syncing', 'åŒæ­¥ä¸­...');
                
                try {
                    const { doc, setDoc, serverTimestamp } = window.firebaseModules;
                    const docRef = doc(window.firebaseDb, 'tcmData', this.deviceId);
                    
                    const cloudData = {
                        data: this.data,
                        lastModified: serverTimestamp(),
                        version: this.currentVersion,
                        deviceId: this.deviceId,
                        checksum: this.generateChecksum(this.data)
                    };
                    
                    await setDoc(docRef, cloudData);
                    
                    this.lastSyncTime = new Date();
                    localStorage.setItem('tcmLastModified', this.lastSyncTime.toISOString());
                    
                    this.updateCloudStatus('connected', 'é›²ç«¯å·²é€£æ¥');
                    this.updateSyncStatus();
                    
                    return true;
                } catch (error) {
                    console.error('åŒæ­¥åˆ°é›²ç«¯å¤±æ•—:', error);
                    this.updateCloudStatus('disconnected', 'åŒæ­¥å¤±æ•—');
                    throw error;
                } finally {
                    this.syncInProgress = false;
                }
            }

            async accessSharedData(shareCode) {
                if (!this.isFirebaseReady) {
                    throw new Error('é›²ç«¯æœå‹™æœªå°±ç·’');
                }
                
                try {
                    const { doc, getDoc } = window.firebaseModules;
                    const docRef = doc(window.firebaseDb, 'tcmData', shareCode);
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        const sharedData = docSnap.data();
                        return sharedData.data;
                    } else {
                        throw new Error('åˆ†äº«ä»£ç¢¼ç„¡æ•ˆæˆ–è³‡æ–™ä¸å­˜åœ¨');
                    }
                } catch (error) {
                    console.error('å­˜å–åˆ†äº«è³‡æ–™å¤±æ•—:', error);
                    throw error;
                }
            }

            getOrCreateDeviceId() {
                let deviceId = localStorage.getItem('tcmDeviceId');
                if (!deviceId) {
                    deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('tcmDeviceId', deviceId);
                }
                return deviceId;
            }

            loadLocalData() {
                try {
                    const stored = localStorage.getItem(this.storageKey);
                    if (stored) {
                        this.data = JSON.parse(stored);
                    }
                } catch (error) {
                    console.error('è¼‰å…¥æœ¬åœ°è³‡æ–™å¤±æ•—:', error);
                }
            }

            saveLocalData() {
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(this.data));
                    localStorage.setItem('tcmLastModified', new Date().toISOString());
                } catch (error) {
                    console.error('ä¿å­˜æœ¬åœ°è³‡æ–™å¤±æ•—:', error);
                }
            }

            updateCloudStatus(status, message) {
                const cloudStatus = document.getElementById('cloudStatus');
                const cloudIcon = document.getElementById('cloudIcon');
                const cloudText = document.getElementById('cloudText');
                
                cloudStatus.className = `cloud-status ${status} flex items-center space-x-1`;
                
                switch (status) {
                    case 'connected':
                        cloudIcon.textContent = 'â˜ï¸';
                        break;
                    case 'disconnected':
                        cloudIcon.textContent = 'âš ï¸';
                        break;
                    case 'syncing':
                        cloudIcon.textContent = 'ğŸ”„';
                        cloudIcon.classList.add('sync-animation');
                        break;
                }
                
                cloudText.textContent = message;
                
                if (status !== 'syncing') {
                    cloudIcon.classList.remove('sync-animation');
                }
                
                // æ›´æ–°ç”¨æˆ¶ä¿¡æ¯
                document.getElementById('deviceId').textContent = this.deviceId.substring(0, 12) + '...';
                document.getElementById('userInfo').classList.remove('hidden');
            }

            updateSyncStatus() {
                const indicator = document.getElementById('dataStatusIndicator');
                const statusText = document.getElementById('syncStatusText');
                const lastSyncElement = document.getElementById('lastSyncTime');
                
                if (this.isFirebaseReady && this.lastSyncTime) {
                    const now = new Date();
                    const diffMinutes = Math.floor((now - this.lastSyncTime) / 60000);
                    
                    if (diffMinutes < 5) {
                        indicator.className = 'w-2 h-2 bg-green-500 rounded-full mr-1 pulse-dot';
                        statusText.textContent = 'å·²åŒæ­¥';
                    } else if (diffMinutes < 60) {
                        indicator.className = 'w-2 h-2 bg-yellow-500 rounded-full mr-1';
                        statusText.textContent = 'éœ€åŒæ­¥';
                    } else {
                        indicator.className = 'w-2 h-2 bg-orange-500 rounded-full mr-1';
                        statusText.textContent = 'éæœŸ';
                    }
                    
                    lastSyncElement.textContent = this.lastSyncTime.toLocaleTimeString('zh-TW');
                } else {
                    indicator.className = 'w-2 h-2 bg-gray-500 rounded-full mr-1';
                    statusText.textContent = 'æœ¬åœ°';
                    lastSyncElement.textContent = 'å¾æœª';
                }
            }

            showConnectionBanner(message, details) {
                const banner = document.getElementById('connectionBanner');
                const messageElement = document.getElementById('connectionMessage');
                const detailsElement = document.getElementById('connectionDetails');
                
                messageElement.textContent = message;
                detailsElement.textContent = details;
                banner.classList.remove('hidden');
            }

            hideConnectionBanner() {
                document.getElementById('connectionBanner').classList.add('hidden');
            }

            generateChecksum(data) {
                const str = JSON.stringify(data);
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return hash.toString(16);
            }

            showSystemNotification(icon, message, className, duration = 3000) {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 ${className} p-4 rounded-lg shadow-lg z-50 max-w-sm`;
                notification.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <span class="text-xl">${icon}</span>
                        <div class="flex-1">
                            <div class="text-sm font-medium">${message}</div>
                            <div class="text-xs opacity-75 mt-1">${new Date().toLocaleTimeString('zh-TW')}</div>
                        </div>
                        <button class="text-lg opacity-50 hover:opacity-100" onclick="this.parentElement.parentElement.remove()">Ã—</button>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, duration);
            }

            initializeEventListeners() {
                // æœå°‹åŠŸèƒ½
                document.getElementById('searchBtn').addEventListener('click', () => this.search());
                document.getElementById('searchInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.search();
                });
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.showSearchSuggestions(e.target.value);
                });

                // åŒæ­¥åŠŸèƒ½
                document.getElementById('syncBtn').addEventListener('click', () => this.handleSyncClick());

                // åˆ†äº«åŠŸèƒ½
                document.getElementById('shareBtn').addEventListener('click', () => this.showShareModal());
                document.getElementById('closeShareModal').addEventListener('click', () => this.hideShareModal());
                document.getElementById('copyShareCode').addEventListener('click', () => this.copyShareCode());
                document.getElementById('accessSharedData').addEventListener('click', () => this.handleAccessSharedData());

                // å‚™ä»½åŠŸèƒ½
                document.getElementById('backupBtn').addEventListener('click', () => this.showBackupModal());
                document.getElementById('closeBackupModal').addEventListener('click', () => this.hideBackupModal());
                document.getElementById('downloadBackup').addEventListener('click', () => this.downloadBackup());
                document.getElementById('copyBackup').addEventListener('click', () => this.copyBackupToClipboard());
                document.getElementById('restoreBackup').addEventListener('click', () => this.triggerBackupRestore());
                document.getElementById('backupFileInput').addEventListener('change', (e) => this.handleBackupRestore(e));

                // è³‡æ–™ç®¡ç†
                document.getElementById('fileImportBtn').addEventListener('click', () => this.triggerFileImport());
                document.getElementById('textImportBtn').addEventListener('click', () => this.toggleManualInput());
                document.getElementById('processImport').addEventListener('click', () => this.processImportData());
                document.getElementById('fileInput').addEventListener('change', (e) => this.handleFileImport(e));

                // é€£æ¥æ©«å¹…
                document.getElementById('dismissBanner').addEventListener('click', () => this.hideConnectionBanner());

                // é»æ“Šå¤–éƒ¨éš±è—å»ºè­°
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#searchInput') && !e.target.closest('#searchSuggestions')) {
                        this.hideSearchSuggestions();
                    }
                });
            }

            async handleSyncClick() {
                if (!this.isFirebaseReady) {
                    this.showSystemNotification('âš ï¸', 'é›²ç«¯æœå‹™æœªå°±ç·’', 'bg-yellow-100 text-yellow-800');
                    return;
                }

                const syncIcon = document.getElementById('syncIcon');
                const syncText = document.getElementById('syncText');
                
                syncIcon.classList.add('sync-animation');
                syncText.textContent = 'åŒæ­¥ä¸­...';
                
                try {
                    await this.syncToCloud();
                    this.showSystemNotification('âœ…', 'è³‡æ–™åŒæ­¥æˆåŠŸ', 'bg-green-100 text-green-800');
                } catch (error) {
                    this.showSystemNotification('âŒ', 'åŒæ­¥å¤±æ•—: ' + error.message, 'bg-red-100 text-red-800');
                } finally {
                    setTimeout(() => {
                        syncIcon.classList.remove('sync-animation');
                        syncText.textContent = 'ç«‹å³åŒæ­¥';
                    }, 1000);
                }
            }

            showShareModal() {
                document.getElementById('shareCode').value = this.deviceId;
                document.getElementById('shareModal').classList.remove('hidden');
                document.getElementById('shareModal').classList.add('flex');
            }

            hideShareModal() {
                document.getElementById('shareModal').classList.add('hidden');
                document.getElementById('shareModal').classList.remove('flex');
                document.getElementById('shareStatus').classList.add('hidden');
            }

            async copyShareCode() {
                try {
                    await navigator.clipboard.writeText(this.deviceId);
                    this.showShareStatus('âœ…', 'åˆ†äº«ä»£ç¢¼å·²è¤‡è£½', 'bg-green-100 text-green-800');
                } catch (error) {
                    this.showShareStatus('âŒ', 'è¤‡è£½å¤±æ•—', 'bg-red-100 text-red-800');
                }
            }

            async handleAccessSharedData() {
                const shareCode = document.getElementById('accessCode').value.trim();
                if (!shareCode) {
                    this.showShareStatus('âš ï¸', 'è«‹è¼¸å…¥åˆ†äº«ä»£ç¢¼', 'bg-yellow-100 text-yellow-800');
                    return;
                }

                this.showShareStatus('â³', 'æ­£åœ¨å­˜å–åˆ†äº«è³‡æ–™...', 'bg-blue-100 text-blue-800');

                try {
                    const sharedData = await this.accessSharedData(shareCode);
                    
                    if (confirm('ç¢ºå®šè¦è¼‰å…¥åˆ†äº«çš„è³‡æ–™å—ï¼Ÿé€™å°‡è¦†è“‹ç¾æœ‰è³‡æ–™ã€‚')) {
                        this.data = sharedData;
                        this.saveLocalData();
                        await this.syncToCloud();
                        this.updateUI();
                        
                        this.showShareStatus('âœ…', 'åˆ†äº«è³‡æ–™è¼‰å…¥æˆåŠŸ', 'bg-green-100 text-green-800');
                        
                        setTimeout(() => {
                            this.hideShareModal();
                        }, 2000);
                    } else {
                        this.showShareStatus('â„¹ï¸', 'è¼‰å…¥å·²å–æ¶ˆ', 'bg-gray-100 text-gray-800');
                    }
                } catch (error) {
                    this.showShareStatus('âŒ', error.message, 'bg-red-100 text-red-800');
                }
            }

            showShareStatus(icon, text, className) {
                const statusDiv = document.getElementById('shareStatus');
                const statusIcon = document.getElementById('shareStatusIcon');
                const statusText = document.getElementById('shareStatusText');
                
                statusIcon.textContent = icon;
                statusText.textContent = text;
                statusDiv.className = `mt-4 p-3 rounded-lg text-sm ${className}`;
                statusDiv.classList.remove('hidden');
                
                if (icon === 'âœ…') {
                    setTimeout(() => {
                        statusDiv.classList.add('hidden');
                    }, 3000);
                }
            }

            // æœå°‹ç›¸é—œæ–¹æ³•
            search() {
                const query = document.getElementById('searchInput').value.trim();
                if (!query) return;

                const results = this.performSearch(query);
                this.displaySearchResults(query, results);
            }

            performSearch(query) {
                const results = {
                    herbResults: [],
                    symptomResults: []
                };

                const normalizedQuery = query.toLowerCase();

                // æœå°‹ä¸­è—¥
                Object.keys(this.data.herbs).forEach(herb => {
                    if (herb.toLowerCase().includes(normalizedQuery)) {
                        results.herbResults.push({
                            name: herb,
                            symptoms: this.data.herbs[herb],
                            score: 100
                        });
                    }
                });

                // æœå°‹ç—‡ç‹€
                Object.keys(this.data.symptoms).forEach(symptom => {
                    if (symptom.toLowerCase().includes(normalizedQuery)) {
                        results.symptomResults.push({
                            name: symptom,
                            herbs: this.data.symptoms[symptom],
                            score: 100
                        });
                    }
                });

                return results;
            }

            displaySearchResults(query, results) {
                const resultsSection = document.getElementById('resultsSection');
                const searchResults = document.getElementById('searchResults');
                
                resultsSection.classList.remove('hidden');
                searchResults.innerHTML = '';

                const totalResults = results.herbResults.length + results.symptomResults.length;

                if (totalResults === 0) {
                    searchResults.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <div class="text-4xl mb-4">ğŸ”</div>
                            <p class="text-lg">æœªæ‰¾åˆ°ç›¸é—œçµæœ</p>
                            <p class="text-sm mt-2">è«‹å˜—è©¦å…¶ä»–é—œéµå­—æˆ–æª¢æŸ¥æ‹¼å¯«</p>
                        </div>
                    `;
                    return;
                }

                // é¡¯ç¤ºä¸­è—¥çµæœ
                if (results.herbResults.length > 0) {
                    const herbSection = document.createElement('div');
                    herbSection.className = 'mb-8';
                    herbSection.innerHTML = `
                        <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                            <span class="mr-2">ğŸŒ¿</span>
                            <span>ä¸­è—¥</span>
                            <span class="ml-2 text-xs text-gray-500">(${results.herbResults.length})</span>
                        </h4>
                    `;

                    results.herbResults.forEach(herb => {
                        const herbCard = document.createElement('div');
                        herbCard.className = `bg-gradient-to-r from-green-50 to-green-25 border-l-4 border-green-500 p-4 rounded-lg mb-3`;
                        herbCard.innerHTML = `
                            <div class="flex justify-between items-start mb-3">
                                <h5 class="font-bold text-green-800 text-lg">${herb.name}</h5>
                                <div class="text-sm font-medium text-gray-700">${herb.score}%</div>
                            </div>
                            <div class="mb-2">
                                <div class="text-xs text-gray-600 mb-1">ä¸»æ²»ç—‡ç‹€ï¼š</div>
                                <div class="flex flex-wrap gap-1">
                                    ${herb.symptoms.map(symptom => 
                                        `<span class="px-2 py-1 text-xs rounded bg-green-100 text-green-800">${symptom}</span>`
                                    ).join('')}
                                </div>
                            </div>
                        `;
                        herbSection.appendChild(herbCard);
                    });

                    searchResults.appendChild(herbSection);
                }

                // é¡¯ç¤ºç—‡ç‹€çµæœ
                if (results.symptomResults.length > 0) {
                    const symptomSection = document.createElement('div');
                    symptomSection.className = 'mb-8';
                    symptomSection.innerHTML = `
                        <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                            <span class="mr-2">ğŸ©º</span>
                            <span>ç—‡ç‹€</span>
                            <span class="ml-2 text-xs text-gray-500">(${results.symptomResults.length})</span>
                        </h4>
                    `;

                    results.symptomResults.forEach(symptom => {
                        const symptomCard = document.createElement('div');
                        symptomCard.className = `bg-gradient-to-r from-blue-50 to-blue-25 border-l-4 border-blue-500 p-4 rounded-lg mb-3`;
                        symptomCard.innerHTML = `
                            <div class="flex justify-between items-start mb-3">
                                <h5 class="font-bold text-blue-800 text-lg">${symptom.name}</h5>
                                <div class="text-sm font-medium text-gray-700">${symptom.score}%</div>
                            </div>
                            <div class="mb-2">
                                <div class="text-xs text-gray-600 mb-1">ç›¸é—œä¸­è—¥ï¼š</div>
                                <div class="flex flex-wrap gap-1">
                                    ${symptom.herbs.map(herb => 
                                        `<span class="px-2 py-1 text-xs rounded bg-blue-100 text-blue-800">${herb}</span>`
                                    ).join('')}
                                </div>
                            </div>
                        `;
                        symptomSection.appendChild(symptomCard);
                    });

                    searchResults.appendChild(symptomSection);
                }
            }

            showSearchSuggestions(query) {
                const suggestionsDiv = document.getElementById('searchSuggestions');
                
                if (!query || query.length < 1) {
                    this.hideSearchSuggestions();
                    return;
                }

                const suggestions = this.generateSuggestions(query);
                
                if (suggestions.length === 0) {
                    this.hideSearchSuggestions();
                    return;
                }

                suggestionsDiv.innerHTML = '';
                suggestions.forEach(suggestion => {
                    const suggestionItem = document.createElement('div');
                    suggestionItem.className = 'px-4 py-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0 flex items-center justify-between';
                    suggestionItem.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <span class="text-lg">${suggestion.icon}</span>
                            <div>
                                <div class="font-medium text-gray-800">${suggestion.text}</div>
                                <div class="text-xs text-gray-500">${suggestion.type} â€¢ ${suggestion.count} å€‹ç›¸é—œé …ç›®</div>
                            </div>
                        </div>
                    `;
                    
                    suggestionItem.addEventListener('click', () => {
                        document.getElementById('searchInput').value = suggestion.text;
                        this.hideSearchSuggestions();
                        this.search();
                    });
                    
                    suggestionsDiv.appendChild(suggestionItem);
                });

                suggestionsDiv.classList.remove('hidden');
            }

            generateSuggestions(query) {
                const suggestions = [];
                const normalizedQuery = query.toLowerCase();

                // å¾ä¸­è—¥ç²å–å»ºè­°
                Object.keys(this.data.herbs).forEach(herb => {
                    if (herb.toLowerCase().includes(normalizedQuery)) {
                        suggestions.push({
                            text: herb,
                            type: 'ä¸­è—¥',
                            icon: 'ğŸŒ¿',
                            count: this.data.herbs[herb].length,
                            category: 'herb'
                        });
                    }
                });

                // å¾ç—‡ç‹€ç²å–å»ºè­°
                Object.keys(this.data.symptoms).forEach(symptom => {
                    if (symptom.toLowerCase().includes(normalizedQuery)) {
                        suggestions.push({
                            text: symptom,
                            type: 'ç—‡ç‹€',
                            icon: 'ğŸ©º',
                            count: this.data.symptoms[symptom].length,
                            category: 'symptom'
                        });
                    }
                });

                return suggestions.slice(0, 8);
            }

            hideSearchSuggestions() {
                document.getElementById('searchSuggestions').classList.add('hidden');
            }

            // è³‡æ–™ç®¡ç†æ–¹æ³•
            triggerFileImport() {
                document.getElementById('fileInput').click();
            }

            toggleManualInput() {
                const manualSection = document.getElementById('manualInputSection');
                const isHidden = manualSection.classList.contains('hidden');
                
                if (isHidden) {
                    manualSection.classList.remove('hidden');
                    document.getElementById('textImportBtn').textContent = 'âœï¸ éš±è—è¼¸å…¥';
                } else {
                    manualSection.classList.add('hidden');
                    document.getElementById('textImportBtn').innerHTML = 'âœï¸ æ‰‹å‹•è¼¸å…¥';
                }
            }

            async processImportData() {
                const importText = document.getElementById('importData').value.trim();
                if (!importText) {
                    this.showImportStatus('âš ï¸', 'è«‹è¼¸å…¥è¦å°å…¥çš„è³‡æ–™', 'bg-yellow-100 text-yellow-800');
                    return;
                }

                this.showImportStatus('â³', 'æ­£åœ¨è™•ç†è³‡æ–™...', 'bg-blue-100 text-blue-800');

                const lines = importText.split('\n').filter(line => line.trim());
                let successCount = 0;

                lines.forEach(line => {
                    const parts = line.split('ï¼š');
                    if (parts.length === 2) {
                        const herb = parts[0].trim();
                        const symptoms = parts[1].split(',').map(s => s.trim()).filter(s => s);
                        
                        if (herb && symptoms.length > 0) {
                            this.addHerbData(herb, symptoms);
                            successCount++;
                        }
                    }
                });

                this.saveLocalData();
                this.updateUI();
                document.getElementById('importData').value = '';
                
                this.showImportStatus('âœ…', `æˆåŠŸå°å…¥ ${successCount} æ¢ä¸­è—¥è³‡æ–™`, 'bg-green-100 text-green-800');
                
                // è‡ªå‹•åŒæ­¥åˆ°é›²ç«¯
                if (this.isFirebaseReady) {
                    try {
                        await this.syncToCloud();
                    } catch (error) {
                        console.error('è‡ªå‹•åŒæ­¥å¤±æ•—:', error);
                    }
                }
                
                setTimeout(() => {
                    document.getElementById('manualInputSection').classList.add('hidden');
                    document.getElementById('textImportBtn').innerHTML = 'âœï¸ æ‰‹å‹•è¼¸å…¥';
                    document.getElementById('importStatus').classList.add('hidden');
                }, 2000);
            }

            addHerbData(herb, symptoms) {
                if (!this.data.herbs[herb]) {
                    this.data.herbs[herb] = [];
                }
                
                symptoms.forEach(symptom => {
                    if (!this.data.herbs[herb].includes(symptom)) {
                        this.data.herbs[herb].push(symptom);
                    }
                    
                    if (!this.data.symptoms[symptom]) {
                        this.data.symptoms[symptom] = [];
                    }
                    if (!this.data.symptoms[symptom].includes(herb)) {
                        this.data.symptoms[symptom].push(herb);
                    }
                });
            }

            handleFileImport(event) {
                const file = event.target.files[0];
                if (!file) return;

                this.showImportStatus('â³', 'æ­£åœ¨è™•ç†æª”æ¡ˆ...', 'bg-blue-100 text-blue-800');

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const content = e.target.result;
                        let successCount = 0;
                        
                        if (file.name.endsWith('.json')) {
                            const importedData = JSON.parse(content);
                            if (importedData.data) {
                                this.data = importedData.data;
                                successCount = Object.keys(importedData.data.herbs || {}).length;
                            } else {
                                this.data = importedData;
                                successCount = Object.keys(importedData.herbs || {}).length;
                            }
                        } else {
                            const lines = content.split('\n').filter(line => line.trim());
                            lines.forEach(line => {
                                const parts = line.split('ï¼š');
                                if (parts.length === 2) {
                                    const herb = parts[0].trim();
                                    const symptoms = parts[1].split(',').map(s => s.trim()).filter(s => s);
                                    
                                    if (herb && symptoms.length > 0) {
                                        this.addHerbData(herb, symptoms);
                                        successCount++;
                                    }
                                }
                            });
                        }
                        
                        this.saveLocalData();
                        this.updateUI();
                        this.showImportStatus('âœ…', `æˆåŠŸå°å…¥ ${successCount} æ¢è³‡æ–™`, 'bg-green-100 text-green-800');
                        
                        // è‡ªå‹•åŒæ­¥åˆ°é›²ç«¯
                        if (this.isFirebaseReady) {
                            try {
                                await this.syncToCloud();
                            } catch (error) {
                                console.error('è‡ªå‹•åŒæ­¥å¤±æ•—:', error);
                            }
                        }
                        
                        setTimeout(() => {
                            document.getElementById('importStatus').classList.add('hidden');
                        }, 3000);
                        
                    } catch (error) {
                        this.showImportStatus('âŒ', 'æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆå…§å®¹', 'bg-red-100 text-red-800');
                    }
                };
                reader.readAsText(file);
                
                event.target.value = '';
            }

            showImportStatus(icon, text, className) {
                const statusDiv = document.getElementById('importStatus');
                const statusIcon = document.getElementById('statusIcon');
                const statusText = document.getElementById('statusText');
                
                statusIcon.textContent = icon;
                statusText.textContent = text;
                statusDiv.className = `p-3 rounded-lg ${className}`;
                statusDiv.classList.remove('hidden');
            }

            // å‚™ä»½ç›¸é—œæ–¹æ³•
            showBackupModal() {
                const herbCount = Object.keys(this.data.herbs).length;
                const symptomCount = Object.keys(this.data.symptoms).length;
                const cloudStatus = this.isFirebaseReady ? 'å·²é€£æ¥' : 'æœªé€£æ¥';
                
                document.getElementById('backupHerbCount').textContent = herbCount;
                document.getElementById('backupSymptomCount').textContent = symptomCount;
                document.getElementById('cloudSyncStatus').textContent = cloudStatus;
                
                document.getElementById('backupModal').classList.remove('hidden');
                document.getElementById('backupModal').classList.add('flex');
            }

            hideBackupModal() {
                document.getElementById('backupModal').classList.add('hidden');
                document.getElementById('backupModal').classList.remove('flex');
                document.getElementById('backupStatus').classList.add('hidden');
            }

            downloadBackup() {
                try {
                    const backupData = this.createBackupData();
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
                    const filename = `TCM_CloudBackup_${timestamp}.json`;
                    
                    const blob = new Blob([JSON.stringify(backupData, null, 2)], { 
                        type: 'application/json' 
                    });
                    
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    link.click();
                    
                    URL.revokeObjectURL(url);
                    
                    this.showBackupStatus('âœ…', 'å‚™ä»½æª”æ¡ˆå·²ä¸‹è¼‰å®Œæˆï¼', 'bg-green-100 text-green-800');
                } catch (error) {
                    this.showBackupStatus('âŒ', 'ä¸‹è¼‰å¤±æ•—ï¼Œè«‹é‡è©¦', 'bg-red-100 text-red-800');
                }
            }

            async copyBackupToClipboard() {
                try {
                    const backupData = this.createBackupData();
                    const backupText = JSON.stringify(backupData, null, 2);
                    
                    await navigator.clipboard.writeText(backupText);
                    this.showBackupStatus('âœ…', 'å‚™ä»½è³‡æ–™å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', 'bg-green-100 text-green-800');
                } catch (error) {
                    const textArea = document.createElement('textarea');
                    textArea.value = JSON.stringify(this.createBackupData(), null, 2);
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    this.showBackupStatus('âœ…', 'å‚™ä»½è³‡æ–™å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', 'bg-green-100 text-green-800');
                }
            }

            triggerBackupRestore() {
                document.getElementById('backupFileInput').click();
            }

            async handleBackupRestore(event) {
                const file = event.target.files[0];
                if (!file) return;

                this.showBackupStatus('â³', 'æ­£åœ¨æ¢å¾©å‚™ä»½...', 'bg-blue-100 text-blue-800');

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        if (this.validateBackupData(backupData)) {
                            if (confirm('ç¢ºå®šè¦æ¢å¾©æ­¤å‚™ä»½å—ï¼Ÿé€™å°‡è¦†è“‹ç¾æœ‰çš„æ‰€æœ‰è³‡æ–™ã€‚')) {
                                this.restoreFromBackup(backupData);
                                
                                // åŒæ­¥åˆ°é›²ç«¯
                                if (this.isFirebaseReady) {
                                    try {
                                        await this.syncToCloud();
                                    } catch (error) {
                                        console.error('æ¢å¾©å¾ŒåŒæ­¥å¤±æ•—:', error);
                                    }
                                }
                                
                                this.showBackupStatus('âœ…', 'å‚™ä»½æ¢å¾©æˆåŠŸï¼', 'bg-green-100 text-green-800');
                                
                                setTimeout(() => {
                                    this.hideBackupModal();
                                    this.updateUI();
                                }, 1500);
                            } else {
                                this.showBackupStatus('â„¹ï¸', 'æ¢å¾©å·²å–æ¶ˆ', 'bg-gray-100 text-gray-800');
                            }
                        } else {
                            this.showBackupStatus('âŒ', 'å‚™ä»½æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º', 'bg-red-100 text-red-800');
                        }
                    } catch (error) {
                        this.showBackupStatus('âŒ', 'å‚™ä»½æª”æ¡ˆæå£æˆ–æ ¼å¼éŒ¯èª¤', 'bg-red-100 text-red-800');
                    }
                };
                
                reader.readAsText(file);
                event.target.value = '';
            }

            createBackupData() {
                return {
                    version: this.currentVersion,
                    appName: 'ä¸­é†«è¨ºç—‡è¼”åŠ©å·¥å…· - é›²ç«¯åŒæ­¥ç‰ˆ',
                    backupDate: new Date().toISOString(),
                    backupTime: new Date().toLocaleString('zh-TW'),
                    deviceId: this.deviceId,
                    cloudSync: this.isFirebaseReady,
                    statistics: {
                        herbCount: Object.keys(this.data.herbs).length,
                        symptomCount: Object.keys(this.data.symptoms).length,
                        totalRelations: Object.values(this.data.herbs).reduce((sum, symptoms) => sum + symptoms.length, 0)
                    },
                    data: {
                        herbs: this.data.herbs,
                        symptoms: this.data.symptoms
                    },
                    checksum: this.generateChecksum(this.data)
                };
            }

            validateBackupData(backupData) {
                if (!backupData.data || !backupData.data.herbs || !backupData.data.symptoms) {
                    return false;
                }
                
                if (typeof backupData.data.herbs !== 'object' || typeof backupData.data.symptoms !== 'object') {
                    return false;
                }
                
                if (backupData.checksum) {
                    const calculatedChecksum = this.generateChecksum(backupData.data);
                    if (calculatedChecksum !== backupData.checksum) {
                        console.warn('Backup checksum mismatch - data may be corrupted');
                    }
                }
                
                return true;
            }

            restoreFromBackup(backupData) {
                this.data = {
                    herbs: backupData.data.herbs,
                    symptoms: backupData.data.symptoms
                };
                
                this.saveLocalData();
                
                document.getElementById('resultsSection').classList.add('hidden');
                document.getElementById('searchInput').value = '';
            }

            showBackupStatus(icon, text, className) {
                const statusDiv = document.getElementById('backupStatus');
                const statusIcon = document.getElementById('backupStatusIcon');
                const statusText = document.getElementById('backupStatusText');
                
                statusIcon.textContent = icon;
                statusText.textContent = text;
                statusDiv.className = `mt-4 p-3 rounded-lg text-sm ${className}`;
                statusDiv.classList.remove('hidden');
                
                if (icon === 'âœ…') {
                    setTimeout(() => {
                        statusDiv.classList.add('hidden');
                    }, 3000);
                }
            }

            updateUI() {
                const herbCount = Object.keys(this.data.herbs).length;
                const symptomCount = Object.keys(this.data.symptoms).length;
                
                document.getElementById('herbCount').textContent = herbCount;
                document.getElementById('symptomCount').textContent = symptomCount;
                
                this.updateSyncStatus();
            }
        }

        // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
        document.addEventListener('DOMContentLoaded', () => {
            new CloudTCMTool();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9652d95cf50184ab',t:'MTc1MzUyMTkxOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
