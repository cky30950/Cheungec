<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­é†«è¨ºç—‡è¼”åŠ©å·¥å…· - ç·šä¸Šå…±äº«ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .search-highlight {
            background: linear-gradient(120deg, #fbbf24 0%, #f59e0b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .sync-animation {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .pulse-dot {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="max-w-4xl mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <h1 class="text-xl font-bold text-gray-800">ä¸­è—¥è³‡æ–™åº« - ç·šä¸Šå…±äº«ç‰ˆ</h1>
                <div class="flex items-center space-x-3">
                    <button id="syncBtn" class="px-3 py-1.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm flex items-center space-x-1">
                        <span id="syncIcon">â˜ï¸</span>
                        <span id="syncText">ç·šä¸ŠåŒæ­¥</span>
                    </button>
                    <button id="onlineDataBtn" class="px-3 py-1.5 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors text-sm">
                        ğŸŒ ç·šä¸Šè³‡æ–™
                    </button>
                    <button id="backupBtn" class="px-3 py-1.5 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors text-sm">
                        ğŸ’¾ å‚™ä»½
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-4xl mx-auto px-4 py-6">
        <!-- Search Section -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="relative">
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="æœå°‹ç—‡ç‹€æˆ–ä¸­è—¥..." 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                    autocomplete="off"
                >
                <button id="searchBtn" class="absolute right-2 top-2 px-4 py-1.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm">
                    æœå°‹
                </button>
                <div id="searchSuggestions" class="absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-lg shadow-lg mt-1 hidden z-10 max-h-64 overflow-y-auto"></div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="bg-white rounded-lg shadow-sm p-6 mb-6 hidden">
            <div id="searchResults" class="space-y-4"></div>
        </div>

        <!-- Data Management Section -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex flex-wrap gap-3 mb-4">
                <button id="fileImportBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm">
                    ğŸ“ å°å…¥æª”æ¡ˆ
                </button>
                <button id="textImportBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors text-sm">
                    âœï¸ æ‰‹å‹•è¼¸å…¥
                </button>

                <div class="ml-auto flex items-center space-x-4 text-sm text-gray-600">
                    <span>ä¸­è—¥: <span id="herbCount" class="font-medium">0</span></span>
                    <span>ç—‡ç‹€: <span id="symptomCount" class="font-medium">0</span></span>
                    <span class="flex items-center">
                        <span id="dataStatusIndicator" class="w-2 h-2 bg-green-500 rounded-full mr-1 pulse-dot" title="è³‡æ–™ç‹€æ…‹æ­£å¸¸"></span>
                        <span id="syncStatusText" class="text-xs">æœ¬åœ°</span>
                    </span>
                </div>
            </div>
            
            <!-- Manual Input Section -->
            <div id="manualInputSection" class="hidden">
                <textarea 
                    id="importData" 
                    rows="6" 
                    placeholder="æ ¼å¼ï¼šä¸­è—¥åï¼šç—‡ç‹€1,ç—‡ç‹€2,ç—‡ç‹€3&#10;ç¯„ä¾‹ï¼šç•¶æ­¸ï¼šè¡€è™›,æœˆç¶“ä¸èª¿,ä¾¿ç§˜"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:border-blue-500 focus:outline-none resize-none text-sm mb-3"
                ></textarea>
                <button id="processImport" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm">
                    å°å…¥è³‡æ–™
                </button>
            </div>
            
            <!-- File Import Status -->
            <div id="importStatus" class="hidden p-3 rounded-md">
                <div class="flex items-center space-x-2">
                    <span id="statusIcon">âœ…</span>
                    <span id="statusText" class="text-sm"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Online Data Management Modal -->
    <div id="onlineDataModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    ğŸŒ ç·šä¸Šè³‡æ–™å…±äº«ä¸­å¿ƒ
                </h3>
                <button id="closeOnlineDataModal" class="text-gray-400 hover:text-gray-600 text-xl">Ã—</button>
            </div>
            
            <!-- Connection Status -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div id="connectionIndicator" class="w-3 h-3 bg-green-500 rounded-full pulse-dot"></div>
                        <div>
                            <div id="connectionStatus" class="text-sm text-green-600 font-medium">å·²é€£ç·š</div>
                            <div class="text-xs text-gray-500">ä¼ºæœå™¨ç‹€æ…‹: <span id="serverStatus">æ­£å¸¸</span></div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-gray-500">æœ€å¾ŒåŒæ­¥</div>
                        <div id="lastSyncTime" class="text-sm font-medium">å¾æœªåŒæ­¥</div>
                    </div>
                </div>
            </div>
            
            <!-- Data Comparison -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Local Data -->
                <div class="bg-blue-50 rounded-lg p-4">
                    <h4 class="font-semibold text-blue-800 mb-3 flex items-center">
                        <span class="mr-2">ğŸ’»</span>
                        æœ¬åœ°è³‡æ–™
                    </h4>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">ä¸­è—¥æ•¸é‡</span>
                            <span id="localHerbCount" class="text-sm font-medium">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">ç—‡ç‹€æ•¸é‡</span>
                            <span id="localSymptomCount" class="text-sm font-medium">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">æœ€å¾Œæ›´æ–°</span>
                            <span id="localLastUpdate" class="text-sm text-gray-500">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Online Data -->
                <div class="bg-green-50 rounded-lg p-4">
                    <h4 class="font-semibold text-green-800 mb-3 flex items-center">
                        <span class="mr-2">â˜ï¸</span>
                        ç·šä¸Šè³‡æ–™
                        <span class="ml-2 text-xs bg-green-200 text-green-800 px-2 py-1 rounded">v<span id="onlineDataVersion">1.0</span></span>
                    </h4>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">ä¸­è—¥æ•¸é‡</span>
                            <span id="onlineHerbCount" class="text-sm font-medium">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">ç—‡ç‹€æ•¸é‡</span>
                            <span id="onlineSymptomCount" class="text-sm font-medium">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">æœ€å¾Œæ›´æ–°</span>
                            <span id="onlineLastUpdate" class="text-sm text-gray-500">-</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sync Actions -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <button id="uploadDataBtn" class="px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center space-x-2">
                    <span>ğŸ“¤</span>
                    <span>ä¸Šå‚³æœ¬åœ°è³‡æ–™</span>
                </button>
                
                <button id="downloadDataBtn" class="px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center space-x-2">
                    <span>ğŸ“¥</span>
                    <span>ä¸‹è¼‰ç·šä¸Šè³‡æ–™</span>
                </button>
                
                <button id="mergeDataBtn" class="px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center justify-center space-x-2">
                    <span>ğŸ”„</span>
                    <span>æ™ºèƒ½åˆä½µ</span>
                </button>
            </div>
            
            <!-- Sync Settings -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <h4 class="font-semibold text-gray-800 mb-3">åŒæ­¥è¨­å®š</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">è‡ªå‹•åŒæ­¥</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="autoSyncEnabled" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">è¡çªè‡ªå‹•è™•ç†</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="conflictResolution" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">åŒæ­¥é–“éš”</span>
                        <select id="syncInterval" class="text-sm border border-gray-300 rounded px-2 py-1">
                            <option value="300">5åˆ†é˜</option>
                            <option value="600">10åˆ†é˜</option>
                            <option value="1800">30åˆ†é˜</option>
                            <option value="3600">1å°æ™‚</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Recent Activity -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-semibold text-gray-800 mb-3">æœ€è¿‘æ´»å‹•</h4>
                <div id="recentActivityList" class="space-y-2 max-h-32 overflow-y-auto">
                    <!-- Activity items will be inserted here -->
                </div>
            </div>
            
            <!-- Status Message -->
            <div id="onlineDataStatus" class="hidden mt-4 p-3 rounded-lg text-sm">
                <div class="flex items-center space-x-2">
                    <span id="onlineDataStatusIcon">âœ…</span>
                    <span id="onlineDataStatusText"></span>
                </div>
            </div>
        </div>
    </div>



    <!-- Backup Modal -->
    <div id="backupModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    ğŸ’¾ è³‡æ–™å‚™ä»½
                </h3>
                <button id="closeBackupModal" class="text-gray-400 hover:text-gray-600 text-xl">Ã—</button>
            </div>
            
            <!-- Backup Info -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600" id="backupHerbCount">0</div>
                        <div class="text-gray-600">ä¸­è—¥</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600" id="backupSymptomCount">0</div>
                        <div class="text-gray-600">ç—‡ç‹€</div>
                    </div>
                </div>
                <div class="text-center mt-3 text-xs text-gray-500">
                    æœ€å¾Œæ›´æ–°ï¼š<span id="lastUpdateTime">-</span>
                </div>
            </div>
            
            <!-- Backup Options -->
            <div class="space-y-3">
                <button id="downloadBackup" class="w-full px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center justify-center space-x-2">
                    <span>ğŸ“¥</span>
                    <span>ä¸‹è¼‰å‚™ä»½æª”æ¡ˆ</span>
                </button>
                
                <button id="copyBackup" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center space-x-2">
                    <span>ğŸ“‹</span>
                    <span>è¤‡è£½åˆ°å‰ªè²¼ç°¿</span>
                </button>
                
                <div class="border-t pt-3">
                    <div class="text-sm text-gray-600 mb-2">æˆ–è€…æ¢å¾©å‚™ä»½ï¼š</div>
                    <button id="restoreBackup" class="w-full px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors flex items-center justify-center space-x-2">
                        <span>ğŸ“¤</span>
                        <span>é¸æ“‡å‚™ä»½æª”æ¡ˆæ¢å¾©</span>
                    </button>
                </div>
            </div>
            
            <!-- Status Message -->
            <div id="backupStatus" class="hidden mt-4 p-3 rounded-lg text-sm">
                <div class="flex items-center space-x-2">
                    <span id="backupStatusIcon">âœ…</span>
                    <span id="backupStatusText"></span>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".txt,.json" class="hidden">
    <input type="file" id="backupFileInput" accept=".json" class="hidden">

    <script>
        class TCMDiagnosticTool {
            constructor() {
                this.storageKey = 'tcmData_v3';
                this.backupKey = 'tcmDataBackup_v3';
                this.onlineDataKey = 'tcmOnlineData_v3';
                this.lastSyncKey = 'tcmLastSync_v3';
                this.syncSettingsKey = 'tcmSyncSettings_v3';
                this.versionKey = 'tcmDataVersion';
                this.currentVersion = '3.0';
                
                // ç·šä¸ŠåŒæ­¥ç›¸é—œè¨­å®š
                this.isOnline = true; // æ¨¡æ“¬ç·šä¸Šç‹€æ…‹
                this.syncSettings = this.loadSyncSettings();
                this.autoSyncTimer = null;
                
                // åˆå§‹åŒ–è³‡æ–™æŒä¹…åŒ–ç³»çµ±
                this.initializeDataPersistence();
                
                this.data = this.loadDataWithBackup() || {
                    herbs: {}, // ä¸­è—¥ -> [ç—‡ç‹€]
                    symptoms: {} // ç—‡ç‹€ -> [ä¸­è—¥]
                };
                
                this.initializeEventListeners();
                this.updateUI();
                this.startAutoBackup();
                this.initializeOnlineSync();
            }

            // è¼‰å…¥åŒæ­¥è¨­å®š
            loadSyncSettings() {
                try {
                    const settings = localStorage.getItem(this.syncSettingsKey);
                    return settings ? JSON.parse(settings) : {
                        autoSync: false,
                        conflictResolution: true,
                        syncInterval: 1800 // 30åˆ†é˜
                    };
                } catch (error) {
                    return {
                        autoSync: false,
                        conflictResolution: true,
                        syncInterval: 1800
                    };
                }
            }

            // ä¿å­˜åŒæ­¥è¨­å®š
            saveSyncSettings() {
                localStorage.setItem(this.syncSettingsKey, JSON.stringify(this.syncSettings));
            }

            // åˆå§‹åŒ–ç·šä¸ŠåŒæ­¥åŠŸèƒ½
            initializeOnlineSync() {
                // æª¢æŸ¥æ˜¯å¦éœ€è¦è‡ªå‹•åŒæ­¥
                if (this.syncSettings.autoSync && this.isOnline) {
                    this.startAutoSync();
                }
                
                // æ¨¡æ“¬ç·šä¸Šç‹€æ…‹æª¢æŸ¥
                this.checkOnlineStatus();
                
                // å®šæœŸæª¢æŸ¥ç·šä¸Šç‹€æ…‹
                setInterval(() => {
                    this.checkOnlineStatus();
                }, 30000); // æ¯30ç§’æª¢æŸ¥ä¸€æ¬¡
            }

            // æª¢æŸ¥ç·šä¸Šç‹€æ…‹
            checkOnlineStatus() {
                // æ¨¡æ“¬ç·šä¸Šç‹€æ…‹æª¢æŸ¥
                this.isOnline = navigator.onLine;
                this.updateSyncStatus();
            }

            // æ›´æ–°åŒæ­¥ç‹€æ…‹é¡¯ç¤º
            updateSyncStatus() {
                const indicator = document.getElementById('dataStatusIndicator');
                const statusText = document.getElementById('syncStatusText');
                
                if (this.isOnline) {
                    const lastSync = localStorage.getItem(this.lastSyncKey);
                    if (lastSync) {
                        const syncTime = new Date(lastSync);
                        const now = new Date();
                        const diffMinutes = Math.floor((now - syncTime) / 60000);
                        
                        if (diffMinutes < 5) {
                            indicator.className = 'w-2 h-2 bg-green-500 rounded-full mr-1 pulse-dot';
                            statusText.textContent = 'å·²åŒæ­¥';
                        } else if (diffMinutes < 60) {
                            indicator.className = 'w-2 h-2 bg-yellow-500 rounded-full mr-1';
                            statusText.textContent = 'éœ€åŒæ­¥';
                        } else {
                            indicator.className = 'w-2 h-2 bg-orange-500 rounded-full mr-1';
                            statusText.textContent = 'éæœŸ';
                        }
                    } else {
                        indicator.className = 'w-2 h-2 bg-blue-500 rounded-full mr-1';
                        statusText.textContent = 'ç·šä¸Š';
                    }
                } else {
                    indicator.className = 'w-2 h-2 bg-gray-500 rounded-full mr-1';
                    statusText.textContent = 'é›¢ç·š';
                }
            }

            // é–‹å§‹è‡ªå‹•åŒæ­¥
            startAutoSync() {
                this.stopAutoSync(); // å…ˆåœæ­¢ç¾æœ‰çš„å®šæ™‚å™¨
                
                if (this.syncSettings.autoSync && this.isOnline) {
                    this.autoSyncTimer = setInterval(() => {
                        this.performQuickSync();
                    }, this.syncSettings.syncInterval * 1000);
                }
            }

            // åœæ­¢è‡ªå‹•åŒæ­¥
            stopAutoSync() {
                if (this.autoSyncTimer) {
                    clearInterval(this.autoSyncTimer);
                    this.autoSyncTimer = null;
                }
            }

            // æ¨¡æ“¬ç·šä¸Šè³‡æ–™å­˜å–
            getOnlineData() {
                try {
                    const onlineData = localStorage.getItem(this.onlineDataKey);
                    return onlineData ? JSON.parse(onlineData) : null;
                } catch (error) {
                    console.error('ç²å–ç·šä¸Šè³‡æ–™å¤±æ•—:', error);
                    return null;
                }
            }

            saveOnlineData(data) {
                try {
                    const onlineData = {
                        data: data,
                        timestamp: new Date().toISOString(),
                        version: this.currentVersion,
                        checksum: this.generateChecksum(data)
                    };
                    
                    localStorage.setItem(this.onlineDataKey, JSON.stringify(onlineData));
                    localStorage.setItem(this.lastSyncKey, new Date().toISOString());
                    
                    this.addSyncActivity('ä¸Šå‚³', 'æœ¬åœ°è³‡æ–™å·²ä¸Šå‚³åˆ°ç·šä¸Š');
                    this.updateSyncStatus();
                    
                    return true;
                } catch (error) {
                    console.error('ä¿å­˜ç·šä¸Šè³‡æ–™å¤±æ•—:', error);
                    return false;
                }
            }

            // æª¢æŸ¥æ˜¯å¦éœ€è¦åŒæ­¥
            needsSync(localData, onlineData) {
                if (!onlineData || !onlineData.data) return true;
                
                const localChecksum = this.generateChecksum(localData);
                const onlineChecksum = onlineData.checksum || this.generateChecksum(onlineData.data);
                
                return localChecksum !== onlineChecksum;
            }

            // æ·»åŠ åŒæ­¥æ´»å‹•è¨˜éŒ„
            addSyncActivity(action, description) {
                try {
                    const activities = JSON.parse(localStorage.getItem('tcmSyncActivities') || '[]');
                    
                    activities.unshift({
                        action: action,
                        description: description,
                        timestamp: new Date().toISOString()
                    });
                    
                    // ä¿æŒæœ€å¤š50æ¢è¨˜éŒ„
                    if (activities.length > 50) {
                        activities.splice(50);
                    }
                    
                    localStorage.setItem('tcmSyncActivities', JSON.stringify(activities));
                } catch (error) {
                    console.error('æ·»åŠ æ´»å‹•è¨˜éŒ„å¤±æ•—:', error);
                }
            }

            // è³‡æ–™æŒä¹…åŒ–ç³»çµ±åˆå§‹åŒ–
            initializeDataPersistence() {
                // æª¢æŸ¥ç‰ˆæœ¬ä¸¦è™•ç†è³‡æ–™é·ç§»
                const storedVersion = localStorage.getItem(this.versionKey);
                if (storedVersion !== this.currentVersion) {
                    this.migrateData(storedVersion);
                    localStorage.setItem(this.versionKey, this.currentVersion);
                }
                
                // è¨­ç½®é é¢é—œé–‰å‰çš„è³‡æ–™ä¿å­˜
                window.addEventListener('beforeunload', () => {
                    this.emergencySave();
                });
                
                // è¨­ç½®é é¢å¯è¦‹æ€§è®ŠåŒ–æ™‚çš„è³‡æ–™ä¿å­˜
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        this.emergencySave();
                    }
                });
                
                // è¨­ç½®å®šæœŸè³‡æ–™å®Œæ•´æ€§æª¢æŸ¥
                setInterval(() => {
                    this.verifyDataIntegrity();
                }, 30000); // æ¯30ç§’æª¢æŸ¥ä¸€æ¬¡
            }

            // è¼‰å…¥è³‡æ–™ä¸¦æä¾›å‚™ä»½æ¢å¾©æ©Ÿåˆ¶
            loadDataWithBackup() {
                try {
                    // å˜—è©¦è¼‰å…¥ä¸»è¦è³‡æ–™
                    const mainData = localStorage.getItem(this.storageKey);
                    if (mainData) {
                        const parsedData = JSON.parse(mainData);
                        if (this.validateDataStructure(parsedData)) {
                            // å‰µå»ºå‚™ä»½
                            this.createLocalBackup(parsedData);
                            return parsedData;
                        }
                    }
                    
                    // ä¸»è¦è³‡æ–™ç„¡æ•ˆï¼Œå˜—è©¦è¼‰å…¥å‚™ä»½
                    console.warn('ä¸»è¦è³‡æ–™ç„¡æ•ˆï¼Œå˜—è©¦è¼‰å…¥å‚™ä»½...');
                    const backupData = localStorage.getItem(this.backupKey);
                    if (backupData) {
                        const parsedBackup = JSON.parse(backupData);
                        if (parsedBackup.data && this.validateDataStructure(parsedBackup.data)) {
                            // æ¢å¾©ä¸»è¦è³‡æ–™
                            localStorage.setItem(this.storageKey, JSON.stringify(parsedBackup.data));
                            this.showDataRecoveryNotification();
                            return parsedBackup.data;
                        }
                    }
                    
                } catch (error) {
                    console.error('è³‡æ–™è¼‰å…¥å¤±æ•—:', error);
                    this.showDataErrorNotification();
                }
                
                return null;
            }

            // é©—è­‰è³‡æ–™çµæ§‹å®Œæ•´æ€§
            validateDataStructure(data) {
                if (!data || typeof data !== 'object') return false;
                if (!data.herbs || typeof data.herbs !== 'object') return false;
                if (!data.symptoms || typeof data.symptoms !== 'object') return false;
                
                // æª¢æŸ¥è³‡æ–™ä¸€è‡´æ€§
                for (const [herb, symptoms] of Object.entries(data.herbs)) {
                    if (!Array.isArray(symptoms)) return false;
                    for (const symptom of symptoms) {
                        if (!data.symptoms[symptom] || !data.symptoms[symptom].includes(herb)) {
                            console.warn(`è³‡æ–™ä¸ä¸€è‡´: ${herb} -> ${symptom}`);
                        }
                    }
                }
                
                return true;
            }

            // å®‰å…¨ä¿å­˜è³‡æ–™
            saveDataSecurely(data = this.data) {
                try {
                    const dataString = JSON.stringify(data);
                    const timestamp = new Date().toISOString();
                    
                    // ä¿å­˜ä¸»è¦è³‡æ–™
                    localStorage.setItem(this.storageKey, dataString);
                    
                    // å‰µå»ºå‚™ä»½
                    this.createLocalBackup(data);
                    
                    // æ›´æ–°æ™‚é–“æˆ³
                    localStorage.setItem('tcmLastUpdate', new Date().toLocaleString('zh-TW'));
                    localStorage.setItem('tcmLastSave', timestamp);
                    
                    // é©—è­‰ä¿å­˜æ˜¯å¦æˆåŠŸ
                    const verification = localStorage.getItem(this.storageKey);
                    if (verification !== dataString) {
                        throw new Error('è³‡æ–™ä¿å­˜é©—è­‰å¤±æ•—');
                    }
                    
                    return true;
                } catch (error) {
                    console.error('è³‡æ–™ä¿å­˜å¤±æ•—:', error);
                    this.handleSaveError(error);
                    return false;
                }
            }

            // å‰µå»ºæœ¬åœ°å‚™ä»½
            createLocalBackup(data) {
                try {
                    const backupData = {
                        data: data,
                        timestamp: new Date().toISOString(),
                        version: this.currentVersion,
                        checksum: this.generateChecksum(data)
                    };
                    
                    localStorage.setItem(this.backupKey, JSON.stringify(backupData));
                    
                    // ä¿æŒå¤šå€‹å‚™ä»½ç‰ˆæœ¬
                    this.maintainBackupHistory(backupData);
                } catch (error) {
                    console.error('å‚™ä»½å‰µå»ºå¤±æ•—:', error);
                }
            }

            // ç¶­è­·å‚™ä»½æ­·å²
            maintainBackupHistory(currentBackup) {
                try {
                    const historyKey = 'tcmBackupHistory';
                    let history = JSON.parse(localStorage.getItem(historyKey) || '[]');
                    
                    // æ·»åŠ ç•¶å‰å‚™ä»½
                    history.unshift(currentBackup);
                    
                    // ä¿æŒæœ€å¤š5å€‹å‚™ä»½
                    history = history.slice(0, 5);
                    
                    localStorage.setItem(historyKey, JSON.stringify(history));
                } catch (error) {
                    console.error('å‚™ä»½æ­·å²ç¶­è­·å¤±æ•—:', error);
                }
            }

            // ç·Šæ€¥ä¿å­˜
            emergencySave() {
                try {
                    this.saveDataSecurely();
                    console.log('ç·Šæ€¥ä¿å­˜å®Œæˆ');
                } catch (error) {
                    console.error('ç·Šæ€¥ä¿å­˜å¤±æ•—:', error);
                }
            }

            // è³‡æ–™å®Œæ•´æ€§é©—è­‰
            verifyDataIntegrity() {
                try {
                    const currentData = localStorage.getItem(this.storageKey);
                    if (!currentData) {
                        console.warn('ä¸»è¦è³‡æ–™éºå¤±ï¼Œå˜—è©¦æ¢å¾©...');
                        this.recoverFromBackup();
                        return;
                    }
                    
                    const parsedData = JSON.parse(currentData);
                    if (!this.validateDataStructure(parsedData)) {
                        console.warn('è³‡æ–™çµæ§‹æå£ï¼Œå˜—è©¦æ¢å¾©...');
                        this.recoverFromBackup();
                        return;
                    }
                    
                    // æª¢æŸ¥è³‡æ–™æ˜¯å¦èˆ‡è¨˜æ†¶é«”ä¸­çš„è³‡æ–™ä¸€è‡´
                    const memoryChecksum = this.generateChecksum(this.data);
                    const storageChecksum = this.generateChecksum(parsedData);
                    
                    if (memoryChecksum !== storageChecksum) {
                        console.warn('è¨˜æ†¶é«”èˆ‡å„²å­˜è³‡æ–™ä¸ä¸€è‡´ï¼Œé‡æ–°åŒæ­¥...');
                        this.saveDataSecurely();
                    }
                    
                } catch (error) {
                    console.error('è³‡æ–™å®Œæ•´æ€§æª¢æŸ¥å¤±æ•—:', error);
                    this.recoverFromBackup();
                }
            }

            // å¾å‚™ä»½æ¢å¾©
            recoverFromBackup() {
                try {
                    const backupData = localStorage.getItem(this.backupKey);
                    if (backupData) {
                        const backup = JSON.parse(backupData);
                        if (backup.data && this.validateDataStructure(backup.data)) {
                            this.data = backup.data;
                            this.saveDataSecurely();
                            this.updateUI();
                            this.showDataRecoveryNotification();
                            return true;
                        }
                    }
                    
                    // å˜—è©¦å¾å‚™ä»½æ­·å²æ¢å¾©
                    const historyData = localStorage.getItem('tcmBackupHistory');
                    if (historyData) {
                        const history = JSON.parse(historyData);
                        for (const backup of history) {
                            if (backup.data && this.validateDataStructure(backup.data)) {
                                this.data = backup.data;
                                this.saveDataSecurely();
                                this.updateUI();
                                this.showDataRecoveryNotification();
                                return true;
                            }
                        }
                    }
                    
                } catch (error) {
                    console.error('å‚™ä»½æ¢å¾©å¤±æ•—:', error);
                }
                
                this.showDataErrorNotification();
                return false;
            }

            // è³‡æ–™é·ç§»
            migrateData(oldVersion) {
                try {
                    console.log(`è³‡æ–™é·ç§»: ${oldVersion} -> ${this.currentVersion}`);
                    
                    // å¾èˆŠç‰ˆæœ¬é·ç§»
                    if (!oldVersion || oldVersion === '1.0' || oldVersion === '2.0') {
                        const oldData = localStorage.getItem('tcmData') || localStorage.getItem('tcmData_v2');
                        if (oldData) {
                            const parsed = JSON.parse(oldData);
                            if (this.validateDataStructure(parsed)) {
                                this.saveDataSecurely(parsed);
                                console.log('æˆåŠŸå¾èˆŠç‰ˆæœ¬é·ç§»è³‡æ–™');
                            }
                        }
                    }
                    
                } catch (error) {
                    console.error('è³‡æ–™é·ç§»å¤±æ•—:', error);
                }
            }

            // é–‹å§‹è‡ªå‹•å‚™ä»½
            startAutoBackup() {
                // æ¯5åˆ†é˜è‡ªå‹•å‚™ä»½ä¸€æ¬¡
                setInterval(() => {
                    this.createLocalBackup(this.data);
                }, 5 * 60 * 1000);
                
                // æ¯å°æ™‚é©—è­‰ä¸€æ¬¡è³‡æ–™å®Œæ•´æ€§
                setInterval(() => {
                    this.verifyDataIntegrity();
                }, 60 * 60 * 1000);
            }

            // è™•ç†ä¿å­˜éŒ¯èª¤
            handleSaveError(error) {
                if (error.name === 'QuotaExceededError') {
                    this.showStorageFullNotification();
                    this.cleanupOldData();
                } else {
                    this.showDataErrorNotification();
                }
            }

            // æ¸…ç†èˆŠè³‡æ–™
            cleanupOldData() {
                try {
                    // æ¸…ç†æœå°‹åˆ†æè³‡æ–™
                    const analytics = JSON.parse(localStorage.getItem('searchAnalytics') || '{}');
                    const cutoffDate = new Date();
                    cutoffDate.setDate(cutoffDate.getDate() - 30); // ä¿ç•™30å¤©
                    
                    Object.keys(analytics).forEach(query => {
                        const lastSearched = new Date(analytics[query].lastSearched);
                        if (lastSearched < cutoffDate) {
                            delete analytics[query];
                        }
                    });
                    
                    localStorage.setItem('searchAnalytics', JSON.stringify(analytics));
                    
                    // æ¸…ç†å‚™ä»½æ­·å²ï¼Œåªä¿ç•™æœ€æ–°çš„3å€‹
                    const history = JSON.parse(localStorage.getItem('tcmBackupHistory') || '[]');
                    if (history.length > 3) {
                        localStorage.setItem('tcmBackupHistory', JSON.stringify(history.slice(0, 3)));
                    }
                    
                    console.log('èˆŠè³‡æ–™æ¸…ç†å®Œæˆ');
                } catch (error) {
                    console.error('è³‡æ–™æ¸…ç†å¤±æ•—:', error);
                }
            }

            // é¡¯ç¤ºè³‡æ–™æ¢å¾©é€šçŸ¥
            showDataRecoveryNotification() {
                this.showSystemNotification('ğŸ”„', 'è³‡æ–™å·²å¾å‚™ä»½æ¢å¾©', 'bg-blue-100 text-blue-800', 5000);
            }

            // é¡¯ç¤ºè³‡æ–™éŒ¯èª¤é€šçŸ¥
            showDataErrorNotification() {
                this.showSystemNotification('âš ï¸', 'è³‡æ–™è¼‰å…¥å‡ºç¾å•é¡Œï¼Œè«‹æª¢æŸ¥æˆ–é‡æ–°å°å…¥', 'bg-red-100 text-red-800', 8000);
            }

            // é¡¯ç¤ºå„²å­˜ç©ºé–“ä¸è¶³é€šçŸ¥
            showStorageFullNotification() {
                this.showSystemNotification('ğŸ’¾', 'å„²å­˜ç©ºé–“ä¸è¶³ï¼Œå·²æ¸…ç†èˆŠè³‡æ–™', 'bg-yellow-100 text-yellow-800', 6000);
            }

            // é¡¯ç¤ºç³»çµ±é€šçŸ¥
            showSystemNotification(icon, message, className, duration = 3000) {
                // å‰µå»ºé€šçŸ¥å…ƒç´ 
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 ${className} p-4 rounded-lg shadow-lg z-50 max-w-sm`;
                notification.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <span class="text-xl">${icon}</span>
                        <div class="flex-1">
                            <div class="text-sm font-medium">${message}</div>
                            <div class="text-xs opacity-75 mt-1">${new Date().toLocaleTimeString('zh-TW')}</div>
                        </div>
                        <button class="text-lg opacity-50 hover:opacity-100" onclick="this.parentElement.parentElement.remove()">Ã—</button>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // è‡ªå‹•ç§»é™¤
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, duration);
            }

            generateChecksum(data) {
                // Simple checksum generation
                const str = JSON.stringify(data);
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32-bit integer
                }
                return hash.toString(16);
            }

            initializeEventListeners() {
                // Search functionality
                document.getElementById('searchBtn').addEventListener('click', () => this.search());
                document.getElementById('searchInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.search();
                });
                
                // Real-time search suggestions
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.showSearchSuggestions(e.target.value);
                });
                
                // Hide suggestions when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#searchInput') && !e.target.closest('#searchSuggestions')) {
                        this.hideSearchSuggestions();
                    }
                });

                // Backup functionality
                document.getElementById('backupBtn').addEventListener('click', () => this.showBackupModal());
                document.getElementById('processImport').addEventListener('click', () => this.processImportData());

                // Import controls
                document.getElementById('fileImportBtn').addEventListener('click', () => this.triggerFileImport());
                document.getElementById('textImportBtn').addEventListener('click', () => this.toggleManualInput());
                document.getElementById('fileInput').addEventListener('change', (e) => this.handleFileImport(e));

                // Online sync controls
                document.getElementById('syncBtn').addEventListener('click', () => this.handleSyncButtonClick());
                document.getElementById('onlineDataBtn').addEventListener('click', () => this.showOnlineDataModal());
                document.getElementById('closeOnlineDataModal').addEventListener('click', () => this.hideOnlineDataModal());
                document.getElementById('uploadDataBtn').addEventListener('click', () => this.uploadLocalData());
                document.getElementById('downloadDataBtn').addEventListener('click', () => this.downloadOnlineData());
                document.getElementById('mergeDataBtn').addEventListener('click', () => this.mergeData());
                document.getElementById('autoSyncEnabled').addEventListener('change', (e) => this.toggleAutoSync(e.target.checked));
                document.getElementById('conflictResolution').addEventListener('change', (e) => this.toggleConflictResolution(e.target.checked));
                document.getElementById('syncInterval').addEventListener('change', (e) => this.changeSyncInterval(e.target.value));



                // Backup modal controls
                document.getElementById('closeBackupModal').addEventListener('click', () => this.hideBackupModal());
                document.getElementById('downloadBackup').addEventListener('click', () => this.downloadBackup());
                document.getElementById('copyBackup').addEventListener('click', () => this.copyBackupToClipboard());
                document.getElementById('restoreBackup').addEventListener('click', () => this.triggerBackupRestore());
                document.getElementById('backupFileInput').addEventListener('change', (e) => this.handleBackupRestore(e));
            }

            search() {
                const query = document.getElementById('searchInput').value.trim();
                if (!query) return;

                const results = this.performSearch(query);
                this.displaySearchResults(query, results);
            }

            performSearch(query) {
                const results = {
                    herbResults: [],
                    symptomResults: []
                };

                // Simple search implementation
                const normalizedQuery = query.toLowerCase();

                // Search herbs
                Object.keys(this.data.herbs).forEach(herb => {
                    if (herb.toLowerCase().includes(normalizedQuery)) {
                        results.herbResults.push({
                            name: herb,
                            symptoms: this.data.herbs[herb],
                            score: 100
                        });
                    }
                });

                // Search symptoms
                Object.keys(this.data.symptoms).forEach(symptom => {
                    if (symptom.toLowerCase().includes(normalizedQuery)) {
                        results.symptomResults.push({
                            name: symptom,
                            herbs: this.data.symptoms[symptom],
                            score: 100
                        });
                    }
                });

                return results;
            }

            displaySearchResults(query, results) {
                const resultsSection = document.getElementById('resultsSection');
                const searchResults = document.getElementById('searchResults');
                
                resultsSection.classList.remove('hidden');
                searchResults.innerHTML = '';

                const totalResults = results.herbResults.length + results.symptomResults.length;

                if (totalResults === 0) {
                    searchResults.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <div class="text-4xl mb-4">ğŸ”</div>
                            <p class="text-lg">æœªæ‰¾åˆ°ç›¸é—œçµæœ</p>
                            <p class="text-sm mt-2">è«‹å˜—è©¦å…¶ä»–é—œéµå­—æˆ–æª¢æŸ¥æ‹¼å¯«</p>
                        </div>
                    `;
                    return;
                }

                // Display herb results
                if (results.herbResults.length > 0) {
                    const herbSection = document.createElement('div');
                    herbSection.className = 'mb-8';
                    herbSection.innerHTML = `
                        <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                            <span class="mr-2">ğŸŒ¿</span>
                            <span>ä¸­è—¥</span>
                            <span class="ml-2 text-xs text-gray-500">(${results.herbResults.length})</span>
                        </h4>
                    `;

                    results.herbResults.forEach(herb => {
                        const herbCard = document.createElement('div');
                        herbCard.className = `bg-gradient-to-r from-green-50 to-green-25 border-l-4 border-green-500 p-4 rounded-lg mb-3`;
                        herbCard.innerHTML = `
                            <div class="flex justify-between items-start mb-3">
                                <h5 class="font-bold text-green-800 text-lg">${herb.name}</h5>
                                <div class="text-sm font-medium text-gray-700">${herb.score}%</div>
                            </div>
                            <div class="mb-2">
                                <div class="text-xs text-gray-600 mb-1">ä¸»æ²»ç—‡ç‹€ï¼š</div>
                                <div class="flex flex-wrap gap-1">
                                    ${herb.symptoms.map(symptom => 
                                        `<span class="px-2 py-1 text-xs rounded bg-green-100 text-green-800">${symptom}</span>`
                                    ).join('')}
                                </div>
                            </div>
                        `;
                        herbSection.appendChild(herbCard);
                    });

                    searchResults.appendChild(herbSection);
                }

                // Display symptom results
                if (results.symptomResults.length > 0) {
                    const symptomSection = document.createElement('div');
                    symptomSection.className = 'mb-8';
                    symptomSection.innerHTML = `
                        <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                            <span class="mr-2">ğŸ©º</span>
                            <span>ç—‡ç‹€</span>
                            <span class="ml-2 text-xs text-gray-500">(${results.symptomResults.length})</span>
                        </h4>
                    `;

                    results.symptomResults.forEach(symptom => {
                        const symptomCard = document.createElement('div');
                        symptomCard.className = `bg-gradient-to-r from-blue-50 to-blue-25 border-l-4 border-blue-500 p-4 rounded-lg mb-3`;
                        symptomCard.innerHTML = `
                            <div class="flex justify-between items-start mb-3">
                                <h5 class="font-bold text-blue-800 text-lg">${symptom.name}</h5>
                                <div class="text-sm font-medium text-gray-700">${symptom.score}%</div>
                            </div>
                            <div class="mb-2">
                                <div class="text-xs text-gray-600 mb-1">ç›¸é—œä¸­è—¥ï¼š</div>
                                <div class="flex flex-wrap gap-1">
                                    ${symptom.herbs.map(herb => 
                                        `<span class="px-2 py-1 text-xs rounded bg-blue-100 text-blue-800">${herb}</span>`
                                    ).join('')}
                                </div>
                            </div>
                        `;
                        symptomSection.appendChild(symptomCard);
                    });

                    searchResults.appendChild(symptomSection);
                }
            }

            processImportData() {
                const importText = document.getElementById('importData').value.trim();
                if (!importText) {
                    this.showImportStatus('âš ï¸', 'è«‹è¼¸å…¥è¦å°å…¥çš„è³‡æ–™', 'bg-yellow-100 text-yellow-800');
                    return;
                }

                this.showImportStatus('â³', 'æ­£åœ¨è™•ç†è³‡æ–™...', 'bg-blue-100 text-blue-800');

                const lines = importText.split('\n').filter(line => line.trim());
                let successCount = 0;

                lines.forEach(line => {
                    const parts = line.split('ï¼š');
                    if (parts.length === 2) {
                        const herb = parts[0].trim();
                        const symptoms = parts[1].split(',').map(s => s.trim()).filter(s => s);
                        
                        if (herb && symptoms.length > 0) {
                            this.addHerbData(herb, symptoms);
                            successCount++;
                        }
                    }
                });

                this.saveData();
                this.updateUI();
                document.getElementById('importData').value = '';
                
                this.showImportStatus('âœ…', `æˆåŠŸå°å…¥ ${successCount} æ¢ä¸­è—¥è³‡æ–™`, 'bg-green-100 text-green-800');
                
                // Hide manual input section and status after success
                setTimeout(() => {
                    document.getElementById('manualInputSection').classList.add('hidden');
                    document.getElementById('textImportBtn').innerHTML = 'âœï¸ æ‰‹å‹•è¼¸å…¥';
                    document.getElementById('importStatus').classList.add('hidden');
                }, 2000);
            }

            addHerbData(herb, symptoms) {
                // Add to herbs data
                if (!this.data.herbs[herb]) {
                    this.data.herbs[herb] = [];
                }
                
                symptoms.forEach(symptom => {
                    if (!this.data.herbs[herb].includes(symptom)) {
                        this.data.herbs[herb].push(symptom);
                    }
                    
                    // Add to symptoms data
                    if (!this.data.symptoms[symptom]) {
                        this.data.symptoms[symptom] = [];
                    }
                    if (!this.data.symptoms[symptom].includes(herb)) {
                        this.data.symptoms[symptom].push(herb);
                    }
                });
            }

            toggleManualInput() {
                const manualSection = document.getElementById('manualInputSection');
                const isHidden = manualSection.classList.contains('hidden');
                
                if (isHidden) {
                    manualSection.classList.remove('hidden');
                    document.getElementById('textImportBtn').textContent = 'âœï¸ éš±è—è¼¸å…¥';
                } else {
                    manualSection.classList.add('hidden');
                    document.getElementById('textImportBtn').innerHTML = 'âœï¸ æ‰‹å‹•è¼¸å…¥';
                }
            }

            triggerFileImport() {
                document.getElementById('fileInput').click();
            }

            handleFileImport(event) {
                const file = event.target.files[0];
                if (!file) return;

                this.showImportStatus('â³', 'æ­£åœ¨è™•ç†æª”æ¡ˆ...', 'bg-blue-100 text-blue-800');

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const content = e.target.result;
                        let successCount = 0;
                        
                        if (file.name.endsWith('.json')) {
                            const importedData = JSON.parse(content);
                            if (importedData.data) {
                                this.data = importedData.data;
                                successCount = Object.keys(importedData.data.herbs || {}).length;
                            } else {
                                this.data = importedData;
                                successCount = Object.keys(importedData.herbs || {}).length;
                            }
                        } else {
                            // Process text file
                            const lines = content.split('\n').filter(line => line.trim());
                            lines.forEach(line => {
                                const parts = line.split('ï¼š');
                                if (parts.length === 2) {
                                    const herb = parts[0].trim();
                                    const symptoms = parts[1].split(',').map(s => s.trim()).filter(s => s);
                                    
                                    if (herb && symptoms.length > 0) {
                                        this.addHerbData(herb, symptoms);
                                        successCount++;
                                    }
                                }
                            });
                        }
                        
                        this.saveData();
                        this.updateUI();
                        this.showImportStatus('âœ…', `æˆåŠŸå°å…¥ ${successCount} æ¢è³‡æ–™`, 'bg-green-100 text-green-800');
                        
                        setTimeout(() => {
                            document.getElementById('importStatus').classList.add('hidden');
                        }, 3000);
                        
                    } catch (error) {
                        this.showImportStatus('âŒ', 'æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆå…§å®¹', 'bg-red-100 text-red-800');
                    }
                };
                reader.readAsText(file);
                
                event.target.value = '';
            }

            showImportStatus(icon, text, className) {
                const statusDiv = document.getElementById('importStatus');
                const statusIcon = document.getElementById('statusIcon');
                const statusText = document.getElementById('statusText');
                
                statusIcon.textContent = icon;
                statusText.textContent = text;
                statusDiv.className = `p-3 rounded-lg ${className}`;
                statusDiv.classList.remove('hidden');
            }

            // ç·šä¸ŠåŒæ­¥åŠŸèƒ½æ–¹æ³•
            handleSyncButtonClick() {
                if (!this.isOnline) {
                    this.showSystemNotification('ğŸ“±', 'ç›®å‰è™•æ–¼é›¢ç·šæ¨¡å¼ï¼Œç„¡æ³•åŒæ­¥', 'bg-gray-100 text-gray-800');
                    return;
                }
                
                this.performQuickSync();
            }

            async performQuickSync() {
                const syncIcon = document.getElementById('syncIcon');
                const syncText = document.getElementById('syncText');
                
                // é¡¯ç¤ºåŒæ­¥å‹•ç•«
                syncIcon.className = 'sync-animation';
                syncIcon.textContent = 'ğŸ”„';
                syncText.textContent = 'åŒæ­¥ä¸­...';
                
                try {
                    const onlineData = this.getOnlineData();
                    
                    if (!onlineData) {
                        await this.uploadLocalData(false);
                        this.showSystemNotification('âœ…', 'æœ¬åœ°è³‡æ–™å·²ä¸Šå‚³åˆ°ç·šä¸Š', 'bg-green-100 text-green-800');
                    } else if (this.needsSync(this.data, onlineData)) {
                        await this.mergeData(false);
                        this.showSystemNotification('âœ…', 'è³‡æ–™åŒæ­¥å®Œæˆ', 'bg-green-100 text-green-800');
                    } else {
                        this.showSystemNotification('â„¹ï¸', 'è³‡æ–™å·²æ˜¯æœ€æ–°ç‰ˆæœ¬', 'bg-blue-100 text-blue-800');
                    }
                } catch (error) {
                    console.error('å¿«é€ŸåŒæ­¥å¤±æ•—:', error);
                    this.showSystemNotification('âŒ', 'åŒæ­¥å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦', 'bg-red-100 text-red-800');
                } finally {
                    setTimeout(() => {
                        syncIcon.className = '';
                        syncIcon.textContent = 'â˜ï¸';
                        syncText.textContent = 'ç·šä¸ŠåŒæ­¥';
                    }, 1000);
                }
            }

            showOnlineDataModal() {
                this.refreshOnlineDataModal();
                document.getElementById('onlineDataModal').classList.remove('hidden');
                document.getElementById('onlineDataModal').classList.add('flex');
            }

            hideOnlineDataModal() {
                document.getElementById('onlineDataModal').classList.add('hidden');
                document.getElementById('onlineDataModal').classList.remove('flex');
                document.getElementById('onlineDataStatus').classList.add('hidden');
            }

            refreshOnlineDataModal() {
                this.updateConnectionStatus();
                this.updateLocalDataInfo();
                this.updateOnlineDataInfo();
                this.updateSyncSettings();
                this.updateRecentActivity();
            }

            updateConnectionStatus() {
                const indicator = document.getElementById('connectionIndicator');
                const status = document.getElementById('connectionStatus');
                const serverStatus = document.getElementById('serverStatus');
                const lastSync = document.getElementById('lastSyncTime');
                const onlineVersion = document.getElementById('onlineDataVersion');
                
                if (this.isOnline) {
                    indicator.className = 'w-3 h-3 bg-green-500 rounded-full pulse-dot';
                    status.textContent = 'å·²é€£ç·š';
                    status.className = 'text-sm text-green-600 font-medium';
                    serverStatus.textContent = 'æ­£å¸¸';
                } else {
                    indicator.className = 'w-3 h-3 bg-red-500 rounded-full';
                    status.textContent = 'é›¢ç·š';
                    status.className = 'text-sm text-red-600 font-medium';
                    serverStatus.textContent = 'ç„¡æ³•é€£æ¥';
                }
                
                const lastSyncTime = localStorage.getItem(this.lastSyncKey);
                if (lastSyncTime) {
                    const syncDate = new Date(lastSyncTime);
                    lastSync.textContent = syncDate.toLocaleString('zh-TW');
                } else {
                    lastSync.textContent = 'å¾æœªåŒæ­¥';
                }
                
                const onlineData = this.getOnlineData();
                onlineVersion.textContent = onlineData ? (onlineData.version || '1.0') : '-';
            }

            updateLocalDataInfo() {
                const herbCount = Object.keys(this.data.herbs).length;
                const symptomCount = Object.keys(this.data.symptoms).length;
                const lastUpdate = localStorage.getItem('tcmLastUpdate') || 'å¾æœªæ›´æ–°';
                
                document.getElementById('localHerbCount').textContent = herbCount;
                document.getElementById('localSymptomCount').textContent = symptomCount;
                document.getElementById('localLastUpdate').textContent = lastUpdate;
            }

            updateOnlineDataInfo(onlineData = null) {
                if (!onlineData) {
                    onlineData = this.getOnlineData();
                }
                
                if (onlineData && onlineData.data) {
                    const herbCount = Object.keys(onlineData.data.herbs || {}).length;
                    const symptomCount = Object.keys(onlineData.data.symptoms || {}).length;
                    const lastUpdate = onlineData.timestamp ? 
                        new Date(onlineData.timestamp).toLocaleString('zh-TW') : 'æœªçŸ¥';
                    
                    document.getElementById('onlineHerbCount').textContent = herbCount;
                    document.getElementById('onlineSymptomCount').textContent = symptomCount;
                    document.getElementById('onlineLastUpdate').textContent = lastUpdate;
                } else {
                    document.getElementById('onlineHerbCount').textContent = '-';
                    document.getElementById('onlineSymptomCount').textContent = '-';
                    document.getElementById('onlineLastUpdate').textContent = 'ç„¡è³‡æ–™';
                }
            }

            updateSyncSettings() {
                document.getElementById('autoSyncEnabled').checked = this.syncSettings.autoSync;
                document.getElementById('conflictResolution').checked = this.syncSettings.conflictResolution;
                document.getElementById('syncInterval').value = this.syncSettings.syncInterval;
            }

            updateRecentActivity() {
                const activityList = document.getElementById('recentActivityList');
                const activities = JSON.parse(localStorage.getItem('tcmSyncActivities') || '[]');
                
                activityList.innerHTML = '';
                
                if (activities.length === 0) {
                    activityList.innerHTML = '<div class="text-sm text-gray-500 text-center py-2">æš«ç„¡æ´»å‹•è¨˜éŒ„</div>';
                    return;
                }
                
                activities.slice(0, 10).forEach(activity => {
                    const activityItem = document.createElement('div');
                    activityItem.className = 'flex items-center justify-between text-sm p-2 bg-white rounded border';
                    
                    const activityDate = new Date(activity.timestamp);
                    const timeAgo = this.getTimeAgo(activityDate);
                    
                    activityItem.innerHTML = `
                        <div>
                            <div class="font-medium">${activity.action}</div>
                            <div class="text-xs text-gray-500">${activity.description}</div>
                        </div>
                        <div class="text-xs text-gray-400">${timeAgo}</div>
                    `;
                    
                    activityList.appendChild(activityItem);
                });
            }

            getTimeAgo(date) {
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                if (diffMins < 1) return 'å‰›å‰›';
                if (diffMins < 60) return `${diffMins}åˆ†é˜å‰`;
                if (diffHours < 24) return `${diffHours}å°æ™‚å‰`;
                if (diffDays < 7) return `${diffDays}å¤©å‰`;
                return date.toLocaleDateString('zh-TW');
            }

            async uploadLocalData(showModal = true) {
                if (!this.isOnline) {
                    if (showModal) {
                        this.showOnlineDataStatus('âŒ', 'ç„¡æ³•é€£æ¥åˆ°ç·šä¸Šæœå‹™', 'bg-red-100 text-red-800');
                    }
                    return;
                }
                
                if (showModal) {
                    this.showOnlineDataStatus('â³', 'æ­£åœ¨ä¸Šå‚³æœ¬åœ°è³‡æ–™...', 'bg-blue-100 text-blue-800');
                }
                
                try {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    const result = this.saveOnlineData(this.data);
                    
                    if (showModal) {
                        this.showOnlineDataStatus('âœ…', 'æœ¬åœ°è³‡æ–™ä¸Šå‚³æˆåŠŸï¼', 'bg-green-100 text-green-800');
                        this.refreshOnlineDataModal();
                    }
                    
                    return result;
                } catch (error) {
                    console.error('ä¸Šå‚³å¤±æ•—:', error);
                    if (showModal) {
                        this.showOnlineDataStatus('âŒ', 'ä¸Šå‚³å¤±æ•—ï¼Œè«‹é‡è©¦', 'bg-red-100 text-red-800');
                    }
                    throw error;
                }
            }

            async downloadOnlineData() {
                if (!this.isOnline) {
                    this.showOnlineDataStatus('âŒ', 'ç„¡æ³•é€£æ¥åˆ°ç·šä¸Šæœå‹™', 'bg-red-100 text-red-800');
                    return;
                }
                
                this.showOnlineDataStatus('â³', 'æ­£åœ¨ä¸‹è¼‰ç·šä¸Šè³‡æ–™...', 'bg-blue-100 text-blue-800');
                
                try {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    const onlineData = this.getOnlineData();
                    
                    if (!onlineData || !onlineData.data) {
                        this.showOnlineDataStatus('âš ï¸', 'ç·šä¸Šæ²’æœ‰å¯ç”¨çš„è³‡æ–™', 'bg-yellow-100 text-yellow-800');
                        return;
                    }
                    
                    if (confirm('ä¸‹è¼‰ç·šä¸Šè³‡æ–™å°‡è¦†è“‹æœ¬åœ°è³‡æ–™ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                        this.data = {
                            herbs: onlineData.data.herbs || {},
                            symptoms: onlineData.data.symptoms || {}
                        };
                        
                        this.saveDataSecurely();
                        this.updateUI();
                        this.addSyncActivity('ä¸‹è¼‰', 'ç·šä¸Šè³‡æ–™å·²ä¸‹è¼‰ä¸¦è¦†è“‹æœ¬åœ°è³‡æ–™');
                        
                        this.showOnlineDataStatus('âœ…', 'ç·šä¸Šè³‡æ–™ä¸‹è¼‰æˆåŠŸï¼', 'bg-green-100 text-green-800');
                        this.refreshOnlineDataModal();
                    } else {
                        this.showOnlineDataStatus('â„¹ï¸', 'ä¸‹è¼‰å·²å–æ¶ˆ', 'bg-gray-100 text-gray-800');
                    }
                } catch (error) {
                    console.error('ä¸‹è¼‰å¤±æ•—:', error);
                    this.showOnlineDataStatus('âŒ', 'ä¸‹è¼‰å¤±æ•—ï¼Œè«‹é‡è©¦', 'bg-red-100 text-red-800');
                }
            }

            async mergeData(showModal = true) {
                if (!this.isOnline) {
                    if (showModal) {
                        this.showOnlineDataStatus('âŒ', 'ç„¡æ³•é€£æ¥åˆ°ç·šä¸Šæœå‹™', 'bg-red-100 text-red-800');
                    }
                    return;
                }
                
                if (showModal) {
                    this.showOnlineDataStatus('â³', 'æ­£åœ¨åŸ·è¡Œæ™ºèƒ½åˆä½µ...', 'bg-blue-100 text-blue-800');
                }
                
                try {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    const onlineData = this.getOnlineData();
                    
                    if (!onlineData || !onlineData.data) {
                        await this.uploadLocalData(false);
                        if (showModal) {
                            this.showOnlineDataStatus('âœ…', 'æœ¬åœ°è³‡æ–™å·²ä¸Šå‚³ï¼ˆç·šä¸Šç„¡è³‡æ–™ï¼‰', 'bg-green-100 text-green-800');
                        }
                        return;
                    }
                    
                    const mergedData = this.performIntelligentMerge(this.data, onlineData.data);
                    
                    this.data = mergedData;
                    this.saveDataSecurely();
                    this.saveOnlineData(mergedData);
                    
                    this.updateUI();
                    this.addSyncActivity('åˆä½µ', 'æœ¬åœ°èˆ‡ç·šä¸Šè³‡æ–™å·²æ™ºèƒ½åˆä½µ');
                    
                    if (showModal) {
                        this.showOnlineDataStatus('âœ…', 'è³‡æ–™æ™ºèƒ½åˆä½µå®Œæˆï¼', 'bg-green-100 text-green-800');
                        this.refreshOnlineDataModal();
                    }
                } catch (error) {
                    console.error('åˆä½µå¤±æ•—:', error);
                    if (showModal) {
                        this.showOnlineDataStatus('âŒ', 'åˆä½µå¤±æ•—ï¼Œè«‹é‡è©¦', 'bg-red-100 text-red-800');
                    }
                }
            }

            performIntelligentMerge(localData, onlineData) {
                const mergedData = {
                    herbs: { ...localData.herbs },
                    symptoms: { ...localData.symptoms }
                };
                
                // åˆä½µä¸­è—¥è³‡æ–™
                Object.keys(onlineData.herbs || {}).forEach(herb => {
                    if (mergedData.herbs[herb]) {
                        const combinedSymptoms = [...new Set([
                            ...mergedData.herbs[herb],
                            ...onlineData.herbs[herb]
                        ])];
                        mergedData.herbs[herb] = combinedSymptoms;
                    } else {
                        mergedData.herbs[herb] = [...onlineData.herbs[herb]];
                    }
                });
                
                // åˆä½µç—‡ç‹€è³‡æ–™
                Object.keys(onlineData.symptoms || {}).forEach(symptom => {
                    if (mergedData.symptoms[symptom]) {
                        const combinedHerbs = [...new Set([
                            ...mergedData.symptoms[symptom],
                            ...onlineData.symptoms[symptom]
                        ])];
                        mergedData.symptoms[symptom] = combinedHerbs;
                    } else {
                        mergedData.symptoms[symptom] = [...onlineData.symptoms[symptom]];
                    }
                });
                
                this.rebuildSymptomIndex(mergedData);
                
                return mergedData;
            }

            rebuildSymptomIndex(data) {
                data.symptoms = {};
                
                Object.keys(data.herbs).forEach(herb => {
                    data.herbs[herb].forEach(symptom => {
                        if (!data.symptoms[symptom]) {
                            data.symptoms[symptom] = [];
                        }
                        if (!data.symptoms[symptom].includes(herb)) {
                            data.symptoms[symptom].push(herb);
                        }
                    });
                });
            }

            toggleAutoSync(enabled) {
                this.syncSettings.autoSync = enabled;
                this.saveSyncSettings();
                
                if (enabled && this.isOnline) {
                    this.startAutoSync();
                } else {
                    this.stopAutoSync();
                }
                
                this.showOnlineDataStatus('âœ…', `è‡ªå‹•åŒæ­¥å·²${enabled ? 'å•Ÿç”¨' : 'åœç”¨'}`, 'bg-blue-100 text-blue-800');
            }

            toggleConflictResolution(enabled) {
                this.syncSettings.conflictResolution = enabled;
                this.saveSyncSettings();
                
                this.showOnlineDataStatus('âœ…', `è¡çªè‡ªå‹•è™•ç†å·²${enabled ? 'å•Ÿç”¨' : 'åœç”¨'}`, 'bg-blue-100 text-blue-800');
            }

            changeSyncInterval(interval) {
                this.syncSettings.syncInterval = parseInt(interval);
                this.saveSyncSettings();
                
                if (this.syncSettings.autoSync && this.isOnline) {
                    this.startAutoSync();
                }
                
                const minutes = Math.floor(interval / 60);
                this.showOnlineDataStatus('âœ…', `åŒæ­¥é–“éš”å·²è¨­ç‚º${minutes}åˆ†é˜`, 'bg-blue-100 text-blue-800');
            }

            showOnlineDataStatus(icon, text, className) {
                const statusDiv = document.getElementById('onlineDataStatus');
                const statusIcon = document.getElementById('onlineDataStatusIcon');
                const statusText = document.getElementById('onlineDataStatusText');
                
                statusIcon.textContent = icon;
                statusText.textContent = text;
                statusDiv.className = `mt-4 p-3 rounded-lg text-sm ${className}`;
                statusDiv.classList.remove('hidden');
                
                if (icon === 'âœ…') {
                    setTimeout(() => {
                        statusDiv.classList.add('hidden');
                    }, 3000);
                }
            }

            // Backup Modal Functions
            showBackupModal() {
                const herbCount = Object.keys(this.data.herbs).length;
                const symptomCount = Object.keys(this.data.symptoms).length;
                const lastUpdate = localStorage.getItem('tcmLastUpdate') || 'å¾æœªæ›´æ–°';
                
                document.getElementById('backupHerbCount').textContent = herbCount;
                document.getElementById('backupSymptomCount').textContent = symptomCount;
                document.getElementById('lastUpdateTime').textContent = lastUpdate;
                
                document.getElementById('backupModal').classList.remove('hidden');
                document.getElementById('backupModal').classList.add('flex');
            }

            hideBackupModal() {
                document.getElementById('backupModal').classList.add('hidden');
                document.getElementById('backupModal').classList.remove('flex');
                document.getElementById('backupStatus').classList.add('hidden');
            }

            downloadBackup() {
                try {
                    const backupData = this.createBackupData();
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
                    const filename = `TCM_Backup_${timestamp}.json`;
                    
                    const blob = new Blob([JSON.stringify(backupData, null, 2)], { 
                        type: 'application/json' 
                    });
                    
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    link.click();
                    
                    URL.revokeObjectURL(url);
                    
                    this.showBackupStatus('âœ…', 'å‚™ä»½æª”æ¡ˆå·²ä¸‹è¼‰å®Œæˆï¼', 'bg-green-100 text-green-800');
                } catch (error) {
                    this.showBackupStatus('âŒ', 'ä¸‹è¼‰å¤±æ•—ï¼Œè«‹é‡è©¦', 'bg-red-100 text-red-800');
                }
            }

            async copyBackupToClipboard() {
                try {
                    const backupData = this.createBackupData();
                    const backupText = JSON.stringify(backupData, null, 2);
                    
                    await navigator.clipboard.writeText(backupText);
                    this.showBackupStatus('âœ…', 'å‚™ä»½è³‡æ–™å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', 'bg-green-100 text-green-800');
                } catch (error) {
                    const textArea = document.createElement('textarea');
                    textArea.value = JSON.stringify(this.createBackupData(), null, 2);
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    this.showBackupStatus('âœ…', 'å‚™ä»½è³‡æ–™å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', 'bg-green-100 text-green-800');
                }
            }

            triggerBackupRestore() {
                document.getElementById('backupFileInput').click();
            }

            handleBackupRestore(event) {
                const file = event.target.files[0];
                if (!file) return;

                this.showBackupStatus('â³', 'æ­£åœ¨æ¢å¾©å‚™ä»½...', 'bg-blue-100 text-blue-800');

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        if (this.validateBackupData(backupData)) {
                            if (confirm('ç¢ºå®šè¦æ¢å¾©æ­¤å‚™ä»½å—ï¼Ÿé€™å°‡è¦†è“‹ç¾æœ‰çš„æ‰€æœ‰è³‡æ–™ã€‚')) {
                                this.restoreFromBackup(backupData);
                                this.showBackupStatus('âœ…', 'å‚™ä»½æ¢å¾©æˆåŠŸï¼', 'bg-green-100 text-green-800');
                                
                                setTimeout(() => {
                                    this.hideBackupModal();
                                    this.updateUI();
                                }, 1500);
                            } else {
                                this.showBackupStatus('â„¹ï¸', 'æ¢å¾©å·²å–æ¶ˆ', 'bg-gray-100 text-gray-800');
                            }
                        } else {
                            this.showBackupStatus('âŒ', 'å‚™ä»½æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º', 'bg-red-100 text-red-800');
                        }
                    } catch (error) {
                        this.showBackupStatus('âŒ', 'å‚™ä»½æª”æ¡ˆæå£æˆ–æ ¼å¼éŒ¯èª¤', 'bg-red-100 text-red-800');
                    }
                };
                
                reader.readAsText(file);
                event.target.value = '';
            }

            createBackupData() {
                return {
                    version: '3.0',
                    appName: 'ä¸­é†«è¨ºç—‡è¼”åŠ©å·¥å…· - ç·šä¸Šå…±äº«ç‰ˆ',
                    backupDate: new Date().toISOString(),
                    backupTime: new Date().toLocaleString('zh-TW'),
                    statistics: {
                        herbCount: Object.keys(this.data.herbs).length,
                        symptomCount: Object.keys(this.data.symptoms).length,
                        totalRelations: Object.values(this.data.herbs).reduce((sum, symptoms) => sum + symptoms.length, 0)
                    },
                    data: {
                        herbs: this.data.herbs,
                        symptoms: this.data.symptoms
                    },
                    checksum: this.generateChecksum(this.data)
                };
            }

            validateBackupData(backupData) {
                if (!backupData.data || !backupData.data.herbs || !backupData.data.symptoms) {
                    return false;
                }
                
                if (typeof backupData.data.herbs !== 'object' || typeof backupData.data.symptoms !== 'object') {
                    return false;
                }
                
                if (backupData.checksum) {
                    const calculatedChecksum = this.generateChecksum(backupData.data);
                    if (calculatedChecksum !== backupData.checksum) {
                        console.warn('Backup checksum mismatch - data may be corrupted');
                    }
                }
                
                return true;
            }

            restoreFromBackup(backupData) {
                this.data = {
                    herbs: backupData.data.herbs,
                    symptoms: backupData.data.symptoms
                };
                
                this.saveData();
                this.updateLastUpdateTime();
                
                document.getElementById('resultsSection').classList.add('hidden');
                document.getElementById('searchInput').value = '';
            }

            showBackupStatus(icon, text, className) {
                const statusDiv = document.getElementById('backupStatus');
                const statusIcon = document.getElementById('backupStatusIcon');
                const statusText = document.getElementById('backupStatusText');
                
                statusIcon.textContent = icon;
                statusText.textContent = text;
                statusDiv.className = `mt-4 p-3 rounded-lg text-sm ${className}`;
                statusDiv.classList.remove('hidden');
                
                if (icon === 'âœ…') {
                    setTimeout(() => {
                        statusDiv.classList.add('hidden');
                    }, 3000);
                }
            }



            saveData() {
                this.saveDataSecurely();
            }

            updateLastUpdateTime() {
                const now = new Date().toLocaleString('zh-TW');
                localStorage.setItem('tcmLastUpdate', now);
            }

            updateUI() {
                const herbCount = Object.keys(this.data.herbs).length;
                const symptomCount = Object.keys(this.data.symptoms).length;
                
                document.getElementById('herbCount').textContent = herbCount;
                document.getElementById('symptomCount').textContent = symptomCount;
                
                this.updateSyncStatus();
            }

            showSearchSuggestions(query) {
                const suggestionsDiv = document.getElementById('searchSuggestions');
                
                if (!query || query.length < 1) {
                    this.hideSearchSuggestions();
                    return;
                }

                const suggestions = this.generateSuggestions(query);
                
                if (suggestions.length === 0) {
                    this.hideSearchSuggestions();
                    return;
                }

                suggestionsDiv.innerHTML = '';
                suggestions.forEach(suggestion => {
                    const suggestionItem = document.createElement('div');
                    suggestionItem.className = 'px-4 py-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0 flex items-center justify-between';
                    suggestionItem.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <span class="text-lg">${suggestion.icon}</span>
                            <div>
                                <div class="font-medium text-gray-800">${suggestion.text}</div>
                                <div class="text-xs text-gray-500">${suggestion.type} â€¢ ${suggestion.count} å€‹ç›¸é—œé …ç›®</div>
                            </div>
                        </div>
                    `;
                    
                    suggestionItem.addEventListener('click', () => {
                        document.getElementById('searchInput').value = suggestion.text;
                        this.hideSearchSuggestions();
                        this.search();
                    });
                    
                    suggestionsDiv.appendChild(suggestionItem);
                });

                suggestionsDiv.classList.remove('hidden');
            }

            generateSuggestions(query) {
                const suggestions = [];
                const normalizedQuery = query.toLowerCase();

                // Get suggestions from herbs
                Object.keys(this.data.herbs).forEach(herb => {
                    if (herb.toLowerCase().includes(normalizedQuery)) {
                        suggestions.push({
                            text: herb,
                            type: 'ä¸­è—¥',
                            icon: 'ğŸŒ¿',
                            count: this.data.herbs[herb].length,
                            category: 'herb'
                        });
                    }
                });

                // Get suggestions from symptoms
                Object.keys(this.data.symptoms).forEach(symptom => {
                    if (symptom.toLowerCase().includes(normalizedQuery)) {
                        suggestions.push({
                            text: symptom,
                            type: 'ç—‡ç‹€',
                            icon: 'ğŸ©º',
                            count: this.data.symptoms[symptom].length,
                            category: 'symptom'
                        });
                    }
                });

                return suggestions.slice(0, 8);
            }

            hideSearchSuggestions() {
                document.getElementById('searchSuggestions').classList.add('hidden');
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            new TCMDiagnosticTool();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'965297c5c79eb5bc',t:'MTc1MzUxOTIzMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
