<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­é†«è¨ºæ‰€ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* æµ®å‹•æç¤ºæ¨£å¼ */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            max-width: 500px;
            padding: 16px 20px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transform: translateX(100%);
            transition: all 0.3s ease-in-out;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .toast.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .toast.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .toast.info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }
        
        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .toast-content {
            flex: 1;
            line-height: 1.4;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">
    <!-- ç™»å…¥é é¢ -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="text-4xl mb-4">ğŸ¥</div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">ä¸­é†«è¨ºæ‰€ç®¡ç†ç³»çµ±</h1>
                <p class="text-gray-600">è«‹é¸æ“‡æ‚¨çš„èº«ä»½ç™»å…¥</p>
            </div>
            
            <div class="space-y-4">
                <button onclick="login('admin')" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center">
                    <span class="mr-2">ğŸ‘¨â€ğŸ’¼</span>
                    ç®¡ç†å“¡ç™»å…¥
                </button>
                <button onclick="login('doctor')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center">
                    <span class="mr-2">ğŸ‘¨â€âš•ï¸</span>
                    é†«å¸«ç™»å…¥
                </button>
                <button onclick="login('assistant')" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center">
                    <span class="mr-2">ğŸ‘©â€ğŸ’»</span>
                    è¨ºæ‰€åŠ©ç†ç™»å…¥
                </button>
            </div>
        </div>
    </div>

    <!-- ä¸»ç³»çµ±é é¢ -->
    <div id="mainSystem" class="hidden fade-in">
        <!-- å´é‚Šé¸å–® -->
        <div id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-2xl transform -translate-x-full transition-transform duration-300 ease-in-out">
            <div class="flex flex-col h-full">
                <!-- é¸å–®æ¨™é¡Œ -->
                <div class="bg-green-600 text-white p-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">ğŸ¥</span>
                            <h2 class="text-lg font-bold">è¨ºæ‰€åŠŸèƒ½</h2>
                        </div>
                        <button onclick="toggleSidebar()" class="text-white hover:text-gray-200 text-xl">
                            Ã—
                        </button>
                    </div>
                    <div id="sidebarUserRole" class="text-sm text-green-100 mt-2"></div>
                </div>

                <!-- åŠŸèƒ½é¸å–®é …ç›® -->
                <div class="flex-1 py-4">
                    <div id="sidebarMenu" class="space-y-2 px-4">
                        <!-- é¸å–®é …ç›®æœƒå‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- åº•éƒ¨æ“ä½œ -->
                <div class="border-t border-gray-200 p-4">
                    <button onclick="logout()" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg text-sm transition duration-200 flex items-center justify-center">
                        <span class="mr-2">ğŸšª</span>
                        ç™»å‡ºç³»çµ±
                    </button>
                </div>
            </div>
        </div>

        <!-- é®ç½©å±¤ -->
        <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden" onclick="toggleSidebar()"></div>

        <!-- é ‚éƒ¨å°èˆª -->
        <nav class="bg-white shadow-lg border-b-4 border-green-500">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <button onclick="toggleSidebar()" class="mr-4 p-2 rounded-lg hover:bg-gray-100 transition duration-200">
                            <div class="w-6 h-6 flex flex-col justify-center space-y-1">
                                <div class="w-full h-0.5 bg-gray-600"></div>
                                <div class="w-full h-0.5 bg-gray-600"></div>
                                <div class="w-full h-0.5 bg-gray-600"></div>
                            </div>
                        </button>
                        <span class="text-2xl mr-3">ğŸ¥</span>
                        <h1 class="text-xl font-bold text-gray-800">ä¸­é†«è¨ºæ‰€ç®¡ç†ç³»çµ±</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="userRole" class="text-sm text-gray-600"></span>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                            ç™»å‡º
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
        <div class="max-w-7xl mx-auto px-4 py-6">
            <!-- æ­¡è¿é é¢ -->
            <div id="welcomePage" class="text-center py-16">
                <div class="text-6xl mb-6">ğŸ¥</div>
                <h2 class="text-3xl font-bold text-gray-800 mb-4">æ­¡è¿ä½¿ç”¨ä¸­é†«è¨ºæ‰€ç®¡ç†ç³»çµ±</h2>
                <p class="text-gray-600 text-lg mb-8">è«‹é»æ“Šå·¦ä¸Šè§’é¸å–®æŒ‰éˆ•é–‹å§‹ä½¿ç”¨ç³»çµ±åŠŸèƒ½</p>
                <div class="bg-white rounded-xl shadow-lg p-8 max-w-2xl mx-auto">
                    <h3 class="text-xl font-semibold mb-4">ç³»çµ±åŠŸèƒ½æ¦‚è¦½</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <div class="text-2xl mb-2">ğŸ‘¥</div>
                            <div class="font-semibold">ç—…äººè³‡æ–™ç®¡ç†</div>
                            <div class="text-gray-600 mt-1">æ–°å¢ã€æŸ¥çœ‹ã€ç®¡ç†ç—…äººè³‡æ–™</div>
                        </div>
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <div class="text-2xl mb-2">ğŸ©º</div>
                            <div class="font-semibold">è¨ºç—‡ç³»çµ±</div>
                            <div class="text-gray-600 mt-1">è¨˜éŒ„ç—‡ç‹€ã€è¨ºæ–·ã€é–‹ç«‹è™•æ–¹</div>
                        </div>
                        <div class="text-center p-4 bg-red-50 rounded-lg">
                            <div class="text-2xl mb-2">âš™ï¸</div>
                            <div class="font-semibold">ç³»çµ±ç®¡ç†</div>
                            <div class="text-gray-600 mt-1">çµ±è¨ˆè³‡æ–™ã€å‚™ä»½åŒ¯å‡º</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç—…äººè³‡æ–™ç®¡ç† -->
            <div id="patientManagement" class="hidden bg-white rounded-xl shadow-lg p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">ç—…äººè³‡æ–™ç®¡ç†</h2>
                    <div class="flex flex-col md:flex-row gap-3">
                        <div class="relative">
                            <input type="text" id="searchPatient" placeholder="æœå°‹ç—…äººç·¨è™Ÿã€å§“åæˆ–é›»è©±..." class="border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:ring-2 focus:ring-green-500 focus:border-transparent w-full md:w-64">
                            <span class="absolute right-3 top-2.5 text-gray-400">ğŸ”</span>
                        </div>
                        <button onclick="showAddPatientForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200 whitespace-nowrap">
                            + æ–°å¢ç—…äºº
                        </button>
                    </div>
                </div>

                <!-- æ–°å¢/ç·¨è¼¯ç—…äººè¡¨å–®å½ˆçª— -->
                <div id="addPatientModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                            <h3 id="formTitle" class="text-xl font-bold text-gray-800">æ–°å¢ç—…äººè³‡æ–™</h3>
                            <button onclick="hideAddPatientForm()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">å§“å *</label>
                                    <input type="text" id="patientName" placeholder="è«‹è¼¸å…¥å§“å" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">å¹´é½¡</label>
                                    <input type="number" id="patientAge" placeholder="ç³»çµ±è‡ªå‹•è¨ˆç®—" min="0" max="120" readonly class="w-full border border-gray-300 rounded-lg px-4 py-2 bg-gray-100 text-gray-600">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">æ€§åˆ¥ *</label>
                                    <select id="patientGender" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                        <option value="">è«‹é¸æ“‡æ€§åˆ¥</option>
                                        <option value="ç”·">ç”·</option>
                                        <option value="å¥³">å¥³</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">é›»è©±è™Ÿç¢¼ *</label>
                                    <input type="tel" id="patientPhone" placeholder="ä¾‹ï¼š0912-345-678" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">èº«åˆ†è­‰å­—è™Ÿ</label>
                                    <input type="text" id="patientIdCard" placeholder="ä¾‹ï¼šA123456789" maxlength="10" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">å‡ºç”Ÿæ—¥æœŸ *</label>
                                    <input type="date" id="patientBirthDate" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent" onchange="updatePatientAge()">
                                </div>
                                <div class="md:col-span-2 lg:col-span-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">è¯çµ¡åœ°å€</label>
                                    <textarea id="patientAddress" placeholder="è«‹è¼¸å…¥å®Œæ•´åœ°å€" rows="2" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                                </div>
                                <div class="md:col-span-2 lg:col-span-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">éæ•å²</label>
                                    <textarea id="patientAllergies" placeholder="è«‹è©³ç´°è¨˜éŒ„è—¥ç‰©éæ•æˆ–é£Ÿç‰©éæ•å²" rows="2" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                                </div>
                                <div class="md:col-span-2 lg:col-span-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ç—…å²åŠå‚™è¨»</label>
                                    <textarea id="patientHistory" placeholder="è«‹è¨˜éŒ„é‡è¦ç—…å²ã€å®¶æ—ç—…å²ã€æ…¢æ€§ç–¾ç—…ç­‰" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-gray-200">
                                <button onclick="hideAddPatientForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                                    å–æ¶ˆ
                                </button>
                                <button onclick="savePatient()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200">
                                    <span id="saveButtonText">å„²å­˜</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç—…äººåˆ—è¡¨ -->
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ç·¨è™Ÿ</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">å§“å</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">å¹´é½¡</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">æ€§åˆ¥</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">é›»è©±</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">æœ€å¾Œå°±è¨º</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="patientList" class="divide-y divide-gray-200">
                            <!-- ç—…äººè³‡æ–™æœƒå‹•æ…‹è¼‰å…¥ -->
                        </tbody>
                    </table>
                </div>

                <!-- ç—…äººè©³ç´°è³‡æ–™å½ˆçª— -->
                <div id="patientDetailModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
                            <h3 class="text-xl font-bold text-gray-800">ç—…äººè©³ç´°è³‡æ–™</h3>
                            <button onclick="closePatientDetail()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                        </div>
                        <div id="patientDetailContent" class="p-6">
                            <!-- è©³ç´°å…§å®¹æœƒå‹•æ…‹è¼‰å…¥ -->
                        </div>
                    </div>
                </div>

                <!-- ç—…äººç—…æ­·æŸ¥çœ‹å½ˆçª— -->
                <div id="patientHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                            <h3 class="text-xl font-bold text-gray-800">ç—…äººç—…æ­·è¨˜éŒ„</h3>
                            <button onclick="closePatientHistory()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                        </div>
                        <div id="patientHistoryContent" class="p-6">
                            <!-- ç—…æ­·å…§å®¹æœƒå‹•æ…‹è¼‰å…¥ -->
                        </div>
                    </div>
                </div>

                <!-- åˆªé™¤æ›è™Ÿç¢ºèªå½ˆçª— -->
                <div id="deleteAppointmentModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
                        <div class="bg-red-600 text-white px-6 py-4 rounded-t-xl">
                            <div class="flex items-center">
                                <span class="text-2xl mr-3">âš ï¸</span>
                                <h3 class="text-xl font-bold">ç¢ºèªåˆªé™¤æ›è™Ÿ</h3>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <div class="mb-4">
                                <div class="text-gray-700 mb-2">æ‚¨å³å°‡åˆªé™¤ä»¥ä¸‹æ›è™Ÿè¨˜éŒ„ï¼š</div>
                                <div id="deleteAppointmentInfo" class="bg-gray-50 rounded-lg p-4 border-l-4 border-red-400">
                                    <!-- æ›è™Ÿè³‡è¨Šæœƒå‹•æ…‹è¼‰å…¥ -->
                                </div>
                            </div>
                            
                            <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-4">
                                <div class="flex items-start">
                                    <span class="text-red-500 mr-2 mt-0.5">âš ï¸</span>
                                    <div class="text-sm text-red-700">
                                        <div class="font-medium mb-1">æ³¨æ„äº‹é …ï¼š</div>
                                        <ul class="list-disc list-inside space-y-1">
                                            <li>æ­¤æ“ä½œç„¡æ³•å¾©åŸ</li>
                                            <li>æ›è™Ÿè¨˜éŒ„å°‡è¢«æ°¸ä¹…åˆªé™¤</li>
                                            <li>å¦‚æœå·²æœ‰è¨ºç—‡è¨˜éŒ„ï¼Œå»ºè­°æ”¹ç‚ºå®Œæˆç‹€æ…‹</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex space-x-3">
                                <button onclick="closeDeleteAppointmentModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg transition duration-200">
                                    å–æ¶ˆ
                                </button>
                                <button onclick="confirmDeleteAppointment()" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                    ç¢ºèªåˆªé™¤
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¨ºç—‡ç³»çµ± -->
            <div id="consultationSystem" class="hidden bg-white rounded-xl shadow-lg p-6">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">æ›è™Ÿè¨ºç—‡ç³»çµ±</h2>
                    <p class="text-gray-600 mt-2">ç°¡æ½”çš„æ›è™Ÿæµç¨‹ç®¡ç†</p>
                </div>
                
                <!-- ç—…äººæœç´¢æ›è™Ÿ -->
                <div class="bg-gradient-to-r from-blue-50 to-green-50 rounded-lg p-6 mb-6">
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold text-gray-800 flex items-center mb-2">
                            <span class="mr-2">ğŸ”</span>æœç´¢ç—…äººæ›è™Ÿ
                        </h3>
                        <p class="text-sm text-gray-600">è«‹è¼¸å…¥ç—…äººå§“åã€ç·¨è™Ÿæˆ–é›»è©±é€²è¡Œæœç´¢</p>
                    </div>
                    
                    <div class="flex gap-3">
                        <div class="flex-1 relative">
                            <input type="text" id="patientSearchInput" placeholder="æœå°‹ç—…äººå§“åã€ç·¨è™Ÿæˆ–é›»è©±..." 
                                   class="w-full border border-gray-300 rounded-lg px-4 py-3 pr-10 focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                   oninput="searchPatientsForRegistration()">
                            <span class="absolute right-3 top-3.5 text-gray-400">ğŸ”</span>
                        </div>
                        <button onclick="clearPatientSearch()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-lg transition duration-200">
                            æ¸…é™¤
                        </button>
                    </div>
                    
                    <!-- æœç´¢çµæœ -->
                    <div id="patientSearchResults" class="mt-4 hidden">
                        <div class="bg-white rounded-lg border border-gray-200 max-h-64 overflow-y-auto">
                            <div id="searchResultsList" class="divide-y divide-gray-200">
                                <!-- æœç´¢çµæœæœƒå‹•æ…‹è¼‰å…¥ -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ›è™Ÿå½ˆçª— -->
                <div id="registrationModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
                        <div class="bg-green-600 text-white px-6 py-4 rounded-t-xl">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-bold">ç—…äººæ›è™Ÿ</h3>
                                <button onclick="closeRegistrationModal()" class="text-white hover:text-gray-200 text-2xl">Ã—</button>
                            </div>
                        </div>
                        
                        <div class="p-6 space-y-4">
                            <!-- é¸ä¸­çš„ç—…äººè³‡è¨Š -->
                            <div class="bg-blue-50 rounded-lg p-4">
                                <div class="flex items-center mb-2">
                                    <span class="mr-2">ğŸ‘¤</span>
                                    <span class="font-semibold text-gray-700">ç—…äººè³‡è¨Š</span>
                                </div>
                                <div id="selectedPatientInfo" class="text-sm text-gray-600">
                                    <!-- ç—…äººè³‡è¨Šæœƒå‹•æ…‹è¼‰å…¥ -->
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <span class="mr-2">â°</span>æ›è™Ÿæ™‚é–“
                                </label>
                                <input type="datetime-local" id="appointmentDateTime" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <span class="mr-2">ğŸ“</span>ä¸»è¨´ç—‡ç‹€
                                </label>
                                <textarea id="quickChiefComplaint" placeholder="è«‹ç°¡è¿°ç—…äººçš„ä¸»è¦ç—‡ç‹€..." rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                            </div>
                            
                            <div class="flex space-x-3 pt-4">
                                <button onclick="closeRegistrationModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg transition duration-200">
                                    å–æ¶ˆ
                                </button>
                                <button onclick="confirmRegistration()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                    ç¢ºèªæ›è™Ÿ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ä»Šæ—¥æ›è™Ÿåˆ—è¡¨ -->
                <div class="bg-white border border-gray-200 rounded-lg">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 rounded-t-lg">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                                <span class="mr-2">ğŸ“…</span>ä»Šæ—¥æ›è™Ÿåˆ—è¡¨
                            </h3>
                            <div class="text-sm text-gray-600">
                                ç¸½è¨ˆï¼š<span id="todayTotal" class="font-semibold text-blue-600">0</span> äºº
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">åºè™Ÿ</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ç—…äººå§“å</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">æ›è™Ÿæ™‚é–“</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ä¸»è¨´ç—‡ç‹€</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ç‹€æ…‹</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="todayAppointmentsList" class="divide-y divide-gray-200">
                                    <!-- æ›è™Ÿåˆ—è¡¨æœƒå‹•æ…‹è¼‰å…¥ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- è¨ºç—‡è¡¨å–®å€åŸŸ -->
                <div id="consultationForm" class="hidden bg-white border border-gray-200 rounded-lg mt-6">
                    <div class="bg-green-600 text-white px-6 py-4 rounded-t-lg">
                        <h3 class="text-xl font-bold">è¨ºç—‡è¨˜éŒ„</h3>
                    </div>
                    
                    <div class="p-6">
                        <!-- ç—…äººè³‡è¨Š -->
                        <div class="bg-blue-50 rounded-lg p-4 mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                <div>
                                    <span class="font-medium">ç—…äººï¼š</span>
                                    <span id="formPatientName" class="text-blue-600 font-semibold"></span>
                                </div>
                                <div>
                                    <span class="font-medium">æ›è™Ÿæ™‚é–“ï¼š</span>
                                    <span id="formAppointmentTime"></span>
                                </div>
                                <div>
                                    <span class="font-medium">ä¸»è¨´ï¼š</span>
                                    <span id="formChiefComplaint"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- è¨ºç—‡è¡¨å–® -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- å·¦å´ -->
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        ä¸»è¨´ *
                                    </label>
                                    <textarea id="formSymptoms" placeholder="ç—…äººä¸»è¦ä¸é©ç—‡ç‹€ã€ç™¼ç—…æ™‚é–“ã€ç—‡ç‹€ç‰¹é»ç­‰..." rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        èˆŒè±¡
                                    </label>
                                    <textarea id="formTongue" placeholder="èˆŒè³ªã€èˆŒè‹”ã€èˆŒå½¢ç­‰..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        è„ˆè±¡
                                    </label>
                                    <textarea id="formPulse" placeholder="è„ˆä½ã€è„ˆç‡ã€è„ˆåŠ›ã€è„ˆå½¢ç­‰..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        ç¾ç—…å²
                                    </label>
                                    <textarea id="formCurrentHistory" placeholder="ç™¼ç—…ç¶“éã€ç—‡ç‹€è®ŠåŒ–ã€æ²»ç™‚ç¶“éç­‰..." rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                            </div>
                            
                            <!-- å³å´ -->
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        ä¸­é†«è¨ºæ–· *
                                    </label>
                                    <textarea id="formDiagnosis" placeholder="ä¸­é†«ç—…åè¨ºæ–·..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        è­‰å‹è¨ºæ–· *
                                    </label>
                                    <textarea id="formSyndrome" placeholder="è¾¨è­‰åˆ†å‹ã€ç—…æ©Ÿåˆ†æ..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        è™•æ–¹å…§å®¹ *
                                    </label>
                                    <textarea id="formPrescription" placeholder="æ–¹åŠ‘åç¨±ã€è—¥ç‰©çµ„æˆã€åŠ‘é‡ç­‰..." rows="4" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        æœç”¨æ–¹æ³•
                                    </label>
                                    <textarea id="formUsage" placeholder="ç…ç…®æ–¹æ³•ã€æœç”¨æ™‚é–“ã€åŠ‘é‡ç­‰..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        ç™‚ç¨‹
                                    </label>
                                    <input type="text" id="formTreatmentCourse" placeholder="ä¾‹ï¼š7å¤©ã€2é€±ã€1å€‹æœˆç­‰..." class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        é†«å›‘åŠæ³¨æ„äº‹é …
                                    </label>
                                    <textarea id="formInstructions" placeholder="é£²é£Ÿå®œå¿Œã€ç”Ÿæ´»èª¿è­·ã€æ³¨æ„äº‹é …ç­‰..." rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- è¤‡è¨ºæ™‚é–“ -->
                        <div class="mt-6 pt-4 border-t border-gray-200">
                            <div class="max-w-md">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    è¤‡è¨ºæ™‚é–“
                                </label>
                                <input type="datetime-local" id="formFollowUpDate" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <p class="text-xs text-gray-500 mt-1">å»ºè­°ç—…äººä¸‹æ¬¡å›è¨ºçš„æ™‚é–“</p>
                            </div>
                        </div>
                        
                        <!-- æ“ä½œæŒ‰éˆ• -->
                        <div class="flex justify-end space-x-3 mt-6 pt-4 border-t border-gray-200">
                            <button onclick="saveConsultation()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200">
                                å®Œæˆè¨ºç—‡
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç³»çµ±ç®¡ç† -->
            <div id="systemManagement" class="hidden bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">ç³»çµ±ç®¡ç†</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">è¨ºæ‰€çµ±è¨ˆ</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span>ç¸½ç—…äººæ•¸ï¼š</span>
                                <span id="totalPatients" class="font-semibold">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>ä»Šæ—¥è¨ºç—‡ï¼š</span>
                                <span id="todayConsultations" class="font-semibold">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>æœ¬æœˆè¨ºç—‡ï¼š</span>
                                <span id="monthlyConsultations" class="font-semibold">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">è³‡æ–™ç®¡ç†</h3>
                        <div class="space-y-3">
                            <button onclick="exportData()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                åŒ¯å‡ºè³‡æ–™
                            </button>
                            <button onclick="backupData()" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                å‚™ä»½è³‡æ–™
                            </button>
                            <button onclick="clearData()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                æ¸…é™¤è³‡æ–™
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ç³»çµ±è³‡æ–™å„²å­˜
        let currentUser = null;
        
        // æµ®å‹•æç¤ºåŠŸèƒ½
        function showToast(message, type = 'info') {
            // ç§»é™¤ç¾æœ‰çš„æç¤º
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // å‰µå»ºæ–°çš„æç¤º
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            // è¨­ç½®åœ–æ¨™
            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
                info: 'â„¹ï¸'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-content">${message}</div>
            `;
            
            // æ·»åŠ åˆ°é é¢
            document.body.appendChild(toast);
            
            // é¡¯ç¤ºå‹•ç•«
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // 2ç§’å¾Œæ·¡å‡ºä¸¦ç§»é™¤
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 2000);
        }
        
        // è¨ˆç®—å¹´é½¡å‡½æ•¸
        function calculateAge(birthDate) {
            const birth = new Date(birthDate);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            
            return age;
        }
        
        // æ ¼å¼åŒ–å¹´é½¡é¡¯ç¤º
        function formatAge(birthDate) {
            if (!birthDate) return 'æœªçŸ¥';
            
            const birth = new Date(birthDate);
            const today = new Date();
            
            let years = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                years--;
            }
            
            if (years > 0) {
                return `${years}æ­²`;
            } else {
                // æœªæ»¿ä¸€æ­²çš„å¬°å¹¼å…’é¡¯ç¤ºæœˆæ•¸
                let months = today.getMonth() - birth.getMonth();
                let days = today.getDate() - birth.getDate();
                
                if (days < 0) {
                    months--;
                    const lastMonth = new Date(today.getFullYear(), today.getMonth(), 0);
                    days += lastMonth.getDate();
                }
                
                if (months < 0) {
                    months += 12;
                }
                
                if (months > 0) {
                    return `${months}å€‹æœˆ`;
                } else {
                    return `${days}å¤©`;
                }
            }
        }
        
        // ç”Ÿæˆç—…äººç·¨è™Ÿå‡½æ•¸
        function generatePatientNumber() {
            const existingNumbers = patients
                .map(p => p.patientNumber)
                .filter(num => num && num.startsWith('P'))
                .map(num => parseInt(num.substring(1)))
                .filter(num => !isNaN(num));
            
            const maxNumber = existingNumbers.length > 0 ? Math.max(...existingNumbers) : 0;
            const newNumber = maxNumber + 1;
            return `P${newNumber.toString().padStart(3, '0')}`;
        }

        // é è¨­æ¸¬è©¦ç—…äººè³‡æ–™
        const defaultPatients = [
            {
                id: 1001,
                patientNumber: 'P001',
                name: 'ç‹å°æ˜',
                gender: 'ç”·',
                phone: '0912-345-678',
                birthDate: '1989-03-15',
                address: 'å°åŒ—å¸‚å¤§å®‰å€ä¿¡ç¾©è·¯å››æ®µ123è™Ÿ',
                history: 'é«˜è¡€å£“ç—…å²3å¹´ï¼Œå¶æœ‰é ­æšˆç—‡ç‹€',
                createdAt: new Date('2024-01-15').toISOString()
            },
            {
                id: 1002,
                patientNumber: 'P002',
                name: 'æç¾è¯',
                gender: 'å¥³',
                phone: '0923-456-789',
                birthDate: '1996-07-22',
                address: 'æ–°åŒ—å¸‚æ¿æ©‹å€ä¸­å±±è·¯äºŒæ®µ456è™Ÿ',
                history: 'ç¶“å¸¸æ€§å¤±çœ ï¼Œå·¥ä½œå£“åŠ›å¤§',
                createdAt: new Date('2024-01-20').toISOString()
            },
            {
                id: 1003,
                patientNumber: 'P003',
                name: 'å¼µå¿—å¼·',
                gender: 'ç”·',
                phone: '0934-567-890',
                birthDate: '1982-11-08',
                address: 'æ¡ƒåœ’å¸‚ä¸­å£¢å€ä¸­æ­£è·¯789è™Ÿ',
                history: 'æ…¢æ€§èƒƒç‚ï¼Œé£²é£Ÿä¸è¦å¾‹',
                createdAt: new Date('2024-02-01').toISOString()
            },
            {
                id: 1004,
                patientNumber: 'P004',
                name: 'é™³é›…å©·',
                gender: 'å¥³',
                phone: '0945-678-901',
                birthDate: '1993-05-12',
                address: 'å°ä¸­å¸‚è¥¿å±¯å€å°ç£å¤§é“ä¸‰æ®µ321è™Ÿ',
                history: 'æœˆç¶“ä¸èª¿ï¼Œç¶“å¸¸è…°é…¸èƒŒç—›',
                createdAt: new Date('2024-02-10').toISOString()
            },
            {
                id: 1005,
                patientNumber: 'P005',
                name: 'æ—å¤§å‰',
                gender: 'ç”·',
                phone: '0956-789-012',
                birthDate: '1969-12-03',
                address: 'é«˜é›„å¸‚å‰é‡‘å€ä¸­æ­£å››è·¯654è™Ÿ',
                history: 'ç³–å°¿ç—…æ‚£è€…ï¼Œéœ€å®šæœŸè¿½è¹¤è¡€ç³–',
                createdAt: new Date('2024-02-15').toISOString()
            }
        ];

        // åˆå§‹åŒ–ç—…äººè³‡æ–™ï¼ˆå¦‚æœæœ¬åœ°å„²å­˜ç‚ºç©ºå‰‡è¼‰å…¥é è¨­è³‡æ–™ï¼‰
        let patients = JSON.parse(localStorage.getItem('patients') || '[]');
        if (patients.length === 0) {
            patients = defaultPatients;
            localStorage.setItem('patients', JSON.stringify(patients));
        } else {
            // ç‚ºèˆŠè³‡æ–™è£œå……ç—…äººç·¨è™Ÿ
            let needsUpdate = false;
            patients.forEach(patient => {
                if (!patient.patientNumber) {
                    patient.patientNumber = generatePatientNumber();
                    needsUpdate = true;
                }
            });
            if (needsUpdate) {
                localStorage.setItem('patients', JSON.stringify(patients));
            }
        }
        
        let consultations = JSON.parse(localStorage.getItem('consultations') || '[]');

        // ç”¨æˆ¶æ¬Šé™è¨­å®š - æ‰€æœ‰ç”¨æˆ¶éƒ½æœ‰å®Œæ•´æ¬Šé™
        const userPermissions = {
            admin: ['patientManagement', 'consultationSystem', 'systemManagement'],
            doctor: ['patientManagement', 'consultationSystem', 'systemManagement'],
            assistant: ['patientManagement', 'consultationSystem', 'systemManagement']
        };

        // ç™»å…¥åŠŸèƒ½
        function login(role) {
            currentUser = role;
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainSystem').classList.remove('hidden');
            
            const roleNames = {
                admin: 'ç®¡ç†å“¡',
                doctor: 'é†«å¸«',
                assistant: 'è¨ºæ‰€åŠ©ç†'
            };
            
            document.getElementById('userRole').textContent = `ç•¶å‰ç”¨æˆ¶ï¼š${roleNames[role]}`;
            document.getElementById('sidebarUserRole').textContent = `ç•¶å‰ç”¨æˆ¶ï¼š${roleNames[role]}`;
            generateSidebarMenu();
            updateStatistics();
        }

        // å´é‚Šé¸å–®æ§åˆ¶
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        // ç™»å‡ºåŠŸèƒ½
        function logout() {
            currentUser = null;
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('mainSystem').classList.add('hidden');
            document.getElementById('sidebar').classList.add('-translate-x-full');
            document.getElementById('sidebarOverlay').classList.add('hidden');
            hideAllSections();
        }

        // ç”Ÿæˆå´é‚Šé¸å–®
        function generateSidebarMenu() {
            const menuContainer = document.getElementById('sidebarMenu');
            menuContainer.innerHTML = '';
            
            const menuItems = {
                patientManagement: { title: 'ç—…äººè³‡æ–™ç®¡ç†', icon: 'ğŸ‘¥', description: 'æ–°å¢ã€æŸ¥çœ‹ã€ç®¡ç†ç—…äººè³‡æ–™' },
                consultationSystem: { title: 'è¨ºç—‡ç³»çµ±', icon: 'ğŸ©º', description: 'è¨˜éŒ„ç—‡ç‹€ã€è¨ºæ–·ã€é–‹ç«‹è™•æ–¹' },
                systemManagement: { title: 'ç³»çµ±ç®¡ç†', icon: 'âš™ï¸', description: 'çµ±è¨ˆè³‡æ–™ã€å‚™ä»½åŒ¯å‡º' }
            };
            
            userPermissions[currentUser].forEach(permission => {
                const item = menuItems[permission];
                const button = document.createElement('button');
                button.className = 'w-full text-left p-4 rounded-lg hover:bg-gray-100 transition duration-200 border border-gray-200 mb-2';
                button.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-2xl mr-4">${item.icon}</span>
                        <div>
                            <div class="font-semibold text-gray-800">${item.title}</div>
                            <div class="text-sm text-gray-600">${item.description}</div>
                        </div>
                    </div>
                `;
                button.onclick = () => {
                    showSection(permission);
                    toggleSidebar();
                };
                menuContainer.appendChild(button);
            });
        }

        // é¡¯ç¤ºæŒ‡å®šå€åŸŸ
        function showSection(sectionId) {
            hideAllSections();
            document.getElementById('welcomePage').classList.add('hidden');
            document.getElementById(sectionId).classList.remove('hidden');
            
            if (sectionId === 'patientManagement') {
                loadPatientList();
            } else if (sectionId === 'consultationSystem') {
                loadConsultationPatients();
            }
        }

        // éš±è—æ‰€æœ‰å€åŸŸ
        function hideAllSections() {
            ['patientManagement', 'consultationSystem', 'systemManagement', 'welcomePage'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
        }

        // ç—…äººç®¡ç†åŠŸèƒ½
        let editingPatientId = null;
        let filteredPatients = [];
        
        // æ›´æ–°ç—…äººå¹´é½¡é¡¯ç¤º
        function updatePatientAge() {
            const birthDate = document.getElementById('patientBirthDate').value;
            const ageInput = document.getElementById('patientAge');
            
            if (birthDate) {
                const age = calculateAge(birthDate);
                ageInput.value = age;
            } else {
                ageInput.value = '';
            }
        }

        function showAddPatientForm() {
            editingPatientId = null;
            document.getElementById('formTitle').textContent = 'æ–°å¢ç—…äººè³‡æ–™';
            document.getElementById('saveButtonText').textContent = 'å„²å­˜';
            document.getElementById('addPatientModal').classList.remove('hidden');
            clearPatientForm();
        }

        function hideAddPatientForm() {
            document.getElementById('addPatientModal').classList.add('hidden');
            clearPatientForm();
            editingPatientId = null;
        }

        function clearPatientForm() {
            ['patientName', 'patientAge', 'patientGender', 'patientPhone', 'patientIdCard', 'patientBirthDate', 'patientAddress', 'patientAllergies', 'patientHistory'].forEach(id => {
                document.getElementById(id).value = '';
            });
        }

        function savePatient() {
            const patient = {
                id: editingPatientId || Date.now(),
                patientNumber: editingPatientId ? patients.find(p => p.id === editingPatientId).patientNumber : generatePatientNumber(),
                name: document.getElementById('patientName').value.trim(),
                age: document.getElementById('patientAge').value,
                gender: document.getElementById('patientGender').value,
                phone: document.getElementById('patientPhone').value.trim(),
                idCard: document.getElementById('patientIdCard').value.trim(),
                birthDate: document.getElementById('patientBirthDate').value,
                address: document.getElementById('patientAddress').value.trim(),
                allergies: document.getElementById('patientAllergies').value.trim(),
                history: document.getElementById('patientHistory').value.trim(),
                createdAt: editingPatientId ? patients.find(p => p.id === editingPatientId).createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            // é©—è­‰å¿…å¡«æ¬„ä½
            if (!patient.name || !patient.gender || !patient.phone || !patient.birthDate) {
                showToast('è«‹å¡«å¯«å¿…è¦è³‡æ–™ï¼ˆå§“åã€æ€§åˆ¥ã€é›»è©±ã€å‡ºç”Ÿæ—¥æœŸï¼‰ï¼', 'error');
                return;
            }

            // é©—è­‰å‡ºç”Ÿæ—¥æœŸ
            const birthDate = new Date(patient.birthDate);
            const today = new Date();
            if (birthDate > today) {
                showToast('å‡ºç”Ÿæ—¥æœŸä¸èƒ½æ™šæ–¼ä»Šå¤©ï¼', 'error');
                return;
            }

            // è¨ˆç®—å¹´é½¡
            const calculatedAge = calculateAge(patient.birthDate);
            if (calculatedAge > 120) {
                showToast('è«‹ç¢ºèªå‡ºç”Ÿæ—¥æœŸæ˜¯å¦æ­£ç¢ºï¼', 'error');
                return;
            }

            // é©—è­‰é›»è©±æ ¼å¼
            const phoneRegex = /^[0-9\-\+\(\)\s]+$/;
            if (!phoneRegex.test(patient.phone)) {
                showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»è©±è™Ÿç¢¼ï¼', 'error');
                return;
            }

            // é©—è­‰èº«åˆ†è­‰æ ¼å¼ï¼ˆå¦‚æœæœ‰å¡«å¯«ï¼‰
            if (patient.idCard) {
                const idRegex = /^[A-Z][12][0-9]{8}$/;
                if (!idRegex.test(patient.idCard)) {
                    showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„èº«åˆ†è­‰å­—è™Ÿæ ¼å¼ï¼ˆä¾‹ï¼šA123456789ï¼‰ï¼', 'error');
                    return;
                }
            }

            if (editingPatientId) {
                // æ›´æ–°ç¾æœ‰ç—…äºº
                const index = patients.findIndex(p => p.id === editingPatientId);
                patients[index] = patient;
                showToast('ç—…äººè³‡æ–™å·²æˆåŠŸæ›´æ–°ï¼', 'success');
            } else {
                // æ–°å¢ç—…äºº
                patients.push(patient);
                showToast('ç—…äººè³‡æ–™å·²æˆåŠŸæ–°å¢ï¼', 'success');
            }

            localStorage.setItem('patients', JSON.stringify(patients));
            loadPatientList();
            hideAddPatientForm();
            updateStatistics();
        }

        function loadPatientList() {
            const tbody = document.getElementById('patientList');
            const searchTerm = document.getElementById('searchPatient').value.toLowerCase();
            
            // éæ¿¾ç—…äººè³‡æ–™
            filteredPatients = patients.filter(patient => 
                patient.name.toLowerCase().includes(searchTerm) ||
                patient.phone.includes(searchTerm) ||
                (patient.idCard && patient.idCard.toLowerCase().includes(searchTerm)) ||
                (patient.patientNumber && patient.patientNumber.toLowerCase().includes(searchTerm))
            );

            tbody.innerHTML = '';

            if (filteredPatients.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                            ${searchTerm ? 'æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„ç—…äºº' : 'å°šç„¡ç—…äººè³‡æ–™'}
                        </td>
                    </tr>
                `;
                return;
            }

            filteredPatients.forEach(patient => {
                // è¨ˆç®—æœ€å¾Œå°±è¨ºæ—¥æœŸ
                const lastConsultation = consultations
                    .filter(c => c.patientId === patient.id)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                
                const lastVisitDate = lastConsultation 
                    ? new Date(lastConsultation.date).toLocaleDateString('zh-TW')
                    : 'æœªå°±è¨º';

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-blue-600 font-medium">${patient.patientNumber || 'æœªè¨­å®š'}</td>
                    <td class="px-4 py-3 text-sm text-gray-900 font-medium">${patient.name}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${formatAge(patient.birthDate)}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${patient.gender}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${patient.phone}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${lastVisitDate}</td>
                    <td class="px-4 py-3 text-sm space-x-2">
                        <button onclick="viewPatient(${patient.id})" class="text-blue-600 hover:text-blue-800">æŸ¥çœ‹</button>
                        <button onclick="editPatient(${patient.id})" class="text-green-600 hover:text-green-800">ç·¨è¼¯</button>
                        <button onclick="deletePatient(${patient.id})" class="text-red-600 hover:text-red-800">åˆªé™¤</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function editPatient(id) {
            const patient = patients.find(p => p.id === id);
            if (!patient) return;

            editingPatientId = id;
            document.getElementById('formTitle').textContent = 'ç·¨è¼¯ç—…äººè³‡æ–™';
            document.getElementById('saveButtonText').textContent = 'æ›´æ–°';
            
            // å¡«å…¥ç¾æœ‰è³‡æ–™
            document.getElementById('patientName').value = patient.name || '';
            document.getElementById('patientGender').value = patient.gender || '';
            document.getElementById('patientPhone').value = patient.phone || '';
            document.getElementById('patientIdCard').value = patient.idCard || '';
            document.getElementById('patientBirthDate').value = patient.birthDate || '';
            document.getElementById('patientAddress').value = patient.address || '';
            document.getElementById('patientAllergies').value = patient.allergies || '';
            document.getElementById('patientHistory').value = patient.history || '';
            
            // è‡ªå‹•è¨ˆç®—å¹´é½¡
            updatePatientAge();
            
            document.getElementById('addPatientModal').classList.remove('hidden');
        }

        function deletePatient(id) {
            const patient = patients.find(p => p.id === id);
            if (!patient) return;

            if (confirm(`ç¢ºå®šè¦åˆªé™¤ç—…äººã€Œ${patient.name}ã€çš„è³‡æ–™å—ï¼Ÿ\n\næ³¨æ„ï¼šç›¸é—œçš„è¨ºç—‡è¨˜éŒ„ä¹Ÿæœƒä¸€ä½µåˆªé™¤ï¼`)) {
                // åˆªé™¤ç—…äººè³‡æ–™
                patients = patients.filter(p => p.id !== id);
                // åˆªé™¤ç›¸é—œè¨ºç—‡è¨˜éŒ„
                consultations = consultations.filter(c => c.patientId !== id);
                
                localStorage.setItem('patients', JSON.stringify(patients));
                localStorage.setItem('consultations', JSON.stringify(consultations));
                
                loadPatientList();
                updateStatistics();
                showToast('ç—…äººè³‡æ–™åŠç›¸é—œè¨ºç—‡è¨˜éŒ„å·²åˆªé™¤ï¼', 'success');
            }
        }

        function viewPatient(id) {
            const patient = patients.find(p => p.id === id);
            if (!patient) return;

            // ç²å–è©²ç—…äººçš„è¨ºç—‡è¨˜éŒ„
            const patientConsultations = consultations
                .filter(c => c.patientId === id)
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            const content = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <h4 class="text-lg font-semibold text-gray-800 border-b pb-2">åŸºæœ¬è³‡æ–™</h4>
                        <div class="space-y-2">
                            <div><span class="font-medium">ç—…äººç·¨è™Ÿï¼š</span><span class="text-blue-600 font-semibold">${patient.patientNumber || 'æœªè¨­å®š'}</span></div>
                            <div><span class="font-medium">å§“åï¼š</span>${patient.name}</div>
                            <div><span class="font-medium">å¹´é½¡ï¼š</span>${formatAge(patient.birthDate)}</div>
                            <div><span class="font-medium">æ€§åˆ¥ï¼š</span>${patient.gender}</div>
                            <div><span class="font-medium">é›»è©±ï¼š</span>${patient.phone}</div>
                            ${patient.idCard ? `<div><span class="font-medium">èº«åˆ†è­‰ï¼š</span>${patient.idCard}</div>` : ''}
                            ${patient.birthDate ? `<div><span class="font-medium">å‡ºç”Ÿæ—¥æœŸï¼š</span>${new Date(patient.birthDate).toLocaleDateString('zh-TW')}</div>` : ''}
                            ${patient.address ? `<div><span class="font-medium">åœ°å€ï¼š</span>${patient.address}</div>` : ''}
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <h4 class="text-lg font-semibold text-gray-800 border-b pb-2">é†«ç™‚è³‡è¨Š</h4>
                        <div class="space-y-2">
                            ${patient.allergies ? `<div><span class="font-medium">éæ•å²ï¼š</span><div class="mt-1 p-2 bg-red-50 rounded text-sm">${patient.allergies}</div></div>` : ''}
                            ${patient.history ? `<div><span class="font-medium">ç—…å²ï¼š</span><div class="mt-1 p-2 bg-gray-50 rounded text-sm">${patient.history}</div></div>` : ''}
                            <div><span class="font-medium">å»ºæª”æ—¥æœŸï¼š</span>${new Date(patient.createdAt).toLocaleDateString('zh-TW')}</div>
                            ${patient.updatedAt ? `<div><span class="font-medium">æ›´æ–°æ—¥æœŸï¼š</span>${new Date(patient.updatedAt).toLocaleDateString('zh-TW')}</div>` : ''}
                        </div>
                    </div>
                </div>
                
                <div class="mt-6">
                    <h4 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-4">è¨ºç—‡è¨˜éŒ„ (${patientConsultations.length}æ¬¡)</h4>
                    ${patientConsultations.length > 0 ? `
                        <div class="space-y-3 max-h-64 overflow-y-auto">
                            ${patientConsultations.map(consultation => `
                                <div class="border border-gray-200 rounded-lg p-3">
                                    <div class="flex justify-between items-start mb-2">
                                        <div class="text-sm font-medium">${new Date(consultation.date).toLocaleDateString('zh-TW')} ${new Date(consultation.date).toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'})}</div>
                                        <div class="text-xs text-gray-500">é†«å¸«ï¼š${consultation.doctor}</div>
                                    </div>
                                    <div class="text-sm text-gray-700">
                                        <div><span class="font-medium">ä¸»è¨´ï¼š</span>${consultation.symptoms || 'ç„¡è¨˜éŒ„'}</div>
                                        <div><span class="font-medium">è¨ºæ–·ï¼š</span>${consultation.diagnosis || 'ç„¡è¨˜éŒ„'}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<div class="text-gray-500 text-center py-4">å°šç„¡è¨ºç—‡è¨˜éŒ„</div>'}
                </div>
            `;

            document.getElementById('patientDetailContent').innerHTML = content;
            document.getElementById('patientDetailModal').classList.remove('hidden');
        }

        function closePatientDetail() {
            document.getElementById('patientDetailModal').classList.add('hidden');
        }

        // æŸ¥çœ‹ç—…äººç—…æ­·è¨˜éŒ„
        function viewPatientHistory(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) {
                showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ï¼', 'error');
                return;
            }

            // ç²å–è©²ç—…äººçš„æ‰€æœ‰è¨ºç—‡è¨˜éŒ„
            const patientConsultations = consultations
                .filter(c => c.patientId === patientId)
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            const content = `
                <div class="mb-6">
                    <!-- ç—…äººåŸºæœ¬è³‡è¨Š -->
                    <div class="bg-blue-50 rounded-lg p-4 mb-6">
                        <div class="flex items-center mb-3">
                            <span class="text-2xl mr-3">ğŸ‘¤</span>
                            <h4 class="text-lg font-semibold text-gray-800">ç—…äººåŸºæœ¬è³‡è¨Š</h4>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                            <div><span class="font-medium">å§“åï¼š</span><span class="text-blue-600 font-semibold">${patient.name}</span></div>
                            <div><span class="font-medium">ç·¨è™Ÿï¼š</span>${patient.patientNumber || 'æœªè¨­å®š'}</div>
                            <div><span class="font-medium">å¹´é½¡ï¼š</span>${formatAge(patient.birthDate)}</div>
                            <div><span class="font-medium">æ€§åˆ¥ï¼š</span>${patient.gender}</div>
                            <div><span class="font-medium">é›»è©±ï¼š</span>${patient.phone}</div>
                            <div><span class="font-medium">å»ºæª”æ—¥æœŸï¼š</span>${new Date(patient.createdAt).toLocaleDateString('zh-TW')}</div>
                        </div>
                        ${patient.allergies ? `
                            <div class="mt-3 p-3 bg-red-50 border border-red-200 rounded">
                                <div class="font-medium text-red-800 mb-1">âš ï¸ éæ•å²</div>
                                <div class="text-sm text-red-700">${patient.allergies}</div>
                            </div>
                        ` : ''}
                        ${patient.history ? `
                            <div class="mt-3 p-3 bg-gray-50 border border-gray-200 rounded">
                                <div class="font-medium text-gray-800 mb-1">ğŸ“‹ ç—…å²</div>
                                <div class="text-sm text-gray-700">${patient.history}</div>
                            </div>
                        ` : ''}
                    </div>

                    <!-- è¨ºç—‡è¨˜éŒ„ -->
                    <div>
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-semibold text-gray-800 flex items-center">
                                <span class="mr-2">ğŸ“‹</span>è¨ºç—‡è¨˜éŒ„
                            </h4>
                            <div class="text-sm text-gray-600">
                                å…± <span class="font-semibold text-blue-600">${patientConsultations.length}</span> æ¬¡è¨ºç—‡
                            </div>
                        </div>
                        
                        ${patientConsultations.length > 0 ? `
                            <div class="space-y-4">
                                ${patientConsultations.map((consultation, index) => `
                                    <div class="border border-gray-200 rounded-lg overflow-hidden">
                                        <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                                            <div class="flex justify-between items-center">
                                                <div class="flex items-center">
                                                    <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full mr-3">
                                                        ç¬¬ ${patientConsultations.length - index} æ¬¡
                                                    </span>
                                                    <div class="font-medium text-gray-900">
                                                        ${new Date(consultation.date).toLocaleDateString('zh-TW')} 
                                                        ${new Date(consultation.date).toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'})}
                                                    </div>
                                                </div>
                                                <div class="text-xs text-gray-500">
                                                    é†«å¸«ï¼š${consultation.doctor || 'æœªè¨˜éŒ„'}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="p-4">
                                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                                <!-- å·¦å´ï¼šç—‡ç‹€èˆ‡æª¢æŸ¥ -->
                                                <div class="space-y-3">
                                                    ${consultation.symptoms ? `
                                                        <div>
                                                            <div class="text-sm font-medium text-gray-700 mb-1">ä¸»è¨´ç—‡ç‹€</div>
                                                            <div class="text-sm text-gray-900 bg-gray-50 p-2 rounded">${consultation.symptoms}</div>
                                                        </div>
                                                    ` : ''}
                                                    
                                                    ${consultation.currentHistory ? `
                                                        <div>
                                                            <div class="text-sm font-medium text-gray-700 mb-1">ç¾ç—…å²</div>
                                                            <div class="text-sm text-gray-900 bg-gray-50 p-2 rounded">${consultation.currentHistory}</div>
                                                        </div>
                                                    ` : ''}
                                                    
                                                    <div class="grid grid-cols-2 gap-3">
                                                        ${consultation.tongue ? `
                                                            <div>
                                                                <div class="text-sm font-medium text-gray-700 mb-1">èˆŒè±¡</div>
                                                                <div class="text-sm text-gray-900 bg-pink-50 p-2 rounded">${consultation.tongue}</div>
                                                            </div>
                                                        ` : ''}
                                                        
                                                        ${consultation.pulse ? `
                                                            <div>
                                                                <div class="text-sm font-medium text-gray-700 mb-1">è„ˆè±¡</div>
                                                                <div class="text-sm text-gray-900 bg-green-50 p-2 rounded">${consultation.pulse}</div>
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                                
                                                <!-- å³å´ï¼šè¨ºæ–·èˆ‡è™•æ–¹ -->
                                                <div class="space-y-3">
                                                    ${consultation.diagnosis ? `
                                                        <div>
                                                            <div class="text-sm font-medium text-gray-700 mb-1">ä¸­é†«è¨ºæ–·</div>
                                                            <div class="text-sm text-gray-900 bg-blue-50 p-2 rounded font-medium">${consultation.diagnosis}</div>
                                                        </div>
                                                    ` : ''}
                                                    
                                                    ${consultation.syndrome ? `
                                                        <div>
                                                            <div class="text-sm font-medium text-gray-700 mb-1">è­‰å‹è¨ºæ–·</div>
                                                            <div class="text-sm text-gray-900 bg-purple-50 p-2 rounded">${consultation.syndrome}</div>
                                                        </div>
                                                    ` : ''}
                                                    
                                                    ${consultation.prescription ? `
                                                        <div>
                                                            <div class="text-sm font-medium text-gray-700 mb-1">è™•æ–¹å…§å®¹</div>
                                                            <div class="text-sm text-gray-900 bg-yellow-50 p-2 rounded border-l-4 border-yellow-400">${consultation.prescription}</div>
                                                        </div>
                                                    ` : ''}
                                                    
                                                    <div class="grid grid-cols-1 gap-2">
                                                        ${consultation.usage ? `
                                                            <div>
                                                                <div class="text-xs font-medium text-gray-600 mb-1">æœç”¨æ–¹æ³•</div>
                                                                <div class="text-xs text-gray-800 bg-gray-50 p-2 rounded">${consultation.usage}</div>
                                                            </div>
                                                        ` : ''}
                                                        
                                                        ${consultation.treatmentCourse ? `
                                                            <div>
                                                                <div class="text-xs font-medium text-gray-600 mb-1">ç™‚ç¨‹</div>
                                                                <div class="text-xs text-gray-800 bg-gray-50 p-2 rounded">${consultation.treatmentCourse}</div>
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            ${consultation.instructions ? `
                                                <div class="mt-3 pt-3 border-t border-gray-200">
                                                    <div class="text-sm font-medium text-gray-700 mb-1">é†«å›‘åŠæ³¨æ„äº‹é …</div>
                                                    <div class="text-sm text-gray-900 bg-orange-50 p-2 rounded border-l-4 border-orange-400">${consultation.instructions}</div>
                                                </div>
                                            ` : ''}
                                            
                                            ${consultation.followUpDate ? `
                                                <div class="mt-3 pt-3 border-t border-gray-200">
                                                    <div class="text-sm font-medium text-gray-700 mb-1">å»ºè­°è¤‡è¨ºæ™‚é–“</div>
                                                    <div class="text-sm text-blue-600 font-medium">
                                                        ğŸ“… ${new Date(consultation.followUpDate).toLocaleString('zh-TW')}
                                                    </div>
                                                </div>
                                            ` : ''}
                                            
                                            ${consultation.updatedAt ? `
                                                <div class="mt-3 pt-2 border-t border-gray-100">
                                                    <div class="text-xs text-gray-500">
                                                        æœ€å¾Œæ›´æ–°ï¼š${new Date(consultation.updatedAt).toLocaleString('zh-TW')} 
                                                        ${consultation.updatedBy ? `(${consultation.updatedBy})` : ''}
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="text-center py-12">
                                <div class="text-6xl mb-4">ğŸ“‹</div>
                                <div class="text-gray-500 text-lg">å°šç„¡è¨ºç—‡è¨˜éŒ„</div>
                                <div class="text-gray-400 text-sm mt-2">ç—…äººé¦–æ¬¡å°±è¨ºæ™‚æœƒåœ¨æ­¤é¡¯ç¤ºè¨ºç—‡è¨˜éŒ„</div>
                            </div>
                        `}
                    </div>
                </div>
            `;

            document.getElementById('patientHistoryContent').innerHTML = content;
            document.getElementById('patientHistoryModal').classList.remove('hidden');
        }

        // é—œé–‰ç—…äººç—…æ­·å½ˆçª—
        function closePatientHistory() {
            document.getElementById('patientHistoryModal').classList.add('hidden');
        }

        // æœå°‹åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchPatient');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    loadPatientList();
                });
            }
        });

        // è¨ºç—‡ç³»çµ±åŠŸèƒ½
        let appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
        let currentConsultingAppointmentId = null;
        let selectedPatientForRegistration = null;
        
        function loadConsultationPatients() {
            loadTodayAppointments();
            clearPatientSearch();
        }
        
        // æœç´¢ç—…äººé€²è¡Œæ›è™Ÿ
        function searchPatientsForRegistration() {
            const searchTerm = document.getElementById('patientSearchInput').value.trim().toLowerCase();
            const resultsContainer = document.getElementById('patientSearchResults');
            const resultsList = document.getElementById('searchResultsList');
            
            if (searchTerm.length < 1) {
                resultsContainer.classList.add('hidden');
                return;
            }
            
            // æœç´¢åŒ¹é…çš„ç—…äºº
            const matchedPatients = patients.filter(patient => 
                patient.name.toLowerCase().includes(searchTerm) ||
                patient.phone.includes(searchTerm) ||
                (patient.patientNumber && patient.patientNumber.toLowerCase().includes(searchTerm))
            );
            
            if (matchedPatients.length === 0) {
                resultsList.innerHTML = `
                    <div class="p-4 text-center text-gray-500">
                        æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„ç—…äºº
                    </div>
                `;
                resultsContainer.classList.remove('hidden');
                return;
            }
            
            // é¡¯ç¤ºæœç´¢çµæœ
            resultsList.innerHTML = matchedPatients.map(patient => `
                <div class="p-4 hover:bg-gray-50 cursor-pointer transition duration-200" onclick="selectPatientForRegistration(${patient.id})">
                    <div>
                        <div class="font-semibold text-gray-900">${patient.name}</div>
                        <div class="text-sm text-gray-600">ç·¨è™Ÿï¼š${patient.patientNumber} | å¹´é½¡ï¼š${formatAge(patient.birthDate)} | æ€§åˆ¥ï¼š${patient.gender}</div>
                        <div class="text-sm text-gray-500">é›»è©±ï¼š${patient.phone}</div>
                    </div>
                </div>
            `).join('');
            
            resultsContainer.classList.remove('hidden');
        }
        
        // é¸æ“‡ç—…äººé€²è¡Œæ›è™Ÿ
        function selectPatientForRegistration(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) return;
            
            selectedPatientForRegistration = patient;
            showRegistrationModal(patient);
        }
        
        // æ¸…é™¤ç—…äººæœç´¢
        function clearPatientSearch() {
            document.getElementById('patientSearchInput').value = '';
            document.getElementById('patientSearchResults').classList.add('hidden');
            selectedPatientForRegistration = null;
        }
        

        
        // é¡¯ç¤ºæ›è™Ÿå½ˆçª—
        function showRegistrationModal(patient) {
            if (!patient) return;
            
            // é¡¯ç¤ºé¸ä¸­çš„ç—…äººè³‡è¨Š
            document.getElementById('selectedPatientInfo').innerHTML = `
                <div class="space-y-1">
                    <div><span class="font-medium">å§“åï¼š</span>${patient.name}</div>
                    <div><span class="font-medium">ç·¨è™Ÿï¼š</span>${patient.patientNumber}</div>
                    <div><span class="font-medium">å¹´é½¡ï¼š</span>${formatAge(patient.birthDate)} | <span class="font-medium">æ€§åˆ¥ï¼š</span>${patient.gender}</div>
                    <div><span class="font-medium">é›»è©±ï¼š</span>${patient.phone}</div>
                </div>
            `;
            
            // è¨­ç½®é è¨­æ›è™Ÿæ™‚é–“ç‚ºç•¶å‰æ™‚é–“ï¼ˆåŠ 5åˆ†é˜é¿å…æ™‚é–“éæœŸï¼‰
            const now = new Date();
            now.setMinutes(now.getMinutes() + 5); // åŠ 5åˆ†é˜
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const localDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
            
            document.getElementById('appointmentDateTime').value = localDateTime;
            
            clearRegistrationForm();
            document.getElementById('registrationModal').classList.remove('hidden');
        }
        
        // é—œé–‰æ›è™Ÿå½ˆçª—
        function closeRegistrationModal() {
            document.getElementById('registrationModal').classList.add('hidden');
            clearRegistrationForm();
            selectedPatientForRegistration = null;
        }
        
        // æ¸…ç©ºæ›è™Ÿè¡¨å–®
        function clearRegistrationForm() {
            document.getElementById('quickChiefComplaint').value = '';
        }
        
        // ç¢ºèªæ›è™Ÿ
        function confirmRegistration() {
            if (!selectedPatientForRegistration) {
                showToast('ç³»çµ±éŒ¯èª¤ï¼šæœªé¸æ“‡ç—…äººï¼', 'error');
                return;
            }
            
            const appointmentDateTime = document.getElementById('appointmentDateTime').value;
            const chiefComplaint = document.getElementById('quickChiefComplaint').value.trim();
            
            if (!appointmentDateTime) {
                showToast('è«‹é¸æ“‡æ›è™Ÿæ™‚é–“ï¼', 'error');
                return;
            }
            
            // é©—è­‰æ›è™Ÿæ™‚é–“ä¸èƒ½æ˜¯éå»æ™‚é–“ï¼ˆå…è¨±1åˆ†é˜çš„èª¤å·®ï¼‰
            const selectedTime = new Date(appointmentDateTime);
            const now = new Date();
            now.setMinutes(now.getMinutes() - 1); // å…è¨±1åˆ†é˜èª¤å·®
            if (selectedTime < now) {
                showToast('æ›è™Ÿæ™‚é–“ä¸èƒ½æ—©æ–¼ç¾åœ¨æ™‚é–“ï¼', 'error');
                return;
            }
            
            const appointment = {
                id: Date.now(),
                patientId: selectedPatientForRegistration.id,
                appointmentTime: selectedTime.toISOString(),
                chiefComplaint: chiefComplaint || 'ç„¡ç‰¹æ®Šä¸»è¨´',
                status: 'registered', // registered, waiting, consulting, completed
                createdAt: new Date().toISOString(),
                createdBy: currentUser
            };
            
            appointments.push(appointment);
            localStorage.setItem('appointments', JSON.stringify(appointments));
            
            showToast(`${selectedPatientForRegistration.name} æ›è™ŸæˆåŠŸï¼`, 'success');
            
            closeRegistrationModal();
            clearPatientSearch();
            loadTodayAppointments();
        }
        
        // è¼‰å…¥ä»Šæ—¥æ›è™Ÿåˆ—è¡¨
        function loadTodayAppointments() {
            const today = new Date().toDateString();
            const todayAppointments = appointments.filter(apt => 
                new Date(apt.appointmentTime).toDateString() === today
            ).sort((a, b) => new Date(a.appointmentTime) - new Date(b.appointmentTime));
            
            const tbody = document.getElementById('todayAppointmentsList');
            document.getElementById('todayTotal').textContent = todayAppointments.length;
            
            if (todayAppointments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            ä»Šæ—¥æš«ç„¡æ›è™Ÿè¨˜éŒ„
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = todayAppointments.map((appointment, index) => {
                const patient = patients.find(p => p.id === appointment.patientId);
                if (!patient) return '';
                
                const statusInfo = getStatusInfo(appointment.status);
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm text-gray-900">${index + 1}</td>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">
                            ${patient.name}
                            <div class="text-xs text-gray-500">${patient.patientNumber}</div>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900">
                            ${new Date(appointment.appointmentTime).toLocaleString('zh-TW', {
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900">
                            ${appointment.chiefComplaint || 'ç„¡'}
                        </td>
                        <td class="px-4 py-3">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusInfo.class}">
                                ${statusInfo.text}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm space-x-1">
                            ${getStatusUpdateButtons(appointment)}
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // ç²å–ç‹€æ…‹è³‡è¨Š
        function getStatusInfo(status) {
            const statusMap = {
                'registered': { text: 'å·²æ›è™Ÿ', class: 'bg-blue-100 text-blue-800' },
                'waiting': { text: 'å€™è¨ºä¸­', class: 'bg-yellow-100 text-yellow-800' },
                'consulting': { text: 'è¨ºç—‡ä¸­', class: 'bg-green-100 text-green-800' },
                'completed': { text: 'å·²å®Œæˆ', class: 'bg-gray-100 text-gray-800' }
            };
            return statusMap[status] || { text: 'æœªçŸ¥', class: 'bg-gray-100 text-gray-800' };
        }
        
        // ç²å–ç‹€æ…‹æ›´æ–°æŒ‰éˆ•
        function getStatusUpdateButtons(appointment) {
            // æ ¹æ“šç•¶å‰ç‹€æ…‹å’Œç”¨æˆ¶è§’è‰²é¡¯ç¤ºé©ç•¶çš„ç‹€æ…‹è½‰æ›æŒ‰éˆ•
            switch (appointment.status) {
                case 'registered':
                    // å·²æ›è™Ÿç‹€æ…‹ï¼šæ‰€æœ‰ç”¨æˆ¶éƒ½å¯ä»¥ç¢ºèªç—…äººåˆ°é”æˆ–åˆªé™¤æ›è™Ÿ
                    return `
                        <button onclick="confirmPatientArrival(${appointment.id})" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-xs transition duration-200">ç¢ºèªåˆ°é”</button>
                        <button onclick="viewPatientHistory(${appointment.patientId})" class="bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-xs transition duration-200 ml-1">æŸ¥çœ‹ç—…æ­·</button>
                        <button onclick="deleteAppointment(${appointment.id})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition duration-200 ml-1">åˆªé™¤æ›è™Ÿ</button>
                    `;
                    
                case 'waiting':
                    // å€™è¨ºä¸­ç‹€æ…‹ï¼šæ‰€æœ‰ç”¨æˆ¶éƒ½å¯ä»¥æ“ä½œ
                    return `
                        <button onclick="startConsultation(${appointment.id})" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs transition duration-200">é–‹å§‹è¨ºç—‡</button>
                        <button onclick="viewPatientHistory(${appointment.patientId})" class="bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-xs transition duration-200 ml-1">æŸ¥çœ‹ç—…æ­·</button>
                    `;
                    
                case 'consulting':
                    // è¨ºç—‡ä¸­ç‹€æ…‹ï¼šæ‰€æœ‰ç”¨æˆ¶éƒ½å¯ä»¥æ“ä½œ
                    return `
                        <span class="text-green-600 text-xs font-medium">è¨ºç—‡é€²è¡Œä¸­...</span>
                        <button onclick="viewPatientHistory(${appointment.patientId})" class="bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-xs transition duration-200 ml-1">æŸ¥çœ‹ç—…æ­·</button>
                    `;
                    
                case 'completed':
                    // å·²å®Œæˆç‹€æ…‹ï¼šå¯ä»¥ä¿®æ”¹ç—…æ­·æˆ–é‡æ–°è¨­ç‚ºå€™è¨º
                    return `
                        <button onclick="editMedicalRecord(${appointment.id})" class="bg-orange-500 hover:bg-orange-600 text-white px-2 py-1 rounded text-xs transition duration-200">ä¿®æ”¹ç—…æ­·</button>
                        <button onclick="viewPatientHistory(${appointment.patientId})" class="bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-xs transition duration-200 ml-1">æŸ¥çœ‹ç—…æ­·</button>
                        <button onclick="resetToWaiting(${appointment.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs transition duration-200 ml-1">é‡æ–°å€™è¨º</button>
                    `;
                    
                default:
                    return '<span class="text-gray-400 text-xs">ç‹€æ…‹ç•°å¸¸</span>';
            }
        }
        
        // ç¢ºèªç—…äººåˆ°é”ï¼ˆåŠ©ç†æ“ä½œï¼‰
        function confirmPatientArrival(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) {
                showToast('æ‰¾ä¸åˆ°æ›è™Ÿè¨˜éŒ„ï¼', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            
            if (appointment.status !== 'registered') {
                showToast('åªèƒ½ç¢ºèªå·²æ›è™Ÿç‹€æ…‹çš„ç—…äººåˆ°é”ï¼', 'warning');
                return;
            }
            
            appointment.status = 'waiting';
            appointment.arrivedAt = new Date().toISOString();
            appointment.confirmedBy = currentUser;
            
            localStorage.setItem('appointments', JSON.stringify(appointments));
            showToast(`${patient.name} å·²ç¢ºèªåˆ°é”ï¼Œé€²å…¥å€™è¨ºç‹€æ…‹ï¼`, 'success');
            loadTodayAppointments();
        }
        
        // å–æ¶ˆå€™è¨ºï¼ˆåŠ©ç†æ“ä½œï¼‰
        function cancelWaiting(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) {
                showToast('æ‰¾ä¸åˆ°æ›è™Ÿè¨˜éŒ„ï¼', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            
            if (confirm(`ç¢ºå®šè¦å–æ¶ˆ ${patient.name} çš„å€™è¨ºç‹€æ…‹å—ï¼Ÿ\nç—…äººå°‡å›åˆ°å·²æ›è™Ÿç‹€æ…‹ã€‚`)) {
                appointment.status = 'registered';
                delete appointment.arrivedAt;
                delete appointment.confirmedBy;
                
                localStorage.setItem('appointments', JSON.stringify(appointments));
                showToast(`${patient.name} å·²å–æ¶ˆå€™è¨ºï¼Œå›åˆ°å·²æ›è™Ÿç‹€æ…‹ï¼`, 'success');
                loadTodayAppointments();
            }
        }
        
        // é‡æ–°è¨­ç‚ºå€™è¨ºï¼ˆç®¡ç†å“¡æ“ä½œï¼‰
        function resetToWaiting(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) {
                showToast('æ‰¾ä¸åˆ°æ›è™Ÿè¨˜éŒ„ï¼', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            
            if (confirm(`ç¢ºå®šè¦å°‡ ${patient.name} é‡æ–°è¨­ç‚ºå€™è¨ºç‹€æ…‹å—ï¼Ÿ`)) {
                appointment.status = 'waiting';
                appointment.resetAt = new Date().toISOString();
                appointment.resetBy = currentUser;
                
                localStorage.setItem('appointments', JSON.stringify(appointments));
                showToast(`${patient.name} å·²é‡æ–°è¨­ç‚ºå€™è¨ºç‹€æ…‹ï¼`, 'success');
                loadTodayAppointments();
            }
        }
        
        // åˆªé™¤æ›è™Ÿè¨˜éŒ„
        let appointmentToDelete = null;
        
        function deleteAppointment(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) {
                showToast('æ‰¾ä¸åˆ°æ›è™Ÿè¨˜éŒ„ï¼', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            if (!patient) {
                showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ï¼', 'error');
                return;
            }
            
            appointmentToDelete = appointmentId;
            
            // é¡¯ç¤ºæ›è™Ÿè³‡è¨Š
            const statusInfo = getStatusInfo(appointment.status);
            document.getElementById('deleteAppointmentInfo').innerHTML = `
                <div class="space-y-2">
                    <div><span class="font-medium">ç—…äººå§“åï¼š</span>${patient.name}</div>
                    <div><span class="font-medium">ç—…äººç·¨è™Ÿï¼š</span>${patient.patientNumber}</div>
                    <div><span class="font-medium">æ›è™Ÿæ™‚é–“ï¼š</span>${new Date(appointment.appointmentTime).toLocaleString('zh-TW')}</div>
                    <div><span class="font-medium">ä¸»è¨´ç—‡ç‹€ï¼š</span>${appointment.chiefComplaint || 'ç„¡'}</div>
                    <div><span class="font-medium">ç›®å‰ç‹€æ…‹ï¼š</span><span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${statusInfo.class}">${statusInfo.text}</span></div>
                </div>
            `;
            
            document.getElementById('deleteAppointmentModal').classList.remove('hidden');
        }
        
        function closeDeleteAppointmentModal() {
            document.getElementById('deleteAppointmentModal').classList.add('hidden');
            appointmentToDelete = null;
        }
        
        function confirmDeleteAppointment() {
            if (!appointmentToDelete) {
                showToast('ç³»çµ±éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è¦åˆªé™¤çš„æ›è™Ÿè¨˜éŒ„ï¼', 'error');
                return;
            }
            
            const appointment = appointments.find(apt => apt.id === appointmentToDelete);
            const patient = patients.find(p => p.id === appointment.patientId);
            
            // å¾æ›è™Ÿåˆ—è¡¨ä¸­ç§»é™¤
            appointments = appointments.filter(apt => apt.id !== appointmentToDelete);
            localStorage.setItem('appointments', JSON.stringify(appointments));
            
            showToast(`${patient.name} çš„æ›è™Ÿè¨˜éŒ„å·²åˆªé™¤ï¼`, 'success');
            closeDeleteAppointmentModal();
            loadTodayAppointments();
            updateStatistics();
        }
        
        // æŸ¥çœ‹ç—…äººè³‡è¨Š
        function viewPatientInfo(patientId) {
            viewPatient(patientId);
        }
        
        // ç²å–æ“ä½œæŒ‰éˆ•
        function getActionButtons(appointment) {
            switch (appointment.status) {
                case 'registered':
                    // å·²æ›è™Ÿç‹€æ…‹ï¼šå¯ä»¥æŸ¥çœ‹ç—…äººè³‡æ–™
                    return `<button onclick="viewPatientInfo(${appointment.patientId})" class="text-blue-600 hover:text-blue-800 font-medium">æŸ¥çœ‹ç—…äºº</button>`;
                    
                case 'waiting':
                    // å€™è¨ºä¸­ç‹€æ…‹ï¼šå¯ä»¥æŸ¥çœ‹ç—…äººè³‡æ–™
                    return `<button onclick="viewPatientInfo(${appointment.patientId})" class="text-blue-600 hover:text-blue-800 font-medium">æŸ¥çœ‹ç—…äºº</button>`;
                    
                case 'consulting':
                    // è¨ºç—‡ä¸­ç‹€æ…‹ï¼šæ‰€æœ‰ç”¨æˆ¶éƒ½å¯ä»¥ç¹¼çºŒè¨ºç—‡
                    return `<button onclick="continueConsultation(${appointment.id})" class="text-green-600 hover:text-green-800 font-medium">ç¹¼çºŒè¨ºç—‡</button>`;
                    
                case 'completed':
                    // å·²å®Œæˆç‹€æ…‹ï¼šå¯ä»¥æŸ¥çœ‹è¨ºç—‡è¨˜éŒ„
                    return `<button onclick="viewRecord(${appointment.id})" class="text-gray-600 hover:text-gray-800 font-medium">æŸ¥çœ‹è¨˜éŒ„</button>`;
                    
                default:
                    return '';
            }
        }
        
        // é–‹å§‹è¨ºç—‡ï¼ˆé†«å¸«æ“ä½œï¼‰
        function startConsultation(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) {
                showToast('æ‰¾ä¸åˆ°æ›è™Ÿè¨˜éŒ„ï¼', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            
            // æª¢æŸ¥ç—…äººæ˜¯å¦åœ¨å€™è¨ºç‹€æ…‹
            if (appointment.status !== 'waiting') {
                showToast('åªèƒ½å°å€™è¨ºä¸­çš„ç—…äººé–‹å§‹è¨ºç—‡ï¼', 'warning');
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦å·²æœ‰å…¶ä»–ç—…äººåœ¨è¨ºç—‡ä¸­
            const consultingAppointment = appointments.find(apt => 
                apt.status === 'consulting' && apt.id !== appointmentId
            );
            if (consultingAppointment) {
                const consultingPatient = patients.find(p => p.id === consultingAppointment.patientId);
                showToast(`${consultingPatient.name} æ­£åœ¨è¨ºç—‡ä¸­ï¼Œè«‹å…ˆå®Œæˆè©²ç—…äººçš„è¨ºç—‡ï¼`, 'warning');
                return;
            }
            
            // æ›´æ–°ç‹€æ…‹ç‚ºè¨ºç—‡ä¸­
            appointment.status = 'consulting';
            appointment.consultationStartTime = new Date().toISOString();
            appointment.consultingDoctor = currentUser;
            localStorage.setItem('appointments', JSON.stringify(appointments));
            
            currentConsultingAppointmentId = appointmentId;
            showConsultationForm(appointment);
            loadTodayAppointments();
            
            showToast(`é–‹å§‹ç‚º ${patient.name} è¨ºç—‡`, 'success');
        }
        
        // ç¹¼çºŒè¨ºç—‡
        function continueConsultation(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) return;
            
            currentConsultingAppointmentId = appointmentId;
            showConsultationForm(appointment);
        }
        

        
        // é¡¯ç¤ºè¨ºç—‡è¡¨å–®
        function showConsultationForm(appointment) {
            const patient = patients.find(p => p.id === appointment.patientId);
            if (!patient) return;
            
            // è¨­ç½®ç—…äººè³‡è¨Š
            document.getElementById('formPatientName').textContent = `${patient.name} (${patient.patientNumber})`;
            document.getElementById('formAppointmentTime').textContent = new Date(appointment.appointmentTime).toLocaleString('zh-TW');
            document.getElementById('formChiefComplaint').textContent = appointment.chiefComplaint || 'ç„¡';
            
            // é å¡«ä¸»è¨´ç—‡ç‹€
            if (appointment.chiefComplaint) {
                document.getElementById('formSymptoms').value = appointment.chiefComplaint;
            }
            
            // æ¸…ç©ºå…¶ä»–æ¬„ä½
            ['formTongue', 'formPulse', 'formCurrentHistory', 'formDiagnosis', 'formSyndrome', 'formPrescription', 'formUsage', 'formTreatmentCourse', 'formInstructions', 'formFollowUpDate'].forEach(id => {
                document.getElementById(id).value = '';
            });
            
            document.getElementById('consultationForm').classList.remove('hidden');
            
            // æ»¾å‹•åˆ°è¡¨å–®ä½ç½®
            document.getElementById('consultationForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        // é—œé–‰è¨ºç—‡è¡¨å–®
        function closeConsultationForm() {
            document.getElementById('consultationForm').classList.add('hidden');
            currentConsultingAppointmentId = null;
        }
        
        // å„²å­˜è¨ºç—‡è¨˜éŒ„ï¼ˆé†«å¸«æ“ä½œï¼‰
        function saveConsultation() {
            if (!currentConsultingAppointmentId) {
                showToast('ç³»çµ±éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è¨ºç—‡è¨˜éŒ„ï¼', 'error');
                return;
            }
            
            const appointment = appointments.find(apt => apt.id === currentConsultingAppointmentId);
            if (!appointment) {
                showToast('æ‰¾ä¸åˆ°æ›è™Ÿè¨˜éŒ„ï¼', 'error');
                return;
            }
            
            const symptoms = document.getElementById('formSymptoms').value.trim();
            const diagnosis = document.getElementById('formDiagnosis').value.trim();
            const syndrome = document.getElementById('formSyndrome').value.trim();
            const prescription = document.getElementById('formPrescription').value.trim();
            
            if (!symptoms || !diagnosis || !syndrome || !prescription) {
                showToast('è«‹å¡«å¯«å¿…å¡«æ¬„ä½ï¼šä¸»è¨´ã€ä¸­é†«è¨ºæ–·ã€è­‰å‹è¨ºæ–·ã€è™•æ–¹å…§å®¹ï¼', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºä¿®æ”¹ç—…æ­·æ¨¡å¼
            if (appointment.status === 'completed' && appointment.consultationId) {
                // ä¿®æ”¹ç¾æœ‰ç—…æ­·
                const existingConsultation = consultations.find(c => c.id === appointment.consultationId);
                if (existingConsultation) {
                    existingConsultation.symptoms = symptoms;
                    existingConsultation.tongue = document.getElementById('formTongue').value.trim();
                    existingConsultation.pulse = document.getElementById('formPulse').value.trim();
                    existingConsultation.currentHistory = document.getElementById('formCurrentHistory').value.trim();
                    existingConsultation.diagnosis = diagnosis;
                    existingConsultation.syndrome = syndrome;
                    existingConsultation.prescription = prescription;
                    existingConsultation.usage = document.getElementById('formUsage').value.trim();
                    existingConsultation.treatmentCourse = document.getElementById('formTreatmentCourse').value.trim();
                    existingConsultation.instructions = document.getElementById('formInstructions').value.trim();
                    existingConsultation.followUpDate = document.getElementById('formFollowUpDate').value;
                    existingConsultation.updatedAt = new Date().toISOString();
                    existingConsultation.updatedBy = currentUser;
                    
                    localStorage.setItem('consultations', JSON.stringify(consultations));
                    showToast(`${patient.name} çš„ç—…æ­·å·²æˆåŠŸæ›´æ–°ï¼`, 'success');
                }
            } else if (appointment.status === 'consulting') {
                // æ–°å¢è¨ºç—‡è¨˜éŒ„
                const consultation = {
                    id: Date.now(),
                    appointmentId: currentConsultingAppointmentId,
                    patientId: appointment.patientId,
                    symptoms: symptoms,
                    tongue: document.getElementById('formTongue').value.trim(),
                    pulse: document.getElementById('formPulse').value.trim(),
                    currentHistory: document.getElementById('formCurrentHistory').value.trim(),
                    diagnosis: diagnosis,
                    syndrome: syndrome,
                    prescription: prescription,
                    usage: document.getElementById('formUsage').value.trim(),
                    treatmentCourse: document.getElementById('formTreatmentCourse').value.trim(),
                    instructions: document.getElementById('formInstructions').value.trim(),
                    followUpDate: document.getElementById('formFollowUpDate').value,
                    date: new Date().toISOString(),
                    doctor: currentUser,
                    status: 'completed'
                };
                
                consultations.push(consultation);
                localStorage.setItem('consultations', JSON.stringify(consultations));
                
                // æ›´æ–°æ›è™Ÿç‹€æ…‹ç‚ºå·²å®Œæˆ
                appointment.status = 'completed';
                appointment.completedAt = new Date().toISOString();
                appointment.consultationId = consultation.id;
                appointment.completedBy = currentUser;
                localStorage.setItem('appointments', JSON.stringify(appointments));
                
                showToast(`${patient.name} çš„è¨ºç—‡è¨˜éŒ„å·²å®Œæˆä¸¦ä¿å­˜ï¼`, 'success');
            } else {
                showToast('åªèƒ½ä¿å­˜è¨ºç—‡ä¸­ç‹€æ…‹çš„è¨˜éŒ„æˆ–ä¿®æ”¹å·²å®Œæˆçš„ç—…æ­·ï¼', 'warning');
                return;
            }
            
            closeConsultationForm();
            loadTodayAppointments();
            updateStatistics();
        }
        
        // ä¿®æ”¹ç—…æ­·åŠŸèƒ½
        function editMedicalRecord(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment || !appointment.consultationId) {
                showToast('æ‰¾ä¸åˆ°è¨ºç—‡è¨˜éŒ„ï¼', 'warning');
                return;
            }
            
            const consultation = consultations.find(c => c.id === appointment.consultationId);
            const patient = patients.find(p => p.id === appointment.patientId);
            
            if (!consultation || !patient) {
                showToast('è¨ºç—‡è¨˜éŒ„è³‡æ–™ä¸å®Œæ•´ï¼', 'error');
                return;
            }
            
            // è¨­ç½®ç‚ºç·¨è¼¯æ¨¡å¼
            currentConsultingAppointmentId = appointmentId;
            
            // åœ¨è¡¨å–®ä¸­é¡¯ç¤ºè¨ºç—‡è¨˜éŒ„ï¼ˆç·¨è¼¯æ¨¡å¼ï¼‰
            document.getElementById('formPatientName').textContent = `${patient.name} (${patient.patientNumber})`;
            document.getElementById('formAppointmentTime').textContent = new Date(consultation.date).toLocaleString('zh-TW');
            document.getElementById('formChiefComplaint').textContent = appointment.chiefComplaint || 'ç„¡';
            
            // å¡«å…¥è¨ºç—‡è¨˜éŒ„ï¼ˆå¯ç·¨è¼¯ï¼‰
            document.getElementById('formSymptoms').value = consultation.symptoms || '';
            document.getElementById('formTongue').value = consultation.tongue || '';
            document.getElementById('formPulse').value = consultation.pulse || '';
            document.getElementById('formCurrentHistory').value = consultation.currentHistory || '';
            document.getElementById('formDiagnosis').value = consultation.diagnosis || '';
            document.getElementById('formSyndrome').value = consultation.syndrome || '';
            document.getElementById('formPrescription').value = consultation.prescription || '';
            document.getElementById('formUsage').value = consultation.usage || '';
            document.getElementById('formTreatmentCourse').value = consultation.treatmentCourse || '';
            document.getElementById('formInstructions').value = consultation.instructions || '';
            document.getElementById('formFollowUpDate').value = consultation.followUpDate || '';
            
            // ä¿®æ”¹æŒ‰éˆ•æ–‡å­—
            const saveButton = document.querySelector('#consultationForm button[onclick="saveConsultation()"]');
            if (saveButton) {
                saveButton.textContent = 'æ›´æ–°ç—…æ­·';
            }
            
            document.getElementById('consultationForm').classList.remove('hidden');
            document.getElementById('consultationForm').scrollIntoView({ behavior: 'smooth' });
            
            showToast('é€²å…¥ç—…æ­·ç·¨è¼¯æ¨¡å¼', 'info');
        }
        
        // æŸ¥çœ‹è¨ºç—‡è¨˜éŒ„
        function viewRecord(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment || !appointment.consultationId) {
                showToast('æ‰¾ä¸åˆ°è¨ºç—‡è¨˜éŒ„ï¼', 'warning');
                return;
            }
            
            const consultation = consultations.find(c => c.id === appointment.consultationId);
            const patient = patients.find(p => p.id === appointment.patientId);
            
            if (!consultation || !patient) {
                showToast('è¨ºç—‡è¨˜éŒ„è³‡æ–™ä¸å®Œæ•´ï¼', 'error');
                return;
            }
            
            // åœ¨è¡¨å–®ä¸­é¡¯ç¤ºè¨ºç—‡è¨˜éŒ„ï¼ˆåªè®€æ¨¡å¼ï¼‰
            document.getElementById('formPatientName').textContent = `${patient.name} (${patient.patientNumber})`;
            document.getElementById('formAppointmentTime').textContent = new Date(consultation.date).toLocaleString('zh-TW');
            document.getElementById('formChiefComplaint').textContent = appointment.chiefComplaint || 'ç„¡';
            
            // å¡«å…¥è¨ºç—‡è¨˜éŒ„ï¼ˆåªè®€ï¼‰
            document.getElementById('formSymptoms').value = consultation.symptoms || '';
            document.getElementById('formTongue').value = consultation.tongue || '';
            document.getElementById('formPulse').value = consultation.pulse || '';
            document.getElementById('formCurrentHistory').value = consultation.currentHistory || '';
            document.getElementById('formDiagnosis').value = consultation.diagnosis || '';
            document.getElementById('formSyndrome').value = consultation.syndrome || '';
            document.getElementById('formPrescription').value = consultation.prescription || '';
            document.getElementById('formUsage').value = consultation.usage || '';
            document.getElementById('formTreatmentCourse').value = consultation.treatmentCourse || '';
            document.getElementById('formInstructions').value = consultation.instructions || '';
            document.getElementById('formFollowUpDate').value = consultation.followUpDate || '';
            
            // è¨­ç½®ç‚ºåªè®€æ¨¡å¼
            ['formSymptoms', 'formTongue', 'formPulse', 'formCurrentHistory', 'formDiagnosis', 'formSyndrome', 'formPrescription', 'formUsage', 'formTreatmentCourse', 'formInstructions', 'formFollowUpDate'].forEach(id => {
                document.getElementById(id).readOnly = true;
            });
            
            // éš±è—å„²å­˜æŒ‰éˆ•ï¼Œåªé¡¯ç¤ºé—œé–‰æŒ‰éˆ•
            const saveButton = document.querySelector('#consultationForm button[onclick="saveConsultation()"]');
            if (saveButton) {
                saveButton.style.display = 'none';
            }
            
            document.getElementById('consultationForm').classList.remove('hidden');
            document.getElementById('consultationForm').scrollIntoView({ behavior: 'smooth' });
            
            // ç•¶é—œé–‰æ™‚æ¢å¾©ç·¨è¼¯æ¨¡å¼
            const originalClose = closeConsultationForm;
            window.closeConsultationForm = function() {
                ['formSymptoms', 'formTongue', 'formPulse', 'formCurrentHistory', 'formDiagnosis', 'formSyndrome', 'formPrescription', 'formUsage', 'formTreatmentCourse', 'formInstructions', 'formFollowUpDate'].forEach(id => {
                    document.getElementById(id).readOnly = false;
                });
                if (saveButton) {
                    saveButton.style.display = 'inline-block';
                    saveButton.textContent = 'å®Œæˆè¨ºç—‡';
                }
                window.closeConsultationForm = originalClose;
                originalClose();
            };
        }







        // ç³»çµ±ç®¡ç†åŠŸèƒ½
        function updateStatistics() {
            document.getElementById('totalPatients').textContent = patients.length;
            
            const today = new Date().toDateString();
            const todayConsultations = consultations.filter(c => 
                new Date(c.date).toDateString() === today
            ).length;
            document.getElementById('todayConsultations').textContent = todayConsultations;
            
            const thisMonth = new Date().getMonth();
            const monthlyConsultations = consultations.filter(c => 
                new Date(c.date).getMonth() === thisMonth
            ).length;
            document.getElementById('monthlyConsultations').textContent = monthlyConsultations;
        }

        function exportData() {
            const data = {
                patients: patients,
                consultations: consultations,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `è¨ºæ‰€è³‡æ–™_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('è³‡æ–™åŒ¯å‡ºå®Œæˆï¼', 'success');
        }

        function backupData() {
            const backup = {
                patients: patients,
                consultations: consultations,
                backupDate: new Date().toISOString()
            };
            localStorage.setItem('clinicBackup', JSON.stringify(backup));
            showToast('è³‡æ–™å‚™ä»½å®Œæˆï¼', 'success');
        }

        function clearData() {
            if (confirm('è­¦å‘Šï¼šæ­¤æ“ä½œå°‡æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                if (confirm('æœ€å¾Œç¢ºèªï¼šæ‰€æœ‰ç—…äººè³‡æ–™å’Œè¨ºç—‡è¨˜éŒ„å°‡è¢«æ°¸ä¹…åˆªé™¤ï¼')) {
                    localStorage.removeItem('patients');
                    localStorage.removeItem('consultations');
                    patients = [];
                    consultations = [];
                    updateStatistics();
                    showToast('æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤ï¼', 'success');
                }
            }
        }

        // åˆå§‹åŒ–ç³»çµ±
        document.addEventListener('DOMContentLoaded', function() {
            updateStatistics();
            
            // è¨ºç—‡ç³»çµ±æœƒåœ¨è¼‰å…¥æ™‚è‡ªå‹•è¨­ç½®æœå°‹åŠŸèƒ½
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'968c1110d5ea1fbe',t:'MTc1NDEyMTg4OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
        
        .toast.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .toast.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .toast.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .toast.info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }
        
        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .toast-content {
            flex: 1;
            line-height: 1.4;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">
    <!-- ç™»å…¥é é¢ -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="text-4xl mb-4">ğŸ¥</div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">ä¸­é†«è¨ºæ‰€ç®¡ç†ç³»çµ±</h1>
                <p class="text-gray-600">è«‹é¸æ“‡æ‚¨çš„èº«ä»½ç™»å…¥</p>
            </div>
            
            <div class="space-y-4">
                <button onclick="login('admin')" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center">
                    <span class="mr-2">ğŸ‘¨â€ğŸ’¼</span>
                    ç®¡ç†å“¡ç™»å…¥
                </button>
                <button onclick="login('doctor')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center">
                    <span class="mr-2">ğŸ‘¨â€âš•ï¸</span>
                    é†«å¸«ç™»å…¥
                </button>
                <button onclick="login('assistant')" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center">
                    <span class="mr-2">ğŸ‘©â€ğŸ’»</span>
                    è¨ºæ‰€åŠ©ç†ç™»å…¥
                </button>
            </div>
        </div>
    </div>

    <!-- ä¸»ç³»çµ±é é¢ -->
    <div id="mainSystem" class="hidden fade-in">
        <!-- å´é‚Šé¸å–® -->
        <div id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-2xl transform -translate-x-full transition-transform duration-300 ease-in-out">
            <div class="flex flex-col h-full">
                <!-- é¸å–®æ¨™é¡Œ -->
                <div class="bg-green-600 text-white p-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">ğŸ¥</span>
                            <h2 class="text-lg font-bold">è¨ºæ‰€åŠŸèƒ½</h2>
                        </div>
                        <button onclick="toggleSidebar()" class="text-white hover:text-gray-200 text-xl">
                            Ã—
                        </button>
                    </div>
                    <div id="sidebarUserRole" class="text-sm text-green-100 mt-2"></div>
                </div>

                <!-- åŠŸèƒ½é¸å–®é …ç›® -->
                <div class="flex-1 py-4">
                    <div id="sidebarMenu" class="space-y-2 px-4">
                        <!-- é¸å–®é …ç›®æœƒå‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- åº•éƒ¨æ“ä½œ -->
                <div class="border-t border-gray-200 p-4">
                    <button onclick="logout()" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg text-sm transition duration-200 flex items-center justify-center">
                        <span class="mr-2">ğŸšª</span>
                        ç™»å‡ºç³»çµ±
                    </button>
                </div>
            </div>
        </div>

        <!-- é®ç½©å±¤ -->
        <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden" onclick="toggleSidebar()"></div>

        <!-- é ‚éƒ¨å°èˆª -->
        <nav class="bg-white shadow-lg border-b-4 border-green-500">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <button onclick="toggleSidebar()" class="mr-4 p-2 rounded-lg hover:bg-gray-100 transition duration-200">
                            <div class="w-6 h-6 flex flex-col justify-center space-y-1">
                                <div class="w-full h-0.5 bg-gray-600"></div>
                                <div class="w-full h-0.5 bg-gray-600"></div>
                                <div class="w-full h-0.5 bg-gray-600"></div>
                            </div>
                        </button>
                        <span class="text-2xl mr-3">ğŸ¥</span>
                        <h1 class="text-xl font-bold text-gray-800">ä¸­é†«è¨ºæ‰€ç®¡ç†ç³»çµ±</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="userRole" class="text-sm text-gray-600"></span>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                            ç™»å‡º
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
        <div class="max-w-7xl mx-auto px-4 py-6">
            <!-- æ­¡è¿é é¢ -->
            <div id="welcomePage" class="text-center py-16">
                <div class="text-6xl mb-6">ğŸ¥</div>
                <h2 class="text-3xl font-bold text-gray-800 mb-4">æ­¡è¿ä½¿ç”¨ä¸­é†«è¨ºæ‰€ç®¡ç†ç³»çµ±</h2>
                <p class="text-gray-600 text-lg mb-8">è«‹é»æ“Šå·¦ä¸Šè§’é¸å–®æŒ‰éˆ•é–‹å§‹ä½¿ç”¨ç³»çµ±åŠŸèƒ½</p>
                <div class="bg-white rounded-xl shadow-lg p-8 max-w-2xl mx-auto">
                    <h3 class="text-xl font-semibold mb-4">ç³»çµ±åŠŸèƒ½æ¦‚è¦½</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <div class="text-2xl mb-2">ğŸ‘¥</div>
                            <div class="font-semibold">ç—…äººè³‡æ–™ç®¡ç†</div>
                            <div class="text-gray-600 mt-1">æ–°å¢ã€æŸ¥çœ‹ã€ç®¡ç†ç—…äººè³‡æ–™</div>
                        </div>
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <div class="text-2xl mb-2">ğŸ©º</div>
                            <div class="font-semibold">è¨ºç—‡ç³»çµ±</div>
                            <div class="text-gray-600 mt-1">è¨˜éŒ„ç—‡ç‹€ã€è¨ºæ–·ã€é–‹ç«‹è™•æ–¹</div>
                        </div>
                        <div class="text-center p-4 bg-red-50 rounded-lg">
                            <div class="text-2xl mb-2">âš™ï¸</div>
                            <div class="font-semibold">ç³»çµ±ç®¡ç†</div>
                            <div class="text-gray-600 mt-1">çµ±è¨ˆè³‡æ–™ã€å‚™ä»½åŒ¯å‡º</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç—…äººè³‡æ–™ç®¡ç† -->
            <div id="patientManagement" class="hidden bg-white rounded-xl shadow-lg p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">ç—…äººè³‡æ–™ç®¡ç†</h2>
                    <div class="flex flex-col md:flex-row gap-3">
                        <div class="relative">
                            <input type="text" id="searchPatient" placeholder="æœå°‹ç—…äººç·¨è™Ÿã€å§“åæˆ–é›»è©±..." class="border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:ring-2 focus:ring-green-500 focus:border-transparent w-full md:w-64">
                            <span class="absolute right-3 top-2.5 text-gray-400">ğŸ”</span>
                        </div>
                        <button onclick="showAddPatientForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200 whitespace-nowrap">
                            + æ–°å¢ç—…äºº
                        </button>
                    </div>
                </div>

                <!-- æ–°å¢/ç·¨è¼¯ç—…äººè¡¨å–®å½ˆçª— -->
                <div id="addPatientModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                            <h3 id="formTitle" class="text-xl font-bold text-gray-800">æ–°å¢ç—…äººè³‡æ–™</h3>
                            <button onclick="hideAddPatientForm()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">å§“å *</label>
                                    <input type="text" id="patientName" placeholder="è«‹è¼¸å…¥å§“å" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">å¹´é½¡</label>
                                    <input type="number" id="patientAge" placeholder="ç³»çµ±è‡ªå‹•è¨ˆç®—" min="0" max="120" readonly class="w-full border border-gray-300 rounded-lg px-4 py-2 bg-gray-100 text-gray-600">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">æ€§åˆ¥ *</label>
                                    <select id="patientGender" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                        <option value="">è«‹é¸æ“‡æ€§åˆ¥</option>
                                        <option value="ç”·">ç”·</option>
                                        <option value="å¥³">å¥³</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">é›»è©±è™Ÿç¢¼ *</label>
                                    <input type="tel" id="patientPhone" placeholder="ä¾‹ï¼š0912-345-678" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">èº«åˆ†è­‰å­—è™Ÿ</label>
                                    <input type="text" id="patientIdCard" placeholder="ä¾‹ï¼šA123456789" maxlength="10" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">å‡ºç”Ÿæ—¥æœŸ *</label>
                                    <input type="date" id="patientBirthDate" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent" onchange="updatePatientAge()">
                                </div>
                                <div class="md:col-span-2 lg:col-span-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">è¯çµ¡åœ°å€</label>
                                    <textarea id="patientAddress" placeholder="è«‹è¼¸å…¥å®Œæ•´åœ°å€" rows="2" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                                </div>
                                <div class="md:col-span-2 lg:col-span-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">éæ•å²</label>
                                    <textarea id="patientAllergies" placeholder="è«‹è©³ç´°è¨˜éŒ„è—¥ç‰©éæ•æˆ–é£Ÿç‰©éæ•å²" rows="2" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                                </div>
                                <div class="md:col-span-2 lg:col-span-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ç—…å²åŠå‚™è¨»</label>
                                    <textarea id="patientHistory" placeholder="è«‹è¨˜éŒ„é‡è¦ç—…å²ã€å®¶æ—ç—…å²ã€æ…¢æ€§ç–¾ç—…ç­‰" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-gray-200">
                                <button onclick="hideAddPatientForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                                    å–æ¶ˆ
                                </button>
                                <button onclick="savePatient()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200">
                                    <span id="saveButtonText">å„²å­˜</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç—…äººåˆ—è¡¨ -->
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ç·¨è™Ÿ</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">å§“å</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">å¹´é½¡</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">æ€§åˆ¥</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">é›»è©±</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">æœ€å¾Œå°±è¨º</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="patientList" class="divide-y divide-gray-200">
                            <!-- ç—…äººè³‡æ–™æœƒå‹•æ…‹è¼‰å…¥ -->
                        </tbody>
                    </table>
                </div>

                <!-- ç—…äººè©³ç´°è³‡æ–™å½ˆçª— -->
                <div id="patientDetailModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
                            <h3 class="text-xl font-bold text-gray-800">ç—…äººè©³ç´°è³‡æ–™</h3>
                            <button onclick="closePatientDetail()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                        </div>
                        <div id="patientDetailContent" class="p-6">
                            <!-- è©³ç´°å…§å®¹æœƒå‹•æ…‹è¼‰å…¥ -->
                        </div>
                    </div>
                </div>

                <!-- ç—…äººç—…æ­·æŸ¥çœ‹å½ˆçª— -->
                <div id="patientHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                            <h3 class="text-xl font-bold text-gray-800">ç—…äººç—…æ­·è¨˜éŒ„</h3>
                            <button onclick="closePatientHistory()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                        </div>
                        <div id="patientHistoryContent" class="p-6">
                            <!-- ç—…æ­·å…§å®¹æœƒå‹•æ…‹è¼‰å…¥ -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¨ºç—‡ç³»çµ± -->
            <div id="consultationSystem" class="hidden bg-white rounded-xl shadow-lg p-6">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">æ›è™Ÿè¨ºç—‡ç³»çµ±</h2>
                    <p class="text-gray-600 mt-2">ç°¡æ½”çš„æ›è™Ÿæµç¨‹ç®¡ç†</p>
                </div>
                
                <!-- ç—…äººæœç´¢æ›è™Ÿ -->
                <div class="bg-gradient-to-r from-blue-50 to-green-50 rounded-lg p-6 mb-6">
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold text-gray-800 flex items-center mb-2">
                            <span class="mr-2">ğŸ”</span>æœç´¢ç—…äººæ›è™Ÿ
                        </h3>
                        <p class="text-sm text-gray-600">è«‹è¼¸å…¥ç—…äººå§“åã€ç·¨è™Ÿæˆ–é›»è©±é€²è¡Œæœç´¢</p>
                    </div>
                    
                    <div class="flex gap-3">
                        <div class="flex-1 relative">
                            <input type="text" id="patientSearchInput" placeholder="æœå°‹ç—…äººå§“åã€ç·¨è™Ÿæˆ–é›»è©±..." 
                                   class="w-full border border-gray-300 rounded-lg px-4 py-3 pr-10 focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                   oninput="searchPatientsForRegistration()">
                            <span class="absolute right-3 top-3.5 text-gray-400">ğŸ”</span>
                        </div>
                        <button onclick="clearPatientSearch()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-lg transition duration-200">
                            æ¸…é™¤
                        </button>
                    </div>
                    
                    <!-- æœç´¢çµæœ -->
                    <div id="patientSearchResults" class="mt-4 hidden">
                        <div class="bg-white rounded-lg border border-gray-200 max-h-64 overflow-y-auto">
                            <div id="searchResultsList" class="divide-y divide-gray-200">
                                <!-- æœç´¢çµæœæœƒå‹•æ…‹è¼‰å…¥ -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ›è™Ÿå½ˆçª— -->
                <div id="registrationModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
                        <div class="bg-green-600 text-white px-6 py-4 rounded-t-xl">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-bold">ç—…äººæ›è™Ÿ</h3>
                                <button onclick="closeRegistrationModal()" class="text-white hover:text-gray-200 text-2xl">Ã—</button>
                            </div>
                        </div>
                        
                        <div class="p-6 space-y-4">
                            <!-- é¸ä¸­çš„ç—…äººè³‡è¨Š -->
                            <div class="bg-blue-50 rounded-lg p-4">
                                <div class="flex items-center mb-2">
                                    <span class="mr-2">ğŸ‘¤</span>
                                    <span class="font-semibold text-gray-700">ç—…äººè³‡è¨Š</span>
                                </div>
                                <div id="selectedPatientInfo" class="text-sm text-gray-600">
                                    <!-- ç—…äººè³‡è¨Šæœƒå‹•æ…‹è¼‰å…¥ -->
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <span class="mr-2">â°</span>æ›è™Ÿæ™‚é–“
                                </label>
                                <input type="datetime-local" id="appointmentDateTime" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <span class="mr-2">ğŸ“</span>ä¸»è¨´ç—‡ç‹€
                                </label>
                                <textarea id="quickChiefComplaint" placeholder="è«‹ç°¡è¿°ç—…äººçš„ä¸»è¦ç—‡ç‹€..." rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                            </div>
                            
                            <div class="flex space-x-3 pt-4">
                                <button onclick="closeRegistrationModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg transition duration-200">
                                    å–æ¶ˆ
                                </button>
                                <button onclick="confirmRegistration()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                    ç¢ºèªæ›è™Ÿ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ä»Šæ—¥æ›è™Ÿåˆ—è¡¨ -->
                <div class="bg-white border border-gray-200 rounded-lg">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 rounded-t-lg">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                                <span class="mr-2">ğŸ“…</span>ä»Šæ—¥æ›è™Ÿåˆ—è¡¨
                            </h3>
                            <div class="text-sm text-gray-600">
                                ç¸½è¨ˆï¼š<span id="todayTotal" class="font-semibold text-blue-600">0</span> äºº
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">åºè™Ÿ</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ç—…äººå§“å</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">æ›è™Ÿæ™‚é–“</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ä¸»è¨´ç—‡ç‹€</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ç‹€æ…‹</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="todayAppointmentsList" class="divide-y divide-gray-200">
                                    <!-- æ›è™Ÿåˆ—è¡¨æœƒå‹•æ…‹è¼‰å…¥ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- è¨ºç—‡è¡¨å–®å€åŸŸ -->
                <div id="consultationForm" class="hidden bg-white border border-gray-200 rounded-lg mt-6">
                    <div class="bg-green-600 text-white px-6 py-4 rounded-t-lg">
                        <h3 class="text-xl font-bold">è¨ºç—‡è¨˜éŒ„</h3>
                    </div>
                    
                    <div class="p-6">
                        <!-- ç—…äººè³‡è¨Š -->
                        <div class="bg-blue-50 rounded-lg p-4 mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                <div>
                                    <span class="font-medium">ç—…äººï¼š</span>
                                    <span id="formPatientName" class="text-blue-600 font-semibold"></span>
                                </div>
                                <div>
                                    <span class="font-medium">æ›è™Ÿæ™‚é–“ï¼š</span>
                                    <span id="formAppointmentTime"></span>
                                </div>
                                <div>
                                    <span class="font-medium">ä¸»è¨´ï¼š</span>
                                    <span id="formChiefComplaint"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- è¨ºç—‡è¡¨å–® -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- å·¦å´ -->
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        ä¸»è¨´ *
                                    </label>
                                    <textarea id="formSymptoms" placeholder="ç—…äººä¸»è¦ä¸é©ç—‡ç‹€ã€ç™¼ç—…æ™‚é–“ã€ç—‡ç‹€ç‰¹é»ç­‰..." rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        èˆŒè±¡
                                    </label>
                                    <textarea id="formTongue" placeholder="èˆŒè³ªã€èˆŒè‹”ã€èˆŒå½¢ç­‰..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        è„ˆè±¡
                                    </label>
                                    <textarea id="formPulse" placeholder="è„ˆä½ã€è„ˆç‡ã€è„ˆåŠ›ã€è„ˆå½¢ç­‰..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        ç¾ç—…å²
                                    </label>
                                    <textarea id="formCurrentHistory" placeholder="ç™¼ç—…ç¶“éã€ç—‡ç‹€è®ŠåŒ–ã€æ²»ç™‚ç¶“éç­‰..." rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                            </div>
                            
                            <!-- å³å´ -->
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        ä¸­é†«è¨ºæ–· *
                                    </label>
                                    <textarea id="formDiagnosis" placeholder="ä¸­é†«ç—…åè¨ºæ–·..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        è­‰å‹è¨ºæ–· *
                                    </label>
                                    <textarea id="formSyndrome" placeholder="è¾¨è­‰åˆ†å‹ã€ç—…æ©Ÿåˆ†æ..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        è™•æ–¹å…§å®¹ *
                                    </label>
                                    <textarea id="formPrescription" placeholder="æ–¹åŠ‘åç¨±ã€è—¥ç‰©çµ„æˆã€åŠ‘é‡ç­‰..." rows="4" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        æœç”¨æ–¹æ³•
                                    </label>
                                    <textarea id="formUsage" placeholder="ç…ç…®æ–¹æ³•ã€æœç”¨æ™‚é–“ã€åŠ‘é‡ç­‰..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        ç™‚ç¨‹
                                    </label>
                                    <input type="text" id="formTreatmentCourse" placeholder="ä¾‹ï¼š7å¤©ã€2é€±ã€1å€‹æœˆç­‰..." class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        é†«å›‘åŠæ³¨æ„äº‹é …
                                    </label>
                                    <textarea id="formInstructions" placeholder="é£²é£Ÿå®œå¿Œã€ç”Ÿæ´»èª¿è­·ã€æ³¨æ„äº‹é …ç­‰..." rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- è¤‡è¨ºæ™‚é–“ -->
                        <div class="mt-6 pt-4 border-t border-gray-200">
                            <div class="max-w-md">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    è¤‡è¨ºæ™‚é–“
                                </label>
                                <input type="datetime-local" id="formFollowUpDate" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <p class="text-xs text-gray-500 mt-1">å»ºè­°ç—…äººä¸‹æ¬¡å›è¨ºçš„æ™‚é–“</p>
                            </div>
                        </div>
                        
                        <!-- æ“ä½œæŒ‰éˆ• -->
                        <div class="flex justify-end space-x-3 mt-6 pt-4 border-t border-gray-200">
                            <button onclick="saveConsultation()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200">
                                å®Œæˆè¨ºç—‡
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç³»çµ±ç®¡ç† -->
            <div id="systemManagement" class="hidden bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">ç³»çµ±ç®¡ç†</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">è¨ºæ‰€çµ±è¨ˆ</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span>ç¸½ç—…äººæ•¸ï¼š</span>
                                <span id="totalPatients" class="font-semibold">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>ä»Šæ—¥è¨ºç—‡ï¼š</span>
                                <span id="todayConsultations" class="font-semibold">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>æœ¬æœˆè¨ºç—‡ï¼š</span>
                                <span id="monthlyConsultations" class="font-semibold">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">è³‡æ–™ç®¡ç†</h3>
                        <div class="space-y-3">
                            <button onclick="exportData()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                åŒ¯å‡ºè³‡æ–™
                            </button>
                            <button onclick="backupData()" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                å‚™ä»½è³‡æ–™
                            </button>
                            <button onclick="clearData()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                æ¸…é™¤è³‡æ–™
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ç³»çµ±è³‡æ–™å„²å­˜
        let currentUser = null;
        
        // æµ®å‹•æç¤ºåŠŸèƒ½
        function showToast(message, type = 'info') {
            // ç§»é™¤ç¾æœ‰çš„æç¤º
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // å‰µå»ºæ–°çš„æç¤º
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            // è¨­ç½®åœ–æ¨™
            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
                info: 'â„¹ï¸'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-content">${message}</div>
            `;
            
            // æ·»åŠ åˆ°é é¢
            document.body.appendChild(toast);
            
            // é¡¯ç¤ºå‹•ç•«
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // 2ç§’å¾Œæ·¡å‡ºä¸¦ç§»é™¤
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 2000);
        }
        
        // è¨ˆç®—å¹´é½¡å‡½æ•¸
        function calculateAge(birthDate) {
            const birth = new Date(birthDate);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            
            return age;
        }
        
        // æ ¼å¼åŒ–å¹´é½¡é¡¯ç¤º
        function formatAge(birthDate) {
            if (!birthDate) return 'æœªçŸ¥';
            
            const birth = new Date(birthDate);
            const today = new Date();
            
            let years = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                years--;
            }
            
            if (years > 0) {
                return `${years}æ­²`;
            } else {
                // æœªæ»¿ä¸€æ­²çš„å¬°å¹¼å…’é¡¯ç¤ºæœˆæ•¸
                let months = today.getMonth() - birth.getMonth();
                let days = today.getDate() - birth.getDate();
                
                if (days < 0) {
                    months--;
                    const lastMonth = new Date(today.getFullYear(), today.getMonth(), 0);
                    days += lastMonth.getDate();
                }
                
                if (months < 0) {
                    months += 12;
                }
                
                if (months > 0) {
                    return `${months}å€‹æœˆ`;
                } else {
                    return `${days}å¤©`;
                }
            }
        }
        
        // ç”Ÿæˆç—…äººç·¨è™Ÿå‡½æ•¸
        function generatePatientNumber() {
            const existingNumbers = patients
                .map(p => p.patientNumber)
                .filter(num => num && num.startsWith('P'))
                .map(num => parseInt(num.substring(1)))
                .filter(num => !isNaN(num));
            
            const maxNumber = existingNumbers.length > 0 ? Math.max(...existingNumbers) : 0;
            const newNumber = maxNumber + 1;
            return `P${newNumber.toString().padStart(3, '0')}`;
        }

        // é è¨­æ¸¬è©¦ç—…äººè³‡æ–™
        const defaultPatients = [
            {
                id: 1001,
                patientNumber: 'P001',
                name: 'ç‹å°æ˜',
                gender: 'ç”·',
                phone: '0912-345-678',
                birthDate: '1989-03-15',
                address: 'å°åŒ—å¸‚å¤§å®‰å€ä¿¡ç¾©è·¯å››æ®µ123è™Ÿ',
                history: 'é«˜è¡€å£“ç—…å²3å¹´ï¼Œå¶æœ‰é ­æšˆç—‡ç‹€',
                createdAt: new Date('2024-01-15').toISOString()
            },
            {
                id: 1002,
                patientNumber: 'P002',
                name: 'æç¾è¯',
                gender: 'å¥³',
                phone: '0923-456-789',
                birthDate: '1996-07-22',
                address: 'æ–°åŒ—å¸‚æ¿æ©‹å€ä¸­å±±è·¯äºŒæ®µ456è™Ÿ',
                history: 'ç¶“å¸¸æ€§å¤±çœ ï¼Œå·¥ä½œå£“åŠ›å¤§',
                createdAt: new Date('2024-01-20').toISOString()
            },
            {
                id: 1003,
                patientNumber: 'P003',
                name: 'å¼µå¿—å¼·',
                gender: 'ç”·',
                phone: '0934-567-890',
                birthDate: '1982-11-08',
                address: 'æ¡ƒåœ’å¸‚ä¸­å£¢å€ä¸­æ­£è·¯789è™Ÿ',
                history: 'æ…¢æ€§èƒƒç‚ï¼Œé£²é£Ÿä¸è¦å¾‹',
                createdAt: new Date('2024-02-01').toISOString()
            },
            {
                id: 1004,
                patientNumber: 'P004',
                name: 'é™³é›…å©·',
                gender: 'å¥³',
                phone: '0945-678-901',
                birthDate: '1993-05-12',
                address: 'å°ä¸­å¸‚è¥¿å±¯å€å°ç£å¤§é“ä¸‰æ®µ321è™Ÿ',
                history: 'æœˆç¶“ä¸èª¿ï¼Œç¶“å¸¸è…°é…¸èƒŒç—›',
                createdAt: new Date('2024-02-10').toISOString()
            },
            {
                id: 1005,
                patientNumber: 'P005',
                name: 'æ—å¤§å‰',
                gender: 'ç”·',
                phone: '0956-789-012',
                birthDate: '1969-12-03',
                address: 'é«˜é›„å¸‚å‰é‡‘å€ä¸­æ­£å››è·¯654è™Ÿ',
                history: 'ç³–å°¿ç—…æ‚£è€…ï¼Œéœ€å®šæœŸè¿½è¹¤è¡€ç³–',
                createdAt: new Date('2024-02-15').toISOString()
            }
        ];

        // åˆå§‹åŒ–ç—…äººè³‡æ–™ï¼ˆå¦‚æœæœ¬åœ°å„²å­˜ç‚ºç©ºå‰‡è¼‰å…¥é è¨­è³‡æ–™ï¼‰
        let patients = JSON.parse(localStorage.getItem('patients') || '[]');
        if (patients.length === 0) {
            patients = defaultPatients;
            localStorage.setItem('patients', JSON.stringify(patients));
        } else {
            // ç‚ºèˆŠè³‡æ–™è£œå……ç—…äººç·¨è™Ÿ
            let needsUpdate = false;
            patients.forEach(patient => {
                if (!patient.patientNumber) {
                    patient.patientNumber = generatePatientNumber();
                    needsUpdate = true;
                }
            });
            if (needsUpdate) {
                localStorage.setItem('patients', JSON.stringify(patients));
            }
        }
        
        let consultations = JSON.parse(localStorage.getItem('consultations') || '[]');

        // ç”¨æˆ¶æ¬Šé™è¨­å®š - æ‰€æœ‰ç”¨æˆ¶éƒ½æœ‰å®Œæ•´æ¬Šé™
        const userPermissions = {
            admin: ['patientManagement', 'consultationSystem', 'systemManagement'],
            doctor: ['patientManagement', 'consultationSystem', 'systemManagement'],
            assistant: ['patientManagement', 'consultationSystem', 'systemManagement']
        };

        // ç™»å…¥åŠŸèƒ½
        function login(role) {
            currentUser = role;
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainSystem').classList.remove('hidden');
            
            const roleNames = {
                admin: 'ç®¡ç†å“¡',
                doctor: 'é†«å¸«',
                assistant: 'è¨ºæ‰€åŠ©ç†'
            };
            
            document.getElementById('userRole').textContent = `ç•¶å‰ç”¨æˆ¶ï¼š${roleNames[role]}`;
            document.getElementById('sidebarUserRole').textContent = `ç•¶å‰ç”¨æˆ¶ï¼š${roleNames[role]}`;
            generateSidebarMenu();
            updateStatistics();
        }

        // å´é‚Šé¸å–®æ§åˆ¶
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        // ç™»å‡ºåŠŸèƒ½
        function logout() {
            currentUser = null;
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('mainSystem').classList.add('hidden');
            document.getElementById('sidebar').classList.add('-translate-x-full');
            document.getElementById('sidebarOverlay').classList.add('hidden');
            hideAllSections();
        }

        // ç”Ÿæˆå´é‚Šé¸å–®
        function generateSidebarMenu() {
            const menuContainer = document.getElementById('sidebarMenu');
            menuContainer.innerHTML = '';
            
            const menuItems = {
                patientManagement: { title: 'ç—…äººè³‡æ–™ç®¡ç†', icon: 'ğŸ‘¥', description: 'æ–°å¢ã€æŸ¥çœ‹ã€ç®¡ç†ç—…äººè³‡æ–™' },
                consultationSystem: { title: 'è¨ºç—‡ç³»çµ±', icon: 'ğŸ©º', description: 'è¨˜éŒ„ç—‡ç‹€ã€è¨ºæ–·ã€é–‹ç«‹è™•æ–¹' },
                systemManagement: { title: 'ç³»çµ±ç®¡ç†', icon: 'âš™ï¸', description: 'çµ±è¨ˆè³‡æ–™ã€å‚™ä»½åŒ¯å‡º' }
            };
            
            userPermissions[currentUser].forEach(permission => {
                const item = menuItems[permission];
                const button = document.createElement('button');
                button.className = 'w-full text-left p-4 rounded-lg hover:bg-gray-100 transition duration-200 border border-gray-200 mb-2';
                button.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-2xl mr-4">${item.icon}</span>
                        <div>
                            <div class="font-semibold text-gray-800">${item.title}</div>
                            <div class="text-sm text-gray-600">${item.description}</div>
                        </div>
                    </div>
                `;
                button.onclick = () => {
                    showSection(permission);
                    toggleSidebar();
                };
                menuContainer.appendChild(button);
            });
        }

        // é¡¯ç¤ºæŒ‡å®šå€åŸŸ
        function showSection(sectionId) {
            hideAllSections();
            document.getElementById('welcomePage').classList.add('hidden');
            document.getElementById(sectionId).classList.remove('hidden');
            
            if (sectionId === 'patientManagement') {
                loadPatientList();
            } else if (sectionId === 'consultationSystem') {
                loadConsultationPatients();
            }
        }

        // éš±è—æ‰€æœ‰å€åŸŸ
        function hideAllSections() {
            ['patientManagement', 'consultationSystem', 'systemManagement', 'welcomePage'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
        }

        // ç—…äººç®¡ç†åŠŸèƒ½
        let editingPatientId = null;
        let filteredPatients = [];
        
        // æ›´æ–°ç—…äººå¹´é½¡é¡¯ç¤º
        function updatePatientAge() {
            const birthDate = document.getElementById('patientBirthDate').value;
            const ageInput = document.getElementById('patientAge');
            
            if (birthDate) {
                const age = calculateAge(birthDate);
                ageInput.value = age;
            } else {
                ageInput.value = '';
            }
        }

        function showAddPatientForm() {
            editingPatientId = null;
            document.getElementById('formTitle').textContent = 'æ–°å¢ç—…äººè³‡æ–™';
            document.getElementById('saveButtonText').textContent = 'å„²å­˜';
            document.getElementById('addPatientModal').classList.remove('hidden');
            clearPatientForm();
        }

        function hideAddPatientForm() {
            document.getElementById('addPatientModal').classList.add('hidden');
            clearPatientForm();
            editingPatientId = null;
        }

        function clearPatientForm() {
            ['patientName', 'patientAge', 'patientGender', 'patientPhone', 'patientIdCard', 'patientBirthDate', 'patientAddress', 'patientAllergies', 'patientHistory'].forEach(id => {
                document.getElementById(id).value = '';
            });
        }

        function savePatient() {
            const patient = {
                id: editingPatientId || Date.now(),
                patientNumber: editingPatientId ? patients.find(p => p.id === editingPatientId).patientNumber : generatePatientNumber(),
                name: document.getElementById('patientName').value.trim(),
                age: document.getElementById('patientAge').value,
                gender: document.getElementById('patientGender').value,
                phone: document.getElementById('patientPhone').value.trim(),
                idCard: document.getElementById('patientIdCard').value.trim(),
                birthDate: document.getElementById('patientBirthDate').value,
                address: document.getElementById('patientAddress').value.trim(),
                allergies: document.getElementById('patientAllergies').value.trim(),
                history: document.getElementById('patientHistory').value.trim(),
                createdAt: editingPatientId ? patients.find(p => p.id === editingPatientId).createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            // é©—è­‰å¿…å¡«æ¬„ä½
            if (!patient.name || !patient.gender || !patient.phone || !patient.birthDate) {
                showToast('è«‹å¡«å¯«å¿…è¦è³‡æ–™ï¼ˆå§“åã€æ€§åˆ¥ã€é›»è©±ã€å‡ºç”Ÿæ—¥æœŸï¼‰ï¼', 'error');
                return;
            }

            // é©—è­‰å‡ºç”Ÿæ—¥æœŸ
            const birthDate = new Date(patient.birthDate);
            const today = new Date();
            if (birthDate > today) {
                showToast('å‡ºç”Ÿæ—¥æœŸä¸èƒ½æ™šæ–¼ä»Šå¤©ï¼', 'error');
                return;
            }

            // è¨ˆç®—å¹´é½¡
            const calculatedAge = calculateAge(patient.birthDate);
            if (calculatedAge > 120) {
                showToast('è«‹ç¢ºèªå‡ºç”Ÿæ—¥æœŸæ˜¯å¦æ­£ç¢ºï¼', 'error');
                return;
            }

            // é©—è­‰é›»è©±æ ¼å¼
            const phoneRegex = /^[0-9\-\+\(\)\s]+$/;
            if (!phoneRegex.test(patient.phone)) {
                showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»è©±è™Ÿç¢¼ï¼', 'error');
                return;
            }

            // é©—è­‰èº«åˆ†è­‰æ ¼å¼ï¼ˆå¦‚æœæœ‰å¡«å¯«ï¼‰
            if (patient.idCard) {
                const idRegex = /^[A-Z][12][0-9]{8}$/;
                if (!idRegex.test(patient.idCard)) {
                    showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„èº«åˆ†è­‰å­—è™Ÿæ ¼å¼ï¼ˆä¾‹ï¼šA123456789ï¼‰ï¼', 'error');
                    return;
                }
            }

            if (editingPatientId) {
                // æ›´æ–°ç¾æœ‰ç—…äºº
                const index = patients.findIndex(p => p.id === editingPatientId);
                patients[index] = patient;
                showToast('ç—…äººè³‡æ–™å·²æˆåŠŸæ›´æ–°ï¼', 'success');
            } else {
                // æ–°å¢ç—…äºº
                patients.push(patient);
                showToast('ç—…äººè³‡æ–™å·²æˆåŠŸæ–°å¢ï¼', 'success');
            }

            localStorage.setItem('patients', JSON.stringify(patients));
            loadPatientList();
            hideAddPatientForm();
            updateStatistics();
        }

        function loadPatientList() {
            const tbody = document.getElementById('patientList');
            const searchTerm = document.getElementById('searchPatient').value.toLowerCase();
            
            // éæ¿¾ç—…äººè³‡æ–™
            filteredPatients = patients.filter(patient => 
                patient.name.toLowerCase().includes(searchTerm) ||
                patient.phone.includes(searchTerm) ||
                (patient.idCard && patient.idCard.toLowerCase().includes(searchTerm)) ||
                (patient.patientNumber && patient.patientNumber.toLowerCase().includes(searchTerm))
            );

            tbody.innerHTML = '';

            if (filteredPatients.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                            ${searchTerm ? 'æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„ç—…äºº' : 'å°šç„¡ç—…äººè³‡æ–™'}
                        </td>
                    </tr>
                `;
                return;
            }

            filteredPatients.forEach(patient => {
                // è¨ˆç®—æœ€å¾Œå°±è¨ºæ—¥æœŸ
                const lastConsultation = consultations
                    .filter(c => c.patientId === patient.id)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                
                const lastVisitDate = lastConsultation 
                    ? new Date(lastConsultation.date).toLocaleDateString('zh-TW')
                    : 'æœªå°±è¨º';

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-blue-600 font-medium">${patient.patientNumber || 'æœªè¨­å®š'}</td>
                    <td class="px-4 py-3 text-sm text-gray-900 font-medium">${patient.name}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${formatAge(patient.birthDate)}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${patient.gender}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${patient.phone}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${lastVisitDate}</td>
                    <td class="px-4 py-3 text-sm space-x-2">
                        <button onclick="viewPatient(${patient.id})" class="text-blue-600 hover:text-blue-800">æŸ¥çœ‹</button>
                        <button onclick="editPatient(${patient.id})" class="text-green-600 hover:text-green-800">ç·¨è¼¯</button>
                        <button onclick="deletePatient(${patient.id})" class="text-red-600 hover:text-red-800">åˆªé™¤</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function editPatient(id) {
            const patient = patients.find(p => p.id === id);
            if (!patient) return;

            editingPatientId = id;
            document.getElementById('formTitle').textContent = 'ç·¨è¼¯ç—…äººè³‡æ–™';
            document.getElementById('saveButtonText').textContent = 'æ›´æ–°';
            
            // å¡«å…¥ç¾æœ‰è³‡æ–™
            document.getElementById('patientName').value = patient.name || '';
            document.getElementById('patientGender').value = patient.gender || '';
            document.getElementById('patientPhone').value = patient.phone || '';
            document.getElementById('patientIdCard').value = patient.idCard || '';
            document.getElementById('patientBirthDate').value = patient.birthDate || '';
            document.getElementById('patientAddress').value = patient.address || '';
            document.getElementById('patientAllergies').value = patient.allergies || '';
            document.getElementById('patientHistory').value = patient.history || '';
            
            // è‡ªå‹•è¨ˆç®—å¹´é½¡
            updatePatientAge();
            
            document.getElementById('addPatientModal').classList.remove('hidden');
        }

        function deletePatient(id) {
            const patient = patients.find(p => p.id === id);
            if (!patient) return;

            if (confirm(`ç¢ºå®šè¦åˆªé™¤ç—…äººã€Œ${patient.name}ã€çš„è³‡æ–™å—ï¼Ÿ\n\næ³¨æ„ï¼šç›¸é—œçš„è¨ºç—‡è¨˜éŒ„ä¹Ÿæœƒä¸€ä½µåˆªé™¤ï¼`)) {
                // åˆªé™¤ç—…äººè³‡æ–™
                patients = patients.filter(p => p.id !== id);
                // åˆªé™¤ç›¸é—œè¨ºç—‡è¨˜éŒ„
                consultations = consultations.filter(c => c.patientId !== id);
                
                localStorage.setItem('patients', JSON.stringify(patients));
                localStorage.setItem('consultations', JSON.stringify(consultations));
                
                loadPatientList();
                updateStatistics();
                showToast('ç—…äººè³‡æ–™åŠç›¸é—œè¨ºç—‡è¨˜éŒ„å·²åˆªé™¤ï¼', 'success');
            }
        }

        function viewPatient(id) {
            const patient = patients.find(p => p.id === id);
            if (!patient) return;

            // ç²å–è©²ç—…äººçš„è¨ºç—‡è¨˜éŒ„
            const patientConsultations = consultations
                .filter(c => c.patientId === id)
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            const content = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <h4 class="text-lg font-semibold text-gray-800 border-b pb-2">åŸºæœ¬è³‡æ–™</h4>
                        <div class="space-y-2">
                            <div><span class="font-medium">ç—…äººç·¨è™Ÿï¼š</span><span class="text-blue-600 font-semibold">${patient.patientNumber || 'æœªè¨­å®š'}</span></div>
                            <div><span class="font-medium">å§“åï¼š</span>${patient.name}</div>
                            <div><span class="font-medium">å¹´é½¡ï¼š</span>${formatAge(patient.birthDate)}</div>
                            <div><span class="font-medium">æ€§åˆ¥ï¼š</span>${patient.gender}</div>
                            <div><span class="font-medium">é›»è©±ï¼š</span>${patient.phone}</div>
                            ${patient.idCard ? `<div><span class="font-medium">èº«åˆ†è­‰ï¼š</span>${patient.idCard}</div>` : ''}
                            ${patient.birthDate ? `<div><span class="font-medium">å‡ºç”Ÿæ—¥æœŸï¼š</span>${new Date(patient.birthDate).toLocaleDateString('zh-TW')}</div>` : ''}
                            ${patient.address ? `<div><span class="font-medium">åœ°å€ï¼š</span>${patient.address}</div>` : ''}
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <h4 class="text-lg font-semibold text-gray-800 border-b pb-2">é†«ç™‚è³‡è¨Š</h4>
                        <div class="space-y-2">
                            ${patient.allergies ? `<div><span class="font-medium">éæ•å²ï¼š</span><div class="mt-1 p-2 bg-red-50 rounded text-sm">${patient.allergies}</div></div>` : ''}
                            ${patient.history ? `<div><span class="font-medium">ç—…å²ï¼š</span><div class="mt-1 p-2 bg-gray-50 rounded text-sm">${patient.history}</div></div>` : ''}
                            <div><span class="font-medium">å»ºæª”æ—¥æœŸï¼š</span>${new Date(patient.createdAt).toLocaleDateString('zh-TW')}</div>
                            ${patient.updatedAt ? `<div><span class="font-medium">æ›´æ–°æ—¥æœŸï¼š</span>${new Date(patient.updatedAt).toLocaleDateString('zh-TW')}</div>` : ''}
                        </div>
                    </div>
                </div>
                
                <div class="mt-6">
                    <h4 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-4">è¨ºç—‡è¨˜éŒ„ (${patientConsultations.length}æ¬¡)</h4>
                    ${patientConsultations.length > 0 ? `
                        <div class="space-y-3 max-h-64 overflow-y-auto">
                            ${patientConsultations.map(consultation => `
                                <div class="border border-gray-200 rounded-lg p-3">
                                    <div class="flex justify-between items-start mb-2">
                                        <div class="text-sm font-medium">${new Date(consultation.date).toLocaleDateString('zh-TW')} ${new Date(consultation.date).toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'})}</div>
                                        <div class="text-xs text-gray-500">é†«å¸«ï¼š${consultation.doctor}</div>
                                    </div>
                                    <div class="text-sm text-gray-700">
                                        <div><span class="font-medium">ä¸»è¨´ï¼š</span>${consultation.symptoms || 'ç„¡è¨˜éŒ„'}</div>
                                        <div><span class="font-medium">è¨ºæ–·ï¼š</span>${consultation.diagnosis || 'ç„¡è¨˜éŒ„'}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<div class="text-gray-500 text-center py-4">å°šç„¡è¨ºç—‡è¨˜éŒ„</div>'}
                </div>
            `;

            document.getElementById('patientDetailContent').innerHTML = content;
            document.getElementById('patientDetailModal').classList.remove('hidden');
        }

        function closePatientDetail() {
            document.getElementById('patientDetailModal').classList.add('hidden');
        }

        // æŸ¥çœ‹ç—…äººç—…æ­·è¨˜éŒ„
        function viewPatientHistory(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) {
                showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ï¼', 'error');
                return;
            }

            // ç²å–è©²ç—…äººçš„æ‰€æœ‰è¨ºç—‡è¨˜éŒ„
            const patientConsultations = consultations
                .filter(c => c.patientId === patientId)
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            const content = `
                <div class="mb-6">
                    <!-- ç—…äººåŸºæœ¬è³‡è¨Š -->
                    <div class="bg-blue-50 rounded-lg p-4 mb-6">
                        <div class="flex items-center mb-3">
                            <span class="text-2xl mr-3">ğŸ‘¤</span>
                            <h4 class="text-lg font-semibold text-gray-800">ç—…äººåŸºæœ¬è³‡è¨Š</h4>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                            <div><span class="font-medium">å§“åï¼š</span><span class="text-blue-600 font-semibold">${patient.name}</span></div>
                            <div><span class="font-medium">ç·¨è™Ÿï¼š</span>${patient.patientNumber || 'æœªè¨­å®š'}</div>
                            <div><span class="font-medium">å¹´é½¡ï¼š</span>${formatAge(patient.birthDate)}</div>
                            <div><span class="font-medium">æ€§åˆ¥ï¼š</span>${patient.gender}</div>
                            <div><span class="font-medium">é›»è©±ï¼š</span>${patient.phone}</div>
                            <div><span class="font-medium">å»ºæª”æ—¥æœŸï¼š</span>${new Date(patient.createdAt).toLocaleDateString('zh-TW')}</div>
                        </div>
                        ${patient.allergies ? `
                            <div class="mt-3 p-3 bg-red-50 border border-red-200 rounded">
                                <div class="font-medium text-red-800 mb-1">âš ï¸ éæ•å²</div>
                                <div class="text-sm text-red-700">${patient.allergies}</div>
                            </div>
                        ` : ''}
                        ${patient.history ? `
                            <div class="mt-3 p-3 bg-gray-50 border border-gray-200 rounded">
                                <div class="font-medium text-gray-800 mb-1">ğŸ“‹ ç—…å²</div>
                                <div class="text-sm text-gray-700">${patient.history}</div>
                            </div>
                        ` : ''}
                    </div>

                    <!-- è¨ºç—‡è¨˜éŒ„ -->
                    <div>
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-semibold text-gray-800 flex items-center">
                                <span class="mr-2">ğŸ“‹</span>è¨ºç—‡è¨˜éŒ„
                            </h4>
                            <div class="text-sm text-gray-600">
                                å…± <span class="font-semibold text-blue-600">${patientConsultations.length}</span> æ¬¡è¨ºç—‡
                            </div>
                        </div>
                        
                        ${patientConsultations.length > 0 ? `
                            <div class="space-y-4">
                                ${patientConsultations.map((consultation, index) => `
                                    <div class="border border-gray-200 rounded-lg overflow-hidden">
                                        <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                                            <div class="flex justify-between items-center">
                                                <div class="flex items-center">
                                                    <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full mr-3">
                                                        ç¬¬ ${patientConsultations.length - index} æ¬¡
                                                    </span>
                                                    <div class="font-medium text-gray-900">
                                                        ${new Date(consultation.date).toLocaleDateString('zh-TW')} 
                                                        ${new Date(consultation.date).toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'})}
                                                    </div>
                                                </div>
                                                <div class="text-xs text-gray-500">
                                                    é†«å¸«ï¼š${consultation.doctor || 'æœªè¨˜éŒ„'}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="p-4">
                                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                                <!-- å·¦å´ï¼šç—‡ç‹€èˆ‡æª¢æŸ¥ -->
                                                <div class="space-y-3">
                                                    ${consultation.symptoms ? `
                                                        <div>
                                                            <div class="text-sm font-medium text-gray-700 mb-1">ä¸»è¨´ç—‡ç‹€</div>
                                                            <div class="text-sm text-gray-900 bg-gray-50 p-2 rounded">${consultation.symptoms}</div>
                                                        </div>
                                                    ` : ''}
                                                    
                                                    ${consultation.currentHistory ? `
                                                        <div>
                                                            <div class="text-sm font-medium text-gray-700 mb-1">ç¾ç—…å²</div>
                                                            <div class="text-sm text-gray-900 bg-gray-50 p-2 rounded">${consultation.currentHistory}</div>
                                                        </div>
                                                    ` : ''}
                                                    
                                                    <div class="grid grid-cols-2 gap-3">
                                                        ${consultation.tongue ? `
                                                            <div>
                                                                <div class="text-sm font-medium text-gray-700 mb-1">èˆŒè±¡</div>
                                                                <div class="text-sm text-gray-900 bg-pink-50 p-2 rounded">${consultation.tongue}</div>
                                                            </div>
                                                        ` : ''}
                                                        
                                                        ${consultation.pulse ? `
                                                            <div>
                                                                <div class="text-sm font-medium text-gray-700 mb-1">è„ˆè±¡</div>
                                                                <div class="text-sm text-gray-900 bg-green-50 p-2 rounded">${consultation.pulse}</div>
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                                
                                                <!-- å³å´ï¼šè¨ºæ–·èˆ‡è™•æ–¹ -->
                                                <div class="space-y-3">
                                                    ${consultation.diagnosis ? `
                                                        <div>
                                                            <div class="text-sm font-medium text-gray-700 mb-1">ä¸­é†«è¨ºæ–·</div>
                                                            <div class="text-sm text-gray-900 bg-blue-50 p-2 rounded font-medium">${consultation.diagnosis}</div>
                                                        </div>
                                                    ` : ''}
                                                    
                                                    ${consultation.syndrome ? `
                                                        <div>
                                                            <div class="text-sm font-medium text-gray-700 mb-1">è­‰å‹è¨ºæ–·</div>
                                                            <div class="text-sm text-gray-900 bg-purple-50 p-2 rounded">${consultation.syndrome}</div>
                                                        </div>
                                                    ` : ''}
                                                    
                                                    ${consultation.prescription ? `
                                                        <div>
                                                            <div class="text-sm font-medium text-gray-700 mb-1">è™•æ–¹å…§å®¹</div>
                                                            <div class="text-sm text-gray-900 bg-yellow-50 p-2 rounded border-l-4 border-yellow-400">${consultation.prescription}</div>
                                                        </div>
                                                    ` : ''}
                                                    
                                                    <div class="grid grid-cols-1 gap-2">
                                                        ${consultation.usage ? `
                                                            <div>
                                                                <div class="text-xs font-medium text-gray-600 mb-1">æœç”¨æ–¹æ³•</div>
                                                                <div class="text-xs text-gray-800 bg-gray-50 p-2 rounded">${consultation.usage}</div>
                                                            </div>
                                                        ` : ''}
                                                        
                                                        ${consultation.treatmentCourse ? `
                                                            <div>
                                                                <div class="text-xs font-medium text-gray-600 mb-1">ç™‚ç¨‹</div>
                                                                <div class="text-xs text-gray-800 bg-gray-50 p-2 rounded">${consultation.treatmentCourse}</div>
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            ${consultation.instructions ? `
                                                <div class="mt-3 pt-3 border-t border-gray-200">
                                                    <div class="text-sm font-medium text-gray-700 mb-1">é†«å›‘åŠæ³¨æ„äº‹é …</div>
                                                    <div class="text-sm text-gray-900 bg-orange-50 p-2 rounded border-l-4 border-orange-400">${consultation.instructions}</div>
                                                </div>
                                            ` : ''}
                                            
                                            ${consultation.followUpDate ? `
                                                <div class="mt-3 pt-3 border-t border-gray-200">
                                                    <div class="text-sm font-medium text-gray-700 mb-1">å»ºè­°è¤‡è¨ºæ™‚é–“</div>
                                                    <div class="text-sm text-blue-600 font-medium">
                                                        ğŸ“… ${new Date(consultation.followUpDate).toLocaleString('zh-TW')}
                                                    </div>
                                                </div>
                                            ` : ''}
                                            
                                            ${consultation.updatedAt ? `
                                                <div class="mt-3 pt-2 border-t border-gray-100">
                                                    <div class="text-xs text-gray-500">
                                                        æœ€å¾Œæ›´æ–°ï¼š${new Date(consultation.updatedAt).toLocaleString('zh-TW')} 
                                                        ${consultation.updatedBy ? `(${consultation.updatedBy})` : ''}
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="text-center py-12">
                                <div class="text-6xl mb-4">ğŸ“‹</div>
                                <div class="text-gray-500 text-lg">å°šç„¡è¨ºç—‡è¨˜éŒ„</div>
                                <div class="text-gray-400 text-sm mt-2">ç—…äººé¦–æ¬¡å°±è¨ºæ™‚æœƒåœ¨æ­¤é¡¯ç¤ºè¨ºç—‡è¨˜éŒ„</div>
                            </div>
                        `}
                    </div>
                </div>
            `;

            document.getElementById('patientHistoryContent').innerHTML = content;
            document.getElementById('patientHistoryModal').classList.remove('hidden');
        }

        // é—œé–‰ç—…äººç—…æ­·å½ˆçª—
        function closePatientHistory() {
            document.getElementById('patientHistoryModal').classList.add('hidden');
        }

        // æœå°‹åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchPatient');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    loadPatientList();
                });
            }
        });

        // è¨ºç—‡ç³»çµ±åŠŸèƒ½
        let appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
        let currentConsultingAppointmentId = null;
        let selectedPatientForRegistration = null;
        
        function loadConsultationPatients() {
            loadTodayAppointments();
            clearPatientSearch();
        }
        
        // æœç´¢ç—…äººé€²è¡Œæ›è™Ÿ
        function searchPatientsForRegistration() {
            const searchTerm = document.getElementById('patientSearchInput').value.trim().toLowerCase();
            const resultsContainer = document.getElementById('patientSearchResults');
            const resultsList = document.getElementById('searchResultsList');
            
            if (searchTerm.length < 1) {
                resultsContainer.classList.add('hidden');
                return;
            }
            
            // æœç´¢åŒ¹é…çš„ç—…äºº
            const matchedPatients = patients.filter(patient => 
                patient.name.toLowerCase().includes(searchTerm) ||
                patient.phone.includes(searchTerm) ||
                (patient.patientNumber && patient.patientNumber.toLowerCase().includes(searchTerm))
            );
            
            if (matchedPatients.length === 0) {
                resultsList.innerHTML = `
                    <div class="p-4 text-center text-gray-500">
                        æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„ç—…äºº
                    </div>
                `;
                resultsContainer.classList.remove('hidden');
                return;
            }
            
            // é¡¯ç¤ºæœç´¢çµæœ
            resultsList.innerHTML = matchedPatients.map(patient => `
                <div class="p-4 hover:bg-gray-50 cursor-pointer transition duration-200" onclick="selectPatientForRegistration(${patient.id})">
                    <div>
                        <div class="font-semibold text-gray-900">${patient.name}</div>
                        <div class="text-sm text-gray-600">ç·¨è™Ÿï¼š${patient.patientNumber} | å¹´é½¡ï¼š${formatAge(patient.birthDate)} | æ€§åˆ¥ï¼š${patient.gender}</div>
                        <div class="text-sm text-gray-500">é›»è©±ï¼š${patient.phone}</div>
                    </div>
                </div>
            `).join('');
            
            resultsContainer.classList.remove('hidden');
        }
        
        // é¸æ“‡ç—…äººé€²è¡Œæ›è™Ÿ
        function selectPatientForRegistration(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) return;
            
            selectedPatientForRegistration = patient;
            showRegistrationModal(patient);
        }
        
        // æ¸…é™¤ç—…äººæœç´¢
        function clearPatientSearch() {
            document.getElementById('patientSearchInput').value = '';
            document.getElementById('patientSearchResults').classList.add('hidden');
            selectedPatientForRegistration = null;
        }
        

        
        // é¡¯ç¤ºæ›è™Ÿå½ˆçª—
        function showRegistrationModal(patient) {
            if (!patient) return;
            
            // é¡¯ç¤ºé¸ä¸­çš„ç—…äººè³‡è¨Š
            document.getElementById('selectedPatientInfo').innerHTML = `
                <div class="space-y-1">
                    <div><span class="font-medium">å§“åï¼š</span>${patient.name}</div>
                    <div><span class="font-medium">ç·¨è™Ÿï¼š</span>${patient.patientNumber}</div>
                    <div><span class="font-medium">å¹´é½¡ï¼š</span>${formatAge(patient.birthDate)} | <span class="font-medium">æ€§åˆ¥ï¼š</span>${patient.gender}</div>
                    <div><span class="font-medium">é›»è©±ï¼š</span>${patient.phone}</div>
                </div>
            `;
            
            // è¨­ç½®é è¨­æ›è™Ÿæ™‚é–“ç‚ºç•¶å‰æ™‚é–“ï¼ˆåŠ 5åˆ†é˜é¿å…æ™‚é–“éæœŸï¼‰
            const now = new Date();
            now.setMinutes(now.getMinutes() + 5); // åŠ 5åˆ†é˜
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const localDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
            
            document.getElementById('appointmentDateTime').value = localDateTime;
            
            clearRegistrationForm();
            document.getElementById('registrationModal').classList.remove('hidden');
        }
        
        // é—œé–‰æ›è™Ÿå½ˆçª—
        function closeRegistrationModal() {
            document.getElementById('registrationModal').classList.add('hidden');
            clearRegistrationForm();
            selectedPatientForRegistration = null;
        }
        
        // æ¸…ç©ºæ›è™Ÿè¡¨å–®
        function clearRegistrationForm() {
            document.getElementById('quickChiefComplaint').value = '';
        }
        
        // ç¢ºèªæ›è™Ÿ
        function confirmRegistration() {
            if (!selectedPatientForRegistration) {
                showToast('ç³»çµ±éŒ¯èª¤ï¼šæœªé¸æ“‡ç—…äººï¼', 'error');
                return;
            }
            
            const appointmentDateTime = document.getElementById('appointmentDateTime').value;
            const chiefComplaint = document.getElementById('quickChiefComplaint').value.trim();
            
            if (!appointmentDateTime) {
                showToast('è«‹é¸æ“‡æ›è™Ÿæ™‚é–“ï¼', 'error');
                return;
            }
            
            // é©—è­‰æ›è™Ÿæ™‚é–“ä¸èƒ½æ˜¯éå»æ™‚é–“ï¼ˆå…è¨±1åˆ†é˜çš„èª¤å·®ï¼‰
            const selectedTime = new Date(appointmentDateTime);
            const now = new Date();
            now.setMinutes(now.getMinutes() - 1); // å…è¨±1åˆ†é˜èª¤å·®
            if (selectedTime < now) {
                showToast('æ›è™Ÿæ™‚é–“ä¸èƒ½æ—©æ–¼ç¾åœ¨æ™‚é–“ï¼', 'error');
                return;
            }
            
            const appointment = {
                id: Date.now(),
                patientId: selectedPatientForRegistration.id,
                appointmentTime: selectedTime.toISOString(),
                chiefComplaint: chiefComplaint || 'ç„¡ç‰¹æ®Šä¸»è¨´',
                status: 'registered', // registered, waiting, consulting, completed
                createdAt: new Date().toISOString(),
                createdBy: currentUser
            };
            
            appointments.push(appointment);
            localStorage.setItem('appointments', JSON.stringify(appointments));
            
            showToast(`${selectedPatientForRegistration.name} æ›è™ŸæˆåŠŸï¼`, 'success');
            
            closeRegistrationModal();
            clearPatientSearch();
            loadTodayAppointments();
        }
        
        // è¼‰å…¥ä»Šæ—¥æ›è™Ÿåˆ—è¡¨
        function loadTodayAppointments() {
            const today = new Date().toDateString();
            const todayAppointments = appointments.filter(apt => 
                new Date(apt.appointmentTime).toDateString() === today
            ).sort((a, b) => new Date(a.appointmentTime) - new Date(b.appointmentTime));
            
            const tbody = document.getElementById('todayAppointmentsList');
            document.getElementById('todayTotal').textContent = todayAppointments.length;
            
            if (todayAppointments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            ä»Šæ—¥æš«ç„¡æ›è™Ÿè¨˜éŒ„
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = todayAppointments.map((appointment, index) => {
                const patient = patients.find(p => p.id === appointment.patientId);
                if (!patient) return '';
                
                const statusInfo = getStatusInfo(appointment.status);
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm text-gray-900">${index + 1}</td>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">
                            ${patient.name}
                            <div class="text-xs text-gray-500">${patient.patientNumber}</div>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900">
                            ${new Date(appointment.appointmentTime).toLocaleString('zh-TW', {
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900">
                            ${appointment.chiefComplaint || 'ç„¡'}
                        </td>
                        <td class="px-4 py-3">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusInfo.class}">
                                ${statusInfo.text}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm space-x-1">
                            ${getStatusUpdateButtons(appointment)}
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // ç²å–ç‹€æ…‹è³‡è¨Š
        function getStatusInfo(status) {
            const statusMap = {
                'registered': { text: 'å·²æ›è™Ÿ', class: 'bg-blue-100 text-blue-800' },
                'waiting': { text: 'å€™è¨ºä¸­', class: 'bg-yellow-100 text-yellow-800' },
                'consulting': { text: 'è¨ºç—‡ä¸­', class: 'bg-green-100 text-green-800' },
                'completed': { text: 'å·²å®Œæˆ', class: 'bg-gray-100 text-gray-800' }
            };
            return statusMap[status] || { text: 'æœªçŸ¥', class: 'bg-gray-100 text-gray-800' };
        }
        
        // ç²å–ç‹€æ…‹æ›´æ–°æŒ‰éˆ•
        function getStatusUpdateButtons(appointment) {
            // æ ¹æ“šç•¶å‰ç‹€æ…‹å’Œç”¨æˆ¶è§’è‰²é¡¯ç¤ºé©ç•¶çš„ç‹€æ…‹è½‰æ›æŒ‰éˆ•
            switch (appointment.status) {
                case 'registered':
                    // å·²æ›è™Ÿç‹€æ…‹ï¼šæ‰€æœ‰ç”¨æˆ¶éƒ½å¯ä»¥ç¢ºèªç—…äººåˆ°é”æˆ–åˆªé™¤æ›è™Ÿ
                    let registeredButtons = [];
                    registeredButtons.push(`<button onclick="confirmPatientArrival(${appointment.id})" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-xs transition duration-200">ç¢ºèªåˆ°é”</button>`);
                    registeredButtons.push(`<button onclick="viewPatientHistory(${appointment.patientId})" class="bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-xs transition duration-200 ml-1">æŸ¥çœ‹ç—…æ­·</button>`);
                    registeredButtons.push(`<button onclick="deleteAppointment(${appointment.id})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition duration-200 ml-1">åˆªé™¤æ›è™Ÿ</button>`);
                    return registeredButtons.join('');
                    
                case 'waiting':
                    // å€™è¨ºä¸­ç‹€æ…‹ï¼šæ‰€æœ‰ç”¨æˆ¶éƒ½å¯ä»¥æ“ä½œ
                    let waitingButtons = [];
                    waitingButtons.push(`<button onclick="startConsultation(${appointment.id})" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs transition duration-200">é–‹å§‹è¨ºç—‡</button>`);
                    waitingButtons.push(`<button onclick="viewPatientHistory(${appointment.patientId})" class="bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-xs transition duration-200 ml-1">æŸ¥çœ‹ç—…æ­·</button>`);
                    return waitingButtons.join('');
                    
                case 'consulting':
                    // è¨ºç—‡ä¸­ç‹€æ…‹ï¼šæ‰€æœ‰ç”¨æˆ¶éƒ½å¯ä»¥æ“ä½œ
                    let consultingButtons = [];
                    consultingButtons.push(`<span class="text-green-600 text-xs font-medium">è¨ºç—‡é€²è¡Œä¸­...</span>`);
                    consultingButtons.push(`<button onclick="viewPatientHistory(${appointment.patientId})" class="bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-xs transition duration-200 ml-1">æŸ¥çœ‹ç—…æ­·</button>`);
                    return consultingButtons.join('');
                    
                case 'completed':
                    // å·²å®Œæˆç‹€æ…‹ï¼šå¯ä»¥ä¿®æ”¹ç—…æ­·æˆ–é‡æ–°è¨­ç‚ºå€™è¨º
                    let completedButtons = [];
                    completedButtons.push(`<button onclick="editMedicalRecord(${appointment.id})" class="bg-orange-500 hover:bg-orange-600 text-white px-2 py-1 rounded text-xs transition duration-200">ä¿®æ”¹ç—…æ­·</button>`);
                    completedButtons.push(`<button onclick="viewPatientHistory(${appointment.patientId})" class="bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-xs transition duration-200 ml-1">æŸ¥çœ‹ç—…æ­·</button>`);
                    completedButtons.push(`<button onclick="resetToWaiting(${appointment.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs transition duration-200 ml-1">é‡æ–°å€™è¨º</button>`);
                    return completedButtons.join('');
                    
                default:
                    return '<span class="text-gray-400 text-xs">ç‹€æ…‹ç•°å¸¸</span>';
            }
        }
        
        // ç¢ºèªç—…äººåˆ°é”ï¼ˆåŠ©ç†æ“ä½œï¼‰
        function confirmPatientArrival(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) {
                showToast('æ‰¾ä¸åˆ°æ›è™Ÿè¨˜éŒ„ï¼', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            
            if (appointment.status !== 'registered') {
                showToast('åªèƒ½ç¢ºèªå·²æ›è™Ÿç‹€æ…‹çš„ç—…äººåˆ°é”ï¼', 'warning');
                return;
            }
            
            appointment.status = 'waiting';
            appointment.arrivedAt = new Date().toISOString();
            appointment.confirmedBy = currentUser;
            
            localStorage.setItem('appointments', JSON.stringify(appointments));
            showToast(`${patient.name} å·²ç¢ºèªåˆ°é”ï¼Œé€²å…¥å€™è¨ºç‹€æ…‹ï¼`, 'success');
            loadTodayAppointments();
        }
        
        // å–æ¶ˆå€™è¨ºï¼ˆåŠ©ç†æ“ä½œï¼‰
        function cancelWaiting(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) {
                showToast('æ‰¾ä¸åˆ°æ›è™Ÿè¨˜éŒ„ï¼', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            
            if (confirm(`ç¢ºå®šè¦å–æ¶ˆ ${patient.name} çš„å€™è¨ºç‹€æ…‹å—ï¼Ÿ\nç—…äººå°‡å›åˆ°å·²æ›è™Ÿç‹€æ…‹ã€‚`)) {
                appointment.status = 'registered';
                delete appointment.arrivedAt;
                delete appointment.confirmedBy;
                
                localStorage.setItem('appointments', JSON.stringify(appointments));
                showToast(`${patient.name} å·²å–æ¶ˆå€™è¨ºï¼Œå›åˆ°å·²æ›è™Ÿç‹€æ…‹ï¼`, 'success');
                loadTodayAppointments();
            }
        }
        
        // é‡æ–°è¨­ç‚ºå€™è¨ºï¼ˆç®¡ç†å“¡æ“ä½œï¼‰
        function resetToWaiting(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) {
                showToast('æ‰¾ä¸åˆ°æ›è™Ÿè¨˜éŒ„ï¼', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            
            if (confirm(`ç¢ºå®šè¦å°‡ ${patient.name} é‡æ–°è¨­ç‚ºå€™è¨ºç‹€æ…‹å—ï¼Ÿ`)) {
                appointment.status = 'waiting';
                appointment.resetAt = new Date().toISOString();
                appointment.resetBy = currentUser;
                
                localStorage.setItem('appointments', JSON.stringify(appointments));
                showToast(`${patient.name} å·²é‡æ–°è¨­ç‚ºå€™è¨ºç‹€æ…‹ï¼`, 'success');
                loadTodayAppointments();
            }
        }
        
        // åˆªé™¤æ›è™Ÿè¨˜éŒ„
        function deleteAppointment(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) {
                showToast('æ‰¾ä¸åˆ°æ›è™Ÿè¨˜éŒ„ï¼', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            if (!patient) {
                showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ï¼', 'error');
                return;
            }
            
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ ${patient.name} çš„æ›è™Ÿè¨˜éŒ„å—ï¼Ÿ\n\næ³¨æ„ï¼šæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) {
                // å¾æ›è™Ÿåˆ—è¡¨ä¸­ç§»é™¤
                appointments = appointments.filter(apt => apt.id !== appointmentId);
                localStorage.setItem('appointments', JSON.stringify(appointments));
                
                showToast(`${patient.name} çš„æ›è™Ÿè¨˜éŒ„å·²åˆªé™¤ï¼`, 'success');
                loadTodayAppointments();
                updateStatistics();
            }
        }
        
        // æŸ¥çœ‹ç—…äººè³‡è¨Š
        function viewPatientInfo(patientId) {
            viewPatient(patientId);
        }
        
        // ç²å–æ“ä½œæŒ‰éˆ•
        function getActionButtons(appointment) {
            switch (appointment.status) {
                case 'registered':
                    // å·²æ›è™Ÿç‹€æ…‹ï¼šå¯ä»¥æŸ¥çœ‹ç—…äººè³‡æ–™
                    return `<button onclick="viewPatientInfo(${appointment.patientId})" class="text-blue-600 hover:text-blue-800 font-medium">æŸ¥çœ‹ç—…äºº</button>`;
                    
                case 'waiting':
                    // å€™è¨ºä¸­ç‹€æ…‹ï¼šå¯ä»¥æŸ¥çœ‹ç—…äººè³‡æ–™
                    return `<button onclick="viewPatientInfo(${appointment.patientId})" class="text-blue-600 hover:text-blue-800 font-medium">æŸ¥çœ‹ç—…äºº</button>`;
                    
                case 'consulting':
                    // è¨ºç—‡ä¸­ç‹€æ…‹ï¼šæ‰€æœ‰ç”¨æˆ¶éƒ½å¯ä»¥ç¹¼çºŒè¨ºç—‡
                    return `<button onclick="continueConsultation(${appointment.id})" class="text-green-600 hover:text-green-800 font-medium">ç¹¼çºŒè¨ºç—‡</button>`;
                    
                case 'completed':
                    // å·²å®Œæˆç‹€æ…‹ï¼šå¯ä»¥æŸ¥çœ‹è¨ºç—‡è¨˜éŒ„
                    return `<button onclick="viewRecord(${appointment.id})" class="text-gray-600 hover:text-gray-800 font-medium">æŸ¥çœ‹è¨˜éŒ„</button>`;
                    
                default:
                    return '';
            }
        }
        
        // é–‹å§‹è¨ºç—‡ï¼ˆé†«å¸«æ“ä½œï¼‰
        function startConsultation(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) {
                showToast('æ‰¾ä¸åˆ°æ›è™Ÿè¨˜éŒ„ï¼', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            
            // æª¢æŸ¥ç—…äººæ˜¯å¦åœ¨å€™è¨ºç‹€æ…‹
            if (appointment.status !== 'waiting') {
                showToast('åªèƒ½å°å€™è¨ºä¸­çš„ç—…äººé–‹å§‹è¨ºç—‡ï¼', 'warning');
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦å·²æœ‰å…¶ä»–ç—…äººåœ¨è¨ºç—‡ä¸­
            const consultingAppointment = appointments.find(apt => 
                apt.status === 'consulting' && apt.id !== appointmentId
            );
            if (consultingAppointment) {
                const consultingPatient = patients.find(p => p.id === consultingAppointment.patientId);
                showToast(`${consultingPatient.name} æ­£åœ¨è¨ºç—‡ä¸­ï¼Œè«‹å…ˆå®Œæˆè©²ç—…äººçš„è¨ºç—‡ï¼`, 'warning');
                return;
            }
            
            // æ›´æ–°ç‹€æ…‹ç‚ºè¨ºç—‡ä¸­
            appointment.status = 'consulting';
            appointment.consultationStartTime = new Date().toISOString();
            appointment.consultingDoctor = currentUser;
            localStorage.setItem('appointments', JSON.stringify(appointments));
            
            currentConsultingAppointmentId = appointmentId;
            showConsultationForm(appointment);
            loadTodayAppointments();
            
            showToast(`é–‹å§‹ç‚º ${patient.name} è¨ºç—‡`, 'success');
        }
        
        // ç¹¼çºŒè¨ºç—‡
        function continueConsultation(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) return;
            
            currentConsultingAppointmentId = appointmentId;
            showConsultationForm(appointment);
        }
        

        
        // é¡¯ç¤ºè¨ºç—‡è¡¨å–®
        function showConsultationForm(appointment) {
            const patient = patients.find(p => p.id === appointment.patientId);
            if (!patient) return;
            
            // è¨­ç½®ç—…äººè³‡è¨Š
            document.getElementById('formPatientName').textContent = `${patient.name} (${patient.patientNumber})`;
            document.getElementById('formAppointmentTime').textContent = new Date(appointment.appointmentTime).toLocaleString('zh-TW');
            document.getElementById('formChiefComplaint').textContent = appointment.chiefComplaint || 'ç„¡';
            
            // é å¡«ä¸»è¨´ç—‡ç‹€
            if (appointment.chiefComplaint) {
                document.getElementById('formSymptoms').value = appointment.chiefComplaint;
            }
            
            // æ¸…ç©ºå…¶ä»–æ¬„ä½
            ['formTongue', 'formPulse', 'formCurrentHistory', 'formDiagnosis', 'formSyndrome', 'formPrescription', 'formUsage', 'formTreatmentCourse', 'formInstructions', 'formFollowUpDate'].forEach(id => {
                document.getElementById(id).value = '';
            });
            
            document.getElementById('consultationForm').classList.remove('hidden');
            
            // æ»¾å‹•åˆ°è¡¨å–®ä½ç½®
            document.getElementById('consultationForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        // é—œé–‰è¨ºç—‡è¡¨å–®
        function closeConsultationForm() {
            document.getElementById('consultationForm').classList.add('hidden');
            currentConsultingAppointmentId = null;
        }
        
        // å„²å­˜è¨ºç—‡è¨˜éŒ„ï¼ˆé†«å¸«æ“ä½œï¼‰
        function saveConsultation() {
            if (!currentConsultingAppointmentId) {
                showToast('ç³»çµ±éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è¨ºç—‡è¨˜éŒ„ï¼', 'error');
                return;
            }
            
            const appointment = appointments.find(apt => apt.id === currentConsultingAppointmentId);
            if (!appointment) {
                showToast('æ‰¾ä¸åˆ°æ›è™Ÿè¨˜éŒ„ï¼', 'error');
                return;
            }
            
            const symptoms = document.getElementById('formSymptoms').value.trim();
            const diagnosis = document.getElementById('formDiagnosis').value.trim();
            const syndrome = document.getElementById('formSyndrome').value.trim();
            const prescription = document.getElementById('formPrescription').value.trim();
            
            if (!symptoms || !diagnosis || !syndrome || !prescription) {
                showToast('è«‹å¡«å¯«å¿…å¡«æ¬„ä½ï¼šä¸»è¨´ã€ä¸­é†«è¨ºæ–·ã€è­‰å‹è¨ºæ–·ã€è™•æ–¹å…§å®¹ï¼', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºä¿®æ”¹ç—…æ­·æ¨¡å¼
            if (appointment.status === 'completed' && appointment.consultationId) {
                // ä¿®æ”¹ç¾æœ‰ç—…æ­·
                const existingConsultation = consultations.find(c => c.id === appointment.consultationId);
                if (existingConsultation) {
                    existingConsultation.symptoms = symptoms;
                    existingConsultation.tongue = document.getElementById('formTongue').value.trim();
                    existingConsultation.pulse = document.getElementById('formPulse').value.trim();
                    existingConsultation.currentHistory = document.getElementById('formCurrentHistory').value.trim();
                    existingConsultation.diagnosis = diagnosis;
                    existingConsultation.syndrome = syndrome;
                    existingConsultation.prescription = prescription;
                    existingConsultation.usage = document.getElementById('formUsage').value.trim();
                    existingConsultation.treatmentCourse = document.getElementById('formTreatmentCourse').value.trim();
                    existingConsultation.instructions = document.getElementById('formInstructions').value.trim();
                    existingConsultation.followUpDate = document.getElementById('formFollowUpDate').value;
                    existingConsultation.updatedAt = new Date().toISOString();
                    existingConsultation.updatedBy = currentUser;
                    
                    localStorage.setItem('consultations', JSON.stringify(consultations));
                    showToast(`${patient.name} çš„ç—…æ­·å·²æˆåŠŸæ›´æ–°ï¼`, 'success');
                }
            } else if (appointment.status === 'consulting') {
                // æ–°å¢è¨ºç—‡è¨˜éŒ„
                const consultation = {
                    id: Date.now(),
                    appointmentId: currentConsultingAppointmentId,
                    patientId: appointment.patientId,
                    symptoms: symptoms,
                    tongue: document.getElementById('formTongue').value.trim(),
                    pulse: document.getElementById('formPulse').value.trim(),
                    currentHistory: document.getElementById('formCurrentHistory').value.trim(),
                    diagnosis: diagnosis,
                    syndrome: syndrome,
                    prescription: prescription,
                    usage: document.getElementById('formUsage').value.trim(),
                    treatmentCourse: document.getElementById('formTreatmentCourse').value.trim(),
                    instructions: document.getElementById('formInstructions').value.trim(),
                    followUpDate: document.getElementById('formFollowUpDate').value,
                    date: new Date().toISOString(),
                    doctor: currentUser,
                    status: 'completed'
                };
                
                consultations.push(consultation);
                localStorage.setItem('consultations', JSON.stringify(consultations));
                
                // æ›´æ–°æ›è™Ÿç‹€æ…‹ç‚ºå·²å®Œæˆ
                appointment.status = 'completed';
                appointment.completedAt = new Date().toISOString();
                appointment.consultationId = consultation.id;
                appointment.completedBy = currentUser;
                localStorage.setItem('appointments', JSON.stringify(appointments));
                
                showToast(`${patient.name} çš„è¨ºç—‡è¨˜éŒ„å·²å®Œæˆä¸¦ä¿å­˜ï¼`, 'success');
            } else {
                showToast('åªèƒ½ä¿å­˜è¨ºç—‡ä¸­ç‹€æ…‹çš„è¨˜éŒ„æˆ–ä¿®æ”¹å·²å®Œæˆçš„ç—…æ­·ï¼', 'warning');
                return;
            }
            
            closeConsultationForm();
            loadTodayAppointments();
            updateStatistics();
        }
        
        // ä¿®æ”¹ç—…æ­·åŠŸèƒ½
        function editMedicalRecord(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment || !appointment.consultationId) {
                showToast('æ‰¾ä¸åˆ°è¨ºç—‡è¨˜éŒ„ï¼', 'warning');
                return;
            }
            
            const consultation = consultations.find(c => c.id === appointment.consultationId);
            const patient = patients.find(p => p.id === appointment.patientId);
            
            if (!consultation || !patient) {
                showToast('è¨ºç—‡è¨˜éŒ„è³‡æ–™ä¸å®Œæ•´ï¼', 'error');
                return;
            }
            
            // è¨­ç½®ç‚ºç·¨è¼¯æ¨¡å¼
            currentConsultingAppointmentId = appointmentId;
            
            // åœ¨è¡¨å–®ä¸­é¡¯ç¤ºè¨ºç—‡è¨˜éŒ„ï¼ˆç·¨è¼¯æ¨¡å¼ï¼‰
            document.getElementById('formPatientName').textContent = `${patient.name} (${patient.patientNumber})`;
            document.getElementById('formAppointmentTime').textContent = new Date(consultation.date).toLocaleString('zh-TW');
            document.getElementById('formChiefComplaint').textContent = appointment.chiefComplaint || 'ç„¡';
            
            // å¡«å…¥è¨ºç—‡è¨˜éŒ„ï¼ˆå¯ç·¨è¼¯ï¼‰
            document.getElementById('formSymptoms').value = consultation.symptoms || '';
            document.getElementById('formTongue').value = consultation.tongue || '';
            document.getElementById('formPulse').value = consultation.pulse || '';
            document.getElementById('formCurrentHistory').value = consultation.currentHistory || '';
            document.getElementById('formDiagnosis').value = consultation.diagnosis || '';
            document.getElementById('formSyndrome').value = consultation.syndrome || '';
            document.getElementById('formPrescription').value = consultation.prescription || '';
            document.getElementById('formUsage').value = consultation.usage || '';
            document.getElementById('formTreatmentCourse').value = consultation.treatmentCourse || '';
            document.getElementById('formInstructions').value = consultation.instructions || '';
            document.getElementById('formFollowUpDate').value = consultation.followUpDate || '';
            
            // ä¿®æ”¹æŒ‰éˆ•æ–‡å­—
            const saveButton = document.querySelector('#consultationForm button[onclick="saveConsultation()"]');
            if (saveButton) {
                saveButton.textContent = 'æ›´æ–°ç—…æ­·';
            }
            
            document.getElementById('consultationForm').classList.remove('hidden');
            document.getElementById('consultationForm').scrollIntoView({ behavior: 'smooth' });
            
            showToast('é€²å…¥ç—…æ­·ç·¨è¼¯æ¨¡å¼', 'info');
        }
        
        // æŸ¥çœ‹è¨ºç—‡è¨˜éŒ„
        function viewRecord(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment || !appointment.consultationId) {
                showToast('æ‰¾ä¸åˆ°è¨ºç—‡è¨˜éŒ„ï¼', 'warning');
                return;
            }
            
            const consultation = consultations.find(c => c.id === appointment.consultationId);
            const patient = patients.find(p => p.id === appointment.patientId);
            
            if (!consultation || !patient) {
                showToast('è¨ºç—‡è¨˜éŒ„è³‡æ–™ä¸å®Œæ•´ï¼', 'error');
                return;
            }
            
            // åœ¨è¡¨å–®ä¸­é¡¯ç¤ºè¨ºç—‡è¨˜éŒ„ï¼ˆåªè®€æ¨¡å¼ï¼‰
            document.getElementById('formPatientName').textContent = `${patient.name} (${patient.patientNumber})`;
            document.getElementById('formAppointmentTime').textContent = new Date(consultation.date).toLocaleString('zh-TW');
            document.getElementById('formChiefComplaint').textContent = appointment.chiefComplaint || 'ç„¡';
            
            // å¡«å…¥è¨ºç—‡è¨˜éŒ„ï¼ˆåªè®€ï¼‰
            document.getElementById('formSymptoms').value = consultation.symptoms || '';
            document.getElementById('formTongue').value = consultation.tongue || '';
            document.getElementById('formPulse').value = consultation.pulse || '';
            document.getElementById('formCurrentHistory').value = consultation.currentHistory || '';
            document.getElementById('formDiagnosis').value = consultation.diagnosis || '';
            document.getElementById('formSyndrome').value = consultation.syndrome || '';
            document.getElementById('formPrescription').value = consultation.prescription || '';
            document.getElementById('formUsage').value = consultation.usage || '';
            document.getElementById('formTreatmentCourse').value = consultation.treatmentCourse || '';
            document.getElementById('formInstructions').value = consultation.instructions || '';
            document.getElementById('formFollowUpDate').value = consultation.followUpDate || '';
            
            // è¨­ç½®ç‚ºåªè®€æ¨¡å¼
            ['formSymptoms', 'formTongue', 'formPulse', 'formCurrentHistory', 'formDiagnosis', 'formSyndrome', 'formPrescription', 'formUsage', 'formTreatmentCourse', 'formInstructions', 'formFollowUpDate'].forEach(id => {
                document.getElementById(id).readOnly = true;
            });
            
            // éš±è—å„²å­˜æŒ‰éˆ•ï¼Œåªé¡¯ç¤ºé—œé–‰æŒ‰éˆ•
            const saveButton = document.querySelector('#consultationForm button[onclick="saveConsultation()"]');
            if (saveButton) {
                saveButton.style.display = 'none';
            }
            
            document.getElementById('consultationForm').classList.remove('hidden');
            document.getElementById('consultationForm').scrollIntoView({ behavior: 'smooth' });
            
            // ç•¶é—œé–‰æ™‚æ¢å¾©ç·¨è¼¯æ¨¡å¼
            const originalClose = closeConsultationForm;
            window.closeConsultationForm = function() {
                ['formSymptoms', 'formTongue', 'formPulse', 'formCurrentHistory', 'formDiagnosis', 'formSyndrome', 'formPrescription', 'formUsage', 'formTreatmentCourse', 'formInstructions', 'formFollowUpDate'].forEach(id => {
                    document.getElementById(id).readOnly = false;
                });
                if (saveButton) {
                    saveButton.style.display = 'inline-block';
                    saveButton.textContent = 'å®Œæˆè¨ºç—‡';
                }
                window.closeConsultationForm = originalClose;
                originalClose();
            };
        }







        // ç³»çµ±ç®¡ç†åŠŸèƒ½
        function updateStatistics() {
            document.getElementById('totalPatients').textContent = patients.length;
            
            const today = new Date().toDateString();
            const todayConsultations = consultations.filter(c => 
                new Date(c.date).toDateString() === today
            ).length;
            document.getElementById('todayConsultations').textContent = todayConsultations;
            
            const thisMonth = new Date().getMonth();
            const monthlyConsultations = consultations.filter(c => 
                new Date(c.date).getMonth() === thisMonth
            ).length;
            document.getElementById('monthlyConsultations').textContent = monthlyConsultations;
        }

        function exportData() {
            const data = {
                patients: patients,
                consultations: consultations,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `è¨ºæ‰€è³‡æ–™_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('è³‡æ–™åŒ¯å‡ºå®Œæˆï¼', 'success');
        }

        function backupData() {
            const backup = {
                patients: patients,
                consultations: consultations,
                backupDate: new Date().toISOString()
            };
            localStorage.setItem('clinicBackup', JSON.stringify(backup));
            showToast('è³‡æ–™å‚™ä»½å®Œæˆï¼', 'success');
        }

        function clearData() {
            if (confirm('è­¦å‘Šï¼šæ­¤æ“ä½œå°‡æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                if (confirm('æœ€å¾Œç¢ºèªï¼šæ‰€æœ‰ç—…äººè³‡æ–™å’Œè¨ºç—‡è¨˜éŒ„å°‡è¢«æ°¸ä¹…åˆªé™¤ï¼')) {
                    localStorage.removeItem('patients');
                    localStorage.removeItem('consultations');
                    patients = [];
                    consultations = [];
                    updateStatistics();
                    showToast('æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤ï¼', 'success');
                }
            }
        }

        // åˆå§‹åŒ–ç³»çµ±
        document.addEventListener('DOMContentLoaded', function() {
            updateStatistics();
            
            // è¨ºç—‡ç³»çµ±æœƒåœ¨è¼‰å…¥æ™‚è‡ªå‹•è¨­ç½®æœå°‹åŠŸèƒ½
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96861e57937bdd40',t:'MTc1NDA1OTUxOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
