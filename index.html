<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中藥資料庫 - 雲端版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, push, onValue, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBtUcrBYiE4B1O4xkvIqwxM52Hrh-i6pL8",
            authDomain: "cheungec-ea477.firebaseapp.com",
            databaseURL: "https://cheungec-ea477-default-rtdb.firebaseio.com/",
            projectId: "cheungec-ea477",
            storageBucket: "cheungec-ea477.firebasestorage.app",
            messagingSenderId: "986510230799",
            appId: "1:986510230799:web:f603e67b605e71294f2a7a"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Make Firebase functions globally available
        window.firebaseDB = {
            ref: ref,
            set: set,
            get: get,
            push: push,
            onValue: onValue,
            remove: remove,
            database: database
        };
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-6xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                        <span class="text-white font-bold">中</span>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">中藥資料庫</h1>
                        <p class="text-sm text-gray-600">雲端版</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="connectionStatus" class="flex items-center space-x-2">
                        <div class="w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></div>
                        <span class="text-sm text-gray-600">連線中</span>
                    </div>
                    <div class="text-sm text-gray-500">v2.0</div>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-6xl mx-auto px-6 py-8">
        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50">
            <div class="text-center">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-gray-600">正在載入資料...</p>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div id="mainContent" class="grid grid-cols-1 lg:grid-cols-3 gap-8 hidden">
            
            <!-- Left Panel - Search -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Search Section -->
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        搜尋功能
                    </h2>
                    
                    <div class="mb-4">
                        <input 
                            type="text" 
                            id="searchInput" 
                            placeholder="輸入中藥名稱或症狀..."
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                        >
                    </div>

                    <div class="flex space-x-3">
                        <button id="searchBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                            🔍 搜尋
                        </button>
                        <button id="clearBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                            清除
                        </button>
                    </div>
                </div>


            </div>

            <!-- Right Panel - Data Import -->
            <div class="space-y-6">
                <!-- Data Import Section -->
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        資料導入
                    </h2>
                    
                    <!-- Smart Input Area -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            智能格式識別
                        </label>
                        <div class="flex items-center justify-between mb-2">
                            <div id="formatHint" class="text-xs text-blue-600"></div>
                        </div>
                        <textarea 
                            id="importData" 
                            placeholder="支援多種格式，例如：&#10;當歸：補血調經，活血止痛&#10;黃芪,補氣固表、利尿托毒&#10;人參→大補元氣，復脈固脫..."
                            class="w-full h-32 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-none text-sm"
                        ></textarea>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="space-y-3">
                        <button id="importBtn" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-medium transition-colors">
                            ⬆️ 智能導入到雲端
                        </button>
                        
                        <!-- Progress Bar -->
                        <div id="progressContainer" class="hidden bg-gray-50 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-2">
                                <span id="progressText" class="text-sm text-gray-600">準備導入...</span>
                                <span id="progressPercent" class="text-sm font-medium text-blue-600">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <button id="clearAllBtn" class="bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg font-medium transition-colors text-sm">
                                🗑️ 清空輸入
                            </button>
                            <button id="clearDatabaseBtn" class="bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg font-medium transition-colors text-sm">
                                💥 清空資料庫
                            </button>
                        </div>
                    </div>
                    
                    <!-- Quick Templates -->
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <p class="text-sm text-gray-600 mb-2">快速範本：</p>
                        <div class="grid grid-cols-2 gap-2">
                            <button id="sampleData1" class="text-xs bg-blue-50 hover:bg-blue-100 text-blue-700 px-3 py-2 rounded border transition-colors">
                                📚 基礎中藥
                            </button>
                            <button id="sampleData2" class="text-xs bg-green-50 hover:bg-green-100 text-green-700 px-3 py-2 rounded border transition-colors">
                                🌿 常用方劑
                            </button>
                            <button id="sampleData3" class="text-xs bg-purple-50 hover:bg-purple-100 text-purple-700 px-3 py-2 rounded border transition-colors">
                                💊 現代應用
                            </button>
                            <button id="sampleData4" class="text-xs bg-orange-50 hover:bg-orange-100 text-orange-700 px-3 py-2 rounded border transition-colors">
                                🔄 混合格式
                            </button>
                            <button id="sampleData5" class="text-xs bg-pink-50 hover:bg-pink-100 text-pink-700 px-3 py-2 rounded border transition-colors col-span-2">
                                ✨ 標點符號範例
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        統計資訊
                    </h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">中藥數量</span>
                            <span id="herbCount" class="font-semibold text-blue-600">載入中...</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">症狀數量</span>
                            <span id="symptomCount" class="font-semibold text-green-600">載入中...</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">總記錄數</span>
                            <span id="recordCount" class="font-semibold text-purple-600">載入中...</span>
                        </div>
                    </div>
                </div>


            </div>
        </div>

        <!-- Data Display -->
        <div id="dataDisplay" class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-8 hidden">
            <!-- Herbs List -->
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
                    中藥列表
                </h3>
                <div id="herbsList" class="max-h-64 overflow-y-auto space-y-2">
                    <p class="text-gray-500 text-center py-8">載入中...</p>
                </div>
            </div>

            <!-- Symptoms List -->
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                    症狀列表
                </h3>
                <div id="symptomsList" class="max-h-64 overflow-y-auto space-y-2">
                    <p class="text-gray-500 text-center py-8">載入中...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Results Modal -->
    <div id="searchModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">搜尋結果</h3>
                        <p id="modalSearchQuery" class="text-sm text-gray-600"></p>
                    </div>
                </div>
                <button id="closeModal" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Modal Content -->
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                <div id="modalResultsContainer">
                    <!-- Results will be populated here -->
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="flex items-center justify-between p-6 border-t border-gray-200 bg-gray-50">
                <div class="flex items-center space-x-4">
                    <span id="modalResultCount" class="text-sm text-gray-600"></span>
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                        <span class="text-xs text-gray-500">中藥</span>
                        <div class="w-3 h-3 bg-green-500 rounded-full ml-4"></div>
                        <span class="text-xs text-gray-500">症狀</span>
                    </div>
                </div>
                <button id="newSearchBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    🔍 新搜尋
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50">
        <div class="flex items-center space-x-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span id="toastMessage">操作成功</span>
        </div>
    </div>

    <script>
        // Global variables
        let herbsData = {};
        let symptomsData = {};
        let recordsData = {};
        let isFirebaseReady = false;

        // DOM elements
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const clearBtn = document.getElementById('clearBtn');
        const importData = document.getElementById('importData');
        const importBtn = document.getElementById('importBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const clearDatabaseBtn = document.getElementById('clearDatabaseBtn');
        const herbCount = document.getElementById('herbCount');
        const symptomCount = document.getElementById('symptomCount');
        const recordCount = document.getElementById('recordCount');
        const herbsList = document.getElementById('herbsList');
        const symptomsList = document.getElementById('symptomsList');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const mainContent = document.getElementById('mainContent');
        const dataDisplay = document.getElementById('dataDisplay');
        const connectionStatus = document.getElementById('connectionStatus');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        
        // Modal elements
        const searchModal = document.getElementById('searchModal');
        const modalResultsContainer = document.getElementById('modalResultsContainer');
        const modalSearchQuery = document.getElementById('modalSearchQuery');
        const modalResultCount = document.getElementById('modalResultCount');
        const closeModal = document.getElementById('closeModal');
        const newSearchBtn = document.getElementById('newSearchBtn');
        
        // Smart import elements
        const formatHint = document.getElementById('formatHint');
        const sampleData1 = document.getElementById('sampleData1');
        const sampleData2 = document.getElementById('sampleData2');
        const sampleData3 = document.getElementById('sampleData3');
        const sampleData4 = document.getElementById('sampleData4');
        const sampleData5 = document.getElementById('sampleData5');
        
        // Progress bar elements
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const progressPercent = document.getElementById('progressPercent');

        // Wait for Firebase to be ready
        function waitForFirebase() {
            return new Promise((resolve) => {
                const checkFirebase = () => {
                    if (window.firebaseDB) {
                        resolve();
                    } else {
                        setTimeout(checkFirebase, 100);
                    }
                };
                checkFirebase();
            });
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            toastMessage.textContent = message;
            toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-transform duration-300 z-50 ${
                type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            } text-white`;
            toast.style.transform = 'translateX(0)';
            
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
            }, 3000);
        }

        // Initialize Firebase listeners
        async function initializeFirebase() {
            try {
                await waitForFirebase();
                
                // Listen to records data
                const recordsRef = window.firebaseDB.ref(window.firebaseDB.database, 'tcm-records');
                window.firebaseDB.onValue(recordsRef, (snapshot) => {
                    const data = snapshot.val();
                    recordsData = data || {};
                    processRecordsData();
                    updateDisplay();
                    
                    if (!isFirebaseReady) {
                        isFirebaseReady = true;
                        loadingIndicator.classList.add('hidden');
                        mainContent.classList.remove('hidden');
                        dataDisplay.classList.remove('hidden');
                        showToast('資料載入完成', 'success');
                    }
                });

                // Start connection monitoring
                monitorConnection();
            } catch (error) {
                console.error('Firebase initialization error:', error);
                updateConnectionStatus(false);
                showToast('連線失敗，使用離線模式', 'error');
                
                // Show content anyway for demo
                loadingIndicator.classList.add('hidden');
                mainContent.classList.remove('hidden');
                dataDisplay.classList.remove('hidden');
            }
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            const statusDot = connectionStatus.querySelector('div');
            const statusText = connectionStatus.querySelector('span');
            
            if (connected) {
                statusDot.className = 'w-2 h-2 bg-green-400 rounded-full';
                statusText.textContent = '已連線';
            } else {
                statusDot.className = 'w-2 h-2 bg-red-400 rounded-full animate-pulse';
                statusText.textContent = '離線';
            }
        }

        // Real-time connection monitoring
        function monitorConnection() {
            const connectedRef = window.firebaseDB.ref(window.firebaseDB.database, '.info/connected');
            window.firebaseDB.onValue(connectedRef, (snapshot) => {
                const connected = snapshot.val();
                updateConnectionStatus(connected);
                
                if (connected) {
                    console.log('Firebase connected');
                } else {
                    console.log('Firebase disconnected');
                }
            });
        }

        // Progress bar functions
        function showProgress() {
            progressContainer.classList.remove('hidden');
            importBtn.disabled = true;
            importBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }

        function hideProgress() {
            progressContainer.classList.add('hidden');
            importBtn.disabled = false;
            importBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            updateProgress(0, '準備導入...');
        }

        function updateProgress(percent, text) {
            progressBar.style.width = percent + '%';
            progressPercent.textContent = Math.round(percent) + '%';
            progressText.textContent = text;
        }

        // Process records data into herbs and symptoms
        function processRecordsData() {
            herbsData = {};
            symptomsData = {};

            Object.values(recordsData).forEach(record => {
                const herb = record.herb;
                const symptom = record.symptom;

                // Add to herbs data
                if (!herbsData[herb]) {
                    herbsData[herb] = [];
                }
                if (!herbsData[herb].includes(symptom)) {
                    herbsData[herb].push(symptom);
                }

                // Add to symptoms data
                if (!symptomsData[symptom]) {
                    symptomsData[symptom] = [];
                }
                if (!symptomsData[symptom].includes(herb)) {
                    symptomsData[symptom].push(herb);
                }
            });
        }

        // Smart data parsing functions
        function detectFormat(text) {
            const lines = text.split('\n').filter(line => line.trim());
            if (lines.length === 0) return 'unknown';
            
            const formats = {
                colon: 0,
                comma: 0,
                tab: 0,
                space: 0,
                arrow: 0,
                bracket: 0,
                json: 0
            };
            
            lines.forEach(line => {
                if (line.includes('：') || line.includes(':')) formats.colon++;
                if (line.includes(',')) formats.comma++;
                if (line.includes('\t')) formats.tab++;
                if (line.includes('→') || line.includes('->')) formats.arrow++;
                if (line.includes('[') && line.includes(']')) formats.bracket++;
                if (line.includes(' ') && !line.includes('：') && !line.includes(',') && !line.includes('\t')) formats.space++;
                if (line.trim().startsWith('{') || line.trim().startsWith('[')) formats.json++;
            });
            
            return Object.keys(formats).reduce((a, b) => formats[a] > formats[b] ? a : b);
        }

        function parseDataByFormat(text, format) {
            const lines = text.split('\n').filter(line => line.trim());
            const results = [];
            
            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (!trimmedLine) return;
                
                let herb = '', symptomsText = '';
                
                try {
                    // Try different formats in order
                    if (trimmedLine.includes('：')) {
                        [herb, symptomsText] = trimmedLine.split('：');
                    } else if (trimmedLine.includes(':')) {
                        [herb, symptomsText] = trimmedLine.split(':');
                    } else if (trimmedLine.includes(',')) {
                        [herb, symptomsText] = trimmedLine.split(',');
                    } else if (trimmedLine.includes('\t')) {
                        [herb, symptomsText] = trimmedLine.split('\t');
                    } else if (trimmedLine.includes('→')) {
                        [herb, symptomsText] = trimmedLine.split('→');
                    } else if (trimmedLine.includes('->')) {
                        [herb, symptomsText] = trimmedLine.split('->');
                    } else if (trimmedLine.includes('[') && trimmedLine.includes(']')) {
                        const bracketMatch = trimmedLine.match(/^(.+?)\[(.+?)\]$/);
                        if (bracketMatch) {
                            herb = bracketMatch[1];
                            symptomsText = bracketMatch[2];
                        }
                    } else if (trimmedLine.includes(' ')) {
                        const parts = trimmedLine.split(' ');
                        if (parts.length >= 2) {
                            herb = parts[0];
                            symptomsText = parts.slice(1).join(' ');
                        }
                    } else if (trimmedLine.startsWith('{')) {
                        try {
                            const jsonData = JSON.parse(trimmedLine);
                            if (jsonData.herb && jsonData.symptom) {
                                herb = jsonData.herb;
                                symptomsText = jsonData.symptom;
                            } else if (jsonData.name && jsonData.effect) {
                                herb = jsonData.name;
                                symptomsText = jsonData.effect;
                            }
                        } catch (e) {
                            // Invalid JSON, skip
                        }
                    }
                    
                    if (herb && symptomsText) {
                        herb = herb.trim().replace(/[^\u4e00-\u9fa5a-zA-Z0-9、]/g, '');
                        symptomsText = symptomsText.trim();
                        
                        // Split multiple symptoms by all common separators and punctuation
                        const symptoms = symptomsText.split(/[，,、；;|\/\\。！？…：「」『』《》〈〉【】〔〕（）()＼/]/)
                            .map(s => s.trim().replace(/^[，。、；：！？…\s「」『』《》〈〉【】〔〕（）()＼/]+|[，。、；：！？…\s「」『』《》〈〉【】〔〕（）()＼/]+$/g, ''))
                            .filter(s => s.length > 0 && s !== '　'); // Filter out empty strings and full-width spaces
                        
                        // Create a result for each symptom
                        symptoms.forEach(symptom => {
                            if (herb && symptom) {
                                results.push({ herb, symptom, original: trimmedLine });
                            }
                        });
                    }
                } catch (error) {
                    console.warn('Parse error for line:', trimmedLine, error);
                }
            });
            
            return results;
        }

        // Import data to Firebase with robust error handling
        async function importDataFunction() {
            const data = importData.value.trim();
            if (!data) {
                showToast('請輸入要導入的資料', 'error');
                return;
            }

            // Parse data with auto-detection
            const detectedFormat = detectFormat(data);
            const parsedData = parseDataByFormat(data, detectedFormat);
            
            if (parsedData.length === 0) {
                showToast('沒有有效的資料可以導入', 'error');
                return;
            }

            // Remove duplicates and prepare data
            const seen = new Set();
            const validData = [];
            let skipCount = 0;

            // Show progress bar
            showProgress();
            updateProgress(5, '📋 資料預處理中...');

            // Pre-process all data
            parsedData.forEach(item => {
                const key = `${item.herb}_${item.symptom}`;
                if (seen.has(key)) return;
                seen.add(key);

                const recordKey = `${item.herb}_${item.symptom}`.replace(/[.#$[\]]/g, '_');
                
                // Check for duplicates in existing data
                if (recordsData[recordKey]) {
                    skipCount++;
                    return;
                }

                validData.push({
                    key: recordKey,
                    herb: item.herb,
                    symptom: item.symptom,
                    timestamp: Date.now()
                });
            });

            const totalItems = validData.length;
            
            if (totalItems === 0) {
                updateProgress(100, '沒有新資料需要導入');
                await new Promise(resolve => setTimeout(resolve, 600));
                hideProgress();
                showToast(`所有 ${skipCount} 筆資料已存在，無需重複導入`, 'info');
                return;
            }

            try {
                updateProgress(15, `📤 準備導入 ${totalItems} 筆資料...`);

                // Always use safe individual writes for maximum reliability
                let completed = 0;
                let failed = 0;
                const batchSize = 10; // Conservative batch size
                
                // Process in small batches to avoid overwhelming Firebase
                for (let i = 0; i < validData.length; i += batchSize) {
                    const batch = validData.slice(i, i + batchSize);
                    
                    updateProgress(
                        15 + (i / validData.length) * 70, 
                        `📝 處理第 ${Math.floor(i/batchSize) + 1} 批 (${i + 1}-${Math.min(i + batchSize, validData.length)})`
                    );

                    // Process batch items with individual error handling
                    const batchPromises = batch.map(async (item) => {
                        try {
                            // Check if Firebase is available
                            if (!window.firebaseDB || !window.firebaseDB.database) {
                                throw new Error('Firebase 未初始化');
                            }

                            const recordRef = window.firebaseDB.ref(window.firebaseDB.database, `tcm-records/${item.key}`);
                            await window.firebaseDB.set(recordRef, {
                                herb: item.herb,
                                symptom: item.symptom,
                                timestamp: item.timestamp
                            });
                            
                            completed++;
                            return { success: true, item };
                        } catch (error) {
                            console.warn('Single item failed:', item, error);
                            failed++;
                            return { success: false, item, error };
                        }
                    });

                    // Wait for current batch to complete
                    await Promise.all(batchPromises);
                    
                    // Small delay between batches to prevent rate limiting
                    if (i + batchSize < validData.length) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }

                // Final progress
                updateProgress(90, '✅ 導入完成，正在同步...');
                await new Promise(resolve => setTimeout(resolve, 500));
                updateProgress(100, '🎉 同步完成！');

                // Wait briefly before hiding
                await new Promise(resolve => setTimeout(resolve, 800));

                importData.value = '';
                formatHint.textContent = '';
                
                let message = `✅ 成功導入 ${completed} 筆資料`;
                if (failed > 0) {
                    message += `，${failed} 筆失敗`;
                }
                if (skipCount > 0) {
                    message += `，跳過 ${skipCount} 筆重複`;
                }
                
                showToast(message, completed > 0 ? 'success' : 'error');
                
            } catch (error) {
                console.error('Import error:', error);
                updateProgress(100, '❌ 導入失敗');
                
                let errorMessage = '導入失敗';
                if (error.message) {
                    if (error.message.includes('permission') || error.message.includes('PERMISSION')) {
                        errorMessage = '權限不足，請檢查 Firebase 設定';
                    } else if (error.message.includes('network') || error.message.includes('offline')) {
                        errorMessage = '網路連線問題，請檢查網路後重試';
                    } else if (error.message.includes('Firebase')) {
                        errorMessage = 'Firebase 連線問題，請重新整理頁面';
                    } else {
                        errorMessage = `導入失敗: ${error.message}`;
                    }
                }
                
                showToast(errorMessage, 'error');
                
                // Wait before hiding progress
                await new Promise(resolve => setTimeout(resolve, 1000));
            } finally {
                hideProgress();
            }
        }





        // Clear input data
        function clearAllData() {
            if (!confirm('確定要清空輸入欄的資料嗎？')) {
                return;
            }

            importData.value = '';
            formatHint.textContent = '';
            showToast('輸入資料已清空', 'success');
        }

        // Clear entire database
        async function clearDatabase() {
            if (!confirm('⚠️ 警告：這將清除整個資料庫的所有內容！\n\n此操作無法復原，確定要繼續嗎？')) {
                return;
            }

            // Double confirmation for safety
            if (!confirm('🚨 最後確認：您即將刪除整個資料庫！\n\n請再次確認您真的要執行此操作？')) {
                return;
            }

            if (!isFirebaseReady) {
                showToast('正在連線中，請稍候...', 'info');
                return;
            }

            try {
                showProgress();
                updateProgress(20, '🗑️ 正在清除資料庫...');
                
                // Clear only the tcm-records node instead of entire database
                const recordsRef = window.firebaseDB.ref(window.firebaseDB.database, 'tcm-records');
                await window.firebaseDB.set(recordsRef, null);
                
                updateProgress(80, '✅ 資料庫已清除');
                await new Promise(resolve => setTimeout(resolve, 500));
                updateProgress(100, '🎉 清除完成');
                
                // Reset local data
                herbsData = {};
                symptomsData = {};
                recordsData = {};
                
                // Clear search input
                searchInput.value = '';
                
                // Hide modal if open
                if (!searchModal.classList.contains('hidden')) {
                    hideModal();
                }
                
                showToast('💥 整個資料庫已清除', 'success');
                
                setTimeout(() => {
                    hideProgress();
                }, 1000);
                
            } catch (error) {
                console.error('Database clear error:', error);
                
                let errorMessage = '清除資料庫失敗';
                if (error.message) {
                    if (error.message.includes('permission') || error.message.includes('PERMISSION')) {
                        errorMessage = '權限不足，無法清除資料庫';
                    } else if (error.message.includes('network') || error.message.includes('offline')) {
                        errorMessage = '網路連線問題，請檢查網路後重試';
                    } else if (error.message.includes('Firebase')) {
                        errorMessage = 'Firebase 連線問題，請重新整理頁面';
                    } else {
                        errorMessage = `清除失敗: ${error.message}`;
                    }
                }
                
                showToast(errorMessage, 'error');
                hideProgress();
            }
        }

        // Traditional-Simplified Chinese conversion maps
        const traditionalToSimplified = {
            '當': '当', '歸': '归', '補': '补', '調': '调', '經': '经', '潤': '润', '腸': '肠', '黃': '黄', '氣': '气', '錶': '表', '膿': '脓', '瘡': '疮', '復': '复', '脈': '脉', '脫': '脱', '養': '养', '血': '血', '祛': '祛', '風': '风', '緩': '缓', '陰': '阴', '滋': '滋', '腎': '肾', '精': '精', '髓': '髓', '寧': '宁', '神': '神', '濕': '湿', '痰': '痰', '鬱': '郁', '營': '营', '衛': '卫', '發': '发', '汗': '汗', '宣': '宣', '肺': '肺', '喘': '喘', '攻': '攻', '燥': '燥', '實': '实', '瀉': '泻', '火': '火', '藍': '蓝', '涼': '凉', '咽': '咽', '銀': '银', '疏': '疏', '散': '散', '熱': '热', '腫': '肿', '結': '结', '癰': '痈', '淋': '淋', '腥': '腥', '草': '草', '排': '排', '葉': '叶', '嘔': '呕', '貝': '贝', '母': '母', '煩': '烦', '紅': '红', '花': '花', '瘀': '瘀', '桃': '桃', '仁': '仁', '膝': '膝', '強': '强', '筋': '筋', '骨': '骨', '傷': '伤', '沒': '没', '藥': '药', '竭': '竭', '斂': '敛', '機': '机', '體': '体', '療': '疗', '證': '证', '診': '诊', '斷': '断', '處': '处', '方': '方', '劑': '剂', '湯': '汤', '丸': '丸', '膏': '膏', '飲': '饮', '顆': '颗', '粒': '粒', '針': '针', '灸': '灸', '推': '推', '拿': '拿', '按': '按', '摩': '摩', '穴': '穴', '位': '位', '經': '经', '絡': '络', '臟': '脏', '腑': '腑', '陽': '阳', '虛': '虚', '實': '实', '寒': '寒', '溫': '温', '涼': '凉', '燥': '燥', '濕': '湿', '風': '风', '暑': '暑', '火': '火', '燥': '燥', '濕': '湿', '寒': '寒', '熱': '热', '虛': '虚', '實': '实', '陰': '阴', '陽': '阳', '氣': '气', '血': '血', '津': '津', '液': '液', '精': '精', '神': '神', '魂': '魂', '魄': '魄', '意': '意', '志': '志', '思': '思', '慮': '虑', '智': '智', '慧': '慧'
        };

        const simplifiedToTraditional = {};
        Object.keys(traditionalToSimplified).forEach(trad => {
            const simp = traditionalToSimplified[trad];
            simplifiedToTraditional[simp] = trad;
        });

        // Convert text between Traditional and Simplified Chinese
        function convertToSimplified(text) {
            return text.split('').map(char => traditionalToSimplified[char] || char).join('');
        }

        function convertToTraditional(text) {
            return text.split('').map(char => simplifiedToTraditional[char] || char).join('');
        }

        // Enhanced similarity calculation with Traditional/Simplified support and crash protection
        function calculateSimilarity(text, query) {
            try {
                // Input validation
                if (!text || !query || typeof text !== 'string' || typeof query !== 'string') {
                    return 0;
                }
                
                // Prevent infinite loops with very long strings
                if (text.length > 100 || query.length > 100) {
                    // Fallback to simple comparison for very long strings
                    if (text === query) return 1000;
                    if (text.includes(query)) return 400;
                    return 0;
                }
                
                const textLower = text.toLowerCase();
                const queryLower = query.toLowerCase();
                
                // Convert to both Traditional and Simplified for comparison with error handling
                let textSimp, textTrad, querySimp, queryTrad;
                try {
                    textSimp = convertToSimplified(text);
                    textTrad = convertToTraditional(text);
                    querySimp = convertToSimplified(query);
                    queryTrad = convertToTraditional(query);
                } catch (conversionError) {
                    // Fallback to original strings if conversion fails
                    textSimp = text;
                    textTrad = text;
                    querySimp = query;
                    queryTrad = query;
                }
                
                // Test all combinations with safety checks
                const testCombinations = [
                    { text: textLower, query: queryLower },
                    { text: textSimp.toLowerCase(), query: queryLower },
                    { text: textTrad.toLowerCase(), query: queryLower },
                    { text: textLower, query: querySimp.toLowerCase() },
                    { text: textLower, query: queryTrad.toLowerCase() },
                    { text: textSimp.toLowerCase(), query: querySimp.toLowerCase() },
                    { text: textTrad.toLowerCase(), query: queryTrad.toLowerCase() },
                    { text: textSimp.toLowerCase(), query: queryTrad.toLowerCase() },
                    { text: textTrad.toLowerCase(), query: querySimp.toLowerCase() }
                ];
                
                let maxScore = 0;
                
                testCombinations.forEach(combo => {
                    try {
                        // Safety check for combo properties
                        if (!combo.text || !combo.query || typeof combo.text !== 'string' || typeof combo.query !== 'string') {
                            return;
                        }
                        
                        let score = 0;
                        
                        // Exact match gets highest score
                        if (combo.text === combo.query) score = 1000;
                        // Starts with query gets high score
                        else if (combo.text.startsWith(combo.query)) score = 800;
                        // Ends with query gets medium-high score
                        else if (combo.text.endsWith(combo.query)) score = 600;
                        // Contains query gets medium score
                        else if (combo.text.includes(combo.query)) score = 400;
                        else {
                            // Calculate character overlap score with bounds checking
                            let overlapScore = 0;
                            const maxIterations = Math.min(combo.query.length, 50); // Prevent excessive iterations
                            
                            for (let i = 0; i < maxIterations; i++) {
                                if (combo.text.includes(combo.query[i])) {
                                    overlapScore += 10;
                                }
                            }
                            
                            // Length difference penalty (shorter differences get higher scores)
                            const lengthDiff = Math.abs(combo.text.length - combo.query.length);
                            const lengthScore = Math.max(0, 100 - lengthDiff * 5);
                            
                            score = overlapScore + lengthScore;
                        }
                        
                        maxScore = Math.max(maxScore, score);
                    } catch (comboError) {
                        console.warn('Combo calculation error:', comboError);
                    }
                });
                
                return maxScore;
            } catch (error) {
                console.warn('Similarity calculation error:', error);
                return 0; // Return 0 instead of crashing
            }
        }

        // Ultra-safe search function with comprehensive crash protection
        function searchFunction() {
            try {
                const query = searchInput.value ? searchInput.value.trim() : '';
                if (!query) {
                    showToast('請輸入搜尋關鍵字', 'error');
                    return;
                }

                // Show loading state with safety check
                if (searchBtn) {
                    searchBtn.disabled = true;
                    searchBtn.innerHTML = '🔍 搜尋中...';
                }

                // Use setTimeout to prevent UI blocking and add extra error handling
                setTimeout(() => {
                    let results = [];
                    
                    try {
                        // Initialize safe data structures
                        const safeHerbsData = herbsData && typeof herbsData === 'object' ? herbsData : {};
                        const safeSymptomsData = symptomsData && typeof symptomsData === 'object' ? symptomsData : {};
                        
                        // Safe query processing
                        const queryLower = query.toLowerCase();
                        
                        // Initialize result arrays
                        let exactMatches = [];
                        let partialMatches = [];
                        let fuzzyMatches = [];

                        // Ultra-safe herb search
                        try {
                            const herbKeys = Object.keys(safeHerbsData);
                            
                            for (let i = 0; i < herbKeys.length && i < 1000; i++) { // Limit iterations
                                try {
                                    const herb = herbKeys[i];
                                    
                                    // Multiple safety checks
                                    if (!herb || typeof herb !== 'string' || herb.length === 0) continue;
                                    if (!safeHerbsData[herb] || !Array.isArray(safeHerbsData[herb])) continue;
                                    if (safeHerbsData[herb].length === 0) continue;
                                    
                                    // Safe string operations
                                    let herbLower = '';
                                    try {
                                        herbLower = herb.toLowerCase();
                                    } catch (e) {
                                        continue;
                                    }
                                    
                                    // Exact match (highest priority)
                                    if (herb === query || herbLower === queryLower) {
                                        exactMatches.push({
                                            type: '中藥',
                                            name: herb,
                                            items: safeHerbsData[herb].slice(0, 50), // Limit items
                                            label: '對應症狀',
                                            similarity: 1000,
                                            matchType: 'exact'
                                        });
                                        continue;
                                    }

                                    // Partial match (medium priority)
                                    let hasPartialMatch = false;
                                    try {
                                        hasPartialMatch = herb.includes(query) || herbLower.includes(queryLower);
                                    } catch (e) {
                                        hasPartialMatch = false;
                                    }
                                    
                                    if (hasPartialMatch) {
                                        partialMatches.push({
                                            type: '中藥',
                                            name: herb,
                                            items: safeHerbsData[herb].slice(0, 50),
                                            label: '對應症狀',
                                            similarity: 800,
                                            matchType: 'partial'
                                        });
                                        continue;
                                    }

                                    // Fuzzy match (lowest priority) - only if we don't have too many results
                                    if (exactMatches.length + partialMatches.length < 20) {
                                        try {
                                            const similarity = calculateSimilarity(herb, query);
                                            if (similarity && similarity >= 100) { // Higher threshold for fuzzy
                                                fuzzyMatches.push({
                                                    type: '中藥',
                                                    name: herb,
                                                    items: safeHerbsData[herb].slice(0, 50),
                                                    label: '對應症狀',
                                                    similarity: similarity,
                                                    matchType: 'fuzzy'
                                                });
                                            }
                                        } catch (simError) {
                                            // Silently skip fuzzy matching if it fails
                                        }
                                    }
                                } catch (herbItemError) {
                                    // Skip this herb and continue
                                    continue;
                                }
                            }
                        } catch (herbSearchError) {
                            console.warn('Herb search section failed:', herbSearchError);
                        }

                        // Ultra-safe symptom search
                        try {
                            const symptomKeys = Object.keys(safeSymptomsData);
                            
                            for (let i = 0; i < symptomKeys.length && i < 1000; i++) { // Limit iterations
                                try {
                                    const symptom = symptomKeys[i];
                                    
                                    // Multiple safety checks
                                    if (!symptom || typeof symptom !== 'string' || symptom.length === 0) continue;
                                    if (!safeSymptomsData[symptom] || !Array.isArray(safeSymptomsData[symptom])) continue;
                                    if (safeSymptomsData[symptom].length === 0) continue;
                                    
                                    // Safe string operations
                                    let symptomLower = '';
                                    try {
                                        symptomLower = symptom.toLowerCase();
                                    } catch (e) {
                                        continue;
                                    }
                                    
                                    // Exact match (highest priority)
                                    if (symptom === query || symptomLower === queryLower) {
                                        exactMatches.push({
                                            type: '症狀',
                                            name: symptom,
                                            items: safeSymptomsData[symptom].slice(0, 50),
                                            label: '對應中藥',
                                            similarity: 1000,
                                            matchType: 'exact'
                                        });
                                        continue;
                                    }

                                    // Partial match (medium priority)
                                    let hasPartialMatch = false;
                                    try {
                                        hasPartialMatch = symptom.includes(query) || symptomLower.includes(queryLower);
                                    } catch (e) {
                                        hasPartialMatch = false;
                                    }
                                    
                                    if (hasPartialMatch) {
                                        partialMatches.push({
                                            type: '症狀',
                                            name: symptom,
                                            items: safeSymptomsData[symptom].slice(0, 50),
                                            label: '對應中藥',
                                            similarity: 800,
                                            matchType: 'partial'
                                        });
                                        continue;
                                    }

                                    // Fuzzy match (lowest priority) - only if we don't have too many results
                                    if (exactMatches.length + partialMatches.length < 20) {
                                        try {
                                            const similarity = calculateSimilarity(symptom, query);
                                            if (similarity && similarity >= 100) { // Higher threshold for fuzzy
                                                fuzzyMatches.push({
                                                    type: '症狀',
                                                    name: symptom,
                                                    items: safeSymptomsData[symptom].slice(0, 50),
                                                    label: '對應中藥',
                                                    similarity: similarity,
                                                    matchType: 'fuzzy'
                                                });
                                            }
                                        } catch (simError) {
                                            // Silently skip fuzzy matching if it fails
                                        }
                                    }
                                } catch (symptomItemError) {
                                    // Skip this symptom and continue
                                    continue;
                                }
                            }
                        } catch (symptomSearchError) {
                            console.warn('Symptom search section failed:', symptomSearchError);
                        }

                        // Safe sorting with error handling
                        try {
                            exactMatches = exactMatches.sort((a, b) => {
                                try {
                                    return (a.name ? a.name.length : 999) - (b.name ? b.name.length : 999);
                                } catch (e) {
                                    return 0;
                                }
                            });
                        } catch (e) {
                            exactMatches = exactMatches || [];
                        }

                        try {
                            partialMatches = partialMatches.sort((a, b) => {
                                try {
                                    const simA = a.similarity || 0;
                                    const simB = b.similarity || 0;
                                    const lenA = a.name ? a.name.length : 999;
                                    const lenB = b.name ? b.name.length : 999;
                                    return simB - simA || lenA - lenB;
                                } catch (e) {
                                    return 0;
                                }
                            });
                        } catch (e) {
                            partialMatches = partialMatches || [];
                        }

                        try {
                            fuzzyMatches = fuzzyMatches.sort((a, b) => {
                                try {
                                    const simA = a.similarity || 0;
                                    const simB = b.similarity || 0;
                                    const lenA = a.name ? a.name.length : 999;
                                    const lenB = b.name ? b.name.length : 999;
                                    return simB - simA || lenA - lenB;
                                } catch (e) {
                                    return 0;
                                }
                            });
                        } catch (e) {
                            fuzzyMatches = fuzzyMatches || [];
                        }

                        // Safely combine results
                        results = [];
                        try {
                            results = [...(exactMatches || []), ...(partialMatches || []), ...(fuzzyMatches || [])];
                            // Limit total results to prevent UI overload
                            results = results.slice(0, 100);
                        } catch (combineError) {
                            console.warn('Result combination error:', combineError);
                            results = [];
                        }

                    } catch (searchError) {
                        console.error('Search processing error:', searchError);
                        results = [];
                    }

                    // Always try to display results, even if empty
                    try {
                        displayResults(results, query);
                    } catch (displayError) {
                        console.error('Display results error:', displayError);
                        // Fallback: show basic error message
                        try {
                            showToast('搜尋結果顯示失敗', 'error');
                        } catch (toastError) {
                            // Even toast failed, just log
                            console.error('Toast also failed:', toastError);
                        }
                    }

                    // Always restore button state
                    try {
                        if (searchBtn) {
                            searchBtn.disabled = false;
                            searchBtn.innerHTML = '🔍 搜尋';
                        }
                    } catch (buttonError) {
                        console.error('Button restore error:', buttonError);
                    }

                }, 50); // Slightly longer delay for stability

            } catch (outerError) {
                console.error('Search function outer error:', outerError);
                
                // Emergency fallback
                try {
                    if (searchBtn) {
                        searchBtn.disabled = false;
                        searchBtn.innerHTML = '🔍 搜尋';
                    }
                    showToast('搜尋功能暫時無法使用', 'error');
                } catch (emergencyError) {
                    console.error('Emergency fallback failed:', emergencyError);
                }
            }
        }

        // Modal control functions
        function showModal() {
            searchModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // Scroll modal content to top
            const modalContent = searchModal.querySelector('.overflow-y-auto');
            if (modalContent) {
                modalContent.scrollTop = 0;
            }
        }

        function hideModal() {
            searchModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // Display search results in modal
        function displayResults(results, query) {
            // Update modal header
            modalSearchQuery.textContent = `搜尋關鍵字：「${query}」`;
            modalResultCount.textContent = `找到 ${results.length} 個結果`;

            if (results.length === 0) {
                modalResultsContainer.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-gray-400 text-4xl mb-4">🔍</div>
                        <h4 class="text-lg font-medium text-gray-900 mb-2">未找到相關資料</h4>
                        <p class="text-gray-500">未找到與「${query}」相關的中藥或症狀資料</p>
                        <div class="mt-6">
                            <button onclick="hideModal(); searchInput.focus();" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                重新搜尋
                            </button>
                        </div>
                    </div>
                `;
            } else {
                modalResultsContainer.innerHTML = results.map((result, index) => {
                    // Determine match quality indicator
                    let matchIndicator = '';
                    let matchColor = '';
                    if (result.matchType === 'exact') {
                        matchIndicator = '🎯 完全匹配';
                        matchColor = 'text-green-600';
                    } else if (result.matchType === 'partial') {
                        matchIndicator = '🔍 部分匹配';
                        matchColor = 'text-blue-600';
                    } else {
                        matchIndicator = '💡 相關匹配';
                        matchColor = 'text-purple-600';
                    }

                    return `
                        <div class="border border-gray-200 rounded-lg p-5 mb-4 border-l-4 ${result.type === '中藥' ? 'border-l-blue-500' : 'border-l-green-500'} fade-in hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <span class="inline-block px-3 py-1 text-sm font-medium rounded ${result.type === '中藥' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">${result.type}</span>
                                    <h4 class="font-semibold text-gray-900 ml-3 text-lg">${result.name}</h4>
                                    ${index < 3 ? '<span class="ml-2 text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">推薦</span>' : ''}
                                </div>
                                <div class="text-sm ${matchColor} font-medium">${matchIndicator}</div>
                            </div>
                            <p class="text-sm text-gray-600 mb-4 font-medium">${result.label}：</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                                ${result.items.map(item => `
                                    <span class="inline-block px-4 py-2 bg-gray-50 text-gray-700 rounded-lg text-sm hover:bg-blue-50 hover:text-blue-700 cursor-pointer transition-colors border border-gray-200 hover:border-blue-300" onclick="hideModal(); searchInput.value='${item}'; searchFunction();">${item}</span>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Show modal
            showModal();
        }

        // Update display
        function updateDisplay() {
            // Update counts
            herbCount.textContent = Object.keys(herbsData).length;
            symptomCount.textContent = Object.keys(symptomsData).length;
            recordCount.textContent = Object.keys(recordsData).length;

            // Update herbs list
            if (Object.keys(herbsData).length === 0) {
                herbsList.innerHTML = '<p class="text-gray-500 text-center py-8">暫無資料</p>';
            } else {
                herbsList.innerHTML = Object.keys(herbsData).sort().map(herb => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors" onclick="searchInput.value='${herb}'; searchFunction();">
                        <span class="font-medium text-gray-900">${herb}</span>
                        <span class="text-xs text-blue-600 bg-blue-100 px-2 py-1 rounded">${herbsData[herb].length}</span>
                    </div>
                `).join('');
            }

            // Update symptoms list
            if (Object.keys(symptomsData).length === 0) {
                symptomsList.innerHTML = '<p class="text-gray-500 text-center py-8">暫無資料</p>';
            } else {
                symptomsList.innerHTML = Object.keys(symptomsData).sort().map(symptom => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors" onclick="searchInput.value='${symptom}'; searchFunction();">
                        <span class="font-medium text-gray-900">${symptom}</span>
                        <span class="text-xs text-green-600 bg-green-100 px-2 py-1 rounded">${symptomsData[symptom].length}</span>
                    </div>
                `).join('');
            }
        }

        // Sample data templates
        const sampleTemplates = {
            basic: `當歸：補血調經，活血止痛，潤腸通便
黃芪：補氣固表，利尿托毒，排膿，斂瘡生肌
人參：大補元氣，復脈固脫，補脾益肺，生津養血
甘草：調和諸藥，補脾益氣，清熱解毒，祛痰止咳
川芎：活血行氣，祛風止痛
白芍：養血柔肝，緩中止痛，斂陰收汗
熟地黃：滋陰補血，益精填髓
茯苓：健脾利水，寧心安神`,
            
            formula: `四物湯：補血調經，養血活血
六君子湯：健脾益氣，燥濕化痰
逍遙散：疏肝解鬱，健脾和血
補中益氣湯：補氣升陽，甘溫除熱
桂枝湯：解肌發表，調和營衛
麻黃湯：發汗解表，宣肺平喘
小柴胡湯：和解少陽，疏肝和胃
大承氣湯：攻下燥實，清熱瀉火`,
            
            modern: `板藍根：清熱解毒，涼血利咽
金銀花：清熱解毒，疏散風熱
連翹：清熱解毒，消腫散結
蒲公英：清熱解毒，消腫散結，利尿通淋
魚腥草：清熱解毒，消癰排膿，利尿通淋
桔梗：宣肺祛痰，利咽排膿
枇杷葉：清肺止咳，降逆止嘔
川貝母：清熱化痰，潤肺止咳，散結消腫`,
            
            mixed: `丹參：活血化瘀，涼血消癰，除煩安神
紅花,活血通經、散瘀止痛
桃仁	破血行瘀；潤燥滑腸
牛膝 活血通經/補肝腎、強筋骨
三七→止血化瘀|定痛
乳香[活血止痛；伸筋]
沒藥[活血止痛，消腫生肌]
{"herb":"血竭","symptom":"活血定痛，化瘀止血，生肌斂瘡"}`,

            punctuation: `當歸：補血調經。活血止痛！潤腸通便？
黃芪，補氣固表、利尿托毒；排膿…斂瘡生肌
人參「大補元氣」「復脈固脫」「補脾益肺」
甘草《調和諸藥》《補脾益氣》《清熱解毒》
川芎〈活血行氣〉〈祛風止痛〉
白芍【養血柔肝】【緩中止痛】【斂陰收汗】
熟地黃（滋陰補血）（益精填髓）
茯苓＼健脾利水／寧心安神
丹參→活血化瘀|涼血消癰|除煩安神`
        };

        // Helper functions
        function loadSampleData(type) {
            const template = sampleTemplates[type];
            if (template) {
                importData.value = template;
                const templateNames = {
                    'basic': '基礎中藥',
                    'formula': '常用方劑', 
                    'modern': '現代應用',
                    'mixed': '混合格式',
                    'punctuation': '標點符號範例'
                };
                showToast(`已載入${templateNames[type]}範本`, 'success');
            }
        }

        // Event listeners
        searchBtn.addEventListener('click', searchFunction);
        clearBtn.addEventListener('click', () => {
            searchInput.value = '';
        });
        importBtn.addEventListener('click', importDataFunction);
        clearAllBtn.addEventListener('click', clearAllData);
        clearDatabaseBtn.addEventListener('click', clearDatabase);
        
        // Modal event listeners
        closeModal.addEventListener('click', hideModal);
        newSearchBtn.addEventListener('click', () => {
            hideModal();
            searchInput.focus();
        });
        
        // Close modal when clicking outside
        searchModal.addEventListener('click', (e) => {
            if (e.target === searchModal) {
                hideModal();
            }
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !searchModal.classList.contains('hidden')) {
                hideModal();
            }
        });
        
        // Sample data buttons
        sampleData1.addEventListener('click', () => loadSampleData('basic'));
        sampleData2.addEventListener('click', () => loadSampleData('formula'));
        sampleData3.addEventListener('click', () => loadSampleData('modern'));
        sampleData4.addEventListener('click', () => loadSampleData('mixed'));
        sampleData5.addEventListener('click', () => loadSampleData('punctuation'));

        // Auto-detect format on input change
        importData.addEventListener('input', () => {
            if (importData.value.trim()) {
                const detectedFormat = detectFormat(importData.value);
                const formatNames = {
                    colon: '冒號格式',
                    comma: '逗號格式',
                    tab: 'Tab格式',
                    space: '空格格式',
                    arrow: '箭頭格式',
                    bracket: '方括號格式',
                    json: 'JSON格式'
                };
                
                formatHint.textContent = `自動識別：${formatNames[detectedFormat] || '未知格式'}`;
            } else {
                formatHint.textContent = '';
            }
        });

        // Enter key support
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchFunction();
            }
        });



        // Initialize the application
        initializeFirebase();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9665384a60a9055c',t:'MTc1MzcxNDU1MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
