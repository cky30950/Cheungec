<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中醫診症輔助工具 - Firebase版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase 配置 (示例配置，實際使用時需要替換為您的        const firebaseConfig = {
            apiKey: "AIzaSyBtUcrBYiE4B1O4xkvIqwxM52Hrh-i6pL8",
            authDomain: "cheungec-ea477.firebaseapp.com",
            databaseURL: "https://cheungec-ea477-default-rtdb.firebaseio.com",
            projectId: "cheungec-ea477",
            storageBucket: "cheungec-ea477.firebasestorage.app",
            messagingSenderId: "986510230799",
            appId: "1:986510230799:web:f603e67b605e71294f2a7a",
            measurementId: "G-4H26EC2H4Y"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // 將 Firebase 實例掛載到 window 對象，供其他腳本使用
        window.firebaseApp = app;
        window.firestore = db;
        window.firestoreModules = {
            collection,
            addDoc,
            getDocs,
            doc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            query,
            orderBy
        };
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .card-modern {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .fade-in {
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        .search-result {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .search-result:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        
        .search-result::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s;
        }
        
        .search-result:hover::before {
            left: 100%;
        }
        
        .btn-modern {
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .btn-modern::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-modern:hover::before {
            left: 100%;
        }
        
        .input-modern {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .input-modern:focus {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .floating-animation {
            animation: floating 3s ease-in-out infinite;
        }
        
        @keyframes floating {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .pulse-glow {
            animation: pulseGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes pulseGlow {
            from { box-shadow: 0 0 20px rgba(102, 126, 234, 0.4); }
            to { box-shadow: 0 0 30px rgba(118, 75, 162, 0.6); }
        }
        
        .tag-modern {
            position: relative;
            overflow: hidden;
            transition: all 0.2s ease;
        }
        
        .tag-modern:hover {
            transform: scale(1.05);
        }
        
        .autocomplete-modern {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .stats-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .sync-indicator {
            transition: all 0.3s ease;
        }
        
        .sync-indicator.syncing {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 120px;
            text-align: center;
        }
        
        .connection-status.online {
            background: rgba(34, 197, 94, 0.95);
            color: white;
            border-color: rgba(34, 197, 94, 0.3);
        }
        
        .connection-status.offline {
            background: rgba(239, 68, 68, 0.95);
            color: white;
            border-color: rgba(239, 68, 68, 0.3);
        }
        
        .connection-status.connecting {
            background: rgba(251, 191, 36, 0.95);
            color: white;
            border-color: rgba(251, 191, 36, 0.3);
        }
        
        .connection-status.error {
            background: rgba(239, 68, 68, 0.95);
            color: white;
            border-color: rgba(239, 68, 68, 0.3);
        }
        
        .status-pulse {
            animation: statusPulse 2s ease-in-out infinite;
        }
        
        @keyframes statusPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Firebase 連線狀態指示器 -->
    <div id="connectionStatus" class="connection-status connecting status-pulse">
        <div class="flex items-center justify-center space-x-2">
            <span id="statusIcon" class="text-sm">🔄</span>
            <span id="statusText" class="font-medium">Firebase 連接中</span>
        </div>
        <div id="statusDetails" class="text-xs mt-1 opacity-80"></div>
    </div>

    <div class="container mx-auto px-4 py-6 max-w-5xl relative z-10">
        <!-- Header -->
        <div class="text-center mb-6">
            <h1 class="text-2xl font-bold gradient-text mb-1">中醫診症工具</h1>
            <p class="text-white/70 text-sm">智能搜尋 · 雲端同步</p>
        </div>

        <!-- Main Content -->
        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Search Section -->
            <div class="lg:col-span-2">
                <div class="card-modern rounded-xl p-4 mb-4">
                    <div class="mb-3">
                        <div class="relative">
                            <input 
                                type="text" 
                                id="searchInput" 
                                placeholder="輸入症狀或中藥名稱..."
                                class="input-modern w-full px-4 py-3 pl-10 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-gray-700 placeholder-gray-500"
                                autocomplete="off"
                            >
                            <div class="absolute left-3 top-3 w-4 h-4 text-gray-400">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            <!-- 同步指示器 -->
                            <div id="syncIndicator" class="absolute right-3 top-3 w-4 h-4 text-green-500 sync-indicator">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                            </div>
                            <!-- 自動完成下拉選單 -->
                            <div id="autocompleteList" class="autocomplete-modern absolute top-full left-0 right-0 rounded-lg z-20 max-h-48 overflow-y-auto hidden mt-1"></div>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button id="searchBtn" class="btn-modern flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">
                            搜尋
                        </button>
                        <button id="clearBtn" class="btn-modern bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium">
                            清除
                        </button>
                    </div>
                </div>

                <!-- Search Results -->
                <div id="searchResults" class="card-modern rounded-xl p-4 min-h-64">
                    <div id="resultsContainer" class="text-gray-500 text-center py-8">
                        <div class="w-12 h-12 mx-auto mb-3 bg-gray-100 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <p class="text-gray-600">請輸入關鍵詞開始搜尋</p>
                    </div>
                </div>
            </div>

            <!-- Data Management Section -->
            <div class="lg:col-span-1">
                <div class="glass-effect rounded-xl p-4 backdrop-blur-xl">
                    <h2 class="text-lg font-semibold text-white mb-3">資料管理</h2>
                    
                    <div class="mb-3">
                        <textarea 
                            id="importData" 
                            placeholder="格式：中藥名：症狀"
                            class="w-full h-20 px-3 py-2 bg-white/20 border border-white/30 rounded-lg focus:ring-2 focus:ring-white/50 focus:border-white/50 outline-none resize-none text-white placeholder-white/70 text-sm"
                        ></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <button id="importBtn" class="btn-modern bg-green-600 hover:bg-green-700 text-white py-2 px-3 rounded-lg text-sm">
                            導入
                        </button>
                        <button id="syncBtn" class="btn-modern bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded-lg text-sm">
                            同步
                        </button>
                    </div>

                    <div class="stats-card rounded-lg p-3 mb-3">
                        <div class="grid grid-cols-2 gap-2 text-center">
                            <div>
                                <div id="herbCount" class="text-lg font-bold text-white">0</div>
                                <div class="text-white/70 text-xs">中藥</div>
                            </div>
                            <div>
                                <div id="symptomCount" class="text-lg font-bold text-white">0</div>
                                <div class="text-white/70 text-xs">症狀</div>
                            </div>
                        </div>
                        <div class="mt-2 pt-2 border-t border-white/20">
                            <div id="lastSyncTime" class="text-xs text-white/70 text-center">未同步</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <button id="exportBtn" class="btn-modern bg-purple-600 hover:bg-purple-700 text-white py-2 px-3 rounded-lg text-sm">
                            匯出
                        </button>
                        <button id="clearDataBtn" class="btn-modern bg-red-600 hover:bg-red-700 text-white py-2 px-3 rounded-lg text-sm">
                            清空
                        </button>
                    </div>
                </div>

                <!-- 同步日誌 -->
                <div class="glass-effect rounded-xl p-4 backdrop-blur-xl mt-4">
                    <h3 class="text-sm font-semibold text-white mb-2">同步日誌</h3>
                    <div id="syncLog" class="space-y-1 max-h-24 overflow-y-auto">
                        <div class="text-white/70 text-xs">等待同步...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class FirebaseTCMTool {
            constructor() {
                this.database = {
                    herbs: new Map(),
                    symptoms: new Map()
                };
                this.isOnline = navigator.onLine;
                this.syncInProgress = false;
                this.lastSyncTime = null;
                
                this.initializeFirebase();
                this.initializeEventListeners();
                this.initializeSemanticMapping();
                this.setupConnectionMonitoring();
                this.updateConnectionStatus();
            }

            async initializeFirebase() {
                try {
                    this.updateConnectionStatus('connecting', 'Firebase 模組載入中...');
                    
                    // 等待 Firebase 模組載入
                    await this.waitForFirebase();
                    
                    this.updateConnectionStatus('connecting', '建立 Firestore 連接...');
                    
                    this.db = window.firestore;
                    this.firestoreModules = window.firestoreModules;
                    
                    // 測試連接
                    await this.testFirebaseConnection();
                    
                    this.updateConnectionStatus('connecting', '設置即時監聽器...');
                    
                    // 設置即時監聽器
                    this.setupRealtimeListeners();
                    
                    this.updateConnectionStatus('connecting', '載入雲端資料...');
                    
                    // 初始載入資料
                    await this.loadDataFromFirebase();
                    
                    this.updateConnectionStatus('online', `Firebase已連接 (${this.database.herbs.size} 項中藥)`);
                    this.addSyncLog('✅ Firebase 連接成功，雲端同步已啟用');
                    
                } catch (error) {
                    console.error('Firebase 初始化失敗:', error);
                    
                    if (error.message.includes('示例配置')) {
                        this.updateConnectionStatus('error', '使用示例配置，僅本地模式');
                        this.addSyncLog('⚠️ 檢測到示例配置，請配置真實Firebase項目以啟用雲端同步');
                        this.addSyncLog('💡 提示：這是演示版本，資料僅保存在本地');
                    } else {
                        this.updateConnectionStatus('error', `連接失敗: ${error.message}`);
                        this.addSyncLog(`❌ Firebase 連接失敗: ${error.message}`);
                    }
                    
                    // 載入本地示例資料
                    this.loadSampleData();
                }
            }

            async testFirebaseConnection() {
                if (!this.db) throw new Error('Firestore 未初始化');
                
                try {
                    const { collection, getDocs } = this.firestoreModules;
                    
                    // 檢查Firebase配置是否為示例配置
                    const firebaseConfig = {
                        apiKey: "demo-api-key",
                        authDomain: "tcm-diagnostic-tool.firebaseapp.com",
                        projectId: "tcm-diagnostic-tool"
                    };
                    
                    if (window.firebaseApp.options.apiKey === firebaseConfig.apiKey) {
                        throw new Error('使用示例配置，請配置真實的Firebase項目');
                    }
                    
                    // 嘗試讀取集合來測試真實連接
                    const testQuery = await getDocs(collection(this.db, 'herbs'));
                    
                    // 檢查是否有網路連接問題
                    if (!navigator.onLine) {
                        throw new Error('網路連接中斷');
                    }
                    
                } catch (error) {
                    if (error.code === 'permission-denied') {
                        throw new Error('Firebase權限被拒絕，請檢查安全規則');
                    } else if (error.code === 'unavailable') {
                        throw new Error('Firebase服務暫時不可用');
                    } else if (error.message.includes('demo-api-key')) {
                        throw new Error('使用示例配置，請配置真實的Firebase項目');
                    } else {
                        throw new Error(`連接失敗: ${error.message}`);
                    }
                }
            }

            waitForFirebase() {
                return new Promise((resolve, reject) => {
                    const checkFirebase = () => {
                        if (window.firestore && window.firestoreModules) {
                            resolve();
                        } else {
                            setTimeout(checkFirebase, 100);
                        }
                    };
                    checkFirebase();
                    
                    // 10秒超時
                    setTimeout(() => reject(new Error('Firebase 載入超時')), 10000);
                });
            }

            setupRealtimeListeners() {
                if (!this.db) return;

                const { collection, onSnapshot, query, orderBy } = this.firestoreModules;
                
                // 監聽中藥資料變化
                const herbsQuery = query(collection(this.db, 'herbs'), orderBy('createdAt', 'desc'));
                onSnapshot(herbsQuery, (snapshot) => {
                    this.handleHerbsSnapshot(snapshot);
                }, (error) => {
                    console.error('監聽中藥資料失敗:', error);
                    this.addSyncLog('❌ 中藥資料同步失敗');
                });

                // 監聽症狀資料變化
                const symptomsQuery = query(collection(this.db, 'symptoms'), orderBy('createdAt', 'desc'));
                onSnapshot(symptomsQuery, (snapshot) => {
                    this.handleSymptomsSnapshot(snapshot);
                }, (error) => {
                    console.error('監聽症狀資料失敗:', error);
                    this.addSyncLog('❌ 症狀資料同步失敗');
                });
            }

            handleHerbsSnapshot(snapshot) {
                this.database.herbs.clear();
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    this.database.herbs.set(data.name, new Set(data.symptoms || []));
                });
                
                this.rebuildSymptomsFromHerbs();
                this.updateStats();
                this.addSyncLog(`🌿 中藥資料已同步 (${snapshot.size} 項)`);
            }

            handleSymptomsSnapshot(snapshot) {
                // 症狀資料會從中藥資料重建，這裡主要用於統計
                this.updateStats();
            }

            rebuildSymptomsFromHerbs() {
                this.database.symptoms.clear();
                
                for (let [herb, symptoms] of this.database.herbs) {
                    for (let symptom of symptoms) {
                        if (!this.database.symptoms.has(symptom)) {
                            this.database.symptoms.set(symptom, new Set());
                        }
                        this.database.symptoms.get(symptom).add(herb);
                    }
                }
            }

            async loadDataFromFirebase() {
                if (!this.db) return;

                try {
                    this.setSyncIndicator(true);
                    
                    const { collection, getDocs } = this.firestoreModules;
                    
                    // 載入中藥資料
                    const herbsSnapshot = await getDocs(collection(this.db, 'herbs'));
                    this.database.herbs.clear();
                    
                    herbsSnapshot.forEach((doc) => {
                        const data = doc.data();
                        this.database.herbs.set(data.name, new Set(data.symptoms || []));
                    });
                    
                    this.rebuildSymptomsFromHerbs();
                    this.updateStats();
                    this.updateLastSyncTime();
                    
                    this.addSyncLog(`📥 載入完成 (${herbsSnapshot.size} 項中藥)`);
                    
                } catch (error) {
                    console.error('載入資料失敗:', error);
                    this.addSyncLog('❌ 載入資料失敗');
                } finally {
                    this.setSyncIndicator(false);
                }
            }

            async saveHerbToFirebase(herbName, symptoms) {
                if (!this.db || !this.isOnline) return false;

                try {
                    const { collection, addDoc } = this.firestoreModules;
                    
                    await addDoc(collection(this.db, 'herbs'), {
                        name: herbName,
                        symptoms: Array.from(symptoms),
                        createdAt: new Date(),
                        updatedAt: new Date()
                    });
                    
                    return true;
                } catch (error) {
                    console.error('儲存中藥資料失敗:', error);
                    return false;
                }
            }

            async syncAllDataToFirebase() {
                if (!this.db || !this.isOnline || this.syncInProgress) {
                    if (!this.isOnline) {
                        this.updateConnectionStatus('offline', '無法同步：網路連接中斷');
                        this.addSyncLog('❌ 同步失敗：網路連接中斷');
                    } else if (!this.db) {
                        this.addSyncLog('❌ 同步失敗：Firebase未正確配置');
                        alert('Firebase未正確配置，無法同步到雲端。\n請配置真實的Firebase項目以啟用雲端同步功能。');
                    }
                    return;
                }

                try {
                    this.syncInProgress = true;
                    this.setSyncIndicator(true);
                    this.updateConnectionStatus('connecting', '正在同步資料到雲端...');
                    
                    const { collection, getDocs, addDoc, deleteDoc, doc } = this.firestoreModules;
                    
                    // 清空現有資料
                    const existingHerbs = await getDocs(collection(this.db, 'herbs'));
                    const deletePromises = existingHerbs.docs.map(docRef => 
                        deleteDoc(doc(this.db, 'herbs', docRef.id))
                    );
                    await Promise.all(deletePromises);
                    
                    // 上傳新資料
                    const uploadPromises = [];
                    for (let [herbName, symptoms] of this.database.herbs) {
                        uploadPromises.push(
                            addDoc(collection(this.db, 'herbs'), {
                                name: herbName,
                                symptoms: Array.from(symptoms),
                                createdAt: new Date(),
                                updatedAt: new Date()
                            })
                        );
                    }
                    
                    await Promise.all(uploadPromises);
                    this.updateLastSyncTime();
                    this.updateConnectionStatus('online', `同步完成 (${this.database.herbs.size} 項中藥)`);
                    this.addSyncLog(`✅ 同步完成 (${this.database.herbs.size} 項中藥)`);
                    
                } catch (error) {
                    console.error('同步失敗:', error);
                    this.updateConnectionStatus('error', `同步失敗: ${error.message}`);
                    this.addSyncLog(`❌ 同步失敗: ${error.message}`);
                } finally {
                    this.syncInProgress = false;
                    this.setSyncIndicator(false);
                }
            }

            setupConnectionMonitoring() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.updateConnectionStatus('connecting', '重新連接 Firebase...');
                    this.addSyncLog('🌐 網路連接已恢復');
                    
                    // 重新初始化 Firebase 連接
                    setTimeout(() => {
                        this.initializeFirebase();
                    }, 1000);
                });

                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.updateConnectionStatus('offline', '網路連接中斷，使用本地資料');
                    this.addSyncLog('📡 網路連接中斷');
                });
            }

            updateConnectionStatus(status = null, details = '') {
                const statusElement = document.getElementById('connectionStatus');
                const iconElement = document.getElementById('statusIcon');
                const textElement = document.getElementById('statusText');
                const detailsElement = document.getElementById('statusDetails');
                
                if (!status) {
                    status = this.isOnline ? 'online' : 'offline';
                }
                
                // 移除所有狀態類別
                statusElement.className = statusElement.className.replace(/\b(online|offline|connecting|error)\b/g, '');
                statusElement.classList.add(status);
                
                // 根據狀態添加或移除脈衝動畫
                if (status === 'connecting') {
                    statusElement.classList.add('status-pulse');
                } else {
                    statusElement.classList.remove('status-pulse');
                }
                
                switch (status) {
                    case 'online':
                        iconElement.textContent = '✅';
                        textElement.textContent = 'Firebase 已連接';
                        break;
                    case 'offline':
                        iconElement.textContent = '📡';
                        textElement.textContent = '離線模式';
                        break;
                    case 'connecting':
                        iconElement.textContent = '🔄';
                        textElement.textContent = 'Firebase 連接中';
                        break;
                    case 'error':
                        iconElement.textContent = '❌';
                        textElement.textContent = 'Firebase 錯誤';
                        break;
                }
                
                // 更新詳細資訊
                detailsElement.textContent = details;
                
                // 如果沒有詳細資訊，隱藏詳細資訊元素
                if (!details) {
                    detailsElement.style.display = 'none';
                } else {
                    detailsElement.style.display = 'block';
                }
            }

            setSyncIndicator(syncing) {
                const indicator = document.getElementById('syncIndicator');
                if (syncing) {
                    indicator.classList.add('syncing');
                    indicator.style.color = '#f59e0b';
                } else {
                    indicator.classList.remove('syncing');
                    indicator.style.color = '#10b981';
                }
            }

            addSyncLog(message) {
                const logContainer = document.getElementById('syncLog');
                const timestamp = new Date().toLocaleTimeString();
                
                const logEntry = document.createElement('div');
                logEntry.className = 'text-white/70 text-xs';
                logEntry.innerHTML = `<span class="text-white/50">${timestamp}</span> ${message}`;
                
                logContainer.insertBefore(logEntry, logContainer.firstChild);
                
                // 保持最多10條日誌
                while (logContainer.children.length > 10) {
                    logContainer.removeChild(logContainer.lastChild);
                }
            }

            updateLastSyncTime() {
                this.lastSyncTime = new Date();
                const timeString = this.lastSyncTime.toLocaleString();
                document.getElementById('lastSyncTime').textContent = `最後同步: ${timeString}`;
            }

            initializeEventListeners() {
                document.getElementById('searchBtn').addEventListener('click', () => this.performIntelligentSearch());
                document.getElementById('clearBtn').addEventListener('click', () => this.clearSearch());
                document.getElementById('importBtn').addEventListener('click', () => this.importData());
                document.getElementById('syncBtn').addEventListener('click', () => this.syncAllDataToFirebase());
                document.getElementById('exportBtn').addEventListener('click', () => this.exportData());
                document.getElementById('clearDataBtn').addEventListener('click', () => this.clearDatabase());
                
                const searchInput = document.getElementById('searchInput');
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.performIntelligentSearch();
                });
                
                searchInput.addEventListener('input', (e) => this.handleAutocomplete(e.target.value));
                searchInput.addEventListener('focus', () => this.showAutocomplete());
                searchInput.addEventListener('blur', () => {
                    setTimeout(() => this.hideAutocomplete(), 200);
                });
                
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.relative')) {
                        this.hideAutocomplete();
                    }
                });
            }

            async importData() {
                const data = document.getElementById('importData').value.trim();
                if (!data) {
                    alert('請輸入要導入的資料');
                    return;
                }

                const lines = data.split('\n');
                let successCount = 0;
                
                for (let line of lines) {
                    if (this.processDataLine(line.trim())) {
                        successCount++;
                    }
                }

                // 如果在線，同步到 Firebase
                if (this.isOnline && successCount > 0) {
                    await this.syncAllDataToFirebase();
                }

                this.updateStats();
                document.getElementById('importData').value = '';
                alert(`成功導入 ${successCount} 條資料`);
                this.addSyncLog(`📥 導入 ${successCount} 條資料`);
            }

            exportData() {
                const exportData = [];
                
                for (let [herb, symptoms] of this.database.herbs) {
                    for (let symptom of symptoms) {
                        exportData.push(`${herb}：${symptom}`);
                    }
                }
                
                const dataStr = exportData.join('\n');
                const dataBlob = new Blob([dataStr], { type: 'text/plain;charset=utf-8' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `中醫資料_${new Date().toISOString().split('T')[0]}.txt`;
                link.click();
                
                this.addSyncLog(`📤 匯出 ${exportData.length} 條資料`);
            }

            async clearDatabase() {
                if (confirm('確定要清空所有資料嗎？此操作會同步到雲端且無法復原。')) {
                    this.database.herbs.clear();
                    this.database.symptoms.clear();
                    
                    // 如果在線，清空 Firebase 資料
                    if (this.isOnline && this.db) {
                        try {
                            const { collection, getDocs, deleteDoc, doc } = this.firestoreModules;
                            const herbsSnapshot = await getDocs(collection(this.db, 'herbs'));
                            
                            const deletePromises = herbsSnapshot.docs.map(docRef => 
                                deleteDoc(doc(this.db, 'herbs', docRef.id))
                            );
                            await Promise.all(deletePromises);
                            
                            this.addSyncLog('🗑️ 雲端資料已清空');
                        } catch (error) {
                            console.error('清空雲端資料失敗:', error);
                            this.addSyncLog('❌ 清空雲端資料失敗');
                        }
                    }
                    
                    this.updateStats();
                    this.clearSearch();
                    alert('資料庫已清空');
                    this.addSyncLog('🗑️ 本地資料已清空');
                }
            }

            processDataLine(line) {
                if (!line || !line.includes('：')) return false;
                
                const [herb, symptom] = line.split('：').map(s => s.trim());
                if (!herb || !symptom) return false;

                if (!this.database.herbs.has(herb)) {
                    this.database.herbs.set(herb, new Set());
                }
                this.database.herbs.get(herb).add(symptom);

                if (!this.database.symptoms.has(symptom)) {
                    this.database.symptoms.set(symptom, new Set());
                }
                this.database.symptoms.get(symptom).add(herb);

                return true;
            }

            loadSampleData() {
                const sampleData = [
                    "當歸：補血調經", "當歸：活血止痛", "黃芪：補氣固表", "黃芪：利水消腫",
                    "人參：大補元氣", "人參：復脈固脫", "甘草：調和諸藥", "甘草：清熱解毒",
                    "川芎：活血行氣", "川芎：祛風止痛", "白芍：養血調經", "白芍：平肝止痛",
                    "熟地黃：滋陰補血", "熟地黃：益精填髓", "枸杞子：滋補肝腎", "枸杞子：明目潤肺",
                    "紅棗：補中益氣", "紅棗：養血安神", "生薑：溫中散寒", "生薑：止嘔化痰",
                    "桂圓：補心脾", "桂圓：益氣血", "山藥：健脾益氣", "山藥：固腎澀精"
                ];
                
                sampleData.forEach(line => this.processDataLine(line));
                this.updateStats();
                this.addSyncLog('📋 載入示例資料');
            }

            initializeSemanticMapping() {
                this.semanticMap = {
                    '補血': ['養血', '滋血', '生血', '血虛', '貧血', '面色蒼白'],
                    '補氣': ['益氣', '固氣', '升氣', '氣虛', '乏力', '疲勞', '無力'],
                    '補腎': ['益腎', '固腎', '滋腎', '腎虛', '腰膝酸軟', '遺精'],
                    '補心': ['養心', '安神', '心悸', '失眠', '健忘'],
                    '補脾': ['健脾', '益脾', '脾虛', '消化不良', '食慾不振'],
                    '補肝': ['養肝', '滋肝', '肝血不足', '視力模糊'],
                    '調經': ['月經不調', '經期不準', '痛經', '閉經', '月經過多', '月經過少'],
                    '止痛': ['鎮痛', '緩解疼痛', '疼痛', '痛症', '頭痛', '腹痛'],
                    '活血': ['行血', '通血', '血瘀', '瘀血', '血液循環'],
                    '化痰': ['祛痰', '止咳', '咳嗽', '痰多', '咳痰'],
                    '清熱': ['降火', '退熱', '解熱', '發熱', '上火', '熱症'],
                    '解毒': ['排毒', '清毒', '中毒', '毒素'],
                    '溫中': ['暖胃', '溫胃', '胃寒', '腹冷', '消化不良'],
                    '散寒': ['驅寒', '溫陽', '寒症', '怕冷', '手腳冰冷'],
                    '安神': ['鎮靜', '寧神', '失眠', '多夢', '心神不寧', '焦慮'],
                    '明目': ['護眼', '改善視力', '眼睛疲勞', '視力下降'],
                    '健脾': ['養脾', '脾胃虛弱', '消化不良', '腹脹', '食慾不振'],
                    '止嘔': ['防嘔', '嘔吐', '噁心', '反胃'],
                    '利水': ['利尿', '消腫', '水腫', '小便不利', '尿少'],
                    '固表': ['止汗', '自汗', '盜汗', '易感冒'],
                    '復脈': ['強心', '心律不整', '心悸', '脈搏微弱'],
                    '固脫': ['收斂', '脫肛', '子宮脫垂', '久瀉不止']
                };
            }

            // 搜尋相關方法（與之前相同）
            performIntelligentSearch() {
                const query = document.getElementById('searchInput').value.trim();
                if (!query) {
                    alert('請輸入搜尋內容');
                    return;
                }

                const allResults = this.intelligentSearch(query, 'all');
                this.displayIntelligentResults(query, allResults);
                this.hideAutocomplete();
            }

            intelligentSearch(query, searchType = 'all') {
                const allResults = [];
                const processedQuery = query.toLowerCase();

                this.addExactMatches(allResults, query, processedQuery, searchType);
                this.addContainsMatches(allResults, query, processedQuery, searchType);
                this.addFuzzyMatches(allResults, query, processedQuery, searchType);
                this.addRelatedMatches(allResults, query, processedQuery, searchType);

                const uniqueResults = this.deduplicateResults(allResults);
                return uniqueResults.sort((a, b) => b.finalScore - a.finalScore);
            }

            addExactMatches(results, query, processedQuery, searchType) {
                if (searchType === 'all' || searchType === 'herb') {
                    for (let [herb, symptoms] of this.database.herbs) {
                        if (herb.toLowerCase() === processedQuery) {
                            results.push({
                                name: herb,
                                items: Array.from(symptoms),
                                type: 'herb',
                                matchType: '中藥名稱',
                                matchLevel: 'exact',
                                baseScore: 100,
                                finalScore: 100
                            });
                        }
                    }
                }

                if (searchType === 'all' || searchType === 'symptom') {
                    for (let [symptom, herbs] of this.database.symptoms) {
                        if (symptom.toLowerCase() === processedQuery) {
                            results.push({
                                name: symptom,
                                items: Array.from(herbs),
                                type: 'symptom',
                                matchType: '症狀名稱',
                                matchLevel: 'exact',
                                baseScore: 100,
                                finalScore: 100
                            });
                        }
                    }
                }
            }

            addContainsMatches(results, query, processedQuery, searchType) {
                if (searchType === 'all' || searchType === 'herb') {
                    for (let [herb, symptoms] of this.database.herbs) {
                        const herbLower = herb.toLowerCase();
                        if (herbLower.includes(processedQuery) && herbLower !== processedQuery) {
                            const score = (processedQuery.length / herbLower.length) * 90;
                            results.push({
                                name: herb,
                                items: Array.from(symptoms),
                                type: 'herb',
                                matchType: '中藥名稱',
                                matchLevel: 'contains',
                                baseScore: score,
                                finalScore: score + 10
                            });
                        }
                    }
                }

                if (searchType === 'all' || searchType === 'symptom') {
                    for (let [symptom, herbs] of this.database.symptoms) {
                        const symptomLower = symptom.toLowerCase();
                        if (symptomLower.includes(processedQuery) && symptomLower !== processedQuery) {
                            const score = (processedQuery.length / symptomLower.length) * 90;
                            results.push({
                                name: symptom,
                                items: Array.from(herbs),
                                type: 'symptom',
                                matchType: '症狀名稱',
                                matchLevel: 'contains',
                                baseScore: score,
                                finalScore: score + 10
                            });
                        }
                    }
                }
            }

            addFuzzyMatches(results, query, processedQuery, searchType) {
                if (searchType === 'all' || searchType === 'herb') {
                    for (let [herb, symptoms] of this.database.herbs) {
                        const herbLower = herb.toLowerCase();
                        if (!herbLower.includes(processedQuery)) {
                            const similarity = this.calculateSimilarity(processedQuery, herbLower);
                            if (similarity > 0.4) {
                                const score = similarity * 80;
                                results.push({
                                    name: herb,
                                    items: Array.from(symptoms),
                                    type: 'herb',
                                    matchType: '中藥名稱',
                                    matchLevel: 'fuzzy',
                                    baseScore: score,
                                    finalScore: score
                                });
                            }
                        }
                    }
                }

                if (searchType === 'all' || searchType === 'symptom') {
                    for (let [symptom, herbs] of this.database.symptoms) {
                        const symptomLower = symptom.toLowerCase();
                        if (!symptomLower.includes(processedQuery)) {
                            const similarity = this.calculateSimilarity(processedQuery, symptomLower);
                            if (similarity > 0.4) {
                                const score = similarity * 80;
                                results.push({
                                    name: symptom,
                                    items: Array.from(herbs),
                                    type: 'symptom',
                                    matchType: '症狀名稱',
                                    matchLevel: 'fuzzy',
                                    baseScore: score,
                                    finalScore: score
                                });
                            }
                        }
                    }
                }
            }

            addRelatedMatches(results, query, processedQuery, searchType) {
                if (searchType !== 'all') return;

                for (let [herb, symptoms] of this.database.herbs) {
                    for (let symptom of symptoms) {
                        const symptomLower = symptom.toLowerCase();
                        if (symptomLower.includes(processedQuery)) {
                            results.push({
                                name: herb,
                                items: Array.from(symptoms),
                                type: 'herb',
                                matchType: '功效匹配',
                                matchLevel: 'related',
                                baseScore: 60,
                                finalScore: 60,
                                highlightItem: symptom
                            });
                        }
                    }
                }

                for (let [symptom, herbs] of this.database.symptoms) {
                    for (let herb of herbs) {
                        const herbLower = herb.toLowerCase();
                        if (herbLower.includes(processedQuery)) {
                            results.push({
                                name: symptom,
                                items: Array.from(herbs),
                                type: 'symptom',
                                matchType: '藥材匹配',
                                matchLevel: 'related',
                                baseScore: 60,
                                finalScore: 60,
                                highlightItem: herb
                            });
                        }
                    }
                }

                this.addSemanticMatches(results, query, processedQuery, searchType);
            }

            addSemanticMatches(results, query, processedQuery, searchType) {
                const semanticMatches = this.findSemanticMatches(processedQuery);
                
                for (let semanticTerm of semanticMatches) {
                    const semanticLower = semanticTerm.toLowerCase();
                    
                    for (let [herb, symptoms] of this.database.herbs) {
                        for (let symptom of symptoms) {
                            const symptomLower = symptom.toLowerCase();
                            if (symptomLower.includes(semanticLower)) {
                                const existingResult = results.find(r => 
                                    r.name === herb && r.type === 'herb' && r.matchLevel === 'semantic'
                                );
                                
                                if (!existingResult) {
                                    results.push({
                                        name: herb,
                                        items: Array.from(symptoms),
                                        type: 'herb',
                                        matchType: '語義匹配',
                                        matchLevel: 'semantic',
                                        baseScore: 55,
                                        finalScore: 55,
                                        highlightItem: symptom,
                                        semanticTerm: semanticTerm
                                    });
                                }
                            }
                        }
                    }

                    for (let [symptom, herbs] of this.database.symptoms) {
                        const symptomLower = symptom.toLowerCase();
                        if (symptomLower.includes(semanticLower)) {
                            const existingResult = results.find(r => 
                                r.name === symptom && r.type === 'symptom' && r.matchLevel === 'semantic'
                            );
                            
                            if (!existingResult) {
                                results.push({
                                    name: symptom,
                                    items: Array.from(herbs),
                                    type: 'symptom',
                                    matchType: '語義匹配',
                                    matchLevel: 'semantic',
                                    baseScore: 55,
                                    finalScore: 55,
                                    semanticTerm: semanticTerm
                                });
                            }
                        }
                    }
                }
            }

            findSemanticMatches(query) {
                const matches = new Set();
                const queryLower = query.toLowerCase();
                
                for (let [key, synonyms] of Object.entries(this.semanticMap)) {
                    if (key.toLowerCase().includes(queryLower)) {
                        synonyms.forEach(synonym => matches.add(synonym));
                        matches.add(key);
                    }
                    
                    for (let synonym of synonyms) {
                        if (synonym.toLowerCase().includes(queryLower)) {
                            matches.add(key);
                            synonyms.forEach(s => matches.add(s));
                            break;
                        }
                    }
                }
                
                return Array.from(matches);
            }

            deduplicateResults(results) {
                const seen = new Map();
                const unique = [];

                for (let result of results) {
                    const key = `${result.type}-${result.name}`;
                    if (!seen.has(key) || seen.get(key).finalScore < result.finalScore) {
                        seen.set(key, result);
                    }
                }

                return Array.from(seen.values());
            }

            calculateSimilarity(str1, str2) {
                const longer = str1.length > str2.length ? str1 : str2;
                const shorter = str1.length > str2.length ? str2 : str1;
                
                if (longer.length === 0) return 1.0;
                
                const editDistance = this.levenshteinDistance(longer, shorter);
                return (longer.length - editDistance) / longer.length;
            }

            levenshteinDistance(str1, str2) {
                const matrix = [];
                
                for (let i = 0; i <= str2.length; i++) {
                    matrix[i] = [i];
                }
                
                for (let j = 0; j <= str1.length; j++) {
                    matrix[0][j] = j;
                }
                
                for (let i = 1; i <= str2.length; i++) {
                    for (let j = 1; j <= str1.length; j++) {
                        if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                            matrix[i][j] = matrix[i - 1][j - 1];
                        } else {
                            matrix[i][j] = Math.min(
                                matrix[i - 1][j - 1] + 1,
                                matrix[i][j - 1] + 1,
                                matrix[i - 1][j] + 1
                            );
                        }
                    }
                }
                
                return matrix[str2.length][str1.length];
            }

            handleAutocomplete(value) {
                if (!value || value.length < 1) {
                    this.hideAutocomplete();
                    return;
                }

                const suggestions = this.getSuggestions(value);
                this.showAutocompleteSuggestions(suggestions);
            }

            getSuggestions(query) {
                const suggestions = [];
                const lowerQuery = query.toLowerCase();
                const maxSuggestions = 8;

                for (let herb of this.database.herbs.keys()) {
                    if (herb.toLowerCase().includes(lowerQuery) && suggestions.length < maxSuggestions) {
                        suggestions.push({
                            text: herb,
                            type: 'herb',
                            icon: '🌿'
                        });
                    }
                }

                for (let symptom of this.database.symptoms.keys()) {
                    if (symptom.toLowerCase().includes(lowerQuery) && suggestions.length < maxSuggestions) {
                        suggestions.push({
                            text: symptom,
                            type: 'symptom',
                            icon: '🔍'
                        });
                    }
                }

                return suggestions.slice(0, maxSuggestions);
            }

            showAutocompleteSuggestions(suggestions) {
                const list = document.getElementById('autocompleteList');
                
                if (suggestions.length === 0) {
                    this.hideAutocomplete();
                    return;
                }

                let html = '';
                suggestions.forEach(suggestion => {
                    html += `
                        <div class="autocomplete-item px-4 py-3 hover:bg-white/80 cursor-pointer flex items-center transition-all duration-200 hover:transform hover:scale-105" 
                             data-value="${suggestion.text}">
                            <span class="mr-3 text-lg">${suggestion.icon}</span>
                            <span class="flex-1 text-gray-700 font-medium">${suggestion.text}</span>
                            <span class="text-xs px-2 py-1 rounded-full ${suggestion.type === 'herb' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}">${suggestion.type === 'herb' ? '中藥' : '症狀'}</span>
                        </div>
                    `;
                });

                list.innerHTML = html;
                list.classList.remove('hidden');

                list.querySelectorAll('.autocomplete-item').forEach(item => {
                    item.addEventListener('click', () => {
                        document.getElementById('searchInput').value = item.dataset.value;
                        this.hideAutocomplete();
                        this.performIntelligentSearch();
                    });
                });
            }

            showAutocomplete() {
                const value = document.getElementById('searchInput').value;
                if (value) {
                    this.handleAutocomplete(value);
                }
            }

            hideAutocomplete() {
                document.getElementById('autocompleteList').classList.add('hidden');
            }

            displayIntelligentResults(query, results) {
                const container = document.getElementById('resultsContainer');
                
                if (results.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6-4h6m2 5.291A7.962 7.962 0 0112 15c-2.34 0-4.29-1.009-5.824-2.562M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                            </svg>
                            <p class="text-gray-500">未找到與「${query}」相關的結果</p>
                            <p class="text-sm text-gray-400 mt-2">請嘗試其他關鍵詞或檢查拼寫</p>
                        </div>
                    `;
                    return;
                }

                let html = `<div class="fade-in">`;
                
                html += `
                    <div class="mb-4 pb-2 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-700">搜尋「${query}」</span>
                            <span class="text-sm text-gray-500">${results.length} 個結果</span>
                        </div>
                    </div>
                `;

                html += `<div class="space-y-4">`;
                
                results.forEach((result, index) => {
                    const isHerb = result.type === 'herb';
                    const bgColor = isHerb ? 'bg-green-50 border-green-200' : 'bg-blue-50 border-blue-200';
                    const textColor = isHerb ? 'text-green-800' : 'text-blue-800';
                    const tagColor = isHerb ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800';
                    
                    let matchLevelColor = 'bg-gray-200 text-gray-800';
                    let matchLevelText = result.matchType;
                    
                    switch(result.matchLevel) {
                        case 'exact':
                            matchLevelColor = 'bg-red-200 text-red-800';
                            matchLevelText = '🎯 ' + result.matchType;
                            break;
                        case 'contains':
                            matchLevelColor = 'bg-orange-200 text-orange-800';
                            matchLevelText = '📍 ' + result.matchType;
                            break;
                        case 'fuzzy':
                            matchLevelColor = 'bg-yellow-200 text-yellow-800';
                            matchLevelText = '🔍 ' + result.matchType;
                            break;
                        case 'related':
                            matchLevelColor = 'bg-purple-200 text-purple-800';
                            matchLevelText = '🔗 ' + result.matchType;
                            break;
                        case 'semantic':
                            matchLevelColor = 'bg-indigo-200 text-indigo-800';
                            matchLevelText = '🧠 ' + result.matchType;
                            break;
                    }
                    
                    const scoreColor = result.finalScore >= 90 ? 'text-green-600' : 
                                     result.finalScore >= 70 ? 'text-yellow-600' : 
                                     result.finalScore >= 50 ? 'text-orange-600' : 'text-gray-600';
                    
                    html += `
                        <div class="search-result ${bgColor} border rounded-lg p-3 relative">
                            <div class="flex items-center justify-between mb-2">
                                <h5 class="font-semibold ${textColor}">${result.name}</h5>
                                <span class="text-xs px-2 py-1 rounded ${matchLevelColor}">
                                    ${result.matchType}
                                </span>
                            </div>
                            
                            <div class="flex flex-wrap gap-1">
                                ${result.items.map(item => {
                                    const isHighlight = result.highlightItem === item;
                                    const itemClass = isHighlight ? 
                                        `${tagColor} ring-1 ring-yellow-400 font-medium` : 
                                        `${tagColor}`;
                                    return `<span class="${itemClass} px-2 py-1 rounded text-xs">${item}</span>`;
                                }).join('')}
                            </div>
                        </div>
                    `;
                });
                
                html += `</div></div>`;
                container.innerHTML = html;
            }

            clearSearch() {
                document.getElementById('searchInput').value = '';
                document.getElementById('resultsContainer').innerHTML = `
                    <div class="text-gray-500 text-center py-8">
                        <div class="w-12 h-12 mx-auto mb-3 bg-gray-100 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <p class="text-gray-600">請輸入關鍵詞開始搜尋</p>
                    </div>
                `;
            }

            updateStats() {
                document.getElementById('herbCount').textContent = this.database.herbs.size;
                document.getElementById('symptomCount').textContent = this.database.symptoms.size;
            }
        }

        // 初始化應用程序
        document.addEventListener('DOMContentLoaded', () => {
            new FirebaseTCMTool();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9653e3d0106c20fc',t:'MTc1MzUzMjgzMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中醫診症輔助工具 - 雲端同步版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script type="module"
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
        
        // Firebase 配置 (請替換為您的實際配置)
        const firebaseConfig = {
            apiKey: "AIzaSyBtUcrBYiE4B1O4xkvIqwxM52Hrh-i6pL8",
            authDomain: "cheungec-ea477.firebaseapp.com",
            databaseURL: "https://cheungec-ea477-default-rtdb.firebaseio.com",
            projectId: "cheungec-ea477",
            storageBucket: "cheungec-ea477.firebasestorage.app",
            messagingSenderId: "986510230799",
            appId: "1:986510230799:web:f603e67b605e71294f2a7a",
            measurementId: "G-4H26EC2H4Y"
        };
        
        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // 將 Firebase 實例掛載到 window 供其他腳本使用
        window.firebaseApp = app;
        window.firebaseDb = db;
        window.firebaseAuth = auth;
        window.firebaseModules = {
            doc, setDoc, getDoc, onSnapshot, serverTimestamp,
            signInAnonymously, onAuthStateChanged
        };
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .search-highlight {
            background: linear-gradient(120deg, #fbbf24 0%, #f59e0b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .sync-animation {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .pulse-dot {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .cloud-status {
            transition: all 0.3s ease;
        }
        .cloud-status.connected {
            color: #10b981;
        }
        .cloud-status.disconnected {
            color: #ef4444;
        }
        .cloud-status.syncing {
            color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="max-w-4xl mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <h1 class="text-xl font-bold text-gray-800">中藥資料庫</h1>
                    <div class="flex items-center space-x-2 text-sm">
                        <div id="cloudStatus" class="cloud-status disconnected flex items-center space-x-1">
                            <span id="cloudIcon">☁️</span>
                            <span id="cloudText">連接中...</span>
                        </div>
                        <div id="userInfo" class="text-xs text-gray-500 hidden">
                            設備ID: <span id="deviceId">-</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="syncBtn" class="px-3 py-1.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm flex items-center space-x-1">
                        <span id="syncIcon">🔄</span>
                        <span id="syncText">立即同步</span>
                    </button>
                    <button id="shareBtn" class="px-3 py-1.5 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors text-sm">
                        🔗 分享資料
                    </button>
                    <button id="backupBtn" class="px-3 py-1.5 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors text-sm">
                        💾 備份
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-4xl mx-auto px-4 py-6">
        <!-- Connection Status Banner -->
        <div id="connectionBanner" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 hidden">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div id="connectionIndicator" class="w-3 h-3 bg-blue-500 rounded-full pulse-dot"></div>
                    <div>
                        <div id="connectionMessage" class="text-sm font-medium text-blue-800">正在連接雲端服務...</div>
                        <div id="connectionDetails" class="text-xs text-blue-600">初始化 Firebase 連接</div>
                    </div>
                </div>
                <button id="dismissBanner" class="text-blue-400 hover:text-blue-600">×</button>
            </div>
        </div>

        <!-- Search Section -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="relative">
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="搜尋症狀或中藥..." 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                    autocomplete="off"
                >
                <button id="searchBtn" class="absolute right-2 top-2 px-4 py-1.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm">
                    搜尋
                </button>
                <div id="searchSuggestions" class="absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-lg shadow-lg mt-1 hidden z-10 max-h-64 overflow-y-auto"></div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="bg-white rounded-lg shadow-sm p-6 mb-6 hidden">
            <div id="searchResults" class="space-y-4"></div>
        </div>

        <!-- Data Management Section -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex flex-wrap gap-3 mb-4">
                <button id="fileImportBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm">
                    📁 導入檔案
                </button>
                <button id="textImportBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors text-sm">
                    ✏️ 手動輸入
                </button>

                <div class="ml-auto flex items-center space-x-4 text-sm text-gray-600">
                    <span>中藥: <span id="herbCount" class="font-medium">0</span></span>
                    <span>症狀: <span id="symptomCount" class="font-medium">0</span></span>
                    <span class="flex items-center">
                        <span id="dataStatusIndicator" class="w-2 h-2 bg-gray-500 rounded-full mr-1" title="資料狀態"></span>
                        <span id="syncStatusText" class="text-xs">本地</span>
                    </span>
                    <span class="text-xs text-gray-400">
                        最後同步: <span id="lastSyncTime">從未</span>
                    </span>
                </div>
            </div>
            
            <!-- Manual Input Section -->
            <div id="manualInputSection" class="hidden">
                <textarea 
                    id="importData" 
                    rows="6" 
                    placeholder="格式：中藥名：症狀1,症狀2,症狀3&#10;範例：當歸：血虛,月經不調,便秘"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:border-blue-500 focus:outline-none resize-none text-sm mb-3"
                ></textarea>
                <button id="processImport" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm">
                    導入資料
                </button>
            </div>
            
            <!-- File Import Status -->
            <div id="importStatus" class="hidden p-3 rounded-md">
                <div class="flex items-center space-x-2">
                    <span id="statusIcon">✅</span>
                    <span id="statusText" class="text-sm"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Data Modal -->
    <div id="shareModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    🔗 分享資料
                </h3>
                <button id="closeShareModal" class="text-gray-400 hover:text-gray-600 text-xl">×</button>
            </div>
            
            <!-- Share Options -->
            <div class="space-y-4">
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="text-sm font-medium text-gray-800 mb-2">您的分享代碼</div>
                    <div class="flex items-center space-x-2">
                        <input 
                            type="text" 
                            id="shareCode" 
                            readonly 
                            class="flex-1 px-3 py-2 bg-white border border-gray-300 rounded text-sm font-mono"
                            value="載入中..."
                        >
                        <button id="copyShareCode" class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                            複製
                        </button>
                    </div>
                    <div class="text-xs text-gray-500 mt-2">
                        其他設備可使用此代碼存取您的資料
                    </div>
                </div>
                
                <div class="border-t pt-4">
                    <div class="text-sm font-medium text-gray-800 mb-2">存取他人分享的資料</div>
                    <div class="flex items-center space-x-2">
                        <input 
                            type="text" 
                            id="accessCode" 
                            placeholder="輸入分享代碼"
                            class="flex-1 px-3 py-2 border border-gray-300 rounded text-sm"
                        >
                        <button id="accessSharedData" class="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm">
                            存取
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Status Message -->
            <div id="shareStatus" class="hidden mt-4 p-3 rounded-lg text-sm">
                <div class="flex items-center space-x-2">
                    <span id="shareStatusIcon">✅</span>
                    <span id="shareStatusText"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Backup Modal -->
    <div id="backupModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    💾 資料備份
                </h3>
                <button id="closeBackupModal" class="text-gray-400 hover:text-gray-600 text-xl">×</button>
            </div>
            
            <!-- Backup Info -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600" id="backupHerbCount">0</div>
                        <div class="text-gray-600">中藥</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600" id="backupSymptomCount">0</div>
                        <div class="text-gray-600">症狀</div>
                    </div>
                </div>
                <div class="text-center mt-3 text-xs text-gray-500">
                    雲端同步: <span id="cloudSyncStatus" class="font-medium">-</span>
                </div>
            </div>
            
            <!-- Backup Options -->
            <div class="space-y-3">
                <button id="downloadBackup" class="w-full px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center justify-center space-x-2">
                    <span>📥</span>
                    <span>下載備份檔案</span>
                </button>
                
                <button id="copyBackup" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center space-x-2">
                    <span>📋</span>
                    <span>複製到剪貼簿</span>
                </button>
                
                <div class="border-t pt-3">
                    <div class="text-sm text-gray-600 mb-2">或者恢復備份：</div>
                    <button id="restoreBackup" class="w-full px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors flex items-center justify-center space-x-2">
                        <span>📤</span>
                        <span>選擇備份檔案恢復</span>
                    </button>
                </div>
            </div>
            
            <!-- Status Message -->
            <div id="backupStatus" class="hidden mt-4 p-3 rounded-lg text-sm">
                <div class="flex items-center space-x-2">
                    <span id="backupStatusIcon">✅</span>
                    <span id="backupStatusText"></span>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".txt,.json" class="hidden">
    <input type="file" id="backupFileInput" accept=".json" class="hidden">

    <script>
        class CloudTCMTool {
            constructor() {
                this.storageKey = 'tcmData_v4';
                this.currentVersion = '4.0';
                
                // Firebase 相關
                this.isFirebaseReady = false;
                this.currentUser = null;
                this.deviceId = this.getOrCreateDeviceId();
                this.unsubscribeSnapshot = null;
                
                // 資料狀態
                this.data = {
                    herbs: {},
                    symptoms: {}
                };
                
                this.isOnline = navigator.onLine;
                this.lastSyncTime = null;
                this.syncInProgress = false;
                
                // 初始化
                this.initializeApp();
            }

            async initializeApp() {
                // 顯示連接橫幅
                this.showConnectionBanner('正在初始化雲端服務...', '連接 Firebase');
                
                // 載入本地資料
                this.loadLocalData();
                this.updateUI();
                
                // 初始化事件監聽器
                this.initializeEventListeners();
                
                // 等待 Firebase 初始化
                await this.waitForFirebase();
                
                // 初始化 Firebase 認證和資料庫
                await this.initializeFirebase();
                
                // 隱藏連接橫幅
                setTimeout(() => {
                    this.hideConnectionBanner();
                }, 2000);
            }

            async waitForFirebase() {
                return new Promise((resolve) => {
                    const checkFirebase = () => {
                        if (window.firebaseDb && window.firebaseAuth && window.firebaseModules) {
                            resolve();
                        } else {
                            setTimeout(checkFirebase, 100);
                        }
                    };
                    checkFirebase();
                });
            }

            async initializeFirebase() {
                try {
                    const { onAuthStateChanged, signInAnonymously } = window.firebaseModules;
                    
                    // 監聽認證狀態
                    onAuthStateChanged(window.firebaseAuth, async (user) => {
                        if (user) {
                            this.currentUser = user;
                            this.isFirebaseReady = true;
                            this.updateCloudStatus('connected', '雲端已連接');
                            
                            // 設置即時資料監聽
                            await this.setupRealtimeListener();
                            
                            // 執行初始同步
                            await this.performInitialSync();
                            
                        } else {
                            this.updateCloudStatus('disconnected', '未連接');
                        }
                    });
                    
                    // 匿名登入
                    await signInAnonymously(window.firebaseAuth);
                    
                } catch (error) {
                    console.error('Firebase 初始化失敗:', error);
                    this.updateCloudStatus('disconnected', '連接失敗');
                    this.showSystemNotification('❌', 'Firebase 連接失敗，使用離線模式', 'bg-red-100 text-red-800');
                }
            }

            async setupRealtimeListener() {
                if (!this.isFirebaseReady || this.unsubscribeSnapshot) return;
                
                try {
                    const { doc, onSnapshot } = window.firebaseModules;
                    const docRef = doc(window.firebaseDb, 'tcmData', this.deviceId);
                    
                    this.unsubscribeSnapshot = onSnapshot(docRef, (docSnapshot) => {
                        if (docSnapshot.exists() && !this.syncInProgress) {
                            const cloudData = docSnapshot.data();
                            if (cloudData && cloudData.data) {
                                const cloudChecksum = this.generateChecksum(cloudData.data);
                                const localChecksum = this.generateChecksum(this.data);
                                
                                if (cloudChecksum !== localChecksum) {
                                    this.handleCloudDataUpdate(cloudData);
                                }
                            }
                        }
                    }, (error) => {
                        console.error('即時監聽錯誤:', error);
                    });
                    
                } catch (error) {
                    console.error('設置即時監聽失敗:', error);
                }
            }

            handleCloudDataUpdate(cloudData) {
                if (confirm('檢測到雲端資料更新，是否同步到本地？')) {
                    this.data = cloudData.data;
                    this.saveLocalData();
                    this.updateUI();
                    this.lastSyncTime = new Date();
                    this.updateSyncStatus();
                    this.showSystemNotification('🔄', '已同步雲端資料更新', 'bg-blue-100 text-blue-800');
                }
            }

            async performInitialSync() {
                if (!this.isFirebaseReady) return;
                
                try {
                    const { doc, getDoc } = window.firebaseModules;
                    const docRef = doc(window.firebaseDb, 'tcmData', this.deviceId);
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        const cloudData = docSnap.data();
                        const cloudTimestamp = cloudData.lastModified?.toDate() || new Date(0);
                        const localTimestamp = new Date(localStorage.getItem('tcmLastModified') || 0);
                        
                        if (cloudTimestamp > localTimestamp) {
                            this.data = cloudData.data;
                            this.saveLocalData();
                            this.updateUI();
                            this.showSystemNotification('📥', '已載入雲端資料', 'bg-green-100 text-green-800');
                        } else if (localTimestamp > cloudTimestamp) {
                            await this.syncToCloud();
                        }
                    } else {
                        // 雲端沒有資料，上傳本地資料
                        if (Object.keys(this.data.herbs).length > 0) {
                            await this.syncToCloud();
                        }
                    }
                    
                    this.lastSyncTime = new Date();
                    this.updateSyncStatus();
                    
                } catch (error) {
                    console.error('初始同步失敗:', error);
                }
            }

            async syncToCloud() {
                if (!this.isFirebaseReady || this.syncInProgress) return;
                
                this.syncInProgress = true;
                this.updateCloudStatus('syncing', '同步中...');
                
                try {
                    const { doc, setDoc, serverTimestamp } = window.firebaseModules;
                    const docRef = doc(window.firebaseDb, 'tcmData', this.deviceId);
                    
                    const cloudData = {
                        data: this.data,
                        lastModified: serverTimestamp(),
                        version: this.currentVersion,
                        deviceId: this.deviceId,
                        checksum: this.generateChecksum(this.data)
                    };
                    
                    await setDoc(docRef, cloudData);
                    
                    this.lastSyncTime = new Date();
                    localStorage.setItem('tcmLastModified', this.lastSyncTime.toISOString());
                    
                    this.updateCloudStatus('connected', '雲端已連接');
                    this.updateSyncStatus();
                    
                    return true;
                } catch (error) {
                    console.error('同步到雲端失敗:', error);
                    this.updateCloudStatus('disconnected', '同步失敗');
                    throw error;
                } finally {
                    this.syncInProgress = false;
                }
            }

            async accessSharedData(shareCode) {
                if (!this.isFirebaseReady) {
                    throw new Error('雲端服務未就緒');
                }
                
                try {
                    const { doc, getDoc } = window.firebaseModules;
                    const docRef = doc(window.firebaseDb, 'tcmData', shareCode);
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        const sharedData = docSnap.data();
                        return sharedData.data;
                    } else {
                        throw new Error('分享代碼無效或資料不存在');
                    }
                } catch (error) {
                    console.error('存取分享資料失敗:', error);
                    throw error;
                }
            }

            getOrCreateDeviceId() {
                let deviceId = localStorage.getItem('tcmDeviceId');
                if (!deviceId) {
                    deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('tcmDeviceId', deviceId);
                }
                return deviceId;
            }

            loadLocalData() {
                try {
                    const stored = localStorage.getItem(this.storageKey);
                    if (stored) {
                        this.data = JSON.parse(stored);
                    }
                } catch (error) {
                    console.error('載入本地資料失敗:', error);
                }
            }

            saveLocalData() {
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(this.data));
                    localStorage.setItem('tcmLastModified', new Date().toISOString());
                } catch (error) {
                    console.error('保存本地資料失敗:', error);
                }
            }

            updateCloudStatus(status, message) {
                const cloudStatus = document.getElementById('cloudStatus');
                const cloudIcon = document.getElementById('cloudIcon');
                const cloudText = document.getElementById('cloudText');
                
                cloudStatus.className = `cloud-status ${status} flex items-center space-x-1`;
                
                switch (status) {
                    case 'connected':
                        cloudIcon.textContent = '☁️';
                        break;
                    case 'disconnected':
                        cloudIcon.textContent = '⚠️';
                        break;
                    case 'syncing':
                        cloudIcon.textContent = '🔄';
                        cloudIcon.classList.add('sync-animation');
                        break;
                }
                
                cloudText.textContent = message;
                
                if (status !== 'syncing') {
                    cloudIcon.classList.remove('sync-animation');
                }
                
                // 更新用戶信息
                document.getElementById('deviceId').textContent = this.deviceId.substring(0, 12) + '...';
                document.getElementById('userInfo').classList.remove('hidden');
            }

            updateSyncStatus() {
                const indicator = document.getElementById('dataStatusIndicator');
                const statusText = document.getElementById('syncStatusText');
                const lastSyncElement = document.getElementById('lastSyncTime');
                
                if (this.isFirebaseReady && this.lastSyncTime) {
                    const now = new Date();
                    const diffMinutes = Math.floor((now - this.lastSyncTime) / 60000);
                    
                    if (diffMinutes < 5) {
                        indicator.className = 'w-2 h-2 bg-green-500 rounded-full mr-1 pulse-dot';
                        statusText.textContent = '已同步';
                    } else if (diffMinutes < 60) {
                        indicator.className = 'w-2 h-2 bg-yellow-500 rounded-full mr-1';
                        statusText.textContent = '需同步';
                    } else {
                        indicator.className = 'w-2 h-2 bg-orange-500 rounded-full mr-1';
                        statusText.textContent = '過期';
                    }
                    
                    lastSyncElement.textContent = this.lastSyncTime.toLocaleTimeString('zh-TW');
                } else {
                    indicator.className = 'w-2 h-2 bg-gray-500 rounded-full mr-1';
                    statusText.textContent = '本地';
                    lastSyncElement.textContent = '從未';
                }
            }

            showConnectionBanner(message, details) {
                const banner = document.getElementById('connectionBanner');
                const messageElement = document.getElementById('connectionMessage');
                const detailsElement = document.getElementById('connectionDetails');
                
                messageElement.textContent = message;
                detailsElement.textContent = details;
                banner.classList.remove('hidden');
            }

            hideConnectionBanner() {
                document.getElementById('connectionBanner').classList.add('hidden');
            }

            generateChecksum(data) {
                const str = JSON.stringify(data);
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return hash.toString(16);
            }

            showSystemNotification(icon, message, className, duration = 3000) {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 ${className} p-4 rounded-lg shadow-lg z-50 max-w-sm`;
                notification.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <span class="text-xl">${icon}</span>
                        <div class="flex-1">
                            <div class="text-sm font-medium">${message}</div>
                            <div class="text-xs opacity-75 mt-1">${new Date().toLocaleTimeString('zh-TW')}</div>
                        </div>
                        <button class="text-lg opacity-50 hover:opacity-100" onclick="this.parentElement.parentElement.remove()">×</button>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, duration);
            }

            initializeEventListeners() {
                // 搜尋功能
                document.getElementById('searchBtn').addEventListener('click', () => this.search());
                document.getElementById('searchInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.search();
                });
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.showSearchSuggestions(e.target.value);
                });

                // 同步功能
                document.getElementById('syncBtn').addEventListener('click', () => this.handleSyncClick());

                // 分享功能
                document.getElementById('shareBtn').addEventListener('click', () => this.showShareModal());
                document.getElementById('closeShareModal').addEventListener('click', () => this.hideShareModal());
                document.getElementById('copyShareCode').addEventListener('click', () => this.copyShareCode());
                document.getElementById('accessSharedData').addEventListener('click', () => this.handleAccessSharedData());

                // 備份功能
                document.getElementById('backupBtn').addEventListener('click', () => this.showBackupModal());
                document.getElementById('closeBackupModal').addEventListener('click', () => this.hideBackupModal());
                document.getElementById('downloadBackup').addEventListener('click', () => this.downloadBackup());
                document.getElementById('copyBackup').addEventListener('click', () => this.copyBackupToClipboard());
                document.getElementById('restoreBackup').addEventListener('click', () => this.triggerBackupRestore());
                document.getElementById('backupFileInput').addEventListener('change', (e) => this.handleBackupRestore(e));

                // 資料管理
                document.getElementById('fileImportBtn').addEventListener('click', () => this.triggerFileImport());
                document.getElementById('textImportBtn').addEventListener('click', () => this.toggleManualInput());
                document.getElementById('processImport').addEventListener('click', () => this.processImportData());
                document.getElementById('fileInput').addEventListener('change', (e) => this.handleFileImport(e));

                // 連接橫幅
                document.getElementById('dismissBanner').addEventListener('click', () => this.hideConnectionBanner());

                // 點擊外部隱藏建議
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#searchInput') && !e.target.closest('#searchSuggestions')) {
                        this.hideSearchSuggestions();
                    }
                });
            }

            async handleSyncClick() {
                if (!this.isFirebaseReady) {
                    this.showSystemNotification('⚠️', '雲端服務未就緒', 'bg-yellow-100 text-yellow-800');
                    return;
                }

                const syncIcon = document.getElementById('syncIcon');
                const syncText = document.getElementById('syncText');
                
                syncIcon.classList.add('sync-animation');
                syncText.textContent = '同步中...';
                
                try {
                    await this.syncToCloud();
                    this.showSystemNotification('✅', '資料同步成功', 'bg-green-100 text-green-800');
                } catch (error) {
                    this.showSystemNotification('❌', '同步失敗: ' + error.message, 'bg-red-100 text-red-800');
                } finally {
                    setTimeout(() => {
                        syncIcon.classList.remove('sync-animation');
                        syncText.textContent = '立即同步';
                    }, 1000);
                }
            }

            showShareModal() {
                document.getElementById('shareCode').value = this.deviceId;
                document.getElementById('shareModal').classList.remove('hidden');
                document.getElementById('shareModal').classList.add('flex');
            }

            hideShareModal() {
                document.getElementById('shareModal').classList.add('hidden');
                document.getElementById('shareModal').classList.remove('flex');
                document.getElementById('shareStatus').classList.add('hidden');
            }

            async copyShareCode() {
                try {
                    await navigator.clipboard.writeText(this.deviceId);
                    this.showShareStatus('✅', '分享代碼已複製', 'bg-green-100 text-green-800');
                } catch (error) {
                    this.showShareStatus('❌', '複製失敗', 'bg-red-100 text-red-800');
                }
            }

            async handleAccessSharedData() {
                const shareCode = document.getElementById('accessCode').value.trim();
                if (!shareCode) {
                    this.showShareStatus('⚠️', '請輸入分享代碼', 'bg-yellow-100 text-yellow-800');
                    return;
                }

                this.showShareStatus('⏳', '正在存取分享資料...', 'bg-blue-100 text-blue-800');

                try {
                    const sharedData = await this.accessSharedData(shareCode);
                    
                    if (confirm('確定要載入分享的資料嗎？這將覆蓋現有資料。')) {
                        this.data = sharedData;
                        this.saveLocalData();
                        await this.syncToCloud();
                        this.updateUI();
                        
                        this.showShareStatus('✅', '分享資料載入成功', 'bg-green-100 text-green-800');
                        
                        setTimeout(() => {
                            this.hideShareModal();
                        }, 2000);
                    } else {
                        this.showShareStatus('ℹ️', '載入已取消', 'bg-gray-100 text-gray-800');
                    }
                } catch (error) {
                    this.showShareStatus('❌', error.message, 'bg-red-100 text-red-800');
                }
            }

            showShareStatus(icon, text, className) {
                const statusDiv = document.getElementById('shareStatus');
                const statusIcon = document.getElementById('shareStatusIcon');
                const statusText = document.getElementById('shareStatusText');
                
                statusIcon.textContent = icon;
                statusText.textContent = text;
                statusDiv.className = `mt-4 p-3 rounded-lg text-sm ${className}`;
                statusDiv.classList.remove('hidden');
                
                if (icon === '✅') {
                    setTimeout(() => {
                        statusDiv.classList.add('hidden');
                    }, 3000);
                }
            }

            // 搜尋相關方法
            search() {
                const query = document.getElementById('searchInput').value.trim();
                if (!query) return;

                const results = this.performSearch(query);
                this.displaySearchResults(query, results);
            }

            performSearch(query) {
                const results = {
                    herbResults: [],
                    symptomResults: []
                };

                const normalizedQuery = query.toLowerCase();

                // 搜尋中藥
                Object.keys(this.data.herbs).forEach(herb => {
                    if (herb.toLowerCase().includes(normalizedQuery)) {
                        results.herbResults.push({
                            name: herb,
                            symptoms: this.data.herbs[herb],
                            score: 100
                        });
                    }
                });

                // 搜尋症狀
                Object.keys(this.data.symptoms).forEach(symptom => {
                    if (symptom.toLowerCase().includes(normalizedQuery)) {
                        results.symptomResults.push({
                            name: symptom,
                            herbs: this.data.symptoms[symptom],
                            score: 100
                        });
                    }
                });

                return results;
            }

            displaySearchResults(query, results) {
                const resultsSection = document.getElementById('resultsSection');
                const searchResults = document.getElementById('searchResults');
                
                resultsSection.classList.remove('hidden');
                searchResults.innerHTML = '';

                const totalResults = results.herbResults.length + results.symptomResults.length;

                if (totalResults === 0) {
                    searchResults.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <div class="text-4xl mb-4">🔍</div>
                            <p class="text-lg">未找到相關結果</p>
                            <p class="text-sm mt-2">請嘗試其他關鍵字或檢查拼寫</p>
                        </div>
                    `;
                    return;
                }

                // 顯示中藥結果
                if (results.herbResults.length > 0) {
                    const herbSection = document.createElement('div');
                    herbSection.className = 'mb-8';
                    herbSection.innerHTML = `
                        <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                            <span class="mr-2">🌿</span>
                            <span>中藥</span>
                            <span class="ml-2 text-xs text-gray-500">(${results.herbResults.length})</span>
                        </h4>
                    `;

                    results.herbResults.forEach(herb => {
                        const herbCard = document.createElement('div');
                        herbCard.className = `bg-gradient-to-r from-green-50 to-green-25 border-l-4 border-green-500 p-4 rounded-lg mb-3`;
                        herbCard.innerHTML = `
                            <div class="flex justify-between items-start mb-3">
                                <h5 class="font-bold text-green-800 text-lg">${herb.name}</h5>
                                <div class="text-sm font-medium text-gray-700">${herb.score}%</div>
                            </div>
                            <div class="mb-2">
                                <div class="text-xs text-gray-600 mb-1">主治症狀：</div>
                                <div class="flex flex-wrap gap-1">
                                    ${herb.symptoms.map(symptom => 
                                        `<span class="px-2 py-1 text-xs rounded bg-green-100 text-green-800">${symptom}</span>`
                                    ).join('')}
                                </div>
                            </div>
                        `;
                        herbSection.appendChild(herbCard);
                    });

                    searchResults.appendChild(herbSection);
                }

                // 顯示症狀結果
                if (results.symptomResults.length > 0) {
                    const symptomSection = document.createElement('div');
                    symptomSection.className = 'mb-8';
                    symptomSection.innerHTML = `
                        <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                            <span class="mr-2">🩺</span>
                            <span>症狀</span>
                            <span class="ml-2 text-xs text-gray-500">(${results.symptomResults.length})</span>
                        </h4>
                    `;

                    results.symptomResults.forEach(symptom => {
                        const symptomCard = document.createElement('div');
                        symptomCard.className = `bg-gradient-to-r from-blue-50 to-blue-25 border-l-4 border-blue-500 p-4 rounded-lg mb-3`;
                        symptomCard.innerHTML = `
                            <div class="flex justify-between items-start mb-3">
                                <h5 class="font-bold text-blue-800 text-lg">${symptom.name}</h5>
                                <div class="text-sm font-medium text-gray-700">${symptom.score}%</div>
                            </div>
                            <div class="mb-2">
                                <div class="text-xs text-gray-600 mb-1">相關中藥：</div>
                                <div class="flex flex-wrap gap-1">
                                    ${symptom.herbs.map(herb => 
                                        `<span class="px-2 py-1 text-xs rounded bg-blue-100 text-blue-800">${herb}</span>`
                                    ).join('')}
                                </div>
                            </div>
                        `;
                        symptomSection.appendChild(symptomCard);
                    });

                    searchResults.appendChild(symptomSection);
                }
            }

            showSearchSuggestions(query) {
                const suggestionsDiv = document.getElementById('searchSuggestions');
                
                if (!query || query.length < 1) {
                    this.hideSearchSuggestions();
                    return;
                }

                const suggestions = this.generateSuggestions(query);
                
                if (suggestions.length === 0) {
                    this.hideSearchSuggestions();
                    return;
                }

                suggestionsDiv.innerHTML = '';
                suggestions.forEach(suggestion => {
                    const suggestionItem = document.createElement('div');
                    suggestionItem.className = 'px-4 py-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0 flex items-center justify-between';
                    suggestionItem.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <span class="text-lg">${suggestion.icon}</span>
                            <div>
                                <div class="font-medium text-gray-800">${suggestion.text}</div>
                                <div class="text-xs text-gray-500">${suggestion.type} • ${suggestion.count} 個相關項目</div>
                            </div>
                        </div>
                    `;
                    
                    suggestionItem.addEventListener('click', () => {
                        document.getElementById('searchInput').value = suggestion.text;
                        this.hideSearchSuggestions();
                        this.search();
                    });
                    
                    suggestionsDiv.appendChild(suggestionItem);
                });

                suggestionsDiv.classList.remove('hidden');
            }

            generateSuggestions(query) {
                const suggestions = [];
                const normalizedQuery = query.toLowerCase();

                // 從中藥獲取建議
                Object.keys(this.data.herbs).forEach(herb => {
                    if (herb.toLowerCase().includes(normalizedQuery)) {
                        suggestions.push({
                            text: herb,
                            type: '中藥',
                            icon: '🌿',
                            count: this.data.herbs[herb].length,
                            category: 'herb'
                        });
                    }
                });

                // 從症狀獲取建議
                Object.keys(this.data.symptoms).forEach(symptom => {
                    if (symptom.toLowerCase().includes(normalizedQuery)) {
                        suggestions.push({
                            text: symptom,
                            type: '症狀',
                            icon: '🩺',
                            count: this.data.symptoms[symptom].length,
                            category: 'symptom'
                        });
                    }
                });

                return suggestions.slice(0, 8);
            }

            hideSearchSuggestions() {
                document.getElementById('searchSuggestions').classList.add('hidden');
            }

            // 資料管理方法
            triggerFileImport() {
                document.getElementById('fileInput').click();
            }

            toggleManualInput() {
                const manualSection = document.getElementById('manualInputSection');
                const isHidden = manualSection.classList.contains('hidden');
                
                if (isHidden) {
                    manualSection.classList.remove('hidden');
                    document.getElementById('textImportBtn').textContent = '✏️ 隱藏輸入';
                } else {
                    manualSection.classList.add('hidden');
                    document.getElementById('textImportBtn').innerHTML = '✏️ 手動輸入';
                }
            }

            async processImportData() {
                const importText = document.getElementById('importData').value.trim();
                if (!importText) {
                    this.showImportStatus('⚠️', '請輸入要導入的資料', 'bg-yellow-100 text-yellow-800');
                    return;
                }

                this.showImportStatus('⏳', '正在處理資料...', 'bg-blue-100 text-blue-800');

                const lines = importText.split('\n').filter(line => line.trim());
                let successCount = 0;

                lines.forEach(line => {
                    const parts = line.split('：');
                    if (parts.length === 2) {
                        const herb = parts[0].trim();
                        const symptoms = parts[1].split(',').map(s => s.trim()).filter(s => s);
                        
                        if (herb && symptoms.length > 0) {
                            this.addHerbData(herb, symptoms);
                            successCount++;
                        }
                    }
                });

                this.saveLocalData();
                this.updateUI();
                document.getElementById('importData').value = '';
                
                this.showImportStatus('✅', `成功導入 ${successCount} 條中藥資料`, 'bg-green-100 text-green-800');
                
                // 自動同步到雲端
                if (this.isFirebaseReady) {
                    try {
                        await this.syncToCloud();
                    } catch (error) {
                        console.error('自動同步失敗:', error);
                    }
                }
                
                setTimeout(() => {
                    document.getElementById('manualInputSection').classList.add('hidden');
                    document.getElementById('textImportBtn').innerHTML = '✏️ 手動輸入';
                    document.getElementById('importStatus').classList.add('hidden');
                }, 2000);
            }

            addHerbData(herb, symptoms) {
                if (!this.data.herbs[herb]) {
                    this.data.herbs[herb] = [];
                }
                
                symptoms.forEach(symptom => {
                    if (!this.data.herbs[herb].includes(symptom)) {
                        this.data.herbs[herb].push(symptom);
                    }
                    
                    if (!this.data.symptoms[symptom]) {
                        this.data.symptoms[symptom] = [];
                    }
                    if (!this.data.symptoms[symptom].includes(herb)) {
                        this.data.symptoms[symptom].push(herb);
                    }
                });
            }

            handleFileImport(event) {
                const file = event.target.files[0];
                if (!file) return;

                this.showImportStatus('⏳', '正在處理檔案...', 'bg-blue-100 text-blue-800');

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const content = e.target.result;
                        let successCount = 0;
                        
                        if (file.name.endsWith('.json')) {
                            const importedData = JSON.parse(content);
                            if (importedData.data) {
                                this.data = importedData.data;
                                successCount = Object.keys(importedData.data.herbs || {}).length;
                            } else {
                                this.data = importedData;
                                successCount = Object.keys(importedData.herbs || {}).length;
                            }
                        } else {
                            const lines = content.split('\n').filter(line => line.trim());
                            lines.forEach(line => {
                                const parts = line.split('：');
                                if (parts.length === 2) {
                                    const herb = parts[0].trim();
                                    const symptoms = parts[1].split(',').map(s => s.trim()).filter(s => s);
                                    
                                    if (herb && symptoms.length > 0) {
                                        this.addHerbData(herb, symptoms);
                                        successCount++;
                                    }
                                }
                            });
                        }
                        
                        this.saveLocalData();
                        this.updateUI();
                        this.showImportStatus('✅', `成功導入 ${successCount} 條資料`, 'bg-green-100 text-green-800');
                        
                        // 自動同步到雲端
                        if (this.isFirebaseReady) {
                            try {
                                await this.syncToCloud();
                            } catch (error) {
                                console.error('自動同步失敗:', error);
                            }
                        }
                        
                        setTimeout(() => {
                            document.getElementById('importStatus').classList.add('hidden');
                        }, 3000);
                        
                    } catch (error) {
                        this.showImportStatus('❌', '檔案格式錯誤，請檢查檔案內容', 'bg-red-100 text-red-800');
                    }
                };
                reader.readAsText(file);
                
                event.target.value = '';
            }

            showImportStatus(icon, text, className) {
                const statusDiv = document.getElementById('importStatus');
                const statusIcon = document.getElementById('statusIcon');
                const statusText = document.getElementById('statusText');
                
                statusIcon.textContent = icon;
                statusText.textContent = text;
                statusDiv.className = `p-3 rounded-lg ${className}`;
                statusDiv.classList.remove('hidden');
            }

            // 備份相關方法
            showBackupModal() {
                const herbCount = Object.keys(this.data.herbs).length;
                const symptomCount = Object.keys(this.data.symptoms).length;
                const cloudStatus = this.isFirebaseReady ? '已連接' : '未連接';
                
                document.getElementById('backupHerbCount').textContent = herbCount;
                document.getElementById('backupSymptomCount').textContent = symptomCount;
                document.getElementById('cloudSyncStatus').textContent = cloudStatus;
                
                document.getElementById('backupModal').classList.remove('hidden');
                document.getElementById('backupModal').classList.add('flex');
            }

            hideBackupModal() {
                document.getElementById('backupModal').classList.add('hidden');
                document.getElementById('backupModal').classList.remove('flex');
                document.getElementById('backupStatus').classList.add('hidden');
            }

            downloadBackup() {
                try {
                    const backupData = this.createBackupData();
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
                    const filename = `TCM_CloudBackup_${timestamp}.json`;
                    
                    const blob = new Blob([JSON.stringify(backupData, null, 2)], { 
                        type: 'application/json' 
                    });
                    
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    link.click();
                    
                    URL.revokeObjectURL(url);
                    
                    this.showBackupStatus('✅', '備份檔案已下載完成！', 'bg-green-100 text-green-800');
                } catch (error) {
                    this.showBackupStatus('❌', '下載失敗，請重試', 'bg-red-100 text-red-800');
                }
            }

            async copyBackupToClipboard() {
                try {
                    const backupData = this.createBackupData();
                    const backupText = JSON.stringify(backupData, null, 2);
                    
                    await navigator.clipboard.writeText(backupText);
                    this.showBackupStatus('✅', '備份資料已複製到剪貼簿！', 'bg-green-100 text-green-800');
                } catch (error) {
                    const textArea = document.createElement('textarea');
                    textArea.value = JSON.stringify(this.createBackupData(), null, 2);
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    this.showBackupStatus('✅', '備份資料已複製到剪貼簿！', 'bg-green-100 text-green-800');
                }
            }

            triggerBackupRestore() {
                document.getElementById('backupFileInput').click();
            }

            async handleBackupRestore(event) {
                const file = event.target.files[0];
                if (!file) return;

                this.showBackupStatus('⏳', '正在恢復備份...', 'bg-blue-100 text-blue-800');

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        if (this.validateBackupData(backupData)) {
                            if (confirm('確定要恢復此備份嗎？這將覆蓋現有的所有資料。')) {
                                this.restoreFromBackup(backupData);
                                
                                // 同步到雲端
                                if (this.isFirebaseReady) {
                                    try {
                                        await this.syncToCloud();
                                    } catch (error) {
                                        console.error('恢復後同步失敗:', error);
                                    }
                                }
                                
                                this.showBackupStatus('✅', '備份恢復成功！', 'bg-green-100 text-green-800');
                                
                                setTimeout(() => {
                                    this.hideBackupModal();
                                    this.updateUI();
                                }, 1500);
                            } else {
                                this.showBackupStatus('ℹ️', '恢復已取消', 'bg-gray-100 text-gray-800');
                            }
                        } else {
                            this.showBackupStatus('❌', '備份檔案格式不正確', 'bg-red-100 text-red-800');
                        }
                    } catch (error) {
                        this.showBackupStatus('❌', '備份檔案損壞或格式錯誤', 'bg-red-100 text-red-800');
                    }
                };
                
                reader.readAsText(file);
                event.target.value = '';
            }

            createBackupData() {
                return {
                    version: this.currentVersion,
                    appName: '中醫診症輔助工具 - 雲端同步版',
                    backupDate: new Date().toISOString(),
                    backupTime: new Date().toLocaleString('zh-TW'),
                    deviceId: this.deviceId,
                    cloudSync: this.isFirebaseReady,
                    statistics: {
                        herbCount: Object.keys(this.data.herbs).length,
                        symptomCount: Object.keys(this.data.symptoms).length,
                        totalRelations: Object.values(this.data.herbs).reduce((sum, symptoms) => sum + symptoms.length, 0)
                    },
                    data: {
                        herbs: this.data.herbs,
                        symptoms: this.data.symptoms
                    },
                    checksum: this.generateChecksum(this.data)
                };
            }

            validateBackupData(backupData) {
                if (!backupData.data || !backupData.data.herbs || !backupData.data.symptoms) {
                    return false;
                }
                
                if (typeof backupData.data.herbs !== 'object' || typeof backupData.data.symptoms !== 'object') {
                    return false;
                }
                
                if (backupData.checksum) {
                    const calculatedChecksum = this.generateChecksum(backupData.data);
                    if (calculatedChecksum !== backupData.checksum) {
                        console.warn('Backup checksum mismatch - data may be corrupted');
                    }
                }
                
                return true;
            }

            restoreFromBackup(backupData) {
                this.data = {
                    herbs: backupData.data.herbs,
                    symptoms: backupData.data.symptoms
                };
                
                this.saveLocalData();
                
                document.getElementById('resultsSection').classList.add('hidden');
                document.getElementById('searchInput').value = '';
            }

            showBackupStatus(icon, text, className) {
                const statusDiv = document.getElementById('backupStatus');
                const statusIcon = document.getElementById('backupStatusIcon');
                const statusText = document.getElementById('backupStatusText');
                
                statusIcon.textContent = icon;
                statusText.textContent = text;
                statusDiv.className = `mt-4 p-3 rounded-lg text-sm ${className}`;
                statusDiv.classList.remove('hidden');
                
                if (icon === '✅') {
                    setTimeout(() => {
                        statusDiv.classList.add('hidden');
                    }, 3000);
                }
            }

            updateUI() {
                const herbCount = Object.keys(this.data.herbs).length;
                const symptomCount = Object.keys(this.data.symptoms).length;
                
                document.getElementById('herbCount').textContent = herbCount;
                document.getElementById('symptomCount').textContent = symptomCount;
                
                this.updateSyncStatus();
            }
        }

        // 初始化應用程式
        document.addEventListener('DOMContentLoaded', () => {
            new CloudTCMTool();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9652d95cf50184ab',t:'MTc1MzUyMTkxOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
