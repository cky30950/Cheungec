<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中醫診所管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">
    <!-- 登入頁面 -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-white text-2xl">🏥</span>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">中醫診所管理系統</h1>
                <p class="text-gray-600 mt-2">請選擇您的身份登入</p>
            </div>
            
            <div class="space-y-4">
                <button onclick="login('admin')" class="w-full bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded-lg font-medium transition-colors">
                    管理員登入
                </button>
                <button onclick="login('doctor')" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-medium transition-colors">
                    醫師登入
                </button>
                <button onclick="login('assistant')" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg font-medium transition-colors">
                    診所助理登入
                </button>
            </div>
        </div>
    </div>

    <!-- 主系統頁面 -->
    <div id="mainSystem" class="hidden min-h-screen">
        <!-- 側邊選單 -->
        <div id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-2xl transform -translate-x-full transition-transform duration-300 ease-in-out">
            <div class="flex flex-col h-full">
                <!-- 選單標題 -->
                <div class="bg-green-600 text-white p-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <span class="text-lg">🏥</span>
                            </div>
                            <div>
                                <h2 class="font-bold text-lg">診所系統</h2>
                                <p class="text-green-100 text-sm" id="sidebarUserRole"></p>
                            </div>
                        </div>
                        <button onclick="closeSidebar()" class="text-white hover:text-green-200 text-2xl">×</button>
                    </div>
                </div>
                
                <!-- 選單項目 -->
                <div class="flex-1 py-4" id="sidebarMenu">
                    <!-- 選單項目會動態載入 -->
                </div>
                
                <!-- 底部登出 -->
                <div class="p-4 border-t border-gray-200">
                    <button onclick="logout()" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg font-medium transition-colors">
                        登出系統
                    </button>
                </div>
            </div>
        </div>

        <!-- 選單遮罩 -->
        <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden" onclick="closeSidebar()"></div>

        <!-- 頂部導航 -->
        <nav class="bg-white shadow-lg border-b-4 border-green-500">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-4">
                        <button onclick="openSidebar()" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                            </svg>
                        </button>
                        <div class="w-10 h-10 bg-green-600 rounded-full flex items-center justify-center">
                            <span class="text-white text-lg">🏥</span>
                        </div>
                        <h1 class="text-xl font-bold text-gray-800">中醫診所管理系統</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="userRole" class="text-sm text-gray-600 bg-gray-100 px-3 py-1 rounded-full"></span>
                        <button onclick="logout()" class="text-red-600 hover:text-red-800 font-medium">登出</button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- 主要內容區域 -->
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div id="welcomeMessage" class="bg-white rounded-xl shadow-lg p-8 text-center">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-4xl">🏥</span>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">歡迎使用中醫診所管理系統</h2>
                <p class="text-gray-600">請使用左側選單開始使用系統功能</p>
            </div>
        </div>

        <!-- 病人資料管理 -->
        <div id="patientManagement" class="hidden max-w-7xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">病人資料管理</h2>
                    <button onclick="showAddPatientForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">
                        新增病人
                    </button>
                </div>
                
                <!-- 搜索功能 -->
                <div class="mb-6">
                    <div class="relative">
                        <input type="text" id="patientSearchInput" placeholder="搜索病人姓名、電話..." 
                               onkeyup="searchPatients()" 
                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <!-- 病人列表 -->
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">病人編號</th>
                                <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">姓名</th>
                                <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">性別</th>
                                <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">年齡</th>
                                <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">電話</th>
                                <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">操作</th>
                            </tr>
                        </thead>
                        <tbody id="patientList">
                            <!-- 病人資料會動態載入 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 新增病人表單 -->
        <div id="addPatientForm" class="hidden max-w-2xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">新增病人資料</h2>
                <form onsubmit="addPatient(event)" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">姓名 *</label>
                            <input type="text" id="patientName" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">身份證字號 *</label>
                            <input type="text" id="patientIdNumber" required pattern="[A-Z][0-9]{9}" maxlength="10" placeholder="如：A123456789" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">性別 *</label>
                            <select id="patientGender" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="">請選擇</option>
                                <option value="男">男</option>
                                <option value="女">女</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">出生日期 *</label>
                            <input type="date" id="patientBirthDate" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">電話 *</label>
                            <input type="tel" id="patientPhone" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">地址</label>
                            <input type="text" id="patientAddress" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                    </div>
                    <div class="flex space-x-4 pt-4">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium">
                            儲存
                        </button>
                        <button type="button" onclick="showPatientManagement()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium">
                            取消
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 編輯病人表單 -->
        <div id="editPatientForm" class="hidden max-w-2xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">編輯病人資料</h2>
                <form onsubmit="updatePatient(event)" class="space-y-4">
                    <input type="hidden" id="editPatientId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">姓名 *</label>
                            <input type="text" id="editPatientName" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">身份證字號 *</label>
                            <input type="text" id="editPatientIdNumber" required pattern="[A-Z][0-9]{9}" maxlength="10" placeholder="如：A123456789" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">性別 *</label>
                            <select id="editPatientGender" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">請選擇</option>
                                <option value="男">男</option>
                                <option value="女">女</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">出生日期 *</label>
                            <input type="date" id="editPatientBirthDate" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">電話 *</label>
                            <input type="tel" id="editPatientPhone" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">地址</label>
                            <input type="text" id="editPatientAddress" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                    <div class="flex space-x-4 pt-4">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium">
                            更新資料
                        </button>
                        <button type="button" onclick="showPatientManagement()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium">
                            取消
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 診症系統 -->
        <div id="consultationSystem" class="hidden max-w-7xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">診症系統</h2>
                    <button onclick="showAppointmentForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">
                        病人掛號
                    </button>
                </div>
                
                <!-- 今日掛號病人列表 -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">今日掛號病人</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">掛號時間</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">病人編號</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">病人姓名</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">年齡</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">狀態</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">操作</th>
                                </tr>
                            </thead>
                            <tbody id="appointmentList">
                                <!-- 掛號列表會動態載入 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 掛號表單 -->
        <div id="appointmentForm" class="hidden max-w-2xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">病人掛號</h2>
                
                <!-- 搜索病人 -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">搜索並選擇病人</label>
                    <div class="relative">
                        <input type="text" id="appointmentSearchInput" placeholder="搜索病人姓名、電話..." 
                               oninput="searchAppointmentPatients()" 
                               onfocus="showSearchResults()"
                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        
                        <!-- 搜索結果下拉選單 -->
                        <div id="searchResults" class="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-60 overflow-y-auto z-10 hidden">
                            <div id="searchResultsList" class="py-1">
                                <!-- 搜索結果會動態載入 -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- 選中的病人顯示 -->
                    <div id="selectedPatientInfo" class="hidden mt-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex justify-between items-center">
                            <div>
                                <span class="text-sm text-green-700">已選擇病人：</span>
                                <span id="selectedPatientDisplay" class="font-medium text-green-800"></span>
                            </div>
                            <button type="button" onclick="clearSelectedPatient()" class="text-green-600 hover:text-green-800 text-sm">
                                重新選擇
                            </button>
                        </div>
                    </div>
                </div>
                
                <form onsubmit="addAppointment(event)" class="space-y-4">
                    <input type="hidden" id="selectedPatientId" required>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">掛號時間 *</label>
                        <input type="datetime-local" id="appointmentTime" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">症狀描述</label>
                        <textarea id="appointmentSymptoms" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="簡述病人主要症狀"></textarea>
                    </div>
                    
                    <div class="flex space-x-4 pt-4">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium">
                            確認掛號
                        </button>
                        <button type="button" onclick="showConsultationSystem()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium">
                            取消
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 中藥及方劑庫 -->
        <div id="herbalLibrary" class="hidden max-w-7xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">🌿 中藥及方劑庫</h2>
                    <div class="flex space-x-2">
                        <button onclick="showAddHerbForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">
                            新增中藥
                        </button>
                        <button onclick="showAddFormulaForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">
                            新增方劑
                        </button>
                    </div>
                </div>
                
                <!-- 分類標籤 -->
                <div class="mb-6">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterHerbalItems('all')" class="px-4 py-2 bg-amber-600 text-white rounded-lg text-sm font-medium hover:bg-amber-700" id="herbal-filter-all">
                            全部
                        </button>
                        <button onclick="filterHerbalItems('herb')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300" id="herbal-filter-herb">
                            🌿 中藥
                        </button>
                        <button onclick="filterHerbalItems('formula')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300" id="herbal-filter-formula">
                            📜 方劑
                        </button>
                    </div>
                </div>
                
                <!-- 搜索功能 -->
                <div class="mb-6">
                    <div class="relative">
                        <input type="text" id="herbalSearchInput" placeholder="搜索中藥名稱、方劑名稱..." 
                               onkeyup="searchHerbalItems()" 
                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <!-- 中藥及方劑列表 -->
                <div class="bg-white rounded-lg border border-gray-200">
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">類型</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">名稱</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">操作</th>
                                </tr>
                            </thead>
                            <tbody id="herbalItemsList">
                                <!-- 中藥及方劑列表會動態載入 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 新增中藥表單 -->
        <div id="addHerbForm" class="hidden max-w-2xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">新增中藥</h2>
                <form onsubmit="addHerb(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">中藥名稱 *</label>
                        <input type="text" id="herbName" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                    <div class="flex space-x-4 pt-4">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium">
                            儲存中藥
                        </button>
                        <button type="button" onclick="showHerbalLibrary()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium">
                            取消
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 編輯中藥表單 -->
        <div id="editHerbForm" class="hidden max-w-2xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">編輯中藥</h2>
                <form onsubmit="updateHerb(event)" class="space-y-4">
                    <input type="hidden" id="editHerbId">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">中藥名稱 *</label>
                        <input type="text" id="editHerbName" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="flex space-x-4 pt-4">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium">
                            更新中藥
                        </button>
                        <button type="button" onclick="showHerbalLibrary()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium">
                            取消
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 新增方劑表單 -->
        <div id="addFormulaForm" class="hidden max-w-4xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">新增方劑</h2>
                <form onsubmit="addFormula(event)" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">方劑名稱 *</label>
                            <input type="text" id="formulaName" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">出處</label>
                            <input type="text" id="formulaSource" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="如：《傷寒論》">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">組成 *</label>
                            
                            <!-- 中藥搜尋和添加 -->
                            <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                                <div class="flex items-center space-x-2 mb-3">
                                    <div class="relative flex-1">
                                        <input type="text" id="herbSearchInput" placeholder="搜尋中藥名稱..." 
                                               oninput="searchHerbsForFormula()" 
                                               onfocus="showHerbSearchResults()"
                                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                            </svg>
                                        </div>
                                        
                                        <!-- 搜尋結果下拉選單 -->
                                        <div id="herbSearchResults" class="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-40 overflow-y-auto z-10 hidden">
                                            <div id="herbSearchResultsList" class="py-1">
                                                <!-- 搜尋結果會動態載入 -->
                                            </div>
                                        </div>
                                    </div>
                                    <input type="number" id="herbDosageInput" placeholder="劑量(g)" min="0.1" step="0.1" 
                                           class="w-24 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <button type="button" onclick="addHerbToFormula()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">
                                        添加
                                    </button>
                                </div>
                                
                                <!-- 已選中藥顯示 -->
                                <div id="selectedHerbsDisplay" class="space-y-2">
                                    <!-- 已選中藥會動態顯示 -->
                                </div>
                            </div>
                            
                            <!-- 最終組成文字 -->
                            <textarea id="formulaComposition" rows="3" required readonly 
                                      class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                      placeholder="請使用上方搜尋功能添加中藥..."></textarea>
                            <p class="text-xs text-gray-500 mt-1">💡 使用上方搜尋功能添加中藥，系統會自動生成組成文字</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">注意事項</label>
                            <input type="text" id="formulaPrecautions" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="禁忌或注意事項">
                        </div>
                    </div>
                    <div class="flex space-x-4 pt-4">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium">
                            儲存方劑
                        </button>
                        <button type="button" onclick="showHerbalLibrary()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium">
                            取消
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 編輯方劑表單 -->
        <div id="editFormulaForm" class="hidden max-w-4xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">編輯方劑</h2>
                <form onsubmit="updateFormula(event)" class="space-y-4">
                    <input type="hidden" id="editFormulaId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">方劑名稱 *</label>
                            <input type="text" id="editFormulaName" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">出處</label>
                            <input type="text" id="editFormulaSource" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="如：《傷寒論》">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">組成 *</label>
                            
                            <!-- 中藥搜尋和添加 -->
                            <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                                <div class="flex items-center space-x-2 mb-3">
                                    <div class="relative flex-1">
                                        <input type="text" id="editHerbSearchInput" placeholder="搜尋中藥名稱..." 
                                               oninput="searchHerbsForEditFormula()" 
                                               onfocus="showEditHerbSearchResults()"
                                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                            </svg>
                                        </div>
                                        
                                        <!-- 搜尋結果下拉選單 -->
                                        <div id="editHerbSearchResults" class="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-40 overflow-y-auto z-10 hidden">
                                            <div id="editHerbSearchResultsList" class="py-1">
                                                <!-- 搜尋結果會動態載入 -->
                                            </div>
                                        </div>
                                    </div>
                                    <input type="number" id="editHerbDosageInput" placeholder="劑量(g)" min="0.1" step="0.1" 
                                           class="w-24 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                    <button type="button" onclick="addHerbToEditFormula()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">
                                        添加
                                    </button>
                                </div>
                                
                                <!-- 已選中藥顯示 -->
                                <div id="editSelectedHerbsDisplay" class="space-y-2">
                                    <!-- 已選中藥會動態顯示 -->
                                </div>
                            </div>
                            
                            <!-- 最終組成文字 -->
                            <textarea id="editFormulaComposition" rows="3" required readonly 
                                      class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-50 focus:ring-2 focus:ring-orange-500 focus:border-transparent" 
                                      placeholder="請使用上方搜尋功能添加中藥..."></textarea>
                            <p class="text-xs text-gray-500 mt-1">💡 使用上方搜尋功能添加中藥，系統會自動生成組成文字</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">注意事項</label>
                            <input type="text" id="editFormulaPrecautions" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="禁忌或注意事項">
                        </div>
                    </div>
                    <div class="flex space-x-4 pt-4">
                        <button type="submit" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-lg font-medium">
                            更新方劑
                        </button>
                        <button type="button" onclick="showHerbalLibrary()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium">
                            取消
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 病歷填寫頁面 -->
        <div id="medicalRecordForm" class="hidden max-w-4xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">📋 病歷填寫</h2>
                        <div id="currentPatientInfo" class="text-sm text-gray-600 mt-1">
                            <!-- 病人資訊會動態載入 -->
                        </div>
                    </div>
                    <button onclick="showConsultationSystem()" class="text-gray-600 hover:text-gray-800">← 返回診症系統</button>
                </div>
                
                <form onsubmit="saveMedicalRecord(event)" class="space-y-6">
                    <input type="hidden" id="recordPatientId">
                    <input type="hidden" id="recordAppointmentId">
                    
                    <!-- 基本資訊 -->
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-blue-800 mb-4">基本資訊</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">診症日期 *</label>
                                <input type="date" id="consultationDate" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">診症時間 *</label>
                                <input type="time" id="consultationTime" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">主診醫師 *</label>
                                <input type="text" id="consultingDoctor" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" value="李中醫師" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 主訴 -->
                    <div class="bg-green-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-green-800 mb-4">主訴 (Chief Complaint)</h3>
                        <textarea id="chiefComplaint" rows="3" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="病人主要症狀及持續時間，如：頭痛3天，伴隨噁心嘔吐..."></textarea>
                    </div>
                    
                    <!-- 現病史 -->
                    <div class="bg-amber-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-amber-800 mb-4">現病史 (Present Illness)</h3>
                        <textarea id="presentIllness" rows="4" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-amber-500 focus:border-transparent" placeholder="詳細描述病情發展過程、症狀變化、相關檢查結果等..."></textarea>
                    </div>
                    
                    <!-- 既往史 -->
                    <div class="bg-purple-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-purple-800 mb-4">既往史 (Past History)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">過往疾病史</label>
                                <textarea id="pastMedicalHistory" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="高血壓、糖尿病、手術史等..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">藥物過敏史</label>
                                <textarea id="allergyHistory" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="對特定藥物或食物的過敏反應..."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 中醫四診 -->
                    <div class="bg-red-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-red-800 mb-4">中醫四診</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">望診 (Inspection)</label>
                                <textarea id="inspection" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="面色、神態、舌象等..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">聞診 (Auscultation & Olfaction)</label>
                                <textarea id="auscultation" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="聲音、氣味等..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">問診 (Inquiry)</label>
                                <textarea id="inquiry" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="寒熱、汗出、飲食、睡眠、二便等..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">切診 (Palpation)</label>
                                <textarea id="palpation" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="脈象、按診等..."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 中醫診斷 -->
                    <div class="bg-indigo-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-indigo-800 mb-4">中醫診斷</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">病名診斷 *</label>
                                <input type="text" id="tcmDiagnosis" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="如：頭痛、胃脘痛等...">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">證型診斷 *</label>
                                <input type="text" id="syndromePattern" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="如：肝陽上亢證、脾胃虛寒證等...">
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">診斷依據</label>
                            <textarea id="diagnosisBasis" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="根據四診資料分析診斷依據..."></textarea>
                        </div>
                    </div>
                    
                    <!-- 治療方案 -->
                    <div class="bg-teal-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-teal-800 mb-4">治療方案</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">治法 *</label>
                                <input type="text" id="treatmentPrinciple" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 focus:border-transparent" placeholder="如：平肝潛陽、溫中健脾等...">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">方劑名稱</label>
                                <input type="text" id="prescriptionName" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 focus:border-transparent" placeholder="如：天麻鉤藤飲加減、理中湯加減等...">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">處方內容 *</label>
                                <textarea id="prescriptionContent" rows="5" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 focus:border-transparent" placeholder="詳細藥物組成及劑量，如：&#10;天麻 10g&#10;鉤藤 15g&#10;石決明 30g&#10;..."></textarea>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">服用方法 *</label>
                                    <input type="text" id="dosageInstructions" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 focus:border-transparent" placeholder="如：水煎服，日二次，飯後溫服">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">療程</label>
                                    <input type="text" id="treatmentDuration" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 focus:border-transparent" placeholder="如：7劑，一週後複診">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 醫囑及注意事項 -->
                    <div class="bg-orange-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-orange-800 mb-4">醫囑及注意事項</h3>
                        <textarea id="medicalAdvice" rows="4" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="飲食宜忌、生活調理、複診時間等注意事項..."></textarea>
                    </div>
                    
                    <!-- 操作按鈕 -->
                    <div class="flex space-x-4 pt-6 border-t border-gray-200">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-medium text-lg">
                            儲存病歷
                        </button>
                        <button type="button" onclick="saveDraftRecord()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium">
                            儲存草稿
                        </button>
                        <button type="button" onclick="showConsultationSystem()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium">
                            取消
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 系統管理 -->
        <div id="systemManagement" class="hidden max-w-7xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">系統管理</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg p-6 text-white">
                        <h3 class="text-lg font-semibold mb-2">用戶管理</h3>
                        <p class="text-blue-100 mb-4">管理系統用戶權限</p>
                        <button onclick="showFeatureModal('用戶管理功能：此功能可以新增、編輯、刪除系統用戶，並設定不同的權限等級。')" class="bg-white text-blue-600 px-4 py-2 rounded font-medium hover:bg-blue-50">
                            管理用戶
                        </button>
                    </div>
                    
                    <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg p-6 text-white">
                        <h3 class="text-lg font-semibold mb-2">數據統計</h3>
                        <p class="text-green-100 mb-4">查看診所營運數據</p>
                        <button onclick="showStatistics()" class="bg-white text-green-600 px-4 py-2 rounded font-medium hover:bg-green-50">
                            查看統計
                        </button>
                    </div>
                    
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg p-6 text-white">
                        <h3 class="text-lg font-semibold mb-2">系統設定</h3>
                        <p class="text-purple-100 mb-4">調整系統參數</p>
                        <button onclick="showFeatureModal('系統設定功能：此功能可以調整系統參數、備份資料、設定診所基本資訊等。')" class="bg-white text-purple-600 px-4 py-2 rounded font-medium hover:bg-purple-50">
                            系統設定
                        </button>
                    </div>
                </div>
            </div>
        </div>



        <!-- 病人病歷記錄頁面 -->
        <div id="patientMedicalRecords" class="hidden max-w-7xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">📋 病歷記錄</h2>
                        <p id="currentPatientName" class="text-sm text-gray-600 mt-1"></p>
                    </div>
                    <button onclick="showPatientManagement()" class="text-gray-600 hover:text-gray-800">← 返回病人管理</button>
                </div>
                
                <!-- 搜索和篩選功能 -->
                <div class="mb-6 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <input type="date" id="patientRecordDateFrom" 
                                   onchange="filterPatientMedicalRecords()" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                   placeholder="開始日期">
                        </div>
                        <div>
                            <input type="date" id="patientRecordDateTo" 
                                   onchange="filterPatientMedicalRecords()" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                   placeholder="結束日期">
                        </div>
                    </div>
                    
                    <!-- 快速篩選按鈕 -->
                    <div class="flex flex-wrap gap-2">
                        <button onclick="setPatientDateFilter('today')" class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg text-sm font-medium hover:bg-purple-200">
                            今日
                        </button>
                        <button onclick="setPatientDateFilter('week')" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium hover:bg-blue-200">
                            本週
                        </button>
                        <button onclick="setPatientDateFilter('month')" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg text-sm font-medium hover:bg-green-200">
                            本月
                        </button>
                        <button onclick="clearPatientDateFilter()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200">
                            清除篩選
                        </button>
                    </div>
                </div>
                
                <!-- 病歷列表 -->
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">診症日期</th>
                                <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">主訴</th>
                                <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">診斷</th>
                                <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">醫師</th>
                                <th class="border border-gray-200 px-4 py-3 text-left font-medium text-gray-700">操作</th>
                            </tr>
                        </thead>
                        <tbody id="patientMedicalRecordsList">
                            <!-- 病歷記錄會動態載入 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 統計頁面 -->
        <div id="statisticsPage" class="hidden max-w-7xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">診所統計數據</h2>
                    <button onclick="showSystemManagement()" class="text-gray-600 hover:text-gray-800">← 返回</button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-blue-50 rounded-lg p-6 text-center">
                        <div class="text-3xl font-bold text-blue-600" id="totalPatients">0</div>
                        <div class="text-gray-600 mt-2">總病人數</div>
                    </div>
                    <div class="bg-green-50 rounded-lg p-6 text-center">
                        <div class="text-3xl font-bold text-green-600" id="totalConsultations">0</div>
                        <div class="text-gray-600 mt-2">總診症次數</div>
                    </div>
                    <div class="bg-yellow-50 rounded-lg p-6 text-center">
                        <div class="text-3xl font-bold text-yellow-600" id="todayConsultations">0</div>
                        <div class="text-gray-600 mt-2">今日診症</div>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-6 text-center">
                        <div class="text-3xl font-bold text-purple-600" id="activeUsers">3</div>
                        <div class="text-gray-600 mt-2">系統用戶</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 浮動視窗 -->
    <!-- 病人詳情視窗 -->
    <div id="patientDetailModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto fade-in">
            <div class="bg-blue-600 text-white p-6 rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">👤 病人詳情</h3>
                    <button onclick="closeModal('patientDetailModal')" class="text-white hover:text-blue-200 text-2xl">×</button>
                </div>
            </div>
            <div class="p-6">
                <div id="patientDetailContent" class="space-y-4">
                    <!-- 病人詳情內容會動態載入 -->
                </div>
                <div class="flex justify-end mt-6">
                    <button onclick="closeModal('patientDetailModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium">
                        關閉
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 中藥詳情視窗 -->
    <div id="herbDetailModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto fade-in">
            <div class="bg-amber-600 text-white p-6 rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">🌿 中藥詳情</h3>
                    <button onclick="closeModal('herbDetailModal')" class="text-white hover:text-amber-200 text-2xl">×</button>
                </div>
            </div>
            <div class="p-6">
                <div id="herbDetailContent" class="space-y-4">
                    <!-- 中藥詳情內容會動態載入 -->
                </div>
                <div class="flex justify-end mt-6">
                    <button onclick="closeModal('herbDetailModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium">
                        關閉
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 方劑詳情視窗 -->
    <div id="formulaDetailModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto fade-in">
            <div class="bg-blue-600 text-white p-6 rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">📜 方劑詳情</h3>
                    <button onclick="closeModal('formulaDetailModal')" class="text-white hover:text-blue-200 text-2xl">×</button>
                </div>
            </div>
            <div class="p-6">
                <div id="formulaDetailContent" class="space-y-4">
                    <!-- 方劑詳情內容會動態載入 -->
                </div>
                <div class="flex justify-end mt-6">
                    <button onclick="closeModal('formulaDetailModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium">
                        關閉
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 浮動通知 -->
    <div id="floatingNotification" class="fixed top-4 right-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-2xl border-l-4 p-4 max-w-sm transform translate-x-full transition-transform duration-300 ease-out">
            <div class="flex items-start">
                <div id="notificationIcon" class="flex-shrink-0 w-6 h-6 mr-3 mt-0.5"></div>
                <div class="flex-1">
                    <p id="notificationMessage" class="text-sm text-gray-800 font-medium"></p>
                </div>
                <button onclick="hideNotification()" class="flex-shrink-0 ml-2 text-gray-400 hover:text-gray-600">
                    <span class="text-lg">×</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 確認刪除視窗 -->
    <div id="confirmDeleteModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full fade-in">
            <div class="bg-red-600 text-white p-6 rounded-t-2xl text-center">
                <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-3xl">⚠️</span>
                </div>
                <h3 class="text-xl font-bold">確認刪除</h3>
            </div>
            <div class="p-6 text-center">
                <p class="text-gray-700 mb-6">確定要刪除此項目嗎？<br>此操作無法復原。</p>
                <div class="flex space-x-4">
                    <button onclick="closeModal('confirmDeleteModal')" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg font-medium">
                        取消
                    </button>
                    <button id="confirmDeleteBtn" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg font-medium">
                        確定刪除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 撤回確認視窗 -->
    <div id="withdrawModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full fade-in">
            <div class="bg-orange-600 text-white p-6 rounded-t-2xl text-center">
                <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-3xl">↩️</span>
                </div>
                <h3 class="text-xl font-bold">確認撤回掛號</h3>
            </div>
            <div class="p-6">
                <div id="withdrawInfo" class="bg-orange-50 rounded-lg p-4 mb-6">
                    <!-- 撤回資訊會動態載入 -->
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                    <div class="flex items-start">
                        <span class="text-yellow-600 text-lg mr-2">⚠️</span>
                        <div class="text-sm text-yellow-800">
                            <p class="font-medium mb-1">撤回說明：</p>
                            <ul class="list-disc list-inside space-y-1 text-xs">
                                <li>撤回後狀態將重置為「已掛號」</li>
                                <li>如有填寫的病歷草稿將被保留</li>
                                <li>操作記錄將被完整保存</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="flex space-x-4">
                    <button onclick="closeModal('withdrawModal')" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 px-4 rounded-lg font-medium">
                        取消
                    </button>
                    <button id="confirmWithdrawBtn" class="flex-1 bg-orange-600 hover:bg-orange-700 text-white py-3 px-4 rounded-lg font-medium">
                        確認撤回
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 病歷詳情視窗 -->
    <div id="medicalRecordDetailModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto fade-in">
            <div class="bg-blue-600 text-white p-6 rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">📋 病歷詳情</h3>
                    <button onclick="closeModal('medicalRecordDetailModal')" class="text-white hover:text-blue-200 text-2xl">×</button>
                </div>
            </div>
            <div class="p-6">
                <div id="medicalRecordDetailContent" class="space-y-6">
                    <!-- 病歷詳情內容會動態載入 -->
                </div>
                <div class="flex justify-end mt-6 pt-6 border-t border-gray-200">
                    <button onclick="closeModal('medicalRecordDetailModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium">
                        關閉
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 編輯中藥視窗 -->
    <div id="editHerbModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full fade-in">
            <div class="bg-green-600 text-white p-6 rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">🌿 編輯中藥</h3>
                    <button onclick="closeModal('editHerbModal')" class="text-white hover:text-green-200 text-2xl">×</button>
                </div>
            </div>
            <div class="p-6">
                <form onsubmit="updateHerbModal(event)" class="space-y-4">
                    <input type="hidden" id="modalEditHerbId">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">中藥名稱 *</label>
                        <input type="text" id="modalEditHerbName" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                    <div class="flex space-x-4 pt-4">
                        <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium">
                            更新中藥
                        </button>
                        <button type="button" onclick="closeModal('editHerbModal')" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium">
                            取消
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 編輯方劑視窗 -->
    <div id="editFormulaModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto fade-in">
            <div class="bg-blue-600 text-white p-6 rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">📜 編輯方劑</h3>
                    <button onclick="closeModal('editFormulaModal')" class="text-white hover:text-blue-200 text-2xl">×</button>
                </div>
            </div>
            <div class="p-6">
                <form onsubmit="updateFormulaModal(event)" class="space-y-4">
                    <input type="hidden" id="modalEditFormulaId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">方劑名稱 *</label>
                            <input type="text" id="modalEditFormulaName" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">出處</label>
                            <input type="text" id="modalEditFormulaSource" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="如：《傷寒論》">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">組成 *</label>
                            
                            <!-- 中藥搜尋和添加 -->
                            <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                                <div class="flex items-center space-x-2 mb-3">
                                    <div class="relative flex-1">
                                        <input type="text" id="modalEditHerbSearchInput" placeholder="搜尋中藥名稱..." 
                                               oninput="searchHerbsForModalEditFormula()" 
                                               onfocus="showModalEditHerbSearchResults()"
                                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                            </svg>
                                        </div>
                                        
                                        <!-- 搜尋結果下拉選單 -->
                                        <div id="modalEditHerbSearchResults" class="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-40 overflow-y-auto z-10 hidden">
                                            <div id="modalEditHerbSearchResultsList" class="py-1">
                                                <!-- 搜尋結果會動態載入 -->
                                            </div>
                                        </div>
                                    </div>
                                    <input type="number" id="modalEditHerbDosageInput" placeholder="劑量(g)" min="0.1" step="0.1" 
                                           class="w-24 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <button type="button" onclick="addHerbToModalEditFormula()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">
                                        添加
                                    </button>
                                </div>
                                
                                <!-- 已選中藥顯示 -->
                                <div id="modalEditSelectedHerbsDisplay" class="space-y-2">
                                    <!-- 已選中藥會動態顯示 -->
                                </div>
                            </div>
                            
                            <!-- 最終組成文字 -->
                            <textarea id="modalEditFormulaComposition" rows="3" required readonly 
                                      class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                      placeholder="請使用上方搜尋功能添加中藥..."></textarea>
                            <p class="text-xs text-gray-500 mt-1">💡 使用上方搜尋功能添加中藥，系統會自動生成組成文字</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">注意事項</label>
                            <input type="text" id="modalEditFormulaPrecautions" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="禁忌或注意事項">
                        </div>
                    </div>
                    <div class="flex space-x-4 pt-4">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium">
                            更新方劑
                        </button>
                        <button type="button" onclick="closeModal('editFormulaModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium">
                            取消
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 功能說明視窗 -->
    <div id="featureModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full fade-in">
            <div class="bg-purple-600 text-white p-6 rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">🔧 功能說明</h3>
                    <button onclick="closeModal('featureModal')" class="text-white hover:text-purple-200 text-2xl">×</button>
                </div>
            </div>
            <div class="p-6">
                <div class="text-center mb-4">
                    <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-3xl">⚙️</span>
                    </div>
                </div>
                <p id="featureMessage" class="text-gray-700 text-center mb-6"></p>
                <div class="flex justify-center">
                    <button onclick="closeModal('featureModal')" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-medium">
                        了解
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 系統數據
        let currentUser = null;
        let patients = [
            { id: 1, patientNumber: 'P001', name: '王小明', gender: '男', birthDate: '1988-05-15', phone: '0912-345-678', address: '台北市信義區', idNumber: 'A123456789' },
            { id: 2, patientNumber: 'P002', name: '李小華', gender: '女', birthDate: '1995-08-22', phone: '0923-456-789', address: '台北市大安區', idNumber: 'B234567890' },
            { id: 3, patientNumber: 'P003', name: '張大同', gender: '男', birthDate: '1978-12-03', phone: '0934-567-890', address: '新北市板橋區', idNumber: 'C345678901' }
        ];
        let appointments = []; // 掛號記錄
        let patientStatus = {}; // 病人診症狀態
        let consultations = [];
        let nextPatientId = 4;

        // 中藥庫數據
        let herbs = [
            {
                id: 1,
                name: '甘草'
            },
            {
                id: 2,
                name: '人參'
            },
            {
                id: 3,
                name: '當歸'
            }
        ];
        let nextHerbId = 4;

        // 方劑庫數據
        let formulas = [
            {
                id: 1,
                name: '四君子湯',
                source: '《太平惠民和劑局方》',
                composition: '人參9g，白朮9g，茯苓9g，甘草6g',
                precautions: '陰虛火旺或實熱證忌用'
            },
            {
                id: 2,
                name: '四物湯',
                source: '《太平惠民和劑局方》',
                composition: '當歸10g，川芎8g，白芍12g，熟地黃12g',
                precautions: '陰虛有熱、血崩氣脫者忌用'
            },
            {
                id: 3,
                name: '逍遙散',
                source: '《太平惠民和劑局方》',
                composition: '柴胡8g，當歸10g，白芍12g，白朮10g，茯苓12g，甘草6g，薄荷3g，生薑3片',
                precautions: '陰虛火旺者慎用'
            }
        ];
        let nextFormulaId = 4;

        let currentFilter = 'all';
        
        // 方劑組成管理
        let selectedHerbsForFormula = []; // 儲存選中的中藥和劑量
        let selectedHerbsForEditFormula = []; // 編輯方劑時儲存選中的中藥和劑量
        let selectedHerbsForModalEditFormula = []; // 視窗編輯方劑時儲存選中的中藥和劑量
        
        // 病歷記錄
        let medicalRecords = [];
        let nextRecordId = 1;

        // 計算年齡函數
        function calculateAge(birthDate) {
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            
            return age;
        }

        // 用戶權限設定
        const userPermissions = {
            admin: ['patientManagement', 'consultationSystem', 'herbalLibrary', 'systemManagement'],
            doctor: ['patientManagement', 'consultationSystem', 'herbalLibrary', 'systemManagement'],
            assistant: ['patientManagement', 'consultationSystem', 'herbalLibrary', 'systemManagement']
        };

        const userNames = {
            admin: '管理員',
            doctor: '醫師',
            assistant: '診所助理'
        };

        // 登入功能
        function login(userType) {
            currentUser = userType;
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainSystem').classList.remove('hidden');
            document.getElementById('userRole').textContent = userNames[userType];
            document.getElementById('sidebarUserRole').textContent = userNames[userType];
            loadSidebarMenu();
            showWelcome(); // 預設顯示歡迎頁面
        }

        // 登出功能
        function logout() {
            currentUser = null;
            document.getElementById('mainSystem').classList.add('hidden');
            document.getElementById('loginPage').classList.remove('hidden');
            closeSidebar();
            hideAllPages();
        }

        // 開啟側邊選單
        function openSidebar() {
            document.getElementById('sidebar').classList.remove('-translate-x-full');
            document.getElementById('sidebarOverlay').classList.remove('hidden');
        }

        // 關閉側邊選單
        function closeSidebar() {
            document.getElementById('sidebar').classList.add('-translate-x-full');
            document.getElementById('sidebarOverlay').classList.add('hidden');
        }

        // 載入側邊選單
        function loadSidebarMenu() {
            const menuContainer = document.getElementById('sidebarMenu');
            const permissions = userPermissions[currentUser];
            
            const menuItems = {
                patientManagement: {
                    title: '病人資料管理',
                    desc: '新增、查看、編輯病人資料',
                    action: 'showPatientManagement()'
                },
                consultationSystem: {
                    title: '診症系統',
                    desc: '進行診症、開立處方',
                    action: 'showConsultationSystem()'
                },
                herbalLibrary: {
                    title: '中藥及方劑庫',
                    desc: '查看中藥資訊及方劑',
                    action: 'showHerbalLibrary()'
                },

                systemManagement: {
                    title: '系統管理',
                    desc: '用戶管理、數據統計',
                    action: 'showSystemManagement()'
                }
            };

            menuContainer.innerHTML = permissions.map(permission => {
                const item = menuItems[permission];
                return `
                    <div class="px-4 mb-2">
                        <button onclick="${item.action}; closeSidebar();" class="w-full text-left p-4 rounded-lg hover:bg-gray-100 transition-colors group">
                            <div class="font-medium text-gray-800 group-hover:text-green-600">${item.title}</div>
                            <div class="text-sm text-gray-500 mt-1">${item.desc}</div>
                        </button>
                    </div>
                `;
            }).join('');
        }

        // 顯示歡迎頁面
        function showWelcome() {
            hideAllPages();
            document.getElementById('welcomeMessage').classList.remove('hidden');
        }

        // 隱藏所有頁面
        function hideAllPages() {
            const pages = ['welcomeMessage', 'patientManagement', 'addPatientForm', 'editPatientForm', 'consultationSystem', 'appointmentForm', 'medicalRecordForm', 'herbalLibrary', 'addHerbForm', 'editHerbForm', 'addFormulaForm', 'editFormulaForm', 'patientMedicalRecords', 'systemManagement', 'statisticsPage'];
            pages.forEach(page => {
                document.getElementById(page).classList.add('hidden');
            });
        }

        // 顯示病人管理
        function showPatientManagement() {
            hideAllPages();
            document.getElementById('patientManagement').classList.remove('hidden');
            document.getElementById('patientSearchInput').value = '';
            loadPatientList();
        }

        // 載入病人列表
        function loadPatientList(filteredPatients = null) {
            const tbody = document.getElementById('patientList');
            const patientsToShow = filteredPatients || patients;
            
            if (patientsToShow.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="border border-gray-200 px-4 py-8 text-center text-gray-500">
                            ${filteredPatients ? '沒有找到符合條件的病人' : '暫無病人資料'}
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = patientsToShow.map(patient => `
                <tr class="hover:bg-gray-50">
                    <td class="border border-gray-200 px-4 py-3 font-mono text-blue-600">${patient.patientNumber}</td>
                    <td class="border border-gray-200 px-4 py-3">${patient.name}</td>
                    <td class="border border-gray-200 px-4 py-3">${patient.gender}</td>
                    <td class="border border-gray-200 px-4 py-3">${calculateAge(patient.birthDate)}</td>
                    <td class="border border-gray-200 px-4 py-3">${patient.phone}</td>
                    <td class="border border-gray-200 px-4 py-3">
                        <button onclick="viewPatient(${patient.id})" class="text-blue-600 hover:text-blue-800 mr-2">查看</button>
                        <button onclick="viewPatientMedicalRecords(${patient.id})" class="text-purple-600 hover:text-purple-800 mr-2">病歷記錄</button>
                        <button onclick="editPatient(${patient.id})" class="text-green-600 hover:text-green-800 mr-2">編輯</button>
                        <button onclick="deletePatient(${patient.id})" class="text-red-600 hover:text-red-800">刪除</button>
                    </td>
                </tr>
            `).join('');
        }

        // 搜索病人功能
        function searchPatients() {
            const searchTerm = document.getElementById('patientSearchInput').value.toLowerCase().trim();
            
            if (searchTerm === '') {
                loadPatientList();
                return;
            }
            
            const filteredPatients = patients.filter(patient => 
                patient.name.toLowerCase().includes(searchTerm) ||
                patient.phone.includes(searchTerm) ||
                patient.gender.includes(searchTerm) ||
                patient.patientNumber.toLowerCase().includes(searchTerm) ||
                calculateAge(patient.birthDate).toString().includes(searchTerm)
            );
            
            loadPatientList(filteredPatients);
        }

        // 顯示新增病人表單
        function showAddPatientForm() {
            hideAllPages();
            document.getElementById('addPatientForm').classList.remove('hidden');
            // 清空表單
            document.getElementById('patientName').value = '';
            document.getElementById('patientIdNumber').value = '';
            document.getElementById('patientGender').value = '';
            document.getElementById('patientBirthDate').value = '';
            document.getElementById('patientPhone').value = '';
            document.getElementById('patientAddress').value = '';
        }

        // 新增病人
        function addPatient(event) {
            event.preventDefault();
            
            const newPatient = {
                id: nextPatientId++,
                patientNumber: 'P' + (nextPatientId - 1).toString().padStart(3, '0'),
                name: document.getElementById('patientName').value,
                idNumber: document.getElementById('patientIdNumber').value.toUpperCase(),
                gender: document.getElementById('patientGender').value,
                birthDate: document.getElementById('patientBirthDate').value,
                phone: document.getElementById('patientPhone').value,
                address: document.getElementById('patientAddress').value
            };
            
            patients.push(newPatient);
            showNotification('病人資料新增成功！病人編號：' + newPatient.patientNumber);
            showPatientManagement();
        }

        // 查看病人詳情
        function viewPatient(id) {
            const patient = patients.find(p => p.id === id);
            if (patient) {
                const content = `
                    <div class="space-y-3">
                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                            <span class="font-medium text-gray-600">病人編號：</span>
                            <span class="text-blue-600 font-mono font-bold">${patient.patientNumber}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                            <span class="font-medium text-gray-600">姓名：</span>
                            <span class="text-gray-800">${patient.name}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                            <span class="font-medium text-gray-600">身份證：</span>
                            <span class="text-gray-800">${patient.idNumber}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                            <span class="font-medium text-gray-600">性別：</span>
                            <span class="text-gray-800">${patient.gender}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                            <span class="font-medium text-gray-600">出生日期：</span>
                            <span class="text-gray-800">${patient.birthDate}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                            <span class="font-medium text-gray-600">年齡：</span>
                            <span class="text-gray-800">${calculateAge(patient.birthDate)} 歲</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                            <span class="font-medium text-gray-600">電話：</span>
                            <span class="text-gray-800">${patient.phone}</span>
                        </div>
                        <div class="py-2">
                            <span class="font-medium text-gray-600">地址：</span>
                            <div class="text-gray-800 mt-1">${patient.address || '未填寫'}</div>
                        </div>
                    </div>
                `;
                document.getElementById('patientDetailContent').innerHTML = content;
                showModal('patientDetailModal');
            }
        }

        // 編輯病人（僅管理員）
        function editPatient(id) {
            const patient = patients.find(p => p.id === id);
            if (patient) {
                hideAllPages();
                document.getElementById('editPatientForm').classList.remove('hidden');
                
                // 填入現有資料
                document.getElementById('editPatientId').value = patient.id;
                document.getElementById('editPatientName').value = patient.name;
                document.getElementById('editPatientIdNumber').value = patient.idNumber;
                document.getElementById('editPatientGender').value = patient.gender;
                document.getElementById('editPatientBirthDate').value = patient.birthDate;
                document.getElementById('editPatientPhone').value = patient.phone;
                document.getElementById('editPatientAddress').value = patient.address || '';
            }
        }

        // 更新病人資料
        function updatePatient(event) {
            event.preventDefault();
            
            const patientId = parseInt(document.getElementById('editPatientId').value);
            const patientIndex = patients.findIndex(p => p.id === patientId);
            
            if (patientIndex !== -1) {
                patients[patientIndex] = {
                    id: patientId,
                    patientNumber: patients[patientIndex].patientNumber, // 保留原編號
                    name: document.getElementById('editPatientName').value,
                    idNumber: document.getElementById('editPatientIdNumber').value.toUpperCase(),
                    gender: document.getElementById('editPatientGender').value,
                    birthDate: document.getElementById('editPatientBirthDate').value,
                    phone: document.getElementById('editPatientPhone').value,
                    address: document.getElementById('editPatientAddress').value
                };
                
                showNotification('病人資料更新成功！');
                showPatientManagement();
            }
        }

        // 刪除病人（僅管理員）
        function deletePatient(id) {
            document.getElementById('confirmDeleteBtn').onclick = function() {
                patients = patients.filter(p => p.id !== id);
                loadPatientList();
                closeModal('confirmDeleteModal');
                showNotification('病人資料已刪除');
            };
            showModal('confirmDeleteModal');
        }

        // 顯示診症系統
        function showConsultationSystem() {
            hideAllPages();
            document.getElementById('consultationSystem').classList.remove('hidden');
            loadAppointmentList();
        }

        // 顯示掛號表單
        function showAppointmentForm() {
            hideAllPages();
            document.getElementById('appointmentForm').classList.remove('hidden');
            document.getElementById('appointmentSearchInput').value = '';
            document.getElementById('selectedPatientId').value = '';
            document.getElementById('selectedPatientInfo').classList.add('hidden');
            document.getElementById('searchResults').classList.add('hidden');
            document.getElementById('appointmentSymptoms').value = ''; // 清空症狀描述欄位
            
            // 設定預設時間為現在
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('appointmentTime').value = now.toISOString().slice(0, 16);
        }

        // 搜索掛號病人功能
        function searchAppointmentPatients() {
            const searchTerm = document.getElementById('appointmentSearchInput').value.toLowerCase().trim();
            const searchResults = document.getElementById('searchResults');
            const searchResultsList = document.getElementById('searchResultsList');
            
            if (searchTerm === '') {
                searchResults.classList.add('hidden');
                return;
            }
            
            const filteredPatients = patients.filter(patient => 
                patient.name.toLowerCase().includes(searchTerm) ||
                patient.phone.includes(searchTerm) ||
                patient.gender.includes(searchTerm) ||
                patient.patientNumber.toLowerCase().includes(searchTerm) ||
                calculateAge(patient.birthDate).toString().includes(searchTerm)
            );
            
            if (filteredPatients.length === 0) {
                searchResultsList.innerHTML = '<div class="px-4 py-3 text-gray-500 text-sm">沒有找到符合條件的病人</div>';
            } else {
                searchResultsList.innerHTML = filteredPatients.map(patient => `
                    <div class="px-4 py-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0" 
                         onclick="selectPatient(${patient.id})">
                        <div class="font-medium text-gray-900">
                            <span class="text-blue-600 font-mono">${patient.patientNumber}</span> - ${patient.name}
                        </div>
                        <div class="text-sm text-gray-500">
                            ${patient.gender} · ${calculateAge(patient.birthDate)}歲 · ${patient.phone}
                        </div>
                    </div>
                `).join('');
            }
            
            searchResults.classList.remove('hidden');
        }

        // 顯示搜索結果
        function showSearchResults() {
            const searchTerm = document.getElementById('appointmentSearchInput').value.trim();
            if (searchTerm !== '') {
                searchAppointmentPatients();
            }
        }

        // 選擇病人
        function selectPatient(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (patient) {
                document.getElementById('selectedPatientId').value = patientId;
                document.getElementById('appointmentSearchInput').value = '';
                document.getElementById('searchResults').classList.add('hidden');
                document.getElementById('selectedPatientInfo').classList.remove('hidden');
                document.getElementById('selectedPatientDisplay').textContent = 
                    `${patient.patientNumber} - ${patient.name} (${patient.gender}, ${calculateAge(patient.birthDate)}歲)`;
            }
        }

        // 清除選中的病人
        function clearSelectedPatient() {
            document.getElementById('selectedPatientId').value = '';
            document.getElementById('selectedPatientInfo').classList.add('hidden');
            document.getElementById('appointmentSearchInput').focus();
        }

        // 新增掛號
        function addAppointment(event) {
            event.preventDefault();
            
            const patientId = parseInt(document.getElementById('selectedPatientId').value);
            if (!patientId) {
                showNotification('請先選擇病人', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === patientId);
            
            // 檢查今日是否已掛號
            const today = new Date().toDateString();
            const existingAppointment = appointments.find(apt => 
                apt.patientId === patientId && 
                new Date(apt.appointmentTime).toDateString() === today &&
                apt.status !== '已完成'
            );
            
            if (existingAppointment) {
                showNotification(`病人 ${patient.patientNumber} - ${patient.name} 今日已掛號！狀態：${existingAppointment.status}`, 'info');
                return;
            }
            
            const appointment = {
                id: appointments.length + 1,
                patientId: patientId,
                patientName: patient.name,
                patientNumber: patient.patientNumber,
                appointmentTime: document.getElementById('appointmentTime').value,
                symptoms: document.getElementById('appointmentSymptoms').value,
                status: '已掛號',
                createdAt: new Date().toISOString()
            };
            
            appointments.push(appointment);
            patientStatus[patientId] = '已掛號';
            
            showNotification(`掛號成功！病人：${patient.patientNumber} - ${patient.name}`);
            showConsultationSystem();
        }

        // 載入掛號列表
        function loadAppointmentList() {
            const tbody = document.getElementById('appointmentList');
            const today = new Date().toDateString();
            const todayAppointments = appointments.filter(apt => 
                new Date(apt.appointmentTime).toDateString() === today
            );
            
            if (todayAppointments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="border border-gray-200 px-4 py-8 text-center text-gray-500">
                            今日暫無掛號病人
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = todayAppointments.map(appointment => {
                const patient = patients.find(p => p.id === appointment.patientId);
                const appointmentDate = new Date(appointment.appointmentTime);
                const timeString = appointmentDate.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-200 px-4 py-3">${timeString}</td>
                        <td class="border border-gray-200 px-4 py-3">
                            <span class="font-mono text-blue-600 font-bold">${appointment.patientNumber || patient.patientNumber}</span>
                        </td>
                        <td class="border border-gray-200 px-4 py-3">${appointment.patientName}</td>
                        <td class="border border-gray-200 px-4 py-3">${calculateAge(patient.birthDate)}</td>
                        <td class="border border-gray-200 px-4 py-3">
                            ${getStatusBadge(appointment.status)}
                        </td>
                        <td class="border border-gray-200 px-4 py-3">
                            ${getStatusActions(appointment)}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // 獲取狀態徽章
        function getStatusBadge(status) {
            const statusConfig = {
                '已掛號': { bg: 'bg-blue-500', text: 'text-white' },
                '侯診中': { bg: 'bg-yellow-500', text: 'text-white' },
                '診症中': { bg: 'bg-green-500', text: 'text-white' },
                '已完成': { bg: 'bg-gray-500', text: 'text-white' }
            };
            
            const config = statusConfig[status] || statusConfig['已掛號'];
            return `
                <span class="px-3 py-1 rounded-full text-sm font-medium ${config.bg} ${config.text}">
                    ${status}
                </span>
            `;
        }

        // 獲取狀態操作按鈕
        function getStatusActions(appointment) {
            // 檢查是否有其他病人正在診症中
            const hasActiveConsultation = appointments.some(apt => 
                apt.status === '診症中' && apt.id !== appointment.id
            );
            
            // 檢查是否有病歷記錄（包括草稿）
            const hasRecord = medicalRecords.some(record => 
                record.appointmentId === appointment.id && 
                (record.status === 'completed' || record.status === 'draft')
            );
            
            const actions = {
                '已掛號': `
                    <div class="flex flex-col space-y-1">
                        <button onclick="updateAppointmentStatus(${appointment.id}, '侯診中')" 
                                ${hasActiveConsultation ? 'disabled' : ''} 
                                class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded-md text-xs font-medium transition-colors ${hasActiveConsultation ? 'opacity-50 cursor-not-allowed' : ''}">
                            開始侯診
                        </button>
                        <button onclick="deleteAppointment(${appointment.id})" 
                                ${hasActiveConsultation ? 'disabled' : ''} 
                                class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md text-xs font-medium transition-colors ${hasActiveConsultation ? 'opacity-50 cursor-not-allowed' : ''}">
                            刪除掛號
                        </button>
                        <button onclick="viewMedicalRecord(${appointment.id})" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded-md text-xs font-medium transition-colors">
                            ${hasRecord ? '查看病歷' : '查看病歷'}
                        </button>
                    </div>
                `,
                '侯診中': `
                    <div class="flex flex-col space-y-1">
                        <button onclick="startConsultation(${appointment.id})" 
                                ${hasActiveConsultation ? 'disabled' : ''} 
                                class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-md text-xs font-medium transition-colors ${hasActiveConsultation ? 'opacity-50 cursor-not-allowed' : ''}">
                            開始診症
                        </button>
                        <button onclick="viewMedicalRecord(${appointment.id})" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded-md text-xs font-medium transition-colors">
                            ${hasRecord ? '查看病歷' : '查看病歷'}
                        </button>
                    </div>
                `,
                '診症中': `
                    <div class="flex flex-col space-y-1">
                        <div class="bg-green-100 border border-green-300 rounded-md px-3 py-2">
                            <div class="flex items-center">
                                <div class="animate-pulse w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                                <span class="text-xs text-green-700 font-medium">診症進行中</span>
                            </div>
                        </div>
                        <button onclick="viewMedicalRecord(${appointment.id})" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded-md text-xs font-medium transition-colors">
                            ${hasRecord ? '查看病歷' : '查看病歷'}
                        </button>
                    </div>
                `,
                '已完成': `
                    <div class="flex flex-col space-y-1">
                        <button onclick="editMedicalRecord(${appointment.id})" 
                                ${hasActiveConsultation ? 'disabled' : ''} 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md text-xs font-medium transition-colors ${hasActiveConsultation ? 'opacity-50 cursor-not-allowed' : ''}">
                            修改病歷
                        </button>
                        <button onclick="withdrawAppointment(${appointment.id})" 
                                ${hasActiveConsultation ? 'disabled' : ''} 
                                class="bg-amber-500 hover:bg-amber-600 text-white px-3 py-1 rounded-md text-xs font-medium transition-colors ${hasActiveConsultation ? 'opacity-50 cursor-not-allowed' : ''}">
                            撤回掛號
                        </button>
                        <button onclick="viewMedicalRecord(${appointment.id})" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded-md text-xs font-medium transition-colors">
                            查看病歷
                        </button>
                    </div>
                `
            };
            
            return actions[appointment.status] || actions['已掛號'];
        }

        // 開始診症（展開病歷填寫）
        function startConsultation(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (appointment) {
                // 更新狀態為診症中
                updateAppointmentStatus(appointmentId, '診症中');
                
                // 在當前頁面展開病歷填寫表單
                showInlineMedicalRecordForm(appointment);
            }
        }

        // 更新掛號狀態
        function updateAppointmentStatus(appointmentId, newStatus) {
            // 檢查是否有其他病人正在診症中
            const hasActiveConsultation = appointments.some(apt => 
                apt.status === '診症中' && apt.id !== appointmentId
            );
            
            if (hasActiveConsultation && (newStatus === '侯診中' || newStatus === '診症中')) {
                showNotification('目前有其他病人正在診症中，請等待診症完成後再進行操作', 'error');
                return;
            }
            
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (appointment) {
                const oldStatus = appointment.status;
                appointment.status = newStatus;
                appointment.lastUpdated = new Date().toISOString();
                
                // 記錄狀態變更歷史
                if (!appointment.statusHistory) {
                    appointment.statusHistory = [];
                }
                appointment.statusHistory.push({
                    from: oldStatus,
                    to: newStatus,
                    timestamp: new Date().toISOString(),
                    updatedBy: currentUser
                });
                
                // 更新病人狀態
                patientStatus[appointment.patientId] = newStatus;
                
                // 顯示通知
                const patient = patients.find(p => p.id === appointment.patientId);
                showNotification(`${patient.name} 的狀態已更新為：${newStatus}`);
                
                // 重新載入列表
                loadAppointmentList();
            }
        }

        // 刪除掛號
        function deleteAppointment(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (appointment) {
                const patient = patients.find(p => p.id === appointment.patientId);
                
                if (confirm(`確定要刪除 ${patient.name} 的掛號記錄嗎？\n\n此操作將永久刪除掛號記錄，無法復原。`)) {
                    // 刪除掛號記錄
                    appointments = appointments.filter(apt => apt.id !== appointmentId);
                    
                    // 清除病人狀態
                    delete patientStatus[appointment.patientId];
                    
                    // 刪除相關的病歷草稿（如果有）
                    medicalRecords = medicalRecords.filter(record => 
                        !(record.appointmentId === appointmentId && record.status === 'draft')
                    );
                    
                    showNotification(`已刪除 ${patient.name} 的掛號記錄`, 'info');
                    loadAppointmentList();
                }
            }
        }

        // 撤回掛號
        function withdrawAppointment(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (appointment) {
                const patient = patients.find(p => p.id === appointment.patientId);
                const appointmentTime = new Date(appointment.appointmentTime);
                
                // 填入撤回資訊
                const withdrawInfo = document.getElementById('withdrawInfo');
                withdrawInfo.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="font-medium text-gray-700">病人姓名：</span>
                            <span class="text-gray-900 font-semibold">${patient.name}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="font-medium text-gray-700">病人編號：</span>
                            <span class="text-blue-600 font-mono">${patient.patientNumber}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="font-medium text-gray-700">當前狀態：</span>
                            <span class="px-2 py-1 rounded-full text-sm font-medium ${getStatusColor(appointment.status)}">${appointment.status}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="font-medium text-gray-700">掛號時間：</span>
                            <span class="text-gray-900">${appointmentTime.toLocaleString('zh-TW')}</span>
                        </div>
                        ${appointment.symptoms ? `
                        <div class="pt-2 border-t border-orange-200">
                            <span class="font-medium text-gray-700">症狀描述：</span>
                            <p class="text-gray-900 text-sm mt-1">${appointment.symptoms}</p>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                // 設定確認按鈕事件
                document.getElementById('confirmWithdrawBtn').onclick = function() {
                    // 撤回到已掛號狀態
                    const oldStatus = appointment.status;
                    appointment.status = '已掛號';
                    appointment.lastUpdated = new Date().toISOString();
                    
                    // 記錄撤回操作
                    if (!appointment.statusHistory) {
                        appointment.statusHistory = [];
                    }
                    appointment.statusHistory.push({
                        from: oldStatus,
                        to: '已掛號',
                        timestamp: new Date().toISOString(),
                        updatedBy: currentUser,
                        action: 'withdraw'
                    });
                    
                    // 更新病人狀態
                    patientStatus[appointment.patientId] = '已掛號';
                    
                    // 隱藏內嵌病歷表單（如果正在顯示）
                    const inlineForm = document.getElementById('inlineMedicalRecord');
                    if (inlineForm) {
                        inlineForm.remove();
                    }
                    
                    closeModal('withdrawModal');
                    showNotification(`已撤回 ${patient.name} 的掛號，狀態重置為「已掛號」`, 'info');
                    loadAppointmentList();
                };
                
                showModal('withdrawModal');
            }
        }
        
        // 獲取狀態顏色
        function getStatusColor(status) {
            const statusColors = {
                '已掛號': 'bg-blue-100 text-blue-800',
                '侯診中': 'bg-yellow-100 text-yellow-800',
                '診症中': 'bg-green-100 text-green-800',
                '已完成': 'bg-gray-100 text-gray-800'
            };
            return statusColors[status] || 'bg-blue-100 text-blue-800';
        }
        
        // 修改病歷功能
        function editMedicalRecord(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            const existingRecord = medicalRecords.find(record => record.appointmentId === appointmentId);
            
            if (appointment && existingRecord) {
                // 顯示內嵌編輯表單，並填入現有資料
                showInlineMedicalRecordForm(appointment, existingRecord);
            } else {
                showNotification('找不到相關的病歷記錄', 'error');
            }
        }

        // 在診症系統頁面內展開病歷填寫表單
        function showInlineMedicalRecordForm(appointment, existingRecord = null) {
            const patient = patients.find(p => p.id === appointment.patientId);
            
            // 創建內嵌病歷填寫表單
            const medicalRecordHtml = `
                <div id="inlineMedicalRecord" class="mt-6 bg-blue-50 rounded-xl p-6 border-2 border-blue-200 fade-in">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-blue-800">📋 ${existingRecord ? '修改病歷' : '病歷填寫'}</h3>
                            <p class="text-sm text-blue-600 mt-1">
                                病人：<strong>${patient.patientNumber} - ${patient.name}</strong> 
                                (${patient.gender}, ${calculateAge(patient.birthDate)}歲)
                            </p>
                            ${existingRecord ? '<p class="text-xs text-orange-600 mt-1">⚠️ 修改模式：正在編輯現有病歷</p>' : ''}
                        </div>

                    </div>
                    

                    
                    <form onsubmit="saveInlineMedicalRecord(event)" class="space-y-4">
                        <input type="hidden" id="inlineRecordPatientId" value="${appointment.patientId}">
                        <input type="hidden" id="inlineRecordAppointmentId" value="${appointment.id}">
                        
                        <!-- 簡化的病歷表單 -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">主訴 *</label>
                                <textarea id="inlineChiefComplaint" rows="2" required 
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                    placeholder="病人主要症狀...">${existingRecord ? existingRecord.chiefComplaint : (appointment.symptoms || '')}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">現病史</label>
                                <textarea id="inlinePresentIllness" rows="2" 
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                    placeholder="病情發展過程...">${existingRecord ? existingRecord.presentIllness || '' : ''}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">中醫診斷 *</label>
                                <input type="text" id="inlineTcmDiagnosis" required 
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                    placeholder="如：頭痛、胃脘痛等..." value="${existingRecord ? existingRecord.tcmDiagnosis || '' : ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">證型診斷 *</label>
                                <input type="text" id="inlineSyndromePattern" required 
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                    placeholder="如：肝陽上亢證等..." value="${existingRecord ? existingRecord.syndromePattern || '' : ''}">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">處方內容 *</label>
                            <textarea id="inlinePrescriptionContent" rows="4" required 
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                placeholder="詳細藥物組成及劑量，如：&#10;天麻 10g&#10;鉤藤 15g&#10;石決明 30g&#10;...">${existingRecord ? existingRecord.prescriptionContent || '' : ''}</textarea>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">服用方法 *</label>
                                <input type="text" id="inlineDosageInstructions" required 
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                    placeholder="如：水煎服，日二次，飯後溫服" value="${existingRecord ? existingRecord.dosageInstructions || '' : ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">療程</label>
                                <input type="text" id="inlineTreatmentDuration" 
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                    placeholder="如：7劑，一週後複診" value="${existingRecord ? existingRecord.treatmentDuration || '' : ''}">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">醫囑及注意事項</label>
                            <textarea id="inlineMedicalAdvice" rows="2" 
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                placeholder="飲食宜忌、生活調理等...">${existingRecord ? existingRecord.medicalAdvice || '' : ''}</textarea>
                        </div>
                        
                        <!-- 操作按鈕 -->
                        <div class="flex space-x-3 pt-4 border-t border-blue-200">
                            ${existingRecord ? `
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium text-sm">
                                更新病歷
                            </button>
                            ` : `
                            <button type="button" onclick="saveInlineDraft()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium text-sm">
                                儲存病歷
                            </button>
                            `}
                            <button type="button" onclick="hideInlineMedicalRecord()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium text-sm">
                                取消
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            // 將表單插入到診症系統頁面
            const consultationDiv = document.getElementById('consultationSystem').querySelector('.bg-white');
            
            // 移除現有的內嵌表單（如果有）
            const existingForm = document.getElementById('inlineMedicalRecord');
            if (existingForm) {
                existingForm.remove();
            }
            
            consultationDiv.insertAdjacentHTML('beforeend', medicalRecordHtml);
            
            // 滾動到表單位置
            setTimeout(() => {
                document.getElementById('inlineMedicalRecord').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }, 100);
        }
        
        // 清空病歷表單
        function clearMedicalRecordForm() {
            const fieldsToKeep = ['recordPatientId', 'recordAppointmentId', 'consultationDate', 'consultationTime', 'consultingDoctor', 'chiefComplaint'];
            const form = document.querySelector('#medicalRecordForm form');
            const inputs = form.querySelectorAll('input, textarea');
            
            inputs.forEach(input => {
                if (!fieldsToKeep.includes(input.id)) {
                    input.value = '';
                }
            });
        }
        
        // 儲存病歷
        function saveMedicalRecord(event) {
            event.preventDefault();
            
            // 驗證必填欄位
            const requiredFields = [
                { id: 'consultationDate', name: '診症日期' },
                { id: 'consultationTime', name: '診症時間' },
                { id: 'consultingDoctor', name: '主診醫師' },
                { id: 'chiefComplaint', name: '主訴' },
                { id: 'tcmDiagnosis', name: '中醫診斷' },
                { id: 'syndromePattern', name: '證型診斷' },
                { id: 'treatmentPrinciple', name: '治法' },
                { id: 'prescriptionContent', name: '處方內容' },
                { id: 'dosageInstructions', name: '服用方法' }
            ];
            
            const missingFields = [];
            
            // 先清除所有錯誤樣式
            requiredFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    element.classList.remove('border-red-500', 'bg-red-50');
                }
            });
            
            for (const field of requiredFields) {
                const element = document.getElementById(field.id);
                if (!element || !element.value.trim()) {
                    missingFields.push(field.name);
                    // 為缺失的欄位添加紅色邊框提示
                    if (element) {
                        element.classList.add('border-red-500', 'bg-red-50');
                        element.addEventListener('input', function() {
                            if (this.value.trim()) {
                                this.classList.remove('border-red-500', 'bg-red-50');
                            }
                        }, { once: true });
                    }
                }
            }
            
            if (missingFields.length > 0) {
                showNotification(`請填寫以下必填欄位：${missingFields.join('、')}`, 'error');
                // 滾動到第一個缺失的欄位
                const firstMissingFieldId = requiredFields.find(field => {
                    const element = document.getElementById(field.id);
                    return !element || !element.value.trim();
                })?.id;
                
                if (firstMissingFieldId) {
                    const firstMissingField = document.getElementById(firstMissingFieldId);
                    if (firstMissingField) {
                        firstMissingField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        firstMissingField.focus();
                    }
                }
                return;
            }
            
            const patientId = parseInt(document.getElementById('recordPatientId').value);
            const appointmentId = parseInt(document.getElementById('recordAppointmentId').value);
            const patient = patients.find(p => p.id === patientId);
            
            const medicalRecord = {
                id: nextRecordId++,
                patientId: patientId,
                appointmentId: appointmentId,
                patientName: patient.name,
                patientNumber: patient.patientNumber,
                consultationDate: document.getElementById('consultationDate').value,
                consultationTime: document.getElementById('consultationTime').value,
                consultingDoctor: document.getElementById('consultingDoctor').value,
                chiefComplaint: document.getElementById('chiefComplaint').value,
                presentIllness: document.getElementById('presentIllness').value,
                pastMedicalHistory: document.getElementById('pastMedicalHistory').value,
                allergyHistory: document.getElementById('allergyHistory').value,
                inspection: document.getElementById('inspection').value,
                auscultation: document.getElementById('auscultation').value,
                inquiry: document.getElementById('inquiry').value,
                palpation: document.getElementById('palpation').value,
                tcmDiagnosis: document.getElementById('tcmDiagnosis').value,
                syndromePattern: document.getElementById('syndromePattern').value,
                diagnosisBasis: document.getElementById('diagnosisBasis').value,
                treatmentPrinciple: document.getElementById('treatmentPrinciple').value,
                prescriptionName: document.getElementById('prescriptionName').value,
                prescriptionContent: document.getElementById('prescriptionContent').value,
                dosageInstructions: document.getElementById('dosageInstructions').value,
                treatmentDuration: document.getElementById('treatmentDuration').value,
                medicalAdvice: document.getElementById('medicalAdvice').value,
                createdAt: new Date().toISOString(),
                createdBy: currentUser,
                status: 'completed'
            };
            
            medicalRecords.push(medicalRecord);
            
            // 更新掛號狀態為已完成
            updateAppointmentStatus(appointmentId, '已完成');
            
            showNotification(`病歷已成功儲存！病人：${patient.name}`);
            showConsultationSystem();
        }
        
        // 隱藏內嵌病歷表單
        function hideInlineMedicalRecord() {
            const inlineForm = document.getElementById('inlineMedicalRecord');
            if (inlineForm) {
                inlineForm.remove();
            }
        }
        
        // 儲存內嵌病歷
        function saveInlineMedicalRecord(event) {
            event.preventDefault();
            
            const patientId = parseInt(document.getElementById('inlineRecordPatientId').value);
            const appointmentId = parseInt(document.getElementById('inlineRecordAppointmentId').value);
            const patient = patients.find(p => p.id === patientId);
            
            // 驗證必填欄位
            const requiredFields = [
                { id: 'inlineChiefComplaint', name: '主訴' },
                { id: 'inlineTcmDiagnosis', name: '中醫診斷' },
                { id: 'inlineSyndromePattern', name: '證型診斷' },
                { id: 'inlinePrescriptionContent', name: '處方內容' },
                { id: 'inlineDosageInstructions', name: '服用方法' }
            ];
            
            const missingFields = [];
            
            // 先清除所有錯誤樣式
            requiredFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    element.classList.remove('border-red-500', 'bg-red-50');
                }
            });
            
            for (const field of requiredFields) {
                const element = document.getElementById(field.id);
                if (!element || !element.value.trim()) {
                    missingFields.push(field.name);
                    // 為缺失的欄位添加紅色邊框提示
                    if (element) {
                        element.classList.add('border-red-500', 'bg-red-50');
                        element.addEventListener('input', function() {
                            if (this.value.trim()) {
                                this.classList.remove('border-red-500', 'bg-red-50');
                            }
                        }, { once: true });
                    }
                }
            }
            
            if (missingFields.length > 0) {
                showNotification(`請填寫以下必填欄位：${missingFields.join('、')}`, 'error');
                // 滾動到第一個缺失的欄位
                const firstMissingFieldId = requiredFields.find(field => {
                    const element = document.getElementById(field.id);
                    return !element || !element.value.trim();
                })?.id;
                
                if (firstMissingFieldId) {
                    const firstMissingField = document.getElementById(firstMissingFieldId);
                    if (firstMissingField) {
                        firstMissingField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        firstMissingField.focus();
                    }
                }
                return;
            }
            
            // 檢查是否為修改模式
            const existingRecordIndex = medicalRecords.findIndex(record => record.appointmentId === appointmentId && record.status === 'completed');
            const isEditMode = existingRecordIndex >= 0;
            
            if (isEditMode) {
                // 修改模式：更新現有病歷，保留原始資訊
                const existingRecord = medicalRecords[existingRecordIndex];
                
                // 記錄修改歷史
                if (!existingRecord.modificationHistory) {
                    existingRecord.modificationHistory = [];
                }
                
                // 保存修改前的狀態
                existingRecord.modificationHistory.push({
                    modifiedAt: new Date().toISOString(),
                    modifiedBy: currentUser,
                    changes: {
                        chiefComplaint: { from: existingRecord.chiefComplaint, to: document.getElementById('inlineChiefComplaint').value },
                        presentIllness: { from: existingRecord.presentIllness, to: document.getElementById('inlinePresentIllness').value },
                        tcmDiagnosis: { from: existingRecord.tcmDiagnosis, to: document.getElementById('inlineTcmDiagnosis').value },
                        syndromePattern: { from: existingRecord.syndromePattern, to: document.getElementById('inlineSyndromePattern').value },
                        prescriptionContent: { from: existingRecord.prescriptionContent, to: document.getElementById('inlinePrescriptionContent').value },
                        dosageInstructions: { from: existingRecord.dosageInstructions, to: document.getElementById('inlineDosageInstructions').value },
                        treatmentDuration: { from: existingRecord.treatmentDuration, to: document.getElementById('inlineTreatmentDuration').value },
                        medicalAdvice: { from: existingRecord.medicalAdvice, to: document.getElementById('inlineMedicalAdvice').value }
                    }
                });
                
                // 更新病歷內容
                existingRecord.chiefComplaint = document.getElementById('inlineChiefComplaint').value;
                existingRecord.presentIllness = document.getElementById('inlinePresentIllness').value;
                existingRecord.tcmDiagnosis = document.getElementById('inlineTcmDiagnosis').value;
                existingRecord.syndromePattern = document.getElementById('inlineSyndromePattern').value;
                existingRecord.prescriptionContent = document.getElementById('inlinePrescriptionContent').value;
                existingRecord.dosageInstructions = document.getElementById('inlineDosageInstructions').value;
                existingRecord.treatmentDuration = document.getElementById('inlineTreatmentDuration').value;
                existingRecord.medicalAdvice = document.getElementById('inlineMedicalAdvice').value;
                existingRecord.lastModified = new Date().toISOString();
                existingRecord.modifiedBy = currentUser;
                
                showNotification(`病歷已更新！病人：${patient.name}`, 'info');
            } else {
                // 新增模式：創建新病歷
                const medicalRecord = {
                    id: nextRecordId++,
                    patientId: patientId,
                    appointmentId: appointmentId,
                    patientName: patient.name,
                    patientNumber: patient.patientNumber,
                    consultationDate: new Date().toISOString().split('T')[0],
                    consultationTime: new Date().toTimeString().slice(0, 5),
                    consultingDoctor: '李中醫師',
                    chiefComplaint: document.getElementById('inlineChiefComplaint').value,
                    presentIllness: document.getElementById('inlinePresentIllness').value,
                    tcmDiagnosis: document.getElementById('inlineTcmDiagnosis').value,
                    syndromePattern: document.getElementById('inlineSyndromePattern').value,
                    prescriptionContent: document.getElementById('inlinePrescriptionContent').value,
                    dosageInstructions: document.getElementById('inlineDosageInstructions').value,
                    treatmentDuration: document.getElementById('inlineTreatmentDuration').value,
                    medicalAdvice: document.getElementById('inlineMedicalAdvice').value,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser,
                    status: 'completed'
                };
                
                medicalRecords.push(medicalRecord);
                
                // 更新掛號狀態為已完成
                updateAppointmentStatus(appointmentId, '已完成');
                showNotification(`診症完成！病歷已儲存 - 病人：${patient.name}`);
            }
            
            // 隱藏表單
            hideInlineMedicalRecord();
        }
        
        // 儲存內嵌草稿
        function saveInlineDraft() {
            const patientId = parseInt(document.getElementById('inlineRecordPatientId').value);
            const appointmentId = parseInt(document.getElementById('inlineRecordAppointmentId').value);
            const patient = patients.find(p => p.id === patientId);
            
            // 驗證必填欄位
            const requiredFields = [
                { id: 'inlineChiefComplaint', name: '主訴' },
                { id: 'inlineTcmDiagnosis', name: '中醫診斷' },
                { id: 'inlineSyndromePattern', name: '證型診斷' },
                { id: 'inlinePrescriptionContent', name: '處方內容' },
                { id: 'inlineDosageInstructions', name: '服用方法' }
            ];
            
            const missingFields = [];
            
            // 先清除所有錯誤樣式
            requiredFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    element.classList.remove('border-red-500', 'bg-red-50');
                }
            });
            
            for (const field of requiredFields) {
                const element = document.getElementById(field.id);
                if (!element || !element.value.trim()) {
                    missingFields.push(field.name);
                    // 為缺失的欄位添加紅色邊框提示
                    if (element) {
                        element.classList.add('border-red-500', 'bg-red-50');
                        element.addEventListener('input', function() {
                            if (this.value.trim()) {
                                this.classList.remove('border-red-500', 'bg-red-50');
                            }
                        }, { once: true });
                    }
                }
            }
            
            if (missingFields.length > 0) {
                showNotification(`請填寫以下必填欄位：${missingFields.join('、')}`, 'error');
                // 滾動到第一個缺失的欄位
                const firstMissingFieldId = requiredFields.find(field => {
                    const element = document.getElementById(field.id);
                    return !element || !element.value.trim();
                })?.id;
                
                if (firstMissingFieldId) {
                    const firstMissingField = document.getElementById(firstMissingFieldId);
                    if (firstMissingField) {
                        firstMissingField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        firstMissingField.focus();
                    }
                }
                return;
            }
            
            // 所有必填欄位都已填寫，完成診症
            const medicalRecord = {
                id: nextRecordId++,
                patientId: patientId,
                appointmentId: appointmentId,
                patientName: patient.name,
                patientNumber: patient.patientNumber,
                consultationDate: new Date().toISOString().split('T')[0],
                consultationTime: new Date().toTimeString().slice(0, 5),
                consultingDoctor: '李中醫師',
                chiefComplaint: document.getElementById('inlineChiefComplaint').value,
                presentIllness: document.getElementById('inlinePresentIllness').value,
                tcmDiagnosis: document.getElementById('inlineTcmDiagnosis').value,
                syndromePattern: document.getElementById('inlineSyndromePattern').value,
                prescriptionContent: document.getElementById('inlinePrescriptionContent').value,
                dosageInstructions: document.getElementById('inlineDosageInstructions').value,
                treatmentDuration: document.getElementById('inlineTreatmentDuration').value,
                medicalAdvice: document.getElementById('inlineMedicalAdvice').value,
                createdAt: new Date().toISOString(),
                createdBy: currentUser,
                status: 'completed'
            };
            
            // 刪除現有草稿（如果有）
            medicalRecords = medicalRecords.filter(record => 
                !(record.appointmentId === appointmentId && record.status === 'draft')
            );
            
            medicalRecords.push(medicalRecord);
            
            // 更新掛號狀態為已完成
            updateAppointmentStatus(appointmentId, '已完成');
            
            showNotification(`診症完成！病歷已儲存 - 病人：${patient.name}`);
            
            // 隱藏表單
            hideInlineMedicalRecord();
        }

        // 顯示中藥及方劑庫
        function showHerbalLibrary() {
            hideAllPages();
            document.getElementById('herbalLibrary').classList.remove('hidden');
            loadHerbalItems();
        }

        // 載入中藥及方劑列表
        function loadHerbalItems(filteredItems = null) {
            const tbody = document.getElementById('herbalItemsList');
            
            let itemsToShow = [];
            
            if (filteredItems) {
                itemsToShow = filteredItems;
            } else {
                if (currentFilter === 'all') {
                    itemsToShow = [
                        ...herbs.map(herb => ({...herb, type: 'herb'})),
                        ...formulas.map(formula => ({...formula, type: 'formula'}))
                    ];
                } else if (currentFilter === 'herb') {
                    itemsToShow = herbs.map(herb => ({...herb, type: 'herb'}));
                } else if (currentFilter === 'formula') {
                    itemsToShow = formulas.map(formula => ({...formula, type: 'formula'}));
                }
            }
            
            if (itemsToShow.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" class="border border-gray-200 px-4 py-8 text-center text-gray-500">
                            沒有找到符合條件的項目
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = itemsToShow.map(item => {
                const typeDisplay = item.type === 'herb' ? '🌿 中藥' : '📜 方劑';
                const typeColor = item.type === 'herb' ? 'text-green-600' : 'text-blue-600';
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-200 px-4 py-3">
                            <span class="${typeColor} font-medium">${typeDisplay}</span>
                        </td>
                        <td class="border border-gray-200 px-4 py-3">
                            <span class="font-medium text-gray-800">${item.name}</span>
                            ${item.source ? `<div class="text-sm text-gray-500">${item.source}</div>` : ''}
                        </td>
                        <td class="border border-gray-200 px-4 py-3">
                            <div class="flex space-x-2">
                                <button onclick="${item.type === 'herb' ? `viewHerbDetail(${item.id})` : `viewFormulaDetail(${item.id})`}" 
                                        class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                    查看
                                </button>
                                <button onclick="${item.type === 'herb' ? `editHerb(${item.id})` : `editFormula(${item.id})`}" 
                                        class="text-green-600 hover:text-green-800 text-sm font-medium">
                                    編輯
                                </button>
                                <button onclick="${item.type === 'herb' ? `deleteHerb(${item.id})` : `deleteFormula(${item.id})`}" 
                                        class="text-red-600 hover:text-red-800 text-sm font-medium">
                                    刪除
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // 創建中藥卡片
        function createHerbCard(herb) {
            return `
                <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-6 border border-green-200 hover:shadow-lg transition-shadow">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-bold text-green-800">${herb.name}</h3>
                            <p class="text-sm text-green-600">${herb.pinyin || ''}</p>
                        </div>
                        <span class="bg-green-600 text-white px-2 py-1 rounded-full text-xs">🌿 中藥</span>
                    </div>
                    
                    <div class="space-y-2 text-sm">
                        <div>
                            <span class="font-medium text-gray-700">性味：</span>
                            <span class="text-gray-600">${herb.nature}</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">歸經：</span>
                            <span class="text-gray-600">${herb.meridian}</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">功效：</span>
                            <span class="text-gray-600">${herb.effects.length > 50 ? herb.effects.substring(0, 50) + '...' : herb.effects}</span>
                        </div>
                        ${herb.dosage ? `
                        <div>
                            <span class="font-medium text-gray-700">用量：</span>
                            <span class="text-gray-600">${herb.dosage}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="flex space-x-2 mt-4">
                        <button onclick="viewHerbDetail(${herb.id})" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm font-medium">
                            查看詳情
                        </button>
                        <button onclick="showNotification('編輯功能開發中...', 'info')" class="bg-amber-600 hover:bg-amber-700 text-white px-3 py-2 rounded text-sm font-medium">
                            編輯
                        </button>
                        <button onclick="deleteHerb(${herb.id})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm font-medium">
                            刪除
                        </button>
                    </div>
                </div>
            `;
        }

        // 創建方劑卡片
        function createFormulaCard(formula) {
            return `
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-6 border border-blue-200 hover:shadow-lg transition-shadow">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-bold text-blue-800">${formula.name}</h3>
                            <p class="text-sm text-blue-600">${formula.source || ''}</p>
                        </div>
                        <span class="bg-blue-600 text-white px-2 py-1 rounded-full text-xs">📜 方劑</span>
                    </div>
                    
                    <div class="space-y-2 text-sm">
                        <div>
                            <span class="font-medium text-gray-700">組成：</span>
                            <span class="text-gray-600">${formula.composition.length > 50 ? formula.composition.substring(0, 50) + '...' : formula.composition}</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">功效：</span>
                            <span class="text-gray-600">${formula.effects}</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">主治：</span>
                            <span class="text-gray-600">${formula.indications.length > 50 ? formula.indications.substring(0, 50) + '...' : formula.indications}</span>
                        </div>
                    </div>
                    
                    <div class="flex space-x-2 mt-4">
                        <button onclick="viewFormulaDetail(${formula.id})" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm font-medium">
                            查看詳情
                        </button>
                        <button onclick="showNotification('編輯功能開發中...', 'info')" class="bg-amber-600 hover:bg-amber-700 text-white px-3 py-2 rounded text-sm font-medium">
                            編輯
                        </button>
                        <button onclick="deleteFormula(${formula.id})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm font-medium">
                            刪除
                        </button>
                    </div>
                </div>
            `;
        }

        // 篩選功能
        function filterHerbalItems(filter) {
            currentFilter = filter;
            
            // 更新按鈕樣式
            document.querySelectorAll('[id^="herbal-filter-"]').forEach(btn => {
                btn.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300';
            });
            document.getElementById(`herbal-filter-${filter}`).className = 'px-4 py-2 bg-amber-600 text-white rounded-lg text-sm font-medium hover:bg-amber-700';
            
            loadHerbalItems();
        }

        // 搜索功能
        function searchHerbalItems() {
            const searchTerm = document.getElementById('herbalSearchInput').value.toLowerCase().trim();
            
            if (searchTerm === '') {
                loadHerbalItems();
                return;
            }
            
            let allItems = [
                ...herbs.map(herb => ({...herb, type: 'herb'})),
                ...formulas.map(formula => ({...formula, type: 'formula'}))
            ];
            
            const filteredItems = allItems.filter(item => {
                if (item.type === 'herb') {
                    return item.name.toLowerCase().includes(searchTerm);
                } else {
                    return item.name.toLowerCase().includes(searchTerm) ||
                           (item.composition && item.composition.toLowerCase().includes(searchTerm)) ||
                           (item.source && item.source.toLowerCase().includes(searchTerm));
                }
            });
            
            loadHerbalItems(filteredItems);
        }

        // 顯示新增中藥表單
        function showAddHerbForm() {
            hideAllPages();
            document.getElementById('addHerbForm').classList.remove('hidden');
            
            // 清空表單
            document.getElementById('herbName').value = '';
        }

        // 顯示新增方劑表單
        function showAddFormulaForm() {
            hideAllPages();
            document.getElementById('addFormulaForm').classList.remove('hidden');
            
            // 清空表單
            document.getElementById('formulaName').value = '';
            document.getElementById('formulaSource').value = '';
            document.getElementById('formulaComposition').value = '';
            document.getElementById('formulaPrecautions').value = '';
            document.getElementById('herbSearchInput').value = '';
            document.getElementById('herbDosageInput').value = '';
            
            // 重置選中的中藥
            selectedHerbsForFormula = [];
            updateSelectedHerbsDisplay();
            updateFormulaCompositionText();
        }

        // 搜尋中藥功能（用於方劑組成）
        function searchHerbsForFormula() {
            const searchTerm = document.getElementById('herbSearchInput').value.toLowerCase().trim();
            const searchResults = document.getElementById('herbSearchResults');
            const searchResultsList = document.getElementById('herbSearchResultsList');
            
            if (searchTerm === '') {
                searchResults.classList.add('hidden');
                return;
            }
            
            const filteredHerbs = herbs.filter(herb => 
                herb.name.toLowerCase().includes(searchTerm)
            );
            
            if (filteredHerbs.length === 0) {
                searchResultsList.innerHTML = '<div class="px-4 py-3 text-gray-500 text-sm">沒有找到符合條件的中藥</div>';
            } else {
                searchResultsList.innerHTML = filteredHerbs.map(herb => `
                    <div class="px-4 py-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0" 
                         onclick="selectHerbForFormula('${herb.name}')">
                        <div class="font-medium text-gray-900">${herb.name}</div>
                    </div>
                `).join('');
            }
            
            searchResults.classList.remove('hidden');
        }

        // 顯示中藥搜尋結果
        function showHerbSearchResults() {
            const searchTerm = document.getElementById('herbSearchInput').value.trim();
            if (searchTerm !== '') {
                searchHerbsForFormula();
            }
        }

        // 選擇中藥（用於方劑組成）
        function selectHerbForFormula(herbName) {
            document.getElementById('herbSearchInput').value = herbName;
            document.getElementById('herbSearchResults').classList.add('hidden');
            document.getElementById('herbDosageInput').focus();
        }

        // 添加中藥到方劑組成
        function addHerbToFormula() {
            const herbName = document.getElementById('herbSearchInput').value.trim();
            const dosage = parseFloat(document.getElementById('herbDosageInput').value);
            
            if (!herbName) {
                showNotification('請選擇中藥', 'error');
                return;
            }
            
            if (!dosage || dosage <= 0) {
                showNotification('請輸入有效的劑量', 'error');
                return;
            }
            
            // 檢查中藥是否存在
            const herbExists = herbs.some(herb => herb.name === herbName);
            if (!herbExists) {
                showNotification('請從搜尋結果中選擇中藥', 'error');
                return;
            }
            
            // 檢查是否已經添加過
            const existingIndex = selectedHerbsForFormula.findIndex(item => item.name === herbName);
            if (existingIndex >= 0) {
                // 更新劑量
                selectedHerbsForFormula[existingIndex].dosage = dosage;
                showNotification(`已更新 ${herbName} 的劑量為 ${dosage}g`, 'info');
            } else {
                // 添加新中藥
                selectedHerbsForFormula.push({
                    name: herbName,
                    dosage: dosage
                });
                showNotification(`已添加 ${herbName} ${dosage}g`);
            }
            
            // 清空輸入框
            document.getElementById('herbSearchInput').value = '';
            document.getElementById('herbDosageInput').value = '';
            document.getElementById('herbSearchResults').classList.add('hidden');
            
            // 更新顯示
            updateSelectedHerbsDisplay();
            updateFormulaCompositionText();
        }

        // 更新已選中藥顯示
        function updateSelectedHerbsDisplay() {
            const container = document.getElementById('selectedHerbsDisplay');
            
            if (selectedHerbsForFormula.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">尚未添加任何中藥</p>';
                return;
            }
            
            container.innerHTML = selectedHerbsForFormula.map((herb, index) => `
                <div class="flex items-center justify-between bg-white rounded-lg p-3 border border-gray-200">
                    <div class="flex items-center space-x-3">
                        <span class="w-6 h-6 bg-green-100 text-green-600 rounded-full flex items-center justify-center text-xs font-bold">
                            ${index + 1}
                        </span>
                        <span class="font-medium text-gray-800">${herb.name}</span>
                        <span class="text-blue-600 font-mono">${herb.dosage}g</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="editHerbInFormula(${index})" class="text-blue-600 hover:text-blue-800 text-sm">
                            編輯
                        </button>
                        <button onclick="removeHerbFromFormula(${index})" class="text-red-600 hover:text-red-800 text-sm">
                            移除
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // 更新方劑組成文字
        function updateFormulaCompositionText() {
            const compositionText = selectedHerbsForFormula
                .map(herb => `${herb.name} ${herb.dosage}g`)
                .join('，');
            
            document.getElementById('formulaComposition').value = compositionText;
        }

        // 編輯方劑中的中藥
        function editHerbInFormula(index) {
            const herb = selectedHerbsForFormula[index];
            const newDosage = prompt(`請輸入 ${herb.name} 的新劑量 (g):`, herb.dosage);
            
            if (newDosage !== null) {
                const dosage = parseFloat(newDosage);
                if (dosage && dosage > 0) {
                    selectedHerbsForFormula[index].dosage = dosage;
                    updateSelectedHerbsDisplay();
                    updateFormulaCompositionText();
                    showNotification(`已更新 ${herb.name} 的劑量為 ${dosage}g`, 'info');
                } else {
                    showNotification('請輸入有效的劑量', 'error');
                }
            }
        }

        // 從方劑中移除中藥
        function removeHerbFromFormula(index) {
            const herb = selectedHerbsForFormula[index];
            if (confirm(`確定要移除 ${herb.name} 嗎？`)) {
                selectedHerbsForFormula.splice(index, 1);
                updateSelectedHerbsDisplay();
                updateFormulaCompositionText();
                showNotification(`已移除 ${herb.name}`, 'info');
            }
        }

        // 編輯方劑的搜尋中藥功能
        function searchHerbsForEditFormula() {
            const searchTerm = document.getElementById('editHerbSearchInput').value.toLowerCase().trim();
            const searchResults = document.getElementById('editHerbSearchResults');
            const searchResultsList = document.getElementById('editHerbSearchResultsList');
            
            if (searchTerm === '') {
                searchResults.classList.add('hidden');
                return;
            }
            
            const filteredHerbs = herbs.filter(herb => 
                herb.name.toLowerCase().includes(searchTerm)
            );
            
            if (filteredHerbs.length === 0) {
                searchResultsList.innerHTML = '<div class="px-4 py-3 text-gray-500 text-sm">沒有找到符合條件的中藥</div>';
            } else {
                searchResultsList.innerHTML = filteredHerbs.map(herb => `
                    <div class="px-4 py-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0" 
                         onclick="selectHerbForEditFormula('${herb.name}')">
                        <div class="font-medium text-gray-900">${herb.name}</div>
                    </div>
                `).join('');
            }
            
            searchResults.classList.remove('hidden');
        }

        // 顯示編輯方劑的中藥搜尋結果
        function showEditHerbSearchResults() {
            const searchTerm = document.getElementById('editHerbSearchInput').value.trim();
            if (searchTerm !== '') {
                searchHerbsForEditFormula();
            }
        }

        // 選擇中藥（編輯方劑用）
        function selectHerbForEditFormula(herbName) {
            document.getElementById('editHerbSearchInput').value = herbName;
            document.getElementById('editHerbSearchResults').classList.add('hidden');
            document.getElementById('editHerbDosageInput').focus();
        }

        // 添加中藥到編輯方劑組成
        function addHerbToEditFormula() {
            const herbName = document.getElementById('editHerbSearchInput').value.trim();
            const dosage = parseFloat(document.getElementById('editHerbDosageInput').value);
            
            if (!herbName) {
                showNotification('請選擇中藥', 'error');
                return;
            }
            
            if (!dosage || dosage <= 0) {
                showNotification('請輸入有效的劑量', 'error');
                return;
            }
            
            // 檢查中藥是否存在
            const herbExists = herbs.some(herb => herb.name === herbName);
            if (!herbExists) {
                showNotification('請從搜尋結果中選擇中藥', 'error');
                return;
            }
            
            // 檢查是否已經添加過
            const existingIndex = selectedHerbsForEditFormula.findIndex(item => item.name === herbName);
            if (existingIndex >= 0) {
                // 更新劑量
                selectedHerbsForEditFormula[existingIndex].dosage = dosage;
                showNotification(`已更新 ${herbName} 的劑量為 ${dosage}g`, 'info');
            } else {
                // 添加新中藥
                selectedHerbsForEditFormula.push({
                    name: herbName,
                    dosage: dosage
                });
                showNotification(`已添加 ${herbName} ${dosage}g`);
            }
            
            // 清空輸入框
            document.getElementById('editHerbSearchInput').value = '';
            document.getElementById('editHerbDosageInput').value = '';
            document.getElementById('editHerbSearchResults').classList.add('hidden');
            
            // 更新顯示
            updateEditSelectedHerbsDisplay();
            updateEditFormulaCompositionText();
        }

        // 更新編輯方劑的已選中藥顯示
        function updateEditSelectedHerbsDisplay() {
            const container = document.getElementById('editSelectedHerbsDisplay');
            
            if (selectedHerbsForEditFormula.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">尚未添加任何中藥</p>';
                return;
            }
            
            container.innerHTML = selectedHerbsForEditFormula.map((herb, index) => `
                <div class="flex items-center justify-between bg-white rounded-lg p-3 border border-gray-200">
                    <div class="flex items-center space-x-3">
                        <span class="w-6 h-6 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center text-xs font-bold">
                            ${index + 1}
                        </span>
                        <span class="font-medium text-gray-800">${herb.name}</span>
                        <span class="text-blue-600 font-mono">${herb.dosage}g</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="editHerbInEditFormula(${index})" class="text-blue-600 hover:text-blue-800 text-sm">
                            編輯
                        </button>
                        <button onclick="removeHerbFromEditFormula(${index})" class="text-red-600 hover:text-red-800 text-sm">
                            移除
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // 更新編輯方劑的組成文字
        function updateEditFormulaCompositionText() {
            const compositionText = selectedHerbsForEditFormula
                .map(herb => `${herb.name} ${herb.dosage}g`)
                .join('，');
            
            document.getElementById('editFormulaComposition').value = compositionText;
        }

        // 編輯編輯方劑中的中藥
        function editHerbInEditFormula(index) {
            const herb = selectedHerbsForEditFormula[index];
            const newDosage = prompt(`請輸入 ${herb.name} 的新劑量 (g):`, herb.dosage);
            
            if (newDosage !== null) {
                const dosage = parseFloat(newDosage);
                if (dosage && dosage > 0) {
                    selectedHerbsForEditFormula[index].dosage = dosage;
                    updateEditSelectedHerbsDisplay();
                    updateEditFormulaCompositionText();
                    showNotification(`已更新 ${herb.name} 的劑量為 ${dosage}g`, 'info');
                } else {
                    showNotification('請輸入有效的劑量', 'error');
                }
            }
        }

        // 從編輯方劑中移除中藥
        function removeHerbFromEditFormula(index) {
            const herb = selectedHerbsForEditFormula[index];
            if (confirm(`確定要移除 ${herb.name} 嗎？`)) {
                selectedHerbsForEditFormula.splice(index, 1);
                updateEditSelectedHerbsDisplay();
                updateEditFormulaCompositionText();
                showNotification(`已移除 ${herb.name}`, 'info');
            }
        }

        // 新增中藥
        function addHerb(event) {
            event.preventDefault();
            
            const newHerb = {
                id: nextHerbId++,
                name: document.getElementById('herbName').value
            };
            
            herbs.push(newHerb);
            showNotification(`中藥 "${newHerb.name}" 新增成功！`);
            showHerbalLibrary();
        }

        // 編輯中藥（使用視窗）
        function editHerb(id) {
            const herb = herbs.find(h => h.id === id);
            if (herb) {
                // 填入現有資料
                document.getElementById('modalEditHerbId').value = herb.id;
                document.getElementById('modalEditHerbName').value = herb.name;
                
                showModal('editHerbModal');
            }
        }

        // 更新中藥（視窗版本）
        function updateHerbModal(event) {
            event.preventDefault();
            
            const herbId = parseInt(document.getElementById('modalEditHerbId').value);
            const herbIndex = herbs.findIndex(h => h.id === herbId);
            
            if (herbIndex !== -1) {
                const oldName = herbs[herbIndex].name;
                herbs[herbIndex].name = document.getElementById('modalEditHerbName').value;
                
                closeModal('editHerbModal');
                loadHerbalItems();
                showNotification(`中藥 "${oldName}" 已更新為 "${herbs[herbIndex].name}"`);
            }
        }

        // 更新中藥（原版本保留）
        function updateHerb(event) {
            event.preventDefault();
            
            const herbId = parseInt(document.getElementById('editHerbId').value);
            const herbIndex = herbs.findIndex(h => h.id === herbId);
            
            if (herbIndex !== -1) {
                const oldName = herbs[herbIndex].name;
                herbs[herbIndex].name = document.getElementById('editHerbName').value;
                
                showNotification(`中藥 "${oldName}" 已更新為 "${herbs[herbIndex].name}"`);
                showHerbalLibrary();
            }
        }

        // 新增方劑
        function addFormula(event) {
            event.preventDefault();
            
            // 驗證是否有添加中藥
            if (selectedHerbsForFormula.length === 0) {
                showNotification('請至少添加一味中藥', 'error');
                return;
            }
            
            const newFormula = {
                id: nextFormulaId++,
                name: document.getElementById('formulaName').value,
                source: document.getElementById('formulaSource').value,
                composition: document.getElementById('formulaComposition').value,
                precautions: document.getElementById('formulaPrecautions').value,
                herbs: [...selectedHerbsForFormula] // 儲存中藥組成詳細資訊
            };
            
            formulas.push(newFormula);
            showNotification(`方劑 "${newFormula.name}" 新增成功！包含 ${selectedHerbsForFormula.length} 味中藥`);
            showHerbalLibrary();
        }

        // 編輯方劑（使用視窗）
        function editFormula(id) {
            const formula = formulas.find(f => f.id === id);
            if (formula) {
                // 填入現有資料
                document.getElementById('modalEditFormulaId').value = formula.id;
                document.getElementById('modalEditFormulaName').value = formula.name;
                document.getElementById('modalEditFormulaSource').value = formula.source || '';
                document.getElementById('modalEditFormulaPrecautions').value = formula.precautions || '';
                
                // 重置編輯用的選中中藥列表
                selectedHerbsForModalEditFormula = formula.herbs ? [...formula.herbs] : [];
                updateModalEditSelectedHerbsDisplay();
                updateModalEditFormulaCompositionText();
                
                // 清空搜尋欄位
                document.getElementById('modalEditHerbSearchInput').value = '';
                document.getElementById('modalEditHerbDosageInput').value = '';
                
                showModal('editFormulaModal');
            }
        }

        // 更新方劑（視窗版本）
        function updateFormulaModal(event) {
            event.preventDefault();
            
            // 驗證是否有添加中藥
            if (selectedHerbsForModalEditFormula.length === 0) {
                showNotification('請至少添加一味中藥', 'error');
                return;
            }
            
            const formulaId = parseInt(document.getElementById('modalEditFormulaId').value);
            const formulaIndex = formulas.findIndex(f => f.id === formulaId);
            
            if (formulaIndex !== -1) {
                const oldName = formulas[formulaIndex].name;
                formulas[formulaIndex] = {
                    id: formulaId,
                    name: document.getElementById('modalEditFormulaName').value,
                    source: document.getElementById('modalEditFormulaSource').value,
                    composition: document.getElementById('modalEditFormulaComposition').value,
                    precautions: document.getElementById('modalEditFormulaPrecautions').value,
                    herbs: [...selectedHerbsForModalEditFormula]
                };
                
                closeModal('editFormulaModal');
                loadHerbalItems();
                showNotification(`方劑 "${oldName}" 已更新為 "${formulas[formulaIndex].name}"`);
            }
        }

        // 更新方劑（原版本保留）
        function updateFormula(event) {
            event.preventDefault();
            
            // 驗證是否有添加中藥
            if (selectedHerbsForEditFormula.length === 0) {
                showNotification('請至少添加一味中藥', 'error');
                return;
            }
            
            const formulaId = parseInt(document.getElementById('editFormulaId').value);
            const formulaIndex = formulas.findIndex(f => f.id === formulaId);
            
            if (formulaIndex !== -1) {
                const oldName = formulas[formulaIndex].name;
                formulas[formulaIndex] = {
                    id: formulaId,
                    name: document.getElementById('editFormulaName').value,
                    source: document.getElementById('editFormulaSource').value,
                    composition: document.getElementById('editFormulaComposition').value,
                    precautions: document.getElementById('editFormulaPrecautions').value,
                    herbs: [...selectedHerbsForEditFormula]
                };
                
                showNotification(`方劑 "${oldName}" 已更新為 "${formulas[formulaIndex].name}"`);
                showHerbalLibrary();
            }
        }

        // 查看中藥詳情
        function viewHerbDetail(id) {
            const herb = herbs.find(h => h.id === id);
            if (herb) {
                const content = `
                    <div class="space-y-4">
                        <div class="text-center border-b border-gray-200 pb-4">
                            <h4 class="text-2xl font-bold text-amber-800">${herb.name}</h4>
                        </div>
                        
                        <div class="bg-amber-50 rounded-lg p-4 text-center">
                            <p class="text-gray-700">中藥名稱：${herb.name}</p>
                        </div>
                    </div>
                `;
                document.getElementById('herbDetailContent').innerHTML = content;
                showModal('herbDetailModal');
            }
        }

        // 查看方劑詳情
        function viewFormulaDetail(id) {
            const formula = formulas.find(f => f.id === id);
            if (formula) {
                const content = `
                    <div class="space-y-4">
                        <div class="text-center border-b border-gray-200 pb-4">
                            <h4 class="text-2xl font-bold text-blue-800">${formula.name}</h4>
                            ${formula.source ? `<p class="text-blue-600 mt-1">出處：${formula.source}</p>` : ''}
                        </div>
                        
                        <div class="bg-blue-50 rounded-lg p-4">
                            <h5 class="font-semibold text-blue-800 mb-2">組成</h5>
                            <p class="text-gray-700">${formula.composition}</p>
                        </div>
                        
                        ${formula.precautions ? `
                        <div class="bg-red-50 rounded-lg p-4">
                            <h5 class="font-semibold text-red-800 mb-2">注意事項</h5>
                            <p class="text-gray-700">${formula.precautions}</p>
                        </div>
                        ` : ''}
                    </div>
                `;
                document.getElementById('formulaDetailContent').innerHTML = content;
                showModal('formulaDetailModal');
            }
        }

        // 刪除中藥
        function deleteHerb(id) {
            const herb = herbs.find(h => h.id === id);
            if (herb) {
                // 設定確認刪除按鈕的事件
                document.getElementById('confirmDeleteBtn').onclick = function() {
                    herbs = herbs.filter(h => h.id !== id);
                    loadHerbalItems();
                    closeModal('confirmDeleteModal');
                    showNotification(`中藥 "${herb.name}" 已刪除`);
                };
                showModal('confirmDeleteModal');
            }
        }

        // 刪除方劑
        function deleteFormula(id) {
            const formula = formulas.find(f => f.id === id);
            if (formula) {
                // 設定確認刪除按鈕的事件
                document.getElementById('confirmDeleteBtn').onclick = function() {
                    formulas = formulas.filter(f => f.id !== id);
                    loadHerbalItems();
                    closeModal('confirmDeleteModal');
                    showNotification(`方劑 "${formula.name}" 已刪除`);
                };
                showModal('confirmDeleteModal');
            }
        }

        // 顯示系統管理
        function showSystemManagement() {
            hideAllPages();
            document.getElementById('systemManagement').classList.remove('hidden');
        }



        // 查看病歷記錄
        function viewMedicalRecord(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) {
                showNotification('找不到掛號記錄', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            if (!patient) {
                showNotification('找不到病人資料', 'error');
                return;
            }
            
            // 獲取該病人的所有病歷記錄（按日期排序，最早的在前）
            const patientRecords = medicalRecords
                .filter(record => record.patientId === appointment.patientId && record.status === 'completed')
                .sort((a, b) => new Date(a.consultationDate) - new Date(b.consultationDate));
            
            if (patientRecords.length === 0) {
                showNotification('此病人暫無病歷記錄', 'info');
                return;
            }
            
            // 顯示病人所有病歷記錄（帶分頁功能），預設顯示該次診症的病歷
            viewPatientAllMedicalRecordsWithPagination(patient, patientRecords, appointmentId);
        }

        // 查看病人所有病歷記錄（簡化版）
        function viewPatientAllMedicalRecordsWithPagination(patient, records, currentAppointmentId = null) {
            // 每次病歷都算一頁，最新的在最後一頁
            let currentPage = records.length; // 預設顯示最新的病歷（最後一頁）
            const totalPages = records.length;
            
            // 如果有指定的appointmentId，找到對應的病歷記錄並設為當前頁
            if (currentAppointmentId) {
                const targetRecordIndex = records.findIndex(record => record.appointmentId === currentAppointmentId);
                if (targetRecordIndex >= 0) {
                    currentPage = targetRecordIndex + 1; // 轉換為頁碼（從1開始）
                }
            }
            
            function renderPage(page) {
                // 第1頁 = 最早的病歷，最後一頁 = 最新的病歷
                const record = records[page - 1]; // 直接索引，因為records已經按日期排序
                
                if (!record) return;
                
                const consultationDate = new Date(record.consultationDate);
                const isCurrentAppointment = record.appointmentId === currentAppointmentId;
                const isDraft = record.status === 'draft';
                
                const content = `
                    <div class="space-y-4">
                        <!-- 病人基本資訊 -->
                        <div class="bg-blue-50 rounded-lg p-4">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h4 class="text-lg font-semibold text-blue-800">${patient.patientNumber} - ${patient.name}</h4>
                                    <p class="text-sm text-blue-600">${patient.gender} · ${calculateAge(patient.birthDate)}歲 · 總診症 ${records.length} 次</p>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm text-gray-600">第 ${page} 次診症</div>
                                    <div class="text-xs text-gray-500">${consultationDate.toLocaleDateString('zh-TW')}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 分頁控制 -->
                        <div class="bg-white rounded-lg border border-gray-200">
                            <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex justify-between items-center">
                                <h4 class="text-lg font-semibold text-gray-800">📋 病歷記錄</h4>
                                <div class="flex items-center space-x-2">
                                    <button onclick="changePage(1)" 
                                            ${page === 1 ? 'disabled' : ''} 
                                            class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed">
                                        第1次
                                    </button>
                                    <button onclick="changePage(${page - 1})" 
                                            ${page === 1 ? 'disabled' : ''} 
                                            class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed">
                                        上一次
                                    </button>
                                    <span class="px-3 py-1 text-sm bg-gray-100 rounded">
                                        第 ${page} 次診症
                                    </span>
                                    <button onclick="changePage(${page + 1})" 
                                            ${page === totalPages ? 'disabled' : ''} 
                                            class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed">
                                        下一次
                                    </button>
                                    <button onclick="changePage(${totalPages})" 
                                            ${page === totalPages ? 'disabled' : ''} 
                                            class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed">
                                        最新
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 單筆病歷記錄 -->
                            <div class="p-6 ${isCurrentAppointment ? 'bg-yellow-50' : ''}">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="flex items-center space-x-3">
                                        <h5 class="text-xl font-semibold text-gray-800">第 ${page} 次診症</h5>
                                        ${isDraft ? `
                                            <span class="bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-xs font-medium">草稿</span>
                                        ` : `
                                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium">已完成</span>
                                        `}
                                        ${isCurrentAppointment ? `
                                            <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-medium">本次診症</span>
                                        ` : ''}
                                    </div>
                                    <div class="text-right text-sm text-gray-600">
                                        <div>${consultationDate.toLocaleDateString('zh-TW')} ${record.consultationTime}</div>
                                        <div>醫師：${record.consultingDoctor}</div>
                                    </div>
                                </div>
                                
                                <!-- 病歷內容 -->
                                <div class="space-y-4">
                                    <div class="bg-green-50 rounded-lg p-4">
                                        <h6 class="font-semibold text-green-800 mb-2">主訴</h6>
                                        <p class="text-gray-700">${record.chiefComplaint}</p>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="bg-indigo-50 rounded-lg p-4">
                                            <h6 class="font-semibold text-indigo-800 mb-2">中醫診斷</h6>
                                            <p class="text-gray-700">${record.tcmDiagnosis}</p>
                                            ${record.syndromePattern ? `<p class="text-gray-600 text-sm mt-1">證型：${record.syndromePattern}</p>` : ''}
                                        </div>
                                        
                                        ${record.presentIllness ? `
                                        <div class="bg-amber-50 rounded-lg p-4">
                                            <h6 class="font-semibold text-amber-800 mb-2">現病史</h6>
                                            <p class="text-gray-700 text-sm">${record.presentIllness}</p>
                                        </div>
                                        ` : ''}
                                    </div>
                                    
                                    <div class="bg-teal-50 rounded-lg p-4">
                                        <h6 class="font-semibold text-teal-800 mb-2">處方</h6>
                                        <div class="bg-white rounded border p-3 mb-3">
                                            <pre class="text-sm text-gray-800 whitespace-pre-wrap">${record.prescriptionContent}</pre>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                            <div>
                                                <span class="font-medium text-gray-700">服用方法：</span>
                                                <span class="text-gray-600">${record.dosageInstructions}</span>
                                            </div>
                                            ${record.treatmentDuration ? `
                                            <div>
                                                <span class="font-medium text-gray-700">療程：</span>
                                                <span class="text-gray-600">${record.treatmentDuration}</span>
                                            </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                    
                                    ${record.medicalAdvice ? `
                                    <div class="bg-orange-50 rounded-lg p-4">
                                        <h6 class="font-semibold text-orange-800 mb-2">醫囑</h6>
                                        <p class="text-gray-700 text-sm">${record.medicalAdvice}</p>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('medicalRecordDetailContent').innerHTML = content;
            }
            
            // 分頁切換函數
            window.changePage = function(page) {
                if (page >= 1 && page <= totalPages) {
                    currentPage = page;
                    renderPage(currentPage);
                }
            };
            
            // 初始化顯示最新的病歷（最後一頁）
            renderPage(currentPage);
            showModal('medicalRecordDetailModal');
        }

        // 查看病人所有病歷記錄
        function viewPatientAllMedicalRecords(patient, records, currentAppointmentId = null) {
            const content = `
                <div class="space-y-6">
                    <!-- 病人基本資訊 -->
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-blue-800 mb-3">病人基本資訊</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <span class="text-sm font-medium text-gray-600">病人編號：</span>
                                <span class="text-blue-600 font-mono font-bold">${patient.patientNumber}</span>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-600">姓名：</span>
                                <span class="text-gray-800">${patient.name}</span>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-600">性別：</span>
                                <span class="text-gray-800">${patient.gender}</span>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-600">年齡：</span>
                                <span class="text-gray-800">${calculateAge(patient.birthDate)} 歲</span>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-600">電話：</span>
                                <span class="text-gray-800">${patient.phone}</span>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-600">總診症次數：</span>
                                <span class="text-green-600 font-bold">${records.filter(r => r.status === 'completed').length} 次</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 病歷記錄列表 -->
                    <div class="bg-white rounded-lg border border-gray-200">
                        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                            <h4 class="text-lg font-semibold text-gray-800">📋 病歷記錄 (共 ${records.length} 筆)</h4>
                            <p class="text-sm text-gray-600 mt-1">按診症日期排序，最新的在前</p>
                        </div>
                        
                        <div class="divide-y divide-gray-200">
                            ${records.map((record, index) => {
                                const consultationDate = new Date(record.consultationDate);
                                const isCurrentAppointment = record.appointmentId === currentAppointmentId;
                                const isDraft = record.status === 'draft';
                                
                                return `
                                    <div class="p-6 ${isCurrentAppointment ? 'bg-yellow-50 border-l-4 border-yellow-400' : ''} hover:bg-gray-50 transition-colors">
                                        <div class="flex justify-between items-start mb-4">
                                            <div class="flex-1">
                                                <div class="flex items-center space-x-3 mb-2">
                                                    <h5 class="text-lg font-semibold text-gray-800">
                                                        第 ${records.length - index} 次診症
                                                    </h5>
                                                    ${isDraft ? `
                                                        <span class="bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-xs font-medium">
                                                            草稿
                                                        </span>
                                                    ` : `
                                                        <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium">
                                                            已完成
                                                        </span>
                                                    `}
                                                    ${isCurrentAppointment ? `
                                                        <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-medium">
                                                            本次診症
                                                        </span>
                                                    ` : ''}
                                                </div>
                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                                    <div>
                                                        <span class="font-medium text-gray-600">診症日期：</span>
                                                        <span class="text-gray-800">${consultationDate.toLocaleDateString('zh-TW')}</span>
                                                    </div>
                                                    <div>
                                                        <span class="font-medium text-gray-600">診症時間：</span>
                                                        <span class="text-gray-800">${record.consultationTime}</span>
                                                    </div>
                                                    <div>
                                                        <span class="font-medium text-gray-600">主診醫師：</span>
                                                        <span class="text-gray-800">${record.consultingDoctor}</span>
                                                    </div>
                                                    <div>
                                                        <span class="font-medium text-gray-600">建立時間：</span>
                                                        <span class="text-gray-800">${new Date(record.createdAt).toLocaleDateString('zh-TW')}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <button onclick="viewMedicalRecordDetail(${record.id})" 
                                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                                查看詳情
                                            </button>
                                        </div>
                                        
                                        <!-- 病歷摘要 -->
                                        <div class="bg-gray-50 rounded-lg p-4">
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div>
                                                    <h6 class="font-medium text-gray-700 mb-1">主訴</h6>
                                                    <p class="text-gray-600 text-sm line-clamp-2">${record.chiefComplaint}</p>
                                                </div>
                                                <div>
                                                    <h6 class="font-medium text-gray-700 mb-1">診斷</h6>
                                                    <p class="text-gray-600 text-sm">
                                                        ${record.tcmDiagnosis}${record.syndromePattern ? ` - ${record.syndromePattern}` : ''}
                                                    </p>
                                                </div>
                                            </div>
                                            ${record.prescriptionContent ? `
                                                <div class="mt-3 pt-3 border-t border-gray-200">
                                                    <h6 class="font-medium text-gray-700 mb-1">處方摘要</h6>
                                                    <p class="text-gray-600 text-sm line-clamp-2">${record.prescriptionContent.split('\n').slice(0, 3).join(', ')}${record.prescriptionContent.split('\n').length > 3 ? '...' : ''}</p>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- 統計資訊 -->
                    <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">📊 診療統計</h4>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
                            <div class="bg-white rounded-lg p-3">
                                <div class="text-2xl font-bold text-blue-600">${records.filter(r => r.status === 'completed').length}</div>
                                <div class="text-sm text-gray-600">完成診症</div>
                            </div>
                            <div class="bg-white rounded-lg p-3">
                                <div class="text-2xl font-bold text-orange-600">${records.filter(r => r.status === 'draft').length}</div>
                                <div class="text-sm text-gray-600">草稿記錄</div>
                            </div>
                            <div class="bg-white rounded-lg p-3">
                                <div class="text-2xl font-bold text-green-600">
                                    ${records.length > 0 ? Math.round((new Date() - new Date(records[records.length - 1].consultationDate)) / (1000 * 60 * 60 * 24)) : 0}
                                </div>
                                <div class="text-sm text-gray-600">首診至今天數</div>
                            </div>
                            <div class="bg-white rounded-lg p-3">
                                <div class="text-2xl font-bold text-purple-600">
                                    ${records.length > 1 ? Math.round((new Date(records[0].consultationDate) - new Date(records[records.length - 1].consultationDate)) / (1000 * 60 * 60 * 24 * (records.length - 1))) : 0}
                                </div>
                                <div class="text-sm text-gray-600">平均診療間隔(天)</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('medicalRecordDetailContent').innerHTML = content;
            showModal('medicalRecordDetailModal');
        }

        // 查看病歷詳情
        function viewMedicalRecordDetail(recordId) {
            const record = medicalRecords.find(r => r.id === recordId);
            if (!record) {
                showNotification('找不到病歷記錄', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === record.patientId);
            const consultationDate = new Date(record.consultationDate);
            
            const content = `
                <div class="space-y-6">
                    <!-- 病人基本資訊 -->
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-blue-800 mb-3">病人基本資訊</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <span class="text-sm font-medium text-gray-600">病人編號：</span>
                                <span class="text-blue-600 font-mono font-bold">${record.patientNumber}</span>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-600">姓名：</span>
                                <span class="text-gray-800">${record.patientName}</span>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-600">年齡：</span>
                                <span class="text-gray-800">${patient ? calculateAge(patient.birthDate) : '未知'} 歲</span>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-600">診症日期：</span>
                                <span class="text-gray-800">${consultationDate.toLocaleDateString('zh-TW')}</span>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-600">診症時間：</span>
                                <span class="text-gray-800">${record.consultationTime}</span>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-600">主診醫師：</span>
                                <span class="text-gray-800">${record.consultingDoctor}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 主訴 -->
                    <div class="bg-green-50 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-green-800 mb-3">主訴</h4>
                        <p class="text-gray-700">${record.chiefComplaint}</p>
                    </div>
                    
                    ${record.presentIllness ? `
                    <!-- 現病史 -->
                    <div class="bg-amber-50 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-amber-800 mb-3">現病史</h4>
                        <p class="text-gray-700">${record.presentIllness}</p>
                    </div>
                    ` : ''}
                    
                    ${record.pastMedicalHistory || record.allergyHistory ? `
                    <!-- 既往史 -->
                    <div class="bg-purple-50 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-purple-800 mb-3">既往史</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${record.pastMedicalHistory ? `
                            <div>
                                <h5 class="font-medium text-gray-700 mb-2">過往疾病史</h5>
                                <p class="text-gray-600 text-sm">${record.pastMedicalHistory}</p>
                            </div>
                            ` : ''}
                            ${record.allergyHistory ? `
                            <div>
                                <h5 class="font-medium text-gray-700 mb-2">藥物過敏史</h5>
                                <p class="text-gray-600 text-sm">${record.allergyHistory}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${record.inspection || record.auscultation || record.inquiry || record.palpation ? `
                    <!-- 中醫四診 -->
                    <div class="bg-red-50 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-red-800 mb-3">中醫四診</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${record.inspection ? `
                            <div>
                                <h5 class="font-medium text-gray-700 mb-2">望診</h5>
                                <p class="text-gray-600 text-sm">${record.inspection}</p>
                            </div>
                            ` : ''}
                            ${record.auscultation ? `
                            <div>
                                <h5 class="font-medium text-gray-700 mb-2">聞診</h5>
                                <p class="text-gray-600 text-sm">${record.auscultation}</p>
                            </div>
                            ` : ''}
                            ${record.inquiry ? `
                            <div>
                                <h5 class="font-medium text-gray-700 mb-2">問診</h5>
                                <p class="text-gray-600 text-sm">${record.inquiry}</p>
                            </div>
                            ` : ''}
                            ${record.palpation ? `
                            <div>
                                <h5 class="font-medium text-gray-700 mb-2">切診</h5>
                                <p class="text-gray-600 text-sm">${record.palpation}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- 中醫診斷 -->
                    <div class="bg-indigo-50 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-indigo-800 mb-3">中醫診斷</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <h5 class="font-medium text-gray-700 mb-2">病名診斷</h5>
                                <p class="text-gray-800 font-medium">${record.tcmDiagnosis}</p>
                            </div>
                            <div>
                                <h5 class="font-medium text-gray-700 mb-2">證型診斷</h5>
                                <p class="text-gray-800 font-medium">${record.syndromePattern || '未填寫'}</p>
                            </div>
                        </div>
                        ${record.diagnosisBasis ? `
                        <div>
                            <h5 class="font-medium text-gray-700 mb-2">診斷依據</h5>
                            <p class="text-gray-600 text-sm">${record.diagnosisBasis}</p>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- 治療方案 -->
                    <div class="bg-teal-50 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-teal-800 mb-3">治療方案</h4>
                        ${record.treatmentPrinciple ? `
                        <div class="mb-4">
                            <h5 class="font-medium text-gray-700 mb-2">治法</h5>
                            <p class="text-gray-800">${record.treatmentPrinciple}</p>
                        </div>
                        ` : ''}
                        ${record.prescriptionName ? `
                        <div class="mb-4">
                            <h5 class="font-medium text-gray-700 mb-2">方劑名稱</h5>
                            <p class="text-gray-800">${record.prescriptionName}</p>
                        </div>
                        ` : ''}
                        <div class="mb-4">
                            <h5 class="font-medium text-gray-700 mb-2">處方內容</h5>
                            <div class="bg-white rounded border p-3">
                                <pre class="text-sm text-gray-800 whitespace-pre-wrap font-mono">${record.prescriptionContent}</pre>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h5 class="font-medium text-gray-700 mb-2">服用方法</h5>
                                <p class="text-gray-800">${record.dosageInstructions}</p>
                            </div>
                            ${record.treatmentDuration ? `
                            <div>
                                <h5 class="font-medium text-gray-700 mb-2">療程</h5>
                                <p class="text-gray-800">${record.treatmentDuration}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    ${record.medicalAdvice ? `
                    <!-- 醫囑及注意事項 -->
                    <div class="bg-orange-50 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-orange-800 mb-3">醫囑及注意事項</h4>
                        <p class="text-gray-700">${record.medicalAdvice}</p>
                    </div>
                    ` : ''}
                    
                    <!-- 記錄資訊 -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">記錄資訊</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="font-medium text-gray-600">建立時間：</span>
                                <span class="text-gray-800">${new Date(record.createdAt).toLocaleString('zh-TW')}</span>
                            </div>
                            <div>
                                <span class="font-medium text-gray-600">建立者：</span>
                                <span class="text-gray-800">${userNames[record.createdBy] || record.createdBy}</span>
                            </div>
                            ${record.lastModified ? `
                            <div>
                                <span class="font-medium text-gray-600">最後修改：</span>
                                <span class="text-gray-800">${new Date(record.lastModified).toLocaleString('zh-TW')}</span>
                            </div>
                            <div>
                                <span class="font-medium text-gray-600">修改者：</span>
                                <span class="text-gray-800">${userNames[record.modifiedBy] || record.modifiedBy}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    ${record.modificationHistory && record.modificationHistory.length > 0 ? `
                    <!-- 修改歷史 -->
                    <div class="bg-yellow-50 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-semibold text-yellow-800">📝 修改歷史</h4>
                            <button onclick="toggleModificationHistory()" id="toggleHistoryBtn" class="text-yellow-600 hover:text-yellow-800 text-sm font-medium">
                                展開歷史 ▼
                            </button>
                        </div>
                        <div id="modificationHistoryContent" class="hidden">
                            <div class="space-y-4">
                                ${record.modificationHistory.map((history, index) => `
                                    <div class="bg-white rounded-lg p-4 border border-yellow-200">
                                        <div class="flex justify-between items-center mb-3">
                                            <h5 class="font-medium text-gray-800">修改記錄 #${record.modificationHistory.length - index}</h5>
                                            <div class="text-sm text-gray-600">
                                                ${new Date(history.modifiedAt).toLocaleString('zh-TW')} 
                                                by ${userNames[history.modifiedBy] || history.modifiedBy}
                                            </div>
                                        </div>
                                        <div class="space-y-3">
                                            ${Object.entries(history.changes).map(([field, change]) => {
                                                if (change.from !== change.to) {
                                                    const fieldNames = {
                                                        chiefComplaint: '主訴',
                                                        presentIllness: '現病史',
                                                        tcmDiagnosis: '中醫診斷',
                                                        syndromePattern: '證型診斷',
                                                        prescriptionContent: '處方內容',
                                                        dosageInstructions: '服用方法',
                                                        treatmentDuration: '療程',
                                                        medicalAdvice: '醫囑及注意事項'
                                                    };
                                                    return `
                                                        <div class="border-l-4 border-yellow-400 pl-4">
                                                            <div class="font-medium text-gray-700 mb-1">${fieldNames[field] || field}</div>
                                                            <div class="text-sm">
                                                                <div class="text-red-600 mb-1">
                                                                    <span class="font-medium">修改前：</span>
                                                                    <span class="bg-red-50 px-2 py-1 rounded">${change.from || '(空白)'}</span>
                                                                </div>
                                                                <div class="text-green-600">
                                                                    <span class="font-medium">修改後：</span>
                                                                    <span class="bg-green-50 px-2 py-1 rounded">${change.to || '(空白)'}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    `;
                                                }
                                                return '';
                                            }).filter(item => item !== '').join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('medicalRecordDetailContent').innerHTML = content;
            showModal('medicalRecordDetailModal');
        }

        // 查看病人病歷記錄
        function viewPatientMedicalRecords(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) {
                showNotification('找不到病人資料', 'error');
                return;
            }
            
            hideAllPages();
            document.getElementById('patientMedicalRecords').classList.remove('hidden');
            document.getElementById('currentPatientName').textContent = `病人：${patient.patientNumber} - ${patient.name}`;
            
            // 清空篩選條件
            document.getElementById('patientRecordDateFrom').value = '';
            document.getElementById('patientRecordDateTo').value = '';
            
            // 儲存當前病人ID
            window.currentPatientId = patientId;
            
            loadPatientMedicalRecordsList();
        }

        // 載入病人病歷記錄列表
        function loadPatientMedicalRecordsList(filteredRecords = null) {
            const tbody = document.getElementById('patientMedicalRecordsList');
            const patientRecords = medicalRecords.filter(record => 
                record.patientId === window.currentPatientId && record.status === 'completed'
            );
            
            const recordsToShow = filteredRecords || patientRecords;
            
            if (recordsToShow.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="border border-gray-200 px-4 py-8 text-center text-gray-500">
                            ${filteredRecords ? '沒有找到符合條件的病歷記錄' : '此病人暫無病歷記錄'}
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = recordsToShow.map(record => {
                const consultationDate = new Date(record.consultationDate);
                const dateString = consultationDate.toLocaleDateString('zh-TW');
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-200 px-4 py-3">${dateString}</td>
                        <td class="border border-gray-200 px-4 py-3">
                            <div class="max-w-xs truncate" title="${record.chiefComplaint}">
                                ${record.chiefComplaint}
                            </div>
                        </td>
                        <td class="border border-gray-200 px-4 py-3">
                            <div class="max-w-xs truncate" title="${record.tcmDiagnosis}">
                                ${record.tcmDiagnosis}
                            </div>
                        </td>
                        <td class="border border-gray-200 px-4 py-3">${record.consultingDoctor}</td>
                        <td class="border border-gray-200 px-4 py-3">
                            <button onclick="viewMedicalRecordDetail(${record.id})" class="text-purple-600 hover:text-purple-800 text-sm font-medium">
                                查看詳情
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // 篩選病人病歷記錄（按日期）
        function filterPatientMedicalRecords() {
            const dateFrom = document.getElementById('patientRecordDateFrom').value;
            const dateTo = document.getElementById('patientRecordDateTo').value;
            
            let filteredRecords = medicalRecords.filter(record => 
                record.patientId === window.currentPatientId && record.status === 'completed'
            );
            
            // 應用日期篩選
            if (dateFrom || dateTo) {
                filteredRecords = filteredRecords.filter(record => {
                    const recordDate = new Date(record.consultationDate);
                    const fromDate = dateFrom ? new Date(dateFrom) : null;
                    const toDate = dateTo ? new Date(dateTo) : null;
                    
                    if (fromDate && recordDate < fromDate) return false;
                    if (toDate && recordDate > toDate) return false;
                    return true;
                });
            }
            
            loadPatientMedicalRecordsList(filteredRecords);
        }

        // 設定病人病歷日期篩選
        function setPatientDateFilter(period) {
            const today = new Date();
            const dateFromInput = document.getElementById('patientRecordDateFrom');
            const dateToInput = document.getElementById('patientRecordDateTo');
            
            let fromDate;
            
            switch (period) {
                case 'today':
                    fromDate = new Date(today);
                    break;
                case 'week':
                    fromDate = new Date(today);
                    fromDate.setDate(today.getDate() - 7);
                    break;
                case 'month':
                    fromDate = new Date(today);
                    fromDate.setMonth(today.getMonth() - 1);
                    break;
                default:
                    return;
            }
            
            dateFromInput.value = fromDate.toISOString().split('T')[0];
            dateToInput.value = today.toISOString().split('T')[0];
            
            filterPatientMedicalRecords();
        }

        // 清除病人病歷日期篩選
        function clearPatientDateFilter() {
            document.getElementById('patientRecordDateFrom').value = '';
            document.getElementById('patientRecordDateTo').value = '';
            filterPatientMedicalRecords();
        }



        // 儲存病歷（原儲存草稿功能）
        function saveDraftRecord() {
            // 驗證必填欄位
            const requiredFields = [
                { id: 'consultationDate', name: '診症日期' },
                { id: 'consultationTime', name: '診症時間' },
                { id: 'consultingDoctor', name: '主診醫師' },
                { id: 'chiefComplaint', name: '主訴' },
                { id: 'tcmDiagnosis', name: '中醫診斷' },
                { id: 'syndromePattern', name: '證型診斷' },
                { id: 'treatmentPrinciple', name: '治法' },
                { id: 'prescriptionContent', name: '處方內容' },
                { id: 'dosageInstructions', name: '服用方法' }
            ];
            
            const missingFields = [];
            
            // 先清除所有錯誤樣式
            requiredFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    element.classList.remove('border-red-500', 'bg-red-50');
                }
            });
            
            for (const field of requiredFields) {
                const element = document.getElementById(field.id);
                if (!element || !element.value.trim()) {
                    missingFields.push(field.name);
                    // 為缺失的欄位添加紅色邊框提示
                    if (element) {
                        element.classList.add('border-red-500', 'bg-red-50');
                        element.addEventListener('input', function() {
                            if (this.value.trim()) {
                                this.classList.remove('border-red-500', 'bg-red-50');
                            }
                        }, { once: true });
                    }
                }
            }
            
            if (missingFields.length > 0) {
                showNotification(`請填寫以下必填欄位：${missingFields.join('、')}`, 'error');
                // 滾動到第一個缺失的欄位
                const firstMissingFieldId = requiredFields.find(field => {
                    const element = document.getElementById(field.id);
                    return !element || !element.value.trim();
                })?.id;
                
                if (firstMissingFieldId) {
                    const firstMissingField = document.getElementById(firstMissingFieldId);
                    if (firstMissingField) {
                        firstMissingField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        firstMissingField.focus();
                    }
                }
                return;
            }
            
            const patientId = parseInt(document.getElementById('recordPatientId').value);
            const appointmentId = parseInt(document.getElementById('recordAppointmentId').value);
            const patient = patients.find(p => p.id === patientId);
            
            const medicalRecord = {
                id: nextRecordId++,
                patientId: patientId,
                appointmentId: appointmentId,
                patientName: patient.name,
                patientNumber: patient.patientNumber,
                consultationDate: document.getElementById('consultationDate').value,
                consultationTime: document.getElementById('consultationTime').value,
                consultingDoctor: document.getElementById('consultingDoctor').value,
                chiefComplaint: document.getElementById('chiefComplaint').value,
                presentIllness: document.getElementById('presentIllness').value,
                pastMedicalHistory: document.getElementById('pastMedicalHistory').value,
                allergyHistory: document.getElementById('allergyHistory').value,
                inspection: document.getElementById('inspection').value,
                auscultation: document.getElementById('auscultation').value,
                inquiry: document.getElementById('inquiry').value,
                palpation: document.getElementById('palpation').value,
                tcmDiagnosis: document.getElementById('tcmDiagnosis').value,
                syndromePattern: document.getElementById('syndromePattern').value,
                diagnosisBasis: document.getElementById('diagnosisBasis').value,
                treatmentPrinciple: document.getElementById('treatmentPrinciple').value,
                prescriptionName: document.getElementById('prescriptionName').value,
                prescriptionContent: document.getElementById('prescriptionContent').value,
                dosageInstructions: document.getElementById('dosageInstructions').value,
                treatmentDuration: document.getElementById('treatmentDuration').value,
                medicalAdvice: document.getElementById('medicalAdvice').value,
                createdAt: new Date().toISOString(),
                createdBy: currentUser,
                status: 'completed'
            };
            
            medicalRecords.push(medicalRecord);
            
            // 更新掛號狀態為已完成
            updateAppointmentStatus(appointmentId, '已完成');
            
            showNotification(`病歷已成功儲存！病人：${patient.name}`);
            showConsultationSystem();
        }

        // 顯示統計頁面
        function showStatistics() {
            hideAllPages();
            document.getElementById('statisticsPage').classList.remove('hidden');
            
            // 更新統計數據
            document.getElementById('totalPatients').textContent = patients.length;
            document.getElementById('totalConsultations').textContent = medicalRecords.filter(r => r.status === 'completed').length;
            document.getElementById('todayConsultations').textContent = appointments.filter(apt => 
                new Date(apt.appointmentTime).toDateString() === new Date().toDateString()
            ).length;
        }

        // 顯示模態視窗
        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        // 關閉模態視窗
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // 顯示功能說明
        function showFeatureModal(message) {
            document.getElementById('featureMessage').textContent = message;
            showModal('featureModal');
        }

        // 顯示通知
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('floatingNotification');
            const messageEl = document.getElementById('notificationMessage');
            const iconEl = document.getElementById('notificationIcon');
            
            messageEl.textContent = message;
            
            // 設定圖示和顏色
            if (type === 'success') {
                iconEl.innerHTML = '✅';
                notification.querySelector('.border-l-4').className = 'bg-white rounded-lg shadow-2xl border-l-4 border-green-500 p-4 max-w-sm transform translate-x-full transition-transform duration-300 ease-out';
            } else if (type === 'error') {
                iconEl.innerHTML = '❌';
                notification.querySelector('.border-l-4').className = 'bg-white rounded-lg shadow-2xl border-l-4 border-red-500 p-4 max-w-sm transform translate-x-full transition-transform duration-300 ease-out';
            } else {
                iconEl.innerHTML = 'ℹ️';
                notification.querySelector('.border-l-4').className = 'bg-white rounded-lg shadow-2xl border-l-4 border-blue-500 p-4 max-w-sm transform translate-x-full transition-transform duration-300 ease-out';
            }
            
            notification.classList.remove('hidden');
            
            // 動畫效果
            setTimeout(() => {
                notification.querySelector('.transform').classList.remove('translate-x-full');
            }, 100);
            
            // 自動隱藏
            setTimeout(() => {
                hideNotification();
            }, 3000);
        }

        // 隱藏通知
        function hideNotification() {
            const notification = document.getElementById('floatingNotification');
            notification.querySelector('.transform').classList.add('translate-x-full');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 300);
        }

        // 切換修改歷史顯示
        function toggleModificationHistory() {
            const content = document.getElementById('modificationHistoryContent');
            const btn = document.getElementById('toggleHistoryBtn');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                btn.textContent = '收起歷史 ▲';
            } else {
                content.classList.add('hidden');
                btn.textContent = '展開歷史 ▼';
            }
        }

        // 視窗編輯方劑的搜尋中藥功能
        function searchHerbsForModalEditFormula() {
            const searchTerm = document.getElementById('modalEditHerbSearchInput').value.toLowerCase().trim();
            const searchResults = document.getElementById('modalEditHerbSearchResults');
            const searchResultsList = document.getElementById('modalEditHerbSearchResultsList');
            
            if (searchTerm === '') {
                searchResults.classList.add('hidden');
                return;
            }
            
            const filteredHerbs = herbs.filter(herb => 
                herb.name.toLowerCase().includes(searchTerm)
            );
            
            if (filteredHerbs.length === 0) {
                searchResultsList.innerHTML = '<div class="px-4 py-3 text-gray-500 text-sm">沒有找到符合條件的中藥</div>';
            } else {
                searchResultsList.innerHTML = filteredHerbs.map(herb => `
                    <div class="px-4 py-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0" 
                         onclick="selectHerbForModalEditFormula('${herb.name}')">
                        <div class="font-medium text-gray-900">${herb.name}</div>
                    </div>
                `).join('');
            }
            
            searchResults.classList.remove('hidden');
        }

        // 顯示視窗編輯方劑的中藥搜尋結果
        function showModalEditHerbSearchResults() {
            const searchTerm = document.getElementById('modalEditHerbSearchInput').value.trim();
            if (searchTerm !== '') {
                searchHerbsForModalEditFormula();
            }
        }

        // 選擇中藥（視窗編輯方劑用）
        function selectHerbForModalEditFormula(herbName) {
            document.getElementById('modalEditHerbSearchInput').value = herbName;
            document.getElementById('modalEditHerbSearchResults').classList.add('hidden');
            document.getElementById('modalEditHerbDosageInput').focus();
        }

        // 添加中藥到視窗編輯方劑組成
        function addHerbToModalEditFormula() {
            const herbName = document.getElementById('modalEditHerbSearchInput').value.trim();
            const dosage = parseFloat(document.getElementById('modalEditHerbDosageInput').value);
            
            if (!herbName) {
                showNotification('請選擇中藥', 'error');
                return;
            }
            
            if (!dosage || dosage <= 0) {
                showNotification('請輸入有效的劑量', 'error');
                return;
            }
            
            // 檢查中藥是否存在
            const herbExists = herbs.some(herb => herb.name === herbName);
            if (!herbExists) {
                showNotification('請從搜尋結果中選擇中藥', 'error');
                return;
            }
            
            // 檢查是否已經添加過
            const existingIndex = selectedHerbsForModalEditFormula.findIndex(item => item.name === herbName);
            if (existingIndex >= 0) {
                // 更新劑量
                selectedHerbsForModalEditFormula[existingIndex].dosage = dosage;
                showNotification(`已更新 ${herbName} 的劑量為 ${dosage}g`, 'info');
            } else {
                // 添加新中藥
                selectedHerbsForModalEditFormula.push({
                    name: herbName,
                    dosage: dosage
                });
                showNotification(`已添加 ${herbName} ${dosage}g`);
            }
            
            // 清空輸入框
            document.getElementById('modalEditHerbSearchInput').value = '';
            document.getElementById('modalEditHerbDosageInput').value = '';
            document.getElementById('modalEditHerbSearchResults').classList.add('hidden');
            
            // 更新顯示
            updateModalEditSelectedHerbsDisplay();
            updateModalEditFormulaCompositionText();
        }

        // 更新視窗編輯方劑的已選中藥顯示
        function updateModalEditSelectedHerbsDisplay() {
            const container = document.getElementById('modalEditSelectedHerbsDisplay');
            
            if (selectedHerbsForModalEditFormula.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">尚未添加任何中藥</p>';
                return;
            }
            
            container.innerHTML = selectedHerbsForModalEditFormula.map((herb, index) => `
                <div class="flex items-center justify-between bg-white rounded-lg p-3 border border-gray-200">
                    <div class="flex items-center space-x-3">
                        <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-bold">
                            ${index + 1}
                        </span>
                        <span class="font-medium text-gray-800">${herb.name}</span>
                        <span class="text-blue-600 font-mono">${herb.dosage}g</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="editHerbInModalEditFormula(${index})" class="text-blue-600 hover:text-blue-800 text-sm">
                            編輯
                        </button>
                        <button onclick="removeHerbFromModalEditFormula(${index})" class="text-red-600 hover:text-red-800 text-sm">
                            移除
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // 更新視窗編輯方劑的組成文字
        function updateModalEditFormulaCompositionText() {
            const compositionText = selectedHerbsForModalEditFormula
                .map(herb => `${herb.name} ${herb.dosage}g`)
                .join('，');
            
            document.getElementById('modalEditFormulaComposition').value = compositionText;
        }

        // 編輯視窗編輯方劑中的中藥
        function editHerbInModalEditFormula(index) {
            const herb = selectedHerbsForModalEditFormula[index];
            const newDosage = prompt(`請輸入 ${herb.name} 的新劑量 (g):`, herb.dosage);
            
            if (newDosage !== null) {
                const dosage = parseFloat(newDosage);
                if (dosage && dosage > 0) {
                    selectedHerbsForModalEditFormula[index].dosage = dosage;
                    updateModalEditSelectedHerbsDisplay();
                    updateModalEditFormulaCompositionText();
                    showNotification(`已更新 ${herb.name} 的劑量為 ${dosage}g`, 'info');
                } else {
                    showNotification('請輸入有效的劑量', 'error');
                }
            }
        }

        // 從視窗編輯方劑中移除中藥
        function removeHerbFromModalEditFormula(index) {
            const herb = selectedHerbsForModalEditFormula[index];
            if (confirm(`確定要移除 ${herb.name} 嗎？`)) {
                selectedHerbsForModalEditFormula.splice(index, 1);
                updateModalEditSelectedHerbsDisplay();
                updateModalEditFormulaCompositionText();
                showNotification(`已移除 ${herb.name}`, 'info');
            }
        }

        // 點擊外部關閉搜尋結果
        document.addEventListener('click', function(event) {
            const herbSearchResults = document.getElementById('herbSearchResults');
            const herbSearchInput = document.getElementById('herbSearchInput');
            
            if (herbSearchResults && herbSearchInput && 
                !herbSearchResults.contains(event.target) && 
                !herbSearchInput.contains(event.target)) {
                herbSearchResults.classList.add('hidden');
            }
        });


    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'967cf425e2780443',t:'MTc1Mzk2MzQxOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
