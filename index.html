<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­é†«è™•æ–¹æ¨è–¦å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-5xl">
        <!-- æ¨™é¡Œ -->
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸŒ¿ ä¸­é†«è™•æ–¹å·¥å…·</h1>
        </div>

        <!-- æ•¸æ“šå‚™ä»½å€ -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-4">
            <div class="grid md:grid-cols-2 gap-4">
                <!-- æœ¬åœ°å‚™ä»½ -->
                <div class="space-y-2">
                    <h3 class="text-sm font-bold text-gray-700 mb-2">ğŸ“± æœ¬åœ°å‚™ä»½</h3>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="exportData()" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg font-medium text-sm">
                            ğŸ’¾ ä¸‹è¼‰å‚™ä»½
                        </button>
                        <button onclick="document.getElementById('importFile').click()" 
                                class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg font-medium text-sm">
                            ğŸ“‚ æ¢å¾©æ•¸æ“š
                        </button>
                        <button onclick="clearAllData()" 
                                class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg font-medium text-sm">
                            ğŸ—‘ï¸ æ¸…ç©ºæ•¸æ“š
                        </button>
                    </div>
                </div>
                
                <!-- é›²ç«¯åŒæ­¥ -->
                <div class="space-y-2">
                    <h3 class="text-sm font-bold text-gray-700 mb-2">â˜ï¸ é›²ç«¯åŒæ­¥</h3>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="saveToCloud()" 
                                class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded-lg font-medium text-sm">
                            â˜ï¸ ä¿å­˜åˆ°é›²ç«¯
                        </button>
                        <button onclick="loadFromCloud()" 
                                class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-2 rounded-lg font-medium text-sm">
                            ğŸ“¥ å¾é›²ç«¯è¼‰å…¥
                        </button>
                        <button onclick="showCloudStatus()" 
                                class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-lg font-medium text-sm">
                            ğŸ“Š åŒæ­¥ç‹€æ…‹
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- æ‰¹é‡å°å…¥å€ -->
            <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border border-yellow-200 rounded-lg p-4 mt-4">
                <h3 class="text-sm font-bold text-gray-700 mb-3">ğŸ“‹ æ‰¹é‡å°å…¥ä¸­è—¥ç—‡ç‹€</h3>
                <div class="space-y-3">
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“ æ–‡æœ¬å°å…¥</label>
                            <textarea id="bulkImportText" 
                                      placeholder="æ ¼å¼ï¼šä¸­è—¥åï¼šç—‡ç‹€1,ç—‡ç‹€2,ç—‡ç‹€3&#10;ä¾‹å¦‚ï¼š&#10;ç•¶æ­¸ï¼šè¡€è™›,æœˆç¶“ä¸èª¿,ä¾¿ç§˜&#10;é»ƒèŠªï¼šæ°£è™›,ç–²å‹,è‡ªæ±—&#10;ç”˜è‰ï¼šå’³å—½,èƒƒç—›,è§£æ¯’&#10;&#10;ğŸ’¡ æ”¯æŒå¤§é‡æ•¸æ“šå°å…¥ï¼ˆå»ºè­°å–®æ¬¡ä¸è¶…é10è¬å­—ï¼‰"
                                      rows="6" 
                                      maxlength="100000"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm resize-y"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“ æ–‡ä»¶å°å…¥</label>
                            <div class="space-y-2">
                                <button onclick="document.getElementById('bulkImportFile').click()" 
                                        class="w-full bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded-lg font-medium text-sm">
                                    ğŸ“ é¸æ“‡æ–‡ä»¶å°å…¥
                                </button>
                                <button onclick="downloadTemplate()" 
                                        class="w-full bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg font-medium text-sm">
                                    ğŸ“„ ä¸‹è¼‰æ¨¡æ¿æ–‡ä»¶
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="flex gap-2">
                            <button onclick="processBulkImport()" 
                                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium text-sm">
                                âš¡ é–‹å§‹å°å…¥
                            </button>
                            <button onclick="clearBulkImport()" 
                                    class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium text-sm">
                                ğŸ§¹ æ¸…ç©ºè¼¸å…¥
                            </button>
                        </div>
                        <div id="charCount" class="text-sm text-gray-500">
                            å­—æ•¸ï¼š0 / 100,000
                        </div>
                    </div>
                </div>
                <input type="file" id="bulkImportFile" accept=".txt,.csv" style="display: none;" onchange="loadBulkImportFile(event)">
            </div>
            
            <!-- ç‹€æ…‹é¡¯ç¤º -->
            <div id="backupStatus" class="mt-3 p-3 bg-gray-50 rounded-lg text-sm text-gray-600 hidden"></div>
            
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
        </div>

        <!-- ä¸»æœç´¢å€ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="space-y-4">
                <input type="text" id="symptomSearch" placeholder="è¼¸å…¥ç—‡ç‹€æœç´¢è™•æ–¹ï¼Œä¾‹å¦‚ï¼šé ­ç—›,ç™¼ç†±" 
                       class="w-full px-4 py-3 text-lg border-2 border-gray-200 rounded-lg focus:border-green-500 focus:outline-none">
                
                <!-- å¿«é€Ÿé¸æ“‡æŒ‰éˆ• -->
                <div class="flex flex-wrap gap-2" id="quickSelectGroups"></div>
                
                <button onclick="searchPrescriptions()" 
                        class="w-full bg-green-500 hover:bg-green-600 text-white text-lg font-medium py-3 rounded-lg">
                    ğŸ” æœç´¢è™•æ–¹
                </button>
            </div>

            <!-- æœç´¢çµæœ -->
            <div id="searchResults" class="mt-6 hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4">æ¨è–¦è™•æ–¹</h3>
                <div id="resultsList" class="space-y-4"></div>
            </div>
        </div>

        <!-- æ¨™ç±¤é å°èˆª -->
        <div class="bg-white rounded-lg shadow-md mb-6">
            <div class="flex border-b">
                <button onclick="showTab('groups')" id="groupsTab" 
                        class="flex-1 py-3 px-4 text-center font-medium border-b-2 border-green-500 text-green-600">
                    ç—‡ç‹€åˆ†çµ„
                </button>
                <button onclick="showTab('symptoms')" id="symptomsTab" 
                        class="flex-1 py-3 px-4 text-center font-medium text-gray-500 hover:text-gray-700">
                    ç—‡ç‹€ç®¡ç†
                </button>
                <button onclick="showTab('prescriptions')" id="prescriptionsTab" 
                        class="flex-1 py-3 px-4 text-center font-medium text-gray-500 hover:text-gray-700">
                    è™•æ–¹ç®¡ç†
                </button>
            </div>

            <!-- ç—‡ç‹€åˆ†çµ„æ¨™ç±¤é  -->
            <div id="groupsContent" class="p-6">
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- å‰µå»ºåˆ†çµ„ -->
                    <div>
                        <h3 class="text-lg font-bold mb-4">å‰µå»ºæ–°åˆ†çµ„</h3>
                        <div class="space-y-3">
                            <input type="text" id="newGroupName" placeholder="åˆ†çµ„åç¨±" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <input type="text" id="newGroupSymptoms" placeholder="ç—‡ç‹€ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <select id="groupColor" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="red">ğŸ”´ ç´…è‰²</option>
                                <option value="blue">ğŸ”µ è—è‰²</option>
                                <option value="green">ğŸŸ¢ ç¶ è‰²</option>
                                <option value="orange">ğŸŸ  æ©™è‰²</option>
                                <option value="purple">ğŸŸ£ ç´«è‰²</option>
                                <option value="pink">ğŸ©· ç²‰è‰²</option>
                            </select>
                            <button onclick="addSymptomGroup()" 
                                    class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg">
                                â• å‰µå»ºåˆ†çµ„
                            </button>
                        </div>
                    </div>
                    
                    <!-- ç¾æœ‰åˆ†çµ„ -->
                    <div>
                        <h3 class="text-lg font-bold mb-4">ç¾æœ‰åˆ†çµ„</h3>
                        <div id="symptomGroupsList" class="space-y-3 max-h-80 overflow-y-auto"></div>
                    </div>
                </div>
            </div>

            <!-- ç—‡ç‹€ç®¡ç†æ¨™ç±¤é  -->
            <div id="symptomsContent" class="p-6 hidden">
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-bold mb-4">æ·»åŠ ç—‡ç‹€</h3>
                        <div class="flex gap-2">
                            <input type="text" id="newSymptom" placeholder="è¼¸å…¥æ–°ç—‡ç‹€" 
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg">
                            <button onclick="addSymptom()" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                                â• æ·»åŠ 
                            </button>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold mb-4">æ‰€æœ‰ç—‡ç‹€ (<span id="symptomCount">0</span>)</h3>
                        <div id="symptomsList" class="max-h-80 overflow-y-auto space-y-2"></div>
                    </div>
                </div>
            </div>

            <!-- è™•æ–¹ç®¡ç†æ¨™ç±¤é  -->
            <div id="prescriptionsContent" class="p-6 hidden">
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-bold mb-4">æ·»åŠ è™•æ–¹</h3>
                        <div class="space-y-3">
                            <input type="text" id="prescriptionName" placeholder="è™•æ–¹åç¨±" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <textarea id="prescriptionIngredients" placeholder="è—¥æçµ„æˆï¼ˆæ¯è¡Œä¸€å‘³è—¥ï¼‰" rows="4"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
                            <input type="text" id="prescriptionSymptoms" placeholder="é©ç”¨ç—‡ç‹€ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <button onclick="addPrescription()" 
                                    class="w-full bg-purple-500 hover:bg-purple-600 text-white py-2 rounded-lg">
                                â• æ·»åŠ è™•æ–¹
                            </button>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold mb-4">ç¾æœ‰è™•æ–¹ (<span id="prescriptionCount">0</span>)</h3>
                        <div id="prescriptionsList" class="max-h-80 overflow-y-auto space-y-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ•¸æ“šå­˜å„²
        let symptoms = JSON.parse(localStorage.getItem('tcm_symptoms') || '[]');
        let symptomGroups = JSON.parse(localStorage.getItem('tcm_symptom_groups') || '[]');
        let prescriptions = JSON.parse(localStorage.getItem('tcm_prescriptions') || '[]');

        // åˆå§‹åŒ–ç¤ºä¾‹æ•¸æ“š
        if (symptoms.length === 0) {
            symptoms = ['é ­ç—›', 'ç™¼ç†±', 'å’³å—½', 'è…¹ç—›', 'å¤±çœ ', 'ç–²å‹', 'é£Ÿæ…¾ä¸æŒ¯', 'å™å¿ƒ', 'åé ­ç—›', 'é ­æšˆ', 'é«˜ç†±', 'ä½ç†±', 'ä¹¾å’³', 'æ¿•å’³', 'èƒƒç—›', 'è…¹è„¹'];
            localStorage.setItem('tcm_symptoms', JSON.stringify(symptoms));
        }

        if (symptomGroups.length === 0) {
            symptomGroups = [
                {
                    name: 'é ­éƒ¨ç—‡ç‹€',
                    symptoms: ['é ­ç—›', 'åé ­ç—›', 'é ­æšˆ'],
                    color: 'red'
                },
                {
                    name: 'ç™¼ç†±ç—‡ç‹€',
                    symptoms: ['ç™¼ç†±', 'é«˜ç†±', 'ä½ç†±'],
                    color: 'orange'
                },
                {
                    name: 'å’³å—½ç—‡ç‹€',
                    symptoms: ['å’³å—½', 'ä¹¾å’³', 'æ¿•å’³'],
                    color: 'blue'
                },
                {
                    name: 'è…¸èƒƒç—‡ç‹€',
                    symptoms: ['è…¹ç—›', 'èƒƒç—›', 'è…¹è„¹', 'é£Ÿæ…¾ä¸æŒ¯', 'å™å¿ƒ'],
                    color: 'green'
                }
            ];
            localStorage.setItem('tcm_symptom_groups', JSON.stringify(symptomGroups));
        }

        if (prescriptions.length === 0) {
            prescriptions = [
                {
                    name: 'éŠ€ç¿¹æ•£',
                    ingredients: 'é‡‘éŠ€èŠ± 15g\né€£ç¿¹ 15g\nè–„è· 6g\nç‰›è’¡å­ 9g\næ¡”æ¢— 6g\nç”˜è‰ 5g',
                    symptoms: ['ç™¼ç†±', 'å’³å—½', 'é ­ç—›']
                },
                {
                    name: 'é€é™æ•£',
                    ingredients: 'æŸ´èƒ¡ 6g\nç•¶æ­¸ 9g\nç™½èŠ 9g\nç™½æœ® 9g\nèŒ¯è‹“ 9g\nç”˜è‰ 3g',
                    symptoms: ['è…¹ç—›', 'ç–²å‹', 'å¤±çœ ']
                },
                {
                    name: 'å¹³èƒƒæ•£',
                    ingredients: 'è’¼æœ® 12g\nåšæœ´ 9g\né™³çš® 6g\nç”˜è‰ 3g',
                    symptoms: ['è…¹ç—›', 'é£Ÿæ…¾ä¸æŒ¯', 'å™å¿ƒ']
                }
            ];
            localStorage.setItem('tcm_prescriptions', JSON.stringify(prescriptions));
        }

        // æ›´æ–°çµ±è¨ˆ
        function updateStats() {
            document.getElementById('symptomCount').textContent = symptoms.length;
            document.getElementById('prescriptionCount').textContent = prescriptions.length;
        }

        // æ¸²æŸ“ç—‡ç‹€åˆ†çµ„
        function renderSymptomGroups() {
            const container = document.getElementById('symptomGroupsList');
            const colorMap = {
                red: 'bg-red-100 text-red-800 border-red-300',
                blue: 'bg-blue-100 text-blue-800 border-blue-300',
                green: 'bg-green-100 text-green-800 border-green-300',
                orange: 'bg-orange-100 text-orange-800 border-orange-300',
                purple: 'bg-purple-100 text-purple-800 border-purple-300',
                pink: 'bg-pink-100 text-pink-800 border-pink-300'
            };
            
            container.innerHTML = symptomGroups.map((group, index) => `
                <div class="border-2 rounded-lg p-4 ${colorMap[group.color] || 'bg-gray-100 text-gray-800 border-gray-300'}">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-bold text-lg">${group.name}</h4>
                        <button onclick="removeSymptomGroup(${index})" 
                                class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm">
                            âŒ åˆªé™¤
                        </button>
                    </div>
                    <div class="text-sm font-medium">
                        ${group.symptoms.join('ã€')}
                    </div>
                </div>
            `).join('');
            
            // æ›´æ–°å¿«é€Ÿé¸æ“‡æŒ‰éˆ•
            renderQuickSelectGroups();
        }

        // æ¸²æŸ“å¿«é€Ÿé¸æ“‡åˆ†çµ„æŒ‰éˆ•
        function renderQuickSelectGroups() {
            const container = document.getElementById('quickSelectGroups');
            const colorMap = {
                red: 'bg-red-200 hover:bg-red-300 text-red-900',
                blue: 'bg-blue-200 hover:bg-blue-300 text-blue-900',
                green: 'bg-green-200 hover:bg-green-300 text-green-900',
                orange: 'bg-orange-200 hover:bg-orange-300 text-orange-900',
                purple: 'bg-purple-200 hover:bg-purple-300 text-purple-900',
                pink: 'bg-pink-200 hover:bg-pink-300 text-pink-900'
            };
            
            container.innerHTML = symptomGroups.map(group => `
                <button onclick="selectSymptomGroup('${group.name}')" 
                        class="px-4 py-2 rounded-lg font-medium transition duration-200 ${colorMap[group.color] || 'bg-gray-200 hover:bg-gray-300 text-gray-900'}">
                    ${group.name}
                </button>
            `).join('');
        }

        // æ¸²æŸ“ç—‡ç‹€åˆ—è¡¨
        function renderSymptoms() {
            const container = document.getElementById('symptomsList');
            container.innerHTML = symptoms.map((symptom, index) => `
                <div class="flex items-center justify-between bg-gray-100 px-4 py-3 rounded-lg">
                    <span class="text-gray-800 font-medium">${symptom}</span>
                    <button onclick="removeSymptom(${index})" 
                            class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm">
                        âŒ
                    </button>
                </div>
            `).join('');
        }

        // æ¸²æŸ“è™•æ–¹åˆ—è¡¨
        function renderPrescriptions() {
            const container = document.getElementById('prescriptionsList');
            container.innerHTML = prescriptions.map((prescription, index) => `
                <div class="bg-purple-50 border border-purple-200 p-4 rounded-lg">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="font-bold text-lg text-gray-800">${prescription.name}</h4>
                        <button onclick="removePrescription(${index})" 
                                class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm">
                            âŒ åˆªé™¤
                        </button>
                    </div>
                    <div class="mb-3">
                        <div class="font-medium text-gray-700 mb-1">ğŸ’Š è—¥æï¼š</div>
                        <div class="text-gray-600 bg-white p-2 rounded border text-sm">
                            ${prescription.ingredients.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                    <div>
                        <div class="font-medium text-gray-700 mb-1">ğŸ¯ é©ç”¨ç—‡ç‹€ï¼š</div>
                        <div class="text-gray-600">${prescription.symptoms.join('ã€')}</div>
                    </div>
                </div>
            `).join('');
        }

        // æ·»åŠ ç—‡ç‹€åˆ†çµ„
        function addSymptomGroup() {
            const name = document.getElementById('newGroupName').value.trim();
            const symptomsInput = document.getElementById('newGroupSymptoms').value.trim();
            const color = document.getElementById('groupColor').value;
            
            if (name && symptomsInput) {
                const groupSymptoms = symptomsInput.split(',').map(s => s.trim()).filter(s => s);
                
                // å°‡åˆ†çµ„ä¸­çš„ç—‡ç‹€æ·»åŠ åˆ°ç¸½ç—‡ç‹€åˆ—è¡¨ä¸­
                groupSymptoms.forEach(symptom => {
                    if (!symptoms.includes(symptom)) {
                        symptoms.push(symptom);
                    }
                });
                
                symptomGroups.push({
                    name: name,
                    symptoms: groupSymptoms,
                    color: color
                });
                
                localStorage.setItem('tcm_symptoms', JSON.stringify(symptoms));
                localStorage.setItem('tcm_symptom_groups', JSON.stringify(symptomGroups));
                
                // æ¸…ç©ºè¼¸å…¥æ¡†
                document.getElementById('newGroupName').value = '';
                document.getElementById('newGroupSymptoms').value = '';
                
                renderSymptomGroups();
                renderSymptoms();
                updateStats();
                enhancedAutoBackup();
            }
        }

        // åˆªé™¤ç—‡ç‹€åˆ†çµ„
        function removeSymptomGroup(index) {
            symptomGroups.splice(index, 1);
            localStorage.setItem('tcm_symptom_groups', JSON.stringify(symptomGroups));
            renderSymptomGroups();
            autoBackup();
        }

        // é¸æ“‡ç—‡ç‹€åˆ†çµ„ï¼ˆå¿«é€Ÿæ·»åŠ åˆ°æœç´¢æ¡†ï¼‰
        function selectSymptomGroup(groupName) {
            const searchInput = document.getElementById('symptomSearch');
            const currentValue = searchInput.value.trim();
            
            if (currentValue) {
                searchInput.value = currentValue + ',' + groupName;
            } else {
                searchInput.value = groupName;
            }
        }

        // æ·»åŠ ç—‡ç‹€
        function addSymptom() {
            const input = document.getElementById('newSymptom');
            const symptom = input.value.trim();
            
            if (symptom && !symptoms.includes(symptom)) {
                symptoms.push(symptom);
                localStorage.setItem('tcm_symptoms', JSON.stringify(symptoms));
                input.value = '';
                renderSymptoms();
                updateStats();
                enhancedAutoBackup();
            }
        }

        // åˆªé™¤ç—‡ç‹€
        function removeSymptom(index) {
            symptoms.splice(index, 1);
            localStorage.setItem('tcm_symptoms', JSON.stringify(symptoms));
            renderSymptoms();
            updateStats();
            autoBackup();
        }

        // æ·»åŠ è™•æ–¹
        function addPrescription() {
            const name = document.getElementById('prescriptionName').value.trim();
            const ingredients = document.getElementById('prescriptionIngredients').value.trim();
            const symptomsInput = document.getElementById('prescriptionSymptoms').value.trim();
            
            if (name && ingredients && symptomsInput) {
                const prescriptionSymptoms = symptomsInput.split(',').map(s => s.trim()).filter(s => s);
                
                prescriptions.push({
                    name: name,
                    ingredients: ingredients,
                    symptoms: prescriptionSymptoms
                });
                
                localStorage.setItem('tcm_prescriptions', JSON.stringify(prescriptions));
                
                // æ¸…ç©ºè¼¸å…¥æ¡†
                document.getElementById('prescriptionName').value = '';
                document.getElementById('prescriptionIngredients').value = '';
                document.getElementById('prescriptionSymptoms').value = '';
                
                renderPrescriptions();
                updateStats();
                enhancedAutoBackup();
            }
        }

        // åˆªé™¤è™•æ–¹
        function removePrescription(index) {
            prescriptions.splice(index, 1);
            localStorage.setItem('tcm_prescriptions', JSON.stringify(prescriptions));
            renderPrescriptions();
            updateStats();
            autoBackup();
        }

        // æœç´¢è™•æ–¹
        function searchPrescriptions() {
            const searchInput = document.getElementById('symptomSearch').value.trim();
            if (!searchInput) return;
            
            const searchTerms = searchInput.split(',').map(s => s.trim()).filter(s => s);
            let allSearchSymptoms = [];
            
            // è™•ç†æœç´¢è©ï¼ŒåŒ…æ‹¬ç—‡ç‹€åˆ†çµ„
            searchTerms.forEach(term => {
                const termLower = term.toLowerCase();
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºç—‡ç‹€åˆ†çµ„
                const matchingGroup = symptomGroups.find(group => 
                    group.name.toLowerCase() === termLower
                );
                
                if (matchingGroup) {
                    // å¦‚æœæ˜¯åˆ†çµ„ï¼Œæ·»åŠ åˆ†çµ„ä¸­çš„æ‰€æœ‰ç—‡ç‹€
                    allSearchSymptoms.push(...matchingGroup.symptoms.map(s => s.toLowerCase()));
                } else {
                    // å¦‚æœä¸æ˜¯åˆ†çµ„ï¼Œç›´æ¥æ·»åŠ ç—‡ç‹€
                    allSearchSymptoms.push(termLower);
                }
            });
            
            // å»é‡
            allSearchSymptoms = [...new Set(allSearchSymptoms)];
            
            const results = [];
            
            prescriptions.forEach(prescription => {
                const matchCount = prescription.symptoms.filter(symptom => 
                    allSearchSymptoms.some(searchSymptom => 
                        symptom.toLowerCase().includes(searchSymptom)
                    )
                ).length;
                
                if (matchCount > 0) {
                    results.push({
                        ...prescription,
                        matchCount: matchCount,
                        matchPercentage: (matchCount / allSearchSymptoms.length * 100).toFixed(0)
                    });
                }
            });
            
            // æŒ‰åŒ¹é…åº¦æ’åº
            results.sort((a, b) => b.matchCount - a.matchCount);
            
            // é¡¯ç¤ºçµæœ
            const resultsContainer = document.getElementById('searchResults');
            const resultsList = document.getElementById('resultsList');
            
            if (results.length > 0) {
                resultsList.innerHTML = results.map(result => `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-xl font-bold text-gray-800">${result.name}</h4>
                            <span class="bg-green-500 text-white text-sm px-3 py-1 rounded-full">
                                ${result.matchPercentage}% åŒ¹é…
                            </span>
                        </div>
                        <div class="mb-3">
                            <div class="text-gray-700 font-medium mb-1">ğŸ’Š è—¥æçµ„æˆï¼š</div>
                            <div class="text-gray-600 bg-white p-3 rounded border">
                                ${result.ingredients.replace(/\n/g, '<br>')}
                            </div>
                        </div>
                        <div>
                            <div class="text-gray-700 font-medium mb-1">ğŸ¯ é©ç”¨ç—‡ç‹€ï¼š</div>
                            <div class="text-gray-600">${result.symptoms.join('ã€')}</div>
                        </div>
                    </div>
                `).join('');
                resultsContainer.classList.remove('hidden');
            } else {
                resultsList.innerHTML = '<div class="text-gray-500 text-center py-8 text-lg">ğŸ˜” æœªæ‰¾åˆ°ç›¸é—œè™•æ–¹</div>';
                resultsContainer.classList.remove('hidden');
            }
        }

        // å›è»Šæœç´¢
        document.getElementById('symptomSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchPrescriptions();
            }
        });

        // å›è»Šæ·»åŠ 
        document.getElementById('newSymptom').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addSymptom();
            }
        });

        // æ¨™ç±¤é åˆ‡æ›åŠŸèƒ½
        function showTab(tabName) {
            // éš±è—æ‰€æœ‰å…§å®¹
            document.getElementById('groupsContent').classList.add('hidden');
            document.getElementById('symptomsContent').classList.add('hidden');
            document.getElementById('prescriptionsContent').classList.add('hidden');
            
            // é‡ç½®æ‰€æœ‰æ¨™ç±¤æ¨£å¼
            document.getElementById('groupsTab').className = 'flex-1 py-3 px-4 text-center font-medium text-gray-500 hover:text-gray-700';
            document.getElementById('symptomsTab').className = 'flex-1 py-3 px-4 text-center font-medium text-gray-500 hover:text-gray-700';
            document.getElementById('prescriptionsTab').className = 'flex-1 py-3 px-4 text-center font-medium text-gray-500 hover:text-gray-700';
            
            // é¡¯ç¤ºé¸ä¸­çš„å…§å®¹å’Œæ¨™ç±¤
            document.getElementById(tabName + 'Content').classList.remove('hidden');
            document.getElementById(tabName + 'Tab').className = 'flex-1 py-3 px-4 text-center font-medium border-b-2 border-green-500 text-green-600';
        }

        // æ•¸æ“šå‚™ä»½å’Œæ¢å¾©åŠŸèƒ½
        function exportData() {
            const data = {
                symptoms: symptoms,
                symptomGroups: symptomGroups,
                prescriptions: prescriptions,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `ä¸­é†«è™•æ–¹æ•¸æ“š_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            alert('âœ… æ•¸æ“šå·²æˆåŠŸå‚™ä»½åˆ°ä¸‹è¼‰æ–‡ä»¶å¤¾ï¼');
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // é©—è­‰æ•¸æ“šæ ¼å¼
                    if (data.symptoms && data.symptomGroups && data.prescriptions) {
                        symptoms = data.symptoms;
                        symptomGroups = data.symptomGroups;
                        prescriptions = data.prescriptions;
                        
                        // ä¿å­˜åˆ°æœ¬åœ°å­˜å„²
                        localStorage.setItem('tcm_symptoms', JSON.stringify(symptoms));
                        localStorage.setItem('tcm_symptom_groups', JSON.stringify(symptomGroups));
                        localStorage.setItem('tcm_prescriptions', JSON.stringify(prescriptions));
                        
                        // é‡æ–°æ¸²æŸ“ç•Œé¢
                        renderSymptomGroups();
                        renderSymptoms();
                        renderPrescriptions();
                        updateStats();
                        
                        alert('âœ… æ•¸æ“šæ¢å¾©æˆåŠŸï¼');
                    } else {
                        alert('âŒ æ–‡ä»¶æ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹é¸æ“‡æ­£ç¢ºçš„å‚™ä»½æ–‡ä»¶ï¼');
                    }
                } catch (error) {
                    alert('âŒ æ–‡ä»¶è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ–‡ä»¶æ˜¯å¦æå£ï¼');
                }
            };
            reader.readAsText(file);
            
            // æ¸…ç©ºæ–‡ä»¶é¸æ“‡å™¨
            event.target.value = '';
        }
        
        function clearAllData() {
            if (confirm('âš ï¸ ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ•¸æ“šå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ï¼\n\nå»ºè­°å…ˆå‚™ä»½æ•¸æ“šå†é€²è¡Œæ¸…ç©ºæ“ä½œã€‚')) {
                localStorage.removeItem('tcm_symptoms');
                localStorage.removeItem('tcm_symptom_groups');
                localStorage.removeItem('tcm_prescriptions');
                
                symptoms = [];
                symptomGroups = [];
                prescriptions = [];
                
                renderSymptomGroups();
                renderSymptoms();
                renderPrescriptions();
                updateStats();
                
                // éš±è—æœç´¢çµæœ
                document.getElementById('searchResults').classList.add('hidden');
                document.getElementById('symptomSearch').value = '';
                
                alert('âœ… æ‰€æœ‰æ•¸æ“šå·²æ¸…ç©ºï¼');
            }
        }
        
        // è‡ªå‹•å‚™ä»½åŠŸèƒ½ï¼ˆæ¯æ¬¡æ•¸æ“šè®Šæ›´æ™‚ï¼‰
        function autoBackup() {
            const data = {
                symptoms: symptoms,
                symptomGroups: symptomGroups,
                prescriptions: prescriptions,
                lastBackup: new Date().toISOString()
            };
            localStorage.setItem('tcm_auto_backup', JSON.stringify(data));
        }
        
        // æª¢æŸ¥ä¸¦æ¢å¾©è‡ªå‹•å‚™ä»½
        function checkAutoBackup() {
            const backup = localStorage.getItem('tcm_auto_backup');
            if (backup) {
                try {
                    const data = JSON.parse(backup);
                    const backupDate = new Date(data.lastBackup);
                    const now = new Date();
                    const daysDiff = (now - backupDate) / (1000 * 60 * 60 * 24);
                    
                    // å¦‚æœå‚™ä»½è¶…é7å¤©ï¼Œæé†’ç”¨æˆ¶
                    if (daysDiff > 7) {
                        if (confirm('ğŸ’¡ æª¢æ¸¬åˆ°æ‚¨çš„æ•¸æ“šå·²ç¶“è¶…é7å¤©æœªå‚™ä»½ï¼Œå»ºè­°ç«‹å³å‚™ä»½æ•¸æ“šä»¥é˜²ä¸Ÿå¤±ã€‚\n\næ˜¯å¦ç¾åœ¨å‚™ä»½ï¼Ÿ')) {
                            exportData();
                        }
                    }
                } catch (error) {
                    console.log('è‡ªå‹•å‚™ä»½æª¢æŸ¥å¤±æ•—');
                }
            }
        }

        // é›²ç«¯å­˜å„²åŠŸèƒ½ï¼ˆä½¿ç”¨ç€è¦½å™¨çš„IndexedDBä½œç‚ºæŒä¹…åŒ–å­˜å„²ï¼‰
        let db;
        
        // åˆå§‹åŒ–IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('TCMDatabase', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('backups')) {
                        const store = db.createObjectStore('backups', { keyPath: 'id' });
                        store.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                };
            });
        }
        
        // ä¿å­˜åˆ°é›²ç«¯ï¼ˆå¯¦éš›æ˜¯IndexedDBæŒä¹…åŒ–å­˜å„²ï¼‰
        async function saveToCloud() {
            try {
                showStatus('æ­£åœ¨ä¿å­˜åˆ°é›²ç«¯...', 'info');
                
                if (!db) await initDB();
                
                const data = {
                    id: 'main_backup',
                    symptoms: symptoms,
                    symptomGroups: symptomGroups,
                    prescriptions: prescriptions,
                    timestamp: new Date().toISOString(),
                    version: '1.0'
                };
                
                const transaction = db.transaction(['backups'], 'readwrite');
                const store = transaction.objectStore('backups');
                await store.put(data);
                
                // åŒæ™‚å‰µå»ºä¸€å€‹å¸¶æ™‚é–“æˆ³çš„æ­·å²å‚™ä»½
                const historyData = {
                    ...data,
                    id: `backup_${Date.now()}`
                };
                await store.put(historyData);
                
                showStatus('âœ… æ•¸æ“šå·²æˆåŠŸä¿å­˜åˆ°é›²ç«¯ï¼', 'success');
                
                // è‡ªå‹•æ¸…ç†è¶…é30å¤©çš„æ­·å²å‚™ä»½
                cleanOldBackups();
                
            } catch (error) {
                showStatus('âŒ é›²ç«¯ä¿å­˜å¤±æ•—ï¼š' + error.message, 'error');
            }
        }
        
        // å¾é›²ç«¯è¼‰å…¥
        async function loadFromCloud() {
            try {
                showStatus('æ­£åœ¨å¾é›²ç«¯è¼‰å…¥...', 'info');
                
                if (!db) await initDB();
                
                const transaction = db.transaction(['backups'], 'readonly');
                const store = transaction.objectStore('backups');
                const request = store.get('main_backup');
                
                request.onsuccess = () => {
                    const data = request.result;
                    if (data) {
                        symptoms = data.symptoms || [];
                        symptomGroups = data.symptomGroups || [];
                        prescriptions = data.prescriptions || [];
                        
                        // ä¿å­˜åˆ°æœ¬åœ°å­˜å„²
                        localStorage.setItem('tcm_symptoms', JSON.stringify(symptoms));
                        localStorage.setItem('tcm_symptom_groups', JSON.stringify(symptomGroups));
                        localStorage.setItem('tcm_prescriptions', JSON.stringify(prescriptions));
                        
                        // é‡æ–°æ¸²æŸ“ç•Œé¢
                        renderSymptomGroups();
                        renderSymptoms();
                        renderPrescriptions();
                        updateStats();
                        
                        showStatus('âœ… æ•¸æ“šå·²å¾é›²ç«¯æˆåŠŸè¼‰å…¥ï¼', 'success');
                    } else {
                        showStatus('âš ï¸ é›²ç«¯æ²’æœ‰æ‰¾åˆ°å‚™ä»½æ•¸æ“š', 'warning');
                    }
                };
                
                request.onerror = () => {
                    showStatus('âŒ é›²ç«¯è¼‰å…¥å¤±æ•—ï¼š' + request.error, 'error');
                };
                
            } catch (error) {
                showStatus('âŒ é›²ç«¯è¼‰å…¥å¤±æ•—ï¼š' + error.message, 'error');
            }
        }
        
        // é¡¯ç¤ºé›²ç«¯ç‹€æ…‹
        async function showCloudStatus() {
            try {
                if (!db) await initDB();
                
                const transaction = db.transaction(['backups'], 'readonly');
                const store = transaction.objectStore('backups');
                
                // ç²å–ä¸»å‚™ä»½
                const mainRequest = store.get('main_backup');
                
                // ç²å–æ‰€æœ‰æ­·å²å‚™ä»½
                const allRequest = store.getAll();
                
                Promise.all([
                    new Promise(resolve => { mainRequest.onsuccess = () => resolve(mainRequest.result); }),
                    new Promise(resolve => { allRequest.onsuccess = () => resolve(allRequest.result); })
                ]).then(([mainBackup, allBackups]) => {
                    let statusText = '';
                    
                    if (mainBackup) {
                        const lastSync = new Date(mainBackup.timestamp);
                        statusText += `ğŸ“… æœ€å¾ŒåŒæ­¥ï¼š${lastSync.toLocaleString('zh-TW')}\n`;
                        statusText += `ğŸ“Š ç—‡ç‹€æ•¸é‡ï¼š${mainBackup.symptoms?.length || 0}\n`;
                        statusText += `ğŸ“‹ åˆ†çµ„æ•¸é‡ï¼š${mainBackup.symptomGroups?.length || 0}\n`;
                        statusText += `ğŸ’Š è™•æ–¹æ•¸é‡ï¼š${mainBackup.prescriptions?.length || 0}\n`;
                    } else {
                        statusText += 'âš ï¸ å°šæœªé€²è¡Œé›²ç«¯å‚™ä»½\n';
                    }
                    
                    const historyBackups = allBackups.filter(b => b.id !== 'main_backup');
                    statusText += `ğŸ—‚ï¸ æ­·å²å‚™ä»½ï¼š${historyBackups.length} å€‹\n`;
                    
                    // è¨ˆç®—å­˜å„²ä½¿ç”¨æƒ…æ³
                    const dataSize = JSON.stringify(allBackups).length;
                    statusText += `ğŸ’¾ å­˜å„²ä½¿ç”¨ï¼š${(dataSize / 1024).toFixed(1)} KB`;
                    
                    showStatus(statusText, 'info', 8000);
                });
                
            } catch (error) {
                showStatus('âŒ ç„¡æ³•ç²å–é›²ç«¯ç‹€æ…‹ï¼š' + error.message, 'error');
            }
        }
        
        // æ¸…ç†èˆŠå‚™ä»½
        async function cleanOldBackups() {
            try {
                if (!db) return;
                
                const transaction = db.transaction(['backups'], 'readwrite');
                const store = transaction.objectStore('backups');
                const index = store.index('timestamp');
                
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                const range = IDBKeyRange.upperBound(thirtyDaysAgo.toISOString());
                const request = index.openCursor(range);
                
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        if (cursor.value.id !== 'main_backup') {
                            cursor.delete();
                        }
                        cursor.continue();
                    }
                };
            } catch (error) {
                console.log('æ¸…ç†èˆŠå‚™ä»½å¤±æ•—ï¼š', error);
            }
        }
        
        // é¡¯ç¤ºç‹€æ…‹ä¿¡æ¯
        function showStatus(message, type = 'info', duration = 3000) {
            const statusDiv = document.getElementById('backupStatus');
            statusDiv.classList.remove('hidden', 'bg-blue-50', 'bg-green-50', 'bg-red-50', 'bg-yellow-50');
            statusDiv.classList.remove('text-blue-600', 'text-green-600', 'text-red-600', 'text-yellow-600');
            
            switch (type) {
                case 'success':
                    statusDiv.classList.add('bg-green-50', 'text-green-600');
                    break;
                case 'error':
                    statusDiv.classList.add('bg-red-50', 'text-red-600');
                    break;
                case 'warning':
                    statusDiv.classList.add('bg-yellow-50', 'text-yellow-600');
                    break;
                default:
                    statusDiv.classList.add('bg-blue-50', 'text-blue-600');
            }
            
            statusDiv.innerHTML = message.replace(/\n/g, '<br>');
            
            if (duration > 0) {
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, duration);
            }
        }
        
        // å¢å¼·çš„è‡ªå‹•å‚™ä»½ï¼ˆåŒæ™‚å‚™ä»½åˆ°é›²ç«¯ï¼‰
        async function enhancedAutoBackup() {
            autoBackup(); // æœ¬åœ°å‚™ä»½
            
            // æ¯10æ¬¡æ“ä½œè‡ªå‹•é›²ç«¯å‚™ä»½ä¸€æ¬¡
            const operationCount = parseInt(localStorage.getItem('tcm_operation_count') || '0') + 1;
            localStorage.setItem('tcm_operation_count', operationCount.toString());
            
            if (operationCount % 10 === 0) {
                try {
                    await saveToCloud();
                } catch (error) {
                    console.log('è‡ªå‹•é›²ç«¯å‚™ä»½å¤±æ•—ï¼š', error);
                }
            }
        }

        // åˆå§‹åŒ–é é¢
        async function initApp() {
            await initDB();
            renderSymptomGroups();
            renderSymptoms();
            renderPrescriptions();
            updateStats();
            checkAutoBackup();
        }
        
        // æ‰¹é‡å°å…¥åŠŸèƒ½
        function downloadTemplate() {
            const template = `ç•¶æ­¸ï¼šè¡€è™›,æœˆç¶“ä¸èª¿,ä¾¿ç§˜
é»ƒèŠªï¼šæ°£è™›,ç–²å‹,è‡ªæ±—
ç”˜è‰ï¼šå’³å—½,èƒƒç—›,è§£æ¯’
äººåƒï¼šæ°£è™›,å¿ƒæ‚¸,å¤±çœ 
ç™½æœ®ï¼šè„¾è™›,è…¹è„¹,æ³„ç€‰
èŒ¯è‹“ï¼šæ°´è…«,å¤±çœ ,å¿ƒæ‚¸
å·èŠï¼šé ­ç—›,æœˆç¶“ä¸èª¿,èƒ¸ç—›
ç™½èŠï¼šè…¹ç—›,æœˆç¶“ä¸èª¿,è‚é¬±
ç†Ÿåœ°é»ƒï¼šè¡€è™›,è…è™›,é ­æšˆ
ä½•é¦–çƒï¼šè¡€è™›,è„«é«®,ä¾¿ç§˜`;
            
            const blob = new Blob([template], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'ä¸­è—¥ç—‡ç‹€å°å…¥æ¨¡æ¿.txt';
            link.click();
            
            showStatus('âœ… æ¨¡æ¿æ–‡ä»¶å·²ä¸‹è¼‰ï¼è«‹æŒ‰ç…§æ ¼å¼å¡«å¯«å¾Œå°å…¥ã€‚', 'success');
        }
        
        function loadBulkImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('bulkImportText').value = e.target.result;
                showStatus('âœ… æ–‡ä»¶å…§å®¹å·²è¼‰å…¥åˆ°æ–‡æœ¬æ¡†ï¼', 'success');
            };
            reader.readAsText(file, 'UTF-8');
            
            // æ¸…ç©ºæ–‡ä»¶é¸æ“‡å™¨
            event.target.value = '';
        }
        
        function clearBulkImport() {
            document.getElementById('bulkImportText').value = '';
            updateCharCount();
            showStatus('ğŸ§¹ è¼¸å…¥æ¡†å·²æ¸…ç©º', 'info');
        }
        
        // æ›´æ–°å­—æ•¸çµ±è¨ˆ
        function updateCharCount() {
            const textarea = document.getElementById('bulkImportText');
            const charCountDiv = document.getElementById('charCount');
            const currentLength = textarea.value.length;
            const maxLength = 100000;
            
            charCountDiv.textContent = `å­—æ•¸ï¼š${currentLength.toLocaleString()} / ${maxLength.toLocaleString()}`;
            
            // æ ¹æ“šå­—æ•¸è®ŠåŒ–é¡è‰²
            if (currentLength > maxLength * 0.9) {
                charCountDiv.className = 'text-sm text-red-500 font-medium';
            } else if (currentLength > maxLength * 0.7) {
                charCountDiv.className = 'text-sm text-yellow-600 font-medium';
            } else {
                charCountDiv.className = 'text-sm text-gray-500';
            }
        }
        
        function processBulkImport() {
            const text = document.getElementById('bulkImportText').value.trim();
            if (!text) {
                showStatus('âš ï¸ è«‹å…ˆè¼¸å…¥æˆ–é¸æ“‡è¦å°å…¥çš„å…§å®¹ï¼', 'warning');
                return;
            }
            
            // æª¢æŸ¥æ•¸æ“šå¤§å°
            const textLength = text.length;
            if (textLength > 100000) {
                showStatus('âŒ æ•¸æ“šéå¤§ï¼è«‹åˆ†æ‰¹å°å…¥æˆ–æ¸›å°‘å…§å®¹ï¼ˆç•¶å‰ï¼š' + textLength.toLocaleString() + ' å­—ï¼‰', 'error');
                return;
            }
            
            showStatus('âš¡ æ­£åœ¨è™•ç†å¤§é‡æ•¸æ“šï¼Œè«‹ç¨å€™...', 'info');
            
            // ä½¿ç”¨ setTimeout é¿å…é˜»å¡ UI
            setTimeout(() => {
                const lines = text.split('\n').filter(line => line.trim());
                let successCount = 0;
                let errorCount = 0;
                let newSymptoms = [];
                let newPrescriptions = [];
                let errorMessages = [];
                
                // æ‰¹é‡è™•ç†ï¼Œæ¯æ¬¡è™•ç†100è¡Œ
                const batchSize = 100;
                let currentBatch = 0;
                
                function processBatch() {
                    const start = currentBatch * batchSize;
                    const end = Math.min(start + batchSize, lines.length);
                    
                        const line = lines[i];
                        const trimmedLine = line.trim();
                        if (!trimmedLine) continue;
                        
                        // æ”¯æŒå¤šç¨®åˆ†éš”ç¬¦ï¼šå†’è™Ÿã€å…¨å½¢å†’è™Ÿ
                        const separators = ['ï¼š', ':'];
                        let separator = null;
                        let parts = null;
                        
                        for (let sep of separators) {
                            if (trimmedLine.includes(sep)) {
                                parts = trimmedLine.split(sep);
                                separator = sep;
                                break;
                            }
                        }
                        
                        if (!parts || parts.length !== 2) {
                            errorMessages.push(`ç¬¬${i + 1}è¡Œæ ¼å¼éŒ¯èª¤ï¼š${trimmedLine}`);
                            errorCount++;
                            continue;
                        }
                        
                        const herbName = parts[0].trim();
                        const symptomsText = parts[1].trim();
                        
                        if (!herbName || !symptomsText) {
                            errorMessages.push(`ç¬¬${i + 1}è¡Œå…§å®¹ä¸å®Œæ•´ï¼š${trimmedLine}`);
                            errorCount++;
                            continue;
                        }
                        
                        // è§£æç—‡ç‹€ï¼Œæ”¯æŒå¤šç¨®åˆ†éš”ç¬¦
                        const symptomSeparators = [',', 'ï¼Œ', ';', 'ï¼›', 'ã€'];
                        let herbSymptoms = [symptomsText];
                        
                        for (let sep of symptomSeparators) {
                            if (symptomsText.includes(sep)) {
                                herbSymptoms = symptomsText.split(sep).map(s => s.trim()).filter(s => s);
                                break;
                            }
                        }
                        
                        // æ·»åŠ ç—‡ç‹€åˆ°ç¸½åˆ—è¡¨
                        herbSymptoms.forEach(symptom => {
                            if (symptom && !symptoms.includes(symptom)) {
                                symptoms.push(symptom);
                                newSymptoms.push(symptom);
                            }
                        });
                        
                        // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåè™•æ–¹
                        const existingIndex = prescriptions.findIndex(p => p.name === herbName);
                        
                        if (existingIndex >= 0) {
                            // æ›´æ–°ç¾æœ‰è™•æ–¹çš„ç—‡ç‹€
                            const existingSymptoms = prescriptions[existingIndex].symptoms;
                            const combinedSymptoms = [...new Set([...existingSymptoms, ...herbSymptoms])];
                            prescriptions[existingIndex].symptoms = combinedSymptoms;
                        } else {
                            // å‰µå»ºæ–°è™•æ–¹
                            const newPrescription = {
                                name: herbName,
                                ingredients: `${herbName} é©é‡\nï¼ˆè«‹è«®è©¢ä¸­é†«å¸«ç¢ºå®šå…·é«”ç”¨é‡ï¼‰`,
                                symptoms: herbSymptoms
                            };
                            prescriptions.push(newPrescription);
                            newPrescriptions.push(herbName);
                        }
                        
                        successCount++;
                    }
                    
                    currentBatch++;
                    
                    // æ›´æ–°é€²åº¦
                    const progress = Math.round((end / lines.length) * 100);
                    showStatus(`âš¡ è™•ç†é€²åº¦ï¼š${progress}% (${end}/${lines.length})`, 'info');
                    
                    // å¦‚æœé‚„æœ‰æ›´å¤šæ‰¹æ¬¡ï¼Œç¹¼çºŒè™•ç†
                    if (end < lines.length) {
                        setTimeout(processBatch, 10); // çŸ­æš«å»¶é²é¿å…é˜»å¡
                    } else {
                        // è™•ç†å®Œæˆï¼Œä¿å­˜æ•¸æ“šä¸¦é¡¯ç¤ºçµæœ
                        finishImport();
                    }
                }
                
                function finishImport() {
                    // ä¿å­˜æ•¸æ“š
                    localStorage.setItem('tcm_symptoms', JSON.stringify(symptoms));
                    localStorage.setItem('tcm_prescriptions', JSON.stringify(prescriptions));
                    
                    // é‡æ–°æ¸²æŸ“ç•Œé¢
                    renderSymptoms();
                    renderPrescriptions();
                    updateStats();
                    enhancedAutoBackup();
                    
                    // é¡¯ç¤ºå°å…¥çµæœ
                    let resultMessage = `ğŸ“Š å°å…¥å®Œæˆï¼\n`;
                    resultMessage += `âœ… æˆåŠŸè™•ç†ï¼š${successCount} æ¢\n`;
                    resultMessage += `ğŸ“ æ–°å¢ç—‡ç‹€ï¼š${newSymptoms.length} å€‹\n`;
                    resultMessage += `ğŸ’Š æ–°å¢/æ›´æ–°è™•æ–¹ï¼š${newPrescriptions.length} å€‹\n`;
                    
                    if (errorCount > 0) {
                        resultMessage += `âŒ éŒ¯èª¤ï¼š${errorCount} æ¢\n`;
                        if (errorMessages.length > 0) {
                            resultMessage += `\néŒ¯èª¤è©³æƒ…ï¼š\n${errorMessages.slice(0, 5).join('\n')}`;
                            if (errorMessages.length > 5) {
                                resultMessage += `\n...é‚„æœ‰ ${errorMessages.length - 5} å€‹éŒ¯èª¤`;
                            }
                        }
                    }
                    
                    showStatus(resultMessage, successCount > 0 ? 'success' : 'error', 10000);
                    
                    // æ¸…ç©ºè¼¸å…¥æ¡†
                    if (successCount > 0) {
                        document.getElementById('bulkImportText').value = '';
                        updateCharCount();
                    }
                }
                
                // é–‹å§‹è™•ç†ç¬¬ä¸€æ‰¹
                processBatch();
                
            }, 100); // å»¶é²100msé–‹å§‹è™•ç†
        }

        // å•Ÿå‹•æ‡‰ç”¨
        initApp();
        
        // ç›£è½æ–‡æœ¬æ¡†è¼¸å…¥ï¼Œå¯¦æ™‚æ›´æ–°å­—æ•¸çµ±è¨ˆ
        document.getElementById('bulkImportText').addEventListener('input', updateCharCount);
        document.getElementById('bulkImportText').addEventListener('paste', function() {
            setTimeout(updateCharCount, 10); // å»¶é²ä¸€é»ç¢ºä¿ç²˜è²¼å…§å®¹å·²è™•ç†
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'964a675ae4bb1082',t:'MTc1MzQzMzM2My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
