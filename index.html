<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­è—¥è³‡æ–™åº« - é›²ç«¯ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, push, onValue, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBtUcrBYiE4B1O4xkvIqwxM52Hrh-i6pL8",
            authDomain: "cheungec-ea477.firebaseapp.com",
            databaseURL: "https://cheungec-ea477-default-rtdb.firebaseio.com/",
            projectId: "cheungec-ea477",
            storageBucket: "cheungec-ea477.firebasestorage.app",
            messagingSenderId: "986510230799",
            appId: "1:986510230799:web:f603e67b605e71294f2a7a"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Make Firebase functions globally available
        window.firebaseDB = {
            ref: ref,
            set: set,
            get: get,
            push: push,
            onValue: onValue,
            remove: remove,
            database: database
        };
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .search-result:hover {
            transform: translateY(-2px);
            transition: all 0.2s ease;
        }
        .loading {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-lg border-b-4 border-green-500">
        <div class="max-w-6xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-green-600 to-green-700 rounded-lg flex items-center justify-center">
                        <span class="text-white font-bold text-lg">ä¸­</span>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">ä¸­è—¥è³‡æ–™åº«</h1>
                        <p class="text-sm text-gray-600">é›²ç«¯å…±äº«ç‰ˆ - å³æ™‚åŒæ­¥</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="connectionStatus" class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-yellow-500 rounded-full animate-pulse"></div>
                        <span class="text-sm text-gray-600">é€£ç·šä¸­...</span>
                    </div>
                    <div class="text-sm text-gray-600">
                        å°ˆæ¥­ç‰ˆ v2.0
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-6xl mx-auto px-6 py-8">
        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="text-center py-8">
            <div class="loading text-gray-600">æ­£åœ¨è¼‰å…¥é›²ç«¯è³‡æ–™...</div>
        </div>

        <!-- Main Content Grid -->
        <div id="mainContent" class="grid grid-cols-1 lg:grid-cols-3 gap-8 hidden">
            
            <!-- Left Panel - Search -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Search Section -->
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        æ™ºèƒ½æœå°‹
                    </h2>
                    
                    <div class="relative mb-4">
                        <input 
                            type="text" 
                            id="searchInput" 
                            placeholder="è¼¸å…¥ç—‡ç‹€æˆ–ä¸­è—¥åç¨±é€²è¡Œæœå°‹..."
                            class="w-full px-4 py-3 pl-12 border-2 border-gray-200 rounded-lg focus:border-green-500 focus:outline-none transition-colors text-gray-700"
                        >
                        <svg class="w-5 h-5 text-gray-400 absolute left-4 top-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>

                    <div class="flex space-x-3 mb-4">
                        <button id="searchBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                            æœå°‹
                        </button>
                        <button id="clearBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                            æ¸…é™¤
                        </button>
                    </div>
                </div>

                <!-- Search Results -->
                <div id="searchResults" class="bg-white rounded-xl shadow-lg border border-gray-100 hidden">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">æœå°‹çµæœ</h3>
                        <div id="resultsContainer"></div>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Data Import -->
            <div class="space-y-6">
                <!-- Data Import Section -->
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                        æ™ºèƒ½è³‡æ–™å°å…¥ (é›²ç«¯åŒæ­¥)
                    </h2>
                    
                    <!-- Smart Input Area -->
                    <div class="mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <label class="text-sm font-medium text-gray-700">
                                ğŸ¤– è‡ªå‹•è­˜åˆ¥æ ¼å¼
                            </label>
                            <div id="formatHint" class="text-xs text-gray-500"></div>
                        </div>
                        <textarea 
                            id="importData" 
                            placeholder="âœ… æ”¯æ´æ‰€æœ‰æ¨™é»ç¬¦è™Ÿåˆ†éš”ï¼Œè‡ªå‹•æ™ºèƒ½è­˜åˆ¥ï¼š&#10;ç•¶æ­¸ï¼šè£œè¡€èª¿ç¶“ï¼Œæ´»è¡€æ­¢ç—›ã€‚æ½¤è…¸é€šä¾¿ï¼&#10;é»ƒèŠª,è£œæ°£å›ºè¡¨ã€åˆ©å°¿æ‰˜æ¯’ï¼›æ’è†¿&#10;äººåƒ	å¤§è£œå…ƒæ°£ï¼Ÿå¾©è„ˆå›ºè„«â€¦ç”Ÿæ´¥é¤Šè¡€&#10;ç”˜è‰ èª¿å’Œè«¸è—¥|è£œè„¾ç›Šæ°£/æ¸…ç†±è§£æ¯’&#10;å·èŠâ†’æ´»è¡€è¡Œæ°£ï¼¼ç¥›é¢¨æ­¢ç—›&#10;ç™½èŠ[é¤Šè¡€æŸ”è‚ï¼›ç·©ä¸­æ­¢ç—›]&#10;èŒ¯è‹“ã€Œå¥è„¾åˆ©æ°´ã€ã€Œå¯§å¿ƒå®‰ç¥ã€&#10;ç†Ÿåœ°é»ƒã€Šæ»‹é™°è£œè¡€ã€‹ã€Šç›Šç²¾å¡«é«“ã€‹&#10;æ¨™é»ç¬¦è™Ÿæœƒè‡ªå‹•æ¸…ç†ï¼Œç„¡éœ€æ‰‹å‹•è™•ç†..."
                            class="w-full h-32 px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none transition-colors resize-none text-sm"
                        ></textarea>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="space-y-2">
                        <button id="importBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-medium transition-colors">
                            â¬†ï¸ æ™ºèƒ½å°å…¥åˆ°é›²ç«¯
                        </button>
                        
                        <!-- Progress Bar -->
                        <div id="progressContainer" class="hidden bg-gray-100 rounded-lg p-4 border">
                            <div class="flex items-center justify-between mb-2">
                                <span id="progressText" class="text-sm text-gray-700">æº–å‚™å°å…¥...</span>
                                <span id="progressPercent" class="text-sm font-medium text-blue-600">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <button id="clearAllBtn" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg font-medium transition-colors text-sm">
                            ğŸ—‘ï¸ æ¸…ç©ºè¼¸å…¥è³‡æ–™
                        </button>
                        <button id="clearDatabaseBtn" class="w-full bg-red-700 hover:bg-red-800 text-white py-2 rounded-lg font-medium transition-colors text-sm mt-2">
                            ğŸ’¥ æ¸…é™¤è³‡æ–™åº«
                        </button>
                    </div>
                    
                    <!-- Quick Templates -->
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <label class="block text-sm font-medium text-gray-700 mb-2">å¿«é€Ÿç¯„æœ¬ï¼š</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button id="sampleData1" class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded transition-colors">
                                ğŸ“š åŸºç¤ä¸­è—¥
                            </button>
                            <button id="sampleData2" class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded transition-colors">
                                ğŸŒ¿ å¸¸ç”¨æ–¹åŠ‘
                            </button>
                            <button id="sampleData3" class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded transition-colors">
                                ğŸ’Š ç¾ä»£æ‡‰ç”¨
                            </button>
                            <button id="sampleData4" class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded transition-colors">
                                ğŸ”„ æ··åˆæ ¼å¼
                            </button>
                            <button id="sampleData5" class="text-xs bg-purple-100 hover:bg-purple-200 px-2 py-1 rounded transition-colors col-span-2">
                                âœ¨ æ¨™é»ç¬¦è™Ÿç¯„ä¾‹
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">å³æ™‚çµ±è¨ˆ</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">ä¸­è—¥ç¸½æ•¸ï¼š</span>
                            <span id="herbCount" class="font-semibold text-green-600">è¼‰å…¥ä¸­...</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">ç—‡ç‹€ç¸½æ•¸ï¼š</span>
                            <span id="symptomCount" class="font-semibold text-blue-600">è¼‰å…¥ä¸­...</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">è³‡æ–™æ¢ç›®ï¼š</span>
                            <span id="recordCount" class="font-semibold text-purple-600">è¼‰å…¥ä¸­...</span>
                        </div>
                    </div>
                </div>


            </div>
        </div>

        <!-- Data Display -->
        <div id="dataDisplay" class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-8 hidden">
            <!-- Herbs List -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-green-500 rounded-full mr-2"></div>
                        ä¸­è—¥è³‡æ–™åº«
                    </div>
                    <div class="text-xs text-gray-500">å³æ™‚åŒæ­¥</div>
                </h3>
                <div id="herbsList" class="max-h-64 overflow-y-auto space-y-2">
                    <p class="text-gray-500 text-center py-8">è¼‰å…¥ä¸­...</p>
                </div>
            </div>

            <!-- Symptoms List -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-blue-500 rounded-full mr-2"></div>
                        ç—‡ç‹€è³‡æ–™åº«
                    </div>
                    <div class="text-xs text-gray-500">å³æ™‚åŒæ­¥</div>
                </h3>
                <div id="symptomsList" class="max-h-64 overflow-y-auto space-y-2">
                    <p class="text-gray-500 text-center py-8">è¼‰å…¥ä¸­...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50">
        <div class="flex items-center space-x-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span id="toastMessage">æ“ä½œæˆåŠŸ</span>
        </div>
    </div>

    <script>
        // Global variables
        let herbsData = {};
        let symptomsData = {};
        let recordsData = {};
        let isFirebaseReady = false;

        // DOM elements
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const clearBtn = document.getElementById('clearBtn');
        const searchResults = document.getElementById('searchResults');
        const resultsContainer = document.getElementById('resultsContainer');
        const importData = document.getElementById('importData');
        const importBtn = document.getElementById('importBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const clearDatabaseBtn = document.getElementById('clearDatabaseBtn');
        const herbCount = document.getElementById('herbCount');
        const symptomCount = document.getElementById('symptomCount');
        const recordCount = document.getElementById('recordCount');
        const herbsList = document.getElementById('herbsList');
        const symptomsList = document.getElementById('symptomsList');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const mainContent = document.getElementById('mainContent');
        const dataDisplay = document.getElementById('dataDisplay');
        const connectionStatus = document.getElementById('connectionStatus');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        
        // Smart import elements
        const formatHint = document.getElementById('formatHint');
        const sampleData1 = document.getElementById('sampleData1');
        const sampleData2 = document.getElementById('sampleData2');
        const sampleData3 = document.getElementById('sampleData3');
        const sampleData4 = document.getElementById('sampleData4');
        const sampleData5 = document.getElementById('sampleData5');
        
        // Progress bar elements
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const progressPercent = document.getElementById('progressPercent');

        // Wait for Firebase to be ready
        function waitForFirebase() {
            return new Promise((resolve) => {
                const checkFirebase = () => {
                    if (window.firebaseDB) {
                        resolve();
                    } else {
                        setTimeout(checkFirebase, 100);
                    }
                };
                checkFirebase();
            });
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            toastMessage.textContent = message;
            toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-transform duration-300 z-50 ${
                type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            } text-white`;
            toast.style.transform = 'translateX(0)';
            
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
            }, 3000);
        }

        // Initialize Firebase listeners
        async function initializeFirebase() {
            try {
                await waitForFirebase();
                
                // Listen to records data
                const recordsRef = window.firebaseDB.ref(window.firebaseDB.database, 'tcm-records');
                window.firebaseDB.onValue(recordsRef, (snapshot) => {
                    const data = snapshot.val();
                    recordsData = data || {};
                    processRecordsData();
                    updateDisplay();
                    
                    if (!isFirebaseReady) {
                        isFirebaseReady = true;
                        loadingIndicator.classList.add('hidden');
                        mainContent.classList.remove('hidden');
                        dataDisplay.classList.remove('hidden');
                        showToast('é›²ç«¯è³‡æ–™è¼‰å…¥å®Œæˆ', 'success');
                    }
                });

                // Start connection monitoring
                monitorConnection();
            } catch (error) {
                console.error('Firebase initialization error:', error);
                updateConnectionStatus(false);
                showToast('é€£ç·šå¤±æ•—ï¼Œä½¿ç”¨é›¢ç·šæ¨¡å¼', 'error');
                
                // Show content anyway for demo
                loadingIndicator.classList.add('hidden');
                mainContent.classList.remove('hidden');
                dataDisplay.classList.remove('hidden');
            }
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            const statusDot = connectionStatus.querySelector('div');
            const statusText = connectionStatus.querySelector('span');
            
            if (connected) {
                statusDot.className = 'w-3 h-3 bg-green-500 rounded-full';
                statusText.textContent = 'å·²é€£ç·š';
            } else {
                statusDot.className = 'w-3 h-3 bg-red-500 rounded-full';
                statusText.textContent = 'é›¢ç·š';
            }
        }

        // Real-time connection monitoring
        function monitorConnection() {
            const connectedRef = window.firebaseDB.ref(window.firebaseDB.database, '.info/connected');
            window.firebaseDB.onValue(connectedRef, (snapshot) => {
                const connected = snapshot.val();
                updateConnectionStatus(connected);
                
                if (connected) {
                    console.log('Firebase connected');
                } else {
                    console.log('Firebase disconnected');
                }
            });
        }

        // Progress bar functions
        function showProgress() {
            progressContainer.classList.remove('hidden');
            importBtn.disabled = true;
            importBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }

        function hideProgress() {
            progressContainer.classList.add('hidden');
            importBtn.disabled = false;
            importBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            updateProgress(0, 'æº–å‚™å°å…¥...');
        }

        function updateProgress(percent, text) {
            progressBar.style.width = percent + '%';
            progressPercent.textContent = Math.round(percent) + '%';
            progressText.textContent = text;
        }

        // Process records data into herbs and symptoms
        function processRecordsData() {
            herbsData = {};
            symptomsData = {};

            Object.values(recordsData).forEach(record => {
                const herb = record.herb;
                const symptom = record.symptom;

                // Add to herbs data
                if (!herbsData[herb]) {
                    herbsData[herb] = [];
                }
                if (!herbsData[herb].includes(symptom)) {
                    herbsData[herb].push(symptom);
                }

                // Add to symptoms data
                if (!symptomsData[symptom]) {
                    symptomsData[symptom] = [];
                }
                if (!symptomsData[symptom].includes(herb)) {
                    symptomsData[symptom].push(herb);
                }
            });
        }

        // Smart data parsing functions
        function detectFormat(text) {
            const lines = text.split('\n').filter(line => line.trim());
            if (lines.length === 0) return 'unknown';
            
            const formats = {
                colon: 0,
                comma: 0,
                tab: 0,
                space: 0,
                arrow: 0,
                bracket: 0,
                json: 0
            };
            
            lines.forEach(line => {
                if (line.includes('ï¼š') || line.includes(':')) formats.colon++;
                if (line.includes(',')) formats.comma++;
                if (line.includes('\t')) formats.tab++;
                if (line.includes('â†’') || line.includes('->')) formats.arrow++;
                if (line.includes('[') && line.includes(']')) formats.bracket++;
                if (line.includes(' ') && !line.includes('ï¼š') && !line.includes(',') && !line.includes('\t')) formats.space++;
                if (line.trim().startsWith('{') || line.trim().startsWith('[')) formats.json++;
            });
            
            return Object.keys(formats).reduce((a, b) => formats[a] > formats[b] ? a : b);
        }

        function parseDataByFormat(text, format) {
            const lines = text.split('\n').filter(line => line.trim());
            const results = [];
            
            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (!trimmedLine) return;
                
                let herb = '', symptomsText = '';
                
                try {
                    // Try different formats in order
                    if (trimmedLine.includes('ï¼š')) {
                        [herb, symptomsText] = trimmedLine.split('ï¼š');
                    } else if (trimmedLine.includes(':')) {
                        [herb, symptomsText] = trimmedLine.split(':');
                    } else if (trimmedLine.includes(',')) {
                        [herb, symptomsText] = trimmedLine.split(',');
                    } else if (trimmedLine.includes('\t')) {
                        [herb, symptomsText] = trimmedLine.split('\t');
                    } else if (trimmedLine.includes('â†’')) {
                        [herb, symptomsText] = trimmedLine.split('â†’');
                    } else if (trimmedLine.includes('->')) {
                        [herb, symptomsText] = trimmedLine.split('->');
                    } else if (trimmedLine.includes('[') && trimmedLine.includes(']')) {
                        const bracketMatch = trimmedLine.match(/^(.+?)\[(.+?)\]$/);
                        if (bracketMatch) {
                            herb = bracketMatch[1];
                            symptomsText = bracketMatch[2];
                        }
                    } else if (trimmedLine.includes(' ')) {
                        const parts = trimmedLine.split(' ');
                        if (parts.length >= 2) {
                            herb = parts[0];
                            symptomsText = parts.slice(1).join(' ');
                        }
                    } else if (trimmedLine.startsWith('{')) {
                        try {
                            const jsonData = JSON.parse(trimmedLine);
                            if (jsonData.herb && jsonData.symptom) {
                                herb = jsonData.herb;
                                symptomsText = jsonData.symptom;
                            } else if (jsonData.name && jsonData.effect) {
                                herb = jsonData.name;
                                symptomsText = jsonData.effect;
                            }
                        } catch (e) {
                            // Invalid JSON, skip
                        }
                    }
                    
                    if (herb && symptomsText) {
                        herb = herb.trim().replace(/[^\u4e00-\u9fa5a-zA-Z0-9ã€]/g, '');
                        symptomsText = symptomsText.trim();
                        
                        // Split multiple symptoms by all common separators and punctuation
                        const symptoms = symptomsText.split(/[ï¼Œ,ã€ï¼›;|\/\\ã€‚ï¼ï¼Ÿâ€¦ï¼šã€Œã€ã€ã€ã€Šã€‹ã€ˆã€‰ã€ã€‘ã€”ã€•ï¼ˆï¼‰()ï¼¼/]/)
                            .map(s => s.trim().replace(/^[ï¼Œã€‚ã€ï¼›ï¼šï¼ï¼Ÿâ€¦\sã€Œã€ã€ã€ã€Šã€‹ã€ˆã€‰ã€ã€‘ã€”ã€•ï¼ˆï¼‰()ï¼¼/]+|[ï¼Œã€‚ã€ï¼›ï¼šï¼ï¼Ÿâ€¦\sã€Œã€ã€ã€ã€Šã€‹ã€ˆã€‰ã€ã€‘ã€”ã€•ï¼ˆï¼‰()ï¼¼/]+$/g, ''))
                            .filter(s => s.length > 0 && s !== 'ã€€'); // Filter out empty strings and full-width spaces
                        
                        // Create a result for each symptom
                        symptoms.forEach(symptom => {
                            if (herb && symptom) {
                                results.push({ herb, symptom, original: trimmedLine });
                            }
                        });
                    }
                } catch (error) {
                    console.warn('Parse error for line:', trimmedLine, error);
                }
            });
            
            return results;
        }

        // Import data to Firebase with robust error handling
        async function importDataFunction() {
            const data = importData.value.trim();
            if (!data) {
                showToast('è«‹è¼¸å…¥è¦å°å…¥çš„è³‡æ–™', 'error');
                return;
            }

            // Parse data with auto-detection
            const detectedFormat = detectFormat(data);
            const parsedData = parseDataByFormat(data, detectedFormat);
            
            if (parsedData.length === 0) {
                showToast('æ²’æœ‰æœ‰æ•ˆçš„è³‡æ–™å¯ä»¥å°å…¥', 'error');
                return;
            }

            // Remove duplicates and prepare data
            const seen = new Set();
            const validData = [];
            let skipCount = 0;

            // Show progress bar
            showProgress();
            updateProgress(5, 'ğŸ“‹ è³‡æ–™é è™•ç†ä¸­...');

            // Pre-process all data
            parsedData.forEach(item => {
                const key = `${item.herb}_${item.symptom}`;
                if (seen.has(key)) return;
                seen.add(key);

                const recordKey = `${item.herb}_${item.symptom}`.replace(/[.#$[\]]/g, '_');
                
                // Check for duplicates in existing data
                if (recordsData[recordKey]) {
                    skipCount++;
                    return;
                }

                validData.push({
                    key: recordKey,
                    herb: item.herb,
                    symptom: item.symptom,
                    timestamp: Date.now()
                });
            });

            const totalItems = validData.length;
            
            if (totalItems === 0) {
                updateProgress(100, 'æ²’æœ‰æ–°è³‡æ–™éœ€è¦å°å…¥');
                await new Promise(resolve => setTimeout(resolve, 600));
                hideProgress();
                showToast(`æ‰€æœ‰ ${skipCount} ç­†è³‡æ–™å·²å­˜åœ¨ï¼Œç„¡éœ€é‡è¤‡å°å…¥`, 'info');
                return;
            }

            try {
                updateProgress(15, `ğŸ“¤ æº–å‚™å°å…¥ ${totalItems} ç­†è³‡æ–™...`);

                // Always use safe individual writes for maximum reliability
                let completed = 0;
                let failed = 0;
                const batchSize = 10; // Conservative batch size
                
                // Process in small batches to avoid overwhelming Firebase
                for (let i = 0; i < validData.length; i += batchSize) {
                    const batch = validData.slice(i, i + batchSize);
                    
                    updateProgress(
                        15 + (i / validData.length) * 70, 
                        `ğŸ“ è™•ç†ç¬¬ ${Math.floor(i/batchSize) + 1} æ‰¹ (${i + 1}-${Math.min(i + batchSize, validData.length)})`
                    );

                    // Process batch items with individual error handling
                    const batchPromises = batch.map(async (item) => {
                        try {
                            // Check if Firebase is available
                            if (!window.firebaseDB || !window.firebaseDB.database) {
                                throw new Error('Firebase æœªåˆå§‹åŒ–');
                            }

                            const recordRef = window.firebaseDB.ref(window.firebaseDB.database, `tcm-records/${item.key}`);
                            await window.firebaseDB.set(recordRef, {
                                herb: item.herb,
                                symptom: item.symptom,
                                timestamp: item.timestamp
                            });
                            
                            completed++;
                            return { success: true, item };
                        } catch (error) {
                            console.warn('Single item failed:', item, error);
                            failed++;
                            return { success: false, item, error };
                        }
                    });

                    // Wait for current batch to complete
                    await Promise.all(batchPromises);
                    
                    // Small delay between batches to prevent rate limiting
                    if (i + batchSize < validData.length) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }

                // Final progress
                updateProgress(90, 'âœ… å°å…¥å®Œæˆï¼Œæ­£åœ¨åŒæ­¥...');
                await new Promise(resolve => setTimeout(resolve, 500));
                updateProgress(100, 'ğŸ‰ åŒæ­¥å®Œæˆï¼');

                // Wait briefly before hiding
                await new Promise(resolve => setTimeout(resolve, 800));

                importData.value = '';
                formatHint.textContent = '';
                
                let message = `âœ… æˆåŠŸå°å…¥ ${completed} ç­†è³‡æ–™`;
                if (failed > 0) {
                    message += `ï¼Œ${failed} ç­†å¤±æ•—`;
                }
                if (skipCount > 0) {
                    message += `ï¼Œè·³é ${skipCount} ç­†é‡è¤‡`;
                }
                
                showToast(message, completed > 0 ? 'success' : 'error');
                
            } catch (error) {
                console.error('Import error:', error);
                updateProgress(100, 'âŒ å°å…¥å¤±æ•—');
                
                let errorMessage = 'å°å…¥å¤±æ•—';
                if (error.message) {
                    if (error.message.includes('permission') || error.message.includes('PERMISSION')) {
                        errorMessage = 'æ¬Šé™ä¸è¶³ï¼Œè«‹æª¢æŸ¥ Firebase è¨­å®š';
                    } else if (error.message.includes('network') || error.message.includes('offline')) {
                        errorMessage = 'ç¶²è·¯é€£ç·šå•é¡Œï¼Œè«‹æª¢æŸ¥ç¶²è·¯å¾Œé‡è©¦';
                    } else if (error.message.includes('Firebase')) {
                        errorMessage = 'Firebase é€£ç·šå•é¡Œï¼Œè«‹é‡æ–°æ•´ç†é é¢';
                    } else {
                        errorMessage = `å°å…¥å¤±æ•—: ${error.message}`;
                    }
                }
                
                showToast(errorMessage, 'error');
                
                // Wait before hiding progress
                await new Promise(resolve => setTimeout(resolve, 1000));
            } finally {
                hideProgress();
            }
        }





        // Clear input data
        function clearAllData() {
            if (!confirm('ç¢ºå®šè¦æ¸…ç©ºè¼¸å…¥æ¬„çš„è³‡æ–™å—ï¼Ÿ')) {
                return;
            }

            importData.value = '';
            formatHint.textContent = '';
            showToast('è¼¸å…¥è³‡æ–™å·²æ¸…ç©º', 'success');
        }

        // Clear entire database
        async function clearDatabase() {
            if (!confirm('âš ï¸ è­¦å‘Šï¼šé€™å°‡æ¸…é™¤æ•´å€‹è³‡æ–™åº«çš„æ‰€æœ‰å…§å®¹ï¼\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                return;
            }

            // Double confirmation for safety
            if (!confirm('ğŸš¨ æœ€å¾Œç¢ºèªï¼šæ‚¨å³å°‡åˆªé™¤æ•´å€‹è³‡æ–™åº«ï¼\n\nè«‹å†æ¬¡ç¢ºèªæ‚¨çœŸçš„è¦åŸ·è¡Œæ­¤æ“ä½œï¼Ÿ')) {
                return;
            }

            if (!isFirebaseReady) {
                showToast('æ­£åœ¨é€£ç·šä¸­ï¼Œè«‹ç¨å€™...', 'info');
                return;
            }

            try {
                showProgress();
                updateProgress(20, 'ğŸ—‘ï¸ æ­£åœ¨æ¸…é™¤è³‡æ–™åº«...');
                
                // Clear the entire database root
                const rootRef = window.firebaseDB.ref(window.firebaseDB.database);
                await window.firebaseDB.set(rootRef, null);
                
                updateProgress(80, 'âœ… è³‡æ–™åº«å·²æ¸…é™¤');
                await new Promise(resolve => setTimeout(resolve, 500));
                updateProgress(100, 'ğŸ‰ æ¸…é™¤å®Œæˆ');
                
                // Reset local data
                herbsData = {};
                symptomsData = {};
                recordsData = {};
                
                // Clear search results
                searchResults.classList.add('hidden');
                searchInput.value = '';
                
                showToast('ğŸ’¥ æ•´å€‹è³‡æ–™åº«å·²æ¸…é™¤', 'success');
                
                setTimeout(() => {
                    hideProgress();
                }, 1000);
                
            } catch (error) {
                console.error('Database clear error:', error);
                showToast('æ¸…é™¤è³‡æ–™åº«å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™è¨­å®š', 'error');
                hideProgress();
            }
        }

        // Traditional-Simplified Chinese conversion maps
        const traditionalToSimplified = {
            'ç•¶': 'å½“', 'æ­¸': 'å½’', 'è£œ': 'è¡¥', 'èª¿': 'è°ƒ', 'ç¶“': 'ç»', 'æ½¤': 'æ¶¦', 'è…¸': 'è‚ ', 'é»ƒ': 'é»„', 'æ°£': 'æ°”', 'éŒ¶': 'è¡¨', 'è†¿': 'è„“', 'ç˜¡': 'ç–®', 'å¾©': 'å¤', 'è„ˆ': 'è„‰', 'è„«': 'è„±', 'é¤Š': 'å…»', 'è¡€': 'è¡€', 'ç¥›': 'ç¥›', 'é¢¨': 'é£', 'ç·©': 'ç¼“', 'é™°': 'é˜´', 'æ»‹': 'æ»‹', 'è…': 'è‚¾', 'ç²¾': 'ç²¾', 'é«“': 'é«“', 'å¯§': 'å®', 'ç¥': 'ç¥', 'æ¿•': 'æ¹¿', 'ç—°': 'ç—°', 'é¬±': 'éƒ', 'ç‡Ÿ': 'è¥', 'è¡›': 'å«', 'ç™¼': 'å‘', 'æ±—': 'æ±—', 'å®£': 'å®£', 'è‚º': 'è‚º', 'å–˜': 'å–˜', 'æ”»': 'æ”»', 'ç‡¥': 'ç‡¥', 'å¯¦': 'å®', 'ç€‰': 'æ³»', 'ç«': 'ç«', 'è—': 'è“', 'æ¶¼': 'å‡‰', 'å’½': 'å’½', 'éŠ€': 'é“¶', 'ç–': 'ç–', 'æ•£': 'æ•£', 'ç†±': 'çƒ­', 'è…«': 'è‚¿', 'çµ': 'ç»“', 'ç™°': 'ç—ˆ', 'æ·‹': 'æ·‹', 'è…¥': 'è…¥', 'è‰': 'è‰', 'æ’': 'æ’', 'è‘‰': 'å¶', 'å˜”': 'å‘•', 'è²': 'è´', 'æ¯': 'æ¯', 'ç…©': 'çƒ¦', 'ç´…': 'çº¢', 'èŠ±': 'èŠ±', 'ç˜€': 'ç˜€', 'æ¡ƒ': 'æ¡ƒ', 'ä»': 'ä»', 'è†': 'è†', 'å¼·': 'å¼º', 'ç­‹': 'ç­‹', 'éª¨': 'éª¨', 'å‚·': 'ä¼¤', 'æ²’': 'æ²¡', 'è—¥': 'è¯', 'ç«­': 'ç«­', 'æ–‚': 'æ•›', 'æ©Ÿ': 'æœº', 'é«”': 'ä½“', 'ç™‚': 'ç–—', 'è­‰': 'è¯', 'è¨º': 'è¯Š', 'æ–·': 'æ–­', 'è™•': 'å¤„', 'æ–¹': 'æ–¹', 'åŠ‘': 'å‰‚', 'æ¹¯': 'æ±¤', 'ä¸¸': 'ä¸¸', 'è†': 'è†', 'é£²': 'é¥®', 'é¡†': 'é¢—', 'ç²’': 'ç²’', 'é‡': 'é’ˆ', 'ç¸': 'ç¸', 'æ¨': 'æ¨', 'æ‹¿': 'æ‹¿', 'æŒ‰': 'æŒ‰', 'æ‘©': 'æ‘©', 'ç©´': 'ç©´', 'ä½': 'ä½', 'ç¶“': 'ç»', 'çµ¡': 'ç»œ', 'è‡Ÿ': 'è„', 'è…‘': 'è…‘', 'é™½': 'é˜³', 'è™›': 'è™š', 'å¯¦': 'å®', 'å¯’': 'å¯’', 'æº«': 'æ¸©', 'æ¶¼': 'å‡‰', 'ç‡¥': 'ç‡¥', 'æ¿•': 'æ¹¿', 'é¢¨': 'é£', 'æš‘': 'æš‘', 'ç«': 'ç«', 'ç‡¥': 'ç‡¥', 'æ¿•': 'æ¹¿', 'å¯’': 'å¯’', 'ç†±': 'çƒ­', 'è™›': 'è™š', 'å¯¦': 'å®', 'é™°': 'é˜´', 'é™½': 'é˜³', 'æ°£': 'æ°”', 'è¡€': 'è¡€', 'æ´¥': 'æ´¥', 'æ¶²': 'æ¶²', 'ç²¾': 'ç²¾', 'ç¥': 'ç¥', 'é­‚': 'é­‚', 'é­„': 'é­„', 'æ„': 'æ„', 'å¿—': 'å¿—', 'æ€': 'æ€', 'æ…®': 'è™‘', 'æ™º': 'æ™º', 'æ…§': 'æ…§'
        };

        const simplifiedToTraditional = {};
        Object.keys(traditionalToSimplified).forEach(trad => {
            const simp = traditionalToSimplified[trad];
            simplifiedToTraditional[simp] = trad;
        });

        // Convert text between Traditional and Simplified Chinese
        function convertToSimplified(text) {
            return text.split('').map(char => traditionalToSimplified[char] || char).join('');
        }

        function convertToTraditional(text) {
            return text.split('').map(char => simplifiedToTraditional[char] || char).join('');
        }

        // Enhanced similarity calculation with Traditional/Simplified support
        function calculateSimilarity(text, query) {
            const textLower = text.toLowerCase();
            const queryLower = query.toLowerCase();
            
            // Convert to both Traditional and Simplified for comparison
            const textSimp = convertToSimplified(text);
            const textTrad = convertToTraditional(text);
            const querySimp = convertToSimplified(query);
            const queryTrad = convertToTraditional(query);
            
            // Test all combinations
            const testCombinations = [
                { text: textLower, query: queryLower },
                { text: textSimp.toLowerCase(), query: queryLower },
                { text: textTrad.toLowerCase(), query: queryLower },
                { text: textLower, query: querySimp.toLowerCase() },
                { text: textLower, query: queryTrad.toLowerCase() },
                { text: textSimp.toLowerCase(), query: querySimp.toLowerCase() },
                { text: textTrad.toLowerCase(), query: queryTrad.toLowerCase() },
                { text: textSimp.toLowerCase(), query: queryTrad.toLowerCase() },
                { text: textTrad.toLowerCase(), query: querySimp.toLowerCase() }
            ];
            
            let maxScore = 0;
            
            testCombinations.forEach(combo => {
                let score = 0;
                
                // Exact match gets highest score
                if (combo.text === combo.query) score = 1000;
                // Starts with query gets high score
                else if (combo.text.startsWith(combo.query)) score = 800;
                // Ends with query gets medium-high score
                else if (combo.text.endsWith(combo.query)) score = 600;
                // Contains query gets medium score
                else if (combo.text.includes(combo.query)) score = 400;
                else {
                    // Calculate character overlap score
                    let overlapScore = 0;
                    for (let i = 0; i < combo.query.length; i++) {
                        if (combo.text.includes(combo.query[i])) {
                            overlapScore += 10;
                        }
                    }
                    
                    // Length difference penalty (shorter differences get higher scores)
                    const lengthDiff = Math.abs(combo.text.length - combo.query.length);
                    const lengthScore = Math.max(0, 100 - lengthDiff * 5);
                    
                    score = overlapScore + lengthScore;
                }
                
                maxScore = Math.max(maxScore, score);
            });
            
            return maxScore;
        }

        // Enhanced search function with similarity ranking
        function searchFunction() {
            const query = searchInput.value.trim();
            if (!query) {
                showToast('è«‹è¼¸å…¥æœå°‹é—œéµå­—', 'error');
                return;
            }

            let results = [];

            // Search in herbs with similarity scoring
            Object.keys(herbsData).forEach(herb => {
                const similarity = calculateSimilarity(herb, query);
                if (similarity > 0) {
                    results.push({
                        type: 'ä¸­è—¥',
                        name: herb,
                        items: herbsData[herb],
                        label: 'å°æ‡‰ç—‡ç‹€',
                        similarity: similarity,
                        matchType: herb === query ? 'exact' : herb.includes(query) ? 'partial' : 'fuzzy'
                    });
                }
            });

            // Search in symptoms with similarity scoring
            Object.keys(symptomsData).forEach(symptom => {
                const similarity = calculateSimilarity(symptom, query);
                if (similarity > 0) {
                    results.push({
                        type: 'ç—‡ç‹€',
                        name: symptom,
                        items: symptomsData[symptom],
                        label: 'å°æ‡‰ä¸­è—¥',
                        similarity: similarity,
                        matchType: symptom === query ? 'exact' : symptom.includes(query) ? 'partial' : 'fuzzy'
                    });
                }
            });

            // Sort results by similarity score (highest first)
            results.sort((a, b) => {
                // First sort by similarity score
                if (b.similarity !== a.similarity) {
                    return b.similarity - a.similarity;
                }
                // Then by match type (exact > partial > fuzzy)
                const matchTypeOrder = { 'exact': 3, 'partial': 2, 'fuzzy': 1 };
                if (matchTypeOrder[b.matchType] !== matchTypeOrder[a.matchType]) {
                    return matchTypeOrder[b.matchType] - matchTypeOrder[a.matchType];
                }
                // Finally by name length (shorter first)
                return a.name.length - b.name.length;
            });

            // Filter out very low similarity results (below threshold)
            results = results.filter(result => result.similarity >= 50);

            displayResults(results, query);
        }

        // Display search results with similarity indicators
        function displayResults(results, query) {
            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-gray-400 text-lg mb-2">ğŸ˜”</div>
                        <p class="text-gray-500">æœªæ‰¾åˆ°èˆ‡ã€Œ${query}ã€ç›¸é—œçš„è³‡æ–™</p>
                    </div>
                `;
            } else {
                resultsContainer.innerHTML = results.map((result, index) => {
                    // Determine match quality indicator
                    let matchIndicator = '';
                    let matchColor = '';
                    if (result.matchType === 'exact') {
                        matchIndicator = 'ğŸ¯ å®Œå…¨åŒ¹é…';
                        matchColor = 'text-green-600';
                    } else if (result.matchType === 'partial') {
                        matchIndicator = 'ğŸ” éƒ¨åˆ†åŒ¹é…';
                        matchColor = 'text-blue-600';
                    } else {
                        matchIndicator = 'ğŸ’¡ ç›¸é—œåŒ¹é…';
                        matchColor = 'text-purple-600';
                    }

                    return `
                        <div class="search-result bg-gray-50 rounded-lg p-4 mb-4 border-l-4 ${result.type === 'ä¸­è—¥' ? 'border-green-500' : 'border-blue-500'} fade-in">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center">
                                    <span class="inline-block px-2 py-1 text-xs font-medium rounded ${result.type === 'ä¸­è—¥' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">${result.type}</span>
                                    <h4 class="font-semibold text-gray-800 ml-2">${result.name}</h4>
                                    ${index < 3 ? '<span class="ml-2 text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">æ¨è–¦</span>' : ''}
                                </div>
                                <div class="text-xs ${matchColor} font-medium">${matchIndicator}</div>
                            </div>
                            <p class="text-sm text-gray-600 mb-2">${result.label}ï¼š</p>
                            <div class="flex flex-wrap gap-2">
                                ${result.items.map(item => `
                                    <span class="inline-block px-3 py-1 bg-white text-gray-700 rounded-full text-sm border border-gray-200 hover:bg-gray-100 cursor-pointer" onclick="searchInput.value='${item}'; searchFunction();">${item}</span>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            searchResults.classList.remove('hidden');
            searchResults.scrollIntoView({ behavior: 'smooth' });
        }

        // Update display
        function updateDisplay() {
            // Update counts
            herbCount.textContent = Object.keys(herbsData).length;
            symptomCount.textContent = Object.keys(symptomsData).length;
            recordCount.textContent = Object.keys(recordsData).length;

            // Update herbs list
            if (Object.keys(herbsData).length === 0) {
                herbsList.innerHTML = '<p class="text-gray-500 text-center py-8">æš«ç„¡è³‡æ–™ï¼Œè«‹å…ˆå°å…¥ä¸­è—¥è³‡æ–™</p>';
            } else {
                herbsList.innerHTML = Object.keys(herbsData).sort().map(herb => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors" onclick="searchInput.value='${herb}'; searchFunction();">
                        <span class="font-medium text-gray-800">${herb}</span>
                        <span class="text-xs text-gray-500">${herbsData[herb].length} å€‹ç—‡ç‹€</span>
                    </div>
                `).join('');
            }

            // Update symptoms list
            if (Object.keys(symptomsData).length === 0) {
                symptomsList.innerHTML = '<p class="text-gray-500 text-center py-8">æš«ç„¡è³‡æ–™ï¼Œè«‹å…ˆå°å…¥ç—‡ç‹€è³‡æ–™</p>';
            } else {
                symptomsList.innerHTML = Object.keys(symptomsData).sort().map(symptom => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors" onclick="searchInput.value='${symptom}'; searchFunction();">
                        <span class="font-medium text-gray-800">${symptom}</span>
                        <span class="text-xs text-gray-500">${symptomsData[symptom].length} ç¨®ä¸­è—¥</span>
                    </div>
                `).join('');
            }
        }

        // Sample data templates
        const sampleTemplates = {
            basic: `ç•¶æ­¸ï¼šè£œè¡€èª¿ç¶“ï¼Œæ´»è¡€æ­¢ç—›ï¼Œæ½¤è…¸é€šä¾¿
é»ƒèŠªï¼šè£œæ°£å›ºè¡¨ï¼Œåˆ©å°¿æ‰˜æ¯’ï¼Œæ’è†¿ï¼Œæ–‚ç˜¡ç”Ÿè‚Œ
äººåƒï¼šå¤§è£œå…ƒæ°£ï¼Œå¾©è„ˆå›ºè„«ï¼Œè£œè„¾ç›Šè‚ºï¼Œç”Ÿæ´¥é¤Šè¡€
ç”˜è‰ï¼šèª¿å’Œè«¸è—¥ï¼Œè£œè„¾ç›Šæ°£ï¼Œæ¸…ç†±è§£æ¯’ï¼Œç¥›ç—°æ­¢å’³
å·èŠï¼šæ´»è¡€è¡Œæ°£ï¼Œç¥›é¢¨æ­¢ç—›
ç™½èŠï¼šé¤Šè¡€æŸ”è‚ï¼Œç·©ä¸­æ­¢ç—›ï¼Œæ–‚é™°æ”¶æ±—
ç†Ÿåœ°é»ƒï¼šæ»‹é™°è£œè¡€ï¼Œç›Šç²¾å¡«é«“
èŒ¯è‹“ï¼šå¥è„¾åˆ©æ°´ï¼Œå¯§å¿ƒå®‰ç¥`,
            
            formula: `å››ç‰©æ¹¯ï¼šè£œè¡€èª¿ç¶“ï¼Œé¤Šè¡€æ´»è¡€
å…­å›å­æ¹¯ï¼šå¥è„¾ç›Šæ°£ï¼Œç‡¥æ¿•åŒ–ç—°
é€é™æ•£ï¼šç–è‚è§£é¬±ï¼Œå¥è„¾å’Œè¡€
è£œä¸­ç›Šæ°£æ¹¯ï¼šè£œæ°£å‡é™½ï¼Œç”˜æº«é™¤ç†±
æ¡‚ææ¹¯ï¼šè§£è‚Œç™¼è¡¨ï¼Œèª¿å’Œç‡Ÿè¡›
éº»é»ƒæ¹¯ï¼šç™¼æ±—è§£è¡¨ï¼Œå®£è‚ºå¹³å–˜
å°æŸ´èƒ¡æ¹¯ï¼šå’Œè§£å°‘é™½ï¼Œç–è‚å’Œèƒƒ
å¤§æ‰¿æ°£æ¹¯ï¼šæ”»ä¸‹ç‡¥å¯¦ï¼Œæ¸…ç†±ç€‰ç«`,
            
            modern: `æ¿è—æ ¹ï¼šæ¸…ç†±è§£æ¯’ï¼Œæ¶¼è¡€åˆ©å’½
é‡‘éŠ€èŠ±ï¼šæ¸…ç†±è§£æ¯’ï¼Œç–æ•£é¢¨ç†±
é€£ç¿¹ï¼šæ¸…ç†±è§£æ¯’ï¼Œæ¶ˆè…«æ•£çµ
è’²å…¬è‹±ï¼šæ¸…ç†±è§£æ¯’ï¼Œæ¶ˆè…«æ•£çµï¼Œåˆ©å°¿é€šæ·‹
é­šè…¥è‰ï¼šæ¸…ç†±è§£æ¯’ï¼Œæ¶ˆç™°æ’è†¿ï¼Œåˆ©å°¿é€šæ·‹
æ¡”æ¢—ï¼šå®£è‚ºç¥›ç—°ï¼Œåˆ©å’½æ’è†¿
æ‡æ·è‘‰ï¼šæ¸…è‚ºæ­¢å’³ï¼Œé™é€†æ­¢å˜”
å·è²æ¯ï¼šæ¸…ç†±åŒ–ç—°ï¼Œæ½¤è‚ºæ­¢å’³ï¼Œæ•£çµæ¶ˆè…«`,
            
            mixed: `ä¸¹åƒï¼šæ´»è¡€åŒ–ç˜€ï¼Œæ¶¼è¡€æ¶ˆç™°ï¼Œé™¤ç…©å®‰ç¥
ç´…èŠ±,æ´»è¡€é€šç¶“ã€æ•£ç˜€æ­¢ç—›
æ¡ƒä»	ç ´è¡€è¡Œç˜€ï¼›æ½¤ç‡¥æ»‘è…¸
ç‰›è† æ´»è¡€é€šç¶“/è£œè‚è…ã€å¼·ç­‹éª¨
ä¸‰ä¸ƒâ†’æ­¢è¡€åŒ–ç˜€|å®šç—›
ä¹³é¦™[æ´»è¡€æ­¢ç—›ï¼›ä¼¸ç­‹]
æ²’è—¥[æ´»è¡€æ­¢ç—›ï¼Œæ¶ˆè…«ç”Ÿè‚Œ]
{"herb":"è¡€ç«­","symptom":"æ´»è¡€å®šç—›ï¼ŒåŒ–ç˜€æ­¢è¡€ï¼Œç”Ÿè‚Œæ–‚ç˜¡"}`,

            punctuation: `ç•¶æ­¸ï¼šè£œè¡€èª¿ç¶“ã€‚æ´»è¡€æ­¢ç—›ï¼æ½¤è…¸é€šä¾¿ï¼Ÿ
é»ƒèŠªï¼Œè£œæ°£å›ºè¡¨ã€åˆ©å°¿æ‰˜æ¯’ï¼›æ’è†¿â€¦æ–‚ç˜¡ç”Ÿè‚Œ
äººåƒã€Œå¤§è£œå…ƒæ°£ã€ã€Œå¾©è„ˆå›ºè„«ã€ã€Œè£œè„¾ç›Šè‚ºã€
ç”˜è‰ã€Šèª¿å’Œè«¸è—¥ã€‹ã€Šè£œè„¾ç›Šæ°£ã€‹ã€Šæ¸…ç†±è§£æ¯’ã€‹
å·èŠã€ˆæ´»è¡€è¡Œæ°£ã€‰ã€ˆç¥›é¢¨æ­¢ç—›ã€‰
ç™½èŠã€é¤Šè¡€æŸ”è‚ã€‘ã€ç·©ä¸­æ­¢ç—›ã€‘ã€æ–‚é™°æ”¶æ±—ã€‘
ç†Ÿåœ°é»ƒï¼ˆæ»‹é™°è£œè¡€ï¼‰ï¼ˆç›Šç²¾å¡«é«“ï¼‰
èŒ¯è‹“ï¼¼å¥è„¾åˆ©æ°´ï¼å¯§å¿ƒå®‰ç¥
ä¸¹åƒâ†’æ´»è¡€åŒ–ç˜€|æ¶¼è¡€æ¶ˆç™°|é™¤ç…©å®‰ç¥`
        };

        // Helper functions
        function loadSampleData(type) {
            const template = sampleTemplates[type];
            if (template) {
                importData.value = template;
                const templateNames = {
                    'basic': 'åŸºç¤ä¸­è—¥',
                    'formula': 'å¸¸ç”¨æ–¹åŠ‘', 
                    'modern': 'ç¾ä»£æ‡‰ç”¨',
                    'mixed': 'æ··åˆæ ¼å¼',
                    'punctuation': 'æ¨™é»ç¬¦è™Ÿç¯„ä¾‹'
                };
                showToast(`å·²è¼‰å…¥${templateNames[type]}ç¯„æœ¬`, 'success');
            }
        }

        // Event listeners
        searchBtn.addEventListener('click', searchFunction);
        clearBtn.addEventListener('click', () => {
            searchInput.value = '';
            searchResults.classList.add('hidden');
        });
        importBtn.addEventListener('click', importDataFunction);
        clearAllBtn.addEventListener('click', clearAllData);
        clearDatabaseBtn.addEventListener('click', clearDatabase);
        
        // Sample data buttons
        sampleData1.addEventListener('click', () => loadSampleData('basic'));
        sampleData2.addEventListener('click', () => loadSampleData('formula'));
        sampleData3.addEventListener('click', () => loadSampleData('modern'));
        sampleData4.addEventListener('click', () => loadSampleData('mixed'));
        sampleData5.addEventListener('click', () => loadSampleData('punctuation'));

        // Auto-detect format on input change
        importData.addEventListener('input', () => {
            if (importData.value.trim()) {
                const detectedFormat = detectFormat(importData.value);
                const formatNames = {
                    colon: 'å†’è™Ÿæ ¼å¼',
                    comma: 'é€—è™Ÿæ ¼å¼',
                    tab: 'Tabæ ¼å¼',
                    space: 'ç©ºæ ¼æ ¼å¼',
                    arrow: 'ç®­é ­æ ¼å¼',
                    bracket: 'æ–¹æ‹¬è™Ÿæ ¼å¼',
                    json: 'JSONæ ¼å¼'
                };
                
                formatHint.textContent = `è­˜åˆ¥ï¼š${formatNames[detectedFormat] || 'æœªçŸ¥æ ¼å¼'}`;
            } else {
                formatHint.textContent = '';
            }
        });

        // Enter key support
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchFunction();
            }
        });



        // Initialize the application
        initializeFirebase();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96647b88334ef7d9',t:'MTc1MzcwNjgyMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
