<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中醫診症輔助工具 - 雲端版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, push, onValue, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBtUcrBYiE4B1O4xkvIqwxM52Hrh-i6pL8",
            authDomain: "cheungec-ea477.firebaseapp.com",
            databaseURL: "https://cheungec-ea477-default-rtdb.firebaseio.com/",
            projectId: "cheungec-ea477",
            storageBucket: "cheungec-ea477.firebasestorage.app",
            messagingSenderId: "986510230799",
            appId: "1:986510230799:web:f603e67b605e71294f2a7a"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Make Firebase functions globally available
        window.firebaseDB = {
            ref: ref,
            set: set,
            get: get,
            push: push,
            onValue: onValue,
            remove: remove,
            database: database
        };
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .search-result:hover {
            transform: translateY(-2px);
            transition: all 0.2s ease;
        }
        .loading {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-lg border-b-4 border-green-500">
        <div class="max-w-6xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-green-600 to-green-700 rounded-lg flex items-center justify-center">
                        <span class="text-white font-bold text-lg">中</span>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">中醫診症輔助工具</h1>
                        <p class="text-sm text-gray-600">雲端共享版 - 即時同步</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="connectionStatus" class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                        <span class="text-sm text-gray-600">已連線</span>
                    </div>
                    <div class="text-sm text-gray-600">
                        專業版 v2.0
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-6xl mx-auto px-6 py-8">
        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="text-center py-8">
            <div class="loading text-gray-600">正在載入雲端資料...</div>
        </div>

        <!-- Main Content Grid -->
        <div id="mainContent" class="grid grid-cols-1 lg:grid-cols-3 gap-8 hidden">
            
            <!-- Left Panel - Search -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Search Section -->
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        智能搜尋
                    </h2>
                    
                    <div class="relative mb-4">
                        <input 
                            type="text" 
                            id="searchInput" 
                            placeholder="輸入症狀或中藥名稱進行搜尋..."
                            class="w-full px-4 py-3 pl-12 border-2 border-gray-200 rounded-lg focus:border-green-500 focus:outline-none transition-colors text-gray-700"
                        >
                        <svg class="w-5 h-5 text-gray-400 absolute left-4 top-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>

                    <div class="flex space-x-3 mb-4">
                        <button id="searchBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                            搜尋
                        </button>
                        <button id="clearBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                            清除
                        </button>
                    </div>
                </div>

                <!-- Search Results -->
                <div id="searchResults" class="bg-white rounded-xl shadow-lg border border-gray-100 hidden">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">搜尋結果</h3>
                        <div id="resultsContainer"></div>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Data Import -->
            <div class="space-y-6">
                <!-- Data Import Section -->
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                        </svg>
                        資料導入 (雲端同步)
                    </h2>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            格式：中藥名：症狀
                        </label>
                        <textarea 
                            id="importData" 
                            placeholder="例如：&#10;當歸：補血調經&#10;黃芪：補氣固表&#10;人參：大補元氣"
                            class="w-full h-32 px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none transition-colors resize-none text-sm"
                        ></textarea>
                    </div>
                    
                    <button id="importBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-medium transition-colors mb-3">
                        導入到雲端
                    </button>
                    
                    <button id="clearAllBtn" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg font-medium transition-colors text-sm">
                        清空所有資料
                    </button>
                </div>

                <!-- Statistics -->
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">即時統計</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">中藥總數：</span>
                            <span id="herbCount" class="font-semibold text-green-600">載入中...</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">症狀總數：</span>
                            <span id="symptomCount" class="font-semibold text-blue-600">載入中...</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">資料條目：</span>
                            <span id="recordCount" class="font-semibold text-purple-600">載入中...</span>
                        </div>
                    </div>
                </div>

                <!-- Online Users (Demo) -->
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">線上狀態</h3>
                    <div class="flex items-center space-x-2">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="text-sm text-gray-600">多人協作模式</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Display -->
        <div id="dataDisplay" class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-8 hidden">
            <!-- Herbs List -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-green-500 rounded-full mr-2"></div>
                        中藥資料庫
                    </div>
                    <div class="text-xs text-gray-500">即時同步</div>
                </h3>
                <div id="herbsList" class="max-h-64 overflow-y-auto space-y-2">
                    <p class="text-gray-500 text-center py-8">載入中...</p>
                </div>
            </div>

            <!-- Symptoms List -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-blue-500 rounded-full mr-2"></div>
                        症狀資料庫
                    </div>
                    <div class="text-xs text-gray-500">即時同步</div>
                </h3>
                <div id="symptomsList" class="max-h-64 overflow-y-auto space-y-2">
                    <p class="text-gray-500 text-center py-8">載入中...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50">
        <div class="flex items-center space-x-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span id="toastMessage">操作成功</span>
        </div>
    </div>

    <script>
        // Global variables
        let herbsData = {};
        let symptomsData = {};
        let recordsData = {};
        let isFirebaseReady = false;

        // DOM elements
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const clearBtn = document.getElementById('clearBtn');
        const searchResults = document.getElementById('searchResults');
        const resultsContainer = document.getElementById('resultsContainer');
        const importData = document.getElementById('importData');
        const importBtn = document.getElementById('importBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const herbCount = document.getElementById('herbCount');
        const symptomCount = document.getElementById('symptomCount');
        const recordCount = document.getElementById('recordCount');
        const herbsList = document.getElementById('herbsList');
        const symptomsList = document.getElementById('symptomsList');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const mainContent = document.getElementById('mainContent');
        const dataDisplay = document.getElementById('dataDisplay');
        const connectionStatus = document.getElementById('connectionStatus');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');

        // Wait for Firebase to be ready
        function waitForFirebase() {
            return new Promise((resolve) => {
                const checkFirebase = () => {
                    if (window.firebaseDB) {
                        resolve();
                    } else {
                        setTimeout(checkFirebase, 100);
                    }
                };
                checkFirebase();
            });
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            toastMessage.textContent = message;
            toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-transform duration-300 z-50 ${
                type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            } text-white`;
            toast.style.transform = 'translateX(0)';
            
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
            }, 3000);
        }

        // Initialize Firebase listeners
        async function initializeFirebase() {
            try {
                await waitForFirebase();
                
                // Listen to records data
                const recordsRef = window.firebaseDB.ref(window.firebaseDB.database, 'tcm-records');
                window.firebaseDB.onValue(recordsRef, (snapshot) => {
                    const data = snapshot.val();
                    recordsData = data || {};
                    processRecordsData();
                    updateDisplay();
                    
                    if (!isFirebaseReady) {
                        isFirebaseReady = true;
                        loadingIndicator.classList.add('hidden');
                        mainContent.classList.remove('hidden');
                        dataDisplay.classList.remove('hidden');
                        showToast('雲端資料載入完成', 'success');
                    }
                });

                updateConnectionStatus(true);
            } catch (error) {
                console.error('Firebase initialization error:', error);
                updateConnectionStatus(false);
                showToast('連線失敗，使用離線模式', 'error');
                
                // Show content anyway for demo
                loadingIndicator.classList.add('hidden');
                mainContent.classList.remove('hidden');
                dataDisplay.classList.remove('hidden');
            }
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            const statusDot = connectionStatus.querySelector('div');
            const statusText = connectionStatus.querySelector('span');
            
            if (connected) {
                statusDot.className = 'w-3 h-3 bg-green-500 rounded-full';
                statusText.textContent = '已連線';
            } else {
                statusDot.className = 'w-3 h-3 bg-red-500 rounded-full';
                statusText.textContent = '離線';
            }
        }

        // Process records data into herbs and symptoms
        function processRecordsData() {
            herbsData = {};
            symptomsData = {};

            Object.values(recordsData).forEach(record => {
                const herb = record.herb;
                const symptom = record.symptom;

                // Add to herbs data
                if (!herbsData[herb]) {
                    herbsData[herb] = [];
                }
                if (!herbsData[herb].includes(symptom)) {
                    herbsData[herb].push(symptom);
                }

                // Add to symptoms data
                if (!symptomsData[symptom]) {
                    symptomsData[symptom] = [];
                }
                if (!symptomsData[symptom].includes(herb)) {
                    symptomsData[symptom].push(herb);
                }
            });
        }

        // Import data to Firebase
        async function importDataFunction() {
            const data = importData.value.trim();
            if (!data) {
                showToast('請輸入要導入的資料', 'error');
                return;
            }

            if (!isFirebaseReady) {
                showToast('正在連線中，請稍候...', 'info');
                return;
            }

            const lines = data.split('\n');
            let importCount = 0;

            try {
                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (trimmedLine && trimmedLine.includes('：')) {
                        const [herb, symptom] = trimmedLine.split('：');
                        const herbName = herb.trim();
                        const symptomName = symptom.trim();

                        if (herbName && symptomName) {
                            // Create unique key for the record
                            const recordKey = `${herbName}_${symptomName}`.replace(/[.#$[\]]/g, '_');
                            const recordRef = window.firebaseDB.ref(window.firebaseDB.database, `tcm-records/${recordKey}`);
                            
                            await window.firebaseDB.set(recordRef, {
                                herb: herbName,
                                symptom: symptomName,
                                timestamp: Date.now()
                            });

                            importCount++;
                        }
                    }
                }

                importData.value = '';
                showToast(`成功導入 ${importCount} 筆資料到雲端`, 'success');
            } catch (error) {
                console.error('Import error:', error);
                showToast('導入失敗，請檢查網路連線', 'error');
            }
        }

        // Clear all data
        async function clearAllData() {
            if (!confirm('確定要清空所有雲端資料嗎？此操作無法復原！')) {
                return;
            }

            if (!isFirebaseReady) {
                showToast('正在連線中，請稍候...', 'info');
                return;
            }

            try {
                const recordsRef = window.firebaseDB.ref(window.firebaseDB.database, 'tcm-records');
                await window.firebaseDB.set(recordsRef, null);
                showToast('所有資料已清空', 'success');
            } catch (error) {
                console.error('Clear error:', error);
                showToast('清空失敗，請檢查網路連線', 'error');
            }
        }

        // Search function
        function searchFunction() {
            const query = searchInput.value.trim();
            if (!query) {
                showToast('請輸入搜尋關鍵字', 'error');
                return;
            }

            let results = [];

            // Search in herbs
            if (herbsData[query]) {
                results.push({
                    type: '中藥',
                    name: query,
                    items: herbsData[query],
                    label: '對應症狀'
                });
            }

            // Search in symptoms
            if (symptomsData[query]) {
                results.push({
                    type: '症狀',
                    name: query,
                    items: symptomsData[query],
                    label: '對應中藥'
                });
            }

            // Partial search
            Object.keys(herbsData).forEach(herb => {
                if (herb.includes(query) && herb !== query) {
                    results.push({
                        type: '中藥',
                        name: herb,
                        items: herbsData[herb],
                        label: '對應症狀'
                    });
                }
            });

            Object.keys(symptomsData).forEach(symptom => {
                if (symptom.includes(query) && symptom !== query) {
                    results.push({
                        type: '症狀',
                        name: symptom,
                        items: symptomsData[symptom],
                        label: '對應中藥'
                    });
                }
            });

            displayResults(results, query);
        }

        // Display search results
        function displayResults(results, query) {
            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-gray-400 text-lg mb-2">😔</div>
                        <p class="text-gray-500">未找到與「${query}」相關的資料</p>
                    </div>
                `;
            } else {
                resultsContainer.innerHTML = results.map(result => `
                    <div class="search-result bg-gray-50 rounded-lg p-4 mb-4 border-l-4 ${result.type === '中藥' ? 'border-green-500' : 'border-blue-500'} fade-in">
                        <div class="flex items-center mb-2">
                            <span class="inline-block px-2 py-1 text-xs font-medium rounded ${result.type === '中藥' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">${result.type}</span>
                            <h4 class="font-semibold text-gray-800 ml-2">${result.name}</h4>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">${result.label}：</p>
                        <div class="flex flex-wrap gap-2">
                            ${result.items.map(item => `
                                <span class="inline-block px-3 py-1 bg-white text-gray-700 rounded-full text-sm border border-gray-200 hover:bg-gray-100 cursor-pointer" onclick="searchInput.value='${item}'; searchFunction();">${item}</span>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            }

            searchResults.classList.remove('hidden');
            searchResults.scrollIntoView({ behavior: 'smooth' });
        }

        // Update display
        function updateDisplay() {
            // Update counts
            herbCount.textContent = Object.keys(herbsData).length;
            symptomCount.textContent = Object.keys(symptomsData).length;
            recordCount.textContent = Object.keys(recordsData).length;

            // Update herbs list
            if (Object.keys(herbsData).length === 0) {
                herbsList.innerHTML = '<p class="text-gray-500 text-center py-8">暫無資料，請先導入中藥資料</p>';
            } else {
                herbsList.innerHTML = Object.keys(herbsData).sort().map(herb => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors" onclick="searchInput.value='${herb}'; searchFunction();">
                        <span class="font-medium text-gray-800">${herb}</span>
                        <span class="text-xs text-gray-500">${herbsData[herb].length} 個症狀</span>
                    </div>
                `).join('');
            }

            // Update symptoms list
            if (Object.keys(symptomsData).length === 0) {
                symptomsList.innerHTML = '<p class="text-gray-500 text-center py-8">暫無資料，請先導入症狀資料</p>';
            } else {
                symptomsList.innerHTML = Object.keys(symptomsData).sort().map(symptom => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors" onclick="searchInput.value='${symptom}'; searchFunction();">
                        <span class="font-medium text-gray-800">${symptom}</span>
                        <span class="text-xs text-gray-500">${symptomsData[symptom].length} 種中藥</span>
                    </div>
                `).join('');
            }
        }

        // Event listeners
        searchBtn.addEventListener('click', searchFunction);
        clearBtn.addEventListener('click', () => {
            searchInput.value = '';
            searchResults.classList.add('hidden');
        });
        importBtn.addEventListener('click', importDataFunction);
        clearAllBtn.addEventListener('click', clearAllData);

        // Enter key support
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchFunction();
            }
        });

        // Initialize the application
        initializeFirebase();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'966277c442db03d3',t:'MTc1MzY4NTY5NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
