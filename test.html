<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰∏≠ÈÜ´Ë®∫ÊâÄÁ≥ªÁµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
<script type="module">
    // Import Firebase functions
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, setDoc, onSnapshot, query, where, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getDatabase, ref, set, get, child, push, update, remove, onValue, off } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    // ÊÇ®ÁöÑ Firebase ÈÖçÁΩÆÔºàË´ãÊõøÊèõÊàêÊÇ®ÁöÑÂØ¶ÈöõÈÖçÁΩÆÔºâ
const firebaseConfig = {
  apiKey: "AIzaSyCx_BLIWVKZs0vJa5TwL6zoycJexY_5nXU",
  authDomain: "system-1e90a.firebaseapp.com",
  databaseURL: "https://system-1e90a-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "system-1e90a",
  storageBucket: "system-1e90a.firebasestorage.app",
  messagingSenderId: "80947900109",
  appId: "1:80947900109:web:b6cd62bb2f1e07971a4384"
};

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);
    const auth = getAuth(app);

    // ËÆìÂÖ∂‰ªñËÖ≥Êú¨ÂèØ‰ª•‰ΩøÁî® Firebase
    window.firebase = {
        app, db, rtdb, auth,
        collection, addDoc, getDocs, doc, updateDoc, deleteDoc, setDoc, onSnapshot, query, where, orderBy, limit,
        ref, set, get, child, push, update, remove, onValue, off,
        signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged
    };

    // ÈÄ£Êé•ÁãÄÊÖãÁõ£Êéß
    window.firebaseConnected = false;
    const connectedRef = ref(rtdb, '.info/connected');
    onValue(connectedRef, (snapshot) => {
        if (snapshot.val() === true) {
            window.firebaseConnected = true;
            console.log('Firebase Â∑≤ÈÄ£Êé•');
        } else {
            window.firebaseConnected = false;
            console.log('Firebase ÈÄ£Êé•‰∏≠Êñ∑');
        }
    });

    console.log('Firebase ÂàùÂßãÂåñÂÆåÊàê');
</script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* ÊµÆÂãïÊèêÁ§∫Ê®£Âºè */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            max-width: 500px;
            padding: 16px 20px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transform: translateX(100%);
            transition: all 0.3s ease-in-out;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .toast.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .toast.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .toast.info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }
        
        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .toast-content {
            flex: 1;
            line-height: 1.4;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">
    <!-- ÁôªÂÖ•È†ÅÈù¢ -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="text-4xl mb-4">üè•</div>
                <h1 id="loginTitle" class="text-2xl font-bold text-gray-800 mb-2">‰∏≠ÈÜ´Ë®∫ÊâÄÁ≥ªÁµ±</h1>
                <p id="loginEnglishTitle" class="text-sm text-gray-500 mb-3">TCM Clinic</p>
                <p class="text-gray-600">Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑÈõªÂ≠êÈÉµ‰ª∂ÂèäÂØÜÁ¢ºÁôªÂÖ•</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ÈõªÂ≠êÈÉµ‰ª∂</label>
                    <input type="email" id="mainLoginUsername" placeholder="Ë´ãËº∏ÂÖ•ÈõªÂ≠êÈÉµ‰ª∂" 
                           class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           onkeypress="if(event.key==='Enter') document.getElementById('mainLoginPassword').focus()">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ÂØÜÁ¢º</label>
                    <input type="password" id="mainLoginPassword" placeholder="Ë´ãËº∏ÂÖ•ÂØÜÁ¢º" 
                           class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           onkeypress="if(event.key==='Enter') attemptMainLogin()">
                </div>
                
                <button onclick="attemptMainLogin()" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                    ÁôªÂÖ•Á≥ªÁµ±
                </button>
                
                <!-- Á§∫ÁØÑÂ∏≥ËôüÊèêÁ§∫ÂçÄÂ∑≤ÁßªÈô§ÔºåÁ≥ªÁµ±‰ΩøÁî®ËÄÖË´ã‰ΩøÁî®ÊÇ®ÁöÑÈõªÂ≠êÈÉµ‰ª∂ÁôªÂÖ• -->
            </div>
        </div>
    </div>

    <!-- ‰∏ªÁ≥ªÁµ±È†ÅÈù¢ -->
    <div id="mainSystem" class="hidden fade-in">
        <!-- ÂÅ¥ÈÇäÈÅ∏ÂñÆ -->
        <div id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-2xl transform -translate-x-full transition-transform duration-300 ease-in-out">
            <div class="flex flex-col h-full">
                <!-- ÈÅ∏ÂñÆÊ®ôÈ°å -->
                <div class="bg-green-600 text-white p-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">üè•</span>
                            <h2 class="text-lg font-bold">Ë®∫ÊâÄÂäüËÉΩ</h2>
                        </div>
                        <button onclick="toggleSidebar()" class="text-white hover:text-gray-200 text-xl">
                            √ó
                        </button>
                    </div>
                    <div id="sidebarUserRole" class="text-sm text-green-100 mt-2"></div>
                </div>

                <!-- ÂäüËÉΩÈÅ∏ÂñÆÈ†ÖÁõÆ -->
                <div class="flex-1 py-4">
                    <div id="sidebarMenu" class="space-y-2 px-4">
                        <!-- ÈÅ∏ÂñÆÈ†ÖÁõÆÊúÉÂãïÊÖãÁîüÊàê -->
                    </div>
                </div>

                <!-- Â∫ïÈÉ®Êìç‰Ωú -->
                <div class="border-t border-gray-200 p-4">
                    <button onclick="logout()" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg text-sm transition duration-200 flex items-center justify-center">
                        <span class="mr-2">üö™</span>
                        ÁôªÂá∫Á≥ªÁµ±
                    </button>
                </div>
            </div>
        </div>

        <!-- ÈÅÆÁΩ©Â±§ -->
        <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden" onclick="toggleSidebar()"></div>

        <!-- È†ÇÈÉ®Â∞éËà™ -->
        <nav class="bg-white shadow-lg border-b-4 border-green-500">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <button onclick="toggleSidebar()" class="mr-4 p-2 rounded-lg hover:bg-gray-100 transition duration-200">
                            <div class="w-6 h-6 flex flex-col justify-center space-y-1">
                                <div class="w-full h-0.5 bg-gray-600"></div>
                                <div class="w-full h-0.5 bg-gray-600"></div>
                                <div class="w-full h-0.5 bg-gray-600"></div>
                            </div>
                        </button>
                        <span class="text-2xl mr-3">üè•</span>
                        <div>
                            <h1 id="systemTitle" class="text-xl font-bold text-gray-800">‰∏≠ÈÜ´Ë®∫ÊâÄÁ≥ªÁµ±</h1>
                            <p id="systemEnglishTitle" class="text-xs text-gray-500">TCM Clinic</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="userRole" class="text-sm text-gray-600"></span>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                            ÁôªÂá∫
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- ‰∏ªË¶ÅÂÖßÂÆπÂçÄÂüü -->
        <div class="max-w-7xl mx-auto px-4 py-6">
            <!-- Ê≠°ËøéÈ†ÅÈù¢ -->
            <div id="welcomePage" class="text-center py-16">
                <div class="text-6xl mb-6">üè•</div>
                <h2 id="welcomeTitle" class="text-3xl font-bold text-gray-800 mb-2">Ê≠°Ëøé‰ΩøÁî®‰∏≠ÈÜ´Ë®∫ÊâÄÁ≥ªÁµ±</h2>
                <p id="welcomeEnglishTitle" class="text-lg text-gray-500 mb-4">Welcome to TCM Clinic</p>
                <p class="text-gray-600 text-lg mb-8">Ë´ãÈªûÊìäÂ∑¶‰∏äËßíÈÅ∏ÂñÆÊåâÈàïÈñãÂßã‰ΩøÁî®Á≥ªÁµ±ÂäüËÉΩ</p>
                <div class="bg-white rounded-xl shadow-lg p-8 max-w-4xl mx-auto">
                    <h3 class="text-xl font-semibold mb-4">Á≥ªÁµ±ÂäüËÉΩÊ¶ÇË¶Ω</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <div class="text-2xl mb-2">üë•</div>
                            <div class="font-semibold">ÁóÖ‰∫∫Ë≥áÊñôÁÆ°ÁêÜ</div>
                            <div class="text-gray-600 mt-1">Êñ∞Â¢û„ÄÅÊü•Áúã„ÄÅÁÆ°ÁêÜÁóÖ‰∫∫Ë≥áÊñô</div>
                        </div>
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <div class="text-2xl mb-2">ü©∫</div>
                            <div class="font-semibold">Ë®∫ÁóáÁ≥ªÁµ±</div>
                            <div class="text-gray-600 mt-1">Ë®òÈåÑÁóáÁãÄ„ÄÅË®∫Êñ∑„ÄÅÈñãÁ´ãËôïÊñπ</div>
                        </div>
                        <div class="text-center p-4 bg-purple-50 rounded-lg">
                            <div class="text-2xl mb-2">üë§</div>
                            <div class="font-semibold">Áî®Êà∂ÁÆ°ÁêÜ</div>
                            <div class="text-gray-600 mt-1">ÁÆ°ÁêÜË®∫ÊâÄÁî®Êà∂Ê¨äÈôê</div>
                        </div>
                        <div class="text-center p-4 bg-red-50 rounded-lg">
                            <div class="text-2xl mb-2">‚öôÔ∏è</div>
                            <div class="font-semibold">Á≥ªÁµ±ÁÆ°ÁêÜ</div>
                            <div class="text-gray-600 mt-1">Áµ±Ë®àË≥áÊñô„ÄÅÂÇô‰ªΩÂåØÂá∫</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÁóÖ‰∫∫Ë≥áÊñôÁÆ°ÁêÜ -->
            <div id="patientManagement" class="hidden bg-white rounded-xl shadow-lg p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">ÁóÖ‰∫∫Ë≥áÊñôÁÆ°ÁêÜ</h2>
                    <div class="flex flex-col md:flex-row gap-3">
                        <div class="relative">
                            <input type="text" id="searchPatient" placeholder="ÊêúÂ∞ãÁóÖ‰∫∫Á∑®Ëôü„ÄÅÂßìÂêçÊàñÈõªË©±..." class="border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:ring-2 focus:ring-green-500 focus:border-transparent w-full md:w-64">
                            <span class="absolute right-3 top-2.5 text-gray-400">üîç</span>
                        </div>
                        <button onclick="showAddPatientForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200 whitespace-nowrap">
                            + Êñ∞Â¢ûÁóÖ‰∫∫
                        </button>
                    </div>
                </div>

                <!-- Êñ∞Â¢û/Á∑®ËºØÁóÖ‰∫∫Ë°®ÂñÆÂΩàÁ™ó -->
                <div id="addPatientModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                            <h3 id="formTitle" class="text-xl font-bold text-gray-800">Êñ∞Â¢ûÁóÖ‰∫∫Ë≥áÊñô</h3>
                            <button onclick="hideAddPatientForm()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ÂßìÂêç *</label>
                                    <input type="text" id="patientName" placeholder="Ë´ãËº∏ÂÖ•ÂßìÂêç" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Âπ¥ÈΩ°</label>
                                    <input type="number" id="patientAge" placeholder="Á≥ªÁµ±Ëá™ÂãïË®àÁÆó" min="0" max="120" readonly class="w-full border border-gray-300 rounded-lg px-4 py-2 bg-gray-100 text-gray-600">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ÊÄßÂà• *</label>
                                    <select id="patientGender" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                        <option value="">Ë´ãÈÅ∏ÊìáÊÄßÂà•</option>
                                        <option value="Áî∑">Áî∑</option>
                                        <option value="Â•≥">Â•≥</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ÈõªË©±ËôüÁ¢º *</label>
                                    <input type="tel" id="patientPhone" placeholder="‰æãÔºö0912-345-678" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <!-- Â∞áË∫´ÂàÜË≠âÂ≠óËôüË®≠ÁÇ∫ÂøÖÂ°´Ôºå‰∏¶ÁßªÈô§Âõ∫ÂÆöÈï∑Â∫¶ÈôêÂà∂ -->
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Ë∫´ÂàÜË≠âÂ≠óËôü *</label>
                                    <input type="text" id="patientIdCard" placeholder="‰æãÔºöA123456789" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Âá∫ÁîüÊó•Êúü *</label>
                                    <input type="date" id="patientBirthDate" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent" onchange="updatePatientAge()">
                                </div>
                                <div class="md:col-span-2 lg:col-span-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ËÅØÁµ°Âú∞ÂùÄ</label>
                                    <textarea id="patientAddress" placeholder="Ë´ãËº∏ÂÖ•ÂÆåÊï¥Âú∞ÂùÄ" rows="2" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                                </div>
                                <div class="md:col-span-2 lg:col-span-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ÈÅéÊïèÂè≤</label>
                                    <textarea id="patientAllergies" placeholder="Ë´ãË©≥Á¥∞Ë®òÈåÑËó•Áâ©ÈÅéÊïèÊàñÈ£üÁâ©ÈÅéÊïèÂè≤" rows="2" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                                </div>
                                <div class="md:col-span-2 lg:col-span-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ÁóÖÂè≤ÂèäÂÇôË®ª</label>
                                    <textarea id="patientHistory" placeholder="Ë´ãË®òÈåÑÈáçË¶ÅÁóÖÂè≤„ÄÅÂÆ∂ÊóèÁóÖÂè≤„ÄÅÊÖ¢ÊÄßÁñæÁóÖÁ≠â" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-gray-200">
                                <button onclick="hideAddPatientForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                                    ÂèñÊ∂à
                                </button>
                                <button onclick="savePatient()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200">
                                    <span id="saveButtonText">ÂÑ≤Â≠ò</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ÁóÖ‰∫∫ÂàóË°® -->
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Á∑®Ëôü</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ÂßìÂêç</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Âπ¥ÈΩ°</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ÊÄßÂà•</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ÈõªË©±</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody id="patientList" class="divide-y divide-gray-200">
                            <!-- ÁóÖ‰∫∫Ë≥áÊñôÊúÉÂãïÊÖãËºâÂÖ• -->
                        </tbody>
                    </table>
                </div>

                <!-- ÁóÖ‰∫∫Ë©≥Á¥∞Ë≥áÊñôÂΩàÁ™ó -->
                <div id="patientDetailModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
                            <h3 class="text-xl font-bold text-gray-800">ÁóÖ‰∫∫Ë©≥Á¥∞Ë≥áÊñô</h3>
                            <button onclick="closePatientDetail()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                        </div>
                        <div id="patientDetailContent" class="p-6">
                            <!-- Ë©≥Á¥∞ÂÖßÂÆπÊúÉÂãïÊÖãËºâÂÖ• -->
                        </div>
                    </div>
                </div>

                <!-- ÁóÖ‰∫∫ÁóÖÊ≠∑Êü•ÁúãÂΩàÁ™ó -->
                <div id="patientMedicalHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                            <h3 id="patientMedicalHistoryTitle" class="text-xl font-bold text-gray-800">ÁóÖÊ≠∑Ë®òÈåÑ</h3>
                            <button onclick="closePatientMedicalHistoryModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                        </div>
                        
                        <div class="p-6">
                            <!-- ÁóÖ‰∫∫Âü∫Êú¨Ë≥áË®ä -->
                            <div id="patientMedicalHistoryPatientInfo" class="bg-blue-50 rounded-lg p-4 mb-6">
                                <!-- ÁóÖ‰∫∫Ë≥áË®äÊúÉÂãïÊÖãËºâÂÖ• -->
                            </div>
                            
                            <!-- Ë®∫ÁóáË®òÈåÑÂàóË°® -->
                            <div id="patientMedicalHistoryContent">
                                <!-- Ë®∫ÁóáË®òÈåÑÊúÉÂãïÊÖãËºâÂÖ• -->
                            </div>
                        </div>
                    </div>
                </div>




            </div>

            <!-- Ë®∫ÁóáÁ≥ªÁµ± -->
            <div id="consultationSystem" class="hidden bg-white rounded-xl shadow-lg p-6">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">ÊéõËôüË®∫ÁóáÁ≥ªÁµ±</h2>
                    <p class="text-gray-600 mt-2">Á∞°ÊΩîÁöÑÊéõËôüÊµÅÁ®ãÁÆ°ÁêÜ</p>
                </div>
                
                <!-- ÁóÖ‰∫∫ÊêúÁ¥¢ÊéõËôü -->
                <div class="bg-gradient-to-r from-blue-50 to-green-50 rounded-lg p-6 mb-6">
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold text-gray-800 flex items-center mb-2">
                            <span class="mr-2">üîç</span>ÊêúÁ¥¢ÁóÖ‰∫∫ÊéõËôü
                        </h3>
                        <p class="text-sm text-gray-600">Ë´ãËº∏ÂÖ•ÁóÖ‰∫∫ÂßìÂêç„ÄÅÁ∑®ËôüÊàñÈõªË©±ÈÄ≤Ë°åÊêúÁ¥¢</p>
                    </div>
                    
                    <div class="flex gap-3">
                        <div class="flex-1 relative">
                            <input type="text" id="patientSearchInput" placeholder="ÊêúÂ∞ãÁóÖ‰∫∫ÂßìÂêç„ÄÅÁ∑®ËôüÊàñÈõªË©±..." 
                                   class="w-full border border-gray-300 rounded-lg px-4 py-3 pr-10 focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                   oninput="searchPatientsForRegistration()">
                            <span class="absolute right-3 top-3.5 text-gray-400">üîç</span>
                        </div>
                        <button onclick="clearPatientSearch()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-lg transition duration-200">
                            Ê∏ÖÈô§
                        </button>
                    </div>
                    
                    <!-- ÊêúÁ¥¢ÁµêÊûú -->
                    <div id="patientSearchResults" class="mt-4 hidden">
                        <div class="bg-white rounded-lg border border-gray-200 max-h-64 overflow-y-auto">
                            <div id="searchResultsList" class="divide-y divide-gray-200">
                                <!-- ÊêúÁ¥¢ÁµêÊûúÊúÉÂãïÊÖãËºâÂÖ• -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ÊéõËôüÂΩàÁ™ó -->
                <div id="registrationModal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
                        <div class="bg-green-600 text-white px-6 py-4 rounded-t-xl">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-bold">ÁóÖ‰∫∫ÊéõËôü</h3>
                                <button onclick="closeRegistrationModal()" class="text-white hover:text-gray-200 text-2xl">√ó</button>
                            </div>
                        </div>
                        
                        <div class="p-6 space-y-4">
                            <!-- ÈÅ∏‰∏≠ÁöÑÁóÖ‰∫∫Ë≥áË®ä -->
                            <div class="bg-blue-50 rounded-lg p-4">
                                <div class="flex items-center mb-2">
                                    <span class="mr-2">üë§</span>
                                    <span class="font-semibold text-gray-700">ÁóÖ‰∫∫Ë≥áË®ä</span>
                                </div>
                                <div id="selectedPatientInfo" class="text-sm text-gray-600">
                                    <!-- ÁóÖ‰∫∫Ë≥áË®äÊúÉÂãïÊÖãËºâÂÖ• -->
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <span class="mr-2">üë®‚Äç‚öïÔ∏è</span>ÊéõËôüÈÜ´Â∏´ *
                                </label>
                                <select id="appointmentDoctor" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="">Ë´ãÈÅ∏ÊìáÈÜ´Â∏´</option>
                                    <!-- ÈÜ´Â∏´ÈÅ∏È†ÖÊúÉÂãïÊÖãËºâÂÖ• -->
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <span class="mr-2">‚è∞</span>ÊéõËôüÊôÇÈñì
                                </label>
                                <input type="datetime-local" id="appointmentDateTime" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <span class="mr-2">üìù</span>‰∏ªË®¥ÁóáÁãÄ
                                </label>
                                <textarea id="quickChiefComplaint" placeholder="Ë´ãÁ∞°Ëø∞ÁóÖ‰∫∫ÁöÑ‰∏ªË¶ÅÁóáÁãÄ..." rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                            </div>
                            
                            <div class="flex space-x-3 pt-4">
                                <button onclick="closeRegistrationModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg transition duration-200">
                                    ÂèñÊ∂à
                                </button>
                                <button onclick="confirmRegistration()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                    Á¢∫Ë™çÊéõËôü
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ‰ªäÊó•ÊéõËôüÂàóË°® -->
                <div class="bg-white border border-gray-200 rounded-lg">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 rounded-t-lg">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                                <span class="mr-2">üìÖ</span>‰ªäÊó•ÊéõËôüÂàóË°®
                            </h3>
                            <div class="text-sm text-gray-600">
                                Á∏ΩË®àÔºö<span id="todayTotal" class="font-semibold text-blue-600">0</span> ‰∫∫
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Â∫èËôü</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ÁóÖ‰∫∫ÂßìÂêç</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ÊéõËôüÈÜ´Â∏´</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ÊéõËôüÊôÇÈñì</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‰∏ªË®¥ÁóáÁãÄ</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ÁãÄÊÖã</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Êìç‰Ωú</th>
                                    </tr>
                                </thead>
                                <tbody id="todayAppointmentsList" class="divide-y divide-gray-200">
                                    <!-- ÊéõËôüÂàóË°®ÊúÉÂãïÊÖãËºâÂÖ• -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>



                <!-- Ë®∫ÁóáË®òÈåÑÊü•ÁúãÂΩàÁ™ó -->
                <div id="medicalHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                            <h3 id="medicalHistoryTitle" class="text-xl font-bold text-gray-800">Ë®∫ÁóáË®òÈåÑ</h3>
                            <button onclick="closeMedicalHistoryModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                        </div>
                        
                        <div class="p-6">
                            <!-- ÁóÖ‰∫∫Âü∫Êú¨Ë≥áË®ä -->
                            <div id="medicalHistoryPatientInfo" class="bg-blue-50 rounded-lg p-4 mb-6">
                                <!-- ÁóÖ‰∫∫Ë≥áË®äÊúÉÂãïÊÖãËºâÂÖ• -->
                            </div>
                            
                            <!-- Ë®∫ÁóáË®òÈåÑÂàóË°® -->
                            <div id="medicalHistoryContent">
                                <!-- Ë®∫ÁóáË®òÈåÑÊúÉÂãïÊÖãËºâÂÖ• -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ë®∫ÁóáË°®ÂñÆÂçÄÂüü -->
                <div id="consultationForm" class="hidden bg-white border border-gray-200 rounded-lg mt-6">
                    <div class="bg-green-600 text-white px-6 py-4 rounded-t-lg">
                        <h3 class="text-xl font-bold">Ë®∫ÁóáË®òÈåÑ</h3>
                    </div>
                    
                    <div class="p-6">
                        <!-- ÁóÖ‰∫∫Ë≥áË®ä -->
                        <div class="bg-blue-50 rounded-lg p-4 mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="font-medium">ÁóÖ‰∫∫Ôºö</span>
                                    <span id="formPatientName" class="text-blue-600 font-semibold"></span>
                                </div>
                                <div>
                                    <span class="font-medium">ÊéõËôüÊôÇÈñìÔºö</span>
                                    <span id="formAppointmentTime"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Ë®∫ÁóáË°®ÂñÆ -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Â∑¶ÂÅ¥ -->
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        ‰∏ªË®¥ *
                                    </label>
                                    <textarea id="formSymptoms" placeholder="ÁóÖ‰∫∫‰∏ªË¶Å‰∏çÈÅ©ÁóáÁãÄ„ÄÅÁôºÁóÖÊôÇÈñì„ÄÅÁóáÁãÄÁâπÈªûÁ≠â..." rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        ËàåË±°
                                    </label>
                                    <textarea id="formTongue" placeholder="ËàåË≥™„ÄÅËàåËãî„ÄÅËàåÂΩ¢Á≠â..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        ËÑàË±°
                                    </label>
                                    <textarea id="formPulse" placeholder="ËÑà‰Ωç„ÄÅËÑàÁéá„ÄÅËÑàÂäõ„ÄÅËÑàÂΩ¢Á≠â..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        ÁèæÁóÖÂè≤
                                    </label>
                                    <textarea id="formCurrentHistory" placeholder="ÁôºÁóÖÁ∂ìÈÅé„ÄÅÁóáÁãÄËÆäÂåñ„ÄÅÊ≤ªÁôÇÁ∂ìÈÅéÁ≠â..." rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        ‰∏≠ÈÜ´Ë®∫Êñ∑ *
                                    </label>
                                    <textarea id="formDiagnosis" placeholder="‰∏≠ÈÜ´ÁóÖÂêçË®∫Êñ∑..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        Ë≠âÂûãË®∫Êñ∑
                                    </label>
                                    <textarea id="formSyndrome" placeholder="Ëæ®Ë≠âÂàÜÂûã„ÄÅÁóÖÊ©üÂàÜÊûê..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        ÈáùÁÅ∏ÂÇôË®ª
                                    </label>
                                    <textarea id="formAcupunctureNotes" placeholder="ÈáùÁÅ∏Á©¥‰Ωç„ÄÅÊâãÊ≥ï„ÄÅÊ≥®ÊÑè‰∫ãÈ†ÖÁ≠â..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                            </div>
                            
                            <!-- Âè≥ÂÅ¥ -->
                            <div class="space-y-4">
                                
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="block text-sm font-semibold text-gray-700">
                                            ËôïÊñπÂÖßÂÆπ
                                        </label>
                                        <button type="button" onclick="loadPreviousPrescription()" 
                                                class="text-xs bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded transition duration-200">
                                            üìã ËºâÂÖ•‰∏äÊ¨°ËôïÊñπ
                                        </button>
                                    </div>
                                    
                                    <!-- ‰∏≠Ëó•Â∫´ÊêúÁ¥¢ÂçÄÂüü -->
                                    <div class="mb-3 bg-yellow-50 rounded-lg p-3 border border-yellow-200">
                                        <div class="flex items-center mb-2">
                                            <span class="text-sm font-medium text-yellow-800 mr-2">üîç ÊêúÁ¥¢‰∏≠Ëó•Â∫´Ôºö</span>
                                            <div class="flex-1 relative">
                                                <input type="text" id="prescriptionSearch" placeholder="ÊêúÁ¥¢‰∏≠Ëó•ÊùêÊàñÊñπÂäëÂêçÁ®±..." 
                                                       class="w-full border border-yellow-300 rounded px-3 py-1 text-sm focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                                       oninput="searchHerbsForPrescription()">
                                                <button onclick="clearPrescriptionSearch()" class="absolute right-2 top-1 text-gray-400 hover:text-gray-600 text-sm">√ó</button>
                                            </div>
                                        </div>
                                        
                                        <!-- ÊêúÁ¥¢ÁµêÊûú -->
                                        <div id="prescriptionSearchResults" class="hidden">
                                            <div class="bg-white rounded border border-yellow-200 max-h-48 overflow-y-auto">
                                                <div id="prescriptionSearchList" class="grid grid-cols-1 md:grid-cols-2 gap-2 p-2">
                                                    <!-- ÊêúÁ¥¢ÁµêÊûúÊúÉÂãïÊÖãËºâÂÖ• -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Â∑≤ÈÅ∏ÊìáÁöÑËôïÊñπÂÖßÂÆπ -->
                                    <div class="border border-gray-300 rounded-lg p-3 min-h-[120px] bg-gray-50">
                                        <div id="selectedPrescriptionItems" class="space-y-2">
                                            <div class="text-sm text-gray-500 text-center py-4">
                                                Ë´ã‰ΩøÁî®‰∏äÊñπÊêúÁ¥¢ÂäüËÉΩÊ∑ªÂä†‰∏≠Ëó•ÊùêÊàñÊñπÂäë
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- ÊúçËó•Â§©Êï∏ÂèäÊ¨°Êï∏Ë®≠ÂÆöÔºàÂè™Âú®ÊúâËôïÊñπÂÖßÂÆπÊôÇÈ°ØÁ§∫Ôºâ -->
                                    <div id="medicationSettings" class="mt-3 bg-yellow-50 rounded-lg p-3 border border-yellow-200" style="display: none;">
                                        <div class="space-y-3">
                                            <!-- ÊúçËó•Â§©Êï∏ -->
                                            <div class="flex items-center justify-between">
                                                <span class="text-sm font-medium text-yellow-800">ÊúçËó•Â§©Êï∏</span>
                                                <div class="flex items-center space-x-2">
                                                    <button onclick="updateMedicationDays(-1)" class="w-7 h-7 bg-yellow-500 text-white rounded-full text-sm hover:bg-yellow-600 transition duration-200">-</button>
                                                    <input type="number" id="medicationDays" value="5" min="1" max="30" 
                                                           class="w-14 px-2 py-1 text-center border border-yellow-300 rounded focus:ring-2 focus:ring-yellow-500 focus:border-transparent text-sm"
                                                           onchange="updateMedicationDaysFromInput()" onclick="this.select()">
                                                    <button onclick="updateMedicationDays(1)" class="w-7 h-7 bg-yellow-500 text-white rounded-full text-sm hover:bg-yellow-600 transition duration-200">+</button>
                                                    <span class="text-sm text-yellow-800">Â§©</span>
                                                </div>
                                            </div>
                                            
                                            <!-- ÊúçËó•Ê¨°Êï∏ -->
                                            <div class="flex items-center justify-between">
                                                <span class="text-sm font-medium text-yellow-800">ÊØèÊó•Ê¨°Êï∏</span>
                                                <div class="flex items-center space-x-2">
                                                    <button onclick="updateMedicationFrequency(-1)" class="w-7 h-7 bg-yellow-500 text-white rounded-full text-sm hover:bg-yellow-600 transition duration-200">-</button>
                                                    <input type="number" id="medicationFrequency" value="2" min="1" max="6" 
                                                           class="w-14 px-2 py-1 text-center border border-yellow-300 rounded focus:ring-2 focus:ring-yellow-500 focus:border-transparent text-sm"
                                                           onchange="updateMedicationFrequency(0)" onclick="this.select()">
                                                    <button onclick="updateMedicationFrequency(1)" class="w-7 h-7 bg-yellow-500 text-white rounded-full text-sm hover:bg-yellow-600 transition duration-200">+</button>
                                                    <span class="text-sm text-yellow-800">Ê¨°/Êó•</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Èö±ËóèÁöÑÊñáÊú¨ÂüüÁî®ÊñºÂ≠òÂÑ≤ËôïÊñπÂÖßÂÆπ -->
                                    <textarea id="formPrescription" class="hidden"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        ÊúçÁî®ÊñπÊ≥ï
                                    </label>
                                    <textarea id="formUsage" placeholder="ÁÖéÁÖÆÊñπÊ≥ï„ÄÅÊúçÁî®ÊôÇÈñì„ÄÅÂäëÈáèÁ≠â..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="block text-sm font-semibold text-gray-700">
                                            Êî∂Ë≤ªÈ†ÖÁõÆ
                                        </label>
                                        <button type="button" onclick="loadPreviousBillingItems()" 
                                                class="text-xs bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded transition duration-200">
                                            üí∞ ËºâÂÖ•‰∏äÊ¨°Êî∂Ë≤ª
                                        </button>
                                    </div>
                                    
                                    <!-- Êî∂Ë≤ªÈ†ÖÁõÆÊêúÁ¥¢ÂçÄÂüü -->
                                    <div class="mb-3 bg-green-50 rounded-lg p-3 border border-green-200">
                                        <div class="flex items-center mb-2">
                                            <span class="text-sm font-medium text-green-800 mr-2">üí∞ ÈÅ∏ÊìáÊî∂Ë≤ªÈ†ÖÁõÆÔºö</span>
                                            <div class="flex-1 relative">
                                                <input type="text" id="billingSearch" placeholder="ÊêúÁ¥¢Êî∂Ë≤ªÈ†ÖÁõÆÂêçÁ®±..." 
                                                       class="w-full border border-green-300 rounded px-3 py-1 text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                       oninput="searchBillingForConsultation()">
                                                <button onclick="clearBillingSearch()" class="absolute right-2 top-1 text-gray-400 hover:text-gray-600 text-sm">√ó</button>
                                            </div>
                                        </div>
                                        
                                        <!-- ÊêúÁ¥¢ÁµêÊûú -->
                                        <div id="billingSearchResults" class="hidden">
                                            <div class="bg-white rounded border border-green-200 max-h-48 overflow-y-auto">
                                                <div id="billingSearchList" class="grid grid-cols-1 md:grid-cols-2 gap-2 p-2">
                                                    <!-- ÊêúÁ¥¢ÁµêÊûúÊúÉÂãïÊÖãËºâÂÖ• -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Â∑≤ÈÅ∏ÊìáÁöÑÊî∂Ë≤ªÈ†ÖÁõÆ -->
                                    <div class="border border-gray-300 rounded-lg p-3 min-h-[80px] bg-gray-50">
                                        <div id="selectedBillingItems" class="space-y-2">
                                            <div class="text-sm text-gray-500 text-center py-4">
                                                Ë´ã‰ΩøÁî®‰∏äÊñπÊêúÁ¥¢ÂäüËÉΩÊ∑ªÂä†Êî∂Ë≤ªÈ†ÖÁõÆ
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Á∏ΩË≤ªÁî®È°ØÁ§∫ -->
                                    <div class="mt-2 text-right">
                                        <span class="text-sm font-medium text-gray-700">Á∏ΩË≤ªÁî®Ôºö</span>
                                        <span id="totalBillingAmount" class="text-lg font-bold text-green-600">$0</span>
                                    </div>
                                    
                                    <!-- Èö±ËóèÁöÑÊñáÊú¨ÂüüÁî®ÊñºÂ≠òÂÑ≤Êî∂Ë≤ªÈ†ÖÁõÆ -->
                                    <textarea id="formBillingItems" class="hidden"></textarea>

                                    <!-- ÁóÖ‰∫∫Â•óÁ•®ÁÆ°ÁêÜ -->
                                    <div class="mt-4 border border-purple-200 rounded-lg p-3 bg-purple-50">
                                      <div class="flex items-center justify-between mb-2">
                                        <div class="text-sm font-semibold text-purple-800">üé´ ÁóÖ‰∫∫Â•óÁ•®</div>
                                        <button type="button" onclick="refreshPatientPackagesUI()"
                                                class="text-xs px-2 py-1 bg-purple-600 text-white rounded">Âà∑Êñ∞</button>
                                      </div>
                                      <div id="patientPackagesList" class="space-y-2 text-sm text-gray-700">
                                        <!-- ÂãïÊÖãËºâÂÖ• -->
                                        <div class="text-gray-500">Â∞öÊú™ËºâÂÖ•ÊàñÁÑ°Â•óÁ•®</div>
                                      </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        ÁôÇÁ®ã
                                    </label>
                                    <input type="text" id="formTreatmentCourse" placeholder="‰æãÔºö7Â§©„ÄÅ2ÈÄ±„ÄÅ1ÂÄãÊúàÁ≠â..." class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        ÈÜ´ÂõëÂèäÊ≥®ÊÑè‰∫ãÈ†Ö
                                    </label>
                                    <textarea id="formInstructions" placeholder="È£≤È£üÂÆúÂøå„ÄÅÁîüÊ¥ªË™øË≠∑„ÄÅÊ≥®ÊÑè‰∫ãÈ†ÖÁ≠â..." rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Ë§áË®∫ÊôÇÈñìÂèäÂÖ∂‰ªñÊôÇÈñìË®≠ÂÆö -->
                        <div class="mt-6 pt-4 border-t border-gray-200">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        Ë§áË®∫ÊôÇÈñì
                                    </label>
                                    <input type="datetime-local" id="formFollowUpDate" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">Âª∫Ë≠∞ÁóÖ‰∫∫‰∏ãÊ¨°ÂõûË®∫ÁöÑÊôÇÈñì</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        Âà∞Ë®∫ÊôÇÈñì
                                    </label>
                                    <input type="datetime-local" id="formVisitTime" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">ÂØ¶ÈöõÂà∞Ë®∫ÁöÑÊôÇÈñìÔºàÁî®ÊñºË≠âÊòéÊõ∏Ôºâ</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        Âª∫Ë≠∞‰ºëÊÅØÊúüÈñì
                                    </label>
                                    <div class="space-y-2">
                                        <div class="flex items-center space-x-2">
                                            <label class="text-xs text-gray-600 w-12">ÈñãÂßãÔºö</label>
                                            <input type="date" id="formRestStartDate" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" onchange="updateRestPeriod()">
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <label class="text-xs text-gray-600 w-12">ÁµêÊùüÔºö</label>
                                            <input type="date" id="formRestEndDate" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" onchange="updateRestPeriod()">
                                        </div>
                                        <div class="text-center">
                                            <span id="restPeriodDisplay" class="text-sm text-gray-500 font-medium">Ë´ãÈÅ∏ÊìáÈñãÂßãÂíåÁµêÊùüÊó•Êúü</span>
                                        </div>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">Áî®ÊñºÁóÖÂÅáË≠âÊòéÊõ∏ÁöÑÂª∫Ë≠∞‰ºëÊÅØÊúüÈñì</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Êìç‰ΩúÊåâÈàï -->
                        <div class="flex justify-end space-x-3 mt-6 pt-4 border-t border-gray-200">
                            <button onclick="cancelConsultation()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                                ÂèñÊ∂àË®∫Áóá
                            </button>
                            <button onclick="saveConsultation()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200">
                                <span id="consultationSaveButtonText">ÂÆåÊàêË®∫Áóá</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‰∏≠Ëó•Â∫´ÁÆ°ÁêÜ -->
            <div id="herbLibrary" class="hidden bg-white rounded-xl shadow-lg p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">‰∏≠Ëó•Â∫´ÁÆ°ÁêÜ</h2>
                    <div class="flex flex-col md:flex-row gap-3">
                        <div class="relative">
                            <input type="text" id="searchHerb" placeholder="ÊêúÂ∞ã‰∏≠Ëó•ÊùêÊàñÊñπÂäëÂêçÁ®±..." class="border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:ring-2 focus:ring-green-500 focus:border-transparent w-full md:w-64">
                            <span class="absolute right-3 top-2.5 text-gray-400">üîç</span>
                        </div>
                        <button onclick="showAddHerbForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200 whitespace-nowrap">
                            + Êñ∞Â¢û‰∏≠Ëó•Êùê
                        </button>
                        <button onclick="showAddFormulaForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200 whitespace-nowrap">
                            + Êñ∞Â¢ûÊñπÂäë
                        </button>
                    </div>
                </div>

                <!-- ÂàÜÈ°ûÊ®ôÁ±§ -->
                <div class="mb-6">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterHerbLibrary('all')" id="filter-all" class="px-4 py-2 rounded-lg text-sm font-medium bg-blue-100 text-blue-800 transition duration-200">
                            ÂÖ®ÈÉ®
                        </button>
                        <button onclick="filterHerbLibrary('herb')" id="filter-herb" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            ‰∏≠Ëó•Êùê
                        </button>
                        <button onclick="filterHerbLibrary('formula')" id="filter-formula" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            ÊñπÂäë
                        </button>
                    </div>
                </div>

                <!-- Êñ∞Â¢û/Á∑®ËºØ‰∏≠Ëó•ÊùêË°®ÂñÆÂΩàÁ™ó -->
                <div id="addHerbModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                            <h3 id="herbFormTitle" class="text-xl font-bold text-gray-800">Êñ∞Â¢û‰∏≠Ëó•Êùê</h3>
                            <button onclick="hideAddHerbForm()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">‰∏≠Ëó•ÊùêÂêçÁ®± *</label>
                                    <input type="text" id="herbName" placeholder="Ë´ãËº∏ÂÖ•‰∏≠Ëó•ÊùêÂêçÁ®±" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Âà•Âêç</label>
                                    <input type="text" id="herbAlias" placeholder="ÂÖ∂‰ªñÂêçÁ®±ÊàñÂà•Âêç" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ÊÄßÂë≥</label>
                                    <input type="text" id="herbNature" placeholder="‰æãÔºöÁîò„ÄÅÂæÆËã¶ÔºåÊ∫´" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Ê≠∏Á∂ì</label>
                                    <input type="text" id="herbMeridian" placeholder="‰æãÔºöËÇ∫„ÄÅËÑæ„ÄÅËÖéÁ∂ì" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ÂäüÊïà</label>
                                    <textarea id="herbEffects" placeholder="Ë´ãÊèèËø∞‰∏ªË¶ÅÂäüÊïà" rows="2" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">‰∏ªÊ≤ª</label>
                                    <textarea id="herbIndications" placeholder="Ë´ãÊèèËø∞‰∏ªË¶ÅÊ≤ªÁôÇÁØÑÂúç" rows="2" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Â∏∏Áî®ÂäëÈáè</label>
                                    <input type="text" id="herbDosage" placeholder="‰æãÔºö3-9g" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">‰ΩøÁî®Ê≥®ÊÑè</label>
                                    <input type="text" id="herbCautions" placeholder="Á¶ÅÂøåÊàñÊ≥®ÊÑè‰∫ãÈ†Ö" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-gray-200">
                                <button onclick="hideAddHerbForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                                    ÂèñÊ∂à
                                </button>
                                <button onclick="saveHerb()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200">
                                    <span id="herbSaveButtonText">ÂÑ≤Â≠ò</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Êñ∞Â¢û/Á∑®ËºØÊñπÂäëË°®ÂñÆÂΩàÁ™ó -->
                <div id="addFormulaModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                            <h3 id="formulaFormTitle" class="text-xl font-bold text-gray-800">Êñ∞Â¢ûÊñπÂäë</h3>
                            <button onclick="hideAddFormulaForm()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">ÊñπÂäëÂêçÁ®± *</label>
                                        <input type="text" id="formulaName" placeholder="Ë´ãËº∏ÂÖ•ÊñπÂäëÂêçÁ®±" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Âá∫Ëôï</label>
                                        <input type="text" id="formulaSource" placeholder="‰æãÔºöÂÇ∑ÂØíË´ñ„ÄÅÈáëÂå±Ë¶ÅÁï•" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">ÂäüÊïà</label>
                                        <textarea id="formulaEffects" placeholder="Ë´ãÊèèËø∞ÊñπÂäë‰∏ªË¶ÅÂäüÊïà" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">‰∏ªÊ≤ª</label>
                                        <textarea id="formulaIndications" placeholder="Ë´ãÊèèËø∞‰∏ªË¶ÅÊ≤ªÁôÇÁóÖÁóá" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                    </div>
                                </div>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">ÁµÑÊàê *</label>
                                        <textarea id="formulaComposition" placeholder="Ë´ãËº∏ÂÖ•ÊñπÂäëÁµÑÊàêÔºå‰æãÂ¶ÇÔºö&#10;‰∫∫ÂèÉ&#10;ÁôΩÊúÆ&#10;ËåØËãì&#10;ÁîòËçâ" rows="8" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Áî®Ê≥ï</label>
                                        <textarea id="formulaUsage" placeholder="ÁÖéÁÖÆÊñπÊ≥ï„ÄÅÊúçÁî®ÊñπÂºèÁ≠â" rows="2" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Ê≥®ÊÑè‰∫ãÈ†Ö</label>
                                        <textarea id="formulaCautions" placeholder="Á¶ÅÂøå„ÄÅÊ≥®ÊÑè‰∫ãÈ†ÖÁ≠â" rows="2" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-gray-200">
                                <button onclick="hideAddFormulaForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                                    ÂèñÊ∂à
                                </button>
                                <button onclick="saveFormula()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition duration-200">
                                    <span id="formulaSaveButtonText">ÂÑ≤Â≠ò</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ‰∏≠Ëó•Â∫´ÂàóË°® -->
                <div class="overflow-x-auto">
                    <div id="herbLibraryList" class="space-y-4">
                        <!-- ‰∏≠Ëó•Â∫´ÂÖßÂÆπÊúÉÂãïÊÖãËºâÂÖ• -->
                    </div>
                </div>
            </div>

            <!-- Êî∂Ë≤ªÈ†ÖÁõÆÁÆ°ÁêÜ -->
            <div id="billingManagement" class="hidden bg-white rounded-xl shadow-lg p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">Êî∂Ë≤ªÈ†ÖÁõÆÁÆ°ÁêÜ</h2>
                    <div class="flex flex-col md:flex-row gap-3">
                        <div class="relative">
                            <input type="text" id="searchBilling" placeholder="ÊêúÂ∞ãÊî∂Ë≤ªÈ†ÖÁõÆÂêçÁ®±..." class="border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:ring-2 focus:ring-green-500 focus:border-transparent w-full md:w-64">
                            <span class="absolute right-3 top-2.5 text-gray-400">üîç</span>
                        </div>
                        <button onclick="showAddBillingItemForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200 whitespace-nowrap">
                            + Êñ∞Â¢ûÊî∂Ë≤ªÈ†ÖÁõÆ
                        </button>
                    </div>
                </div>

                <!-- ÂàÜÈ°ûÊ®ôÁ±§ -->
                <div class="mb-6">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterBillingItems('all')" id="billing-filter-all" class="px-4 py-2 rounded-lg text-sm font-medium bg-blue-100 text-blue-800 transition duration-200">
                            ÂÖ®ÈÉ®
                        </button>
                        <button onclick="filterBillingItems('consultation')" id="billing-filter-consultation" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            Ë®∫ÁôÇË≤ª
                        </button>
                        <button onclick="filterBillingItems('medicine')" id="billing-filter-medicine" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            Ëó•Ë≤ª
                        </button>
                        <button onclick="filterBillingItems('treatment')" id="billing-filter-treatment" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            Ê≤ªÁôÇË≤ª
                        </button>
                        <button onclick="filterBillingItems('other')" id="billing-filter-other" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            ÂÖ∂‰ªñ
                        </button>
                        <button onclick="filterBillingItems('discount')" id="billing-filter-discount" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            ÊäòÊâ£È†ÖÁõÆ
                        </button>
                        <button onclick="filterBillingItems('package')" id="billing-filter-package" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            Â•óÁ•®È†ÖÁõÆ
                        </button>
                    </div>
                </div>

                <!-- Êñ∞Â¢û/Á∑®ËºØÊî∂Ë≤ªÈ†ÖÁõÆË°®ÂñÆÂΩàÁ™ó -->
                <div id="addBillingItemModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                            <h3 id="billingItemFormTitle" class="text-xl font-bold text-gray-800">Êñ∞Â¢ûÊî∂Ë≤ªÈ†ÖÁõÆ</h3>
                            <button onclick="hideAddBillingItemForm()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">È†ÖÁõÆÂêçÁ®± *</label>
                                    <input type="text" id="billingItemName" placeholder="Ë´ãËº∏ÂÖ•Êî∂Ë≤ªÈ†ÖÁõÆÂêçÁ®±" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">È†ÖÁõÆÈ°ûÂà• *</label>
                                    <select id="billingItemCategory" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                        <option value="">Ë´ãÈÅ∏ÊìáÈ°ûÂà•</option>
                                        <option value="consultation">Ë®∫ÁôÇË≤ª</option>
                                        <option value="medicine">Ëó•Ë≤ª</option>
                                        <option value="treatment">Ê≤ªÁôÇË≤ª</option>
                                        <option value="other">ÂÖ∂‰ªñ</option>
                                        <option value="discount">ÊäòÊâ£È†ÖÁõÆ</option>
                                        <option value="package">Â•óÁ•®È†ÖÁõÆ</option>
                                    </select>
                                </div>
                                <!-- Â•óÁ•®Â∞àÁî®Ê¨Ñ‰ΩçÔºöÁï∂È°ûÂà•ÈÅ∏Êìá package ÊôÇÈ°ØÁ§∫ -->
                                <div id="packageFields" class="md:col-span-2 hidden">
                                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                      <label class="block text-sm font-medium text-gray-700 mb-1">Â•óÁ•®ÂèØÁî®Ê¨°Êï∏ *</label>
                                      <input type="number" id="billingItemPackageUses" placeholder="‰æãÂ¶ÇÔºö10" min="1"
                                             class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    </div>
                                    <div>
                                      <label class="block text-sm font-medium text-gray-700 mb-1">ÊúâÊïàÂ§©Êï∏ *</label>
                                      <input type="number" id="billingItemValidityDays" placeholder="‰æãÂ¶ÇÔºö180ÔºàÂçäÂπ¥Ôºâ" min="1"
                                             class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                      <p class="text-xs text-gray-500 mt-1">Ëá™Ë≥ºË≤∑Êó•Ëµ∑ÁÆó</p>
                                    </div>
                                  </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Êî∂Ë≤ªÈáëÈ°ç *</label>
                                    <input type="number" id="billingItemPrice" placeholder="0" step="1" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">ÊäòÊâ£È†ÖÁõÆÔºöËº∏ÂÖ•0.9Ë°®Á§∫9ÊäòÔºåËº∏ÂÖ•9ÊúÉËá™ÂãïËΩâÁÇ∫9ÊäòÔºåÊàñËº∏ÂÖ•Ë≤†Êï∏Ë°®Á§∫Âõ∫ÂÆöÈáëÈ°çÊäòÊâ£</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Ë®àË≤ªÂñÆ‰Ωç</label>
                                    <input type="text" id="billingItemUnit" placeholder="‰æãÔºöÊ¨°„ÄÅÂäë„ÄÅÂåÖ" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">È†ÖÁõÆË™™Êòé</label>
                                    <textarea id="billingItemDescription" placeholder="Ë´ãÊèèËø∞Êî∂Ë≤ªÈ†ÖÁõÆÁöÑË©≥Á¥∞ÂÖßÂÆπ" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="billingItemActive" checked class="mr-2 rounded">
                                        <span class="text-sm font-medium text-gray-700">ÂïüÁî®Ê≠§Êî∂Ë≤ªÈ†ÖÁõÆ</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-gray-200">
                                <button onclick="hideAddBillingItemForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                                    ÂèñÊ∂à
                                </button>
                                <button onclick="saveBillingItem()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200">
                                    <span id="billingItemSaveButtonText">ÂÑ≤Â≠ò</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Êî∂Ë≤ªÈ†ÖÁõÆÂàóË°® -->
                <div class="overflow-x-auto">
                    <div id="billingItemsList" class="space-y-4">
                        <!-- Êî∂Ë≤ªÈ†ÖÁõÆÂÖßÂÆπÊúÉÂãïÊÖãËºâÂÖ• -->
                    </div>
                </div>
            </div>

            <!-- Ë®∫ÊâÄÁî®Êà∂ÁÆ°ÁêÜ -->
            <div id="userManagement" class="hidden bg-white rounded-xl shadow-lg p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">Ë®∫ÊâÄÁî®Êà∂ÁÆ°ÁêÜ</h2>
                    <div class="flex flex-col md:flex-row gap-3">
                        <div class="relative">
                            <input type="text" id="searchUser" placeholder="ÊêúÂ∞ãÁî®Êà∂ÂêçÁ®±ÊàñÈõªÂ≠êÈÉµ‰ª∂..." class="border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:ring-2 focus:ring-green-500 focus:border-transparent w-full md:w-64">
                            <span class="absolute right-3 top-2.5 text-gray-400">üîç</span>
                        </div>
                        <button onclick="showAddUserForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200 whitespace-nowrap">
                            + Êñ∞Â¢ûÁî®Êà∂
                        </button>
                    </div>
                </div>

                <!-- ÁãÄÊÖãÁØ©ÈÅ∏Ê®ôÁ±§ -->
                <div class="mb-6">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterUsers('all')" id="user-filter-all" class="px-4 py-2 rounded-lg text-sm font-medium bg-blue-100 text-blue-800 transition duration-200">
                            ÂÖ®ÈÉ®Áî®Êà∂
                        </button>
                        <button onclick="filterUsers('inactive')" id="user-filter-inactive" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            Â∑≤ÂÅúÁî®
                        </button>
                    </div>
                </div>

                <!-- Êñ∞Â¢û/Á∑®ËºØÁî®Êà∂Ë°®ÂñÆÂΩàÁ™ó -->
                <div id="addUserModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                            <h3 id="userFormTitle" class="text-xl font-bold text-gray-800">Êñ∞Â¢ûÁî®Êà∂</h3>
                            <button onclick="hideAddUserForm()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Â∏≥ËôüËàáÂØÜÁ¢ºÊ¨Ñ‰ΩçÂ∑≤ÁßªÈô§ÔºåÁ≥ªÁµ±Â∞áËá™Âãï‰ΩøÁî® Firebase UID ÊàñÈõªÂ≠êÈÉµ‰ª∂Áî¢ÁîüË≠òÂà•ÂêçÁ®± -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ÂßìÂêç *</label>
                                    <input type="text" id="userDisplayName" placeholder="Ë´ãËº∏ÂÖ•ÁúüÂØ¶ÂßìÂêç" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ËÅ∑‰Ωç *</label>
                                    <select id="userPosition" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent" onchange="toggleRegistrationNumberField()">
                                        <option value="">Ë´ãÈÅ∏ÊìáËÅ∑‰Ωç</option>
                                        <option value="Ë®∫ÊâÄÁÆ°ÁêÜ">Ë®∫ÊâÄÁÆ°ÁêÜ</option>
                                        <option value="ÈÜ´Â∏´">ÈÜ´Â∏´</option>
                                        <option value="Ë≠∑ÁêÜÂ∏´">Ë≠∑ÁêÜÂ∏´</option>
                                    </select>
                                </div>
                                <div id="registrationNumberField" class="hidden">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">‰∏≠ÈÜ´Ë®ªÂÜäÁ∑®Ëôü *</label>
                                    <input type="text" id="userRegistrationNumber" placeholder="Ë´ãËº∏ÂÖ•‰∏≠ÈÜ´Ë®ªÂÜäÁ∑®Ëôü" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">ÈÜ´Â∏´ËÅ∑‰ΩçÂøÖÈ†àÂ°´ÂØ´Ë®ªÂÜäÁ∑®Ëôü</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ÈõªÂ≠êÈÉµ‰ª∂</label>
                                    <input type="email" id="userEmail" placeholder="Ë´ãËº∏ÂÖ•ÈõªÂ≠êÈÉµ‰ª∂" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ÈõªË©±ËôüÁ¢º</label>
                                    <input type="tel" id="userPhone" placeholder="Ë´ãËº∏ÂÖ•ÈõªË©±ËôüÁ¢º" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <!-- Firebase UID Ê¨Ñ‰Ωç -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Firebase UID</label>
                                    <input type="text" id="userUID" placeholder="Ë´ãËº∏ÂÖ• Firebase UIDÔºàÂèØ‰∏çÂ°´Ôºâ" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">Â∞çÊáâ Firebase Authentication Â∏≥ËôüÁöÑ UID</p>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="userActive" checked class="mr-2 rounded">
                                        <span class="text-sm font-medium text-gray-700">ÂïüÁî®Ê≠§Áî®Êà∂Â∏≥Ëôü</span>
                                    </label>
                                    <p class="text-xs text-gray-500 mt-1">ÂÅúÁî®ÁöÑÂ∏≥ËôüÂ∞áÁÑ°Ê≥ïÁôªÂÖ•Á≥ªÁµ±</p>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-gray-200">
                                <button onclick="hideAddUserForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                                    ÂèñÊ∂à
                                </button>
                                <button onclick="saveUser()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200">
                                    <span id="userSaveButtonText">ÂÑ≤Â≠ò</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Áî®Êà∂ÂàóË°® -->
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ÂßìÂêç</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ËÅ∑‰Ωç</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Ë®ªÂÜäÁ∑®Ëôü</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ÈõªÂ≠êÈÉµ‰ª∂</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ÁãÄÊÖã</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ÊúÄÂæåÁôªÂÖ•</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody id="userList" class="divide-y divide-gray-200">
                            <!-- Áî®Êà∂Ë≥áÊñôÊúÉÂãïÊÖãËºâÂÖ• -->
                        </tbody>
                    </table>
                </div>
            </div>

<!-- Ë≤°ÂãôÂ†±Ë°® -->
            <div id="financialReports" class="hidden bg-white rounded-xl shadow-lg p-6">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2 flex items-center">
                        <span class="mr-3">üìä</span>Ë≤°ÂãôÂ†±Ë°®
                    </h2>
                    <p class="text-gray-600">Ë®∫ÊâÄÊî∂ÂÖ•ÂàÜÊûêËàáË≤°ÂãôÁµ±Ë®à</p>
                </div>

                <!-- ÁØ©ÈÅ∏ÊéßÂà∂ÂçÄ -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Â†±Ë°®È°ûÂûã</label>
                            <select id="reportType" onchange="generateFinancialReport()" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="daily">Êó•Â†±Ë°®</option>
                                <option value="weekly">ÈÄ±Â†±Ë°®</option>
                                <option value="monthly" selected>ÊúàÂ†±Ë°®</option>
                                <option value="yearly">Âπ¥Â†±Ë°®</option>
                                <option value="custom">Ëá™Ë®ÇÊúüÈñì</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Âø´ÈÄüÈÅ∏Êìá</label>
                            <select id="quickDate" onchange="setQuickDate()" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="">Ë´ãÈÅ∏Êìá...</option>
                                <option value="today">‰ªäÂ§©</option>
                                <option value="yesterday">Êò®Â§©</option>
                                <option value="thisWeek">Êú¨ÈÄ±</option>
                                <option value="lastWeek">‰∏äÈÄ±</option>
                                <option value="thisMonth">Êú¨Êúà</option>
                                <option value="lastMonth">‰∏äÊúà</option>
                                <option value="thisYear">‰ªäÂπ¥</option>
                                <option value="lastYear">ÂéªÂπ¥</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÈñãÂßãÊó•Êúü</label>
                            <input type="date" id="startDate" onchange="generateFinancialReport()" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÁµêÊùüÊó•Êúü</label>
                            <input type="date" id="endDate" onchange="generateFinancialReport()" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÈÜ´Â∏´ÁØ©ÈÅ∏</label>
                            <select id="doctorFilter" onchange="generateFinancialReport()" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="">ÂÖ®ÈÉ®ÈÜ´Â∏´</option>
                            </select>
                        </div>
                        
                        <div class="flex items-end space-x-2">
                            <button onclick="generateFinancialReport()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200 flex items-center">
                                <span class="mr-2">üîÑ</span>Êõ¥Êñ∞Â†±Ë°®
                            </button>
                            <button onclick="exportFinancialReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition duration-200 flex items-center">
                                <span class="mr-2">üì•</span>ÂåØÂá∫
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ÈóúÈçµÊåáÊ®ôÂç°Áâá -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gradient-to-r from-green-400 to-green-600 text-white rounded-xl p-6 shadow-lg transform hover:scale-105 transition duration-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100 text-sm font-medium">Á∏ΩÊî∂ÂÖ•</p>
                                <h3 id="totalRevenue" class="text-3xl font-bold">$0</h3>
                                <p id="revenueChange" class="text-green-100 text-sm mt-1">Áµ±Ë®àÊúüÈñìÊî∂ÂÖ•</p>
                            </div>
                            <div class="bg-white bg-opacity-20 rounded-full p-3">
                                <span class="text-2xl">üí∞</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-blue-400 to-blue-600 text-white rounded-xl p-6 shadow-lg transform hover:scale-105 transition duration-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100 text-sm font-medium">Ë®∫Áóá‰∫∫Ê¨°</p>
                                <h3 id="totalConsultations" class="text-3xl font-bold">0</h3>
                                <p id="consultationChange" class="text-blue-100 text-sm mt-1">ÂÆåÊàêË®∫ÁóáÊ¨°Êï∏</p>
                            </div>
                            <div class="bg-white bg-opacity-20 rounded-full p-3">
                                <span class="text-2xl">üë•</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-purple-400 to-purple-600 text-white rounded-xl p-6 shadow-lg transform hover:scale-105 transition duration-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100 text-sm font-medium">Âπ≥ÂùáÊ∂àË≤ª</p>
                                <h3 id="averageRevenue" class="text-3xl font-bold">$0</h3>
                                <p id="averageChange" class="text-purple-100 text-sm mt-1">ÊØèÊ¨°Ë®∫ÁóáÂπ≥Âùá</p>
                            </div>
                            <div class="bg-white bg-opacity-20 rounded-full p-3">
                                <span class="text-2xl">üìä</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-orange-400 to-orange-600 text-white rounded-xl p-6 shadow-lg transform hover:scale-105 transition duration-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-orange-100 text-sm font-medium">Ê¥ªË∫çÈÜ´Â∏´</p>
                                <h3 id="activeDoctors" class="text-3xl font-bold">0</h3>
                                <p id="doctorChange" class="text-orange-100 text-sm mt-1">ÊúâË®∫ÁóáÁöÑÈÜ´Â∏´</p>
                            </div>
                            <div class="bg-white bg-opacity-20 rounded-full p-3">
                                <span class="text-2xl">üë®‚Äç‚öïÔ∏è</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ë©≥Á¥∞Â†±Ë°® -->
                <div class="bg-white border border-gray-200 rounded-lg">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 rounded-t-lg">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                                <span class="mr-2">üìã</span>Ë©≥Á¥∞Ë≤°ÂãôÂ†±Ë°®
                            </h3>
                            <div class="text-sm text-gray-600">
                                Ë≥áÊñôÊõ¥Êñ∞ÊôÇÈñìÔºö<span id="lastUpdateTime">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ê®ôÁ±§È†Å -->
                    <div class="border-b border-gray-200">
                        <nav class="flex space-x-8 px-6" role="tablist">
                            <button onclick="switchFinancialTab('summary')" id="financialSummaryTab" class="py-4 px-1 border-b-2 border-green-500 text-green-600 font-medium text-sm transition duration-200">
                                Êî∂ÂÖ•ÊëòË¶Å
                            </button>
                            <button onclick="switchFinancialTab('daily')" id="financialDailyTab" class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm transition duration-200">
                                ÊØèÊó•ÊòéÁ¥∞
                            </button>
                            <button onclick="switchFinancialTab('doctor')" id="financialDoctorTab" class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm transition duration-200">
                                ÈÜ´Â∏´Ê•≠Á∏æ
                            </button>
                            <button onclick="switchFinancialTab('service')" id="financialServiceTab" class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm transition duration-200">
                                ÊúçÂãôÂàÜÊûê
                            </button>
                        </nav>
                    </div>
                    
                    <!-- Ê®ôÁ±§ÂÖßÂÆπ -->
                    <div class="p-6">
                        <!-- Êî∂ÂÖ•ÊëòË¶ÅÊ®ôÁ±§ -->
                        <div id="financialSummaryContent" class="financial-tab-content">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">È†ÖÁõÆ</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">ÈáëÈ°ç</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">‰ΩîÊØî</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">ÂÇôË®ª</th>
                                        </tr>
                                    </thead>
                                    <tbody id="financialSummaryTableBody" class="divide-y divide-gray-200">
                                        <tr>
                                            <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                                                Ë´ãÈªûÊìä„ÄåÊõ¥Êñ∞Â†±Ë°®„Äç‰æÜËºâÂÖ•Ë≥áÊñô
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- ÊØèÊó•ÊòéÁ¥∞Ê®ôÁ±§ -->
                        <div id="financialDailyContent" class="financial-tab-content hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Êó•Êúü</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Ë®∫Áóá‰∫∫Ê¨°</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Êî∂ÂÖ•ÈáëÈ°ç</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Âπ≥ÂùáÊ∂àË≤ª</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‰∏ªË¶ÅÊúçÂãô</th>
                                        </tr>
                                    </thead>
                                    <tbody id="financialDailyTableBody" class="divide-y divide-gray-200">
                                        <tr>
                                            <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                                                Ë´ãÈªûÊìä„ÄåÊõ¥Êñ∞Â†±Ë°®„Äç‰æÜËºâÂÖ•Ë≥áÊñô
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- ÈÜ´Â∏´Ê•≠Á∏æÊ®ôÁ±§ -->
                        <div id="financialDoctorContent" class="financial-tab-content hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ÈÜ´Â∏´</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Ë®∫Áóá‰∫∫Ê¨°</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Á∏ΩÊî∂ÂÖ•</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Âπ≥ÂùáÊ∂àË≤ª</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">‰ΩîÊØî</th>
                                        </tr>
                                    </thead>
                                    <tbody id="financialDoctorTableBody" class="divide-y divide-gray-200">
                                        <tr>
                                            <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                                                Ë´ãÈªûÊìä„ÄåÊõ¥Êñ∞Â†±Ë°®„Äç‰æÜËºâÂÖ•Ë≥áÊñô
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- ÊúçÂãôÂàÜÊûêÊ®ôÁ±§ -->
                        <div id="financialServiceContent" class="financial-tab-content hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ÊúçÂãôÈ°ûÂûã</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Ê¨°Êï∏</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Á∏ΩÈáëÈ°ç</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Âπ≥ÂùáÂñÆÂÉπ</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Êî∂ÂÖ•‰ΩîÊØî</th>
                                        </tr>
                                    </thead>
                                    <tbody id="financialServiceTableBody" class="divide-y divide-gray-200">
                                        <tr>
                                            <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                                                Ë´ãÈªûÊìä„ÄåÊõ¥Êñ∞Â†±Ë°®„Äç‰æÜËºâÂÖ•Ë≥áÊñô
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Á≥ªÁµ±ÁÆ°ÁêÜ -->
            <div id="systemManagement" class="hidden bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Á≥ªÁµ±ÁÆ°ÁêÜ</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">Ë®∫ÊâÄÁµ±Ë®à</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span>Á∏ΩÁóÖ‰∫∫Êï∏Ôºö</span>
                                <span id="totalPatients" class="font-semibold">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>‰ªäÊó•Ë®∫ÁóáÔºö</span>
                                <span id="todayConsultations" class="font-semibold">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Êú¨ÊúàË®∫ÁóáÔºö</span>
                                <span id="monthlyConsultations" class="font-semibold">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">Ë®∫ÊâÄË®≠ÂÆö</h3>
                        <div class="space-y-3">
                            <div class="text-center py-4" id="clinicSettingsDisplay">
                                <div class="text-sm text-gray-700 mb-3">
                                    <div class="font-medium">Ë®∫ÊâÄ‰∏≠ÊñáÂêçÁ®±Ôºö<span id="displayChineseName">‰∏≠ÈÜ´Ë®∫ÊâÄÁ≥ªÁµ±</span></div>
                                    <div class="text-gray-600 mt-1">Ë®∫ÊâÄËã±ÊñáÂêçÁ®±Ôºö<span id="displayEnglishName">TCM Clinic</span></div>
                                </div>
                                <button onclick="showClinicSettingsModal()" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                    Ë®∫ÊâÄË≥áÊñô‰øÆÊîπ
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">Ë≥áÊñôÁÆ°ÁêÜ</h3>
                        <div class="space-y-3">
                            <button onclick="exportData()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                ÂåØÂá∫Ë≥áÊñô
                            </button>
                            <button onclick="backupData()" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                ÂÇô‰ªΩË≥áÊñô
                            </button>
                            <button onclick="clearData()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                Ê∏ÖÈô§Ë≥áÊñô
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ë®∫ÊâÄË≥áÊñô‰øÆÊîπÂΩàÁ™ó -->
    <div id="clinicSettingsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                <h3 class="text-xl font-bold text-gray-800">Ë®∫ÊâÄË≥áÊñô‰øÆÊîπ</h3>
                <button onclick="hideClinicSettingsModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
            </div>
            
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ë®∫ÊâÄ‰∏≠ÊñáÂêçÁ®± *</label>
                        <input type="text" id="clinicChineseName" placeholder="Ë´ãËº∏ÂÖ•Ë®∫ÊâÄ‰∏≠ÊñáÂêçÁ®±" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ë®∫ÊâÄËã±ÊñáÂêçÁ®±</label>
                        <input type="text" id="clinicEnglishName" placeholder="Ë´ãËº∏ÂÖ•Ë®∫ÊâÄËã±ÊñáÂêçÁ®±" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ë®∫ÊâÄÁáüÊ•≠ÊôÇÈñì</label>
                        <input type="text" id="clinicBusinessHours" placeholder="‰æãÔºöÈÄ±‰∏ÄËá≥ÈÄ±‰∫î 09:00-18:00" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ë®∫ÊâÄÈõªË©±</label>
                        <input type="tel" id="clinicPhone" placeholder="Ë´ãËº∏ÂÖ•Ë®∫ÊâÄÈõªË©±ËôüÁ¢º" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ë®∫ÊâÄÂú∞ÂùÄ</label>
                        <textarea id="clinicAddress" placeholder="Ë´ãËº∏ÂÖ•Ë®∫ÊâÄÂÆåÊï¥Âú∞ÂùÄ" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-gray-200">
                    <button onclick="hideClinicSettingsModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                        ÂèñÊ∂à
                    </button>
                    <button onclick="saveClinicSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition duration-200">
                        ÂÑ≤Â≠ò
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // Á≥ªÁµ±Ë≥áÊñôÂÑ≤Â≠ò
        let currentUser = null;
        let currentUserData = null;
        
        // Ë®∫ÊâÄË®≠ÂÆö
        let clinicSettings = JSON.parse(localStorage.getItem('clinicSettings') || '{}');
        if (!clinicSettings.chineseName) {
            clinicSettings.chineseName = '‰∏≠ÈÜ´Ë®∫ÊâÄÁ≥ªÁµ±';
            clinicSettings.englishName = 'TCM Clinic';
            clinicSettings.businessHours = 'ÈÄ±‰∏ÄËá≥ÈÄ±‰∫î 09:00-18:00';
            clinicSettings.phone = '(852) 2345-6789';
            clinicSettings.address = 'È¶ôÊ∏Ø‰∏≠Áí∞ÁöáÂêéÂ§ßÈÅì‰∏≠123Ëôü';
            localStorage.setItem('clinicSettings', JSON.stringify(clinicSettings));
        }
        
        // ÊµÆÂãïÊèêÁ§∫ÂäüËÉΩ
        function showToast(message, type = 'info') {
            // ÁßªÈô§ÁèæÊúâÁöÑÊèêÁ§∫
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // ÂâµÂª∫Êñ∞ÁöÑÊèêÁ§∫
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            // Ë®≠ÁΩÆÂúñÊ®ô
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-content">${message}</div>
            `;
            
            // Ê∑ªÂä†Âà∞È†ÅÈù¢
            document.body.appendChild(toast);
            
            // È°ØÁ§∫ÂãïÁï´
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // 2ÁßíÂæåÊ∑°Âá∫‰∏¶ÁßªÈô§
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 2000);
        }
        
        // Ë®àÁÆóÂπ¥ÈΩ°ÂáΩÊï∏
        function calculateAge(birthDate) {
            const birth = new Date(birthDate);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            
            return age;
        }
        
        // Ê†ºÂºèÂåñÂπ¥ÈΩ°È°ØÁ§∫
        function formatAge(birthDate) {
            if (!birthDate) return 'Êú™Áü•';
            
            const birth = new Date(birthDate);
            const today = new Date();
            
            let years = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                years--;
            }
            
            if (years > 0) {
                return `${years}Ê≠≤`;
            } else {
                // Êú™Êªø‰∏ÄÊ≠≤ÁöÑÂ¨∞ÂπºÂÖíÈ°ØÁ§∫ÊúàÊï∏
                let months = today.getMonth() - birth.getMonth();
                let days = today.getDate() - birth.getDate();
                
                if (days < 0) {
                    months--;
                    const lastMonth = new Date(today.getFullYear(), today.getMonth(), 0);
                    days += lastMonth.getDate();
                }
                
                if (months < 0) {
                    months += 12;
                }
                
                if (months > 0) {
                    return `${months}ÂÄãÊúà`;
                } else {
                    return `${days}Â§©`;
                }
            }
        }
        
        // ÁîüÊàêÁóÖ‰∫∫Á∑®ËôüÂáΩÊï∏
        function generatePatientNumber() {
            const existingNumbers = patients
                .map(p => p.patientNumber)
                .filter(num => num && num.startsWith('P'))
                .map(num => parseInt(num.substring(1)))
                .filter(num => !isNaN(num));
            
            const maxNumber = existingNumbers.length > 0 ? Math.max(...existingNumbers) : 0;
            const newNumber = maxNumber + 1;
            return `P${newNumber.toString().padStart(6, '0')}`;
        }

        // È†êË®≠Ê∏¨Ë©¶ÁóÖ‰∫∫Ë≥áÊñô
        const defaultPatients = [
            {
                id: 1001,
                patientNumber: 'P000001',
                name: 'ÁéãÂ∞èÊòé',
                gender: 'Áî∑',
                phone: '0912-345-678',
                birthDate: '1989-03-15',
                address: 'Âè∞ÂåóÂ∏ÇÂ§ßÂÆâÂçÄ‰ø°Áæ©Ë∑ØÂõõÊÆµ123Ëôü',
                history: 'È´òË°ÄÂ£ìÁóÖÂè≤3Âπ¥ÔºåÂÅ∂ÊúâÈ†≠ÊöàÁóáÁãÄ',
                createdAt: new Date('2024-01-15').toISOString()
            },
            {
                id: 1002,
                patientNumber: 'P000002',
                name: 'ÊùéÁæéËèØ',
                gender: 'Â•≥',
                phone: '0923-456-789',
                birthDate: '1996-07-22',
                address: 'Êñ∞ÂåóÂ∏ÇÊùøÊ©ãÂçÄ‰∏≠Â±±Ë∑Ø‰∫åÊÆµ456Ëôü',
                history: 'Á∂ìÂ∏∏ÊÄßÂ§±Áú†ÔºåÂ∑•‰ΩúÂ£ìÂäõÂ§ß',
                createdAt: new Date('2024-01-20').toISOString()
            },
            {
                id: 1003,
                patientNumber: 'P000003',
                name: 'ÂºµÂøóÂº∑',
                gender: 'Áî∑',
                phone: '0934-567-890',
                birthDate: '1982-11-08',
                address: 'Ê°ÉÂúíÂ∏Ç‰∏≠Â£¢ÂçÄ‰∏≠Ê≠£Ë∑Ø789Ëôü',
                history: 'ÊÖ¢ÊÄßËÉÉÁÇéÔºåÈ£≤È£ü‰∏çË¶èÂæã',
                createdAt: new Date('2024-02-01').toISOString()
            },
            {
                id: 1004,
                patientNumber: 'P000004',
                name: 'Èô≥ÈõÖÂ©∑',
                gender: 'Â•≥',
                phone: '0945-678-901',
                birthDate: '1993-05-12',
                address: 'Âè∞‰∏≠Â∏ÇË•øÂ±ØÂçÄÂè∞ÁÅ£Â§ßÈÅì‰∏âÊÆµ321Ëôü',
                history: 'ÊúàÁ∂ì‰∏çË™øÔºåÁ∂ìÂ∏∏ËÖ∞ÈÖ∏ËÉåÁóõ',
                createdAt: new Date('2024-02-10').toISOString()
            },
            {
                id: 1005,
                patientNumber: 'P000005',
                name: 'ÊûóÂ§ßÂÅâ',
                gender: 'Áî∑',
                phone: '0956-789-012',
                birthDate: '1969-12-03',
                address: 'È´òÈõÑÂ∏ÇÂâçÈáëÂçÄ‰∏≠Ê≠£ÂõõË∑Ø654Ëôü',
                history: 'Á≥ñÂ∞øÁóÖÊÇ£ËÄÖÔºåÈúÄÂÆöÊúüËøΩËπ§Ë°ÄÁ≥ñ',
                createdAt: new Date('2024-02-15').toISOString()
            }
        ];

        // ÂàùÂßãÂåñÁóÖ‰∫∫Ë≥áÊñôÔºàÂ¶ÇÊûúÊú¨Âú∞ÂÑ≤Â≠òÁÇ∫Á©∫ÂâáËºâÂÖ•È†êË®≠Ë≥áÊñôÔºâ
        let patients = JSON.parse(localStorage.getItem('patients') || '[]');
        if (patients.length === 0) {
            patients = defaultPatients;
            localStorage.setItem('patients', JSON.stringify(patients));
        } else {
            // ÁÇ∫ËàäË≥áÊñôË£úÂÖÖÁóÖ‰∫∫Á∑®Ëôü
            let needsUpdate = false;
            patients.forEach(patient => {
                if (!patient.patientNumber) {
                    patient.patientNumber = generatePatientNumber();
                    needsUpdate = true;
                }
            });
            if (needsUpdate) {
                localStorage.setItem('patients', JSON.stringify(patients));
            }
        }
        
        // È†êË®≠Ë®∫ÁóáË®òÈåÑ
        const defaultConsultations = [
            {
                id: 2001,
                appointmentId: 3001,
                patientId: 1001,
                symptoms: 'È†≠ÁóõÈ†≠ÊöàÔºåË°ÄÂ£ìÂÅèÈ´òÔºå‰º¥ÊúâÂøÉÊÇ∏ÔºåÁù°Áú†ÂìÅË≥™‰∏ç‰Ω≥',
                tongue: 'ËàåË≥™Á¥ÖÔºåËãîËñÑÈªÉ',
                pulse: 'ËÑàÂº¶Êï∏',
                currentHistory: 'ÊÇ£ËÄÖ3Âπ¥ÂâçË®∫Êñ∑È´òË°ÄÂ£ìÔºåÂπ≥ÊôÇË°ÄÂ£ìÊéßÂà∂‰∏çÁ©©ÂÆöÔºåËøëÊúüÂ∑•‰ΩúÂ£ìÂäõÂ§ßÔºåÈ†≠ÁóõÁóáÁãÄÂä†Èáç',
                diagnosis: 'Áú©ÊöàÔºàÈ´òË°ÄÂ£ìÁóÖÔºâ',
                syndrome: 'ËÇùÈôΩ‰∏ä‰∫¢Ë≠â',
                prescription: 'Â§©È∫ªÈâ§Ëó§È£≤Âä†Ê∏õ\nÂ§©È∫ª 10g\nÈâ§Ëó§ 15g\nÁü≥Ê±∫Êòé 30g\nÊ¢îÂ≠ê 10g\nÈªÉËä© 10g\nÂ∑ùÁâõËÜù 15g\nÊùú‰ª≤ 15g\nÁõäÊØçËçâ 15g\nÂ§ú‰∫§Ëó§ 20g\nËåØÁ•û 15g',
                usage: 'Ê∞¥ÁÖéÊúçÔºåÊØèÊó•‰∏ÄÂäëÔºåÂàÜÊó©ÊôöÂÖ©Ê¨°Ê∫´Êúç',
                treatmentCourse: '7Â§©',
                instructions: 'Ê≥®ÊÑè‰ºëÊÅØÔºåÈÅøÂÖçÊÉÖÁ∑íÊøÄÂãïÔºåÂÆöÊúüÁõ£Ê∏¨Ë°ÄÂ£ìÔºåÈ£≤È£üÊ∏ÖÊ∑°Â∞ëÈπΩ',
                followUpDate: '2024-03-01T09:00',
                date: new Date('2024-02-23T10:30').toISOString(),
                doctor: 'drzhang',
                status: 'completed'
            },
            {
                id: 2002,
                appointmentId: 3002,
                patientId: 1002,
                symptoms: 'Â§±Áú†Â§öÂ§¢ÔºåÂÖ•Áù°Âõ∞Èõ£ÔºåÊòìÈÜíÔºå‰º¥ÊúâÂøÉÁÖ©ÔºåÂ∑•‰ΩúÂ£ìÂäõÂ§ß',
                tongue: 'ËàåË≥™Ê∑°Á¥ÖÔºåËãîËñÑÁôΩ',
                pulse: 'ËÑàÁ¥∞Êï∏',
                currentHistory: 'ÊÇ£ËÄÖËøëÂçäÂπ¥‰æÜÂ∑•‰ΩúÂ£ìÂäõÂ¢ûÂ§ßÔºåÁù°Áú†ÂìÅË≥™ÈÄêÊº∏‰∏ãÈôçÔºåÊØèÊôöÈúÄ1-2Â∞èÊôÇÊâçËÉΩÂÖ•Áù°',
                diagnosis: '‰∏çÂØêÔºàÂ§±Áú†ÁóáÔºâ',
                syndrome: 'ÂøÉËÖé‰∏ç‰∫§Ë≠â',
                prescription: 'ÁîòÈ∫•Â§ßÊ£óÊπØÂêà‰∫§Ê≥∞‰∏∏Âä†Ê∏õ\nÁîòËçâ 6g\nÂ∞èÈ∫• 30g\nÂ§ßÊ£ó 10Êûö\nÈªÉÈÄ£ 3g\nËÇâÊ°Ç 1g\nÈÖ∏Ê£ó‰ªÅ 20g\nÈæçÈ™® 15g\nÁâ°Ë†£ 15g\nÈÅ†Âøó 10g\nËåØÁ•û 15g',
                usage: 'Ê∞¥ÁÖéÊúçÔºåÊØèÊó•‰∏ÄÂäëÔºåÊôöÈ§êÂæåÂèäÁù°ÂâçÂêÑÊúç‰∏ÄÊ¨°',
                treatmentCourse: '10Â§©',
                instructions: 'Áù°ÂâçÈÅøÂÖç‰ΩøÁî®ÈõªÂ≠êÁî¢ÂìÅÔºå‰øùÊåÅË¶èÂæã‰ΩúÊÅØÔºåÂèØÈÅ©Áï∂ÈÄ≤Ë°åÊîæÈ¨ÜÈÅãÂãï',
                followUpDate: '2024-03-05T14:00',
                date: new Date('2024-02-25T14:15').toISOString(),
                doctor: 'drzhang',
                status: 'completed'
            },
            {
                id: 2003,
                appointmentId: 3003,
                patientId: 1003,
                symptoms: 'ËÉÉËÑòËÑπÁóõÔºåÈ£üÂæåÂä†ÈáçÔºåÂôØÊ∞£È†ªÁπÅÔºåÈ£üÊÖæ‰∏çÊåØ',
                tongue: 'ËàåË≥™Ê∑°ÔºåËãîÁôΩËÜ©',
                pulse: 'ËÑàÂº¶Êªë',
                currentHistory: 'ÊÇ£ËÄÖÊúâÊÖ¢ÊÄßËÉÉÁÇéÁóÖÂè≤ÔºåÂπ≥ÊôÇÈ£≤È£ü‰∏çË¶èÂæãÔºåÂ∏∏ÊúâËÉÉËÑò‰∏çÈÅ©ÔºåËøëÊúüÁóáÁãÄÂä†Èáç',
                diagnosis: 'ËÉÉÁóõÔºàÊÖ¢ÊÄßËÉÉÁÇéÔºâ',
                syndrome: 'ËÑæËÉÉËôõÂº±ÔºåÊøïÊªØ‰∏≠ÁÑ¶Ë≠â',
                prescription: 'È¶ôÁ†ÇÂÖ≠ÂêõÂ≠êÊπØÂä†Ê∏õ\nÈª®ÂèÉ 15g\nÁôΩÊúÆ 10g\nËåØËãì 15g\nÁîòËçâ 6g\nÈô≥ÁöÆ 10g\nÂçäÂ§è 10g\nÊú®È¶ô 6g\nÁ†Ç‰ªÅ 6g\nÊû≥ÊÆº 10g\nÁ•ûÈ∫¥ 15g',
                usage: 'Ê∞¥ÁÖéÊúçÔºåÊØèÊó•‰∏ÄÂäëÔºåÈ£ØÂâç30ÂàÜÈêòÊ∫´Êúç',
                treatmentCourse: '14Â§©',
                instructions: 'Ë¶èÂæãÈ£≤È£üÔºåÁ¥∞ÂöºÊÖ¢Âö•ÔºåÈÅøÂÖçÁîüÂÜ∑ËæõËæ£È£üÁâ©Ôºå‰øùÊåÅÂøÉÊÉÖÊÑâÂø´',
                followUpDate: '2024-03-10T10:30',
                date: new Date('2024-02-26T10:45').toISOString(),
                doctor: 'drzhang',
                status: 'completed'
            }
        ];

        let consultations = JSON.parse(localStorage.getItem('consultations') || '[]');
        if (consultations.length === 0) {
            consultations = defaultConsultations;
            localStorage.setItem('consultations', JSON.stringify(consultations));
        }
        
        // È†êË®≠ÊéõËôüË®òÈåÑ
        const defaultAppointments = [
            {
                id: 3001,
                patientId: 1001,
                appointmentTime: new Date('2024-02-23T10:00').toISOString(),
                appointmentDoctor: 'drzhang',
                chiefComplaint: 'È†≠ÁóõÈ†≠ÊöàÔºåË°ÄÂ£ìÂÅèÈ´ò',
                status: 'completed',
                createdAt: new Date('2024-02-22T15:30').toISOString(),
                createdBy: 'nurse_amy',
                arrivedAt: new Date('2024-02-23T09:55').toISOString(),
                confirmedBy: 'nurse_amy',
                consultationStartTime: new Date('2024-02-23T10:30').toISOString(),
                consultingDoctor: 'drzhang',
                completedAt: new Date('2024-02-23T11:15').toISOString(),
                consultationId: 2001,
                completedBy: 'drzhang'
            },
            {
                id: 3002,
                patientId: 1002,
                appointmentTime: new Date('2024-02-25T14:00').toISOString(),
                appointmentDoctor: 'drzhang',
                chiefComplaint: 'Â§±Áú†Â§öÂ§¢ÔºåÂÖ•Áù°Âõ∞Èõ£',
                status: 'completed',
                createdAt: new Date('2024-02-24T10:20').toISOString(),
                createdBy: 'nurse_amy',
                arrivedAt: new Date('2024-02-25T13:50').toISOString(),
                confirmedBy: 'nurse_amy',
                consultationStartTime: new Date('2024-02-25T14:15').toISOString(),
                consultingDoctor: 'drzhang',
                completedAt: new Date('2024-02-25T15:00').toISOString(),
                consultationId: 2002,
                completedBy: 'drzhang'
            },
            {
                id: 3003,
                patientId: 1003,
                appointmentTime: new Date('2024-02-26T10:30').toISOString(),
                appointmentDoctor: 'drzhang',
                chiefComplaint: 'ËÉÉËÑòËÑπÁóõÔºåÈ£üÂæåÂä†Èáç',
                status: 'completed',
                createdAt: new Date('2024-02-25T16:45').toISOString(),
                createdBy: 'nurse_amy',
                arrivedAt: new Date('2024-02-26T10:25').toISOString(),
                confirmedBy: 'nurse_amy',
                consultationStartTime: new Date('2024-02-26T10:45').toISOString(),
                consultingDoctor: 'drzhang',
                completedAt: new Date('2024-02-26T11:30').toISOString(),
                consultationId: 2003,
                completedBy: 'drzhang'
            }
        ];

        let appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
        if (appointments.length === 0) {
            appointments = defaultAppointments;
            localStorage.setItem('appointments', JSON.stringify(appointments));
        } else {
            // ÁÇ∫ËàäË≥áÊñôË£úÂÖÖÈÜ´Â∏´Ê¨Ñ‰Ωç
            let needsUpdate = false;
            appointments.forEach(appointment => {
                if (!appointment.appointmentDoctor) {
                    appointment.appointmentDoctor = 'drzhang'; // È†êË®≠ÁÇ∫ÂºµÈÜ´Â∏´
                    needsUpdate = true;
                }
            });
            if (needsUpdate) {
                localStorage.setItem('appointments', JSON.stringify(appointments));
            }
        }

        // È†êË®≠‰∏≠Ëó•ÊùêË≥áÊñô
        const defaultHerbs = [
            {
                id: 5001,
                type: 'herb',
                name: '‰∫∫ÂèÉ',
                alias: 'Á¥ÖÂèÉ„ÄÅÁôΩÂèÉ',
                nature: 'Áîò„ÄÅÂæÆËã¶ÔºåÂæÆÊ∫´',
                meridian: 'ËÑæ„ÄÅËÇ∫„ÄÅÂøÉÁ∂ì',
                effects: 'Â§ßË£úÂÖÉÊ∞£ÔºåÂæ©ËÑàÂõ∫ËÑ´ÔºåË£úËÑæÁõäËÇ∫ÔºåÁîüÊ¥•ÂÆâÁ•û',
                indications: 'È´îËôõÊ¨≤ËÑ´ÔºåËÇ¢ÂÜ∑ËÑàÂæÆÔºåËÑæËôõÈ£üÂ∞ëÔºåËÇ∫ËôõÂñòÂí≥ÔºåÊ¥•ÂÇ∑Âè£Ê∏¥ÔºåÂÖßÁÜ±Ê∂àÊ∏¥Ôºå‰πÖÁóÖËôõÁæ∏ÔºåÈ©öÊÇ∏Â§±Áú†ÔºåÈôΩÁóøÂÆÆÂÜ∑',
                dosage: '3-9g',
                cautions: '‰∏çÂÆúËàáËóúËòÜÂêåÁî®',
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 5002,
                type: 'herb',
                name: 'ÁôΩÊúÆ',
                alias: 'ÊñºÊúÆ„ÄÅÂÜ¨ÊúÆ',
                nature: 'Áîò„ÄÅËã¶ÔºåÊ∫´',
                meridian: 'ËÑæ„ÄÅËÉÉÁ∂ì',
                effects: 'ÂÅ•ËÑæÁõäÊ∞£ÔºåÁá•ÊøïÂà©Ê∞¥ÔºåÊ≠¢Ê±óÔºåÂÆâËÉé',
                indications: 'ËÑæËôõÈ£üÂ∞ëÔºåËÖπËÑπÊ≥ÑÁÄâÔºåÁó∞È£≤Áú©ÊÇ∏ÔºåÊ∞¥ËÖ´ÔºåËá™Ê±óÔºåËÉéÂãï‰∏çÂÆâ',
                dosage: '6-12g',
                cautions: 'Èô∞ËôõÁá•Ê∏¥ÔºåÊ∞£ÊªØËÑπÊÇ∂ËÄÖÂøåÊúç',
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 5003,
                type: 'herb',
                name: 'ËåØËãì',
                alias: 'ÁôΩËåØËãì„ÄÅÈõ≤Ëãì',
                nature: 'Áîò„ÄÅÊ∑°ÔºåÂπ≥',
                meridian: 'ÂøÉ„ÄÅËÇ∫„ÄÅËÑæ„ÄÅËÖéÁ∂ì',
                effects: 'Âà©Ê∞¥Êª≤ÊøïÔºåÂÅ•ËÑæÔºåÂØßÂøÉ',
                indications: 'Ê∞¥ËÖ´Â∞øÂ∞ëÔºåÁó∞È£≤Áú©ÊÇ∏ÔºåËÑæËôõÈ£üÂ∞ëÔºå‰æøÊ∫èÊ≥ÑÁÄâÔºåÂøÉÁ•û‰∏çÂÆâÔºåÈ©öÊÇ∏Â§±Áú†',
                dosage: '10-15g',
                cautions: 'ËôõÂØíÁ≤æÊªëÊàñÊ∞£Ëôõ‰∏ãÈô∑ËÄÖÂøåÊúç',
                createdAt: new Date('2024-01-01').toISOString()
            }
        ];

        // È†êË®≠ÊñπÂäëË≥áÊñô
        const defaultFormulas = [
            {
                id: 6001,
                type: 'formula',
                name: 'ÂõõÂêõÂ≠êÊπØ',
                source: 'Â§™Âπ≥ÊÉ†Ê∞ëÂíåÂäëÂ±ÄÊñπ',
                effects: 'ÁõäÊ∞£ÂÅ•ËÑæ',
                indications: 'ËÑæËÉÉÊ∞£ËôõÔºåÈù¢Ëâ≤ËêéÁôΩÔºåË™ûËÅ≤‰ΩéÂæÆÔºåÊ∞£Áü≠‰πèÂäõÔºåÈ£üÂ∞ë‰æøÊ∫èÔºåËàåÊ∑°ËãîÁôΩÔºåËÑàËôõÂº±',
                composition: '‰∫∫ÂèÉ\nÁôΩÊúÆ\nËåØËãì\nÁîòËçâ',
                usage: 'Ê∞¥ÁÖéÊúçÔºåÊØèÊó•‰∏ÄÂäëÔºåÂàÜ‰∫åÊ¨°Ê∫´Êúç',
                cautions: 'Èô∞ËôõÁÅ´Êó∫ËÄÖÊÖéÁî®',
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 6002,
                type: 'formula',
                name: 'ÂÖ≠ÂêõÂ≠êÊπØ',
                source: 'ÈÜ´Â≠∏Ê≠£ÂÇ≥',
                effects: 'ÁõäÊ∞£ÂÅ•ËÑæÔºåÁá•ÊøïÂåñÁó∞',
                indications: 'ËÑæËÉÉÊ∞£ËôõÂÖºÊúâÁó∞ÊøïÔºåÈ£üÂ∞ë‰æøÊ∫èÔºåËÉ∏ËÑòÁóûÊÇ∂ÔºåÂòîÈÄÜÁ≠âÁóá',
                composition: '‰∫∫ÂèÉ\nÁôΩÊúÆ\nËåØËãì\nÁîòËçâ\nÈô≥ÁöÆ\nÂçäÂ§è',
                usage: 'Ê∞¥ÁÖéÊúçÔºåÊØèÊó•‰∏ÄÂäëÔºåÂàÜ‰∫åÊ¨°Ê∫´Êúç',
                cautions: 'Èô∞ËôõÁá•Âí≥„ÄÅÊ¥•Ê∂≤‰∏çË∂≥ËÄÖÂøåÁî®',
                createdAt: new Date('2024-01-01').toISOString()
            }
        ];

        // ÂàùÂßãÂåñ‰∏≠Ëó•Â∫´Ë≥áÊñô
        let herbLibrary = [];
        /**
         * Âæû Firestore ËÆÄÂèñ‰∏≠Ëó•Â∫´Ë≥áÊñôÔºåËã•Ë≥áÊñô‰∏çÂ≠òÂú®ÂâáËá™Âãï‰ΩøÁî®È†êË®≠ÂÄºÂàùÂßãÂåñ„ÄÇ
         * Ê≠§ÂáΩÂºèÊúÉÁ≠âÂæÖ Firebase ÂàùÂßãÂåñÂÆåÊàêÂæåÂÜçÂü∑Ë°å„ÄÇ
         */
        async function initHerbLibrary() {
            // Á≠âÂæÖ Firebase ÂàùÂßãÂåñ
            while (!window.firebase || !window.firebase.db) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            try {
                // Âæû Firestore ÂèñÂæó herbLibrary ÈõÜÂêàË≥áÊñô
                const querySnapshot = await window.firebase.getDocs(
                    window.firebase.collection(window.firebase.db, 'herbLibrary')
                );
                const herbsFromFirestore = [];
                querySnapshot.forEach((docSnap) => {
                    // docSnap.data() Â∑≤ÂåÖÂê´ id Â±¨ÊÄßÔºåÂõ†Ê≠§Áõ¥Êé•Â±ïÈñã
                    herbsFromFirestore.push({ ...docSnap.data() });
                });
                if (herbsFromFirestore.length === 0) {
                    // Ëã• Firestore ‰∏≠Ê≤íÊúâË≥áÊñôÔºå‰ΩøÁî®È†êË®≠‰∏≠Ëó•ÊùêËàáÊñπÂäëÂàùÂßãÂåñ
                    const combinedDefaults = [...defaultHerbs, ...defaultFormulas];
                    for (const item of combinedDefaults) {
                        await window.firebase.setDoc(
                            window.firebase.doc(window.firebase.db, 'herbLibrary', String(item.id)),
                            item
                        );
                    }
                    herbLibrary = combinedDefaults;
                } else {
                    herbLibrary = herbsFromFirestore;
                }
            } catch (error) {
                console.error('ËÆÄÂèñ/ÂàùÂßãÂåñ‰∏≠Ëó•Â∫´Ë≥áÊñôÂ§±Êïó:', error);
            }
        }

        // È†êË®≠Êî∂Ë≤ªÈ†ÖÁõÆË≥áÊñô
        const defaultBillingItems = [
            // Ë®∫ÁôÇË≤ªÈ°ûÂà•
            {
                id: 4001,
                name: 'Ë®∫Èáë',
                category: 'consultation',
                price: 150,
                unit: 'Ê¨°',
                description: '‰∏≠ÈÜ´Â∏´Ë®∫ÁóáË≤ªÁî®',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4002,
                name: 'Ë§áË®∫Ë≤ª',
                category: 'consultation',
                price: 120,
                unit: 'Ê¨°',
                description: 'Ë§áË®∫ÁóÖ‰∫∫Ë®∫ÁóáË≤ªÁî®',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4003,
                name: 'ÊÄ•Ë®∫Ë≤ª',
                category: 'consultation',
                price: 200,
                unit: 'Ê¨°',
                description: 'ÊÄ•Ë®∫ÊàñÈùûËæ¶ÂÖ¨ÊôÇÈñìË®∫Áóá',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            
            // Ëó•Ë≤ªÈ°ûÂà•
            {
                id: 4011,
                name: '‰∏≠Ëó•Ë™øÂäëË≤ª',
                category: 'medicine',
                price: 25,
                unit: 'Âäë',
                description: '‰∏≠Ëó•ÊùêË™øÂäëÂèäÂåÖË£ùË≤ªÁî®',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4012,
                name: 'ÊøÉÁ∏Æ‰∏≠Ëó•Á≤â',
                category: 'medicine',
                price: 15,
                unit: 'ÂåÖ',
                description: 'ÁßëÂ≠∏‰∏≠Ëó•ÊøÉÁ∏ÆÁ≤âÂäë',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4013,
                name: 'Â§ñÁî®Ëó•ËÜè',
                category: 'medicine',
                price: 80,
                unit: 'ÊîØ',
                description: '‰∏≠Ëó•Â§ñÁî®Ëó•ËÜè',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4014,
                name: 'Ëó•ÈÖí',
                category: 'medicine',
                price: 120,
                unit: 'Áì∂',
                description: '‰∏≠Ëó•Êµ∏Ë£ΩËó•ÈÖí',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            
            // Ê≤ªÁôÇË≤ªÈ°ûÂà•
            {
                id: 4021,
                name: 'ÈáùÁÅ∏Ê≤ªÁôÇ',
                category: 'treatment',
                price: 100,
                unit: 'Ê¨°',
                description: 'ÈáùÁÅ∏Á©¥‰ΩçÊ≤ªÁôÇ',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4022,
                name: 'Êé®ÊãøÊåâÊë©',
                category: 'treatment',
                price: 150,
                unit: 'Ê¨°',
                description: '‰∏≠ÈÜ´Êé®ÊãøÊåâÊë©Ê≤ªÁôÇ',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4023,
                name: 'ÊãîÁΩêÊ≤ªÁôÇ',
                category: 'treatment',
                price: 80,
                unit: 'Ê¨°',
                description: 'ÊãîÁΩêÁôÇÊ≥ï',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4024,
                name: 'ÂàÆÁóßÊ≤ªÁôÇ',
                category: 'treatment',
                price: 60,
                unit: 'Ê¨°',
                description: 'ÂàÆÁóßÁôÇÊ≥ï',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4025,
                name: 'ËâæÁÅ∏Ê≤ªÁôÇ',
                category: 'treatment',
                price: 90,
                unit: 'Ê¨°',
                description: 'ËâæÊ¢ùÁÅ∏Ê≥ïÊ≤ªÁôÇ',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4026,
                name: 'ÈõªÈáùÊ≤ªÁôÇ',
                category: 'treatment',
                price: 120,
                unit: 'Ê¨°',
                description: 'ÈõªÈáùÂà∫ÊøÄÊ≤ªÁôÇ',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4027,
                name: 'ËÄ≥ÈáùÊ≤ªÁôÇ',
                category: 'treatment',
                price: 70,
                unit: 'Ê¨°',
                description: 'ËÄ≥Á©¥ÈáùÂà∫Ê≤ªÁôÇ',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4028,
                name: 'Â∞èÂÖíÊé®Êãø',
                category: 'treatment',
                price: 100,
                unit: 'Ê¨°',
                description: 'Â∞èÂÖíÊé®ÊãøÊåâÊë©',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            
            // ÂÖ∂‰ªñÈ°ûÂà•
            {
                id: 4031,
                name: 'Ë®∫Êñ∑Êõ∏',
                category: 'other',
                price: 50,
                unit: '‰ªΩ',
                description: '‰∏≠ÈÜ´Ë®∫Êñ∑Ë≠âÊòéÊõ∏',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4032,
                name: 'ÁóÖÂÅáË≠âÊòé',
                category: 'other',
                price: 30,
                unit: '‰ªΩ',
                description: 'ÁóÖÂÅáË≠âÊòéÊõ∏',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4033,
                name: 'È´îË≥™Ë™øÁêÜË´ÆË©¢',
                category: 'other',
                price: 200,
                unit: 'Ê¨°',
                description: 'ÂÄã‰∫∫È´îË≥™ÂàÜÊûêÂèäË™øÁêÜÂª∫Ë≠∞',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4034,
                name: 'È£≤È£üÊåáÂ∞é',
                category: 'other',
                price: 80,
                unit: 'Ê¨°',
                description: '‰∏≠ÈÜ´È£≤È£üÁôÇÊ≥ïÊåáÂ∞é',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4035,
                name: 'È§äÁîü‰øùÂÅ•Ë´ÆË©¢',
                category: 'other',
                price: 120,
                unit: 'Ê¨°',
                description: '‰∏≠ÈÜ´È§äÁîü‰øùÂÅ•ÊåáÂ∞é',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            
            // ÊäòÊâ£È†ÖÁõÆÈ°ûÂà•
            {
                id: 4041,
                name: 'Èï∑ËÄÖÂÑ™ÊÉ†',
                category: 'discount',
                price: 0.9, // 9Êäò
                unit: '',
                description: '65Ê≠≤‰ª•‰∏äÈï∑ËÄÖ9ÊäòÂÑ™ÊÉ†',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4042,
                name: 'Â≠∏ÁîüÂÑ™ÊÉ†',
                category: 'discount',
                price: 0.85, // 85Êäò
                unit: '',
                description: 'Â≠∏ÁîüÊÜëË≠â85ÊäòÂÑ™ÊÉ†',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4043,
                name: 'ÊúÉÂì°ÂÑ™ÊÉ†',
                category: 'discount',
                price: 0.95, // 95Êäò
                unit: '',
                description: 'Ë®∫ÊâÄÊúÉÂì°95ÊäòÂÑ™ÊÉ†',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4044,
                name: 'ÁôÇÁ®ãÂ•óÈ§êÊäòÊâ£',
                category: 'discount',
                price: 0.8, // 8Êäò
                unit: '',
                description: 'Ë≥ºË≤∑ÁôÇÁ®ãÂ•óÈ§ê8ÊäòÂÑ™ÊÉ†',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4045,
                name: 'ÂàùË®∫ÂÑ™ÊÉ†',
                category: 'discount',
                price: -50, // Âõ∫ÂÆöÊ∏õ50ÂÖÉ
                unit: '',
                description: 'È¶ñÊ¨°Â∞±Ë®∫Ê∏õÂÖç50ÂÖÉ',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4046,
                name: 'Ë§áË®∫ÂÑ™ÊÉ†Âà∏',
                category: 'discount',
                price: -30, // Âõ∫ÂÆöÊ∏õ30ÂÖÉ
                unit: '',
                description: 'Ë§áË®∫ÂÑ™ÊÉ†Âà∏Ê∏õÂÖç30ÂÖÉ',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4047,
                name: 'ÂÆ∂Â∫≠Â•óÈ§êÊäòÊâ£',
                category: 'discount',
                price: 0.75, // 75Êäò
                unit: '',
                description: 'ÂÆ∂Â∫≠ÊàêÂì°ÂêåÊôÇÂ∞±Ë®∫75Êäò',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4048,
                name: 'ÁØÄÊó•ÁâπÊÉ†',
                category: 'discount',
                price: 0.88, // 88Êäò
                unit: '',
                description: 'ÁØÄÊó•ÊúüÈñìÁâπÂà•ÂÑ™ÊÉ†88Êäò',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            // Â•óÁ•®È†ÖÁõÆÈ°ûÂà•
            {
                id: 4051,
                name: '‰∏≠ÈÜ´È§äÁîüÂ•óÈ§ê',
                category: 'package',
                price: 1200,
                unit: 'Â•ó',
                description: 'ÂåÖÂê´ÔºöË®∫Áóá1Ê¨° + ÈáùÁÅ∏3Ê¨° + ‰∏≠Ëó•7ÂäëÔºåÈÅ©ÂêàÊó•Â∏∏‰øùÂÅ•',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4052,
                name: 'ÈáùÁÅ∏ÁôÇÁ®ãÂ•óÁ•®Ôºà10Ê¨°Ôºâ',
                category: 'package',
                price: 800,
                unit: 'Â•ó',
                description: 'ÈáùÁÅ∏Ê≤ªÁôÇ10Ê¨°Â•óÁ•®ÔºåÂñÆÊ¨°‰ΩøÁî®ÂÉπÂÄº$100ÔºåÂ•óÁ•®ÂÉπ$800',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4053,
                name: 'Êé®ÊãøÊåâÊë©Â•óÁ•®Ôºà5Ê¨°Ôºâ',
                category: 'package',
                price: 600,
                unit: 'Â•ó',
                description: 'Êé®ÊãøÊåâÊë©5Ê¨°Â•óÁ•®ÔºåÂñÆÊ¨°‰ΩøÁî®ÂÉπÂÄº$150ÔºåÂ•óÁ•®ÂÉπ$600',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4054,
                name: '‰∏≠ÈÜ´Ë™øÁêÜÁôÇÁ®ã',
                category: 'package',
                price: 2000,
                unit: 'Â•ó',
                description: 'ÂåÖÂê´ÔºöÂàùË®∫1Ê¨° + Ë§áË®∫3Ê¨° + ÈáùÁÅ∏8Ê¨° + ‰∏≠Ëó•21ÂäëÔºå3ÈÄ±ÂÆåÊï¥Ë™øÁêÜ',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4055,
                name: 'ÂÆ∂Â∫≠‰øùÂÅ•Â•óÈ§ê',
                category: 'package',
                price: 3000,
                unit: 'Â•ó',
                description: 'ÈÅ©Âêà3-4‰∫∫ÂÆ∂Â∫≠ÔºåÂåÖÂê´È´îË≥™ÂàÜÊûê„ÄÅÈ§äÁîüÊåáÂ∞é„ÄÅÈ†êÈò≤‰øùÂÅ•Ë´ÆË©¢',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4056,
                name: 'ÁóõÁóáÂ∞àÈ†ÖÂ•óÁ•®',
                category: 'package',
                price: 1500,
                unit: 'Â•ó',
                description: 'Â∞àÊ≤ªÂêÑÁ®ÆÁóõÁóáÔºåÂåÖÂê´ÔºöË®∫Áóá2Ê¨° + ÈáùÁÅ∏6Ê¨° + Êé®Êãø4Ê¨° + Â§ñÁî®Ëó•ËÜè',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4057,
                name: 'ÊúàÂ≠êË™øÁêÜÂ•óÈ§ê',
                category: 'package',
                price: 2500,
                unit: 'Â•ó',
                description: 'Áî¢ÂæåË™øÁêÜÂ∞àÁî®ÔºåÂåÖÂê´ÔºöË®∫Áóá4Ê¨° + ‰∏≠Ëó•28Âäë + ÁáüÈ§äÊåáÂ∞é + È´îË≥™Ë™øÁêÜ',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4058,
                name: 'Â≠∏ÁîüÂÅ•Â∫∑Â•óÁ•®',
                category: 'package',
                price: 800,
                unit: 'Â•ó',
                description: 'Â≠∏ÁîüÂ∞à‰∫´ÂÑ™ÊÉ†Â•óÁ•®ÔºåÂåÖÂê´ÔºöË®∫Áóá2Ê¨° + ÈáùÁÅ∏3Ê¨° + ÂÅ•Â∫∑ÊåáÂ∞é',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            }
        ];

        // ÂàùÂßãÂåñÊî∂Ë≤ªÈ†ÖÁõÆË≥áÊñô
        let billingItems = [];
        /**
         * Âæû Firestore ËÆÄÂèñÊî∂Ë≤ªÈ†ÖÁõÆË≥áÊñôÔºåËã•Ë≥áÊñô‰∏çÂ≠òÂú®Ââá‰ΩøÁî®È†êË®≠Ë≥áÊñôÂàùÂßãÂåñ„ÄÇ
         * Ê≠§ÂáΩÂºèÊúÉÁ≠âÂæÖ Firebase ÂàùÂßãÂåñÂÆåÊàêÂæåÂÜçÂü∑Ë°å„ÄÇ
         */
        async function initBillingItems() {
            // Á≠âÂæÖ Firebase ÂàùÂßãÂåñ
            while (!window.firebase || !window.firebase.db) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            try {
                // Âæû Firestore ÂèñÂæó billingItems ÈõÜÂêàË≥áÊñô
                const querySnapshot = await window.firebase.getDocs(
                    window.firebase.collection(window.firebase.db, 'billingItems')
                );
                const itemsFromFirestore = [];
                querySnapshot.forEach((docSnap) => {
                    itemsFromFirestore.push({ ...docSnap.data() });
                });
                if (itemsFromFirestore.length === 0) {
                    // Ëã• Firestore ‰∏≠Ê≤íÊúâË≥áÊñôÔºå‰ΩøÁî®È†êË®≠Êî∂Ë≤ªÈ†ÖÁõÆÂàùÂßãÂåñ
                    for (const item of defaultBillingItems) {
                        await window.firebase.setDoc(
                            window.firebase.doc(window.firebase.db, 'billingItems', String(item.id)),
                            item
                        );
                    }
                    billingItems = defaultBillingItems;
                } else {
                    billingItems = itemsFromFirestore;
                }
            } catch (error) {
                console.error('ËÆÄÂèñ/ÂàùÂßãÂåñÊî∂Ë≤ªÈ†ÖÁõÆË≥áÊñôÂ§±Êïó:', error);
            }
        }

        // È†êË®≠Áî®Êà∂Ë≥áÊñô
        const defaultUsers = [
            {
                id: 1,
                username: 'manager',
                name: 'Èô≥Á∂ìÁêÜ',
                position: 'Ë®∫ÊâÄÁÆ°ÁêÜ',
                email: 'admin@clinic.com',
                phone: '02-8888-1001',
                active: true,
                // Firebase UID Â∞çÊáâÂÄºÔºåÂèØÊñºÁî®Êà∂ÁÆ°ÁêÜ‰∏≠Ë®≠ÂÆö
                uid: '',
                createdAt: new Date('2024-01-01').toISOString(),
                lastLogin: null
            },
            {
                id: 2,
                username: 'drzhang',
                name: 'Âºµ‰∏≠ÈÜ´Â∏´',
                position: 'ÈÜ´Â∏´',
                registrationNumber: 'CM001234',
                email: 'doctor@clinic.com',
                phone: '02-8888-1002',
                active: true,
                // Firebase UID Â∞çÊáâÂÄºÔºåÂèØÊñºÁî®Êà∂ÁÆ°ÁêÜ‰∏≠Ë®≠ÂÆö
                uid: '',
                createdAt: new Date('2024-01-01').toISOString(),
                lastLogin: null
            },
            {
                id: 3,
                username: 'nurse_amy',
                name: 'ÊûóË≠∑ÁêÜÂ∏´',
                position: 'Ë≠∑ÁêÜÂ∏´',
                email: 'nurse@clinic.com',
                phone: '02-8888-1003',
                active: true,
                // Firebase UID Â∞çÊáâÂÄºÔºåÂèØÊñºÁî®Êà∂ÁÆ°ÁêÜ‰∏≠Ë®≠ÂÆö
                uid: '',
                createdAt: new Date('2024-01-01').toISOString(),
                lastLogin: null
            }
        ];

        // ÂàùÂßãÂåñÁî®Êà∂Ë≥áÊñô
        let users = JSON.parse(localStorage.getItem('users') || '[]');
        if (users.length === 0) {
            users = defaultUsers;
            localStorage.setItem('users', JSON.stringify(users));
        }

        // ÊâÄÊúâÁî®Êà∂ÈÉΩÊúâÂÆåÊï¥Ê¨äÈôê
        const allPermissions = ['patientManagement', 'consultationSystem', 'herbLibrary', 'billingManagement', 'financialReports', 'userManagement', 'systemManagement'];

// ‰∏ªË¶ÅÁôªÂÖ•ÂäüËÉΩ
async function attemptMainLogin() {
    const email = document.getElementById('mainLoginUsername').value.trim();
    const password = document.getElementById('mainLoginPassword').value.trim();
    
    if (!email || !password) {
        showToast('Ë´ãËº∏ÂÖ•ÈõªÂ≠êÈÉµ‰ª∂ÂíåÂØÜÁ¢ºÔºÅ', 'error');
        return;
    }

    // È°ØÁ§∫ËºâÂÖ•ÁãÄÊÖã
    const loginButton = document.querySelector('button[onclick="attemptMainLogin()"]');
    const originalText = loginButton.textContent;
    loginButton.textContent = 'ÁôªÂÖ•‰∏≠...';
    loginButton.disabled = true;

    try {
        // Á≠âÂæÖ Firebase ÂàùÂßãÂåñ
        while (!window.firebase) {
            await new Promise(resolve => setTimeout(resolve, 100));
        }

        // ‰ΩøÁî® Firebase ÁôªÂÖ•
        const userCredential = await window.firebase.signInWithEmailAndPassword(
            window.firebase.auth,
            email,
            password
        );

        console.log('Firebase ÁôªÂÖ•ÊàêÂäü:', userCredential.user.email);

        // ÂèñÂæó Firebase ‰ΩøÁî®ËÄÖË≥áË®ä
        const firebaseUser = userCredential.user;
        const uid = firebaseUser.uid;

        // ÂêåÊ≠•ËºâÂÖ• Firebase Áî®Êà∂Êï∏Êìö
        await syncUserDataFromFirebase();

        // Âú®Áî®Êà∂Ë≥áÊñô‰∏≠Â∞ãÊâæÂ∞çÊáâÁöÑ UID ÊàñÈõªÂ≠êÈÉµ‰ª∂
        let matchingUser = users.find(u => u.uid && u.uid === uid);
        if (!matchingUser) {
            // Ëã•Êú™Ë®≠ÂÆö uidÔºåÊîπÁî® email ÊØîÂ∞çÔºà‰∏çÂçÄÂàÜÂ§ßÂ∞èÂØ´Ôºâ
            matchingUser = users.find(u => u.email && u.email.toLowerCase() === firebaseUser.email.toLowerCase());
            if (matchingUser) {
                // Â∞á Firebase UID Ë®≠ÂÆöÂà∞Áî®Êà∂Ë≥áÊñô‰∏≠Ôºå‰ª•‰æø‰∏ãÊ¨°ÂèØÁõ¥Êé•ÈÄèÈÅé UID ÊØîÂ∞ç
                matchingUser.uid = uid;
                
                // Êõ¥Êñ∞Âà∞ Firebase
                try {
                    await window.firebaseDataManager.updateUser(matchingUser.id, { uid: uid });
                } catch (error) {
                    console.error('Êõ¥Êñ∞Áî®Êà∂ UID Â§±Êïó:', error);
                }
                
                // Êõ¥Êñ∞Êú¨Âú∞Â≠òÂÑ≤
                localStorage.setItem('users', JSON.stringify(users));
            }
        }

        if (matchingUser) {
            // ÊâæÂà∞Â∞çÊáâÁî®Êà∂ÔºåÊ™¢Êü•ÊòØÂê¶ÂïüÁî®
            if (!matchingUser.active) {
                showToast('ÊÇ®ÁöÑÂ∏≥ËôüÂ∑≤Ë¢´ÂÅúÁî®ÔºåË´ãËÅØÁπ´ÁÆ°ÁêÜÂì°', 'error');
                await window.firebase.signOut(window.firebase.auth);
                return;
            }

            // Êõ¥Êñ∞ÊúÄÂæåÁôªÂÖ•ÊôÇÈñì
            matchingUser.lastLogin = new Date().toISOString();
            try {
                await window.firebaseDataManager.updateUser(matchingUser.id, { 
                    lastLogin: new Date() 
                });
            } catch (error) {
                console.error('Êõ¥Êñ∞ÊúÄÂæåÁôªÂÖ•ÊôÇÈñìÂ§±Êïó:', error);
            }
            
            // ‰ΩøÁî®Áî®Êà∂Ë≥áÊñôÈÄ≤Ë°åÁôªÂÖ•
            currentUserData = matchingUser;
            currentUser = matchingUser.username;
        } else {
            // Ëã•Êâæ‰∏çÂà∞Â∞çÊáâÁî®Êà∂Ôºå‰ΩøÁî® Firebase Ë≥áË®äÂª∫Á´ãËá®ÊôÇÁî®Êà∂Ë≥áÊñô
            currentUserData = {
                id: null,
                uid: uid,
                username: firebaseUser.email,
                email: firebaseUser.email,
                name: firebaseUser.displayName || getUserNameFromEmail(firebaseUser.email),
                position: getUserPositionFromEmail(firebaseUser.email),
                active: true,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                lastLogin: new Date().toISOString()
            };
            currentUser = currentUserData.username;
        }

        // ÁôªÂÖ•ÊàêÂäüÔºåÂàáÊèõÂà∞‰∏ªÁ≥ªÁµ±
        performLogin(currentUserData);
        
        showToast('ÁôªÂÖ•ÊàêÂäüÔºÅ', 'success');

    } catch (error) {
        console.error('ÁôªÂÖ•Â§±Êïó:', error);
        let errorMessage = 'ÁôªÂÖ•Â§±Êïó';
        
        if (error.code === 'auth/user-not-found') {
            errorMessage = 'ÈõªÂ≠êÈÉµ‰ª∂‰∏çÂ≠òÂú®';
        } else if (error.code === 'auth/wrong-password') {
            errorMessage = 'ÂØÜÁ¢ºÈåØË™§';
        } else if (error.code === 'auth/invalid-email') {
            errorMessage = 'ÈõªÂ≠êÈÉµ‰ª∂Ê†ºÂºè‰∏çÊ≠£Á¢∫';
        }
        
        showToast(errorMessage, 'error');
        document.getElementById('mainLoginPassword').value = '';
    } finally {
        // ÊÅ¢Âæ©ÊåâÈàïÁãÄÊÖã
        loginButton.textContent = originalText;
        loginButton.disabled = false;
    }
}

// ÂêåÊ≠• Firebase Áî®Êà∂Êï∏ÊìöÂà∞Êú¨Âú∞
async function syncUserDataFromFirebase() {
    try {
        if (!window.firebaseDataManager || !window.firebaseDataManager.isReady) {
            console.log('Firebase Êï∏ÊìöÁÆ°ÁêÜÂô®Â∞öÊú™Ê∫ñÂÇôÂ∞±Á∑íÔºåË∑≥ÈÅéÂêåÊ≠•');
            return;
        }

        const result = await window.firebaseDataManager.getUsers();
        if (result.success && result.data.length > 0) {
            // Êõ¥Êñ∞Êú¨Âú∞ users ËÆäÊï∏
            users = result.data.map(user => ({
                ...user,
                // Á¢∫‰øùÊï∏ÊìöÊ†ºÂºèÂÖºÂÆπÊÄß
                createdAt: user.createdAt ? (user.createdAt.seconds ? new Date(user.createdAt.seconds * 1000).toISOString() : user.createdAt) : new Date().toISOString(),
                updatedAt: user.updatedAt ? (user.updatedAt.seconds ? new Date(user.updatedAt.seconds * 1000).toISOString() : user.updatedAt) : new Date().toISOString(),
                lastLogin: user.lastLogin ? (user.lastLogin.seconds ? new Date(user.lastLogin.seconds * 1000).toISOString() : user.lastLogin) : null
            }));
            
            // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÑ≤‰ΩúÁÇ∫ÂÇôÁî®
            localStorage.setItem('users', JSON.stringify(users));
            console.log('Â∑≤ÂêåÊ≠• Firebase Áî®Êà∂Êï∏ÊìöÂà∞Êú¨Âú∞:', users.length, 'Á≠Ü');
        } else {
            console.log('Firebase Áî®Êà∂Êï∏ÊìöÁÇ∫Á©∫ÊàñËÆÄÂèñÂ§±ÊïóÔºå‰ΩøÁî®Êú¨Âú∞Êï∏Êìö');
        }
    } catch (error) {
        console.error('ÂêåÊ≠• Firebase Áî®Êà∂Êï∏ÊìöÂ§±Êïó:', error);
    }
}

// Âπ´Âä©ÂáΩÊï∏ÔºöÂæû email Áç≤ÂèñÂßìÂêç
function getUserNameFromEmail(email) {
    if (email === 'admin@clinic.com') return 'Á≥ªÁµ±ÁÆ°ÁêÜÂì°';
    if (email === 'doctor@clinic.com') return 'Âºµ‰∏≠ÈÜ´Â∏´';
    if (email === 'nurse@clinic.com') return 'ÊûóË≠∑ÁêÜÂ∏´';
    return 'Áî®Êà∂';
}

// Âπ´Âä©ÂáΩÊï∏ÔºöÂæû email Áç≤ÂèñËÅ∑‰Ωç
function getUserPositionFromEmail(email) {
    if (email === 'admin@clinic.com') return 'Ë®∫ÊâÄÁÆ°ÁêÜ';
    if (email === 'doctor@clinic.com') return 'ÈÜ´Â∏´';
    if (email === 'nurse@clinic.com') return 'Ë≠∑ÁêÜÂ∏´';
    return 'Áî®Êà∂';
}
        
        // Âü∑Ë°åÁôªÂÖ•
        function performLogin(user) {
            // Êõ¥Êñ∞ÊúÄÂæåÁôªÂÖ•ÊôÇÈñì
            const userIndex = users.findIndex(u => u.id === user.id);
            if (userIndex !== -1) {
                users[userIndex].lastLogin = new Date().toISOString();
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            currentUser = user.username;
            currentUserData = user;
            
            // ÂàáÊèõÂà∞‰∏ªÁ≥ªÁµ±
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainSystem').classList.remove('hidden');
            
            document.getElementById('userRole').textContent = `Áï∂ÂâçÁî®Êà∂Ôºö${getUserDisplayName(user)}`;
            document.getElementById('sidebarUserRole').textContent = `Áï∂ÂâçÁî®Êà∂Ôºö${getUserDisplayName(user)}`;
            
            generateSidebarMenu();
            updateStatistics();
            
            showToast(`Ê≠°ËøéÂõû‰æÜÔºå${getUserDisplayName(user)}ÔºÅ`, 'success');
        }

        // ÂÅ¥ÈÇäÈÅ∏ÂñÆÊéßÂà∂
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        // ÁôªÂá∫ÂäüËÉΩ
async function logout() {
    try {
        // Firebase ÁôªÂá∫
        if (window.firebase && window.firebase.auth) {
            await window.firebase.signOut(window.firebase.auth);
        }
        
        // Ê∏ÖÁêÜÊú¨Âú∞Êï∏Êìö
        currentUser = null;
        currentUserData = null;
        
        // ÂàáÊèõÈ†ÅÈù¢
        document.getElementById('loginPage').classList.remove('hidden');
        document.getElementById('mainSystem').classList.add('hidden');
        document.getElementById('sidebar').classList.add('-translate-x-full');
        document.getElementById('sidebarOverlay').classList.add('hidden');
        hideAllSections();
        
        // Ê∏ÖÁ©∫ÁôªÂÖ•Ë°®ÂñÆ
        document.getElementById('mainLoginUsername').value = '';
        document.getElementById('mainLoginPassword').value = '';
        
        showToast('Â∑≤ÊàêÂäüÁôªÂá∫', 'success');
        
    } catch (error) {
        console.error('ÁôªÂá∫ÈåØË™§:', error);
        showToast('ÁôªÂá∫ÊôÇÁôºÁîüÈåØË™§', 'error');
    }
}

        // ÁîüÊàêÂÅ¥ÈÇäÈÅ∏ÂñÆ
        function generateSidebarMenu() {
            const menuContainer = document.getElementById('sidebarMenu');
            menuContainer.innerHTML = '';

            // ÂÆöÁæ©ÂêÑÂÄãÂäüËÉΩÁöÑÊ®ôÈ°å„ÄÅÂúñÁ§∫ÂèäË™™Êòé
            const menuItems = {
                patientManagement: { title: 'ÁóÖ‰∫∫Ë≥áÊñôÁÆ°ÁêÜ', icon: 'üë•', description: 'Êñ∞Â¢û„ÄÅÊü•Áúã„ÄÅÁÆ°ÁêÜÁóÖ‰∫∫Ë≥áÊñô' },
                consultationSystem: { title: 'Ë®∫ÁóáÁ≥ªÁµ±', icon: 'ü©∫', description: 'Ë®òÈåÑÁóáÁãÄ„ÄÅË®∫Êñ∑„ÄÅÈñãÁ´ãËôïÊñπ' },
                herbLibrary: { title: '‰∏≠Ëó•Â∫´ÁÆ°ÁêÜ', icon: 'üåø', description: 'ÁÆ°ÁêÜ‰∏≠Ëó•ÊùêÂèäÊñπÂäëË≥áÊñô' },
                billingManagement: { title: 'Êî∂Ë≤ªÈ†ÖÁõÆÁÆ°ÁêÜ', icon: 'üí∞', description: 'ÁÆ°ÁêÜË®∫ÁôÇË≤ªÁî®ÂèäÊî∂Ë≤ªÈ†ÖÁõÆ' },
                userManagement: { title: 'Ë®∫ÊâÄÁî®Êà∂ÁÆ°ÁêÜ', icon: 'üë§', description: 'ÁÆ°ÁêÜË®∫ÊâÄÁî®Êà∂Ê¨äÈôê' },
                financialReports: { title: 'Ë≤°ÂãôÂ†±Ë°®', icon: 'üìä', description: 'Êî∂ÂÖ•ÂàÜÊûêËàáË≤°ÂãôÁµ±Ë®à' },
                systemManagement: { title: 'Á≥ªÁµ±ÁÆ°ÁêÜ', icon: '‚öôÔ∏è', description: 'Áµ±Ë®àË≥áÊñô„ÄÅÂÇô‰ªΩÂåØÂá∫' }
            };

            /*
             * Ê†πÊìöÁï∂ÂâçÁî®Êà∂ÁöÑËÅ∑‰ΩçÊ±∫ÂÆöÂèØ‰ΩøÁî®ÁöÑÂäüËÉΩÂàóË°®„ÄÇ‰∏ÄËà¨ËÅ∑‰ΩçÂÉÖËÉΩÊü•ÁúãËàáË®∫ÁôÇÁõ∏ÈóúÁöÑË≥áÊñôÔºå
             * „ÄåË®∫ÊâÄÁÆ°ÁêÜ„ÄçËÅ∑‰ΩçÂèØ‰ª•È°çÂ§ñÂ≠òÂèñË≤°ÂãôÂ†±Ë°®„ÄÅÁî®Êà∂ÁÆ°ÁêÜËàáÁ≥ªÁµ±ÁÆ°ÁêÜ„ÄÇ
             */
            function getPermissionsForPosition(position) {
                const basePermissions = ['patientManagement', 'consultationSystem', 'herbLibrary', 'billingManagement'];
                // „ÄåË®∫ÊâÄÁÆ°ÁêÜ„ÄçËÅ∑‰ΩçÂèØ‰ΩøÁî®ÊâÄÊúâÈÄ≤ÈöéÂäüËÉΩ
                if (position === 'Ë®∫ÊâÄÁÆ°ÁêÜ') {
                    return [...basePermissions, 'financialReports', 'userManagement', 'systemManagement'];
                }
                // ÈÜ´Â∏´ËÅ∑‰Ωç‰∫¶ÂèØÁÆ°ÁêÜÁî®Êà∂ÔºåÂõ†Ê≠§Âä†ÂÖ• userManagement Ê¨äÈôê
                if (position === 'ÈÜ´Â∏´') {
                    return [...basePermissions, 'userManagement'];
                }
                // ÂÖ∂‰ªñËÅ∑‰ΩçÂÉÖÂÖ∑ÂÇôÂü∫Êú¨ÂäüËÉΩ
                return basePermissions;
            }

            // ÂèñÂæóÁï∂ÂâçÁî®Êà∂ËÅ∑‰ΩçÔºåÊ≤íÊúâËÅ∑‰ΩçÈ†êË®≠ÁÇ∫‰∏ÄËà¨‰ΩøÁî®ËÄÖ
            const userPosition = (currentUserData && currentUserData.position) || '';
            const permissions = getPermissionsForPosition(userPosition);

            // ‰æùÂ∫èÂª∫Á´ãÂÅ¥ÈÇäÈÅ∏ÂñÆÊåâÈàï
            permissions.forEach(permission => {
                const item = menuItems[permission];
                if (!item) return;
                const button = document.createElement('button');
                button.className = 'w-full text-left p-4 rounded-lg hover:bg-gray-100 transition duration-200 border border-gray-200 mb-2';
                button.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-2xl mr-4">${item.icon}</span>
                        <div>
                            <div class="font-semibold text-gray-800">${item.title}</div>
                            <div class="text-sm text-gray-600">${item.description}</div>
                        </div>
                    </div>
                `;
                button.onclick = () => {
                    showSection(permission);
                    toggleSidebar();
                };
                menuContainer.appendChild(button);
            });
        }

        // È°ØÁ§∫ÊåáÂÆöÂçÄÂüü
        function showSection(sectionId) {
            // Ëã•ÁÇ∫Ë≤°ÂãôÂ†±Ë°®ÊàñÁ≥ªÁµ±ÁÆ°ÁêÜÔºåÂÉÖÈôêË®∫ÊâÄÁÆ°ÁêÜÂ≠òÂèñ
            if (['financialReports', 'systemManagement'].includes(sectionId)) {
                if (!currentUserData || currentUserData.position !== 'Ë®∫ÊâÄÁÆ°ÁêÜ') {
                    showToast('Ê¨äÈôê‰∏çË∂≥ÔºåÂÉÖË®∫ÊâÄÁÆ°ÁêÜÂèØ‰ΩøÁî®Ê≠§ÂäüËÉΩ', 'error');
                    return;
                }
            }
            // Ëã•ÁÇ∫Áî®Êà∂ÁÆ°ÁêÜÔºåË®∫ÊâÄÁÆ°ÁêÜÂèäÈÜ´Â∏´ÁöÜÂèØÂ≠òÂèñ
            if (sectionId === 'userManagement') {
                if (!currentUserData || !['Ë®∫ÊâÄÁÆ°ÁêÜ', 'ÈÜ´Â∏´'].includes(currentUserData.position)) {
                    showToast('Ê¨äÈôê‰∏çË∂≥ÔºåÂÉÖË®∫ÊâÄÁÆ°ÁêÜÊàñÈÜ´Â∏´ÂèØ‰ΩøÁî®Ê≠§ÂäüËÉΩ', 'error');
                    return;
                }
            }

            hideAllSections();
            document.getElementById('welcomePage').classList.add('hidden');
            document.getElementById(sectionId).classList.remove('hidden');

            if (sectionId === 'patientManagement') {
                loadPatientList();
            } else if (sectionId === 'consultationSystem') {
                loadConsultationSystem();
            } else if (sectionId === 'herbLibrary') {
                loadHerbLibrary();
            } else if (sectionId === 'billingManagement') {
                loadBillingManagement();
            } else if (sectionId === 'financialReports') {
                loadFinancialReports();
            } else if (sectionId === 'userManagement') {
                loadUserManagement();
            }
        }

        // Èö±ËóèÊâÄÊúâÂçÄÂüü
        function hideAllSections() {
            ['patientManagement', 'consultationSystem', 'herbLibrary', 'billingManagement', 'userManagement', 'financialReports', 'systemManagement', 'welcomePage'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
        }

        // ÁóÖ‰∫∫ÁÆ°ÁêÜÂäüËÉΩ
        let editingPatientId = null;
        let filteredPatients = [];
        
        // Êõ¥Êñ∞ÁóÖ‰∫∫Âπ¥ÈΩ°È°ØÁ§∫
        function updatePatientAge() {
            const birthDate = document.getElementById('patientBirthDate').value;
            const ageInput = document.getElementById('patientAge');
            
            if (birthDate) {
                const age = calculateAge(birthDate);
                ageInput.value = age;
            } else {
                ageInput.value = '';
            }
        }

        function showAddPatientForm() {
            editingPatientId = null;
            document.getElementById('formTitle').textContent = 'Êñ∞Â¢ûÁóÖ‰∫∫Ë≥áÊñô';
            document.getElementById('saveButtonText').textContent = 'ÂÑ≤Â≠ò';
            document.getElementById('addPatientModal').classList.remove('hidden');
            clearPatientForm();
        }

        function hideAddPatientForm() {
            document.getElementById('addPatientModal').classList.add('hidden');
            clearPatientForm();
            editingPatientId = null;
        }

        function clearPatientForm() {
            ['patientName', 'patientAge', 'patientGender', 'patientPhone', 'patientIdCard', 'patientBirthDate', 'patientAddress', 'patientAllergies', 'patientHistory'].forEach(id => {
                document.getElementById(id).value = '';
            });
        }

async function savePatient() {
    const patient = {
        name: document.getElementById('patientName').value.trim(),
        age: document.getElementById('patientAge').value,
        gender: document.getElementById('patientGender').value,
        phone: document.getElementById('patientPhone').value.trim(),
        idCard: document.getElementById('patientIdCard').value.trim(),
        birthDate: document.getElementById('patientBirthDate').value,
        address: document.getElementById('patientAddress').value.trim(),
        allergies: document.getElementById('patientAllergies').value.trim(),
        history: document.getElementById('patientHistory').value.trim()
    };

    // È©óË≠âÂøÖÂ°´Ê¨Ñ‰ΩçÔºöÂßìÂêç„ÄÅÊÄßÂà•„ÄÅÈõªË©±„ÄÅÂá∫ÁîüÊó•ÊúüËàáË∫´ÂàÜË≠âÂ≠óËôü
    if (!patient.name || !patient.gender || !patient.phone || !patient.birthDate || !patient.idCard) {
        showToast('Ë´ãÂ°´ÂØ´ÂøÖË¶ÅË≥áÊñôÔºàÂßìÂêç„ÄÅÊÄßÂà•„ÄÅÈõªË©±„ÄÅÂá∫ÁîüÊó•Êúü„ÄÅË∫´ÂàÜË≠âÂ≠óËôüÔºâÔºÅ', 'error');
        return;
    }

    // È©óË≠âÂá∫ÁîüÊó•Êúü
    const birthDate = new Date(patient.birthDate);
    const today = new Date();
    if (birthDate > today) {
        showToast('Âá∫ÁîüÊó•Êúü‰∏çËÉΩÊôöÊñº‰ªäÂ§©ÔºÅ', 'error');
        return;
    }

    // Ë®àÁÆóÂπ¥ÈΩ°
    const calculatedAge = calculateAge(patient.birthDate);
    if (calculatedAge > 120) {
        showToast('Ë´ãÁ¢∫Ë™çÂá∫ÁîüÊó•ÊúüÊòØÂê¶Ê≠£Á¢∫ÔºÅ', 'error');
        return;
    }

    // È©óË≠âÈõªË©±Ê†ºÂºè
    const phoneRegex = /^[0-9\-\+\(\)\s]+$/;
    if (!phoneRegex.test(patient.phone)) {
        showToast('Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÈõªË©±ËôüÁ¢ºÔºÅ', 'error');
        return;
    }

    // ‰∏çÈôêÂà∂Ë∫´ÂàÜË≠âÂ≠óËôüÊ†ºÂºèÔºåÂõ†Ê≠§ÁÑ°ÈúÄÊ™¢Êü•Ê†ºÂºè

    try {
        if (editingPatientId) {
            // Êõ¥Êñ∞ÁèæÊúâÁóÖ‰∫∫
            const result = await window.firebaseDataManager.updatePatient(editingPatientId, patient);
            if (result.success) {
                showToast('ÁóÖ‰∫∫Ë≥áÊñôÂ∑≤ÊàêÂäüÊõ¥Êñ∞ÔºÅ', 'success');
            } else {
                showToast('Êõ¥Êñ∞Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
                return;
            }
        } else {
            // Êñ∞Â¢ûÁóÖ‰∫∫
            // ÁîüÊàêÁóÖ‰∫∫Á∑®Ëôü
            patient.patientNumber = await generatePatientNumberFromFirebase();
            
            const result = await window.firebaseDataManager.addPatient(patient);
            if (result.success) {
                showToast('ÁóÖ‰∫∫Ë≥áÊñôÂ∑≤ÊàêÂäüÊñ∞Â¢ûÔºÅ', 'success');
            } else {
                showToast('Êñ∞Â¢ûÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
                return;
            }
        }

        // ÈáçÊñ∞ËºâÂÖ•ÁóÖ‰∫∫ÂàóË°®
        await loadPatientListFromFirebase();
        hideAddPatientForm();
        updateStatistics();

    } catch (error) {
        console.error('‰øùÂ≠òÁóÖ‰∫∫Ë≥áÊñôÈåØË™§:', error);
        showToast('‰øùÂ≠òÊôÇÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
    }
}

        // Âæû Firebase ÁîüÊàêÁóÖ‰∫∫Á∑®Ëôü
async function generatePatientNumberFromFirebase() {
    try {
        const result = await window.firebaseDataManager.getPatients();
        if (!result.success) {
            return 'P000001'; // Â¶ÇÊûúÁÑ°Ê≥ïËÆÄÂèñÔºå‰ΩøÁî®È†êË®≠Á∑®Ëôü
        }

        const existingNumbers = result.data
            .map(p => p.patientNumber)
            .filter(num => num && num.startsWith('P'))
            .map(num => parseInt(num.substring(1)))
            .filter(num => !isNaN(num));

        const maxNumber = existingNumbers.length > 0 ? Math.max(...existingNumbers) : 0;
        const newNumber = maxNumber + 1;
        return `P${newNumber.toString().padStart(6, '0')}`;
    } catch (error) {
        console.error('ÁîüÊàêÁóÖ‰∫∫Á∑®ËôüÂ§±Êïó:', error);
        return `P${Date.now().toString().slice(-6)}`; // ÂÇôÁî®ÊñπÊ°à
    }
}

// Âæû Firebase ËºâÂÖ•ÁóÖ‰∫∫ÂàóË°®
async function loadPatientListFromFirebase() {
    const tbody = document.getElementById('patientList');
    const searchTerm = document.getElementById('searchPatient').value.toLowerCase();
    
    try {
        // È°ØÁ§∫ËºâÂÖ•‰∏≠
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
                    <div class="mt-2">ËºâÂÖ•‰∏≠...</div>
                </td>
            </tr>
        `;

        const result = await window.firebaseDataManager.getPatients();
        
        if (!result.success) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                        ËÆÄÂèñË≥áÊñôÂ§±ÊïóÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢
                    </td>
                </tr>
            `;
            return;
        }

        // ÈÅéÊøæÁóÖ‰∫∫Ë≥áÊñô
        const filteredPatients = result.data.filter(patient => 
            patient.name.toLowerCase().includes(searchTerm) ||
            patient.phone.includes(searchTerm) ||
            (patient.idCard && patient.idCard.toLowerCase().includes(searchTerm)) ||
            (patient.patientNumber && patient.patientNumber.toLowerCase().includes(searchTerm))
        );

        tbody.innerHTML = '';

        if (filteredPatients.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                        ${searchTerm ? 'Ê≤íÊúâÊâæÂà∞Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑÁóÖ‰∫∫' : 'Â∞öÁÑ°ÁóÖ‰∫∫Ë≥áÊñô'}
                    </td>
                </tr>
            `;
            return;
        }

        filteredPatients.forEach(patient => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            row.innerHTML = `
                <td class="px-4 py-3 text-sm text-blue-600 font-medium">${patient.patientNumber || 'Êú™Ë®≠ÂÆö'}</td>
                <td class="px-4 py-3 text-sm text-gray-900 font-medium">${patient.name}</td>
                <td class="px-4 py-3 text-sm text-gray-900">${formatAge(patient.birthDate)}</td>
                <td class="px-4 py-3 text-sm text-gray-900">${patient.gender}</td>
                <td class="px-4 py-3 text-sm text-gray-900">${patient.phone}</td>
                <td class="px-4 py-3 text-sm space-x-2">
                    <button onclick="viewPatient('${patient.id}')" class="text-blue-600 hover:text-blue-800">Êü•Áúã</button>
                    <button onclick="editPatient('${patient.id}')" class="text-green-600 hover:text-green-800">Á∑®ËºØ</button>
                    <button onclick="deletePatient('${patient.id}')" class="text-red-600 hover:text-red-800">Âà™Èô§</button>
                </td>
            `;
            tbody.appendChild(row);
        });

        console.log('Â∑≤ËºâÂÖ•', filteredPatients.length, 'Á≠ÜÁóÖ‰∫∫Ë≥áÊñô');

    } catch (error) {
        console.error('ËºâÂÖ•ÁóÖ‰∫∫ÂàóË°®ÈåØË™§:', error);
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                    ËºâÂÖ•Â§±ÊïóÔºåË´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Êé•
                </td>
            </tr>
        `;
    }
}

function loadPatientList() {
    loadPatientListFromFirebase();
}

async function editPatient(id) {
    try {
        // Âæû Firebase Áç≤ÂèñÁóÖ‰∫∫Ë≥áÊñô
        const result = await window.firebaseDataManager.getPatients();
        if (!result.success) {
            showToast('ÁÑ°Ê≥ïËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñô', 'error');
            return;
        }

        const patient = result.data.find(p => p.id === id);
        if (!patient) {
            showToast('Êâæ‰∏çÂà∞ÁóÖ‰∫∫Ë≥áÊñô', 'error');
            return;
        }

        editingPatientId = id;
        document.getElementById('formTitle').textContent = 'Á∑®ËºØÁóÖ‰∫∫Ë≥áÊñô';
        document.getElementById('saveButtonText').textContent = 'Êõ¥Êñ∞';
        
        // Â°´ÂÖ•ÁèæÊúâË≥áÊñô
        document.getElementById('patientName').value = patient.name || '';
        document.getElementById('patientGender').value = patient.gender || '';
        document.getElementById('patientPhone').value = patient.phone || '';
        document.getElementById('patientIdCard').value = patient.idCard || '';
        document.getElementById('patientBirthDate').value = patient.birthDate || '';
        document.getElementById('patientAddress').value = patient.address || '';
        document.getElementById('patientAllergies').value = patient.allergies || '';
        document.getElementById('patientHistory').value = patient.history || '';
        
        // Ëá™ÂãïË®àÁÆóÂπ¥ÈΩ°
        updatePatientAge();
        
        document.getElementById('addPatientModal').classList.remove('hidden');

    } catch (error) {
        console.error('Á∑®ËºØÁóÖ‰∫∫Ë≥áÊñôÈåØË™§:', error);
        showToast('ËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñôÂ§±Êïó', 'error');
    }
}
async function deletePatient(id) {
    try {
        // Âæû Firebase Áç≤ÂèñÁóÖ‰∫∫Ë≥áÊñô
        const result = await window.firebaseDataManager.getPatients();
        if (!result.success) {
            showToast('ÁÑ°Ê≥ïËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñô', 'error');
            return;
        }

        const patient = result.data.find(p => p.id === id);
        if (!patient) {
            showToast('Êâæ‰∏çÂà∞ÁóÖ‰∫∫Ë≥áÊñô', 'error');
            return;
        }

        const confirmMessage = `Á¢∫ÂÆöË¶ÅÂà™Èô§ÁóÖ‰∫∫„Äå${patient.name}„ÄçÁöÑË≥áÊñôÂóéÔºü\n\nÊ≥®ÊÑèÔºöÁõ∏ÈóúÁöÑË®∫ÁóáË®òÈåÑ‰πüÊúÉ‰∏Ä‰ΩµÂà™Èô§ÔºÅ`;
        
        if (confirm(confirmMessage)) {
            // È°ØÁ§∫Âà™Èô§‰∏≠ÁãÄÊÖã
            showToast('Âà™Èô§‰∏≠...', 'info');

            // Âæû Firebase Âà™Èô§ÁóÖ‰∫∫Ë≥áÊñô
            const deleteResult = await window.firebaseDataManager.deletePatient(id);
            
            if (deleteResult.success) {
                showToast('ÁóÖ‰∫∫Ë≥áÊñôÂ∑≤Âà™Èô§ÔºÅ', 'success');
                // ÈáçÊñ∞ËºâÂÖ•ÁóÖ‰∫∫ÂàóË°®
                await loadPatientListFromFirebase();
                updateStatistics();
            } else {
                showToast('Âà™Èô§Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
            }
        }

    } catch (error) {
        console.error('Âà™Èô§ÁóÖ‰∫∫Ë≥áÊñôÈåØË™§:', error);
        showToast('Âà™Èô§ÊôÇÁôºÁîüÈåØË™§', 'error');
    }
}

async function viewPatient(id) {
    try {
        // Âæû Firebase Áç≤ÂèñÁóÖ‰∫∫Ë≥áÊñô
        const result = await window.firebaseDataManager.getPatients();
        if (!result.success) {
            showToast('ÁÑ°Ê≥ïËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñô', 'error');
            return;
        }

        const patient = result.data.find(p => p.id === id);
        if (!patient) {
            showToast('Êâæ‰∏çÂà∞ÁóÖ‰∫∫Ë≥áÊñô', 'error');
            return;
        }

        // È°ØÁ§∫ÁóÖ‰∫∫Ë©≥Á¥∞Ë≥áÊñô
        const content = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <h4 class="text-lg font-semibold text-gray-800 border-b pb-2">Âü∫Êú¨Ë≥áÊñô</h4>
                    <div class="space-y-2">
                        <div><span class="font-medium">ÁóÖ‰∫∫Á∑®ËôüÔºö</span><span class="text-blue-600 font-semibold">${patient.patientNumber || 'Êú™Ë®≠ÂÆö'}</span></div>
                        <div><span class="font-medium">ÂßìÂêçÔºö</span>${patient.name}</div>
                        <div><span class="font-medium">Âπ¥ÈΩ°Ôºö</span>${formatAge(patient.birthDate)}</div>
                        <div><span class="font-medium">ÊÄßÂà•Ôºö</span>${patient.gender}</div>
                        <div><span class="font-medium">ÈõªË©±Ôºö</span>${patient.phone}</div>
                        ${patient.idCard ? `<div><span class="font-medium">Ë∫´ÂàÜË≠âÔºö</span>${patient.idCard}</div>` : ''}
                        ${patient.birthDate ? `<div><span class="font-medium">Âá∫ÁîüÊó•ÊúüÔºö</span>${new Date(patient.birthDate).toLocaleDateString('zh-TW')}</div>` : ''}
                        ${patient.address ? `<div><span class="font-medium">Âú∞ÂùÄÔºö</span>${patient.address}</div>` : ''}
                    </div>
                </div>
                
                <div class="space-y-4">
                    <h4 class="text-lg font-semibold text-gray-800 border-b pb-2">ÈÜ´ÁôÇË≥áË®ä</h4>
                    <div class="space-y-2">
                        ${patient.allergies ? `<div><span class="font-medium">ÈÅéÊïèÂè≤Ôºö</span><div class="mt-1 p-2 bg-red-50 rounded text-sm">${patient.allergies}</div></div>` : ''}
                        ${patient.history ? `<div><span class="font-medium">ÁóÖÂè≤Ôºö</span><div class="mt-1 p-2 bg-gray-50 rounded text-sm">${patient.history}</div></div>` : ''}
                        <div><span class="font-medium">Âª∫Ê™îÊó•ÊúüÔºö</span>${patient.createdAt ? new Date(patient.createdAt.seconds * 1000).toLocaleDateString('zh-TW') : 'Êú™Áü•'}</div>
                        ${patient.updatedAt ? `<div><span class="font-medium">Êõ¥Êñ∞Êó•ÊúüÔºö</span>${new Date(patient.updatedAt.seconds * 1000).toLocaleDateString('zh-TW')}</div>` : ''}
                    </div>
                </div>
            </div>
            
            <!-- Ë®∫ÁóáË®òÈåÑÊëòË¶Å -->
            <div class="mt-6 pt-6 border-t border-gray-200">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-lg font-semibold text-gray-800">Ë®∫ÁóáË®òÈåÑÊëòË¶Å</h4>
                </div>
                
<div id="patientConsultationSummary">
    <div class="text-center py-4">
        <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-gray-900"></div>
        <div class="mt-2 text-sm">ËºâÂÖ•Ë®∫ÁóáË®òÈåÑ‰∏≠...</div>
    </div>
</div>
            </div>
        `;

                // ËºâÂÖ•Ë®∫ÁóáË®òÈåÑÊëòË¶Å
        loadPatientConsultationSummary(id);
        
        document.getElementById('patientDetailContent').innerHTML = content;
        document.getElementById('patientDetailModal').classList.remove('hidden');

    } catch (error) {
        console.error('Êü•ÁúãÁóÖ‰∫∫Ë≥áÊñôÈåØË™§:', error);
        showToast('ËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñôÂ§±Êïó', 'error');
    }
}

        function closePatientDetail() {
            document.getElementById('patientDetailModal').classList.add('hidden');
        }





        // ÊêúÂ∞ãÂäüËÉΩ
        document.addEventListener('DOMContentLoaded', function() {
            // Â•óÁ•®Ê¨Ñ‰ΩçÂàáÊèõ
            const categorySelect = document.getElementById('billingItemCategory');
            if (categorySelect) {
                categorySelect.addEventListener('change', function () {
                    const isPackage = this.value === 'package';
                    const pf = document.getElementById('packageFields');
                    if (pf) pf.classList.toggle('hidden', !isPackage);
                });
            }
            const searchInput = document.getElementById('searchPatient');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    loadPatientList();
                });
            }
        });

        // Ë®∫ÁóáÁ≥ªÁµ±ÂäüËÉΩ
        let selectedPatientForRegistration = null;
        let currentConsultingAppointmentId = null;
        
        function loadConsultationSystem() {
            loadTodayAppointments();
            clearPatientSearch();
        }
        
// 1. ‰øÆÊîπÁóÖ‰∫∫ÊêúÂ∞ãÂáΩÊï∏ÔºåÊîπÁÇ∫Âæû Firebase ËÆÄÂèñË≥áÊñô
async function searchPatientsForRegistration() {
    const searchTerm = document.getElementById('patientSearchInput').value.trim().toLowerCase();
    const resultsContainer = document.getElementById('patientSearchResults');
    const resultsList = document.getElementById('searchResultsList');
    
    if (searchTerm.length < 1) {
        resultsContainer.classList.add('hidden');
        return;
    }
    
    // È°ØÁ§∫ËºâÂÖ•‰∏≠
    resultsList.innerHTML = `
        <div class="p-4 text-center text-gray-500">
            <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-gray-900"></div>
            <div class="mt-2">ÊêúÂ∞ã‰∏≠...</div>
        </div>
    `;
    resultsContainer.classList.remove('hidden');
    
    try {
        // Âæû Firebase Áç≤ÂèñÁóÖ‰∫∫Ë≥áÊñô
        const result = await window.firebaseDataManager.getPatients();
        
        if (!result.success) {
            resultsList.innerHTML = `
                <div class="p-4 text-center text-red-500">
                    ËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñôÂ§±ÊïóÔºåË´ãÈáçË©¶
                </div>
            `;
            return;
        }
        
        // ÊêúÁ¥¢ÂåπÈÖçÁöÑÁóÖ‰∫∫
        const matchedPatients = result.data.filter(patient => 
            patient.name.toLowerCase().includes(searchTerm) ||
            patient.phone.includes(searchTerm) ||
            (patient.patientNumber && patient.patientNumber.toLowerCase().includes(searchTerm))
        );
        
        if (matchedPatients.length === 0) {
            resultsList.innerHTML = `
                <div class="p-4 text-center text-gray-500">
                    Êâæ‰∏çÂà∞Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑÁóÖ‰∫∫
                </div>
            `;
            resultsContainer.classList.remove('hidden');
            return;
        }
        
        // È°ØÁ§∫ÊêúÁ¥¢ÁµêÊûú
        resultsList.innerHTML = matchedPatients.map(patient => `
            <div class="p-4 hover:bg-gray-50 cursor-pointer transition duration-200" onclick="selectPatientForRegistration('${patient.id}')">
                <div>
                    <div class="font-semibold text-gray-900">${patient.name}</div>
                    <div class="text-sm text-gray-600">Á∑®ËôüÔºö${patient.patientNumber} | Âπ¥ÈΩ°Ôºö${formatAge(patient.birthDate)} | ÊÄßÂà•Ôºö${patient.gender}</div>
                    <div class="text-sm text-gray-500">ÈõªË©±Ôºö${patient.phone}</div>
                </div>
            </div>
        `).join('');
        
        resultsContainer.classList.remove('hidden');
        
    } catch (error) {
        console.error('ÊêúÂ∞ãÁóÖ‰∫∫Ë≥áÊñôÈåØË™§:', error);
        resultsList.innerHTML = `
            <div class="p-4 text-center text-red-500">
                ÊêúÂ∞ãÂ§±ÊïóÔºåË´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Êé•
            </div>
        `;
    }
}
        
// 2. ‰øÆÊîπÈÅ∏ÊìáÁóÖ‰∫∫ÈÄ≤Ë°åÊéõËôüÂáΩÊï∏
async function selectPatientForRegistration(patientId) {
    // Ê™¢Êü•ÊòØÂê¶ÊúâÁóÖ‰∫∫Ê≠£Âú®Ë®∫Áóá‰∏≠
    const consultingAppointment = appointments.find(apt => 
        apt.status === 'consulting' && 
        new Date(apt.appointmentTime).toDateString() === new Date().toDateString()
    );
    
    if (consultingAppointment) {
        try {
            // Âæû Firebase Áç≤ÂèñÊ≠£Âú®Ë®∫ÁóáÁöÑÁóÖ‰∫∫Ë≥áÊñô
            const result = await window.firebaseDataManager.getPatients();
            if (result.success) {
                const consultingPatient = result.data.find(p => p.id === consultingAppointment.patientId);
                const consultingPatientName = consultingPatient ? consultingPatient.name : 'Êüê‰ΩçÁóÖ‰∫∫';
                showToast(`ÁÑ°Ê≥ïÈÄ≤Ë°åÊéõËôüÔºÅ${consultingPatientName}Ê≠£Âú®Ë®∫Áóá‰∏≠ÔºåË´ãÁ≠âÂæÖË®∫ÁóáÂÆåÊàêÂæåÂÜçÈÄ≤Ë°åÊéõËôüÊìç‰Ωú„ÄÇ`, 'warning');
                return;
            }
        } catch (error) {
            console.error('Ê™¢Êü•Ë®∫ÁóáÁãÄÊÖãÈåØË™§:', error);
        }
    }
    
    try {
        // Âæû Firebase Áç≤ÂèñÁóÖ‰∫∫Ë≥áÊñô
        const result = await window.firebaseDataManager.getPatients();
        if (!result.success) {
            showToast('ËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñôÂ§±Êïó', 'error');
            return;
        }
        
        const patient = result.data.find(p => p.id === patientId);
        if (!patient) {
            showToast('Êâæ‰∏çÂà∞ÁóÖ‰∫∫Ë≥áÊñô', 'error');
            return;
        }
        
        selectedPatientForRegistration = patient;
        showRegistrationModal(patient);
        
    } catch (error) {
        console.error('ÈÅ∏ÊìáÁóÖ‰∫∫Ë≥áÊñôÈåØË™§:', error);
        showToast('ËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñôÂ§±Êïó', 'error');
    }
}
        
        // Ê∏ÖÈô§ÁóÖ‰∫∫ÊêúÁ¥¢
        function clearPatientSearch() {
            document.getElementById('patientSearchInput').value = '';
            document.getElementById('patientSearchResults').classList.add('hidden');
            selectedPatientForRegistration = null;
        }
        

        
        // È°ØÁ§∫ÊéõËôüÂΩàÁ™ó
        function showRegistrationModal(patient) {
            if (!patient) return;
            
            // È°ØÁ§∫ÈÅ∏‰∏≠ÁöÑÁóÖ‰∫∫Ë≥áË®ä
            document.getElementById('selectedPatientInfo').innerHTML = `
                <div class="space-y-1">
                    <div><span class="font-medium">ÂßìÂêçÔºö</span>${patient.name}</div>
                    <div><span class="font-medium">Á∑®ËôüÔºö</span>${patient.patientNumber}</div>
                    <div><span class="font-medium">Âπ¥ÈΩ°Ôºö</span>${formatAge(patient.birthDate)} | <span class="font-medium">ÊÄßÂà•Ôºö</span>${patient.gender}</div>
                    <div><span class="font-medium">ÈõªË©±Ôºö</span>${patient.phone}</div>
                </div>
            `;
            
            // ËºâÂÖ•ÈÜ´Â∏´ÈÅ∏È†Ö
            loadDoctorOptions();
            
            // Ë®≠ÁΩÆÈ†êË®≠ÊéõËôüÊôÇÈñìÁÇ∫Áï∂ÂâçÊôÇÈñìÔºàÂä†5ÂàÜÈêòÈÅøÂÖçÊôÇÈñìÈÅéÊúüÔºâ
            const now = new Date();
            now.setMinutes(now.getMinutes() + 5); // Âä†5ÂàÜÈêò
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const localDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
            
            document.getElementById('appointmentDateTime').value = localDateTime;
            
            clearRegistrationForm();
            document.getElementById('registrationModal').classList.remove('hidden');
        }
        
        // ËºâÂÖ•ÈÜ´Â∏´ÈÅ∏È†Ö
        function loadDoctorOptions() {
            const doctorSelect = document.getElementById('appointmentDoctor');
            
            // Áç≤ÂèñÊâÄÊúâÂïüÁî®ÁöÑÈÜ´Â∏´Áî®Êà∂
            const doctors = users.filter(user => 
                user.active && user.position === 'ÈÜ´Â∏´'
            );
            
            // Ê∏ÖÁ©∫ÁèæÊúâÈÅ∏È†ÖÔºà‰øùÁïôÈ†êË®≠ÈÅ∏È†ÖÔºâ
            doctorSelect.innerHTML = '<option value="">Ë´ãÈÅ∏ÊìáÈÜ´Â∏´</option>';
            
            // Ê∑ªÂä†ÈÜ´Â∏´ÈÅ∏È†Ö
            doctors.forEach(doctor => {
                const option = document.createElement('option');
                option.value = doctor.username;
                option.textContent = `${doctor.name}ÈÜ´Â∏´`;
                if (doctor.registrationNumber) {
                    option.textContent += ` (${doctor.registrationNumber})`;
                }
                doctorSelect.appendChild(option);
            });
            
            // Â¶ÇÊûúÁï∂ÂâçÁî®Êà∂ÊòØÈÜ´Â∏´ÔºåÈ†êË®≠ÈÅ∏ÊìáËá™Â∑±
            if (currentUserData && currentUserData.position === 'ÈÜ´Â∏´') {
                doctorSelect.value = currentUserData.username;
            }
        }
        
        // ÈóúÈñâÊéõËôüÂΩàÁ™ó
        function closeRegistrationModal() {
            document.getElementById('registrationModal').classList.add('hidden');
            clearRegistrationForm();
            selectedPatientForRegistration = null;
        }
        
        // Ê∏ÖÁ©∫ÊéõËôüË°®ÂñÆ
        function clearRegistrationForm() {
            document.getElementById('appointmentDoctor').value = '';
            document.getElementById('quickChiefComplaint').value = '';
        }
        
        // Á¢∫Ë™çÊéõËôü
        function confirmRegistration() {
            if (!selectedPatientForRegistration) {
                showToast('Á≥ªÁµ±ÈåØË™§ÔºöÊú™ÈÅ∏ÊìáÁóÖ‰∫∫ÔºÅ', 'error');
                return;
            }
            
            const appointmentDateTime = document.getElementById('appointmentDateTime').value;
            const appointmentDoctor = document.getElementById('appointmentDoctor').value;
            const chiefComplaint = document.getElementById('quickChiefComplaint').value.trim();
            
            if (!appointmentDateTime) {
                showToast('Ë´ãÈÅ∏ÊìáÊéõËôüÊôÇÈñìÔºÅ', 'error');
                return;
            }
            
            if (!appointmentDoctor) {
                showToast('Ë´ãÈÅ∏ÊìáÊéõËôüÈÜ´Â∏´ÔºÅ', 'error');
                return;
            }
            
            // È©óË≠âÈÅ∏ÊìáÁöÑÈÜ´Â∏´ÊòØÂê¶Â≠òÂú®‰∏îÂïüÁî®
            const selectedDoctor = users.find(user => 
                user.username === appointmentDoctor && 
                user.active && 
                user.position === 'ÈÜ´Â∏´'
            );
            
            if (!selectedDoctor) {
                showToast('ÈÅ∏ÊìáÁöÑÈÜ´Â∏´ÁÑ°ÊïàÔºåË´ãÈáçÊñ∞ÈÅ∏ÊìáÔºÅ', 'error');
                return;
            }
            
            // È©óË≠âÊéõËôüÊôÇÈñì‰∏çËÉΩÊòØÈÅéÂéªÊôÇÈñìÔºàÂÖÅË®±1ÂàÜÈêòÁöÑË™§Â∑ÆÔºâ
            const selectedTime = new Date(appointmentDateTime);
            const now = new Date();
            now.setMinutes(now.getMinutes() - 1); // ÂÖÅË®±1ÂàÜÈêòË™§Â∑Æ
            if (selectedTime < now) {
                showToast('ÊéõËôüÊôÇÈñì‰∏çËÉΩÊó©ÊñºÁèæÂú®ÊôÇÈñìÔºÅ', 'error');
                return;
            }
            
            const appointment = {
                id: Date.now(),
                patientId: selectedPatientForRegistration.id,
                appointmentTime: selectedTime.toISOString(),
                appointmentDoctor: appointmentDoctor,
                chiefComplaint: chiefComplaint || 'ÁÑ°ÁâπÊÆä‰∏ªË®¥',
                status: 'registered', // registered, waiting, consulting, completed
                createdAt: new Date().toISOString(),
                createdBy: currentUserData ? currentUserData.username : currentUser
            };
            
            appointments.push(appointment);
            localStorage.setItem('appointments', JSON.stringify(appointments));
            
            showToast(`${selectedPatientForRegistration.name} Â∑≤ÊéõËôüÁµ¶ ${selectedDoctor.name}ÈÜ´Â∏´ÔºÅ`, 'success');
            
            closeRegistrationModal();
            clearPatientSearch();
            loadTodayAppointments();
        }
        
        // ÊØèÊó•Ëá™ÂãïÊ∏ÖÁ©∫ÊéõËôüÂàóË°®
        function clearOldAppointments() {
            const today = new Date().toDateString();
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayString = yesterday.toDateString();
            
            // ÁßªÈô§Êò®Â§©ÂèäÊõ¥Êó©ÁöÑÊéõËôüË®òÈåÑ
            const originalLength = appointments.length;
            appointments = appointments.filter(apt => {
                const appointmentDate = new Date(apt.appointmentTime).toDateString();
                return appointmentDate >= today; // Âè™‰øùÁïô‰ªäÂ§©Âèä‰ª•ÂæåÁöÑÊéõËôü
            });
            
            // Â¶ÇÊûúÊúâÊ∏ÖÈô§Ë®òÈåÑÔºå‰øùÂ≠òÂà∞Êú¨Âú∞ÂÑ≤Â≠ò
            if (appointments.length < originalLength) {
                localStorage.setItem('appointments', JSON.stringify(appointments));
                console.log(`Â∑≤Ê∏ÖÈô§ ${originalLength - appointments.length} Á≠ÜÈÅéÊúüÊéõËôüË®òÈåÑ`);
            }
        }

// 3. ‰øÆÊîπ‰ªäÊó•ÊéõËôüÂàóË°®ËºâÂÖ•ÂäüËÉΩÔºåÁ¢∫‰øùËÉΩÊ≠£Á¢∫È°ØÁ§∫ÁóÖ‰∫∫Ë≥áË®ä
async function loadTodayAppointments() {
    // ÂÖàÊ∏ÖÁ©∫ÈÅéÊúüÊéõËôü
    clearOldAppointments();
    
    const today = new Date().toDateString();
    let todayAppointments = appointments.filter(apt => 
        new Date(apt.appointmentTime).toDateString() === today
    );
    
    // Â¶ÇÊûúÁï∂ÂâçÁî®Êà∂ÊòØÈÜ´Â∏´ÔºåÂè™È°ØÁ§∫ÊéõÁµ¶Ëá™Â∑±ÁöÑÁóÖ‰∫∫
    if (currentUserData && currentUserData.position === 'ÈÜ´Â∏´') {
        todayAppointments = todayAppointments.filter(apt => 
            apt.appointmentDoctor === currentUserData.username
        );
    }
    
    // ÊåâÊôÇÈñìÊéíÂ∫è
    todayAppointments.sort((a, b) => new Date(a.appointmentTime) - new Date(b.appointmentTime));
    
    const tbody = document.getElementById('todayAppointmentsList');
    document.getElementById('todayTotal').textContent = todayAppointments.length;
    
    if (todayAppointments.length === 0) {
        const message = currentUserData && currentUserData.position === 'ÈÜ´Â∏´' 
            ? '‰ªäÊó•Êö´ÁÑ°ÊéõÁµ¶ÊÇ®ÁöÑÁóÖ‰∫∫' 
            : '‰ªäÊó•Êö´ÁÑ°ÊéõËôüË®òÈåÑ';
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                    ${message}
                </td>
            </tr>
        `;
        return;
    }
    
    try {
        // Âæû Firebase Áç≤ÂèñÊâÄÊúâÁóÖ‰∫∫Ë≥áÊñô
        const result = await window.firebaseDataManager.getPatients();
        const patientsData = result.success ? result.data : [];
        
        tbody.innerHTML = todayAppointments.map((appointment, index) => {
            // Âæû Firebase Ë≥áÊñô‰∏≠Â∞ãÊâæÂ∞çÊáâÁóÖ‰∫∫
            const patient = patientsData.find(p => p.id === appointment.patientId);
            
            if (!patient) {
                // Â¶ÇÊûúÂú® Firebase Êâæ‰∏çÂà∞ÔºåÂòóË©¶ÂæûÊú¨Âú∞Èô£ÂàóÊâæÔºàÂêëÂæåÂÖºÂÆπÔºâ
                const localPatient = patients.find(p => p.id === appointment.patientId);
                if (!localPatient) {
                    return `
                        <tr class="hover:bg-gray-50">
                            <td colspan="7" class="px-4 py-3 text-center text-red-500">
                                Êâæ‰∏çÂà∞ÁóÖ‰∫∫Ë≥áÊñô (ID: ${appointment.patientId})
                            </td>
                        </tr>
                    `;
                }
                // ‰ΩøÁî®Êú¨Âú∞ÁóÖ‰∫∫Ë≥áÊñô
                return createAppointmentRow(appointment, localPatient, index);
            }
            
            // ‰ΩøÁî® Firebase ÁóÖ‰∫∫Ë≥áÊñô
            return createAppointmentRow(appointment, patient, index);
        }).join('');
        
    } catch (error) {
        console.error('ËºâÂÖ•ÊéõËôüÂàóË°®ÈåØË™§:', error);
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="px-4 py-8 text-center text-red-500">
                    ËºâÂÖ•ÊéõËôüÂàóË°®Â§±ÊïóÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢
                </td>
            </tr>
        `;
    }
}

// 1. ‰øÆÊîπ createAppointmentRow ÂáΩÊï∏ÔºåÁ¢∫‰øùË®∫ÁóáË®òÈåÑÊåâÈàïÊ≠£Á¢∫ÂÇ≥ÈÅû patientId
function createAppointmentRow(appointment, patient, index) {
    // Áç≤ÂèñÊéõËôüÈÜ´Â∏´Ë≥áË®ä
    const appointmentDoctor = users.find(u => u.username === appointment.appointmentDoctor);
    const doctorName = appointmentDoctor ? `${appointmentDoctor.name}ÈÜ´Â∏´` : 'Êú™ÊåáÂÆöÈÜ´Â∏´';
    
    const statusInfo = getStatusInfo(appointment.status);
    const operationButtons = getOperationButtons(appointment, patient); // ÂÇ≥ÈÅû patient ÂèÉÊï∏
    
    return `
        <tr class="hover:bg-gray-50">
            <td class="px-4 py-3 text-sm text-gray-900 font-medium">${index + 1}</td>
            <td class="px-4 py-3 text-sm font-medium text-gray-900">
                ${patient.name}
                <div class="text-xs text-gray-500">${patient.patientNumber}</div>
            </td>
            <td class="px-4 py-3 text-sm text-gray-900">
                <div class="font-medium text-blue-600">${doctorName}</div>
            </td>
            <td class="px-4 py-3 text-sm text-gray-900">
                ${new Date(appointment.appointmentTime).toLocaleString('zh-TW', {
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                })}
            </td>
            <td class="px-4 py-3 text-sm text-gray-900">
                <div class="max-w-xs truncate" title="${appointment.chiefComplaint || 'ÁÑ°'}">
                    ${appointment.chiefComplaint || 'ÁÑ°'}
                </div>
            </td>
            <td class="px-4 py-3">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusInfo.class}">
                    ${statusInfo.text}
                </span>
            </td>
            <td class="px-4 py-3 text-sm">
                <div class="flex flex-wrap gap-1">
                    ${operationButtons}
                </div>
            </td>
        </tr>
    `;
}
        
        // Áç≤ÂèñÁãÄÊÖãË≥áË®ä
        function getStatusInfo(status) {
            const statusMap = {
                'registered': { text: 'Â∑≤ÊéõËôü', class: 'bg-blue-100 text-blue-800' },
                'waiting': { text: 'ÂÄôË®∫‰∏≠', class: 'bg-yellow-100 text-yellow-800' },
                'consulting': { text: 'Ë®∫Áóá‰∏≠', class: 'bg-green-100 text-green-800' },
                'completed': { text: 'Â∑≤ÂÆåÊàê', class: 'bg-gray-100 text-gray-800' }
            };
            return statusMap[status] || { text: 'Êú™Áü•', class: 'bg-gray-100 text-gray-800' };
        }
        
// 2. ‰øÆÊîπ getOperationButtons ÂáΩÊï∏ÔºåÁ¢∫‰øù‰ΩøÁî®Ê≠£Á¢∫ÁöÑ patientId
function getOperationButtons(appointment, patient = null) {
    const buttons = [];
    
    // Ê™¢Êü•ÊòØÂê¶ÊúâÁóÖ‰∫∫Ê≠£Âú®Ë®∫Áóá‰∏≠
    const isAnyoneConsulting = appointments.some(apt => 
        apt.status === 'consulting' && 
        new Date(apt.appointmentTime).toDateString() === new Date().toDateString()
    );
    
    const isCurrentConsulting = appointment.status === 'consulting';
    
    // Ê™¢Êü•Áï∂ÂâçÁî®Êà∂ÊòØÂê¶ÁÇ∫Ë©≤ÊéõËôüÁöÑÈÜ´Â∏´
    const isAppointmentDoctor = currentUserData && 
        currentUserData.position === 'ÈÜ´Â∏´' && 
        appointment.appointmentDoctor === currentUserData.username;
    
    // Ê™¢Êü•Áï∂ÂâçÁî®Êà∂ÊòØÂê¶ÁÇ∫ÁÆ°ÁêÜÂì°ÊàñË≠∑ÁêÜÂ∏´ÔºàÂèØ‰ª•ÈÄ≤Ë°åÁÆ°ÁêÜÊìç‰ΩúÔºâ
    const canManage = currentUserData && 
        (currentUserData.position === 'Ë®∫ÊâÄÁÆ°ÁêÜ' || currentUserData.position === 'Ë≠∑ÁêÜÂ∏´');
    
    // Ê™¢Êü•Áï∂ÂâçÁî®Êà∂ÊòØÂê¶ÂèØ‰ª•Á¢∫Ë™çÂà∞ÈÅîÔºàÁÆ°ÁêÜÂì°„ÄÅË≠∑ÁêÜÂ∏´ÊàñË©≤ÊéõËôüÁöÑÈÜ´Â∏´Ôºâ
    const canConfirmArrival = canManage || isAppointmentDoctor;
    
    // ‰ΩøÁî®Ê≠£Á¢∫ÁöÑ patientIdÔºàÂÑ™ÂÖà‰ΩøÁî® Firebase IDÔºâ
    const patientId = patient ? patient.id : appointment.patientId;
    
    // ÊâÄÊúâÁãÄÊÖãÈÉΩÂèØ‰ª•Êü•ÁúãË®∫ÁóáË®òÈåÑ
    buttons.push(`<button onclick="viewPatientMedicalHistory('${patientId}')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs transition duration-200">Ë®∫ÁóáË®òÈåÑ</button>`);
    
    // Â¶ÇÊûúÊúâ‰∫∫Âú®Ë®∫Áóá‰∏≠‰∏î‰∏çÊòØÁï∂ÂâçÁóÖ‰∫∫ÔºåÂâáÂÖ∂‰ªñÊìç‰ΩúÈÉΩË¢´Á¶ÅÁî®
    const isDisabled = isAnyoneConsulting && !isCurrentConsulting;
    let disabledTooltip = '';
    if (isDisabled) {
        const consultingAppointment = appointments.find(apt => 
            apt.status === 'consulting' && 
            new Date(apt.appointmentTime).toDateString() === new Date().toDateString()
        );
        disabledTooltip = `title="ÊúâÁóÖ‰∫∫Ê≠£Âú®Ë®∫Áóá‰∏≠ÔºåÊìç‰ΩúÊö´ÊôÇÁ¶ÅÁî®"`;
    }
    
    switch (appointment.status) {
        case 'registered':
            if (isDisabled) {
                if (canConfirmArrival) {
                    buttons.push(`<span class="bg-gray-300 text-gray-500 px-2 py-1 rounded text-xs cursor-not-allowed" ${disabledTooltip}>Á¢∫Ë™çÂà∞ÈÅî</span>`);
                }
                if (canManage) {
                    buttons.push(`<span class="bg-gray-300 text-gray-500 px-2 py-1 rounded text-xs cursor-not-allowed" ${disabledTooltip}>ÁßªÈô§ÊéõËôü</span>`);
                }
            } else {
                if (canConfirmArrival) {
                    buttons.push(`<button onclick="confirmPatientArrival(${appointment.id})" class="bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded text-xs transition duration-200">Á¢∫Ë™çÂà∞ÈÅî</button>`);
                }
                if (canManage) {
                    buttons.push(`<button onclick="removeAppointment(${appointment.id})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition duration-200">ÁßªÈô§ÊéõËôü</button>`);
                }
            }
            break;
            
        case 'waiting':
            if (isDisabled) {
                if (isAppointmentDoctor) {
                    buttons.push(`<span class="bg-gray-300 text-gray-500 px-2 py-1 rounded text-xs cursor-not-allowed" ${disabledTooltip}>ÈñãÂßãË®∫Áóá</span>`);
                }
            } else {
                if (isAppointmentDoctor) {
                    buttons.push(`<button onclick="startConsultation(${appointment.id})" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs transition duration-200">ÈñãÂßãË®∫Áóá</button>`);
                }
            }
            break;
            
        case 'consulting':
            if (isAppointmentDoctor) {
                buttons.push(`<button onclick="continueConsultation(${appointment.id})" class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-xs transition duration-200">ÁπºÁ∫åË®∫Áóá</button>`);
            }
            break;
            
        case 'completed':
            // ÂàóÂç∞Êî∂ÊìöÂäüËÉΩ‰∏çÂèóË®∫ÁóáÁãÄÊÖãÈôêÂà∂
            buttons.push(`<button onclick="printReceiptFromAppointment(${appointment.id})" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs transition duration-200">ÂàóÂç∞Êî∂Êìö</button>`);
            buttons.push(`<button onclick="printAttendanceCertificateFromAppointment(${appointment.id})" class="bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-xs transition duration-200">Âà∞Ë®∫Ë≠âÊòé</button>`);
            buttons.push(`<button onclick="printSickLeaveFromAppointment(${appointment.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs transition duration-200">ÁóÖÂÅáË≠âÊòé</button>`);
            
            if (isDisabled) {
                if (isAppointmentDoctor) {
                    buttons.push(`<span class="bg-gray-300 text-gray-500 px-2 py-1 rounded text-xs cursor-not-allowed" ${disabledTooltip}>‰øÆÊîπÁóÖÊ≠∑</span>`);
                }
                if (canManage) {
                    buttons.push(`<span class="bg-gray-300 text-gray-500 px-2 py-1 rounded text-xs cursor-not-allowed" ${disabledTooltip}>Êí§ÂõûË®∫Áóá</span>`);
                }
            } else {
                if (isAppointmentDoctor) {
                    buttons.push(`<button onclick="editMedicalRecord(${appointment.id})" class="bg-orange-500 hover:bg-orange-600 text-white px-2 py-1 rounded text-xs transition duration-200">‰øÆÊîπÁóÖÊ≠∑</button>`);
                }
                if (canManage) {
                    buttons.push(`<button onclick="withdrawConsultation(${appointment.id})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition duration-200">Êí§ÂõûË®∫Áóá</button>`);
                }
            }
            break;
            
        default:
            buttons.push('<span class="text-gray-400 text-xs">ÁãÄÊÖãÁï∞Â∏∏</span>');
            break;
    }
    
    return buttons.join('');
}

        
// 3. ‰øÆÊîπÁ¢∫Ë™çÁóÖ‰∫∫Âà∞ÈÅîÂáΩÊï∏ÔºåÊîØÊè¥ Firebase
async function confirmPatientArrival(appointmentId) {
    const appointment = appointments.find(apt => apt.id === appointmentId);
    if (!appointment) {
        showToast('Êâæ‰∏çÂà∞ÊéõËôüË®òÈåÑÔºÅ', 'error');
        return;
    }
    
    try {
        // Âæû Firebase Áç≤ÂèñÁóÖ‰∫∫Ë≥áÊñô
        const result = await window.firebaseDataManager.getPatients();
        if (!result.success) {
            showToast('ÁÑ°Ê≥ïËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
            return;
        }
        
        const patient = result.data.find(p => p.id === appointment.patientId);
        if (!patient) {
            showToast('Êâæ‰∏çÂà∞ÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
            return;
        }
        
        // Ë©≥Á¥∞ÁãÄÊÖãÊ™¢Êü•
        console.log(`Á¢∫Ë™çÂà∞ÈÅîÁãÄÊÖãÊ™¢Êü• - ÁóÖ‰∫∫: ${patient.name}, Áï∂ÂâçÁãÄÊÖã: ${appointment.status}`);
        
        // Âè™ÊúâÂ∑≤ÊéõËôüÁãÄÊÖãÊâçËÉΩÁ¢∫Ë™çÂà∞ÈÅî
        if (appointment.status !== 'registered') {
            const statusNames = {
                'waiting': 'ÂÄôË®∫‰∏≠',
                'consulting': 'Ë®∫Áóá‰∏≠',
                'completed': 'Â∑≤ÂÆåÊàê'
            };
            const currentStatusName = statusNames[appointment.status] || appointment.status;
            showToast(`ÁÑ°Ê≥ïÁ¢∫Ë™çÂà∞ÈÅîÔºÅÁóÖ‰∫∫ ${patient.name} ÁõÆÂâçÁãÄÊÖãÁÇ∫„Äå${currentStatusName}„ÄçÔºåÂè™ËÉΩÂ∞ç„ÄåÂ∑≤ÊéõËôü„ÄçÁöÑÁóÖ‰∫∫Á¢∫Ë™çÂà∞ÈÅî„ÄÇ`, 'warning');
            return;
        }
        
        // Êõ¥Êñ∞ÁãÄÊÖãÁÇ∫ÂÄôË®∫‰∏≠
        appointment.status = 'waiting';
        appointment.arrivedAt = new Date().toISOString();
        appointment.confirmedBy = currentUserData ? currentUserData.username : currentUser;
        
        // ‰øùÂ≠òÁãÄÊÖãËÆäÊõ¥
        localStorage.setItem('appointments', JSON.stringify(appointments));
        
        showToast(`${patient.name} Â∑≤Á¢∫Ë™çÂà∞ÈÅîÔºåÈÄ≤ÂÖ•ÂÄôË®∫ÁãÄÊÖãÔºÅ`, 'success');
        loadTodayAppointments();
        
    } catch (error) {
        console.error('Á¢∫Ë™çÂà∞ÈÅîÈåØË™§:', error);
        showToast('ËôïÁêÜÁ¢∫Ë™çÂà∞ÈÅîÊôÇÁôºÁîüÈåØË™§', 'error');
    }
}

        
 // 5. ‰øÆÊîπÁßªÈô§ÊéõËôüÂáΩÊï∏ÔºåÊîØÊè¥ Firebase
async function removeAppointment(appointmentId) {
    const appointment = appointments.find(apt => apt.id === appointmentId);
    if (!appointment) {
        showToast('Êâæ‰∏çÂà∞ÊéõËôüË®òÈåÑÔºÅ', 'error');
        return;
    }
    
    try {
        // Âæû Firebase Áç≤ÂèñÁóÖ‰∫∫Ë≥áÊñô
        const result = await window.firebaseDataManager.getPatients();
        if (!result.success) {
            showToast('ÁÑ°Ê≥ïËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
            return;
        }
        
        const patient = result.data.find(p => p.id === appointment.patientId);
        if (!patient) {
            showToast('Êâæ‰∏çÂà∞ÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
            return;
        }
        
        // Ë©≥Á¥∞ÁãÄÊÖãÊ™¢Êü•
        console.log(`ÁßªÈô§ÊéõËôüÁãÄÊÖãÊ™¢Êü• - ÁóÖ‰∫∫: ${patient.name}, Áï∂ÂâçÁãÄÊÖã: ${appointment.status}`);
        
        // Ê™¢Êü•ÊòØÂê¶ÂèØ‰ª•ÁßªÈô§
        if (appointment.status === 'waiting') {
            showToast(`ÁÑ°Ê≥ïÁßªÈô§ÊéõËôüÔºÅÁóÖ‰∫∫ ${patient.name} Â∑≤Á¢∫Ë™çÂà∞ÈÅîÂÄôË®∫‰∏≠ÔºåË´ãËÅØÁπ´ÈÜ´Â∏´ËôïÁêÜ„ÄÇ`, 'warning');
            return;
        }
        
        if (appointment.status === 'consulting') {
            showToast(`ÁÑ°Ê≥ïÁßªÈô§ÊéõËôüÔºÅÁóÖ‰∫∫ ${patient.name} ÁõÆÂâçÊ≠£Âú®Ë®∫Áóá‰∏≠ÔºåË´ãÂÖàÁµêÊùüË®∫ÁóáÂæåÂÜçÁßªÈô§„ÄÇ`, 'warning');
            return;
        }
        
        if (appointment.status === 'completed') {
            showToast(`ÁÑ°Ê≥ïÁßªÈô§ÊéõËôüÔºÅÁóÖ‰∫∫ ${patient.name} Â∑≤ÂÆåÊàêË®∫ÁóáÔºåÂ∑≤ÂÆåÊàêÁöÑË®òÈåÑÁÑ°Ê≥ïÁßªÈô§„ÄÇ`, 'warning');
            return;
        }
        
        // Á¢∫Ë™çÁßªÈô§
        const statusNames = {
            'registered': 'Â∑≤ÊéõËôü',
            'waiting': 'ÂÄôË®∫‰∏≠'
        };
        const statusText = statusNames[appointment.status] || appointment.status;
        
        const confirmMessage = `Á¢∫ÂÆöË¶ÅÁßªÈô§ ${patient.name} ÁöÑÊéõËôüÂóéÔºü\n\n` +
                             `ÁãÄÊÖãÔºö${statusText}\n` +
                             `ÊéõËôüÊôÇÈñìÔºö${new Date(appointment.appointmentTime).toLocaleString('zh-TW')}\n\n` +
                             `Ê≥®ÊÑèÔºöÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ`;
        
        if (confirm(confirmMessage)) {
            // ÂæûÊéõËôüÂàóË°®‰∏≠ÁßªÈô§
            appointments = appointments.filter(apt => apt.id !== appointmentId);
            localStorage.setItem('appointments', JSON.stringify(appointments));
            
            showToast(`Â∑≤ÁßªÈô§ ${patient.name} ÁöÑÊéõËôüË®òÈåÑ`, 'success');
            loadTodayAppointments();
            
            // Â¶ÇÊûúÊ≠£Âú®Ë®∫ÁóáË°®ÂñÆ‰∏≠È°ØÁ§∫Ë©≤ÁóÖ‰∫∫ÔºåÂâáÈóúÈñâË°®ÂñÆ
            if (currentConsultingAppointmentId === appointmentId) {
                closeConsultationForm();
                currentConsultingAppointmentId = null;
            }
        }
        
    } catch (error) {
        console.error('ÁßªÈô§ÊéõËôüÈåØË™§:', error);
        showToast('ÁßªÈô§ÊéõËôüÊôÇÁôºÁîüÈåØË™§', 'error');
    }
}

        

        
 // 4. ‰øÆÊîπÈñãÂßãË®∫ÁóáÂáΩÊï∏ÔºåÊîØÊè¥ Firebase
async function startConsultation(appointmentId) {
    const appointment = appointments.find(apt => apt.id === appointmentId);
    if (!appointment) {
        showToast('Êâæ‰∏çÂà∞ÊéõËôüË®òÈåÑÔºÅ', 'error');
        return;
    }
    
    try {
        // Âæû Firebase Áç≤ÂèñÁóÖ‰∫∫Ë≥áÊñô
        const result = await window.firebaseDataManager.getPatients();
        if (!result.success) {
            showToast('ÁÑ°Ê≥ïËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
            return;
        }
        
        const patient = result.data.find(p => p.id === appointment.patientId);
        if (!patient) {
            showToast('Êâæ‰∏çÂà∞ÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
            return;
        }
        
        // Ê™¢Êü•Áï∂ÂâçÁî®Êà∂ÊòØÂê¶ÁÇ∫Ë©≤ÊéõËôüÁöÑÈÜ´Â∏´
        if (!currentUserData || currentUserData.position !== 'ÈÜ´Â∏´' || appointment.appointmentDoctor !== currentUserData.username) {
            showToast('Âè™ÊúâË©≤ÊéõËôüÁöÑÈÜ´Â∏´ÊâçËÉΩÈñãÂßãË®∫ÁóáÔºÅ', 'error');
            return;
        }
        
        // Ë©≥Á¥∞ÁãÄÊÖãÊ™¢Êü•
        console.log(`ÈñãÂßãË®∫ÁóáÁãÄÊÖãÊ™¢Êü• - ÁóÖ‰∫∫: ${patient.name}, Áï∂ÂâçÁãÄÊÖã: ${appointment.status}`);
        
        // Ê™¢Êü•ÁóÖ‰∫∫ÁãÄÊÖãÊòØÂê¶ÂÖÅË®±ÈñãÂßãË®∫Áóá
        if (!['waiting', 'registered'].includes(appointment.status)) {
            const statusNames = {
                'consulting': 'Ë®∫Áóá‰∏≠',
                'completed': 'Â∑≤ÂÆåÊàê'
            };
            const currentStatusName = statusNames[appointment.status] || appointment.status;
            showToast(`ÁÑ°Ê≥ïÈñãÂßãË®∫ÁóáÔºÅÁóÖ‰∫∫ ${patient.name} ÁõÆÂâçÁãÄÊÖãÁÇ∫„Äå${currentStatusName}„ÄçÔºåÂè™ËÉΩÂ∞ç„ÄåÂ∑≤ÊéõËôü„ÄçÊàñ„ÄåÂÄôË®∫‰∏≠„ÄçÁöÑÁóÖ‰∫∫ÈñãÂßãË®∫Áóá„ÄÇ`, 'error');
            return;
        }
        
        // Â¶ÇÊûúÊòØÂ∑≤ÊéõËôüÁãÄÊÖãÔºåËá™ÂãïÁ¢∫Ë™çÂà∞ÈÅî
        if (appointment.status === 'registered') {
            appointment.arrivedAt = new Date().toISOString();
            appointment.confirmedBy = currentUserData ? currentUserData.username : currentUser;
            showToast(`${patient.name} Â∑≤Ëá™ÂãïÁ¢∫Ë™çÂà∞ÈÅî`, 'info');
        }
        
        // Ê™¢Êü•ÊòØÂê¶Â∑≤ÊúâÂÖ∂‰ªñÁóÖ‰∫∫Âú®Ë®∫Áóá‰∏≠ÔºàÂè™Ê™¢Êü•Âêå‰∏ÄÈÜ´Â∏´ÁöÑÁóÖ‰∫∫Ôºâ
        const consultingAppointment = appointments.find(apt => 
            apt.status === 'consulting' && 
            apt.id !== appointmentId &&
            apt.appointmentDoctor === currentUserData.username &&
            new Date(apt.appointmentTime).toDateString() === new Date().toDateString()
        );
        
        if (consultingAppointment) {
            // Âæû Firebase Áç≤ÂèñÊ≠£Âú®Ë®∫ÁóáÁöÑÁóÖ‰∫∫Ë≥áÊñô
            const consultingPatient = result.data.find(p => p.id === consultingAppointment.patientId);
            const consultingPatientName = consultingPatient ? consultingPatient.name : 'Êú™Áü•ÁóÖ‰∫∫';
            
            if (confirm(`ÊÇ®ÁõÆÂâçÊ≠£Âú®ÁÇ∫ ${consultingPatientName} Ë®∫Áóá„ÄÇ\n\nÊòØÂê¶Ë¶ÅÁµêÊùüË©≤ÁóÖ‰∫∫ÁöÑË®∫Áóá‰∏¶ÈñãÂßãÁÇ∫ ${patient.name} Ë®∫ÁóáÔºü\n\nÊ≥®ÊÑèÔºö${consultingPatientName} ÁöÑÁãÄÊÖãÂ∞áÊîπÂõûÂÄôË®∫‰∏≠„ÄÇ`)) {
                // ÁµêÊùüÁï∂ÂâçË®∫ÁóáÁöÑÁóÖ‰∫∫
                consultingAppointment.status = 'waiting';
                delete consultingAppointment.consultationStartTime;
                delete consultingAppointment.consultingDoctor;
                
                // ÈóúÈñâÂèØËÉΩÈñãÂïüÁöÑË®∫ÁóáË°®ÂñÆ
                if (currentConsultingAppointmentId === consultingAppointment.id) {
                    closeConsultationForm();
                }
                
                showToast(`Â∑≤ÁµêÊùü ${consultingPatientName} ÁöÑË®∫Áóá`, 'info');
            } else {
                return; // Áî®Êà∂ÂèñÊ∂àÊìç‰Ωú
            }
        }
        
        // ÈñãÂßãÊñ∞ÁöÑË®∫Áóá - Ê≠£Á¢∫Ë®≠ÁΩÆÁãÄÊÖãÁÇ∫Ë®∫Áóá‰∏≠
        appointment.status = 'consulting';
        appointment.consultationStartTime = new Date().toISOString();
        appointment.consultingDoctor = currentUserData ? currentUserData.username : currentUser;
        
        // Á´ãÂç≥‰øùÂ≠òÁãÄÊÖãËÆäÊõ¥
        localStorage.setItem('appointments', JSON.stringify(appointments));
        
        // Ë®≠ÁΩÆÁï∂ÂâçË®∫ÁóáID‰∏¶È°ØÁ§∫Ë°®ÂñÆ
        currentConsultingAppointmentId = appointmentId;
        showConsultationForm(appointment);
        
        // ÈáçÊñ∞ËºâÂÖ•ÂàóË°®‰ª•È°ØÁ§∫Ê≠£Á¢∫ÁãÄÊÖã
        loadTodayAppointments();
        
        showToast(`ÈñãÂßãÁÇ∫ ${patient.name} Ë®∫Áóá`, 'success');
        
    } catch (error) {
        console.error('ÈñãÂßãË®∫ÁóáÈåØË™§:', error);
        showToast('ÈñãÂßãË®∫ÁóáÊôÇÁôºÁîüÈåØË™§', 'error');
    }
}
        
        // ÁπºÁ∫åË®∫Áóá
        function continueConsultation(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) return;
            
            currentConsultingAppointmentId = appointmentId;
            showConsultationForm(appointment);
        }
        
// 6. ‰øÆÊîπË®∫ÁóáË°®ÂñÆÈ°ØÁ§∫ÂáΩÊï∏ÔºåÊîØÊè¥ Firebase
async function showConsultationForm(appointment) {
    try {
        // Âæû Firebase Áç≤ÂèñÁóÖ‰∫∫Ë≥áÊñô
        const result = await window.firebaseDataManager.getPatients();
        if (!result.success) {
            showToast('ÁÑ°Ê≥ïËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
            return;
        }
        
        const patient = result.data.find(p => p.id === appointment.patientId);
        if (!patient) {
            showToast('Êâæ‰∏çÂà∞ÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
            return;
        }
        
        // Ë®≠ÁΩÆÁóÖ‰∫∫Ë≥áË®ä
        document.getElementById('formPatientName').textContent = `${patient.name} (${patient.patientNumber})`;
        document.getElementById('formAppointmentTime').textContent = new Date(appointment.appointmentTime).toLocaleString('zh-TW');
        renderPatientPackages(patient.id);
        
        // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Á∑®ËºØÊ®°Âºè
        if (appointment.status === 'completed' && appointment.consultationId) {
            // Á∑®ËºØÊ®°ÂºèÔºöËºâÂÖ•ÁèæÊúâË®∫ÁóáË®òÈåÑ
            const consultation = consultations.find(c => c.id === appointment.consultationId);
            if (consultation) {
                // ËºâÂÖ•Ë®∫ÁóáË®òÈåÑÂÖßÂÆπ
                document.getElementById('formSymptoms').value = consultation.symptoms || '';
                document.getElementById('formTongue').value = consultation.tongue || '';
                document.getElementById('formPulse').value = consultation.pulse || '';
                document.getElementById('formCurrentHistory').value = consultation.currentHistory || '';
                document.getElementById('formDiagnosis').value = consultation.diagnosis || '';
                document.getElementById('formSyndrome').value = consultation.syndrome || '';
                document.getElementById('formAcupunctureNotes').value = consultation.acupunctureNotes || '';
                document.getElementById('formUsage').value = consultation.usage || '';
                document.getElementById('formTreatmentCourse').value = consultation.treatmentCourse || '';
                document.getElementById('formInstructions').value = consultation.instructions || '';
                document.getElementById('formFollowUpDate').value = consultation.followUpDate || '';
                document.getElementById('formVisitTime').value = consultation.visitTime || '';
                
                // ËºâÂÖ•‰ºëÊÅØÊúüÈñìË®≠ÂÆö
                if (consultation.restStartDate && consultation.restEndDate) {
                    document.getElementById('formRestStartDate').value = consultation.restStartDate;
                    document.getElementById('formRestEndDate').value = consultation.restEndDate;
                    updateRestPeriod();
                } else {
                    // ‰ΩøÁî®È†êË®≠ÂÄº
                    const startDate = new Date();
                    const endDate = new Date();
                    endDate.setDate(startDate.getDate() + 2);
                    
                    const startDateStr = `${startDate.getFullYear()}-${String(startDate.getMonth() + 1).padStart(2, '0')}-${String(startDate.getDate()).padStart(2, '0')}`;
                    const endDateStr = `${endDate.getFullYear()}-${String(endDate.getMonth() + 1).padStart(2, '0')}-${String(endDate.getDate()).padStart(2, '0')}`;
                    
                    document.getElementById('formRestStartDate').value = startDateStr;
                    document.getElementById('formRestEndDate').value = endDateStr;
                    updateRestPeriod();
                }
                
                // ËºâÂÖ•ËôïÊñπÂíåÊî∂Ë≤ªÈ†ÖÁõÆ
                // ... ËôïÊñπÂíåÊî∂Ë≤ªÈ†ÖÁõÆËºâÂÖ•ÈÇèËºØ‰øùÊåÅ‰∏çËÆä
                
                document.getElementById('consultationSaveButtonText').textContent = 'Êõ¥Êñ∞ÁóÖÊ≠∑';
            } else {
                clearConsultationForm();
            }
        } else {
            // Êñ∞Ë®∫ÁóáÊ®°ÂºèÔºö‰ΩøÁî®Á©∫ÁôΩË°®ÂñÆ
            clearConsultationForm();
            
            // Ë®≠ÁΩÆÈ†êË®≠ÂÄº
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const localDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
            document.getElementById('formVisitTime').value = localDateTime;
            
            // Ë®≠ÁΩÆÈ†êË®≠‰ºëÊÅØÊúüÈñì
            const startDate = new Date();
            const endDate = new Date();
            endDate.setDate(startDate.getDate() + 2);
            
            const startDateStr = `${startDate.getFullYear()}-${String(startDate.getMonth() + 1).padStart(2, '0')}-${String(startDate.getDate()).padStart(2, '0')}`;
            const endDateStr = `${endDate.getFullYear()}-${String(endDate.getMonth() + 1).padStart(2, '0')}-${String(endDate.getDate()).padStart(2, '0')}`;
            
            document.getElementById('formRestStartDate').value = startDateStr;
            document.getElementById('formRestEndDate').value = endDateStr;
            updateRestPeriod();
            
            // Â¶ÇÊûúÊéõËôüÊôÇÊúâÂ°´ÂØ´‰∏ªË®¥ÔºåÂâáÈ†êÂ°´Âà∞‰∏ªË®¥Ê¨Ñ‰Ωç
            if (appointment.chiefComplaint && appointment.chiefComplaint !== 'ÁÑ°ÁâπÊÆä‰∏ªË®¥') {
                document.getElementById('formSymptoms').value = appointment.chiefComplaint;
            }
            
            // Ëá™ÂãïÊ∑ªÂä†È†êË®≠Ë®∫ÈáëÊî∂Ë≤ªÈ†ÖÁõÆ
            addDefaultConsultationFee(patient);
            
            document.getElementById('consultationSaveButtonText').textContent = 'ÂÆåÊàêË®∫Áóá';
        }
        
        document.getElementById('consultationForm').classList.remove('hidden');
        
        // ÊªæÂãïÂà∞Ë°®ÂñÆ‰ΩçÁΩÆ
        document.getElementById('consultationForm').scrollIntoView({ behavior: 'smooth' });
        
    } catch (error) {
        console.error('È°ØÁ§∫Ë®∫ÁóáË°®ÂñÆÈåØË™§:', error);
        showToast('ËºâÂÖ•Ë®∫ÁóáË°®ÂñÆÊôÇÁôºÁîüÈåØË™§', 'error');
    }
}
        

        
        // Ê∏ÖÁ©∫Ë®∫ÁóáË°®ÂñÆ
        function clearConsultationForm() {
            ['formSymptoms', 'formTongue', 'formPulse', 'formCurrentHistory', 'formDiagnosis', 'formSyndrome', 'formAcupunctureNotes', 'formPrescription', 'formFollowUpDate', 'formVisitTime', 'formRestStartDate', 'formRestEndDate'].forEach(id => {
                document.getElementById(id).value = '';
            });
            
            // ÈáçÁΩÆÊúçËó•Êó•Êï∏ÂíåÊ¨°Êï∏ÁÇ∫È†êË®≠ÂÄº
            document.getElementById('medicationDays').value = '5';
            document.getElementById('medicationFrequency').value = '2';
            
            // ÈáçÁΩÆ‰ºëÊÅØÊúüÈñìÈ°ØÁ§∫
            document.getElementById('restPeriodDisplay').textContent = 'Ë´ãÈÅ∏ÊìáÈñãÂßãÂíåÁµêÊùüÊó•Êúü';
            document.getElementById('restPeriodDisplay').className = 'text-sm text-gray-500 font-medium';
            
            // Ë®≠ÁΩÆÈ†êË®≠ÂÄº
            document.getElementById('formUsage').value = 'Êó©Êôö‰∏ÄÊ¨°ÔºåÈ£ØÂæåÊúç';
            document.getElementById('formInstructions').value = 'Ê≥®ÊÑè‰ºëÊÅØÔºåÈ£≤È£üÊ∏ÖÊ∑°';
            document.getElementById('formTreatmentCourse').value = '‰∏ÄÂë®';
            
            // Ê∏ÖÁ©∫ËôïÊñπÈ†ÖÁõÆ
            selectedPrescriptionItems = [];
            updatePrescriptionDisplay();
            clearPrescriptionSearch();
            
            // Ê∏ÖÁ©∫Êî∂Ë≤ªÈ†ÖÁõÆÔºà‰ΩÜÊúÉÂú® prefillWithPreviousRecord ‰∏≠Ëá™ÂãïÊ∑ªÂä†Ë®∫ÈáëÔºâ
            selectedBillingItems = [];
            updateBillingDisplay();
            clearBillingSearch();
        }
        
        // ÈóúÈñâË®∫ÁóáË°®ÂñÆ
        function closeConsultationForm() {
            // Èö±ËóèË®∫ÁóáË°®ÂñÆ
            document.getElementById('consultationForm').classList.add('hidden');
            
            // Ê∏ÖÁêÜÂÖ®ÂüüËÆäÊï∏
            currentConsultingAppointmentId = null;
            
            // Ê∏ÖÁ©∫ËôïÊñπÂíåÊî∂Ë≤ªÈ†ÖÁõÆÈÅ∏Êìá
            selectedPrescriptionItems = [];
            selectedBillingItems = [];
            
            // ÊªæÂãïÂõûÈ†ÇÈÉ®
            document.getElementById('consultationSystem').scrollIntoView({ behavior: 'smooth' });
        }
        
        // ÂèñÊ∂àË®∫Áóá
        async function cancelConsultation() {
            if (!currentConsultingAppointmentId) {
                closeConsultationForm();
                return;
            }
            
            const appointment = appointments.find(apt => apt.id === currentConsultingAppointmentId);
            if (!appointment) {
                closeConsultationForm();
                currentConsultingAppointmentId = null;
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            if (!patient) {
                closeConsultationForm();
                currentConsultingAppointmentId = null;
                return;
            }
            
            // Ë©≥Á¥∞ÁãÄÊÖãÊ™¢Êü•
            console.log(`ÂèñÊ∂àË®∫ÁóáÁãÄÊÖãÊ™¢Êü• - ÁóÖ‰∫∫: ${patient.name}, Áï∂ÂâçÁãÄÊÖã: ${appointment.status}`);
            
            if (appointment.status === 'consulting') {
                const confirmMessage = `Á¢∫ÂÆöË¶ÅÂèñÊ∂à ${patient.name} ÁöÑË®∫ÁóáÂóéÔºü\n\n` +
                                     `ÁóÖ‰∫∫ÁãÄÊÖãÂ∞áÂõûÂà∞ÂÄôË®∫‰∏≠ÔºåÂ∑≤Â°´ÂØ´ÁöÑË®∫ÁóáÂÖßÂÆπÂ∞áÊúÉÈÅ∫Â§±„ÄÇ\n\n` +
                                     `Ê≥®ÊÑèÔºöÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ`;
                
                if (confirm(confirmMessage)) {
                    // Â∞áÁãÄÊÖãÊîπÂõûÂÄôË®∫‰∏≠
                    appointment.status = 'waiting';
                    delete appointment.consultationStartTime;
                    delete appointment.consultingDoctor;
                    
                    // ‰øùÂ≠òÁãÄÊÖãËÆäÊõ¥
                    localStorage.setItem('appointments', JSON.stringify(appointments));
                    
                    showToast(`Â∑≤ÂèñÊ∂à ${patient.name} ÁöÑË®∫ÁóáÔºåÁóÖ‰∫∫ÂõûÂà∞ÂÄôË®∫ÁãÄÊÖã`, 'info');
                    
                    // ÈóúÈñâË°®ÂñÆ‰∏¶Ê∏ÖÁêÜ
                    closeConsultationForm();
                    currentConsultingAppointmentId = null;
                    loadTodayAppointments();
                }
            } else if (appointment.status === 'completed') {
                // Â¶ÇÊûúÊòØÂ∑≤ÂÆåÊàêÁöÑË®∫ÁóáÔºåÂè™ÊòØÈóúÈñâÁ∑®ËºØÊ®°Âºè
                showToast('Â∑≤ÈÄÄÂá∫ÁóÖÊ≠∑Á∑®ËºØÊ®°Âºè', 'info');
                closeConsultationForm();
                currentConsultingAppointmentId = null;
            } else {
                // ÂÖ∂‰ªñÁãÄÊÖãÁõ¥Êé•ÈóúÈñâ
                closeConsultationForm();
                currentConsultingAppointmentId = null;
            }
        }
        
        // ÂÑ≤Â≠òË®∫ÁóáË®òÈåÑÔºàÈÜ´Â∏´Êìç‰ΩúÔºâ
async function saveConsultation() {
    if (!currentConsultingAppointmentId) {
        showToast('Á≥ªÁµ±ÈåØË™§ÔºöÊâæ‰∏çÂà∞Ë®∫ÁóáË®òÈåÑÔºÅ', 'error');
        return;
    }
    
    const symptoms = document.getElementById('formSymptoms').value.trim();
    const diagnosis = document.getElementById('formDiagnosis').value.trim();
    
    if (!symptoms || !diagnosis) {
        showToast('Ë´ãÂ°´ÂØ´ÂøÖÂ°´Ê¨Ñ‰ΩçÔºö‰∏ªË®¥„ÄÅ‰∏≠ÈÜ´Ë®∫Êñ∑ÔºÅ', 'error');
        return;
    }

    try {
        // Áç≤ÂèñÁï∂ÂâçÊéõËôü‰ø°ÊÅØÔºàÂæûÂéüÂßãÊï∏ÊìöÁµêÊßãÁç≤ÂèñÔºåÂõ†ÁÇ∫ÊéõËôüÈÇÑÊ≤íÊúâÈÅ∑ÁßªÂà∞ FirebaseÔºâ
        const appointment = appointments.find(apt => apt.id === currentConsultingAppointmentId);
        if (!appointment) {
            showToast('Êâæ‰∏çÂà∞ÊéõËôüË®òÈåÑÔºÅ', 'error');
            return;
        }

        const consultation = {
            appointmentId: currentConsultingAppointmentId,
            patientId: appointment.patientId,
            symptoms: symptoms,
            tongue: document.getElementById('formTongue').value.trim(),
            pulse: document.getElementById('formPulse').value.trim(),
            currentHistory: document.getElementById('formCurrentHistory').value.trim(),
            diagnosis: diagnosis,
            syndrome: document.getElementById('formSyndrome').value.trim(),
            acupunctureNotes: document.getElementById('formAcupunctureNotes').value.trim(),
            prescription: document.getElementById('formPrescription').value.trim(),
            usage: document.getElementById('formUsage').value.trim(),
            treatmentCourse: document.getElementById('formTreatmentCourse').value.trim(),
            instructions: document.getElementById('formInstructions').value.trim(),
            followUpDate: document.getElementById('formFollowUpDate').value,
            visitTime: document.getElementById('formVisitTime').value,
            restStartDate: document.getElementById('formRestStartDate').value,
            restEndDate: document.getElementById('formRestEndDate').value,
            billingItems: document.getElementById('formBillingItems').value.trim(),
            date: new Date(),
            doctor: currentUser,
            status: 'completed'
        };

        // È°ØÁ§∫‰øùÂ≠ò‰∏≠ÁãÄÊÖã
        const saveButton = document.querySelector('[onclick="saveConsultation()"]');
        const originalText = saveButton.textContent;
        saveButton.textContent = '‰øùÂ≠ò‰∏≠...';
        saveButton.disabled = true;

        // ‰øùÂ≠òÂà∞ Firebase
        const result = await window.firebaseDataManager.addConsultation(consultation);

        if (result.success) {
            // Êõ¥Êñ∞Êú¨Âú∞ÊéõËôüÁãÄÊÖãÔºàÊö´ÊôÇÔºåÁõ¥Âà∞ÊéõËôüÁ≥ªÁµ±‰πüÈÅ∑ÁßªÂà∞ FirebaseÔºâ
            appointment.status = 'completed';
            appointment.completedAt = new Date().toISOString();
            appointment.consultationId = result.id;
            appointment.completedBy = currentUser;
            localStorage.setItem('appointments', JSON.stringify(appointments));

            showToast('Ë®∫ÁóáË®òÈåÑÂ∑≤‰øùÂ≠òÔºÅ', 'success');
            
            closeConsultationForm();
            loadTodayAppointments();
            updateStatistics();
            clearAllSearchFields();

        } else {
            showToast('‰øùÂ≠òË®∫ÁóáË®òÈåÑÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
        }

    } catch (error) {
        console.error('‰øùÂ≠òË®∫ÁóáË®òÈåÑÈåØË™§:', error);
        showToast('‰øùÂ≠òÊôÇÁôºÁîüÈåØË™§', 'error');
    } finally {
        // ÊÅ¢Âæ©ÊåâÈàïÁãÄÊÖã
        const saveButton = document.querySelector('[onclick="saveConsultation()"]');
        if (saveButton) {
            saveButton.textContent = originalText;
            saveButton.disabled = false;
        }
    }
}
        
        // ÁóÖ‰∫∫Ë≥áÊñôÁÆ°ÁêÜÈ†ÅÈù¢ÁöÑÁóÖÊ≠∑Êü•ÁúãÂäüËÉΩ
        let currentPatientConsultations = [];
        let currentPatientHistoryPage = 0;
        
        async function showPatientMedicalHistory(patientId) {
    try {
const patientResult = await window.firebaseDataManager.getPatients();
if (!patientResult.success) {
    showToast('ÁÑ°Ê≥ïËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
    return;
}

const patient = patientResult.data.find(p => p.id === patientId);
if (!patient) {
    showToast('Êâæ‰∏çÂà∞ÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
    return;
}
            
            // Áç≤ÂèñË©≤ÁóÖ‰∫∫ÁöÑÊâÄÊúâË®∫ÁóáË®òÈåÑ
            currentPatientConsultations = consultations
                .filter(c => c.patientId === patientId)
                .sort((a, b) => new Date(a.date) - new Date(b.date)); // ÊåâÊó•ÊúüÂçáÂ∫èÊéíÂàóÔºàËºÉËàäËá≥ËºÉÊñ∞Ôºâ
            
            // È†êË®≠È°ØÁ§∫ÊúÄÊñ∞ÁöÑÁóÖÊ≠∑ÔºàÊúÄËøë‰∏ÄÊ¨°Ë®∫ÁóáÔºâ
            currentPatientHistoryPage = currentPatientConsultations.length - 1;
            
            // Ë®≠ÁΩÆÊ®ôÈ°å
            document.getElementById('patientMedicalHistoryTitle').textContent = `${patient.name} ÁöÑÁóÖÊ≠∑Ë®òÈåÑ`;
            
            // È°ØÁ§∫ÁóÖ‰∫∫Âü∫Êú¨Ë≥áË®ä
            document.getElementById('patientMedicalHistoryPatientInfo').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
                    <div>
                        <span class="font-medium text-gray-700">ÁóÖ‰∫∫Á∑®ËôüÔºö</span>
                        <span class="text-blue-600 font-semibold">${patient.patientNumber}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">ÂßìÂêçÔºö</span>
                        <span class="font-semibold">${patient.name}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">Âπ¥ÈΩ°Ôºö</span>
                        <span>${formatAge(patient.birthDate)}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">ÊÄßÂà•Ôºö</span>
                        <span>${patient.gender}</span>
                    </div>
                    ${patient.allergies ? `
                    <div class="md:col-span-4">
                        <span class="font-medium text-red-600">ÈÅéÊïèÂè≤Ôºö</span>
                        <span class="text-red-700 bg-red-50 px-2 py-1 rounded">${patient.allergies}</span>
                    </div>
                    ` : ''}
                </div>
            `;
            
            // È°ØÁ§∫ÂàÜÈ†ÅÁóÖÊ≠∑Ë®òÈåÑ
            displayPatientMedicalHistoryPage();
            
            document.getElementById('patientMedicalHistoryModal').classList.remove('hidden');
            } catch (error) {
        console.error('ËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñôÈåØË™§:', error);
        showToast('ËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñôÂ§±Êïó', 'error');
    }
        }
        
        function displayPatientMedicalHistoryPage() {
            const contentDiv = document.getElementById('patientMedicalHistoryContent');
            
            if (currentPatientConsultations.length === 0) {
                contentDiv.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-4xl mb-4">üìã</div>
                        <div class="text-lg font-medium mb-2">Êö´ÁÑ°Ë®∫ÁóáË®òÈåÑ</div>
                        <div class="text-sm">Ë©≤ÁóÖ‰∫∫Â∞öÊú™ÊúâË®∫ÁóáË®òÈåÑ</div>
                    </div>
                `;
                return;
            }
            
            const consultation = currentPatientConsultations[currentPatientHistoryPage];
            const totalPages = currentPatientConsultations.length;
            const currentPageNumber = currentPatientHistoryPage + 1;
            const consultationNumber = currentPatientHistoryPage + 1;
            
            contentDiv.innerHTML = `
                <!-- ÂàÜÈ†ÅÂ∞éËà™ -->
                <div class="mb-6 flex justify-between items-center bg-gray-50 rounded-lg p-4">
                    <div class="flex items-center space-x-4">
                        <h4 class="text-lg font-semibold text-gray-800">Ë®∫ÁóáË®òÈåÑ</h4>
                        <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                            Á¨¨ ${consultationNumber} Ê¨°Ë®∫Áóá
                        </span>
                        <span class="text-sm text-gray-600">
                            ÂÖ± ${totalPages} Ê¨°Ë®∫ÁóáË®òÈåÑ
                        </span>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <button onclick="changePatientHistoryPage(-1)" 
                                ${currentPatientHistoryPage === 0 ? 'disabled' : ''}
                                class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-sm">
                            ‚Üê ËºÉËàä
                        </button>
                        <span class="text-sm text-gray-600 px-2">
                            ${currentPageNumber} / ${totalPages}
                        </span>
                        <button onclick="changePatientHistoryPage(1)" 
                                ${currentPatientHistoryPage === totalPages - 1 ? 'disabled' : ''}
                                class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-sm">
                            ËºÉÊñ∞ ‚Üí
                        </button>
                    </div>
                </div>
                
                <!-- Áï∂ÂâçÁóÖÊ≠∑Ë®òÈåÑ -->
                <div class="border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                    <div class="bg-gradient-to-r from-gray-50 to-blue-50 px-6 py-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center space-x-4">
                                <span class="font-semibold text-gray-900 text-lg">
                                    ${new Date(consultation.date).toLocaleDateString('zh-TW')} 
                                    ${new Date(consultation.date).toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'})}
                                </span>
                                <span class="text-sm text-gray-600 bg-white px-3 py-1 rounded">
                                    ÈÜ´Â∏´Ôºö${getDoctorDisplayName(consultation.doctor)}
                                </span>
                                ${consultation.updatedAt ? `
                                    <span class="text-xs text-orange-600 bg-orange-50 px-2 py-1 rounded">
                                        Â∑≤‰øÆÊîπ
                                    </span>
                                ` : ''}
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="printConsultationRecord(${consultation.id})" 
                                        class="text-green-600 hover:text-green-800 text-sm font-medium bg-green-50 px-3 py-2 rounded">
                                    üìÑ ÂàóÂç∞Êî∂Êìö
                                </button>
                                <button onclick="printAttendanceCertificate(${consultation.id})" 
                                        class="text-blue-600 hover:text-blue-800 text-sm font-medium bg-blue-50 px-3 py-2 rounded">
                                    üìã Âà∞Ë®∫Ë≠âÊòé
                                </button>
                                ${(() => {
                                    // Ê™¢Êü•ÊòØÂê¶Ê≠£Âú®Ë®∫Áóá‰∏îÁÇ∫Áõ∏ÂêåÁóÖ‰∫∫
                                    if (currentConsultingAppointmentId) {
                                        const currentAppointment = appointments.find(apt => apt.id === currentConsultingAppointmentId);
                                        if (currentAppointment && currentAppointment.patientId === consultation.patientId) {
                                            return `
                                                <button onclick="loadMedicalRecordToCurrentConsultation(${consultation.id})" 
                                                        class="text-blue-600 hover:text-blue-800 text-sm font-medium bg-blue-50 px-3 py-2 rounded">
                                                    üìã ËºâÂÖ•ÁóÖÊ≠∑
                                                </button>
                                            `;
                                        }
                                    }
                                    return '';
                                })()}
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="space-y-4">
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">‰∏ªË®¥</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.symptoms || 'ÁÑ°Ë®òÈåÑ'}</div>
                                </div>
                                
                                ${consultation.tongue ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ËàåË±°</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.tongue}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.pulse ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ËÑàË±°</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.pulse}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.currentHistory ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ÁèæÁóÖÂè≤</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.currentHistory}</div>
                                </div>
                                ` : ''}
                                
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">‰∏≠ÈÜ´Ë®∫Êñ∑</span>
                                    <div class="bg-green-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-green-400">${consultation.diagnosis || 'ÁÑ°Ë®òÈåÑ'}</div>
                                </div>
                                
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">Ë≠âÂûãË®∫Êñ∑</span>
                                    <div class="bg-blue-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-blue-400">${consultation.syndrome || 'ÁÑ°Ë®òÈåÑ'}</div>
                                </div>
                                
                                ${consultation.acupunctureNotes ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ÈáùÁÅ∏ÂÇôË®ª</span>
                                    <div class="bg-orange-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-orange-400">${consultation.acupunctureNotes}</div>
                                </div>
                                ` : ''}
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ËôïÊñπÂÖßÂÆπ</span>
                                    <div class="bg-yellow-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-yellow-400 whitespace-pre-line">${consultation.prescription || 'ÁÑ°Ë®òÈåÑ'}</div>
                                </div>
                                
                                ${consultation.usage ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ÊúçÁî®ÊñπÊ≥ï</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.usage}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.treatmentCourse ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ÁôÇÁ®ã</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.treatmentCourse}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.instructions ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ÈÜ´ÂõëÂèäÊ≥®ÊÑè‰∫ãÈ†Ö</span>
                                    <div class="bg-red-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-red-400">${consultation.instructions}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.followUpDate ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">Ë§áË®∫ÊôÇÈñì</span>
                                    <div class="bg-purple-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-purple-400">${new Date(consultation.followUpDate).toLocaleString('zh-TW')}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.billingItems ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">Êî∂Ë≤ªÈ†ÖÁõÆ</span>
                                    <div class="bg-green-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-green-400 whitespace-pre-line">${consultation.billingItems}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function changePatientHistoryPage(direction) {
            const newPage = currentPatientHistoryPage + direction;
            if (newPage >= 0 && newPage < currentPatientConsultations.length) {
                currentPatientHistoryPage = newPage;
                displayPatientMedicalHistoryPage();
            }
        }

        // ÈóúÈñâÁóÖ‰∫∫ÁóÖÊ≠∑Êü•ÁúãÂΩàÁ™ó
        function closePatientMedicalHistoryModal() {
            document.getElementById('patientMedicalHistoryModal').classList.add('hidden');
        }



        // Ë®∫ÁóáÁ≥ªÁµ±‰∏≠ÁöÑÁóÖÊ≠∑Êü•ÁúãÂäüËÉΩ
        let currentConsultationConsultations = [];
        let currentConsultationHistoryPage = 0;
        
// 5. ‰øÆÊîπÊü•ÁúãÁóÖ‰∫∫Ë®∫ÁóáË®òÈåÑÂäüËÉΩ
async function viewPatientMedicalHistory(patientId) {
    try {
        // Âæû Firebase Áç≤ÂèñÁóÖ‰∫∫Ë≥áÊñô
        const patientResult = await window.firebaseDataManager.getPatients();
        if (!patientResult.success) {
            showToast('ÁÑ°Ê≥ïËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñô', 'error');
            return;
        }
        
        const patient = patientResult.data.find(p => p.id === patientId);
        if (!patient) {
            showToast('Êâæ‰∏çÂà∞ÁóÖ‰∫∫Ë≥áÊñô', 'error');
            return;
        }
        
        // Áç≤ÂèñË©≤ÁóÖ‰∫∫ÁöÑÊâÄÊúâË®∫ÁóáË®òÈåÑ
        const consultationResult = await window.firebaseDataManager.getPatientConsultations(patientId);
        if (!consultationResult.success) {
            showToast('ÁÑ°Ê≥ïËÆÄÂèñË®∫ÁóáË®òÈåÑ', 'error');
            return;
        }
        
        currentConsultationConsultations = consultationResult.data;
        
        // È†êË®≠È°ØÁ§∫ÊúÄÊñ∞ÁöÑÁóÖÊ≠∑ÔºàÊúÄËøë‰∏ÄÊ¨°Ë®∫ÁóáÔºâ
        currentConsultationHistoryPage = 0; // Firebase Â∑≤Á∂ìÊåâÊôÇÈñìÊéíÂ∫èÔºåÊúÄÊñ∞Âú®Ââç
        
        // Ë®≠ÁΩÆÊ®ôÈ°å
        document.getElementById('medicalHistoryTitle').textContent = `${patient.name} ÁöÑË®∫ÁóáË®òÈåÑ`;
        
        // È°ØÁ§∫ÁóÖ‰∫∫Âü∫Êú¨Ë≥áË®ä
        document.getElementById('medicalHistoryPatientInfo').innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
                <div>
                    <span class="font-medium text-gray-700">ÁóÖ‰∫∫Á∑®ËôüÔºö</span>
                    <span class="text-blue-600 font-semibold">${patient.patientNumber}</span>
                </div>
                <div>
                    <span class="font-medium text-gray-700">ÂßìÂêçÔºö</span>
                    <span class="font-semibold">${patient.name}</span>
                </div>
                <div>
                    <span class="font-medium text-gray-700">Âπ¥ÈΩ°Ôºö</span>
                    <span>${formatAge(patient.birthDate)}</span>
                </div>
                <div>
                    <span class="font-medium text-gray-700">ÊÄßÂà•Ôºö</span>
                    <span>${patient.gender}</span>
                </div>
                ${patient.allergies ? `
                <div class="md:col-span-4">
                    <span class="font-medium text-red-600">ÈÅéÊïèÂè≤Ôºö</span>
                    <span class="text-red-700 bg-red-50 px-2 py-1 rounded">${patient.allergies}</span>
                </div>
                ` : ''}
            </div>
        `;
        
        // È°ØÁ§∫ÂàÜÈ†ÅÁóÖÊ≠∑Ë®òÈåÑ
        displayConsultationMedicalHistoryPage();
        
        document.getElementById('medicalHistoryModal').classList.remove('hidden');
        
    } catch (error) {
        console.error('Êü•ÁúãÁóÖ‰∫∫Ë®∫ÁóáË®òÈåÑÈåØË™§:', error);
        showToast('ËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñôÂ§±Êïó', 'error');
    }
}
        
        function displayConsultationMedicalHistoryPage() {
            const contentDiv = document.getElementById('medicalHistoryContent');
            
            if (currentConsultationConsultations.length === 0) {
                contentDiv.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-4xl mb-4">üìã</div>
                        <div class="text-lg font-medium mb-2">Êö´ÁÑ°Ë®∫ÁóáË®òÈåÑ</div>
                        <div class="text-sm">Ë©≤ÁóÖ‰∫∫Â∞öÊú™ÊúâË®∫ÁóáË®òÈåÑ</div>
                    </div>
                `;
                return;
            }
            
            const consultation = currentConsultationConsultations[currentConsultationHistoryPage];
            const totalPages = currentConsultationConsultations.length;
            const currentPageNumber = currentConsultationHistoryPage + 1;
            const consultationNumber = currentConsultationHistoryPage + 1;
            
            contentDiv.innerHTML = `
                <!-- ÂàÜÈ†ÅÂ∞éËà™ -->
                <div class="mb-6 flex justify-between items-center bg-gray-50 rounded-lg p-4">
                    <div class="flex items-center space-x-4">
                        <h4 class="text-lg font-semibold text-gray-800">Ë®∫ÁóáË®òÈåÑ</h4>
                        <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                            Á¨¨ ${consultationNumber} Ê¨°Ë®∫Áóá
                        </span>
                        <span class="text-sm text-gray-600">
                            ÂÖ± ${totalPages} Ê¨°Ë®∫ÁóáË®òÈåÑ
                        </span>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <button onclick="changeConsultationHistoryPage(-1)" 
                                ${currentConsultationHistoryPage === 0 ? 'disabled' : ''}
                                class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-sm">
                            ‚Üê ËºÉËàä
                        </button>
                        <span class="text-sm text-gray-600 px-2">
                            ${currentPageNumber} / ${totalPages}
                        </span>
                        <button onclick="changeConsultationHistoryPage(1)" 
                                ${currentConsultationHistoryPage === totalPages - 1 ? 'disabled' : ''}
                                class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-sm">
                            ËºÉÊñ∞ ‚Üí
                        </button>
                    </div>
                </div>
                
                <!-- Áï∂ÂâçÁóÖÊ≠∑Ë®òÈåÑ -->
                <div class="border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                    <div class="bg-gradient-to-r from-gray-50 to-blue-50 px-6 py-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center space-x-4">
                                <span class="font-semibold text-gray-900 text-lg">
                                    ${new Date(consultation.date).toLocaleDateString('zh-TW')} 
                                    ${new Date(consultation.date).toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'})}
                                </span>
                                <span class="text-sm text-gray-600 bg-white px-3 py-1 rounded">
                                    ÈÜ´Â∏´Ôºö${getDoctorDisplayName(consultation.doctor)}
                                </span>
                                ${consultation.updatedAt ? `
                                    <span class="text-xs text-orange-600 bg-orange-50 px-2 py-1 rounded">
                                        Â∑≤‰øÆÊîπ
                                    </span>
                                ` : ''}
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="printConsultationRecord(${consultation.id})" 
                                        class="text-green-600 hover:text-green-800 text-sm font-medium bg-green-50 px-3 py-2 rounded">
                                    üìÑ ÂàóÂç∞Êî∂Êìö
                                </button>
                                <button onclick="printAttendanceCertificate(${consultation.id})" 
                                        class="text-blue-600 hover:text-blue-800 text-sm font-medium bg-blue-50 px-3 py-2 rounded">
                                    üìã Âà∞Ë®∫Ë≠âÊòé
                                </button>
                                ${(() => {
                                    // Ê™¢Êü•ÊòØÂê¶Ê≠£Âú®Ë®∫Áóá‰∏îÁÇ∫Áõ∏ÂêåÁóÖ‰∫∫
                                    if (currentConsultingAppointmentId) {
                                        const currentAppointment = appointments.find(apt => apt.id === currentConsultingAppointmentId);
                                        if (currentAppointment && currentAppointment.patientId === consultation.patientId) {
                                            return `
                                                <button onclick="loadMedicalRecordToCurrentConsultation(${consultation.id})" 
                                                        class="text-blue-600 hover:text-blue-800 text-sm font-medium bg-blue-50 px-3 py-2 rounded">
                                                    üìã ËºâÂÖ•ÁóÖÊ≠∑
                                                </button>
                                            `;
                                        }
                                    }
                                    return '';
                                })()}
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="space-y-4">
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">‰∏ªË®¥</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.symptoms || 'ÁÑ°Ë®òÈåÑ'}</div>
                                </div>
                                
                                ${consultation.tongue ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ËàåË±°</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.tongue}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.pulse ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ËÑàË±°</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.pulse}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.currentHistory ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ÁèæÁóÖÂè≤</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.currentHistory}</div>
                                </div>
                                ` : ''}
                                
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">‰∏≠ÈÜ´Ë®∫Êñ∑</span>
                                    <div class="bg-green-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-green-400">${consultation.diagnosis || 'ÁÑ°Ë®òÈåÑ'}</div>
                                </div>
                                
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">Ë≠âÂûãË®∫Êñ∑</span>
                                    <div class="bg-blue-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-blue-400">${consultation.syndrome || 'ÁÑ°Ë®òÈåÑ'}</div>
                                </div>
                                
                                ${consultation.acupunctureNotes ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ÈáùÁÅ∏ÂÇôË®ª</span>
                                    <div class="bg-orange-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-orange-400">${consultation.acupunctureNotes}</div>
                                </div>
                                ` : ''}
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ËôïÊñπÂÖßÂÆπ</span>
                                    <div class="bg-yellow-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-yellow-400 whitespace-pre-line">${consultation.prescription || 'ÁÑ°Ë®òÈåÑ'}</div>
                                </div>
                                
                                ${consultation.usage ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ÊúçÁî®ÊñπÊ≥ï</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.usage}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.treatmentCourse ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ÁôÇÁ®ã</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.treatmentCourse}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.instructions ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ÈÜ´ÂõëÂèäÊ≥®ÊÑè‰∫ãÈ†Ö</span>
                                    <div class="bg-red-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-red-400">${consultation.instructions}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.followUpDate ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">Ë§áË®∫ÊôÇÈñì</span>
                                    <div class="bg-purple-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-purple-400">${new Date(consultation.followUpDate).toLocaleString('zh-TW')}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.billingItems ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">Êî∂Ë≤ªÈ†ÖÁõÆ</span>
                                    <div class="bg-green-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-green-400 whitespace-pre-line">${consultation.billingItems}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function changeConsultationHistoryPage(direction) {
            const newPage = currentConsultationHistoryPage + direction;
            if (newPage >= 0 && newPage < currentConsultationConsultations.length) {
                currentConsultationHistoryPage = newPage;
                displayConsultationMedicalHistoryPage();
            }
        }
        
        // ÈóúÈñâË®∫ÁóáË®òÈåÑÂΩàÁ™ó
        function closeMedicalHistoryModal() {
            document.getElementById('medicalHistoryModal').classList.add('hidden');
        }
        

        
// 1. ‰øÆÊîπÂæûÊéõËôüË®òÈåÑÂàóÂç∞Êî∂ÊìöÂáΩÊï∏
async function printReceiptFromAppointment(appointmentId) {
    const appointment = appointments.find(apt => apt.id === appointmentId);
    if (!appointment) {
        showToast('Êâæ‰∏çÂà∞ÊéõËôüË®òÈåÑÔºÅ', 'error');
        return;
    }
    
    if (appointment.status !== 'completed' || !appointment.consultationId) {
        showToast('Âè™ËÉΩÂàóÂç∞Â∑≤ÂÆåÊàêË®∫ÁóáÁöÑÊî∂ÊìöÔºÅ', 'error');
        return;
    }
    
    try {
        // Âæû Firebase Áç≤ÂèñË®∫ÁóáË®òÈåÑ
        const consultationResult = await window.firebaseDataManager.getConsultations();
        if (!consultationResult.success) {
            showToast('ÁÑ°Ê≥ïËÆÄÂèñË®∫ÁóáË®òÈåÑÔºÅ', 'error');
            return;
        }
        
        const consultation = consultationResult.data.find(c => c.id === appointment.consultationId);
        if (!consultation) {
            showToast('Êâæ‰∏çÂà∞Â∞çÊáâÁöÑË®∫ÁóáË®òÈåÑÔºÅ', 'error');
            return;
        }
        
        // Áõ¥Êé•Ë™øÁî®ÁèæÊúâÁöÑÂàóÂç∞ÂäüËÉΩ
        await printConsultationRecord(consultation.id, consultation);
        
    } catch (error) {
        console.error('ÂàóÂç∞Êî∂ÊìöÈåØË™§:', error);
        showToast('ÂàóÂç∞Êî∂ÊìöÊôÇÁôºÁîüÈåØË™§', 'error');
    }
}

        
// 2. ‰øÆÊîπÂæûÊéõËôüË®òÈåÑÂàóÂç∞Âà∞Ë®∫Ë≠âÊòéÂáΩÊï∏
async function printAttendanceCertificateFromAppointment(appointmentId) {
    const appointment = appointments.find(apt => apt.id === appointmentId);
    if (!appointment) {
        showToast('Êâæ‰∏çÂà∞ÊéõËôüË®òÈåÑÔºÅ', 'error');
        return;
    }
    
    if (appointment.status !== 'completed' || !appointment.consultationId) {
        showToast('Âè™ËÉΩÂàóÂç∞Â∑≤ÂÆåÊàêË®∫ÁóáÁöÑÂà∞Ë®∫Ë≠âÊòéÔºÅ', 'error');
        return;
    }
    
    try {
        // Âæû Firebase Áç≤ÂèñË®∫ÁóáË®òÈåÑ
        const consultationResult = await window.firebaseDataManager.getConsultations();
        if (!consultationResult.success) {
            showToast('ÁÑ°Ê≥ïËÆÄÂèñË®∫ÁóáË®òÈåÑÔºÅ', 'error');
            return;
        }
        
        const consultation = consultationResult.data.find(c => c.id === appointment.consultationId);
        if (!consultation) {
            showToast('Êâæ‰∏çÂà∞Â∞çÊáâÁöÑË®∫ÁóáË®òÈåÑÔºÅ', 'error');
            return;
        }
        
        // Áõ¥Êé•Ë™øÁî®Âà∞Ë®∫Ë≠âÊòéÂàóÂç∞ÂäüËÉΩ
        await printAttendanceCertificate(consultation.id, consultation);
        
    } catch (error) {
        console.error('ÂàóÂç∞Âà∞Ë®∫Ë≠âÊòéÈåØË™§:', error);
        showToast('ÂàóÂç∞Âà∞Ë®∫Ë≠âÊòéÊôÇÁôºÁîüÈåØË™§', 'error');
    }
}
        
// 3. ‰øÆÊîπÂæûÊéõËôüË®òÈåÑÂàóÂç∞ÁóÖÂÅáË≠âÊòéÂáΩÊï∏
async function printSickLeaveFromAppointment(appointmentId) {
    const appointment = appointments.find(apt => apt.id === appointmentId);
    if (!appointment) {
        showToast('Êâæ‰∏çÂà∞ÊéõËôüË®òÈåÑÔºÅ', 'error');
        return;
    }
    
    if (appointment.status !== 'completed' || !appointment.consultationId) {
        showToast('Âè™ËÉΩÂàóÂç∞Â∑≤ÂÆåÊàêË®∫ÁóáÁöÑÁóÖÂÅáË≠âÊòéÔºÅ', 'error');
        return;
    }
    
    try {
        // Âæû Firebase Áç≤ÂèñË®∫ÁóáË®òÈåÑ
        const consultationResult = await window.firebaseDataManager.getConsultations();
        if (!consultationResult.success) {
            showToast('ÁÑ°Ê≥ïËÆÄÂèñË®∫ÁóáË®òÈåÑÔºÅ', 'error');
            return;
        }
        
        const consultation = consultationResult.data.find(c => c.id === appointment.consultationId);
        if (!consultation) {
            showToast('Êâæ‰∏çÂà∞Â∞çÊáâÁöÑË®∫ÁóáË®òÈåÑÔºÅ', 'error');
            return;
        }
        
        // Áõ¥Êé•Ë™øÁî®ÁóÖÂÅáË≠âÊòéÂàóÂç∞ÂäüËÉΩ
        await printSickLeave(consultation.id, consultation);
        
    } catch (error) {
        console.error('ÂàóÂç∞ÁóÖÂÅáË≠âÊòéÈåØË™§:', error);
        showToast('ÂàóÂç∞ÁóÖÂÅáË≠âÊòéÊôÇÁôºÁîüÈåØË™§', 'error');
    }
}
        
// 4. ‰øÆÊîπÂàóÂç∞Ë®∫ÁóáË®òÈåÑÂáΩÊï∏
async function printConsultationRecord(consultationId, consultationData = null) {
    let consultation = consultationData;
    
    // Â¶ÇÊûúÊ≤íÊúâÊèê‰æõË®∫ÁóáË≥áÊñôÔºåÂæû Firebase Áç≤Âèñ
    if (!consultation) {
        try {
            const consultationResult = await window.firebaseDataManager.getConsultations();
            if (!consultationResult.success) {
                showToast('ÁÑ°Ê≥ïËÆÄÂèñË®∫ÁóáË®òÈåÑÔºÅ', 'error');
                return;
            }
            
            consultation = consultationResult.data.find(c => c.id === consultationId);
            if (!consultation) {
                showToast('Êâæ‰∏çÂà∞Ë®∫ÁóáË®òÈåÑÔºÅ', 'error');
                return;
            }
        } catch (error) {
            console.error('ËÆÄÂèñË®∫ÁóáË®òÈåÑÈåØË™§:', error);
            showToast('ËÆÄÂèñË®∫ÁóáË®òÈåÑÂ§±Êïó', 'error');
            return;
        }
    }
    
    try {
        // Âæû Firebase Áç≤ÂèñÁóÖ‰∫∫Ë≥áÊñô
        const patientResult = await window.firebaseDataManager.getPatients();
        if (!patientResult.success) {
            showToast('ÁÑ°Ê≥ïËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
            return;
        }
        
        const patient = patientResult.data.find(p => p.id === consultation.patientId);
        if (!patient) {
            showToast('Êâæ‰∏çÂà∞ÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
            return;
        }
        
        // Ëß£ÊûêÊî∂Ë≤ªÈ†ÖÁõÆ‰ª•Ë®àÁÆóÁ∏ΩÈáëÈ°ç
        let totalAmount = 0;
        let billingItemsHtml = '';
        if (consultation.billingItems) {
            const lines = consultation.billingItems.split('\n');
            lines.forEach(line => {
                if (line.includes('=') && line.includes('$')) {
                    const match = line.match(/\$(\d+)/);
                    if (match) {
                        totalAmount += parseInt(match[1]);
                    }
                    billingItemsHtml += `<tr><td style="padding: 5px; border-bottom: 1px dotted #ccc;">${line}</td></tr>`;
                } else if (line.includes('Á∏ΩË≤ªÁî®')) {
                    const match = line.match(/\$(\d+)/);
                    if (match) {
                        totalAmount = parseInt(match[1]);
                    }
                }
            });
        }
        
        // Áç≤ÂèñË®∫ÁóáÊó•ÊúüÔºàËôïÁêÜ Firebase TimestampÔºâ
        let consultationDate;
        if (consultation.date && consultation.date.seconds) {
            consultationDate = new Date(consultation.date.seconds * 1000);
        } else if (consultation.date) {
            consultationDate = new Date(consultation.date);
        } else {
            consultationDate = new Date();
        }
        
        // ÂâµÂª∫‰∏≠ÈÜ´Ë®∫ÊâÄÊî∂ÊìöÊ†ºÂºè
        const printContent = `
            <!DOCTYPE html>
            <html lang="zh-TW">
            <head>
                <meta charset="UTF-8">
                <title>Êî∂Êìö - ${patient.name}</title>
                <style>
                    body { 
                        font-family: 'Microsoft JhengHei', 'ÂæÆËªüÊ≠£ÈªëÈ´î', sans-serif; 
                        margin: 0; 
                        padding: 10px; 
                        line-height: 1.3;
                        font-size: 11px;
                    }
                    .receipt-container {
                        width: 148mm;
                        height: 210mm;
                        margin: 0 auto;
                        border: 2px solid #000;
                        padding: 8px;
                        background: white;
                        box-sizing: border-box;
                    }
                    .clinic-header {
                        text-align: center;
                        border-bottom: 2px double #000;
                        padding-bottom: 10px;
                        margin-bottom: 15px;
                    }
                    .clinic-name {
                        font-size: 14px;
                        font-weight: bold;
                        margin-bottom: 2px;
                        letter-spacing: 1px;
                    }
                    .clinic-subtitle {
                        font-size: 10px;
                        color: #666;
                        margin-bottom: 3px;
                    }
                    .receipt-title {
                        font-size: 14px;
                        font-weight: bold;
                        text-align: center;
                        margin: 6px 0;
                        letter-spacing: 2px;
                    }
                    .receipt-info {
                        margin-bottom: 10px;
                    }
                    .info-row {
                        display: flex;
                        justify-content: space-between;
                        margin-bottom: 3px;
                        font-size: 11px;
                    }
                    .info-label {
                        font-weight: bold;
                    }
                    .items-section {
                        border-top: 1px solid #000;
                        border-bottom: 1px solid #000;
                        padding: 6px 0;
                        margin: 8px 0;
                    }
                    .items-title {
                        font-weight: bold;
                        text-align: center;
                        margin-bottom: 6px;
                        font-size: 12px;
                    }
                    .items-table {
                        width: 100%;
                        font-size: 10px;
                    }
                    .items-table td {
                        padding: 3px 5px;
                        border-bottom: 1px dotted #999;
                    }
                    .total-section {
                        text-align: right;
                        margin: 8px 0;
                        font-size: 12px;
                        font-weight: bold;
                    }
                    .total-amount {
                        font-size: 12px;
                        color: #000;
                        border: 2px solid #000;
                        padding: 4px;
                        display: inline-block;
                        min-width: 60px;
                        text-align: center;
                    }
                    .prescription-section {
                        margin: 8px 0;
                        border-top: 1px dashed #666;
                        padding-top: 6px;
                    }
                    .prescription-title {
                        font-weight: bold;
                        margin-bottom: 4px;
                        font-size: 11px;
                    }
                    .prescription-content {
                        background: #f9f9f9;
                        padding: 4px;
                        border: 1px solid #ddd;
                        font-size: 10px;
                        line-height: 1.2;
                    }
                    .footer-info {
                        margin-top: 10px;
                        border-top: 1px dashed #666;
                        padding-top: 6px;
                        font-size: 9px;
                        color: #666;
                    }
                    .footer-row {
                        display: flex;
                        justify-content: space-between;
                        margin-bottom: 2px;
                    }
                    .thank-you {
                        text-align: center;
                        margin: 8px 0;
                        font-weight: bold;
                        font-size: 11px;
                    }
                    .diagnosis-section {
                        margin: 6px 0;
                        font-size: 10px;
                    }
                    .diagnosis-title {
                        font-weight: bold;
                        margin-bottom: 3px;
                    }
                    @media print {
                        @page {
                            size: A5;
                            margin: 10mm;
                        }
                        body { 
                            margin: 0; 
                            padding: 0; 
                            font-size: 11px;
                        }
                        .receipt-container { 
                            border: 2px solid #000;
                            width: 100%;
                            height: 100%;
                            padding: 8mm;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="receipt-container">
                    <!-- Ë®∫ÊâÄÊ®ôÈ°å -->
                    <div class="clinic-header">
                        <div class="clinic-name">${clinicSettings.chineseName || '‰∏≠ÈÜ´Ë®∫ÊâÄÁ≥ªÁµ±'}</div>
                        <div class="clinic-subtitle">${clinicSettings.englishName || 'TCM Clinic'}</div>
                        <div class="clinic-subtitle">ÈõªË©±Ôºö${clinicSettings.phone || '(852) 2345-6789'}„ÄÄÂú∞ÂùÄÔºö${clinicSettings.address || 'È¶ôÊ∏Ø‰∏≠Áí∞ÁöáÂêéÂ§ßÈÅì‰∏≠123Ëôü'}</div>
                    </div>
                    
                    <!-- Êî∂ÊìöÊ®ôÈ°å -->
                    <div class="receipt-title">Êî∂„ÄÄÊìö</div>
                    
                    <!-- Âü∫Êú¨Ë≥áË®ä -->
                    <div class="receipt-info">
                        <div class="info-row">
                            <span class="info-label">Êî∂ÊìöÁ∑®ËôüÔºö</span>
                            <span>R${consultation.id.toString().padStart(6, '0')}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ÁóÖ‰∫∫ÂßìÂêçÔºö</span>
                            <span>${patient.name}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ÁóÖÊ≠∑ËôüÁ¢ºÔºö</span>
                            <span>${patient.patientNumber}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Ë®∫ÁôÇÊó•ÊúüÔºö</span>
                            <span>${consultationDate.toLocaleDateString('zh-TW', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit'
                            })}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Ë®∫ÁôÇÊôÇÈñìÔºö</span>
                            <span>${consultationDate.toLocaleTimeString('zh-TW', {
                                hour: '2-digit',
                                minute: '2-digit'
                            })}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">‰∏ªÊ≤ªÈÜ´Â∏´Ôºö</span>
                            <span>${getDoctorDisplayName(consultation.doctor)}</span>
                        </div>
                        ${(() => {
                            const regNumber = getDoctorRegistrationNumber(consultation.doctor);
                            return regNumber ? `
                                <div class="info-row">
                                    <span class="info-label">Ë®ªÂÜäÁ∑®ËôüÔºö</span>
                                    <span>${regNumber}</span>
                                </div>
                            ` : '';
                        })()}
                    </div>
                    
                    <!-- Ë®∫Êñ∑Ë≥áË®ä -->
                    ${consultation.diagnosis ? `
                    <div class="diagnosis-section">
                        <div class="diagnosis-title">Ë®∫Êñ∑Ôºö</div>
                        <div>${consultation.diagnosis}</div>
                        ${consultation.syndrome ? `<div>Ë≠âÂûãÔºö${consultation.syndrome}</div>` : ''}
                    </div>
                    ` : ''}
                    
                    <!-- Êî∂Ë≤ªÈ†ÖÁõÆ -->
                    ${consultation.billingItems ? `
                    <div class="items-section">
                        <div class="items-title">Êî∂Ë≤ªÊòéÁ¥∞</div>
                        <table class="items-table">
                            ${billingItemsHtml}
                        </table>
                    </div>
                    ` : ''}
                    
                    <!-- Á∏ΩÈáëÈ°ç -->
                    <div class="total-section">
                        <div style="margin-bottom: 8px; font-size: 10px;">ÊáâÊî∂ÈáëÈ°çÔºö</div>
                        <div class="total-amount">HK$ ${totalAmount.toLocaleString()}</div>
                    </div>
                    
                    <!-- ËôïÊñπË≥áË®ä -->
                    ${consultation.prescription ? `
                    <div class="prescription-section">
                        <div class="prescription-title">üìã ËôïÊñπÂÖßÂÆπ</div>
                        <div class="prescription-content">${(() => {
                            // Â∞áËôïÊñπÂÖßÂÆπÊåâË°åÂàÜÂâ≤ÔºåÁÑ∂ÂæåÊ©´ÂêëÊéíÂàó
                            const lines = consultation.prescription.split('\n').filter(line => line.trim());
                            const allItems = [];
                            let i = 0;
                            
                            while (i < lines.length) {
                                const line = lines[i].trim();
                                if (!line) {
                                    i++;
                                    continue;
                                }
                                
                                // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Ëó•Êùê/ÊñπÂäëÊ†ºÂºèÔºàÂêçÁ®± ÂäëÈáègÔºâ
                                const itemMatch = line.match(/^(.+?)\s+(\d+(?:\.\d+)?)g$/);
                                if (itemMatch) {
                                    const itemName = itemMatch[1].trim();
                                    const dosage = itemMatch[2];
                                    
                                    // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Â∏∏Ë¶ãÊñπÂäëÂêçÁ®±
                                    const isFormula = ['ÊπØ', 'Êï£', '‰∏∏', 'ËÜè', 'È£≤', '‰∏π', 'ÁÖé', 'Êñπ', 'Âäë'].some(suffix => itemName.includes(suffix));
                                    
                                    if (isFormula) {
                                        // Ê™¢Êü•‰∏ã‰∏ÄË°åÊòØÂê¶ÁÇ∫ÊñπÂäëÁµÑÊàê
                                        let composition = '';
                                        if (i + 1 < lines.length) {
                                            const nextLine = lines[i + 1].trim();
                                            // Â¶ÇÊûú‰∏ã‰∏ÄË°å‰∏çÊòØÊ®ôÊ∫ñËó•ÊùêÊ†ºÂºèÔºåË¶ñÁÇ∫ÊñπÂäëÁµÑÊàê
                                            if (nextLine && !nextLine.match(/^.+?\s+\d+(?:\.\d+)?g$/)) {
                                                composition = nextLine.replace(/\n/g, '„ÄÅ').replace(/„ÄÅ/g, ',');
                                                i++; // Ë∑≥ÈÅéÁµÑÊàêË°å
                                            }
                                        }
                                        
                                        // ÊñπÂäëÈ°ØÁ§∫Ê†ºÂºèÔºöÊñπÂäëÂêç ÂäëÈáèg (ÁµÑÊàê)
                                        if (composition) {
                                            allItems.push(`${itemName} ${dosage}g <span style="font-size: 8px;">(${composition})</span>`);
                                        } else {
                                            allItems.push(`${itemName} ${dosage}g`);
                                        }
                                    } else {
                                        // ÊôÆÈÄöËó•Êùê
                                        allItems.push(`${itemName} ${dosage}g`);
                                    }
                                } else {
                                    // ÈùûÊ®ôÊ∫ñÊ†ºÂºèÁöÑË°åÔºåÂèØËÉΩÊòØÁç®Á´ãÁöÑË™™Êòé
                                    allItems.push(`<div style="margin: 2px 0; font-size: 9px; color: #666;">${line}</div>`);
                                }
                                
                                i++;
                            }
                            
                            // ÂàÜÈõ¢ÊôÆÈÄöÈ†ÖÁõÆÂíåÁâπÊÆäË°å
                            const regularItems = allItems.filter(item => typeof item === 'string' && !item.includes('<div'));
                            const specialLines = allItems.filter(item => typeof item === 'string' && item.includes('<div'));
                            
                            let result = '';
                            
                            // ÂÖàÈ°ØÁ§∫ÁâπÊÆäË°å
                            specialLines.forEach(line => {
                                result += line;
                            });
                            
                            // ÁÑ∂ÂæåÈ°ØÁ§∫ÊâÄÊúâÈ†ÖÁõÆÔºàÂåÖÊã¨ÊñπÂäëÂíåËó•ÊùêÔºâÔºåÊØèË°å4ÂÄãÊ©´ÂêëÊéíÂàó
                            if (regularItems.length > 0) {
                                for (let j = 0; j < regularItems.length; j += 4) {
                                    const lineItems = regularItems.slice(j, j + 4);
                                    result += `<div style="margin: 2px 0;">${lineItems.join('„ÄÄ')}</div>`;
                                }
                            }
                            
                            return result || consultation.prescription.replace(/\n/g, '<br>');
                        })()}</div>
                        ${consultation.usage ? `
                        <div style="margin-top: 8px; font-size: 12px;">
                            <strong>ÊúçÁî®ÊñπÊ≥ïÔºö</strong>${consultation.usage}
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}
                    
                    <!-- ÈÜ´Âõë -->
                    ${consultation.instructions ? `
                    <div style="margin: 10px 0; font-size: 12px; background: #fff3cd; padding: 8px; border: 1px solid #ffeaa7;">
                        <strong>‚ö†Ô∏è ÈÜ´ÂõëÂèäÊ≥®ÊÑè‰∫ãÈ†ÖÔºö</strong><br>
                        ${consultation.instructions}
                    </div>
                    ` : ''}
                    
                    <!-- Ë§áË®∫ÊèêÈÜí -->
                    ${consultation.followUpDate ? `
                    <div style="margin: 10px 0; font-size: 12px; background: #e3f2fd; padding: 8px; border: 1px solid #90caf9;">
                        <strong>üìÖ Âª∫Ë≠∞Ë§áË®∫ÊôÇÈñìÔºö</strong><br>
                        ${new Date(consultation.followUpDate).toLocaleString('zh-TW')}
                    </div>
                    ` : ''}
                    
                    <!-- ÊÑüË¨ùË™û -->
                    <div class="thank-you">
                        Ë¨ùË¨ùÊÇ®ÁöÑÂÖâËá®ÔºåÁ•ùÊÇ®Ë∫´È´îÂÅ•Â∫∑ÔºÅ
                    </div>
                    
                    <!-- È†ÅÂ∞æË≥áË®ä -->
                    <div class="footer-info">
                        <div class="footer-row">
                            <span>Êî∂ÊìöÈñãÁ´ãÊôÇÈñìÔºö</span>
                            <span>${new Date().toLocaleString('zh-TW')}</span>
                        </div>
                        <div class="footer-row">
                            <span>Ë®∫ÊâÄÁáüÊ•≠ÊôÇÈñìÔºö</span>
                            <span>${clinicSettings.businessHours || 'ÈÄ±‰∏ÄËá≥ÈÄ±‰∫î 09:00-18:00'}</span>
                        </div>
                        <div class="footer-row">
                            <span>Êú¨Êî∂ÊìöË´ãÂ¶•ÂñÑ‰øùÂ≠ò</span>
                            <span>Â¶ÇÊúâÁñëÂïèË´ãÊ¥ΩÊ´ÉÊ™Ø</span>
                        </div>
                    </div>
                </div>
            </body>
            </html>
        `;
        
        // ÈñãÂïüÊñ∞Ë¶ñÁ™óÈÄ≤Ë°åÂàóÂç∞
        const printWindow = window.open('', '_blank', 'width=500,height=700');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        
        showToast('‰∏≠ÈÜ´Ë®∫ÊâÄÊî∂ÊìöÂ∑≤Ê∫ñÂÇôÂàóÂç∞ÔºÅ', 'success');
        
    } catch (error) {
        console.error('ÂàóÂç∞Êî∂ÊìöÈåØË™§:', error);
        showToast('ÂàóÂç∞Êî∂ÊìöÊôÇÁôºÁîüÈåØË™§', 'error');
    }
}
        
// 5. ‰øÆÊîπÂàóÂç∞Âà∞Ë®∫Ë≠âÊòéÂáΩÊï∏
async function printAttendanceCertificate(consultationId, consultationData = null) {
    let consultation = consultationData;
    
    // Â¶ÇÊûúÊ≤íÊúâÊèê‰æõË®∫ÁóáË≥áÊñôÔºåÂæû Firebase Áç≤Âèñ
    if (!consultation) {
        try {
            const consultationResult = await window.firebaseDataManager.getConsultations();
            if (!consultationResult.success) {
                showToast('ÁÑ°Ê≥ïËÆÄÂèñË®∫ÁóáË®òÈåÑÔºÅ', 'error');
                return;
            }
            
            consultation = consultationResult.data.find(c => c.id === consultationId);
            if (!consultation) {
                showToast('Êâæ‰∏çÂà∞Ë®∫ÁóáË®òÈåÑÔºÅ', 'error');
                return;
            }
        } catch (error) {
            console.error('ËÆÄÂèñË®∫ÁóáË®òÈåÑÈåØË™§:', error);
            showToast('ËÆÄÂèñË®∫ÁóáË®òÈåÑÂ§±Êïó', 'error');
            return;
        }
    }
    
    try {
        // Âæû Firebase Áç≤ÂèñÁóÖ‰∫∫Ë≥áÊñô
        const patientResult = await window.firebaseDataManager.getPatients();
        if (!patientResult.success) {
            showToast('ÁÑ°Ê≥ïËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
            return;
        }
        
        const patient = patientResult.data.find(p => p.id === consultation.patientId);
        if (!patient) {
            showToast('Êâæ‰∏çÂà∞ÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
            return;
        }
        
        // Áç≤ÂèñË®∫ÁóáÊó•ÊúüÔºàËôïÁêÜ Firebase TimestampÔºâ
        let consultationDate;
        if (consultation.date && consultation.date.seconds) {
            consultationDate = new Date(consultation.date.seconds * 1000);
        } else if (consultation.date) {
            consultationDate = new Date(consultation.date);
        } else {
            consultationDate = new Date();
        }
        
        // ÂâµÂª∫Âà∞Ë®∫Ë≠âÊòéÊ†ºÂºè
        const printContent = `
            <!DOCTYPE html>
            <html lang="zh-TW">
            <head>
                <meta charset="UTF-8">
                <title>Âà∞Ë®∫Ë≠âÊòéÊõ∏ - ${patient.name}</title>
                <style>
                    body { 
                        font-family: 'Microsoft JhengHei', 'ÂæÆËªüÊ≠£ÈªëÈ´î', sans-serif; 
                        margin: 0; 
                        padding: 8px; 
                        line-height: 1.3;
                        font-size: 10px;
                        background: white;
                    }
                    .certificate-container {
                        width: 148mm;
                        height: 210mm;
                        margin: 0 auto;
                        border: 3px solid #000;
                        padding: 8px;
                        background: white;
                        position: relative;
                        box-sizing: border-box;
                    }
                    .clinic-header {
                        text-align: center;
                        border-bottom: 2px solid #000;
                        padding-bottom: 10px;
                        margin-bottom: 15px;
                    }
                    .clinic-name {
                        font-size: 13px;
                        font-weight: bold;
                        margin-bottom: 3px;
                        letter-spacing: 1px;
                    }
                    .clinic-subtitle {
                        font-size: 10px;
                        color: #666;
                        margin-bottom: 4px;
                    }
                    .certificate-title {
                        font-size: 16px;
                        font-weight: bold;
                        text-align: center;
                        margin: 8px 0;
                        letter-spacing: 3px;
                        color: #000;
                    }
                    .certificate-number {
                        text-align: right;
                        font-size: 10px;
                        color: #666;
                        margin-bottom: 10px;
                    }
                    .content-section {
                        margin: 8px 0;
                        font-size: 10px;
                        line-height: 1.4;
                    }
                    .patient-info {
                        margin: 8px 0;
                    }
                    .info-row {
                        margin: 4px 0;
                        display: flex;
                        align-items: center;
                    }
                    .info-label {
                        font-weight: bold;
                        min-width: 80px;
                        display: inline-block;
                        font-size: 10px;
                    }
                    .info-value {
                        border-bottom: 1px solid #000;
                        min-width: 120px;
                        padding: 3px 6px;
                        margin-left: 6px;
                        font-size: 10px;
                    }
                    .attendance-section {
                        margin: 8px 0;
                        background: #e3f2fd;
                        padding: 6px;
                        border: 2px solid #2196f3;
                        border-radius: 4px;
                        text-align: center;
                    }
                    .attendance-title {
                        font-size: 11px;
                        font-weight: bold;
                        color: #1976d2;
                        margin-bottom: 4px;
                    }
                    .attendance-details {
                        font-size: 10px;
                        line-height: 1.3;
                    }
                    .doctor-signature {
                        margin-top: 10px;
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-end;
                    }
                    .signature-section {
                        text-align: center;
                    }
                    .signature-line {
                        border-bottom: 2px solid #000;
                        width: 60px;
                        height: 25px;
                        margin: 6px auto;
                        position: relative;
                    }
                    .signature-label {
                        font-size: 9px;
                        color: #666;
                        margin-top: 3px;
                    }
                    .date-section {
                        text-align: right;
                        font-size: 10px;
                    }
                    .footer-note {
                        margin-top: 15px;
                        padding-top: 8px;
                        border-top: 1px dashed #666;
                        font-size: 8px;
                        color: #666;
                        text-align: center;
                    }
                    .watermark {
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%) rotate(-45deg);
                        font-size: 80px;
                        color: rgba(0, 0, 0, 0.05);
                        font-weight: bold;
                        z-index: 0;
                        pointer-events: none;
                    }
                    .content {
                        position: relative;
                        z-index: 1;
                    }
                    @media print {
                        @page {
                            size: A5;
                            margin: 10mm;
                        }
                        body { 
                            margin: 0; 
                            padding: 0; 
                            font-size: 11px;
                        }
                        .certificate-container { 
                            border: 3px solid #000;
                            width: 100%;
                            height: 100%;
                            padding: 8mm;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="certificate-container">
                    <!-- ÊµÆÊ∞¥Âç∞ -->
                    <div class="watermark">Âà∞Ë®∫Ë≠âÊòé</div>
                    
                    <div class="content">
                        <!-- Ë®∫ÊâÄÊ®ôÈ°å -->
                        <div class="clinic-header">
                            <div class="clinic-name">${clinicSettings.chineseName || '‰∏≠ÈÜ´Ë®∫ÊâÄÁ≥ªÁµ±'}</div>
                            <div class="clinic-subtitle">${clinicSettings.englishName || 'TCM Clinic'}</div>
                            <div class="clinic-subtitle">ÈõªË©±Ôºö${clinicSettings.phone || '(852) 2345-6789'}„ÄÄÂú∞ÂùÄÔºö${clinicSettings.address || 'È¶ôÊ∏Ø‰∏≠Áí∞ÁöáÂêéÂ§ßÈÅì‰∏≠123Ëôü'}</div>
                        </div>
                        
                        <!-- Ë≠âÊòéÊõ∏Á∑®Ëôü -->
                        <div class="certificate-number">
                            Ë≠âÊòéÊõ∏Á∑®ËôüÔºöAC${consultation.id.toString().padStart(6, '0')}
                        </div>
                        
                        <!-- Ë≠âÊòéÊõ∏Ê®ôÈ°å -->
                        <div class="certificate-title">Âà∞Ë®∫Ë≠âÊòéÊõ∏</div>
                        
                        <!-- ÁóÖ‰∫∫Ë≥áË®ä -->
                        <div class="patient-info">
                            <div class="info-row">
                                <span class="info-label">Âßì„ÄÄ„ÄÄÂêçÔºö</span>
                                <span class="info-value">${patient.name}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ÊÄß„ÄÄ„ÄÄÂà•Ôºö</span>
                                <span class="info-value">${patient.gender}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Âπ¥„ÄÄ„ÄÄÈΩ°Ôºö</span>
                                <span class="info-value">${formatAge(patient.birthDate)}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Ë∫´ÂàÜË≠âËôüÔºö</span>
                                <span class="info-value">${patient.idCard || 'Êú™Êèê‰æõ'}</span>
                            </div>
                        </div>
                        
                        <!-- Âà∞Ë®∫Ë≥áË®ä -->
                        <div class="attendance-section">
                            <div class="attendance-title">Âà∞Ë®∫Ë≥áË®ä</div>
                            <div class="attendance-details">
                                <div><strong>Âà∞Ë®∫Êó•ÊúüÔºö</strong>${(() => {
                                    const visitDate = consultation.visitTime ? new Date(consultation.visitTime) : consultationDate;
                                    return visitDate.toLocaleDateString('zh-TW', {
                                        year: 'numeric',
                                        month: '2-digit',
                                        day: '2-digit'
                                    });
                                })()}</div>
                                <div><strong>Âà∞Ë®∫ÊôÇÈñìÔºö</strong>${(() => {
                                    const visitDate = consultation.visitTime ? new Date(consultation.visitTime) : consultationDate;
                                    return visitDate.toLocaleTimeString('zh-TW', {
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    });
                                })()}</div>
                            </div>
                        </div>
                        
                        <!-- Ë®∫ÁôÇË≥áË®ä -->
                        ${consultation.diagnosis ? `
                        <div class="content-section">
                            <div style="margin-bottom: 15px;">
                                <strong>Ë®∫Êñ∑ÁµêÊûúÔºö</strong>${consultation.diagnosis}
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="content-section">
                            <strong>Ëå≤Ë≠âÊòé‰∏äËø∞ÁóÖ‰∫∫Á¢∫ÂØ¶Êñº‰∏äËø∞Êó•ÊúüÊôÇÈñìÂà∞Êú¨Ë®∫ÊâÄÊé•Âèó‰∏≠ÈÜ´Ë®∫ÁôÇ„ÄÇ</strong>
                        </div>
                        
                        <div class="content-section">
                            <strong>ÁâπÊ≠§Ë≠âÊòé„ÄÇ</strong>
                        </div>
                        
                        <!-- ÈÜ´Â∏´Á∞ΩÂêçÂçÄ -->
                        <div class="doctor-signature">
                            <div class="signature-section">
                                <div class="signature-line"></div>
                                <div class="signature-label">‰∏ªÊ≤ªÈÜ´Â∏´Á∞ΩÂêç</div>
                                <div style="margin-top: 10px; font-weight: bold;">
                                    ${getDoctorDisplayName(consultation.doctor)}
                                </div>
                                ${(() => {
                                    const regNumber = getDoctorRegistrationNumber(consultation.doctor);
                                    return regNumber ? `
                                        <div style="margin-top: 5px; font-size: 12px; color: #666;">
                                            Ë®ªÂÜäÁ∑®ËôüÔºö${regNumber}
                                        </div>
                                    ` : '';
                                })()}
                            </div>
                            
                            <div class="date-section">
                                <div style="margin-bottom: 20px;">
                                    <strong>ÈñãÁ´ãÊó•ÊúüÔºö</strong><br>
                                    ${new Date().toLocaleDateString('zh-TW', {
                                        year: 'numeric',
                                        month: '2-digit',
                                        day: '2-digit'
                                    })}
                                </div>
                                <div style="border: 2px solid #000; padding: 15px; text-align: center; background: #f8f9fa;">
                                    <div style="font-weight: bold; margin-bottom: 5px;">Ë®∫ÊâÄÂç∞Á´†</div>
                                    <div style="font-size: 12px; color: #666;">(Ê≠§ËôïÊáâËìãË®∫ÊâÄÂç∞Á´†)</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- È†ÅÂ∞æË™™Êòé -->
                        <div class="footer-note">
                            <div>Êú¨Ë≠âÊòéÊõ∏ÂÉÖË≠âÊòéÂà∞Ë®∫‰∫ãÂØ¶ÔºåÂ¶ÇÊúâÁñëÂïèË´ãÊ¥ΩÊú¨Ë®∫ÊâÄ</div>
                            <div>Ë®∫ÊâÄÈõªË©±Ôºö${clinicSettings.phone || '(852) 2345-6789'} | ÁáüÊ•≠ÊôÇÈñìÔºö${clinicSettings.businessHours || 'ÈÄ±‰∏ÄËá≥ÈÄ±‰∫î 09:00-18:00'}</div>
                            <div style="margin-top: 10px; font-size: 10px;">
                                Ë≠âÊòéÊõ∏ÈñãÁ´ãÊôÇÈñìÔºö${new Date().toLocaleString('zh-TW')}
                            </div>
                        </div>
                    </div>
                </div>
            </body>
            </html>
        `;
        
        // ÈñãÂïüÊñ∞Ë¶ñÁ™óÈÄ≤Ë°åÂàóÂç∞
        const printWindow = window.open('', '_blank', 'width=700,height=900');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        
        showToast('Âà∞Ë®∫Ë≠âÊòéÊõ∏Â∑≤Ê∫ñÂÇôÂàóÂç∞ÔºÅ', 'success');
        
    } catch (error) {
        console.error('ÂàóÂç∞Âà∞Ë®∫Ë≠âÊòéÈåØË™§:', error);
        showToast('ÂàóÂç∞Âà∞Ë®∫Ë≠âÊòéÊôÇÁôºÁîüÈåØË™§', 'error');
    }
}
        
        // ÂàóÂç∞ÁóÖÂÅáË≠âÊòé
        async function printSickLeave(consultationId, consultationData = null) {
            const consultation = consultations.find(c => c.id === consultationId);
            if (!consultation) {
                showToast('Êâæ‰∏çÂà∞Ë®∫ÁóáË®òÈåÑÔºÅ', 'error');
                return;
            }
    try {            
const patientResult = await window.firebaseDataManager.getPatients();
if (!patientResult.success) {
    showToast('ÁÑ°Ê≥ïËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
    return;
}

const patient = patientResult.data.find(p => p.id === patientId);
if (!patient) {
    showToast('Êâæ‰∏çÂà∞ÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
    return;
}
            
            // ÂâµÂª∫ÁóÖÂÅáË≠âÊòéÊ†ºÂºè
            const printContent = `
                <!DOCTYPE html>
                <html lang="zh-TW">
                <head>
                    <meta charset="UTF-8">
                    <title>ÁóÖÂÅáË≠âÊòéÊõ∏ - ${patient.name}</title>
                    <style>
                        body { 
                            font-family: 'Microsoft JhengHei', 'ÂæÆËªüÊ≠£ÈªëÈ´î', sans-serif; 
                            margin: 0; 
                            padding: 8px; 
                            line-height: 1.3;
                            font-size: 10px;
                            background: white;
                        }
                        .certificate-container {
                            width: 148mm;
                            height: 210mm;
                            margin: 0 auto;
                            border: 3px solid #000;
                            padding: 8px;
                            background: white;
                            position: relative;
                            box-sizing: border-box;
                        }
                        .clinic-header {
                            text-align: center;
                            border-bottom: 2px solid #000;
                            padding-bottom: 10px;
                            margin-bottom: 15px;
                        }
                        .clinic-name {
                            font-size: 13px;
                            font-weight: bold;
                            margin-bottom: 3px;
                            letter-spacing: 1px;
                        }
                        .clinic-subtitle {
                            font-size: 10px;
                            color: #666;
                            margin-bottom: 4px;
                        }
                        .certificate-title {
                            font-size: 16px;
                            font-weight: bold;
                            text-align: center;
                            margin: 8px 0;
                            letter-spacing: 3px;
                            color: #000;
                        }
                        .certificate-number {
                            text-align: right;
                            font-size: 10px;
                            color: #666;
                            margin-bottom: 10px;
                        }
                        .content-section {
                            margin: 8px 0;
                            font-size: 10px;
                            line-height: 1.4;
                        }
                        .patient-info {
                            margin: 8px 0;
                        }
                        .info-row {
                            margin: 4px 0;
                            display: flex;
                            align-items: center;
                        }
                        .info-label {
                            font-weight: bold;
                            min-width: 80px;
                            display: inline-block;
                            font-size: 10px;
                        }
                        .info-value {
                            border-bottom: 1px solid #000;
                            min-width: 120px;
                            padding: 3px 6px;
                            margin-left: 6px;
                            font-size: 10px;
                        }
                        .diagnosis-section {
                            margin: 8px 0;
                            background: #f9f9f9;
                            padding: 6px;
                            border: 1px solid #ddd;
                            border-radius: 3px;
                        }
                        .rest-period {
                            margin: 8px 0;
                            font-size: 11px;
                            font-weight: bold;
                            text-align: center;
                            background: #fff3cd;
                            padding: 6px;
                            border: 2px solid #ffc107;
                            border-radius: 4px;
                        }
                        .doctor-signature {
                            margin-top: 10px;
                            display: flex;
                            justify-content: space-between;
                            align-items: flex-end;
                        }
                        .signature-section {
                            text-align: center;
                        }
                        .signature-line {
                            border-bottom: 2px solid #000;
                            width: 60px;
                            height: 25px;
                            margin: 6px auto;
                            position: relative;
                        }
                        .signature-label {
                            font-size: 9px;
                            color: #666;
                            margin-top: 3px;
                        }
                        .date-section {
                            text-align: right;
                            font-size: 10px;
                        }
                        .footer-note {
                            margin-top: 15px;
                            padding-top: 8px;
                            border-top: 1px dashed #666;
                            font-size: 8px;
                            color: #666;
                            text-align: center;
                        }
                        .watermark {
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%) rotate(-45deg);
                            font-size: 80px;
                            color: rgba(0, 0, 0, 0.05);
                            font-weight: bold;
                            z-index: 0;
                            pointer-events: none;
                        }
                        .content {
                            position: relative;
                            z-index: 1;
                        }
                        @media print {
                            @page {
                                size: A5;
                                margin: 10mm;
                            }
                            body { 
                                margin: 0; 
                                padding: 0; 
                                font-size: 11px;
                            }
                            .certificate-container { 
                                border: 3px solid #000;
                                width: 100%;
                                height: 100%;
                                padding: 8mm;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="certificate-container">
                        <!-- ÊµÆÊ∞¥Âç∞ -->
                        <div class="watermark">ÁóÖÂÅáË≠âÊòé</div>
                        
                        <div class="content">
                            <!-- Ë®∫ÊâÄÊ®ôÈ°å -->
                            <div class="clinic-header">
                                <div class="clinic-name">${clinicSettings.chineseName || '‰∏≠ÈÜ´Ë®∫ÊâÄÁ≥ªÁµ±'}</div>
                                <div class="clinic-subtitle">${clinicSettings.englishName || 'TCM Clinic'}</div>
                                <div class="clinic-subtitle">ÈõªË©±Ôºö${clinicSettings.phone || '(852) 2345-6789'}„ÄÄÂú∞ÂùÄÔºö${clinicSettings.address || 'È¶ôÊ∏Ø‰∏≠Áí∞ÁöáÂêéÂ§ßÈÅì‰∏≠123Ëôü'}</div>
                            </div>
                            
                            <!-- Ë≠âÊòéÊõ∏Á∑®Ëôü -->
                            <div class="certificate-number">
                                Ë≠âÊòéÊõ∏Á∑®ËôüÔºöSL${consultation.id.toString().padStart(6, '0')}
                            </div>
                            
                            <!-- Ë≠âÊòéÊõ∏Ê®ôÈ°å -->
                            <div class="certificate-title">ÁóÖÂÅáË≠âÊòéÊõ∏</div>
                            
                            <!-- ÁóÖ‰∫∫Ë≥áË®ä -->
                            <div class="patient-info">
                                <div class="info-row">
                                    <span class="info-label">Âßì„ÄÄ„ÄÄÂêçÔºö</span>
                                    <span class="info-value">${patient.name}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">ÊÄß„ÄÄ„ÄÄÂà•Ôºö</span>
                                    <span class="info-value">${patient.gender}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Âπ¥„ÄÄ„ÄÄÈΩ°Ôºö</span>
                                    <span class="info-value">${formatAge(patient.birthDate)}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Ë∫´ÂàÜË≠âËôüÔºö</span>
                                    <span class="info-value">${patient.idCard || 'Êú™Êèê‰æõ'}</span>
                                </div>
                            </div>
                            
                            <!-- Ë®∫Êñ∑Ë≥áË®ä -->
                            <div class="diagnosis-section">
                                <div style="margin-bottom: 15px;">
                                    <strong>Ë®∫ÁôÇÊó•ÊúüÔºö</strong>${(() => {
                                        const visitDate = consultation.visitTime ? new Date(consultation.visitTime) : new Date(consultation.date);
                                        return visitDate.toLocaleDateString('zh-TW', {
                                            year: 'numeric',
                                            month: '2-digit',
                                            day: '2-digit'
                                        });
                                    })()}
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <strong>Ë®∫Êñ∑ÁµêÊûúÔºö</strong>${consultation.diagnosis || 'ÈúÄË¶Å‰ºëÊÅØË™øÈ§ä'}
                                </div>
                            </div>
                            
                            <!-- Âª∫Ë≠∞‰ºëÊÅØÊúüÈñì -->
                            <div class="rest-period">
                                Âª∫Ë≠∞‰ºëÊÅØÊúüÈñìÔºö${(() => {
                                    // ÂÑ™ÂÖà‰ΩøÁî®Ë®∫ÁóáË®òÈåÑ‰∏≠ÁöÑ‰ºëÊÅØÊúüÈñìË®≠ÂÆö
                                    if (consultation.restStartDate && consultation.restEndDate) {
                                        const startDate = new Date(consultation.restStartDate);
                                        const endDate = new Date(consultation.restEndDate);
                                        const timeDiff = endDate.getTime() - startDate.getTime();
                                        const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1; // ÂåÖÂê´ÈñãÂßãÂíåÁµêÊùüÊó•Êúü
                                        
                                        return `${startDate.toLocaleDateString('zh-TW')} Ëá≥ ${endDate.toLocaleDateString('zh-TW')} (ÂÖ± ${daysDiff} Â§©)`;
                                    }
                                    
                                    // Â¶ÇÊûúÊ≤íÊúâË®≠ÂÆö‰ºëÊÅØÊúüÈñìÔºå‰ΩøÁî®ËàäÁöÑÈÇèËºØ
                                    let restDays = consultation.restDays ? parseInt(consultation.restDays) : 3;
                                    
                                    // Â¶ÇÊûúÊ≤íÊúâË®≠ÂÆö‰ºëÊÅØÂ§©Êï∏ÔºåÂâáÊ†πÊìöÊ≤ªÁôÇÁôÇÁ®ãÊé®ÁÆó
                                    if (!consultation.restDays) {
                                        const treatmentCourse = consultation.treatmentCourse || '‰∏ÄÂë®';
                                        
                                        if (treatmentCourse.includes('Â§©')) {
                                            const match = treatmentCourse.match(/(\d+)Â§©/);
                                            if (match) {
                                                restDays = Math.min(parseInt(match[1]), 7); // ÊúÄÂ§ö7Â§©
                                            }
                                        } else if (treatmentCourse.includes('ÈÄ±') || treatmentCourse.includes('Âë®')) {
                                            const match = treatmentCourse.match(/(\d+)[ÈÄ±Âë®]/);
                                            if (match) {
                                                restDays = Math.min(parseInt(match[1]) * 7, 7); // ÊúÄÂ§ö7Â§©
                                            }
                                        }
                                    }
                                    
                                    // ‰ΩøÁî®Âà∞Ë®∫ÊôÇÈñì‰ΩúÁÇ∫Ëµ∑ÂßãÊó•ÊúüÔºåÂ¶ÇÊûúÊ≤íÊúâÂâá‰ΩøÁî®Ë®∫ÁóáÊó•Êúü
                                    const startDate = consultation.visitTime ? new Date(consultation.visitTime) : new Date(consultation.date);
                                    const endDate = new Date(startDate);
                                    endDate.setDate(startDate.getDate() + restDays - 1);
                                    
                                    return `${startDate.toLocaleDateString('zh-TW')} Ëá≥ ${endDate.toLocaleDateString('zh-TW')} (ÂÖ± ${restDays} Â§©)`;
                                })()}
                            </div>
                            
                            <!-- ÈÜ´Âõë -->
                            ${consultation.instructions ? `
                            <div class="content-section">
                                <strong>ÈÜ´Â∏´Âª∫Ë≠∞Ôºö</strong><br>
                                ${consultation.instructions}
                            </div>
                            ` : ''}
                            
                            <div class="content-section">
                                <strong>ÁâπÊ≠§Ë≠âÊòé„ÄÇ</strong>
                            </div>
                            
                            <!-- ÈÜ´Â∏´Á∞ΩÂêçÂçÄ -->
                            <div class="doctor-signature">
                                <div class="signature-section">
                                    <div class="signature-line"></div>
                                    <div class="signature-label">‰∏ªÊ≤ªÈÜ´Â∏´Á∞ΩÂêç</div>
                                    <div style="margin-top: 10px; font-weight: bold;">
                                        ${getDoctorDisplayName(consultation.doctor)}
                                    </div>
                                    ${(() => {
                                        const regNumber = getDoctorRegistrationNumber(consultation.doctor);
                                        return regNumber ? `
                                            <div style="margin-top: 5px; font-size: 12px; color: #666;">
                                                Ë®ªÂÜäÁ∑®ËôüÔºö${regNumber}
                                            </div>
                                        ` : '';
                                    })()}
                                </div>
                                
                                <div class="date-section">
                                    <div style="margin-bottom: 20px;">
                                        <strong>ÈñãÁ´ãÊó•ÊúüÔºö</strong><br>
                                        ${new Date().toLocaleDateString('zh-TW', {
                                            year: 'numeric',
                                            month: '2-digit',
                                            day: '2-digit'
                                        })}
                                    </div>
                                    <div style="border: 2px solid #000; padding: 15px; text-align: center; background: #f8f9fa;">
                                        <div style="font-weight: bold; margin-bottom: 5px;">Ë®∫ÊâÄÂç∞Á´†</div>
                                        <div style="font-size: 12px; color: #666;">(Ê≠§ËôïÊáâËìãË®∫ÊâÄÂç∞Á´†)</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- È†ÅÂ∞æË™™Êòé -->
                            <div class="footer-note">
                                <div>Êú¨Ë≠âÊòéÊõ∏ÂÉÖ‰æõË´ãÂÅá‰ΩøÁî®ÔºåÂ¶ÇÊúâÁñëÂïèË´ãÊ¥ΩÊú¨Ë®∫ÊâÄ</div>
                                <div>Ë®∫ÊâÄÈõªË©±Ôºö${clinicSettings.phone || '(852) 2345-6789'} | ÁáüÊ•≠ÊôÇÈñìÔºö${clinicSettings.businessHours || 'ÈÄ±‰∏ÄËá≥ÈÄ±‰∫î 09:00-18:00'}</div>
                                <div style="margin-top: 10px; font-size: 10px;">
                                    Ë≠âÊòéÊõ∏ÈñãÁ´ãÊôÇÈñìÔºö${new Date().toLocaleString('zh-TW')}
                                </div>
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            // ÈñãÂïüÊñ∞Ë¶ñÁ™óÈÄ≤Ë°åÂàóÂç∞
            const printWindow = window.open('', '_blank', 'width=700,height=900');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            
            showToast('ÁóÖÂÅáË≠âÊòéÊõ∏Â∑≤Ê∫ñÂÇôÂàóÂç∞ÔºÅ', 'success');
            } catch (error) {
        console.error('ËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñôÈåØË™§:', error);
        showToast('ËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñôÂ§±Êïó', 'error');
    }
        }

        // Êí§ÂõûË®∫ÁóáÂäüËÉΩ
        async function withdrawConsultation(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) {
                showToast('Êâæ‰∏çÂà∞ÊéõËôüË®òÈåÑÔºÅ', 'error');
                return;
            }
    try {             
const patientResult = await window.firebaseDataManager.getPatients();
if (!patientResult.success) {
    showToast('ÁÑ°Ê≥ïËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
    return;
}

const patient = patientResult.data.find(p => p.id === patientId);
if (!patient) {
    showToast('Êâæ‰∏çÂà∞ÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
    return;
}
            
            // Ë©≥Á¥∞ÁãÄÊÖãÊ™¢Êü•
            console.log(`Êí§ÂõûË®∫ÁóáÁãÄÊÖãÊ™¢Êü• - ÁóÖ‰∫∫: ${patient.name}, Áï∂ÂâçÁãÄÊÖã: ${appointment.status}, Ë®∫ÁóáË®òÈåÑID: ${appointment.consultationId}`);
            
            // Âè™ÊúâÂ∑≤ÂÆåÊàêÁöÑË®∫ÁóáÊâçËÉΩÊí§Âõû
            if (appointment.status !== 'completed') {
                const statusNames = {
                    'registered': 'Â∑≤ÊéõËôü',
                    'waiting': 'ÂÄôË®∫‰∏≠',
                    'consulting': 'Ë®∫Áóá‰∏≠'
                };
                const currentStatusName = statusNames[appointment.status] || appointment.status;
                showToast(`ÁÑ°Ê≥ïÊí§ÂõûË®∫ÁóáÔºÅÁóÖ‰∫∫ ${patient.name} ÁõÆÂâçÁãÄÊÖãÁÇ∫„Äå${currentStatusName}„ÄçÔºåÂè™ËÉΩÊí§ÂõûÂ∑≤ÂÆåÊàêÁöÑË®∫Áóá„ÄÇ`, 'warning');
                return;
            }
            
            // Ê™¢Êü•ÊòØÂê¶ÊúâË®∫ÁóáË®òÈåÑ
            if (!appointment.consultationId) {
                showToast(`ÁÑ°Ê≥ïÊí§ÂõûË®∫ÁóáÔºÅÁóÖ‰∫∫ ${patient.name} Ê≤íÊúâÂ∞çÊáâÁöÑË®∫ÁóáË®òÈåÑ„ÄÇ`, 'error');
                return;
            }
            
            const consultation = consultations.find(c => c.id === appointment.consultationId);
            if (!consultation) {
                showToast(`ÁÑ°Ê≥ïÊí§ÂõûË®∫ÁóáÔºÅÊâæ‰∏çÂà∞ÁóÖ‰∫∫ ${patient.name} ÁöÑË®∫ÁóáË®òÈåÑË≥áÊñô„ÄÇ`, 'error');
                return;
            }
            
            // Á¢∫Ë™çÊí§ÂõûÊìç‰Ωú
            const confirmMessage = `Á¢∫ÂÆöË¶ÅÊí§Âõû ${patient.name} ÁöÑË®∫ÁóáÂóéÔºü\n\n` +
                                 `Ê≠§Êìç‰ΩúÂ∞áÊúÉÔºö\n` +
                                 `‚Ä¢ Âà™Èô§Ë©≤Ê¨°Ë®∫ÁóáË®òÈåÑ\n` +
                                 `‚Ä¢ ÁóÖ‰∫∫ÁãÄÊÖãÂõûÂà∞„ÄåÂ∑≤ÊéõËôü„Äç\n` +
                                 `‚Ä¢ ÊâÄÊúâË®∫ÁóáË≥áÊñôÂ∞áÊ∞∏‰πÖÈÅ∫Â§±\n\n` +
                                 `Ë®∫ÁóáÊó•ÊúüÔºö${new Date(consultation.date).toLocaleString('zh-TW')}\n` +
                                 `Ë®∫Êñ∑Ôºö${consultation.diagnosis || 'ÁÑ°Ë®òÈåÑ'}\n\n` +
                                 `Ê≥®ÊÑèÔºöÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ`;
            
            if (confirm(confirmMessage)) {
                // Âà™Èô§Ë®∫ÁóáË®òÈåÑ
                const consultationIndex = consultations.findIndex(c => c.id === appointment.consultationId);
                if (consultationIndex !== -1) {
                    consultations.splice(consultationIndex, 1);
                    localStorage.setItem('consultations', JSON.stringify(consultations));
                }
                
                // Â∞áÊéõËôüÁãÄÊÖãÊîπÂõûÂ∑≤ÊéõËôü
                appointment.status = 'registered';
                delete appointment.completedAt;
                delete appointment.consultationId;
                delete appointment.completedBy;
                delete appointment.consultationStartTime;
                delete appointment.consultingDoctor;
                
                // ‰øùÂ≠òÁãÄÊÖãËÆäÊõ¥
                localStorage.setItem('appointments', JSON.stringify(appointments));
                
                showToast(`Â∑≤Êí§Âõû ${patient.name} ÁöÑË®∫ÁóáÔºåÁóÖ‰∫∫ÁãÄÊÖãÂõûÂà∞Â∑≤ÊéõËôü`, 'success');
                
                // Â¶ÇÊûúÊ≠£Âú®Á∑®ËºØË©≤ÁóÖÊ≠∑ÔºåÂâáÈóúÈñâË°®ÂñÆ
                if (currentConsultingAppointmentId === appointmentId) {
                    closeConsultationForm();
                    currentConsultingAppointmentId = null;
                }
                
                // ÈáçÊñ∞ËºâÂÖ•ÂàóË°®ÂíåÁµ±Ë®à
                loadTodayAppointments();
                updateStatistics();
            }
            } catch (error) {
        console.error('ËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñôÈåØË™§:', error);
        showToast('ËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñôÂ§±Êïó', 'error');
    }
        }

        // ‰øÆÊîπÁóÖÊ≠∑ÂäüËÉΩ
        async function editMedicalRecord(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) {
                showToast('Êâæ‰∏çÂà∞ÊéõËôüË®òÈåÑÔºÅ', 'error');
                return;
            }
    try {            
const patientResult = await window.firebaseDataManager.getPatients();
if (!patientResult.success) {
    showToast('ÁÑ°Ê≥ïËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
    return;
}

const patient = patientResult.data.find(p => p.id === patientId);
if (!patient) {
    showToast('Êâæ‰∏çÂà∞ÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
    return;
}
            
            // Ë©≥Á¥∞ÁãÄÊÖãÊ™¢Êü•
            console.log(`‰øÆÊîπÁóÖÊ≠∑ÁãÄÊÖãÊ™¢Êü• - ÁóÖ‰∫∫: ${patient.name}, Áï∂ÂâçÁãÄÊÖã: ${appointment.status}, Ë®∫ÁóáË®òÈåÑID: ${appointment.consultationId}`);
            
            // Âè™ÊúâÂ∑≤ÂÆåÊàêÁöÑË®∫ÁóáÊâçËÉΩ‰øÆÊîπÁóÖÊ≠∑
            if (appointment.status !== 'completed') {
                const statusNames = {
                    'registered': 'Â∑≤ÊéõËôü',
                    'waiting': 'ÂÄôË®∫‰∏≠',
                    'consulting': 'Ë®∫Áóá‰∏≠'
                };
                const currentStatusName = statusNames[appointment.status] || appointment.status;
                showToast(`ÁÑ°Ê≥ï‰øÆÊîπÁóÖÊ≠∑ÔºÅÁóÖ‰∫∫ ${patient.name} ÁõÆÂâçÁãÄÊÖãÁÇ∫„Äå${currentStatusName}„ÄçÔºåÂè™ËÉΩ‰øÆÊîπÂ∑≤ÂÆåÊàêË®∫ÁóáÁöÑÁóÖÊ≠∑„ÄÇ`, 'warning');
                return;
            }
            
            // Ê™¢Êü•ÊòØÂê¶ÊúâË®∫ÁóáË®òÈåÑ
            if (!appointment.consultationId) {
                showToast(`ÁÑ°Ê≥ï‰øÆÊîπÁóÖÊ≠∑ÔºÅÁóÖ‰∫∫ ${patient.name} Ê≤íÊúâÂ∞çÊáâÁöÑË®∫ÁóáË®òÈåÑ„ÄÇ`, 'error');
                return;
            }
            
            const consultation = consultations.find(c => c.id === appointment.consultationId);
            if (!consultation) {
                showToast(`ÁÑ°Ê≥ï‰øÆÊîπÁóÖÊ≠∑ÔºÅÊâæ‰∏çÂà∞ÁóÖ‰∫∫ ${patient.name} ÁöÑË®∫ÁóáË®òÈåÑË≥áÊñô„ÄÇ`, 'error');
                return;
            }
            
            // Ê™¢Êü•ÊòØÂê¶ÊúâÂÖ∂‰ªñÁóÖ‰∫∫Ê≠£Âú®Ë®∫Áóá‰∏≠
            const consultingAppointment = appointments.find(apt => 
                apt.status === 'consulting' && 
                new Date(apt.appointmentTime).toDateString() === new Date().toDateString()
            );
            
            if (consultingAppointment) {
                const consultingPatient = patients.find(p => p.id === consultingAppointment.patientId);
                const consultingPatientName = consultingPatient ? consultingPatient.name : 'Êú™Áü•ÁóÖ‰∫∫';
                
                if (confirm(`ÁõÆÂâç ${consultingPatientName} Ê≠£Âú®Ë®∫Áóá‰∏≠„ÄÇ\n\nÊòØÂê¶Ë¶ÅÁµêÊùüË©≤ÁóÖ‰∫∫ÁöÑË®∫Áóá‰∏¶ÈñãÂßã‰øÆÊîπ ${patient.name} ÁöÑÁóÖÊ≠∑Ôºü\n\nÊ≥®ÊÑèÔºö${consultingPatientName} ÁöÑÁãÄÊÖãÂ∞áÊîπÂõûÂÄôË®∫‰∏≠„ÄÇ`)) {
                    // ÁµêÊùüÁï∂ÂâçË®∫ÁóáÁöÑÁóÖ‰∫∫
                    consultingAppointment.status = 'waiting';
                    delete consultingAppointment.consultationStartTime;
                    delete consultingAppointment.consultingDoctor;
                    
                    // ÈóúÈñâÂèØËÉΩÈñãÂïüÁöÑË®∫ÁóáË°®ÂñÆ
                    if (currentConsultingAppointmentId === consultingAppointment.id) {
                        closeConsultationForm();
                    }
                    
                    showToast(`Â∑≤ÁµêÊùü ${consultingPatientName} ÁöÑË®∫Áóá`, 'info');
                    localStorage.setItem('appointments', JSON.stringify(appointments));
                } else {
                    return; // Áî®Êà∂ÂèñÊ∂àÊìç‰Ωú
                }
            }
            
            // Ë®≠ÁΩÆÁÇ∫Á∑®ËºØÊ®°Âºè
            currentConsultingAppointmentId = appointmentId;
            showConsultationForm(appointment);
            
            showToast(`ÈÄ≤ÂÖ• ${patient.name} ÁöÑÁóÖÊ≠∑Á∑®ËºØÊ®°Âºè`, 'info');
            } catch (error) {
        console.error('ËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñôÈåØË™§:', error);
        showToast('ËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñôÂ§±Êïó', 'error');
    }
        }


// ËºâÂÖ•ÁóÖ‰∫∫Ë®∫ÁóáË®òÈåÑÊëòË¶Å
async function loadPatientConsultationSummary(patientId) {
    const summaryContainer = document.getElementById('patientConsultationSummary');
    
    try {
        const result = await window.firebaseDataManager.getPatientConsultations(patientId);
        
        if (!result.success) {
            summaryContainer.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <div class="text-4xl mb-2">‚ùå</div>
                    <div>ÁÑ°Ê≥ïËºâÂÖ•Ë®∫ÁóáË®òÈåÑ</div>
                </div>
            `;
            return;
        }

        const consultations = result.data;
        const totalConsultations = consultations.length;
        const lastConsultation = consultations[0]; // ÊúÄÊñ∞ÁöÑË®∫ÁóáË®òÈåÑ

        if (totalConsultations === 0) {
            summaryContainer.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="bg-blue-50 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-blue-600">0</div>
                        <div class="text-sm text-blue-800">Á∏ΩË®∫ÁóáÊ¨°Êï∏</div>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4 text-center">
                        <div class="text-lg font-semibold text-green-600">ÁÑ°</div>
                        <div class="text-sm text-green-800">ÊúÄËøëË®∫Áóá</div>
                    </div>
                    <div class="bg-orange-50 rounded-lg p-4 text-center">
                        <div class="text-lg font-semibold text-orange-600">ÁÑ°ÂÆâÊéí</div>
                        <div class="text-sm text-orange-800">‰∏ãÊ¨°Ë§áË®∫</div>
                    </div>
                </div>
                <div class="text-center py-8 text-gray-500">
                    <div class="text-4xl mb-2">üìã</div>
                    <div>Â∞öÁÑ°Ë®∫ÁóáË®òÈåÑ</div>
                </div>
            `;
            return;
        }

        // Ê†ºÂºèÂåñÊúÄÂæåË®∫ÁóáÊó•Êúü
        const lastConsultationDate = lastConsultation.date ? 
            new Date(lastConsultation.date.seconds * 1000).toLocaleDateString('zh-TW') : 
            new Date(lastConsultation.createdAt.seconds * 1000).toLocaleDateString('zh-TW');

        // Ê†ºÂºèÂåñ‰∏ãÊ¨°Ë§áË®∫Êó•Êúü
        const nextFollowUp = lastConsultation.followUpDate ? 
            new Date(lastConsultation.followUpDate).toLocaleDateString('zh-TW') : 'ÁÑ°ÂÆâÊéí';

        summaryContainer.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div class="bg-blue-50 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-blue-600">${totalConsultations}</div>
                    <div class="text-sm text-blue-800">Á∏ΩË®∫ÁóáÊ¨°Êï∏</div>
                </div>
                <div class="bg-green-50 rounded-lg p-4 text-center">
                    <div class="text-lg font-semibold text-green-600">${lastConsultationDate}</div>
                    <div class="text-sm text-green-800">ÊúÄËøëË®∫Áóá</div>
                </div>
                <div class="bg-orange-50 rounded-lg p-4 text-center">
                    <div class="text-lg font-semibold text-orange-600">${nextFollowUp}</div>
                    <div class="text-sm text-orange-800">‰∏ãÊ¨°Ë§áË®∫</div>
                </div>
            </div>
            
            <div class="bg-gray-50 rounded-lg p-4">
                <h5 class="font-medium text-gray-800 mb-2">ÊúÄËøëË®∫ÁóáË®òÈåÑ</h5>
                <div class="text-sm text-gray-700">
                    <div><span class="font-medium">Ë®∫Êñ∑Ôºö</span>${lastConsultation.diagnosis || 'ÁÑ°Ë®òÈåÑ'}</div>
                    <div class="mt-1"><span class="font-medium">Ë≠âÂûãÔºö</span>${lastConsultation.syndrome || 'ÁÑ°Ë®òÈåÑ'}</div>
                    ${lastConsultation.instructions ? `<div class="mt-1"><span class="font-medium">ÈÜ´ÂõëÔºö</span>${lastConsultation.instructions}</div>` : ''}
                </div>
                <div class="mt-3">
                    <button onclick="viewPatientMedicalHistory('${patientId}')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm transition duration-200">
                        Êü•ÁúãÂÆåÊï¥ÁóÖÊ≠∑
                    </button>
                </div>
            </div>
        `;

    } catch (error) {
        console.error('ËºâÂÖ•Ë®∫ÁóáË®òÈåÑÊëòË¶ÅÈåØË™§:', error);
        summaryContainer.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <div class="text-4xl mb-2">‚ùå</div>
                <div>ËºâÂÖ•Ë®∫ÁóáË®òÈåÑÂ§±Êïó</div>
            </div>
        `;
    }
}

        
// 6. ‰øÆÊîπÊõ¥Êñ∞Áµ±Ë®àÂäüËÉΩ
async function updateStatistics() {
    try {
        // Â¶ÇÊûú Firebase Êï∏ÊìöÁÆ°ÁêÜÂô®Â∞öÊú™ÂàùÂßãÂåñÊàñÂ∞öÊú™Ê∫ñÂÇôÂ•ΩÔºåÂâáË∑≥ÈÅéÁµ±Ë®àÊõ¥Êñ∞„ÄÇ
        if (!window.firebaseDataManager || !window.firebaseDataManager.isReady) {
            console.log('Firebase Êï∏ÊìöÁÆ°ÁêÜÂô®Â∞öÊú™Ê∫ñÂÇôÂ∞±Á∑íÔºåÁµ±Ë®àË≥áË®äÂ∞áÁ®çÂæåÊõ¥Êñ∞');
            return;
        }
        // Âæû Firebase Áç≤ÂèñÁóÖ‰∫∫Á∏ΩÊï∏
        const result = await window.firebaseDataManager.getPatients();
        const totalPatients = result.success ? result.data.length : 0;
        
        // Êõ¥Êñ∞ÁóÖ‰∫∫Á∏ΩÊï∏È°ØÁ§∫
        const totalPatientsElement = document.getElementById('totalPatients');
        if (totalPatientsElement) {
            totalPatientsElement.textContent = totalPatients;
        }
        
        // Ë®àÁÆó‰ªäÊó•Ë®∫ÁóáÊï∏ÔºàÂæûÊú¨Âú∞appointmentsË®àÁÆóÔºåÂõ†ÁÇ∫ÊéõËôüÁ≥ªÁµ±Â∞öÊú™ÁßªÂà∞FirebaseÔºâ
        const today = new Date().toDateString();
        const todayConsultations = appointments.filter(apt => 
            apt.status === 'completed' && 
            new Date(apt.appointmentTime).toDateString() === today
        ).length;
        
        const todayConsultationsElement = document.getElementById('todayConsultations');
        if (todayConsultationsElement) {
            todayConsultationsElement.textContent = todayConsultations;
        }
        
        // Ë®àÁÆóÊú¨ÊúàË®∫ÁóáÊï∏
        const thisMonth = new Date();
        const monthlyConsultations = appointments.filter(apt => 
            apt.status === 'completed' && 
            new Date(apt.appointmentTime).getMonth() === thisMonth.getMonth() &&
            new Date(apt.appointmentTime).getFullYear() === thisMonth.getFullYear()
        ).length;
        
        const monthlyConsultationsElement = document.getElementById('monthlyConsultations');
        if (monthlyConsultationsElement) {
            monthlyConsultationsElement.textContent = monthlyConsultations;
        }
        
    } catch (error) {
        console.error('Êõ¥Êñ∞Áµ±Ë®àÈåØË™§:', error);
        // Â¶ÇÊûú Firebase ËÆÄÂèñÂ§±ÊïóÔºåÈ°ØÁ§∫ 0
        const totalPatientsElement = document.getElementById('totalPatients');
        if (totalPatientsElement) {
            totalPatientsElement.textContent = '0';
        }
    }
}
        function exportData() {
            const data = {
                patients: patients,
                consultations: consultations,
                appointments: appointments,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Ë®∫ÊâÄË≥áÊñô_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Ë≥áÊñôÂåØÂá∫ÂÆåÊàêÔºÅ', 'success');
        }

        function backupData() {
            const backup = {
                patients: patients,
                consultations: consultations,
                appointments: appointments,
                backupDate: new Date().toISOString()
            };
            localStorage.setItem('clinicBackup', JSON.stringify(backup));
            showToast('Ë≥áÊñôÂÇô‰ªΩÂÆåÊàêÔºÅ', 'success');
        }

        function clearData() {
            if (confirm('Ë≠¶ÂëäÔºöÊ≠§Êìç‰ΩúÂ∞áÊ∏ÖÈô§ÊâÄÊúâË≥áÊñôÔºåÁ¢∫ÂÆöË¶ÅÁπºÁ∫åÂóéÔºü')) {
                if (confirm('ÊúÄÂæåÁ¢∫Ë™çÔºöÊâÄÊúâÁóÖ‰∫∫Ë≥áÊñôÂíåË®∫ÁóáË®òÈåÑÂ∞áË¢´Ê∞∏‰πÖÂà™Èô§ÔºÅ')) {
                    localStorage.removeItem('patients');
                    localStorage.removeItem('consultations');
                    localStorage.removeItem('appointments');
                    patients = [];
                    consultations = [];
                    appointments = [];
                    updateStatistics();
                    showToast('ÊâÄÊúâË≥áÊñôÂ∑≤Ê∏ÖÈô§ÔºÅ', 'success');
                }
            }
        }

        // Ë®∫ÊâÄË®≠ÂÆöÁÆ°ÁêÜÂäüËÉΩ
        function showClinicSettingsModal() {
            // ËºâÂÖ•ÁèæÊúâË®≠ÂÆö
            document.getElementById('clinicChineseName').value = clinicSettings.chineseName || '';
            document.getElementById('clinicEnglishName').value = clinicSettings.englishName || '';
            document.getElementById('clinicBusinessHours').value = clinicSettings.businessHours || '';
            document.getElementById('clinicPhone').value = clinicSettings.phone || '';
            document.getElementById('clinicAddress').value = clinicSettings.address || '';
            
            document.getElementById('clinicSettingsModal').classList.remove('hidden');
        }
        
        function hideClinicSettingsModal() {
            document.getElementById('clinicSettingsModal').classList.add('hidden');
        }
        
        function saveClinicSettings() {
            const chineseName = document.getElementById('clinicChineseName').value.trim();
            const englishName = document.getElementById('clinicEnglishName').value.trim();
            const businessHours = document.getElementById('clinicBusinessHours').value.trim();
            const phone = document.getElementById('clinicPhone').value.trim();
            const address = document.getElementById('clinicAddress').value.trim();
            
            if (!chineseName) {
                showToast('Ë´ãËº∏ÂÖ•Ë®∫ÊâÄ‰∏≠ÊñáÂêçÁ®±ÔºÅ', 'error');
                return;
            }
            
            // Êõ¥Êñ∞Ë®∫ÊâÄË®≠ÂÆö
            clinicSettings.chineseName = chineseName;
            clinicSettings.englishName = englishName;
            clinicSettings.businessHours = businessHours;
            clinicSettings.phone = phone;
            clinicSettings.address = address;
            clinicSettings.updatedAt = new Date().toISOString();
            
            // ‰øùÂ≠òÂà∞Êú¨Âú∞ÂÑ≤Â≠ò
            localStorage.setItem('clinicSettings', JSON.stringify(clinicSettings));
            
            // Êõ¥Êñ∞Á≥ªÁµ±ÁÆ°ÁêÜÈ†ÅÈù¢ÁöÑÈ°ØÁ§∫
            updateClinicSettingsDisplay();
            
            hideClinicSettingsModal();
            showToast('Ë®∫ÊâÄË≥áÊñôÂ∑≤ÊàêÂäüÊõ¥Êñ∞ÔºÅ', 'success');
        }
        
        function updateClinicSettingsDisplay() {
            // Êõ¥Êñ∞Á≥ªÁµ±ÁÆ°ÁêÜÈ†ÅÈù¢ÁöÑË®∫ÊâÄË®≠ÂÆöÈ°ØÁ§∫
            const chineseNameSpan = document.getElementById('displayChineseName');
            const englishNameSpan = document.getElementById('displayEnglishName');
            
            if (chineseNameSpan) {
                chineseNameSpan.textContent = clinicSettings.chineseName || '‰∏≠ÈÜ´Ë®∫ÊâÄÁ≥ªÁµ±';
            }
            if (englishNameSpan) {
                englishNameSpan.textContent = clinicSettings.englishName || 'TCM Clinic';
            }
            
            // Êõ¥Êñ∞ÁôªÂÖ•È†ÅÈù¢ÁöÑË®∫ÊâÄÂêçÁ®±
            const loginTitle = document.getElementById('loginTitle');
            const loginEnglishTitle = document.getElementById('loginEnglishTitle');
            if (loginTitle) {
                loginTitle.textContent = clinicSettings.chineseName || '‰∏≠ÈÜ´Ë®∫ÊâÄÁ≥ªÁµ±';
            }
            if (loginEnglishTitle) {
                loginEnglishTitle.textContent = clinicSettings.englishName || 'TCM Clinic';
            }
            
            // Êõ¥Êñ∞‰∏ªÈ†ÅÈù¢ÁöÑË®∫ÊâÄÂêçÁ®±
            const systemTitle = document.getElementById('systemTitle');
            const systemEnglishTitle = document.getElementById('systemEnglishTitle');
            if (systemTitle) {
                systemTitle.textContent = clinicSettings.chineseName || '‰∏≠ÈÜ´Ë®∫ÊâÄÁ≥ªÁµ±';
            }
            if (systemEnglishTitle) {
                systemEnglishTitle.textContent = clinicSettings.englishName || 'TCM Clinic';
            }
            
            // Êõ¥Êñ∞Ê≠°ËøéÈ†ÅÈù¢ÁöÑË®∫ÊâÄÂêçÁ®±
            const welcomeTitle = document.getElementById('welcomeTitle');
            const welcomeEnglishTitle = document.getElementById('welcomeEnglishTitle');
            if (welcomeTitle) {
                welcomeTitle.textContent = `Ê≠°Ëøé‰ΩøÁî®${clinicSettings.chineseName || '‰∏≠ÈÜ´Ë®∫ÊâÄÁ≥ªÁµ±'}`;
            }
            if (welcomeEnglishTitle) {
                welcomeEnglishTitle.textContent = `Welcome to ${clinicSettings.englishName || 'TCM Clinic'}`;
            }
        }



        // ‰∏≠Ëó•Â∫´ÁÆ°ÁêÜÂäüËÉΩ
        let editingHerbId = null;
        let editingFormulaId = null;
        let currentHerbFilter = 'all';
        
        async function loadHerbLibrary() {
            // ÈÄ≤ÂÖ•‰∏≠Ëó•Â∫´È†ÅÈù¢ÊôÇÂÖàÂæû Firestore ÈáçÊñ∞ËºâÂÖ•Ë≥áÊñô
            if (typeof initHerbLibrary === 'function') {
                await initHerbLibrary();
            }
            displayHerbLibrary();
            
            // ÊêúÂ∞ãÂäüËÉΩ
            const searchInput = document.getElementById('searchHerb');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    displayHerbLibrary();
                });
            }
        }
        
        function filterHerbLibrary(type) {
            currentHerbFilter = type;
            
            // Êõ¥Êñ∞ÊåâÈàïÊ®£Âºè
            document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                btn.className = 'px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200';
            });
            document.getElementById(`filter-${type}`).className = 'px-4 py-2 rounded-lg text-sm font-medium bg-blue-100 text-blue-800 transition duration-200';
            
            displayHerbLibrary();
        }
        
        function displayHerbLibrary() {
            const searchTerm = document.getElementById('searchHerb').value.toLowerCase();
            const listContainer = document.getElementById('herbLibraryList');
            
            // ÈÅéÊøæË≥áÊñô
            let filteredItems = herbLibrary.filter(item => {
                const matchesSearch = item.name.toLowerCase().includes(searchTerm) ||
                                    (item.alias && item.alias.toLowerCase().includes(searchTerm)) ||
                                    (item.effects && item.effects.toLowerCase().includes(searchTerm));
                
                const matchesFilter = currentHerbFilter === 'all' || item.type === currentHerbFilter;
                
                return matchesSearch && matchesFilter;
            });
            
            if (filteredItems.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-4xl mb-4">üåø</div>
                        <div class="text-lg font-medium mb-2">Ê≤íÊúâÊâæÂà∞Áõ∏ÈóúË≥áÊñô</div>
                        <div class="text-sm">Ë´ãÂòóË©¶ÂÖ∂‰ªñÊêúÂ∞ãÊ¢ù‰ª∂ÊàñÊñ∞Â¢û‰∏≠Ëó•Êùê/ÊñπÂäë</div>
                    </div>
                `;
                return;
            }
            
            // ÊåâÈ°ûÂûãÂàÜÁµÑÈ°ØÁ§∫
            const herbs = filteredItems.filter(item => item.type === 'herb');
            const formulas = filteredItems.filter(item => item.type === 'formula');
            
            let html = '';
            
            if (herbs.length > 0 && (currentHerbFilter === 'all' || currentHerbFilter === 'herb')) {
                html += `
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="mr-2">üåø</span>‰∏≠Ëó•Êùê (${herbs.length})
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${herbs.map(herb => createHerbCard(herb)).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (formulas.length > 0 && (currentHerbFilter === 'all' || currentHerbFilter === 'formula')) {
                html += `
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="mr-2">üìã</span>ÊñπÂäë (${formulas.length})
                        </h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            ${formulas.map(formula => createFormulaCard(formula)).join('')}
                        </div>
                    </div>
                `;
            }
            
            listContainer.innerHTML = html;
        }
        
        function createHerbCard(herb) {
            return `
                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition duration-200">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900">${herb.name}</h4>
                            ${herb.alias ? `<p class="text-sm text-gray-600">${herb.alias}</p>` : ''}
                        </div>
                        <div class="flex space-x-1">
                            <button onclick="editHerb(${herb.id})" class="text-blue-600 hover:text-blue-800 text-sm">Á∑®ËºØ</button>
                            <button onclick="deleteHerbItem(${herb.id})" class="text-red-600 hover:text-red-800 text-sm">Âà™Èô§</button>
                        </div>
                    </div>
                    
                    <div class="space-y-2 text-sm">
                        ${herb.nature ? `<div><span class="font-medium text-gray-700">ÊÄßÂë≥Ôºö</span>${herb.nature}</div>` : ''}
                        ${herb.meridian ? `<div><span class="font-medium text-gray-700">Ê≠∏Á∂ìÔºö</span>${herb.meridian}</div>` : ''}
                        ${herb.effects ? `<div><span class="font-medium text-gray-700">ÂäüÊïàÔºö</span>${herb.effects}</div>` : ''}
                        ${herb.dosage ? `<div><span class="font-medium text-gray-700">ÂäëÈáèÔºö</span><span class="text-blue-600 font-medium">${herb.dosage}</span></div>` : ''}
                        ${herb.cautions ? `<div><span class="font-medium text-red-600">Ê≥®ÊÑèÔºö</span><span class="text-red-700">${herb.cautions}</span></div>` : ''}
                    </div>
                </div>
            `;
        }
        
        function createFormulaCard(formula) {
            return `
                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition duration-200">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900">${formula.name}</h4>
                            ${formula.source ? `<p class="text-sm text-gray-600">Âá∫ËôïÔºö${formula.source}</p>` : ''}
                        </div>
                        <div class="flex space-x-1">
                            <button onclick="editFormula(${formula.id})" class="text-blue-600 hover:text-blue-800 text-sm">Á∑®ËºØ</button>
                            <button onclick="deleteHerbItem(${formula.id})" class="text-red-600 hover:text-red-800 text-sm">Âà™Èô§</button>
                        </div>
                    </div>
                    
                    <div class="space-y-3 text-sm">
                        ${formula.effects ? `<div><span class="font-medium text-gray-700">ÂäüÊïàÔºö</span>${formula.effects}</div>` : ''}
                        ${formula.indications ? `<div><span class="font-medium text-gray-700">‰∏ªÊ≤ªÔºö</span>${formula.indications}</div>` : ''}
                        ${formula.composition ? `
                            <div>
                                <span class="font-medium text-gray-700">ÁµÑÊàêÔºö</span>
                                <div class="mt-1 p-2 bg-yellow-50 rounded text-xs whitespace-pre-line border-l-2 border-yellow-400">${formula.composition}</div>
                            </div>
                        ` : ''}
                        ${formula.usage ? `<div><span class="font-medium text-gray-700">Áî®Ê≥ïÔºö</span>${formula.usage}</div>` : ''}
                        ${formula.cautions ? `<div><span class="font-medium text-red-600">Ê≥®ÊÑèÔºö</span><span class="text-red-700">${formula.cautions}</span></div>` : ''}
                    </div>
                </div>
            `;
        }
        
        // ‰∏≠Ëó•ÊùêË°®ÂñÆÂäüËÉΩ
        function showAddHerbForm() {
            editingHerbId = null;
            document.getElementById('herbFormTitle').textContent = 'Êñ∞Â¢û‰∏≠Ëó•Êùê';
            document.getElementById('herbSaveButtonText').textContent = 'ÂÑ≤Â≠ò';
            clearHerbForm();
            document.getElementById('addHerbModal').classList.remove('hidden');
        }
        
        function hideAddHerbForm() {
            document.getElementById('addHerbModal').classList.add('hidden');
            clearHerbForm();
            editingHerbId = null;
        }
        
        function clearHerbForm() {
            ['herbName', 'herbAlias', 'herbNature', 'herbMeridian', 'herbEffects', 'herbIndications', 'herbDosage', 'herbCautions'].forEach(id => {
                document.getElementById(id).value = '';
            });
        }
        
        function editHerb(id) {
            const herb = herbLibrary.find(item => item.id === id && item.type === 'herb');
            if (!herb) return;
            
            editingHerbId = id;
            document.getElementById('herbFormTitle').textContent = 'Á∑®ËºØ‰∏≠Ëó•Êùê';
            document.getElementById('herbSaveButtonText').textContent = 'Êõ¥Êñ∞';
            
            document.getElementById('herbName').value = herb.name || '';
            document.getElementById('herbAlias').value = herb.alias || '';
            document.getElementById('herbNature').value = herb.nature || '';
            document.getElementById('herbMeridian').value = herb.meridian || '';
            document.getElementById('herbEffects').value = herb.effects || '';
            document.getElementById('herbIndications').value = herb.indications || '';
            document.getElementById('herbDosage').value = herb.dosage || '';
            document.getElementById('herbCautions').value = herb.cautions || '';
            
            document.getElementById('addHerbModal').classList.remove('hidden');
        }
        
        async function saveHerb() {
            const name = document.getElementById('herbName').value.trim();
            
            if (!name) {
                showToast('Ë´ãËº∏ÂÖ•‰∏≠Ëó•ÊùêÂêçÁ®±ÔºÅ', 'error');
                return;
            }
            
            const herb = {
                id: editingHerbId || Date.now(),
                type: 'herb',
                name: name,
                alias: document.getElementById('herbAlias').value.trim(),
                nature: document.getElementById('herbNature').value.trim(),
                meridian: document.getElementById('herbMeridian').value.trim(),
                effects: document.getElementById('herbEffects').value.trim(),
                indications: document.getElementById('herbIndications').value.trim(),
                dosage: document.getElementById('herbDosage').value.trim(),
                cautions: document.getElementById('herbCautions').value.trim(),
                createdAt: editingHerbId ? herbLibrary.find(h => h.id === editingHerbId).createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (editingHerbId) {
                const index = herbLibrary.findIndex(item => item.id === editingHerbId);
                herbLibrary[index] = herb;
                showToast('‰∏≠Ëó•ÊùêË≥áÊñôÂ∑≤Êõ¥Êñ∞ÔºÅ', 'success');
            } else {
                herbLibrary.push(herb);
                showToast('‰∏≠Ëó•ÊùêÂ∑≤Êñ∞Â¢ûÔºÅ', 'success');
            }
            
            try {
                // Â∞á‰∏≠Ëó•ÊùêË≥áÊñôÂØ´ÂÖ• Firestore
                await window.firebase.setDoc(
                    window.firebase.doc(window.firebase.db, 'herbLibrary', String(herb.id)),
                    herb
                );
            } catch (error) {
                console.error('ÂÑ≤Â≠ò‰∏≠Ëó•ÊùêË≥áÊñôËá≥ Firestore Â§±Êïó:', error);
            }
            hideAddHerbForm();
            displayHerbLibrary();
        }
        
        // ÊñπÂäëË°®ÂñÆÂäüËÉΩ
        function showAddFormulaForm() {
            editingFormulaId = null;
            document.getElementById('formulaFormTitle').textContent = 'Êñ∞Â¢ûÊñπÂäë';
            document.getElementById('formulaSaveButtonText').textContent = 'ÂÑ≤Â≠ò';
            clearFormulaForm();
            document.getElementById('addFormulaModal').classList.remove('hidden');
        }
        
        function hideAddFormulaForm() {
            document.getElementById('addFormulaModal').classList.add('hidden');
            clearFormulaForm();
            editingFormulaId = null;
        }
        
        function clearFormulaForm() {
            ['formulaName', 'formulaSource', 'formulaEffects', 'formulaIndications', 'formulaComposition', 'formulaUsage', 'formulaCautions'].forEach(id => {
                document.getElementById(id).value = '';
            });
        }
        
        function editFormula(id) {
            const formula = herbLibrary.find(item => item.id === id && item.type === 'formula');
            if (!formula) return;
            
            editingFormulaId = id;
            document.getElementById('formulaFormTitle').textContent = 'Á∑®ËºØÊñπÂäë';
            document.getElementById('formulaSaveButtonText').textContent = 'Êõ¥Êñ∞';
            
            document.getElementById('formulaName').value = formula.name || '';
            document.getElementById('formulaSource').value = formula.source || '';
            document.getElementById('formulaEffects').value = formula.effects || '';
            document.getElementById('formulaIndications').value = formula.indications || '';
            document.getElementById('formulaComposition').value = formula.composition || '';
            document.getElementById('formulaUsage').value = formula.usage || '';
            document.getElementById('formulaCautions').value = formula.cautions || '';
            
            document.getElementById('addFormulaModal').classList.remove('hidden');
        }
        
        async function saveFormula() {
            const name = document.getElementById('formulaName').value.trim();
            const composition = document.getElementById('formulaComposition').value.trim();
            
            if (!name) {
                showToast('Ë´ãËº∏ÂÖ•ÊñπÂäëÂêçÁ®±ÔºÅ', 'error');
                return;
            }
            
            if (!composition) {
                showToast('Ë´ãËº∏ÂÖ•ÊñπÂäëÁµÑÊàêÔºÅ', 'error');
                return;
            }
            
            const formula = {
                id: editingFormulaId || Date.now(),
                type: 'formula',
                name: name,
                source: document.getElementById('formulaSource').value.trim(),
                effects: document.getElementById('formulaEffects').value.trim(),
                indications: document.getElementById('formulaIndications').value.trim(),
                composition: composition,
                usage: document.getElementById('formulaUsage').value.trim(),
                cautions: document.getElementById('formulaCautions').value.trim(),
                createdAt: editingFormulaId ? herbLibrary.find(f => f.id === editingFormulaId).createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (editingFormulaId) {
                const index = herbLibrary.findIndex(item => item.id === editingFormulaId);
                herbLibrary[index] = formula;
                showToast('ÊñπÂäëË≥áÊñôÂ∑≤Êõ¥Êñ∞ÔºÅ', 'success');
            } else {
                herbLibrary.push(formula);
                showToast('ÊñπÂäëÂ∑≤Êñ∞Â¢ûÔºÅ', 'success');
            }
            
            try {
                // Â∞áÊñπÂäëË≥áÊñôÂØ´ÂÖ• Firestore
                await window.firebase.setDoc(
                    window.firebase.doc(window.firebase.db, 'herbLibrary', String(formula.id)),
                    formula
                );
            } catch (error) {
                console.error('ÂÑ≤Â≠òÊñπÂäëË≥áÊñôËá≥ Firestore Â§±Êïó:', error);
            }
            hideAddFormulaForm();
            displayHerbLibrary();
        }
        
        // Âà™Èô§‰∏≠Ëó•ÊùêÊàñÊñπÂäë
        async function deleteHerbItem(id) {
            const item = herbLibrary.find(h => h.id === id);
            if (!item) return;
            
            const itemType = item.type === 'herb' ? '‰∏≠Ëó•Êùê' : 'ÊñπÂäë';
            
            if (confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§${itemType}„Äå${item.name}„ÄçÂóéÔºü\n\nÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ`)) {
                herbLibrary = herbLibrary.filter(h => h.id !== id);
                try {
                    await window.firebase.deleteDoc(
                        window.firebase.doc(window.firebase.db, 'herbLibrary', String(id))
                    );
                } catch (error) {
                    console.error('Âà™Èô§‰∏≠Ëó•ÊùêË≥áÊñôËá≥ Firestore Â§±Êïó:', error);
                }
                showToast(`${itemType}„Äå${item.name}„ÄçÂ∑≤Âà™Èô§ÔºÅ`, 'success');
                displayHerbLibrary();
            }
        }

        // Êî∂Ë≤ªÈ†ÖÁõÆÁÆ°ÁêÜÂäüËÉΩ
        let editingBillingItemId = null;
        let currentBillingFilter = 'all';
        
        async function loadBillingManagement() {
            // ÈÄ≤ÂÖ•Êî∂Ë≤ªÈ†ÖÁõÆÁÆ°ÁêÜÈ†ÅÈù¢ÊôÇÂÖàÂæû Firestore ÈáçÊñ∞ËºâÂÖ•Ë≥áÊñô
            if (typeof initBillingItems === 'function') {
                await initBillingItems();
            }
            displayBillingItems();
            
            // ÊêúÂ∞ãÂäüËÉΩ
            const searchInput = document.getElementById('searchBilling');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    displayBillingItems();
                });
            }
        }
        
        function filterBillingItems(category) {
            currentBillingFilter = category;
            
            // Êõ¥Êñ∞ÊåâÈàïÊ®£Âºè
            document.querySelectorAll('[id^="billing-filter-"]').forEach(btn => {
                btn.className = 'px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200';
            });
            document.getElementById(`billing-filter-${category}`).className = 'px-4 py-2 rounded-lg text-sm font-medium bg-blue-100 text-blue-800 transition duration-200';
            
            displayBillingItems();
        }
        
        function displayBillingItems() {
            const searchTerm = document.getElementById('searchBilling').value.toLowerCase();
            const listContainer = document.getElementById('billingItemsList');
            
            // ÈÅéÊøæË≥áÊñô
            let filteredItems = billingItems.filter(item => {
                const matchesSearch = item.name.toLowerCase().includes(searchTerm) ||
                                    (item.description && item.description.toLowerCase().includes(searchTerm));
                
                const matchesFilter = currentBillingFilter === 'all' || item.category === currentBillingFilter;
                
                return matchesSearch && matchesFilter;
            });
            
            if (filteredItems.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-4xl mb-4">üí∞</div>
                        <div class="text-lg font-medium mb-2">Ê≤íÊúâÊâæÂà∞Áõ∏ÈóúÊî∂Ë≤ªÈ†ÖÁõÆ</div>
                        <div class="text-sm">Ë´ãÂòóË©¶ÂÖ∂‰ªñÊêúÂ∞ãÊ¢ù‰ª∂ÊàñÊñ∞Â¢ûÊî∂Ë≤ªÈ†ÖÁõÆ</div>
                    </div>
                `;
                return;
            }
            
            // ÊåâÈ°ûÂà•ÂàÜÁµÑÈ°ØÁ§∫
            const categories = {
                consultation: { name: 'Ë®∫ÁôÇË≤ª', icon: 'ü©∫', items: [] },
                medicine: { name: 'Ëó•Ë≤ª', icon: 'üíä', items: [] },
                treatment: { name: 'Ê≤ªÁôÇË≤ª', icon: 'üîß', items: [] },
                other: { name: 'ÂÖ∂‰ªñ', icon: 'üìã', items: [] },
                discount: { name: 'ÊäòÊâ£È†ÖÁõÆ', icon: 'üí∏', items: [] },
                package: { name: 'Â•óÁ•®È†ÖÁõÆ', icon: 'üé´', items: [] }
            };
            
            filteredItems.forEach(item => {
                if (categories[item.category]) {
                    categories[item.category].items.push(item);
                }
            });
            
            let html = '';
            
            Object.keys(categories).forEach(categoryKey => {
                const category = categories[categoryKey];
                if (category.items.length > 0 && (currentBillingFilter === 'all' || currentBillingFilter === categoryKey)) {
                    html += `
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="mr-2">${category.icon}</span>${category.name} (${category.items.length})
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${category.items.map(item => createBillingItemCard(item)).join('')}
                            </div>
                        </div>
                    `;
                }
            });
            
            listContainer.innerHTML = html;
        }
        
        function createBillingItemCard(item) {
            const statusClass = item.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
            const statusText = item.active ? 'ÂïüÁî®' : 'ÂÅúÁî®';
            
            // ÊäòÊâ£È†ÖÁõÆ‰ΩøÁî®‰∏çÂêåÁöÑÈ°èËâ≤È°ØÁ§∫
            const priceColor = item.category === 'discount' ? 'text-red-600' : 'text-green-600';
            let pricePrefix = '$';
            let displayPrice = Math.abs(item.price);
            
            // ËôïÁêÜÊäòÊâ£È†ÖÁõÆÁöÑÈ°ØÁ§∫
            if (item.category === 'discount') {
                if (item.price > 0 && item.price < 1) {
                    // ÁôæÂàÜÊØîÊäòÊâ£ (0.9 = 9Êäò)
                    pricePrefix = '';
                    displayPrice = (item.price * 10).toFixed(0);
                } else if (item.price < 0) {
                    // Âõ∫ÂÆöÈáëÈ°çÊäòÊâ£
                    pricePrefix = '-$';
                    displayPrice = Math.abs(item.price);
                }
            }
            
            return `
                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition duration-200 ${!item.active ? 'opacity-75' : ''}">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h4 class="text-lg font-semibold text-gray-900">${item.name}</h4>
                            <div class="flex items-center mt-1">
                                <span class="text-2xl font-bold text-green-600">$${Math.abs(item.price)}</span>
                                ${item.unit ? `<span class="text-sm text-gray-500 ml-1">/ ${item.unit}</span>` : ''}
                            </div>
                        </div>
                        <div class="flex flex-col items-end space-y-2">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                                ${statusText}
                            </span>
                            <div class="flex space-x-1">
                                <button onclick="editBillingItem(${item.id})" class="text-blue-600 hover:text-blue-800 text-sm">Á∑®ËºØ</button>
                                <button onclick="deleteBillingItem(${item.id})" class="text-red-600 hover:text-red-800 text-sm">Âà™Èô§</button>
                            </div>
                        </div>
                    </div>
                    
                    ${item.description ? `
                        <div class="text-sm text-gray-600 bg-gray-50 p-2 rounded">
                            ${item.description}
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        // Êî∂Ë≤ªÈ†ÖÁõÆË°®ÂñÆÂäüËÉΩ
        function showAddBillingItemForm() {
            editingBillingItemId = null;
            document.getElementById('billingItemFormTitle').textContent = 'Êñ∞Â¢ûÊî∂Ë≤ªÈ†ÖÁõÆ';
            document.getElementById('billingItemSaveButtonText').textContent = 'ÂÑ≤Â≠ò';
            clearBillingItemForm();
            document.getElementById('addBillingItemModal').classList.remove('hidden');
        }
        
        function hideAddBillingItemForm() {
            document.getElementById('addBillingItemModal').classList.add('hidden');
            clearBillingItemForm();
            editingBillingItemId = null;
        }
        
        function clearBillingItemForm() {
            document.getElementById('billingItemPackageUses').value = '';
            document.getElementById('billingItemValidityDays').value = '';
            var pf = document.getElementById('packageFields'); if (pf) pf.classList.add('hidden');
            document.getElementById('billingItemName').value = '';
            document.getElementById('billingItemCategory').value = '';
            document.getElementById('billingItemPrice').value = '';
            document.getElementById('billingItemUnit').value = '';
            document.getElementById('billingItemDescription').value = '';
            document.getElementById('billingItemActive').checked = true;
        }
        
        function editBillingItem(id) {
            const item = billingItems.find(b => b.id === id);
            if (!item) return;
            
            editingBillingItemId = id;
            document.getElementById('billingItemFormTitle').textContent = 'Á∑®ËºØÊî∂Ë≤ªÈ†ÖÁõÆ';
            document.getElementById('billingItemSaveButtonText').textContent = 'Êõ¥Êñ∞';
            
            document.getElementById('billingItemName').value = item.name || '';
            document.getElementById('billingItemCategory').value = item.category || '';
            document.getElementById('billingItemPrice').value = item.price || '';
            document.getElementById('billingItemUnit').value = item.unit || '';
            document.getElementById('billingItemDescription').value = item.description || '';
            document.getElementById('billingItemActive').checked = item.active !== false;
            document.getElementById('billingItemPackageUses').value = item.packageUses || '';
            document.getElementById('billingItemValidityDays').value = item.validityDays || '';
            {
                const pf = document.getElementById('packageFields');
                if (pf) pf.classList.toggle('hidden', item.category !== 'package');
            }
            
            document.getElementById('addBillingItemModal').classList.remove('hidden');
        }
        
        async function saveBillingItem() {
            const name = document.getElementById('billingItemName').value.trim();
            const category = document.getElementById('billingItemCategory').value;
            let price = parseFloat(document.getElementById('billingItemPrice').value);

            let packageUses = null;
            let validityDays = null;
            if (category === 'package') {
                packageUses = parseInt(document.getElementById('billingItemPackageUses').value);
                validityDays = parseInt(document.getElementById('billingItemValidityDays').value);
                if (!packageUses || packageUses <= 0) {
                    showToast('Ë´ãËº∏ÂÖ•Â•óÁ•®ÂèØÁî®Ê¨°Êï∏ÔºÅ', 'error');
                    return;
                }
                if (!validityDays || validityDays <= 0) {
                    showToast('Ë´ãËº∏ÂÖ•ÊúâÊïàÂ§©Êï∏ÔºÅ', 'error');
                    return;
                }
            }
            
            if (!name) {
                showToast('Ë´ãËº∏ÂÖ•Êî∂Ë≤ªÈ†ÖÁõÆÂêçÁ®±ÔºÅ', 'error');
                return;
            }
            
            if (!category) {
                showToast('Ë´ãÈÅ∏ÊìáÈ†ÖÁõÆÈ°ûÂà•ÔºÅ', 'error');
                return;
            }
            
            if (isNaN(price)) {
                showToast('Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÊî∂Ë≤ªÈáëÈ°çÔºÅ', 'error');
                return;
            }
            
            // ÊäòÊâ£È†ÖÁõÆÂÖÅË®±Ë≤†Êï∏Êàñ0-1‰πãÈñìÁöÑÂ∞èÊï∏ÔºàÁôæÂàÜÊØîÔºâÔºåÂÖ∂‰ªñÈ†ÖÁõÆ‰∏çÂÖÅË®±Ë≤†Êï∏
            if (category !== 'discount' && price < 0) {
                showToast('Èô§ÊäòÊâ£È†ÖÁõÆÂ§ñÔºåÊî∂Ë≤ªÈáëÈ°ç‰∏çËÉΩÁÇ∫Ë≤†Êï∏ÔºÅ', 'error');
                return;
            }
            
            // ÊäòÊâ£È†ÖÁõÆÁöÑÁâπÊÆäÈ©óË≠â
            if (category === 'discount') {
                if (price > 0 && price >= 1 && price <= 10) {
                    // Â¶ÇÊûúËº∏ÂÖ•1-10‰πãÈñìÁöÑÊï∏Â≠óÔºåËá™ÂãïËΩâÊèõÁÇ∫ÊäòÊâ£ÊØî‰æã
                    price = price / 10;
                    document.getElementById('billingItemPrice').value = price;
                    showToast(`Â∑≤Ëá™ÂãïËΩâÊèõÁÇ∫${(price * 100).toFixed(0)}Êäò`, 'info');
                }
            }
            
            const item = {
                id: editingBillingItemId || Date.now(),
                name: name,
                category: category,
                price: price,
                unit: document.getElementById('billingItemUnit').value.trim(),
                description: document.getElementById('billingItemDescription').value.trim(),
                packageUses: packageUses,
                validityDays: validityDays,
                active: document.getElementById('billingItemActive').checked,
                createdAt: editingBillingItemId ? billingItems.find(b => b.id === editingBillingItemId).createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (editingBillingItemId) {
                const index = billingItems.findIndex(b => b.id === editingBillingItemId);
                billingItems[index] = item;
                showToast('Êî∂Ë≤ªÈ†ÖÁõÆÂ∑≤Êõ¥Êñ∞ÔºÅ', 'success');
            } else {
                billingItems.push(item);
                showToast('Êî∂Ë≤ªÈ†ÖÁõÆÂ∑≤Êñ∞Â¢ûÔºÅ', 'success');
            }
            
            try {
                // Â∞áÊî∂Ë≤ªÈ†ÖÁõÆÂØ´ÂÖ• Firestore
                await window.firebase.setDoc(
                    window.firebase.doc(window.firebase.db, 'billingItems', String(item.id)),
                    item
                );
            } catch (error) {
                console.error('ÂÑ≤Â≠òÊî∂Ë≤ªÈ†ÖÁõÆËá≥ Firestore Â§±Êïó:', error);
            }
            hideAddBillingItemForm();
            displayBillingItems();
        }
        
        async function deleteBillingItem(id) {
            const item = billingItems.find(b => b.id === id);
            if (!item) return;
            
            if (confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§Êî∂Ë≤ªÈ†ÖÁõÆ„Äå${item.name}„ÄçÂóéÔºü\n\nÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ`)) {
                billingItems = billingItems.filter(b => b.id !== id);
                try {
                    await window.firebase.deleteDoc(
                        window.firebase.doc(window.firebase.db, 'billingItems', String(id))
                    );
                } catch (error) {
                    console.error('Âà™Èô§Êî∂Ë≤ªÈ†ÖÁõÆË≥áÊñôËá≥ Firestore Â§±Êïó:', error);
                }
                showToast(`Êî∂Ë≤ªÈ†ÖÁõÆ„Äå${item.name}„ÄçÂ∑≤Âà™Èô§ÔºÅ`, 'success');
                displayBillingItems();
            }
        }

        // ËôïÊñπÊêúÁ¥¢ÂäüËÉΩ
        function searchHerbsForPrescription() {
            const searchTerm = document.getElementById('prescriptionSearch').value.trim().toLowerCase();
            const resultsContainer = document.getElementById('prescriptionSearchResults');
            const resultsList = document.getElementById('prescriptionSearchList');
            
            if (searchTerm.length < 1) {
                resultsContainer.classList.add('hidden');
                return;
            }
            
            // ÊêúÁ¥¢ÂåπÈÖçÁöÑ‰∏≠Ëó•ÊùêÂíåÊñπÂäë
            const matchedItems = herbLibrary.filter(item => 
                item.name.toLowerCase().includes(searchTerm) ||
                (item.alias && item.alias.toLowerCase().includes(searchTerm)) ||
                (item.effects && item.effects.toLowerCase().includes(searchTerm))
            ).slice(0, 10); // ÈôêÂà∂È°ØÁ§∫Ââç10ÂÄãÁµêÊûú
            
            if (matchedItems.length === 0) {
                resultsList.innerHTML = `
                    <div class="p-3 text-center text-gray-500 text-sm">
                        Êâæ‰∏çÂà∞Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑ‰∏≠Ëó•ÊùêÊàñÊñπÂäë
                    </div>
                `;
                resultsContainer.classList.remove('hidden');
                return;
            }
            
            // È°ØÁ§∫ÊêúÁ¥¢ÁµêÊûú
            resultsList.innerHTML = matchedItems.map(item => {
                const typeName = item.type === 'herb' ? '‰∏≠Ëó•Êùê' : 'ÊñπÂäë';
                const bgColor = 'bg-yellow-50 hover:bg-yellow-100 border-yellow-200';
                
                return `
                    <div class="p-3 ${bgColor} border rounded-lg cursor-pointer transition duration-200" onclick="addToPrescription('${item.type}', ${item.id})">
                        <div class="text-center">
                            <div class="font-semibold text-gray-900 text-sm mb-1">${item.name}</div>
                            <div class="text-xs bg-white text-gray-600 px-2 py-1 rounded mb-2">${typeName}</div>
                            ${item.type === 'herb' && item.dosage ? `<div class="text-xs text-yellow-600 font-medium">${item.dosage}</div>` : ''}
                            ${item.effects ? `<div class="text-xs text-gray-600 mt-1">${item.effects.substring(0, 30)}${item.effects.length > 30 ? '...' : ''}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            resultsContainer.classList.remove('hidden');
        }
        
        // Â≠òÂÑ≤Â∑≤ÈÅ∏ÊìáÁöÑËôïÊñπÈ†ÖÁõÆ
        let selectedPrescriptionItems = [];
        
        // Â≠òÂÑ≤Â∑≤ÈÅ∏ÊìáÁöÑÊî∂Ë≤ªÈ†ÖÁõÆ
        let selectedBillingItems = [];
        
        // Ê∑ªÂä†Âà∞ËôïÊñπÂÖßÂÆπ
        function addToPrescription(type, itemId) {
            const item = herbLibrary.find(h => h.id === itemId);
            if (!item) return;
            
            // Ê™¢Êü•ÊòØÂê¶Â∑≤Á∂ìÊ∑ªÂä†ÈÅé
            const existingIndex = selectedPrescriptionItems.findIndex(p => p.id === itemId);
            if (existingIndex !== -1) {
                showToast(`${item.name} Â∑≤Á∂ìÂú®ËôïÊñπ‰∏≠ÔºÅ`, 'warning');
                return;
            }
            
            // Ê∑ªÂä†Âà∞Â∑≤ÈÅ∏ÊìáÈ†ÖÁõÆ
            const prescriptionItem = {
                id: itemId,
                type: type,
                name: item.name,
                dosage: type === 'herb' ? (item.dosage || '6g') : null,
                customDosage: '6', // ‰∏≠Ëó•ÊùêÂíåÊñπÂäëÈÉΩÈ†êË®≠6ÂÖã
                composition: type === 'formula' ? item.composition : null,
                effects: item.effects
            };
            
            selectedPrescriptionItems.push(prescriptionItem);
            
            // Êõ¥Êñ∞È°ØÁ§∫
            updatePrescriptionDisplay();
            
            // Â¶ÇÊûúÊòØÁ¨¨‰∏ÄÂÄãËôïÊñπÈ†ÖÁõÆÔºåËá™ÂãïÊ∑ªÂä†Ëó•Ë≤ª
            if (selectedPrescriptionItems.length === 1) {
                const days = parseInt(document.getElementById('medicationDays').value) || 5;
                updateMedicineFeeByDays(days);
            }
            
            // Ê∏ÖÈô§ÊêúÁ¥¢
            clearPrescriptionSearch();
            
            showToast(`Â∑≤Ê∑ªÂä†${type === 'herb' ? '‰∏≠Ëó•Êùê' : 'ÊñπÂäë'}Ôºö${item.name}`, 'success');
        }
        

        
        // Êõ¥Êñ∞ËôïÊñπÈ°ØÁ§∫
        function updatePrescriptionDisplay() {
            const container = document.getElementById('selectedPrescriptionItems');
            const hiddenTextarea = document.getElementById('formPrescription');
            const medicationSettings = document.getElementById('medicationSettings');
            
            if (selectedPrescriptionItems.length === 0) {
                container.innerHTML = `
                    <div class="text-sm text-gray-500 text-center py-4">
                        Ë´ã‰ΩøÁî®‰∏äÊñπÊêúÁ¥¢ÂäüËÉΩÊ∑ªÂä†‰∏≠Ëó•ÊùêÊàñÊñπÂäë
                    </div>
                `;
                hiddenTextarea.value = '';
                // Èö±ËóèÊúçËó•Â§©Êï∏Ë®≠ÂÆö
                medicationSettings.style.display = 'none';
                return;
            }
            
            // È°ØÁ§∫ÊúçËó•Â§©Êï∏Ë®≠ÂÆö
            medicationSettings.style.display = 'block';
            
            // È°ØÁ§∫Â∑≤Ê∑ªÂä†ÁöÑÈ†ÖÁõÆ
            const displayHtml = `
                <div class="space-y-3">
                    ${selectedPrescriptionItems.map((item, index) => {
                        const bgColor = 'bg-yellow-50 border-yellow-200';
                        
                        return `
                            <div class="${bgColor} border rounded-lg p-3">
                                <div class="flex items-center">
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900">${item.name}</div>
                                        ${item.type === 'formula' ? `<div class="text-xs text-gray-600">ÊñπÂäë</div>` : ''}
                                    </div>
                                    <div class="flex items-center space-x-2 mr-3">
                                        <input type="number" 
                                               value="${item.customDosage || '6'}" 
                                               min="0.5" 
                                               max="100" 
                                               step="0.5"
                                               class="w-16 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-yellow-500 focus:border-transparent text-center"
                                               onchange="updatePrescriptionDosage(${index}, this.value)"
                                               onclick="this.select()">
                                        <span class="text-sm text-gray-600 font-medium">g</span>
                                    </div>
                                    <button onclick="removePrescriptionItem(${index})" class="text-red-500 hover:text-red-700 font-bold text-lg px-2">√ó</button>
                                </div>
                                
                                ${item.type === 'formula' && item.composition ? `
                                    <div class="mt-3 pt-3 border-t border-yellow-200">
                                        <div class="text-xs font-semibold text-gray-700 mb-2">ÊñπÂäëÁµÑÊàêÔºö</div>
                                        <div class="text-xs text-gray-600 bg-white rounded px-3 py-2 border border-yellow-100">
                                            ${item.composition.replace(/\n/g, '„ÄÅ')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            container.innerHTML = displayHtml;
            
            // Êõ¥Êñ∞Èö±ËóèÁöÑÊñáÊú¨Âüü
            let prescriptionText = '';
            
            selectedPrescriptionItems.forEach(item => {
                if (item.type === 'herb') {
                    const dosage = item.customDosage || '6';
                    prescriptionText += `${item.name} ${dosage}g\n`;
                } else if (item.type === 'formula') {
                    const dosage = item.customDosage || '6';
                    prescriptionText += `${item.name} ${dosage}g\n`;
                    if (item.composition) {
                        prescriptionText += `${item.composition.replace(/\n/g, '„ÄÅ')}\n`;
                    }
                    prescriptionText += '\n';
                }
            });
            
            hiddenTextarea.value = prescriptionText.trim();
        }
        
        // Êõ¥Êñ∞ÊúçËó•Â§©Êï∏
        function updateMedicationDays(change) {
            const daysInput = document.getElementById('medicationDays');
            const currentDays = parseInt(daysInput.value) || 5;
            const newDays = Math.max(1, Math.min(30, currentDays + change));
            daysInput.value = newDays;
            
            // Êõ¥Êñ∞ËôïÊñπÈ°ØÁ§∫
            if (selectedPrescriptionItems.length > 0) {
                updatePrescriptionDisplay();
            }
            
            // Ëá™ÂãïÊõ¥Êñ∞Ëó•Ë≤ª
            updateMedicineFeeByDays(newDays);
        }
        
        // Êõ¥Êñ∞ÊúçËó•Ê¨°Êï∏
        function updateMedicationFrequency(change) {
            const frequencyInput = document.getElementById('medicationFrequency');
            const currentFrequency = parseInt(frequencyInput.value) || 2;
            const newFrequency = Math.max(1, Math.min(6, currentFrequency + change));
            frequencyInput.value = newFrequency;
            
            // Êõ¥Êñ∞ËôïÊñπÈ°ØÁ§∫
            if (selectedPrescriptionItems.length > 0) {
                updatePrescriptionDisplay();
            }
        }
        
        // Ê†πÊìöÈñãËó•Â§©Êï∏Ëá™ÂãïÊõ¥Êñ∞Ëó•Ë≤ª
        function updateMedicineFeeByDays(days) {
            // Âè™ÊúâÂú®ÊúâËôïÊñπÂÖßÂÆπÊôÇÊâçËá™ÂãïÊõ¥Êñ∞Ëó•Ë≤ª
            if (selectedPrescriptionItems.length === 0) {
                return;
            }
            
            // Â∞ãÊâæ‰∏≠Ëó•Ë™øÂäëË≤ªÈ†ÖÁõÆ
            const medicineFeeItem = billingItems.find(item => 
                item.active && 
                item.category === 'medicine' && 
                (item.name.includes('‰∏≠Ëó•') || item.name.includes('Ëó•Ë≤ª') || item.name.includes('Ë™øÂäë'))
            );
            
            if (!medicineFeeItem) {
                return; // Â¶ÇÊûúÊ≤íÊúâÊâæÂà∞Ëó•Ë≤ªÈ†ÖÁõÆÔºå‰∏çÈÄ≤Ë°åËá™ÂãïÊõ¥Êñ∞
            }
            
            // Êü•ÊâæÁèæÊúâÁöÑËó•Ë≤ªÈ†ÖÁõÆ
            const existingMedicineFeeIndex = selectedBillingItems.findIndex(item => 
                item.id === medicineFeeItem.id
            );
            
            if (existingMedicineFeeIndex !== -1) {
                // Êõ¥Êñ∞ÁèæÊúâËó•Ë≤ªÈ†ÖÁõÆÁöÑÊï∏ÈáèÁÇ∫Â§©Êï∏
                selectedBillingItems[existingMedicineFeeIndex].quantity = days;
                updateBillingDisplay();
                showToast(`Â∑≤Êõ¥Êñ∞Ëó•Ë≤ªÔºö${medicineFeeItem.name} x${days}Â§©`, 'info');
            } else {
                // Â¶ÇÊûúÊ≤íÊúâËó•Ë≤ªÈ†ÖÁõÆÔºåËá™ÂãïÊ∑ªÂä†
                const billingItem = {
                    id: medicineFeeItem.id,
                    name: medicineFeeItem.name,
                    category: medicineFeeItem.category,
                    price: medicineFeeItem.price,
                    unit: medicineFeeItem.unit,
                    description: medicineFeeItem.description,
                    quantity: days
                };
                
                selectedBillingItems.push(billingItem);
                updateBillingDisplay();
                showToast(`Â∑≤Ëá™ÂãïÊ∑ªÂä†Ëó•Ë≤ªÔºö${medicineFeeItem.name} x${days}Â§©`, 'info');
            }
        }
        
        // ËôïÁêÜÂ§©Êï∏Ëº∏ÂÖ•Ê°ÜÁõ¥Êé•ËÆäÊõ¥
        function updateMedicationDaysFromInput() {
            const daysInput = document.getElementById('medicationDays');
            const days = parseInt(daysInput.value) || 5;
            
            // Á¢∫‰øùÂ§©Êï∏Âú®ÊúâÊïàÁØÑÂúçÂÖß
            const validDays = Math.max(1, Math.min(30, days));
            if (validDays !== days) {
                daysInput.value = validDays;
            }
            
            // Êõ¥Êñ∞ËôïÊñπÈ°ØÁ§∫
            if (selectedPrescriptionItems.length > 0) {
                updatePrescriptionDisplay();
            }
            
            // Ëá™ÂãïÊõ¥Êñ∞Ëó•Ë≤ª
            updateMedicineFeeByDays(validDays);
        }
        
        // Êõ¥Êñ∞‰ºëÊÅØÊúüÈñìÈ°ØÁ§∫
        function updateRestPeriod() {
            const startDateInput = document.getElementById('formRestStartDate');
            const endDateInput = document.getElementById('formRestEndDate');
            const displaySpan = document.getElementById('restPeriodDisplay');
            
            if (!startDateInput || !endDateInput || !displaySpan) return;
            
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            
            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                if (end >= start) {
                    const timeDiff = end.getTime() - start.getTime();
                    const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1; // ÂåÖÂê´ÈñãÂßãÂíåÁµêÊùüÊó•Êúü
                    displaySpan.textContent = `ÂÖ± ${daysDiff} Â§©`;
                    displaySpan.className = 'text-sm text-blue-600 font-medium';
                } else {
                    displaySpan.textContent = 'ÁµêÊùüÊó•Êúü‰∏çËÉΩÊó©ÊñºÈñãÂßãÊó•Êúü';
                    displaySpan.className = 'text-sm text-red-600 font-medium';
                }
            } else {
                displaySpan.textContent = 'Ë´ãÈÅ∏ÊìáÈñãÂßãÂíåÁµêÊùüÊó•Êúü';
                displaySpan.className = 'text-sm text-gray-500 font-medium';
            }
        }
        

        
        // Êõ¥Êñ∞ËôïÊñπËó•Èáè
        function updatePrescriptionDosage(index, newDosage) {
            if (index >= 0 && index < selectedPrescriptionItems.length) {
                const dosage = parseFloat(newDosage);
                if (dosage > 0 && dosage <= 100) {
                    selectedPrescriptionItems[index].customDosage = newDosage;
                    // ÈáçÊñ∞ÁîüÊàêËôïÊñπÊñáÊú¨
                    updatePrescriptionDisplay();
                } else {
                    // Â¶ÇÊûúËº∏ÂÖ•ÁÑ°ÊïàÔºåÊÅ¢Âæ©ÂéüÂÄº
                    updatePrescriptionDisplay();
                    showToast('Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑËó•ÈáèÔºà0.5-100ÂÖãÔºâ', 'warning');
                }
            }
        }
        

        
        // ÁßªÈô§ËôïÊñπÈ†ÖÁõÆ
        function removePrescriptionItem(index) {
            if (index >= 0 && index < selectedPrescriptionItems.length) {
                const removedItem = selectedPrescriptionItems.splice(index, 1)[0];
                updatePrescriptionDisplay();
                
                // Â¶ÇÊûúÁßªÈô§ÂæåÊ≤íÊúâËôïÊñπÈ†ÖÁõÆ‰∫ÜÔºåÁßªÈô§Ëó•Ë≤ª
                if (selectedPrescriptionItems.length === 0) {
                    // Â∞ãÊâæ‰∏¶ÁßªÈô§Ëó•Ë≤ªÈ†ÖÁõÆ
                    const medicineFeeItem = billingItems.find(item => 
                        item.active && 
                        item.category === 'medicine' && 
                        (item.name.includes('‰∏≠Ëó•') || item.name.includes('Ëó•Ë≤ª') || item.name.includes('Ë™øÂäë'))
                    );
                    
                    if (medicineFeeItem) {
                        const medicineFeeIndex = selectedBillingItems.findIndex(item => 
                            item.id === medicineFeeItem.id
                        );
                        
                        if (medicineFeeIndex !== -1) {
                            selectedBillingItems.splice(medicineFeeIndex, 1);
                            updateBillingDisplay();
                        }
                    }
                }
            }
        }
        
        // Ê∏ÖÈô§ËôïÊñπÊêúÁ¥¢
        function clearPrescriptionSearch() {
            document.getElementById('prescriptionSearch').value = '';
            document.getElementById('prescriptionSearchResults').classList.add('hidden');
        }
        
        // Êî∂Ë≤ªÈ†ÖÁõÆÊêúÁ¥¢ÂäüËÉΩ
        function searchBillingForConsultation() {
            const searchTerm = document.getElementById('billingSearch').value.trim().toLowerCase();
            const resultsContainer = document.getElementById('billingSearchResults');
            const resultsList = document.getElementById('billingSearchList');
            
            if (searchTerm.length < 1) {
                resultsContainer.classList.add('hidden');
                return;
            }
            
            // ÊêúÁ¥¢ÂåπÈÖçÁöÑÊî∂Ë≤ªÈ†ÖÁõÆÔºàÂè™È°ØÁ§∫ÂïüÁî®ÁöÑÈ†ÖÁõÆÔºâ
            const matchedItems = billingItems.filter(item => 
                item.active && (
                    item.name.toLowerCase().includes(searchTerm) ||
                    (item.description && item.description.toLowerCase().includes(searchTerm))
                )
            ).slice(0, 10); // ÈôêÂà∂È°ØÁ§∫Ââç10ÂÄãÁµêÊûú
            
            if (matchedItems.length === 0) {
                resultsList.innerHTML = `
                    <div class="p-3 text-center text-gray-500 text-sm">
                        Êâæ‰∏çÂà∞Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑÊî∂Ë≤ªÈ†ÖÁõÆ
                    </div>
                `;
                resultsContainer.classList.remove('hidden');
                return;
            }
            
            // È°ØÁ§∫ÊêúÁ¥¢ÁµêÊûú
            resultsList.innerHTML = matchedItems.map(item => {
                const categoryNames = {
                    consultation: 'Ë®∫ÁôÇË≤ª',
                    medicine: 'Ëó•Ë≤ª',
                    treatment: 'Ê≤ªÁôÇË≤ª',
                    other: 'ÂÖ∂‰ªñ',
                    discount: 'ÊäòÊâ£È†ÖÁõÆ',
                    package: 'Â•óÁ•®È†ÖÁõÆ'
                };
                const categoryName = categoryNames[item.category] || 'Êú™ÂàÜÈ°û';
                const bgColor = getCategoryBgColor(item.category);
                
                return `
                    <div class="p-3 ${bgColor} border rounded-lg cursor-pointer transition duration-200" onclick="addToBilling(${item.id})">
                        <div class="text-center">
                            <div class="font-semibold text-gray-900 text-sm mb-1">${item.name}</div>
                            <div class="text-xs bg-white text-gray-600 px-2 py-1 rounded mb-2">${categoryName}</div>
                            ${item.category !== 'discount' ? `
                                <div class="text-sm font-bold text-green-600">
                                    $${item.price}
                                </div>
                            ` : ''}
                            ${item.unit ? `<div class="text-xs text-gray-600">/ ${item.unit}</div>` : ''}
                            ${item.description ? `<div class="text-xs text-gray-600 mt-1">${item.description.substring(0, 30)}${item.description.length > 30 ? '...' : ''}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            resultsContainer.classList.remove('hidden');
        }
        
        // Áç≤ÂèñÈ°ûÂà•ËÉåÊôØÈ°èËâ≤
        function getCategoryBgColor(category) {
            const colors = {
                consultation: 'bg-blue-50 hover:bg-blue-100 border-blue-200',
                medicine: 'bg-green-50 hover:bg-green-100 border-green-200',
                treatment: 'bg-orange-50 hover:bg-orange-100 border-orange-200',
                other: 'bg-gray-50 hover:bg-gray-100 border-gray-200',
                discount: 'bg-red-50 hover:bg-red-100 border-red-200',
                package: 'bg-purple-50 hover:bg-purple-100 border-purple-200'
            };
            return colors[category] || colors.other;
        }
        
        // Ê∑ªÂä†Âà∞Êî∂Ë≤ªÈ†ÖÁõÆ
        function addToBilling(itemId) {
            const item = billingItems.find(b => b.id === itemId);
            if (!item) return;
            
            // Ê™¢Êü•ÊòØÂê¶Â∑≤Á∂ìÊ∑ªÂä†ÈÅé
            const existingIndex = selectedBillingItems.findIndex(b => b.id === itemId);
            if (existingIndex !== -1) {
                // Â¶ÇÊûúÂ∑≤Â≠òÂú®ÔºåÂ¢ûÂä†Êï∏Èáè
                selectedBillingItems[existingIndex].quantity += 1;
            } else {
                // Ê∑ªÂä†Êñ∞È†ÖÁõÆ
                const billingItem = {
                    id: itemId,
                    name: item.name,
                    category: item.category,
                    price: item.price,
                    unit: item.unit,
                    description: item.description,
                    packageUses: item.packageUses,
                    validityDays: item.validityDays,
                    quantity: 1
                };
                selectedBillingItems.push(billingItem);
            }
            
            // Êõ¥Êñ∞È°ØÁ§∫
            updateBillingDisplay();
            
            // Ê∏ÖÈô§ÊêúÁ¥¢
            clearBillingSearch();
            
            showToast(`Â∑≤Ê∑ªÂä†Êî∂Ë≤ªÈ†ÖÁõÆÔºö${item.name}`, 'success');
        }
        
        // Êõ¥Êñ∞Êî∂Ë≤ªÈ†ÖÁõÆÈ°ØÁ§∫
        function updateBillingDisplay() {
            const container = document.getElementById('selectedBillingItems');
            const hiddenTextarea = document.getElementById('formBillingItems');
            const totalAmountSpan = document.getElementById('totalBillingAmount');
            
            if (selectedBillingItems.length === 0) {
                container.innerHTML = `
                    <div class="text-sm text-gray-500 text-center py-4">
                        Ë´ã‰ΩøÁî®‰∏äÊñπÊêúÁ¥¢ÂäüËÉΩÊ∑ªÂä†Êî∂Ë≤ªÈ†ÖÁõÆ
                    </div>
                `;
                hiddenTextarea.value = '';
                totalAmountSpan.textContent = '$0';
                return;
            }
            
            // Ë®àÁÆóÁ∏ΩË≤ªÁî®
            let totalAmount = 0;
            let subtotalBeforeDiscount = 0;
            
            // ÂÖàË®àÁÆóÈùûÊäòÊâ£È†ÖÁõÆÁöÑÂ∞èË®à
            selectedBillingItems.forEach(item => {
                if (item.category !== 'discount') {
                    subtotalBeforeDiscount += item.price * item.quantity;
                }
            });
            
            // Ë®àÁÆóÊäòÊâ£ÂæåÁöÑÁ∏ΩÈáëÈ°ç
            totalAmount = subtotalBeforeDiscount;
            selectedBillingItems.forEach(item => {
                if (item.category === 'discount') {
                    if (item.price > 0 && item.price < 1) {
                        // ÁôæÂàÜÊØîÊäòÊâ£ÔºöÂ∞çÂ∞èË®àÈÄ≤Ë°åÊäòÊâ£Ë®àÁÆó
                        const discountAmount = subtotalBeforeDiscount * (1 - item.price) * item.quantity;
                        totalAmount -= discountAmount;
                    } else {
                        // Âõ∫ÂÆöÈáëÈ°çÊäòÊâ£
                        totalAmount += item.price * item.quantity;
                    }
                }
            });
            totalAmountSpan.textContent = `$${totalAmount}`;
            
            // ÂàÜÈõ¢ÊäòÊâ£È†ÖÁõÆÂíåÈùûÊäòÊâ£È†ÖÁõÆÔºå‰ΩÜ‰øùÊåÅÂêÑËá™ÁöÑÊ∑ªÂä†È†ÜÂ∫è
            const nonDiscountItems = [];
            const discountItems = [];
            
            selectedBillingItems.forEach((item, originalIndex) => {
                if (item.category === 'discount') {
                    discountItems.push({ item, originalIndex });
                } else {
                    nonDiscountItems.push({ item, originalIndex });
                }
            });
            
            // Âêà‰ΩµÈ°ØÁ§∫ÔºöÈùûÊäòÊâ£È†ÖÁõÆÂú®ÂâçÔºåÊäòÊâ£È†ÖÁõÆÂú®Âæå
            const displayItems = [...nonDiscountItems, ...discountItems];
            
            // È°ØÁ§∫Â∑≤ÈÅ∏ÊìáÁöÑÈ†ÖÁõÆÔºàÈùûÊäòÊâ£È†ÖÁõÆÂú®ÂâçÔºåÊäòÊâ£È†ÖÁõÆÂú®ÂæåÔºâ
            container.innerHTML = `
                <div class="space-y-2">
                    ${displayItems.map(({ item, originalIndex }) => {
                        const categoryNames = {
                            consultation: 'Ë®∫ÁôÇË≤ª',
                            medicine: 'Ëó•Ë≤ª',
                            treatment: 'Ê≤ªÁôÇË≤ª',
                            other: 'ÂÖ∂‰ªñ',
                            discount: 'ÊäòÊâ£È†ÖÁõÆ',
                            package: 'Â•óÁ•®È†ÖÁõÆ'
                        };
                        const categoryName = categoryNames[item.category] || 'Êú™ÂàÜÈ°û';
                        const bgColor = getCategoryBgColor(item.category);
                        let subtotal;
                        let subtotalDisplay;
                        // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Â•óÁ•®‰ΩøÁî®
                        const isPackageUse = item.category === 'packageUse';
                        // ÂèñÊ∂àÊåâÈàïÔºöÂè™ÊúâÂú®Â•óÁ•®‰ΩøÁî®ÊôÇÈ°ØÁ§∫
                        const undoBtn = isPackageUse ? `
                                    <button
                                        type="button"
                                        class="ml-2 text-xs px-2 py-0.5 rounded border border-purple-300 text-purple-700 hover:bg-purple-50"
                                        onclick="undoPackageUse(${item.patientId}, ${item.packageRecordId}, '${item.id}')"
                                    >ÂèñÊ∂à‰ΩøÁî®</button>
                                ` : '';
                        // Êï∏ÈáèÊéßÂà∂ÂçÄÔºöÂ•óÁ•®‰ΩøÁî®È†ÖÁõÆ‰∏çÈ°ØÁ§∫Âä†Ê∏õËôü
                        const quantityControls = isPackageUse ? '' : `
                                <div class="flex items-center space-x-2 mr-3">
                                    <button onclick="updateBillingQuantity(${originalIndex}, -1)" class="w-6 h-6 bg-red-500 text-white rounded-full text-xs hover:bg-red-600 transition duration-200">-</button>
                                    <span class="w-8 text-center font-semibold">${item.quantity}</span>
                                    <button onclick="updateBillingQuantity(${originalIndex}, 1)" class="w-6 h-6 bg-green-500 text-white rounded-full text-xs hover:bg-green-600 transition duration-200">+</button>
                                </div>
                        `;
                        
                        if (item.category === 'discount' && item.price > 0 && item.price < 1) {
                            // ÁôæÂàÜÊØîÊäòÊâ£ÔºöÈ°ØÁ§∫ÊäòÊâ£ÈáëÈ°ç
                            const discountAmount = subtotalBeforeDiscount * (1 - item.price) * item.quantity;
                            subtotal = -discountAmount;
                            subtotalDisplay = `-$${discountAmount.toFixed(0)}`;
                        } else {
                            // ‰∏ÄËà¨È†ÖÁõÆÊàñÂõ∫ÂÆöÈáëÈ°çÊäòÊâ£
                            subtotal = item.price * item.quantity;
                            subtotalDisplay = `$${subtotal}`;
                        }
                        
                        return `
                            <div class="flex items-center ${bgColor} border rounded-lg p-3">
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-900">${item.name}</div>
                                    <div class="text-xs text-gray-600">${categoryName}</div>
                                    <div class="text-sm font-medium ${item.category === 'discount' ? 'text-red-600' : 'text-green-600'}">
                                        ${(() => {
                                            if (item.category === 'discount') {
                                                if (item.price > 0 && item.price < 1) {
                                                    return `${(item.price * 10).toFixed(1)}Êäò`;
                                                } else if (item.price < 0) {
                                                    return `-$${Math.abs(item.price)}`;
                                                } else {
                                                    return `$${item.price}`;
                                                }
                                            }
                                            return `$${item.price}`;
                                        })()}${item.unit ? ` / ${item.unit}` : ''}
                                    </div>
                                </div>
                                ${quantityControls}
                                <div class="mr-3 text-right">
                                    <div class="font-bold ${subtotal < 0 ? 'text-red-600' : 'text-green-600'}">${subtotalDisplay}</div>
                                </div>
                                ${undoBtn}<button onclick="removeBillingItem(${originalIndex})" class="text-red-500 hover:text-red-700 font-bold text-lg px-2">√ó</button>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <!-- Â∞èË®àÂíåÁ∏ΩË®àÈ°ØÁ§∫ -->
                ${subtotalBeforeDiscount > 0 && selectedBillingItems.some(item => item.category === 'discount') ? `
                    <div class="mt-4 pt-3 border-t border-gray-200">
                        <div class="text-right space-y-1">
                            <div class="text-sm text-gray-600">
                                Â∞èË®àÔºö<span class="font-medium">$${subtotalBeforeDiscount}</span>
                            </div>
                            ${selectedBillingItems.filter(item => item.category === 'discount').map(item => {
                                if (item.price > 0 && item.price < 1) {
                                    const discountAmount = subtotalBeforeDiscount * (1 - item.price) * item.quantity;
                                    return `<div class="text-sm text-red-600">
                                        ${item.name}Ôºö<span class="font-medium">-$${discountAmount.toFixed(0)}</span>
                                    </div>`;
                                } else {
                                    return `<div class="text-sm text-red-600">
                                        ${item.name}Ôºö<span class="font-medium">$${item.price * item.quantity}</span>
                                    </div>`;
                                }
                            }).join('')}
                            <div class="text-base font-bold text-green-600 pt-1 border-t border-gray-300">
                                Á∏ΩË®àÔºö$${Math.round(totalAmount)}
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
            
            // Êõ¥Êñ∞Èö±ËóèÁöÑÊñáÊú¨ÂüüÔºàÈùûÊäòÊâ£È†ÖÁõÆÂú®ÂâçÔºåÊäòÊâ£È†ÖÁõÆÂú®ÂæåÔºâ
            let billingText = '';
            
            // Â¶ÇÊûúÊúâÊäòÊâ£È†ÖÁõÆÔºåÂÖàÈ°ØÁ§∫Â∞èË®à
            if (selectedBillingItems.some(item => item.category === 'discount')) {
                billingText += `Â∞èË®àÔºö$${subtotalBeforeDiscount}\n\n`;
            }
            
            // ÂÖàË®òÈåÑÈùûÊäòÊâ£È†ÖÁõÆ
            selectedBillingItems.forEach(item => {
                if (item.category !== 'discount') {
                    billingText += `${item.name} x${item.quantity} = $${item.price * item.quantity}\n`;
                }
            });
            
            // ÂÜçË®òÈåÑÊäòÊâ£È†ÖÁõÆ
            selectedBillingItems.forEach(item => {
                if (item.category === 'discount') {
                    if (item.price > 0 && item.price < 1) {
                        // ÁôæÂàÜÊØîÊäòÊâ£
                        const discountAmount = subtotalBeforeDiscount * (1 - item.price) * item.quantity;
                        billingText += `${item.name} x${item.quantity} = -$${discountAmount.toFixed(0)}\n`;
                    } else {
                        // Âõ∫ÂÆöÈáëÈ°çÊäòÊâ£
                        billingText += `${item.name} x${item.quantity} = $${item.price * item.quantity}\n`;
                    }
                }
            });
            
            billingText += `\nÁ∏ΩË≤ªÁî®Ôºö$${Math.round(totalAmount)}`;
            hiddenTextarea.value = billingText.trim();
        }
        
        // Êõ¥Êñ∞Êî∂Ë≤ªÈ†ÖÁõÆÊï∏Èáè
        function updateBillingQuantity(index, change) {
            if (index >= 0 && index < selectedBillingItems.length) {
                const item = selectedBillingItems[index];
                // Â¶ÇÊûúÊòØÂ•óÁ•®‰ΩøÁî®Ôºå‰∏î change < 0ÔºåÁõ¥Êé•ÂèñÊ∂à‰ΩøÁî®‰∏¶ÈÄÄÂõûÊ¨°Êï∏
                if (change < 0 && item.category === 'packageUse') {
                    // Ë™øÁî®ÂèñÊ∂àÂáΩÂºèÔºåÈÄôÊúÉËá™ÂãïÁßªÈô§Ë©≤Á≠ÜË®òÈåÑ‰∏¶ÈÄÄÂõûÊ¨°Êï∏
                    undoPackageUse(item.patientId, item.packageRecordId, item.id);
                    return;
                }
                const newQuantity = item.quantity + change;
                if (newQuantity > 0) {
                    selectedBillingItems[index].quantity = newQuantity;
                    updateBillingDisplay();
                } else if (newQuantity === 0) {
                    // Êï∏ÈáèÁÇ∫0ÊôÇÁßªÈô§È†ÖÁõÆ
                    removeBillingItem(index);
                }
            }
        }
        
        // ÁßªÈô§Êî∂Ë≤ªÈ†ÖÁõÆ
        function removeBillingItem(index) {
            if (index >= 0 && index < selectedBillingItems.length) {
                const removedItem = selectedBillingItems[index];
                // Â¶ÇÊûúÊòØÂ•óÁ•®‰ΩøÁî®ÔºåÁßªÈô§ÊôÇÈúÄË¶ÅÈÄÄÂõûÂâ©È§òÊ¨°Êï∏
                if (removedItem.category === 'packageUse') {
                    // Áõ¥Êé•Ë™øÁî®ÂèñÊ∂àÂáΩÂºèÔºåÂÆÉÊúÉËá™ÂãïÂæûÈô£ÂàóÁßªÈô§‰∏¶ËôïÁêÜÊ¨°Êï∏
                    undoPackageUse(removedItem.patientId, removedItem.packageRecordId, removedItem.id);
                    return;
                }
                // Âê¶ÂâáÔºåÂñÆÁ¥îÁßªÈô§
                selectedBillingItems.splice(index, 1);
                updateBillingDisplay();
                // showToast(`Â∑≤ÁßªÈô§Ôºö${removedItem.name}`, 'info');
            }
        }
        
        // Ê∏ÖÈô§Êî∂Ë≤ªÈ†ÖÁõÆÊêúÁ¥¢
        function clearBillingSearch() {
            document.getElementById('billingSearch').value = '';
            document.getElementById('billingSearchResults').classList.add('hidden');
        }
        
        // Ê∏ÖÁ©∫ÊâÄÊúâÊêúÂ∞ãÊ¨Ñ‰Ωç
        function clearAllSearchFields() {
            // Ê∏ÖÁ©∫ÁóÖ‰∫∫ÊêúÂ∞ãÊ¨Ñ
            const patientSearchInput = document.getElementById('patientSearchInput');
            if (patientSearchInput) {
                patientSearchInput.value = '';
            }
            
            // Ê∏ÖÁ©∫ËôïÊñπÊêúÂ∞ãÊ¨Ñ
            clearPrescriptionSearch();
            
            // Ê∏ÖÁ©∫Êî∂Ë≤ªÈ†ÖÁõÆÊêúÂ∞ãÊ¨Ñ
            clearBillingSearch();
        }
        
        // Ëá™ÂãïÊ∑ªÂä†È†êË®≠Ë®∫ÈáëÊî∂Ë≤ª
        function addDefaultConsultationFee(patient) {
            // Â∞ãÊâæË®∫ÈáëÊî∂Ë≤ªÈ†ÖÁõÆÔºàÂÑ™ÂÖàÂ∞ãÊâæÂêçÁ®±ÂåÖÂê´„ÄåË®∫Èáë„ÄçÁöÑÈ†ÖÁõÆÔºâ
            let consultationFeeItem = billingItems.find(item => 
                item.active && 
                item.category === 'consultation' && 
                item.name.includes('Ë®∫Èáë')
            );
            
            // Â¶ÇÊûúÊ≤íÊúâÊâæÂà∞Ë®∫ÈáëÈ†ÖÁõÆÔºå‰ΩøÁî®Á¨¨‰∏ÄÂÄãË®∫ÁôÇË≤ªÈ†ÖÁõÆ
            if (!consultationFeeItem) {
                consultationFeeItem = billingItems.find(item => 
                    item.active && item.category === 'consultation'
                );
            }
            
            // Â¶ÇÊûúÊâæÂà∞Ë®∫ÈáëÈ†ÖÁõÆÔºåËá™ÂãïÊ∑ªÂä†
            if (consultationFeeItem) {
                // Ê∏ÖÁ©∫ÁèæÊúâÊî∂Ë≤ªÈ†ÖÁõÆ
                selectedBillingItems = [];
                
                // Ê∑ªÂä†Ë®∫ÈáëÈ†ÖÁõÆ
                const billingItem = {
                    id: consultationFeeItem.id,
                    name: consultationFeeItem.name,
                    category: consultationFeeItem.category,
                    price: consultationFeeItem.price,
                    unit: consultationFeeItem.unit,
                    description: consultationFeeItem.description,
                    quantity: 1
                };
                
                selectedBillingItems.push(billingItem);
                
                // Ëá™ÂãïÊ∑ªÂä†È†êË®≠Ëó•Ë≤ªÔºàÊ†πÊìöÈ†êË®≠5Â§©Ôºâ
                const defaultDays = 5;
                updateMedicineFeeByDays(defaultDays);
                
                // Êõ¥Êñ∞È°ØÁ§∫
                updateBillingDisplay();
            } else {
                // Â¶ÇÊûúÊ≤íÊúâÊâæÂà∞‰ªª‰ΩïË®∫ÁôÇË≤ªÈ†ÖÁõÆÔºåÂè™Ê∏ÖÁ©∫Êî∂Ë≤ªÈ†ÖÁõÆ‰∏¶Êõ¥Êñ∞È°ØÁ§∫
                selectedBillingItems = [];
                updateBillingDisplay();
            }
        }
        

        
        // ËºâÂÖ•‰∏äÊ¨°ËôïÊñπÂÖßÂÆπÔºàÊåâÈàïËß∏ÁôºÔºâ
        async function loadPreviousPrescription() {
            if (!currentConsultingAppointmentId) {
                showToast('Ë´ãÂÖàÈñãÂßãË®∫ÁóáÔºÅ', 'error');
                return;
            }
            
            const appointment = appointments.find(apt => apt.id === currentConsultingAppointmentId);
            if (!appointment) {
                showToast('Êâæ‰∏çÂà∞Áï∂ÂâçË®∫ÁóáË®òÈåÑÔºÅ', 'error');
                return;
            }
    try {            
const patientResult = await window.firebaseDataManager.getPatients();
if (!patientResult.success) {
    showToast('ÁÑ°Ê≥ïËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
    return;
}

const patient = patientResult.data.find(p => p.id === patientId);
if (!patient) {
    showToast('Êâæ‰∏çÂà∞ÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
    return;
}
            
            // Áç≤ÂèñË©≤ÁóÖ‰∫∫ÁöÑÊúÄËøë‰∏ÄÊ¨°Ë®∫ÁóáË®òÈåÑÔºàÊéíÈô§Áï∂ÂâçÊ≠£Âú®Á∑®ËºØÁöÑË®òÈåÑÔºâ
            const patientConsultations = consultations
                .filter(c => c.patientId === patient.id)
                .sort((a, b) => new Date(b.date) - new Date(a.date)); // ÊåâÊó•ÊúüÈôçÂ∫èÊéíÂàóÔºàÊúÄÊñ∞Âú®ÂâçÔºâ
            
            const lastConsultation = patientConsultations[0]; // ÊúÄËøë‰∏ÄÊ¨°Ë®∫ÁóáË®òÈåÑ
            
            if (!lastConsultation || !lastConsultation.prescription) {
                showToast(`${patient.name} Ê≤íÊúâ‰∏äÊ¨°ËôïÊñπË®òÈåÑÂèØËºâÂÖ•`, 'warning');
                return;
            }
            
            // Áõ¥Êé•ËºâÂÖ•Ôºå‰∏çÈúÄË¶ÅÁ¢∫Ë™ç
            // Ê∏ÖÁ©∫ÁèæÊúâËôïÊñπÈ†ÖÁõÆ
            selectedPrescriptionItems = [];
            
            // Ëß£Êûê‰∏äÊ¨°ËôïÊñπÂÖßÂÆπÔºåÈáçÂª∫ËôïÊñπÈ†ÖÁõÆ
            parsePrescriptionToItems(lastConsultation.prescription);
            
            // Êõ¥Êñ∞ËôïÊñπÈ°ØÁ§∫
            updatePrescriptionDisplay();
            
            // showToast(`Â∑≤ËºâÂÖ• ${patient.name} ‰∏äÊ¨°ÁöÑËôïÊñπÂÖßÂÆπ`, 'success');
            } catch (error) {
        console.error('ËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñôÈåØË™§:', error);
        showToast('ËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñôÂ§±Êïó', 'error');
    }
        }
        
        // Ëß£ÊûêËôïÊñπÂÖßÂÆπ‰∏¶ÈáçÂª∫ËôïÊñπÈ†ÖÁõÆ
        function parsePrescriptionToItems(prescriptionText) {
            if (!prescriptionText) return;
            
            const lines = prescriptionText.split('\n');
            let i = 0;
            
            while (i < lines.length) {
                const line = lines[i].trim();
                if (!line) {
                    i++;
                    continue;
                }
                
                // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Ëó•Êùê/ÊñπÂäëÊ†ºÂºèÔºàÂêçÁ®± ÂäëÈáègÔºâ
                const itemMatch = line.match(/^(.+?)\s+(\d+(?:\.\d+)?)g$/);
                if (itemMatch) {
                    const itemName = itemMatch[1].trim();
                    const dosage = itemMatch[2];
                    
                    // ÂÖàÂú®‰∏≠Ëó•Â∫´‰∏≠Â∞ãÊâæÂ∞çÊáâÁöÑÈ†ÖÁõÆÔºàÂÑ™ÂÖàÂåπÈÖç‰∏≠Ëó•ÊùêÔºåÂÜçÂåπÈÖçÊñπÂäëÔºâ
                    let foundItem = herbLibrary.find(item => 
                        item.type === 'herb' && item.name === itemName
                    );
                    
                    if (foundItem) {
                        // ÊâæÂà∞‰∏≠Ëó•Êùê
                        const prescriptionItem = {
                            id: foundItem.id,
                            type: 'herb',
                            name: foundItem.name,
                            dosage: foundItem.dosage || '6g',
                            customDosage: dosage,
                            effects: foundItem.effects
                        };
                        selectedPrescriptionItems.push(prescriptionItem);
                    } else {
                        // Ê≤íÊâæÂà∞‰∏≠Ëó•ÊùêÔºåÂ∞ãÊâæÊñπÂäë
                        foundItem = herbLibrary.find(item => 
                            item.type === 'formula' && item.name === itemName
                        );
                        
                        if (foundItem) {
                            // ÊâæÂà∞ÊñπÂäë
                            const prescriptionItem = {
                                id: foundItem.id,
                                type: 'formula',
                                name: foundItem.name,
                                customDosage: dosage,
                                composition: foundItem.composition,
                                effects: foundItem.effects
                            };
                            selectedPrescriptionItems.push(prescriptionItem);
                        } else {
                            // ÈÉΩÊ≤íÊâæÂà∞ÔºåÊ†πÊìöÂ∏∏Ë¶ãÊñπÂäëÂêçÁ®±ÁâπÂæµÊô∫ËÉΩÂà§Êñ∑È°ûÂûã
                            const isLikelyFormula = isFormulaName(itemName);
                            
                            const prescriptionItem = {
                                id: Date.now() + Math.random(), // Ëá®ÊôÇID
                                type: isLikelyFormula ? 'formula' : 'herb',
                                name: itemName,
                                customDosage: dosage,
                                effects: 'ÔºàÂæû‰∏äÊ¨°ËôïÊñπËºâÂÖ•Ôºâ'
                            };
                            
                            if (isLikelyFormula) {
                                prescriptionItem.composition = 'ÔºàÂæû‰∏äÊ¨°ËôïÊñπËºâÂÖ•Ôºâ';
                            } else {
                                prescriptionItem.dosage = `${dosage}g`;
                            }
                            
                            selectedPrescriptionItems.push(prescriptionItem);
                        }
                    }
                }
                
                i++;
            }
        }
        
        // Âà§Êñ∑ÊòØÂê¶ÁÇ∫ÊñπÂäëÂêçÁ®±ÁöÑËºîÂä©ÂáΩÊï∏
        function isFormulaName(name) {
            // Â∏∏Ë¶ãÊñπÂäëÂêçÁ®±ÁâπÂæµ
            const formulaKeywords = [
                'ÊπØ', 'Êï£', '‰∏∏', 'ËÜè', 'È£≤', '‰∏π', 'ÁÖé', 'Êñπ', 'Âäë',
                'ÂõõÂêõÂ≠ê', 'ÂÖ≠ÂêõÂ≠ê', 'ÂÖ´Áèç', 'ÂçÅÂÖ®', 'Ë£ú‰∏≠ÁõäÊ∞£', 'ÈÄçÈÅô',
                'ÁîòÈ∫•Â§ßÊ£ó', 'Â∞èÊü¥ËÉ°', 'Â§ßÊü¥ËÉ°', 'ÂçäÂ§èÁÄâÂøÉ', 'ÈªÉÈÄ£Ëß£ÊØí',
                'Ê∏ÖÁÜ±Ëß£ÊØí', 'ÈäÄÁøπ', 'Ê°ëËèä', 'È∫ªÈªÉ', 'Ê°ÇÊûù', 'ËëõÊ†π',
                'ÁôΩËôé', 'ÊâøÊ∞£', 'ÁêÜ‰∏≠', 'ÁúüÊ≠¶', 'ËãìÊ°Ç', '‰∫îËãì'
            ];
            
            return formulaKeywords.some(keyword => name.includes(keyword));
        }
        

        
        // ËºâÂÖ•‰∏äÊ¨°Êî∂Ë≤ªÈ†ÖÁõÆÔºàÊåâÈàïËß∏ÁôºÔºâ
        async function loadPreviousBillingItems() {
            if (!currentConsultingAppointmentId) {
                showToast('Ë´ãÂÖàÈñãÂßãË®∫ÁóáÔºÅ', 'error');
                return;
            }
            
            const appointment = appointments.find(apt => apt.id === currentConsultingAppointmentId);
            if (!appointment) {
                showToast('Êâæ‰∏çÂà∞Áï∂ÂâçË®∫ÁóáË®òÈåÑÔºÅ', 'error');
                return;
            }
    try {             
const patientResult = await window.firebaseDataManager.getPatients();
if (!patientResult.success) {
    showToast('ÁÑ°Ê≥ïËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
    return;
}

const patient = patientResult.data.find(p => p.id === patientId);
if (!patient) {
    showToast('Êâæ‰∏çÂà∞ÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
    return;
}
            
            // Áç≤ÂèñË©≤ÁóÖ‰∫∫ÁöÑÊúÄËøë‰∏ÄÊ¨°Ë®∫ÁóáË®òÈåÑ
            const patientConsultations = consultations
                .filter(c => c.patientId === patient.id)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const lastConsultation = patientConsultations[0];
            
            if (!lastConsultation || !lastConsultation.billingItems) {
                showToast(`${patient.name} Ê≤íÊúâ‰∏äÊ¨°Êî∂Ë≤ªË®òÈåÑÂèØËºâÂÖ•`, 'warning');
                return;
            }
            
            // Áõ¥Êé•ËºâÂÖ•Ôºå‰∏çÈúÄË¶ÅÁ¢∫Ë™ç
            // Ê∏ÖÁ©∫ÁèæÊúâÊî∂Ë≤ªÈ†ÖÁõÆ
            selectedBillingItems = [];
            
            // Ëß£Êûê‰∏¶ËºâÂÖ•‰∏äÊ¨°Êî∂Ë≤ªÈ†ÖÁõÆ
            parseBillingItemsFromText(lastConsultation.billingItems);
            
            // Êõ¥Êñ∞È°ØÁ§∫
            updateBillingDisplay();
            } catch (error) {
        console.error('ËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñôÈåØË™§:', error);
        showToast('ËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñôÂ§±Êïó', 'error');
    }
        }
        
        // Ëß£ÊûêÊî∂Ë≤ªÈ†ÖÁõÆÊñáÂ≠ó‰∏¶ËºâÂÖ•
        function parseBillingItemsFromText(billingText) {
            if (!billingText) {
                return;
            }
            
            // Ëß£Êûê‰∏äÊ¨°Êî∂Ë≤ªÈ†ÖÁõÆ
            const billingLines = billingText.split('\n');
            
            billingLines.forEach(line => {
                line = line.trim();
                if (!line || line.includes('Â∞èË®à') || line.includes('Á∏ΩË≤ªÁî®')) return;
                
                // Ëß£ÊûêÊî∂Ë≤ªÈ†ÖÁõÆÊ†ºÂºèÔºöÈ†ÖÁõÆÂêç xÊï∏Èáè = $ÈáëÈ°ç Êàñ È†ÖÁõÆÂêç xÊï∏Èáè = -$ÈáëÈ°ç
                const itemMatch = line.match(/^(.+?)\s+x(\d+)\s+=\s+([\-\$]?\d+)$/);
                if (itemMatch) {
                    const itemName = itemMatch[1].trim();
                    const quantity = parseInt(itemMatch[2]);
                    
                    // Âú®Êî∂Ë≤ªÈ†ÖÁõÆ‰∏≠Â∞ãÊâæÂ∞çÊáâÁöÑÈ†ÖÁõÆ
                    const billingItem = billingItems.find(item => 
                        item.active && item.name === itemName
                    );
                    
                    if (billingItem) {
                        const selectedItem = {
                            id: billingItem.id,
                            name: billingItem.name,
                            category: billingItem.category,
                            price: billingItem.price,
                            unit: billingItem.unit,
                            description: billingItem.description,
                            quantity: quantity
                        };
                        selectedBillingItems.push(selectedItem);
                    } else {
                        // Â¶ÇÊûúÂú®Êî∂Ë≤ªÈ†ÖÁõÆ‰∏≠Êâæ‰∏çÂà∞ÔºåÂâµÂª∫‰∏ÄÂÄãËá®ÊôÇÈ†ÖÁõÆÔºàÁî®ÊñºÂ∑≤Âà™Èô§ÁöÑÊî∂Ë≤ªÈ†ÖÁõÆÔºâ
                        console.log(`Êâæ‰∏çÂà∞Êî∂Ë≤ªÈ†ÖÁõÆÔºö${itemName}ÔºåÂèØËÉΩÂ∑≤Ë¢´Âà™Èô§`);
                    }
                }
            });
        }
        
        // ËºâÂÖ•‰∏äÊ¨°Êî∂Ë≤ªÈ†ÖÁõÆÔºàÂÖßÈÉ®ÂáΩÊï∏ - ‰øùÁïôÂêëÂæåÂÖºÂÆπÔºâ
        function loadPreviousBillingItemsFromConsultation(lastConsultation) {
            selectedBillingItems = [];
            parseBillingItemsFromText(lastConsultation.billingItems);
            updateBillingDisplay();
        }
        
        // ËºâÂÖ•ÊåáÂÆöÁóÖÊ≠∑Ë®òÈåÑÂà∞Áï∂ÂâçË®∫Áóá
        async function loadMedicalRecordToCurrentConsultation(consultationId) {
            if (!currentConsultingAppointmentId) {
                showToast('Ë´ãÂÖàÈñãÂßãË®∫ÁóáÔºÅ', 'error');
                return;
            }
            
            const consultation = consultations.find(c => c.id === consultationId);
            if (!consultation) {
                showToast('Êâæ‰∏çÂà∞ÊåáÂÆöÁöÑË®∫ÁóáË®òÈåÑÔºÅ', 'error');
                return;
            }
            
            const currentAppointment = appointments.find(apt => apt.id === currentConsultingAppointmentId);
            if (!currentAppointment) {
                showToast('Êâæ‰∏çÂà∞Áï∂ÂâçË®∫ÁóáË®òÈåÑÔºÅ', 'error');
                return;
            }
            
            // Á¢∫Ë™çÊòØÂê¶ÁÇ∫Áõ∏ÂêåÁóÖ‰∫∫
            if (currentAppointment.patientId !== consultation.patientId) {
                showToast('Âè™ËÉΩËºâÂÖ•Áõ∏ÂêåÁóÖ‰∫∫ÁöÑÁóÖÊ≠∑Ë®òÈåÑÔºÅ', 'error');
                return;
            }
            
const patientResult = await window.firebaseDataManager.getPatients();
if (!patientResult.success) {
    showToast('ÁÑ°Ê≥ïËÆÄÂèñÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
    return;
}

const patient = patientResult.data.find(p => p.id === consultation.patientId);
if (!patient) {
    showToast('Êâæ‰∏çÂà∞ÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
    return;
}

const consultationDate = new Date(consultation.date).toLocaleDateString('zh-TW');
            
            // Á¢∫Ë™çËºâÂÖ•Êìç‰Ωú
            const confirmMessage = `Á¢∫ÂÆöË¶ÅËºâÂÖ• ${patient ? patient.name : 'Êú™Áü•ÁóÖ‰∫∫'} Âú® ${consultationDate} ÁöÑÁóÖÊ≠∑Ë®òÈåÑÂóéÔºü\n\n` +
                                 `Ê≠§Êìç‰ΩúÂ∞áÊúÉË¶ÜËìãÁï∂ÂâçÂ∑≤Â°´ÂØ´ÁöÑË®∫ÁóáÂÖßÂÆπÔºåÂåÖÊã¨Ôºö\n` +
                                 `‚Ä¢ ‰∏ªË®¥„ÄÅËàåË±°„ÄÅËÑàË±°Á≠âË®∫ÁóáË≥áÊñô\n` +
                                 `‚Ä¢ Ë®∫Êñ∑ÂíåË≠âÂûã\n` +
                                 `‚Ä¢ ËôïÊñπÂÖßÂÆπ\n` +
                                 `‚Ä¢ Êî∂Ë≤ªÈ†ÖÁõÆ\n` +
                                 `‚Ä¢ ÈÜ´ÂõëÂíåÊ≥®ÊÑè‰∫ãÈ†Ö\n\n` +
                                 `Ê≥®ÊÑèÔºöÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // ËºâÂÖ•Ë®∫ÁóáË≥áÊñô
            document.getElementById('formSymptoms').value = consultation.symptoms || '';
            document.getElementById('formTongue').value = consultation.tongue || '';
            document.getElementById('formPulse').value = consultation.pulse || '';
            document.getElementById('formCurrentHistory').value = consultation.currentHistory || '';
            document.getElementById('formDiagnosis').value = consultation.diagnosis || '';
            document.getElementById('formSyndrome').value = consultation.syndrome || '';
            document.getElementById('formAcupunctureNotes').value = consultation.acupunctureNotes || '';
            document.getElementById('formUsage').value = consultation.usage || '';
            document.getElementById('formTreatmentCourse').value = consultation.treatmentCourse || '';
            document.getElementById('formInstructions').value = consultation.instructions || '';
            document.getElementById('formFollowUpDate').value = consultation.followUpDate || '';
            document.getElementById('formVisitTime').value = consultation.visitTime || '';
            
            // ËºâÂÖ•‰ºëÊÅØÊúüÈñì
            if (consultation.restStartDate && consultation.restEndDate) {
                document.getElementById('formRestStartDate').value = consultation.restStartDate;
                document.getElementById('formRestEndDate').value = consultation.restEndDate;
                updateRestPeriod();
            } else {
                // ‰ΩøÁî®È†êË®≠‰ºëÊÅØÊúüÈñìÔºà‰ªäÂ§©Âà∞ÂæåÂ§©Ôºâ
                const startDate = new Date();
                const endDate = new Date();
                endDate.setDate(startDate.getDate() + 2);
                
                const startDateStr = `${startDate.getFullYear()}-${String(startDate.getMonth() + 1).padStart(2, '0')}-${String(startDate.getDate()).padStart(2, '0')}`;
                const endDateStr = `${endDate.getFullYear()}-${String(endDate.getMonth() + 1).padStart(2, '0')}-${String(endDate.getDate()).padStart(2, '0')}`;
                
                document.getElementById('formRestStartDate').value = startDateStr;
                document.getElementById('formRestEndDate').value = endDateStr;
                updateRestPeriod();
            }
            
            // ËºâÂÖ•ËôïÊñπÂÖßÂÆπ
            selectedPrescriptionItems = [];
            if (consultation.prescription) {
                // Áõ¥Êé•Â∞áËôïÊñπÂÖßÂÆπË®≠ÁΩÆÂà∞Èö±ËóèÊñáÊú¨Âüü
                document.getElementById('formPrescription').value = consultation.prescription;
                
                // Ëß£ÊûêËôïÊñπÂÖßÂÆπ‰∏¶ÈáçÂª∫ËôïÊñπÈ†ÖÁõÆ
                parsePrescriptionToItems(consultation.prescription);
                
                // Êõ¥Êñ∞ËôïÊñπÈ°ØÁ§∫
                updatePrescriptionDisplay();
            } else {
                // Ê∏ÖÁ©∫ËôïÊñπ
                document.getElementById('formPrescription').value = '';
                updatePrescriptionDisplay();
            }
            
            // ËºâÂÖ•Êî∂Ë≤ªÈ†ÖÁõÆ
            selectedBillingItems = [];
            if (consultation.billingItems) {
                // Áõ¥Êé•Â∞áÊî∂Ë≤ªÈ†ÖÁõÆË®≠ÁΩÆÂà∞Èö±ËóèÊñáÊú¨Âüü
                document.getElementById('formBillingItems').value = consultation.billingItems;
                
                // Ëß£Êûê‰∏¶ËºâÂÖ•Êî∂Ë≤ªÈ†ÖÁõÆ
                parseBillingItemsFromText(consultation.billingItems);
                
                // Êõ¥Êñ∞Êî∂Ë≤ªÈ°ØÁ§∫
                updateBillingDisplay();
            } else {
                // Ê∏ÖÁ©∫Êî∂Ë≤ªÈ†ÖÁõÆ
                document.getElementById('formBillingItems').value = '';
                updateBillingDisplay();
            }
            
            // Ê∏ÖÈô§ÊêúÁ¥¢Ê°Ü
            clearPrescriptionSearch();
            clearBillingSearch();
            
            // ÈóúÈñâÁóÖÊ≠∑Êü•ÁúãÂΩàÁ™ó
            closeMedicalHistoryModal();
            
            // ÊªæÂãïÂà∞Ë®∫ÁóáË°®ÂñÆ
            document.getElementById('consultationForm').scrollIntoView({ behavior: 'smooth' });
            
            showToast(`Â∑≤ËºâÂÖ• ${patient ? patient.name : 'Êú™Áü•ÁóÖ‰∫∫'} Âú® ${consultationDate} ÁöÑÂÆåÊï¥ÁóÖÊ≠∑Ë®òÈåÑ`, 'success');
        }
        
        // Ê∏ÖÁ©∫Ë®∫ÁóáË°®ÂñÆÊôÇ‰πüË¶ÅÊ∏ÖÁ©∫ËôïÊñπÊêúÁ¥¢
        function clearConsultationFormOld() {
            ['formSymptoms', 'formTongue', 'formPulse', 'formCurrentHistory', 'formDiagnosis', 'formSyndrome', 'formAcupunctureNotes', 'formPrescription', 'formUsage', 'formTreatmentCourse', 'formInstructions', 'formFollowUpDate'].forEach(id => {
                document.getElementById(id).value = '';
            });
            
            // Ê∏ÖÁ©∫ËôïÊñπÈ†ÖÁõÆ
            selectedPrescriptionItems = [];
            updatePrescriptionDisplay();
            clearPrescriptionSearch();
            
            // Ê∏ÖÁ©∫Êî∂Ë≤ªÈ†ÖÁõÆ
            selectedBillingItems = [];
            updateBillingDisplay();
            clearBillingSearch();
        }



        // Áç≤ÂèñÁî®Êà∂È°ØÁ§∫ÂêçÁ®±ÔºàÂßìÂêçÂÖ®Âêç + ËÅ∑‰ΩçÔºâ
        function getUserDisplayName(user) {
            if (!user || !user.name) return 'Êú™Áü•Áî®Êà∂';
            
            const fullName = user.name;
            const position = user.position || 'Áî®Êà∂';
            
            return `${fullName}${position}`;
        }
        
        // Áç≤ÂèñÈÜ´Â∏´È°ØÁ§∫ÂêçÁ®±
        function getDoctorDisplayName(doctorRole) {
            if (!doctorRole) return 'Êú™Ë®òÈåÑ';
            
            // Â¶ÇÊûúÊòØËàäÁöÑÂõ∫ÂÆöÂÄºÔºåÁõ¥Êé•ËøîÂõû
            if (doctorRole === 'doctor') {
                return 'Âºµ‰∏≠ÈÜ´Â∏´ÈÜ´Â∏´';
            }
            
            // Â∞ãÊâæÂ∞çÊáâÁöÑÈÜ´Â∏´Áî®Êà∂
            const doctorUser = users.find(u => u.username === doctorRole);
            if (doctorUser) {
                return getUserDisplayName(doctorUser);
            }
            
            // Â¶ÇÊûúÊâæ‰∏çÂà∞ÔºåËøîÂõûÂéüÂÄº
            return doctorRole;
        }
        
        // Áç≤ÂèñÈÜ´Â∏´Ë®ªÂÜäÁ∑®Ëôü
        function getDoctorRegistrationNumber(doctorRole) {
            if (!doctorRole) return null;
            
            // Â¶ÇÊûúÊòØËàäÁöÑÂõ∫ÂÆöÂÄºÔºåËøîÂõûÈ†êË®≠Ë®ªÂÜäÁ∑®Ëôü
            if (doctorRole === 'doctor') {
                return 'CM001234';
            }
            
            // Â∞ãÊâæÂ∞çÊáâÁöÑÈÜ´Â∏´Áî®Êà∂
            const doctorUser = users.find(u => u.username === doctorRole);
            if (doctorUser && doctorUser.position === 'ÈÜ´Â∏´') {
                return doctorUser.registrationNumber || null;
            }
            
            return null;
        }
        
// Áî®Êà∂ÁÆ°ÁêÜÂäüËÉΩ
let editingUserId = null;
let currentUserFilter = 'all';
let usersFromFirebase = []; // ÂÑ≤Â≠òÂæû Firebase ËÆÄÂèñÁöÑÁî®Êà∂Êï∏Êìö

async function loadUserManagement() {
    await loadUsersFromFirebase();
    displayUsers();
    
    // ÊêúÂ∞ãÂäüËÉΩ
    const searchInput = document.getElementById('searchUser');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            displayUsers();
        });
    }
}

// Âæû Firebase ËºâÂÖ•Áî®Êà∂Êï∏Êìö
async function loadUsersFromFirebase() {
    const tbody = document.getElementById('userList');
    
    // È°ØÁ§∫ËºâÂÖ•‰∏≠
    tbody.innerHTML = `
        <tr>
            <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
                <div class="mt-2">ËºâÂÖ•‰∏≠...</div>
            </td>
        </tr>
    `;

    try {
        const result = await window.firebaseDataManager.getUsers();
        
        if (result.success) {
            usersFromFirebase = result.data;
            // ÂêåÊôÇÊõ¥Êñ∞Êú¨Âú∞ users ËÆäÊï∏‰ª•‰øùÊåÅÂÖºÂÆπÊÄß
            users = result.data.map(user => ({
                ...user,
                // Á¢∫‰øùÊï∏ÊìöÊ†ºÂºèÂÖºÂÆπÊÄß
                createdAt: user.createdAt ? (user.createdAt.seconds ? new Date(user.createdAt.seconds * 1000).toISOString() : user.createdAt) : new Date().toISOString(),
                updatedAt: user.updatedAt ? (user.updatedAt.seconds ? new Date(user.updatedAt.seconds * 1000).toISOString() : user.updatedAt) : new Date().toISOString(),
                lastLogin: user.lastLogin ? (user.lastLogin.seconds ? new Date(user.lastLogin.seconds * 1000).toISOString() : user.lastLogin) : null
            }));
            
            console.log('Â∑≤Âæû Firebase ËºâÂÖ•Áî®Êà∂Êï∏Êìö:', usersFromFirebase.length, 'Á≠Ü');
        } else {
            // Â¶ÇÊûú Firebase ËÆÄÂèñÂ§±ÊïóÔºå‰ΩøÁî®Êú¨Âú∞ users Êï∏Êìö
            usersFromFirebase = users;
            console.log('Firebase ËÆÄÂèñÂ§±ÊïóÔºå‰ΩøÁî®Êú¨Âú∞Áî®Êà∂Êï∏Êìö');
        }
    } catch (error) {
        console.error('ËºâÂÖ•Áî®Êà∂Êï∏ÊìöÈåØË™§:', error);
        usersFromFirebase = users; // ‰ΩøÁî®Êú¨Âú∞Êï∏Êìö‰ΩúÁÇ∫ÂÇôÁî®
        showToast('ËºâÂÖ•Áî®Êà∂Êï∏ÊìöÊôÇÁôºÁîüÈåØË™§Ôºå‰ΩøÁî®Êú¨Âú∞Êï∏Êìö', 'warning');
    }
}

function filterUsers(status) {
    currentUserFilter = status;
    
    // Êõ¥Êñ∞ÊåâÈàïÊ®£Âºè
    document.querySelectorAll('[id^="user-filter-"]').forEach(btn => {
        btn.className = 'px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200';
    });
    document.getElementById(`user-filter-${status}`).className = 'px-4 py-2 rounded-lg text-sm font-medium bg-blue-100 text-blue-800 transition duration-200';
    
    displayUsers();
}

function displayUsers() {
    const searchTerm = document.getElementById('searchUser').value.toLowerCase();
    const tbody = document.getElementById('userList');
    
    // ‰ΩøÁî® Firebase Êï∏ÊìöÊàñÊú¨Âú∞Êï∏Êìö
    const currentUsers = usersFromFirebase.length > 0 ? usersFromFirebase : users;
    
    // ÈÅéÊøæÁî®Êà∂Ë≥áÊñô
    let filteredUsers = currentUsers.filter(user => {
        // ÂÉÖ‰ª•ÂßìÂêçÊàñÈõªÂ≠êÈÉµ‰ª∂ÈÄ≤Ë°åÊêúÂ∞ãÔºå‰∏çÂåÖÂê´Â∏≥Ëôü
        const matchesSearch = user.name.toLowerCase().includes(searchTerm) ||
                            (user.email && user.email.toLowerCase().includes(searchTerm));
        
        let matchesFilter = true;
        if (currentUserFilter === 'inactive') {
            matchesFilter = !user.active;
        }
        
        return matchesSearch && matchesFilter;
    });
    
        tbody.innerHTML = '';
    
    if (filteredUsers.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                    ${searchTerm ? 'Ê≤íÊúâÊâæÂà∞Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑÁî®Êà∂' : 'Â∞öÁÑ°Áî®Êà∂Ë≥áÊñô'}
                </td>
            </tr>
        `;
        return;
    }
    
        filteredUsers.forEach(user => {
        const statusClass = user.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
        const statusText = user.active ? 'ÂïüÁî®' : 'ÂÅúÁî®';
        
        // ËôïÁêÜ Firebase Timestamp Ê†ºÂºè
        let lastLogin = 'ÂæûÊú™ÁôªÂÖ•';
        if (user.lastLogin) {
            if (user.lastLogin.seconds) {
                lastLogin = new Date(user.lastLogin.seconds * 1000).toLocaleString('zh-TW');
            } else {
                lastLogin = new Date(user.lastLogin).toLocaleString('zh-TW');
            }
        }
        
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
            <td class="px-4 py-3 text-sm text-gray-900">${user.name}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${user.position || 'Êú™Ë®≠ÂÆö'}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${user.position === 'ÈÜ´Â∏´' ? (user.registrationNumber || 'Êú™Ë®≠ÂÆö') : '-'}</td>
            <td class="px-4 py-3 text-sm text-gray-900">${user.email || 'Êú™Ë®≠ÂÆö'}</td>
            <td class="px-4 py-3">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                    ${statusText}
                </span>
            </td>
            <td class="px-4 py-3 text-sm text-gray-600">${lastLogin}</td>
            <td class="px-4 py-3 text-sm space-x-2">
                <button onclick="editUser('${user.id}')" class="text-blue-600 hover:text-blue-800">Á∑®ËºØ</button>
                ${user.id !== currentUserData.id ? `
                    <button onclick="toggleUserStatus('${user.id}')" class="text-orange-600 hover:text-orange-800">
                        ${user.active ? 'ÂÅúÁî®' : 'ÂïüÁî®'}
                    </button>
                    <button onclick="deleteUser('${user.id}')" class="text-red-600 hover:text-red-800">Âà™Èô§</button>
                ` : `
                    <span class="text-gray-400 text-xs">Áï∂ÂâçÁî®Êà∂</span>
                `}
            </td>
        `;
        tbody.appendChild(row);
    });
}

function showAddUserForm() {
    editingUserId = null;
    // ‰ΩøÁî®Èò≤ÂëÜËôïÁêÜÔºåÈÅøÂÖçÁõÆÊ®ôÂÖÉÁ¥†‰∏çÂ≠òÂú®ÊôÇÊããÂá∫ÈåØË™§
    const titleEl = document.getElementById('userFormTitle');
    if (titleEl) {
        titleEl.textContent = 'Êñ∞Â¢ûÁî®Êà∂';
    }
    const saveBtnTextEl = document.getElementById('userSaveButtonText');
    if (saveBtnTextEl) {
        saveBtnTextEl.textContent = 'ÂÑ≤Â≠ò';
    }
    clearUserForm();
    const modalEl = document.getElementById('addUserModal');
    if (modalEl) {
        modalEl.classList.remove('hidden');
    }
}

function hideAddUserForm() {
    document.getElementById('addUserModal').classList.add('hidden');
    clearUserForm();
    editingUserId = null;
}

function clearUserForm() {
    ['userDisplayName', 'userPosition', 'userEmail', 'userPhone', 'userRegistrationNumber', 'userUID'].forEach(id => {
        document.getElementById(id).value = '';
    });
    document.getElementById('userActive').checked = true;
    
    // Èö±ËóèË®ªÂÜäÁ∑®ËôüÊ¨Ñ‰Ωç
    document.getElementById('registrationNumberField').classList.add('hidden');
}

// ÂàáÊèõË®ªÂÜäÁ∑®ËôüÊ¨Ñ‰ΩçÈ°ØÁ§∫
function toggleRegistrationNumberField() {
    const positionSelect = document.getElementById('userPosition');
    const registrationField = document.getElementById('registrationNumberField');
    
    if (positionSelect.value === 'ÈÜ´Â∏´') {
        registrationField.classList.remove('hidden');
    } else {
        registrationField.classList.add('hidden');
        // Ê∏ÖÁ©∫Ë®ªÂÜäÁ∑®ËôüÊ¨Ñ‰Ωç
        document.getElementById('userRegistrationNumber').value = '';
    }
}

async function editUser(id) {
    const currentUsers = usersFromFirebase.length > 0 ? usersFromFirebase : users;
    const user = currentUsers.find(u => u.id === id);
    if (!user) return;
    
    editingUserId = id;
    // ‰ΩøÁî®Èò≤ÂëÜËôïÁêÜÔºåÈÅøÂÖçÁõÆÊ®ôÂÖÉÁ¥†‰∏çÂ≠òÂú®ÊôÇÊããÂá∫ÈåØË™§
    const titleEl = document.getElementById('userFormTitle');
    if (titleEl) {
        titleEl.textContent = 'Á∑®ËºØÁî®Êà∂';
    }
    const saveBtnTextEl = document.getElementById('userSaveButtonText');
    if (saveBtnTextEl) {
        saveBtnTextEl.textContent = 'Êõ¥Êñ∞';
    }
    
    // Â∏≥ËôüÂèäÂØÜÁ¢ºÊ¨Ñ‰ΩçÂ∑≤ÁßªÈô§ÔºåÁÑ°ÈúÄÂ°´ÂÖÖÁõ∏ÈóúË≥áÊñô
    // Â°´ÂÖÖË°®ÂñÆË≥áÊñô
    const displayNameEl = document.getElementById('userDisplayName');
    if (displayNameEl) displayNameEl.value = user.name || '';
    const positionEl = document.getElementById('userPosition');
    if (positionEl) positionEl.value = user.position || '';
    const emailEl = document.getElementById('userEmail');
    if (emailEl) emailEl.value = user.email || '';
    const phoneEl = document.getElementById('userPhone');
    if (phoneEl) phoneEl.value = user.phone || '';
    const regNumEl = document.getElementById('userRegistrationNumber');
    if (regNumEl) regNumEl.value = user.registrationNumber || '';
    const activeEl = document.getElementById('userActive');
    if (activeEl) activeEl.checked = user.active !== false;

    // Â°´ÂÖ• Firebase UID
    const uidEl = document.getElementById('userUID');
    if (uidEl) uidEl.value = user.uid || '';
    
    // Ê†πÊìöËÅ∑‰ΩçÈ°ØÁ§∫ÊàñÈö±ËóèË®ªÂÜäÁ∑®ËôüÊ¨Ñ‰Ωç
    toggleRegistrationNumberField();
    
    const modalEl = document.getElementById('addUserModal');
    if (modalEl) {
        modalEl.classList.remove('hidden');
    }
}

async function saveUser() {
    // Â∏≥ËôüÂèäÂØÜÁ¢ºÊ¨Ñ‰ΩçÂ∑≤ÁßªÈô§Ôºå‰ΩøÁî® UID ÊàñÈõªÂ≠êÈÉµ‰ª∂Ëá™ÂãïÁî¢ÁîüÂÖßÈÉ®Ë≠òÂà•ÂêçÁ®±
    const name = document.getElementById('userDisplayName').value.trim();
    const position = document.getElementById('userPosition').value.trim();
    const email = document.getElementById('userEmail').value.trim();
    const phone = document.getElementById('userPhone').value.trim();
    const registrationNumber = document.getElementById('userRegistrationNumber').value.trim();
    const active = document.getElementById('userActive').checked;
    const uid = document.getElementById('userUID').value.trim();

    // Áî¢ÁîüÂÖßÈÉ®Áî®Êà∂Ë≠òÂà•ÂêçÁ®±ÔºàusernameÔºâ
    let username;
    if (uid) {
        username = uid;
    } else if (email) {
        username = email.split('@')[0];
    } else {
        username = 'user_' + Date.now();
    }
    
    // È©óË≠âÂøÖÂ°´Ê¨Ñ‰ΩçÔºàÂßìÂêçËàáËÅ∑‰ΩçÔºâ
    if (!name || !position) {
        showToast('Ë´ãÂ°´ÂØ´ÂøÖË¶ÅË≥áÊñôÔºàÂßìÂêç„ÄÅËÅ∑‰ΩçÔºâÔºÅ', 'error');
        return;
    }
    
    // ÈÜ´Â∏´ËÅ∑‰ΩçÂøÖÈ†àÂ°´ÂØ´Ë®ªÂÜäÁ∑®Ëôü
    if (position === 'ÈÜ´Â∏´' && !registrationNumber) {
        showToast('ÈÜ´Â∏´ËÅ∑‰ΩçÂøÖÈ†àÂ°´ÂØ´‰∏≠ÈÜ´Ë®ªÂÜäÁ∑®ËôüÔºÅ', 'error');
        return;
    }
    
    // Ê™¢Êü•ÈõªÂ≠êÈÉµ‰ª∂ÊòØÂê¶ÈáçË§á
    if (email) {
        const currentUsers = usersFromFirebase.length > 0 ? usersFromFirebase : users;
        const existingUserByEmail = currentUsers.find(u => u.email && u.email.toLowerCase() === email.toLowerCase() && u.id !== editingUserId);
        if (existingUserByEmail) {
            showToast('Ê≠§ÈõªÂ≠êÈÉµ‰ª∂Â∑≤Â≠òÂú®ÔºåË´ã‰ΩøÁî®ÂÖ∂‰ªñÈõªÂ≠êÈÉµ‰ª∂ÔºÅ', 'error');
            return;
        }
    }
    
    // È©óË≠âÈõªÂ≠êÈÉµ‰ª∂Ê†ºÂºè
    if (email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showToast('Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÈõªÂ≠êÈÉµ‰ª∂Ê†ºÂºèÔºÅ', 'error');
            return;
        }
    }

    // È°ØÁ§∫‰øùÂ≠ò‰∏≠ÁãÄÊÖã
    const saveButton = document.querySelector('[onclick="saveUser()"]');
    const originalText = saveButton.textContent;
    saveButton.textContent = '‰øùÂ≠ò‰∏≠...';
    saveButton.disabled = true;

    try {
        if (editingUserId) {
            // Êõ¥Êñ∞ÁèæÊúâÁî®Êà∂
            const userData = {
                name: name,
                position: position,
                registrationNumber: position === 'ÈÜ´Â∏´' ? registrationNumber : null,
                email: email,
                phone: phone,
                uid: uid || '',
                active: active
            };

            const result = await window.firebaseDataManager.updateUser(editingUserId, userData);
            
            if (result.success) {
                // Êõ¥Êñ∞Êú¨Âú∞Êï∏Êìö
                const userIndex = users.findIndex(u => u.id === editingUserId);
                if (userIndex !== -1) {
                    users[userIndex] = { ...users[userIndex], ...userData, updatedAt: new Date().toISOString() };
                }

                // Êõ¥Êñ∞ Firebase Êï∏Êìö
                const firebaseUserIndex = usersFromFirebase.findIndex(u => u.id === editingUserId);
                if (firebaseUserIndex !== -1) {
                    usersFromFirebase[firebaseUserIndex] = { ...usersFromFirebase[firebaseUserIndex], ...userData };
                }
                
                // Â¶ÇÊûúÊõ¥Êñ∞ÁöÑÊòØÁï∂ÂâçÁôªÂÖ•Áî®Êà∂ÔºåÂêåÊ≠•Êõ¥Êñ∞ currentUserData
                if (editingUserId === currentUserData.id) {
                    currentUserData = { ...currentUserData, ...userData };
                    currentUser = users[userIndex].username;
                    
                    // Êõ¥Êñ∞È°ØÁ§∫ÁöÑÁî®Êà∂Ë≥áË®ä
                    document.getElementById('userRole').textContent = `Áï∂ÂâçÁî®Êà∂Ôºö${getUserDisplayName(currentUserData)}`;
                    document.getElementById('sidebarUserRole').textContent = `Áï∂ÂâçÁî®Êà∂Ôºö${getUserDisplayName(currentUserData)}`;
                }
                
                showToast('Áî®Êà∂Ë≥áÊñôÂ∑≤ÊàêÂäüÊõ¥Êñ∞ÔºÅ', 'success');
            } else {
                showToast('Êõ¥Êñ∞Áî®Êà∂Ë≥áÊñôÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
                return;
            }
        } else {
            // Êñ∞Â¢ûÁî®Êà∂
            const userData = {
                username: username,
                name: name,
                position: position,
                registrationNumber: position === 'ÈÜ´Â∏´' ? registrationNumber : null,
                email: email,
                phone: phone,
                uid: uid || '',
                active: active,
                lastLogin: null
            };

            const result = await window.firebaseDataManager.addUser(userData);
            
            if (result.success) {
                // Êõ¥Êñ∞Êú¨Âú∞Êï∏Êìö
                const newUser = {
                    id: result.id,
                    ...userData,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                users.push(newUser);
                usersFromFirebase.push(newUser);
                
                showToast('Áî®Êà∂Â∑≤ÊàêÂäüÊñ∞Â¢ûÔºÅ', 'success');
            } else {
                showToast('Êñ∞Â¢ûÁî®Êà∂Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
                return;
            }
        }
        
        // ‰øùÂ≠òÂà∞Êú¨Âú∞ÂÑ≤Â≠ò‰ΩúÁÇ∫ÂÇôÁî®
        localStorage.setItem('users', JSON.stringify(users));
        displayUsers();
        hideAddUserForm();

    } catch (error) {
        console.error('‰øùÂ≠òÁî®Êà∂Ë≥áÊñôÈåØË™§:', error);
        showToast('‰øùÂ≠òÊôÇÁôºÁîüÈåØË™§', 'error');
    } finally {
        // ÊÅ¢Âæ©ÊåâÈàïÁãÄÊÖã
        saveButton.textContent = originalText;
        saveButton.disabled = false;
    }
}

async function toggleUserStatus(id) {
    const currentUsers = usersFromFirebase.length > 0 ? usersFromFirebase : users;
    const user = currentUsers.find(u => u.id === id);
    if (!user) return;
    
    // Èò≤Ê≠¢ÂÅúÁî®Ëá™Â∑±ÁöÑÂ∏≥Ëôü
    if (user.id === currentUserData.id) {
        showToast('‰∏çËÉΩÂÅúÁî®Ëá™Â∑±ÁöÑÂ∏≥ËôüÔºÅ', 'error');
        return;
    }
    
    const action = user.active ? 'ÂÅúÁî®' : 'ÂïüÁî®';
    const confirmMessage = `Á¢∫ÂÆöË¶Å${action}Áî®Êà∂„Äå${user.name}„ÄçÂóéÔºü\n\n${user.active ? 'ÂÅúÁî®ÂæåË©≤Áî®Êà∂Â∞áÁÑ°Ê≥ïÁôªÂÖ•Á≥ªÁµ±„ÄÇ' : 'ÂïüÁî®ÂæåË©≤Áî®Êà∂ÂèØ‰ª•Ê≠£Â∏∏ÁôªÂÖ•Á≥ªÁµ±„ÄÇ'}`;
    
    if (confirm(confirmMessage)) {
        // È°ØÁ§∫ËôïÁêÜ‰∏≠ÁãÄÊÖã
        showToast('ËôïÁêÜ‰∏≠...', 'info');

        try {
            const userData = {
                active: !user.active
            };

            const result = await window.firebaseDataManager.updateUser(id, userData);
            
            if (result.success) {
                // Êõ¥Êñ∞Êú¨Âú∞Êï∏Êìö
                const userIndex = users.findIndex(u => u.id === id);
                if (userIndex !== -1) {
                    users[userIndex].active = !user.active;
                    users[userIndex].updatedAt = new Date().toISOString();
                }

                // Êõ¥Êñ∞ Firebase Êï∏Êìö
                const firebaseUserIndex = usersFromFirebase.findIndex(u => u.id === id);
                if (firebaseUserIndex !== -1) {
                    usersFromFirebase[firebaseUserIndex].active = !user.active;
                }
                
                localStorage.setItem('users', JSON.stringify(users));
                displayUsers();
                showToast(`Áî®Êà∂„Äå${user.name}„ÄçÂ∑≤${action}ÔºÅ`, 'success');
            } else {
                showToast(`${action}Áî®Êà∂Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶`, 'error');
            }
        } catch (error) {
            console.error('Êõ¥Êñ∞Áî®Êà∂ÁãÄÊÖãÈåØË™§:', error);
            showToast('Êõ¥Êñ∞Áî®Êà∂ÁãÄÊÖãÊôÇÁôºÁîüÈåØË™§', 'error');
        }
    }
}

async function deleteUser(id) {
    const currentUsers = usersFromFirebase.length > 0 ? usersFromFirebase : users;
    const user = currentUsers.find(u => u.id === id);
    if (!user) return;
    
    // Èò≤Ê≠¢Âà™Èô§Ëá™Â∑±ÁöÑÂ∏≥Ëôü
    if (user.id === currentUserData.id) {
        showToast('‰∏çËÉΩÂà™Èô§Ëá™Â∑±ÁöÑÂ∏≥ËôüÔºÅ', 'error');
        return;
    }
    
    // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÊúÄÂæå‰∏ÄÂÄãÁÆ°ÁêÜÂì°
    const adminUsers = currentUsers.filter(u => u.position === 'Ë®∫ÊâÄÁÆ°ÁêÜ' && u.active && u.id !== id);
    if (user.position === 'Ë®∫ÊâÄÁÆ°ÁêÜ' && adminUsers.length === 0) {
        showToast('‰∏çËÉΩÂà™Èô§ÊúÄÂæå‰∏ÄÂÄãË®∫ÊâÄÁÆ°ÁêÜÂ∏≥ËôüÔºÅ', 'error');
        return;
    }
    
    const confirmMessage = `Á¢∫ÂÆöË¶ÅÂà™Èô§Áî®Êà∂„Äå${user.name}„ÄçÂóéÔºü\n\n` +
                         `ËÅ∑‰ΩçÔºö${user.position}\n` +
                         `ÈõªÂ≠êÈÉµ‰ª∂Ôºö${user.email || 'Êú™Ë®≠ÂÆö'}\n\n` +
                         `Ê≥®ÊÑèÔºöÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ`;
    
    if (confirm(confirmMessage)) {
        // È°ØÁ§∫Âà™Èô§‰∏≠ÁãÄÊÖã
        showToast('Âà™Èô§‰∏≠...', 'info');

        try {
            const result = await window.firebaseDataManager.deleteUser(id);
            
            if (result.success) {
                // Êõ¥Êñ∞Êú¨Âú∞Êï∏Êìö
                users = users.filter(u => u.id !== id);
                usersFromFirebase = usersFromFirebase.filter(u => u.id !== id);
                
                localStorage.setItem('users', JSON.stringify(users));
                displayUsers();
                showToast(`Áî®Êà∂„Äå${user.name}„ÄçÂ∑≤Âà™Èô§ÔºÅ`, 'success');
            } else {
                showToast('Âà™Èô§Áî®Êà∂Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
            }
        } catch (error) {
            console.error('Âà™Èô§Áî®Êà∂ÈåØË™§:', error);
            showToast('Âà™Èô§Áî®Êà∂ÊôÇÁôºÁîüÈåØË™§', 'error');
        }
    }
}

// Ë≤°ÂãôÂ†±Ë°®ÂäüËÉΩ
        let currentFinancialTabType = 'summary';
        
        // ËºâÂÖ•Ë≤°ÂãôÂ†±Ë°®È†ÅÈù¢
        function loadFinancialReports() {
            // Ë®≠ÁΩÆÈ†êË®≠Êó•ÊúüÁØÑÂúçÔºàÊú¨ÊúàÔºâ
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            document.getElementById('startDate').value = formatFinancialDate(firstDayOfMonth);
            document.getElementById('endDate').value = formatFinancialDate(lastDayOfMonth);
            
            // ËºâÂÖ•ÈÜ´Â∏´ÈÅ∏È†Ö
            loadFinancialDoctorOptions();
            
            // ÁîüÊàêÂàùÂßãÂ†±Ë°®
            generateFinancialReport();
        }

        // Ê†ºÂºèÂåñÊó•ÊúüÁÇ∫ YYYY-MM-DD
        function formatFinancialDate(date) {
            return date.toISOString().split('T')[0];
        }

        // ËºâÂÖ•ÈÜ´Â∏´ÈÅ∏È†Ö
        function loadFinancialDoctorOptions() {
            const doctorSelect = document.getElementById('doctorFilter');
            const doctors = users.filter(user => 
                user.active && user.position === 'ÈÜ´Â∏´'
            );
            
            // Ê∏ÖÁ©∫ÁèæÊúâÈÅ∏È†ÖÔºà‰øùÁïô„ÄåÂÖ®ÈÉ®ÈÜ´Â∏´„ÄçÔºâ
            doctorSelect.innerHTML = '<option value="">ÂÖ®ÈÉ®ÈÜ´Â∏´</option>';
            
            // Ê∑ªÂä†ÈÜ´Â∏´ÈÅ∏È†Ö
            doctors.forEach(doctor => {
                const option = document.createElement('option');
                option.value = doctor.username;
                option.textContent = `${doctor.name}`;
                doctorSelect.appendChild(option);
            });
        }

        // Âø´ÈÄüÊó•ÊúüÈÅ∏Êìá
        function setQuickDate() {
            const quickDate = document.getElementById('quickDate').value;
            const today = new Date();
            let startDate, endDate;

            switch (quickDate) {
                case 'today':
                    startDate = endDate = today;
                    document.getElementById('reportType').value = 'daily';
                    break;
                case 'yesterday':
                    startDate = endDate = new Date(today.getTime() - 24 * 60 * 60 * 1000);
                    document.getElementById('reportType').value = 'daily';
                    break;
                case 'thisWeek':
                    const thisWeekStart = new Date(today);
                    thisWeekStart.setDate(today.getDate() - today.getDay());
                    startDate = thisWeekStart;
                    endDate = today;
                    document.getElementById('reportType').value = 'weekly';
                    break;
                case 'lastWeek':
                    const lastWeekStart = new Date(today);
                    lastWeekStart.setDate(today.getDate() - today.getDay() - 7);
                    const lastWeekEnd = new Date(lastWeekStart);
                    lastWeekEnd.setDate(lastWeekStart.getDate() + 6);
                    startDate = lastWeekStart;
                    endDate = lastWeekEnd;
                    document.getElementById('reportType').value = 'weekly';
                    break;
                case 'thisMonth':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    document.getElementById('reportType').value = 'monthly';
                    break;
                case 'lastMonth':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                    document.getElementById('reportType').value = 'monthly';
                    break;
                case 'thisYear':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = new Date(today.getFullYear(), 11, 31);
                    document.getElementById('reportType').value = 'yearly';
                    break;
                case 'lastYear':
                    startDate = new Date(today.getFullYear() - 1, 0, 1);
                    endDate = new Date(today.getFullYear() - 1, 11, 31);
                    document.getElementById('reportType').value = 'yearly';
                    break;
                default:
                    return;
            }

            if (startDate && endDate) {
                document.getElementById('startDate').value = formatFinancialDate(startDate);
                document.getElementById('endDate').value = formatFinancialDate(endDate);
                generateFinancialReport();
            }
        }

        // Ëß£ÊûêÊî∂Ë≤ªÈ†ÖÁõÆÊñáÊú¨
        function parseFinancialBillingItems(billingText) {
            const items = [];
            const lines = billingText.split('\n');
            let totalAmount = 0;

            lines.forEach(line => {
                line = line.trim();
                if (!line || line.includes('Â∞èË®à') || line.includes('Á∏ΩË≤ªÁî®')) {
                    // ÊèêÂèñÁ∏ΩË≤ªÁî®
                    if (line.includes('Á∏ΩË≤ªÁî®')) {
                        const match = line.match(/\$(\d+)/);
                        if (match) {
                            totalAmount = parseInt(match[1]);
                        }
                    }
                    return;
                }

                // Ëß£ÊûêÊî∂Ë≤ªÈ†ÖÁõÆÊ†ºÂºèÔºöÈ†ÖÁõÆÂêç xÊï∏Èáè = $ÈáëÈ°ç Êàñ È†ÖÁõÆÂêç xÊï∏Èáè = -$ÈáëÈ°ç
                const itemMatch = line.match(/^(.+?)\s+x(\d+)\s+=\s+([\-\$]?\d+)$/);
                if (itemMatch) {
                    const itemName = itemMatch[1].trim();
                    const quantity = parseInt(itemMatch[2]);
                    const amount = parseInt(itemMatch[3].replace(/[\-\$]/g, ''));
                    const isDiscount = itemMatch[3].includes('-');

                    items.push({
                        name: itemName,
                        quantity: quantity,
                        unitPrice: Math.abs(amount / quantity),
                        totalAmount: isDiscount ? -amount : amount,
                        category: getFinancialCategoryFromItemName(itemName)
                    });
                }
            });

            return { items, totalAmount };
        }

        // Ê†πÊìöÈ†ÖÁõÆÂêçÁ®±Êé®Êñ∑È°ûÂà•
        function getFinancialCategoryFromItemName(itemName) {
            if (itemName.includes('Ë®∫Èáë') || itemName.includes('Ë®∫ÁôÇ') || itemName.includes('Ë§áË®∫')) {
                return 'consultation';
            } else if (itemName.includes('Ëó•') || itemName.includes('‰∏≠Ëó•') || itemName.includes('Ë™øÂäë')) {
                return 'medicine';
            } else if (itemName.includes('ÈáùÁÅ∏') || itemName.includes('Êé®Êãø') || itemName.includes('ÊãîÁΩê') || itemName.includes('ÂàÆÁóß') || itemName.includes('ËâæÁÅ∏')) {
                return 'treatment';
            } else if (itemName.includes('ÊäòÊâ£') || itemName.includes('ÂÑ™ÊÉ†')) {
                return 'discount';
            } else if (itemName.includes('Â•óÁ•®') || itemName.includes('Â•óÈ§ê') || itemName.includes('ÁôÇÁ®ã') || itemName.includes('ÊñπÊ°à')) {
                return 'package';
            } else {
                return 'other';
            }
        }

        // ÁîüÊàêË≤°ÂãôÂ†±Ë°®
        function generateFinancialReport() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const doctorFilter = document.getElementById('doctorFilter').value;
            const reportType = document.getElementById('reportType').value;

            if (!startDate || !endDate) {
                showToast('Ë´ãÈÅ∏ÊìáÊó•ÊúüÁØÑÂúçÔºÅ', 'error');
                return;
            }

            // ÈÅéÊøæË®∫ÁóáË≥áÊñô
            const filteredConsultations = filterFinancialConsultations(startDate, endDate, doctorFilter);
            
            // Ë®àÁÆóÁµ±Ë®àË≥áÊñô
            const stats = calculateFinancialStatistics(filteredConsultations);
            
            // Êõ¥Êñ∞ÈóúÈçµÊåáÊ®ô
            updateFinancialKeyMetrics(stats);
            
            // Êõ¥Êñ∞Ë°®Ê†º
            updateFinancialTables(filteredConsultations, stats);
            
            // Êõ¥Êñ∞ÊôÇÈñì
            document.getElementById('lastUpdateTime').textContent = new Date().toLocaleString('zh-TW');
            
            showToast('Ë≤°ÂãôÂ†±Ë°®Â∑≤Êõ¥Êñ∞ÔºÅ', 'success');
        }

        // ÈÅéÊøæË®∫ÁóáË≥áÊñô
        function filterFinancialConsultations(startDate, endDate, doctorFilter) {
            const start = new Date(startDate);
            const end = new Date(endDate + 'T23:59:59.999Z');

            return consultations.filter(consultation => {
                const consultationDate = new Date(consultation.date);
                const dateInRange = consultationDate >= start && consultationDate <= end;
                const doctorMatch = !doctorFilter || consultation.doctor === doctorFilter;
                const isCompleted = consultation.status === 'completed';

                return dateInRange && doctorMatch && isCompleted;
            });
        }

        // Ë®àÁÆóË≤°ÂãôÁµ±Ë®àË≥áÊñô
        function calculateFinancialStatistics(consultations) {
            let totalRevenue = 0;
            let totalConsultations = consultations.length;
            const doctorStats = {};
            const serviceStats = {};
            const dailyStats = {};

            consultations.forEach(consultation => {
                const parsed = parseFinancialBillingItems(consultation.billingItems || '');
                const consultationRevenue = parsed.totalAmount;
                totalRevenue += consultationRevenue;

                // ÈÜ´Â∏´Áµ±Ë®à
                if (!doctorStats[consultation.doctor]) {
                    doctorStats[consultation.doctor] = {
                        count: 0,
                        revenue: 0
                    };
                }
                doctorStats[consultation.doctor].count += 1;
                doctorStats[consultation.doctor].revenue += consultationRevenue;

                // ÊúçÂãôÁµ±Ë®à
                parsed.items.forEach(item => {
                    if (!serviceStats[item.category]) {
                        serviceStats[item.category] = {
                            name: getFinancialCategoryDisplayName(item.category),
                            count: 0,
                            revenue: 0,
                            items: []
                        };
                    }
                    serviceStats[item.category].count += item.quantity;
                    serviceStats[item.category].revenue += item.totalAmount;
                    serviceStats[item.category].items.push(item);
                });

                // ÊØèÊó•Áµ±Ë®à
                const dateKey = consultation.date.split('T')[0];
                if (!dailyStats[dateKey]) {
                    dailyStats[dateKey] = {
                        count: 0,
                        revenue: 0,
                        services: {}
                    };
                }
                dailyStats[dateKey].count += 1;
                dailyStats[dateKey].revenue += consultationRevenue;
            });

            const averageRevenue = totalConsultations > 0 ? totalRevenue / totalConsultations : 0;
            const activeDoctors = Object.keys(doctorStats).length;

            return {
                totalRevenue,
                totalConsultations,
                averageRevenue,
                activeDoctors,
                doctorStats,
                serviceStats,
                dailyStats
            };
        }

        // Áç≤ÂèñÈ°ûÂà•È°ØÁ§∫ÂêçÁ®±
        function getFinancialCategoryDisplayName(category) {
            const names = {
                consultation: 'Ë®∫ÁôÇË≤ª',
                medicine: 'Ëó•Ë≤ª',
                treatment: 'Ê≤ªÁôÇË≤ª',
                other: 'ÂÖ∂‰ªñË≤ªÁî®',
                discount: 'ÊäòÊâ£',
                package: 'Â•óÁ•®È†ÖÁõÆ'
            };
            return names[category] || category;
        }

        // Êõ¥Êñ∞ÈóúÈçµÊåáÊ®ô
        function updateFinancialKeyMetrics(stats) {
            document.getElementById('totalRevenue').textContent = `$${stats.totalRevenue.toLocaleString()}`;
            document.getElementById('totalConsultations').textContent = stats.totalConsultations.toLocaleString();
            document.getElementById('averageRevenue').textContent = `$${Math.round(stats.averageRevenue).toLocaleString()}`;
            document.getElementById('activeDoctors').textContent = stats.activeDoctors;
        }

        // Êõ¥Êñ∞Ë≤°ÂãôË°®Ê†º
        function updateFinancialTables(consultations, stats) {
            updateFinancialSummaryTable(stats);
            updateFinancialDailyTable(stats.dailyStats);
            updateFinancialDoctorTable(stats.doctorStats);
            updateFinancialServiceTable(stats.serviceStats);
        }

        // Êõ¥Êñ∞Êî∂ÂÖ•ÊëòË¶ÅË°®Ê†º
        function updateFinancialSummaryTable(stats) {
            const tbody = document.getElementById('financialSummaryTableBody');
            const summaryData = [
                { item: 'Ë®∫ÁôÇË≤ªÊî∂ÂÖ•', amount: 0, category: 'consultation' },
                { item: 'Ëó•Ë≤ªÊî∂ÂÖ•', amount: 0, category: 'medicine' },
                { item: 'Ê≤ªÁôÇË≤ªÊî∂ÂÖ•', amount: 0, category: 'treatment' },
                { item: 'ÂÖ∂‰ªñÊî∂ÂÖ•', amount: 0, category: 'other' },
                { item: 'Â•óÁ•®Êî∂ÂÖ•', amount: 0, category: 'package' }
            ];

            // Ë®àÁÆóÂêÑÈ°ûÂà•Êî∂ÂÖ•
            Object.keys(stats.serviceStats).forEach(category => {
                const stat = stats.serviceStats[category];
                const summaryItem = summaryData.find(item => item.category === category);
                if (summaryItem) {
                    summaryItem.amount = stat.revenue;
                }
            });

            const totalRevenue = stats.totalRevenue;

            tbody.innerHTML = summaryData.map(item => {
                const percentage = totalRevenue > 0 ? ((item.amount / totalRevenue) * 100).toFixed(1) : '0';
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm text-gray-900">${item.item}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-right font-medium">$${item.amount.toLocaleString()}</td>
                        <td class="px-4 py-3 text-sm text-gray-600 text-right">${percentage}%</td>
                        <td class="px-4 py-3 text-sm text-gray-500 text-right">Áµ±Ë®àÊúüÈñì</td>
                    </tr>
                `;
            }).join('');
        }

        // Êõ¥Êñ∞ÊØèÊó•ÊòéÁ¥∞Ë°®Ê†º
        function updateFinancialDailyTable(dailyStats) {
            const tbody = document.getElementById('financialDailyTableBody');
            const sortedDates = Object.keys(dailyStats).sort().reverse();

            if (sortedDates.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                            ÈÅ∏ÂÆöÊúüÈñìÂÖßÊ≤íÊúâË®∫ÁóáË®òÈåÑ
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = sortedDates.map(date => {
                const stat = dailyStats[date];
                const averageDaily = stat.count > 0 ? Math.round(stat.revenue / stat.count) : 0;
                const formattedDate = new Date(date + 'T00:00:00').toLocaleDateString('zh-TW');

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm text-gray-900">${formattedDate}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-right">${stat.count}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-right font-medium">$${stat.revenue.toLocaleString()}</td>
                        <td class="px-4 py-3 text-sm text-gray-600 text-right">$${averageDaily.toLocaleString()}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">Ë®∫ÁôÇ„ÄÅËó•Ë≤ª</td>
                    </tr>
                `;
            }).join('');
        }

        // Êõ¥Êñ∞ÈÜ´Â∏´Ê•≠Á∏æË°®Ê†º
        function updateFinancialDoctorTable(doctorStats) {
            const tbody = document.getElementById('financialDoctorTableBody');
            const totalRevenue = Object.values(doctorStats).reduce((sum, stat) => sum + stat.revenue, 0);

            if (Object.keys(doctorStats).length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                            ÈÅ∏ÂÆöÊúüÈñìÂÖßÊ≤íÊúâÈÜ´Â∏´Ë®∫ÁóáË®òÈåÑ
                        </td>
                    </tr>
                `;
                return;
            }

            const sortedDoctors = Object.entries(doctorStats).sort(([,a], [,b]) => b.revenue - a.revenue);

            tbody.innerHTML = sortedDoctors.map(([doctorUsername, stat]) => {
                const percentage = totalRevenue > 0 ? ((stat.revenue / totalRevenue) * 100).toFixed(1) : '0';
                const average = stat.count > 0 ? Math.round(stat.revenue / stat.count) : 0;
                const doctorName = getDoctorDisplayName(doctorUsername);

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm text-gray-900">${doctorName}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-right">${stat.count}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-right font-medium">$${stat.revenue.toLocaleString()}</td>
                        <td class="px-4 py-3 text-sm text-gray-600 text-right">$${average.toLocaleString()}</td>
                        <td class="px-4 py-3 text-sm text-gray-600 text-right">${percentage}%</td>
                    </tr>
                `;
            }).join('');
        }

        // Êõ¥Êñ∞ÊúçÂãôÂàÜÊûêË°®Ê†º
        function updateFinancialServiceTable(serviceStats) {
            const tbody = document.getElementById('financialServiceTableBody');
            const totalRevenue = Object.values(serviceStats).reduce((sum, stat) => sum + stat.revenue, 0);

            if (Object.keys(serviceStats).length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                            ÈÅ∏ÂÆöÊúüÈñìÂÖßÊ≤íÊúâÊúçÂãôË®òÈåÑ
                        </td>
                    </tr>
                `;
                return;
            }

            const sortedServices = Object.entries(serviceStats).sort(([,a], [,b]) => b.revenue - a.revenue);

            tbody.innerHTML = sortedServices.map(([category, stat]) => {
                const percentage = totalRevenue > 0 ? ((stat.revenue / totalRevenue) * 100).toFixed(1) : '0';
                const average = stat.count > 0 ? Math.round(stat.revenue / stat.count) : 0;

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm text-gray-900">${stat.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-right">${stat.count}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-right font-medium">$${stat.revenue.toLocaleString()}</td>
                        <td class="px-4 py-3 text-sm text-gray-600 text-right">$${average.toLocaleString()}</td>
                        <td class="px-4 py-3 text-sm text-gray-600 text-right">${percentage}%</td>
                    </tr>
                `;
            }).join('');
        }

        // ÂàáÊèõË≤°ÂãôÊ®ôÁ±§
        function switchFinancialTab(tabType) {
            // Êõ¥Êñ∞Ê®ôÁ±§ÊåâÈàïÊ®£Âºè
            document.querySelectorAll('[role="tablist"] button').forEach(btn => {
                if (btn.id && btn.id.startsWith('financial')) {
                    btn.className = 'py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm transition duration-200';
                }
            });
            
            document.getElementById(`financial${tabType.charAt(0).toUpperCase() + tabType.slice(1)}Tab`).className = 'py-4 px-1 border-b-2 border-green-500 text-green-600 font-medium text-sm transition duration-200';

            // Èö±ËóèÊâÄÊúâÊ®ôÁ±§ÂÖßÂÆπ
            document.querySelectorAll('.financial-tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // È°ØÁ§∫ÈÅ∏‰∏≠ÁöÑÊ®ôÁ±§ÂÖßÂÆπ
            document.getElementById(`financial${tabType.charAt(0).toUpperCase() + tabType.slice(1)}Content`).classList.remove('hidden');
            
            currentFinancialTabType = tabType;
        }

        // ÂåØÂá∫Ë≤°ÂãôÂ†±Ë°®
        function exportFinancialReport() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const reportType = document.getElementById('reportType').value;
            
            // Ê∫ñÂÇôÂåØÂá∫Ë≥áÊñô
            const reportData = {
                reportInfo: {
                    title: `Ë≤°ÂãôÂ†±Ë°® - ${reportType}`,
                    period: `${startDate} Ëá≥ ${endDate}`,
                    generatedAt: new Date().toLocaleString('zh-TW')
                },
                summary: {
                    totalRevenue: document.getElementById('totalRevenue').textContent,
                    totalConsultations: document.getElementById('totalConsultations').textContent,
                    averageRevenue: document.getElementById('averageRevenue').textContent,
                    activeDoctors: document.getElementById('activeDoctors').textContent
                }
            };

            // ËΩâÊèõÁÇ∫ JSON Â≠óÁ¨¶‰∏≤
            const jsonString = JSON.stringify(reportData, null, 2);
            
            // ÂâµÂª∫‰∏ãËºâ
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Ë≤°ÂãôÂ†±Ë°®_${startDate}_${endDate}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast('Ë≤°ÂãôÂ†±Ë°®Â∑≤ÂåØÂá∫ÔºÅ', 'success');
        }

        
        // Â•óÁ•®ÁÆ°ÁêÜÂáΩÂºè
        function getPatientPackagesStore() {
            return JSON.parse(localStorage.getItem('patientPackages') || '[]');
        }
        function setPatientPackagesStore(list) {
            localStorage.setItem('patientPackages', JSON.stringify(list));
        }
        function getPatientPackages(patientId) {
            const all = getPatientPackagesStore();
            return all.filter(p => p.patientId === patientId);
        }
        function purchasePackage(patientId, item) {
            const totalUses = Number(item.packageUses || item.totalUses || 0);
            const validityDays = Number(item.validityDays || 0);
            const purchasedAt = new Date();
            const expiresAt = new Date(purchasedAt);
            expiresAt.setDate(expiresAt.getDate() + validityDays);
            const record = {
                id: Date.now(),
                patientId: patientId,
                packageItemId: item.id,
                name: item.name,
                totalUses: totalUses,
                remainingUses: totalUses,
                purchasedAt: purchasedAt.toISOString(),
                expiresAt: expiresAt.toISOString()
            };
            const all = getPatientPackagesStore();
            all.push(record);
            setPatientPackagesStore(all);
            return record;
        }
        function consumePackage(patientId, packageRecordId) {
            const all = getPatientPackagesStore();
            const idx = all.findIndex(p => p.id === packageRecordId && p.patientId === patientId);
            if (idx === -1) return { ok: false, msg: 'Êâæ‰∏çÂà∞Â•óÁ•®' };
            const now = new Date();
            const exp = new Date(all[idx].expiresAt);
            if (now > exp) return { ok: false, msg: 'Â•óÁ•®Â∑≤ÈÅéÊúü' };
            if (all[idx].remainingUses <= 0) return { ok: false, msg: 'Â•óÁ•®Â∑≤Áî®ÂÆå' };
            all[idx].remainingUses -= 1;
            setPatientPackagesStore(all);
            return { ok: true, record: all[idx] };
        }
        function formatPackageStatus(pkg) {
            const exp = new Date(pkg.expiresAt);
            const now = new Date();
            const daysLeft = Math.ceil((exp - now) / (1000*60*60*24));
            const expired = daysLeft < 0;
            return expired
              ? `Â∑≤Âà∞ÊúüÔºà${exp.toLocaleDateString('zh-TW')}Ôºâ`
              : `Ââ©È§ò ${pkg.remainingUses}/${pkg.totalUses} Ê¨° ¬∑ ${exp.toLocaleDateString('zh-TW')} Âà∞ÊúüÔºàÁ¥Ñ ${daysLeft} Â§©Ôºâ`;
        }
        function renderPatientPackages(patientId) {
            const container = document.getElementById('patientPackagesList');
            if (!container) return;
            // ÂÉÖÈ°ØÁ§∫Ââ©È§òÊ¨°Êï∏Â§ßÊñº 0 ÁöÑÂ•óÁ•®ÔºàÂ∑≤Áî®ÂÆåÁöÑÂ•óÁ•®‰∏çÂú®Ë®∫ÁóáË®òÈåÑÈ°ØÁ§∫Ôºâ
            const pkgs = getPatientPackages(patientId).filter(p => p.remainingUses > 0).sort((a,b)=> new Date(a.expiresAt)-new Date(b.expiresAt));
            if (pkgs.length === 0) {
                container.innerHTML = '<div class="text-gray-500">ÁÑ°Â∑≤Ë≥ºË≤∑ÁöÑÂ•óÁ•®</div>';
                return;
            }
            container.innerHTML = pkgs.map(pkg => {
                const exp = new Date(pkg.expiresAt);
                const now = new Date();
                const expired = now > exp;
                const disabled = expired || pkg.remainingUses <= 0;
                const badge =
                  expired ? '<span class="ml-2 text-xs text-white px-2 py-0.5 rounded bg-red-500">Â∑≤Âà∞Êúü</span>' :
                  (pkg.remainingUses <= 0 ? '<span class="ml-2 text-xs text-white px-2 py-0.5 rounded bg-gray-500">Â∑≤Áî®ÂÆå</span>' : '');
                return `
      <div class="flex items-center justify-between bg-white border border-purple-200 rounded p-2">
        <div>
          <div class="font-medium text-purple-900">${pkg.name}${badge}</div>
          <div class="text-xs text-gray-600">${formatPackageStatus(pkg)}</div>
        </div>
        <button type="button" ${disabled ? 'disabled' : ''} 
          onclick="useOnePackage(${pkg.patientId}, ${pkg.id})"
          class="px-3 py-1 rounded ${disabled ? 'bg-gray-300 text-gray-600' : 'bg-purple-600 text-white hover:bg-purple-700'}">
          ‰ΩøÁî®‰∏ÄÊ¨°
        </button>
      </div>
    `;
            }).join('');
        }
        function refreshPatientPackagesUI() {
            const appointment = appointments.find(apt => apt.id === currentConsultingAppointmentId);
            if (!appointment) return;
            renderPatientPackages(appointment.patientId);
        }
        function useOnePackage(patientId, packageRecordId) {
            const res = consumePackage(patientId, packageRecordId);
            if (!res.ok) {
                showToast(res.msg || 'Â•óÁ•®‰∏çÂèØÁî®', 'warning');
                return;
            }
            const usedName = `${res.record.name}Ôºà‰ΩøÁî®Â•óÁ•®Ôºâ`;
            // Âú®Êé®ÂÖ•Â•óÁ•®‰ΩøÁî®Á¥ÄÈåÑÊôÇÔºåÈ°çÂ§ñÂ≠òÂÖ• patientId Ëàá packageRecordIdÔºåÊñπ‰æøÂæåÁ∫åÂèñÊ∂à
            selectedBillingItems.push({
                id: `use-${res.record.id}-${Date.now()}`,
                name: usedName,
                category: 'packageUse',
                price: 0,
                unit: 'Ê¨°',
                description: 'Â•óÁ•®ÊäµÊâ£‰∏ÄÊ¨°',
                quantity: 1,
                patientId: patientId,
                packageRecordId: res.record.id
            });
            updateBillingDisplay();
            refreshPatientPackagesUI();
            showToast(`Â∑≤‰ΩøÁî®Â•óÁ•®Ôºö${res.record.name}ÔºåÂâ©È§ò ${res.record.remainingUses} Ê¨°`, 'success');
        }

        // ÂèñÊ∂à‰∏ÄÊ¨°Â•óÁ•®‰ΩøÁî®ÔºöÈÄÄÂõûÂâ©È§òÊ¨°Êï∏‰∏¶ÁßªÈô§Ë©≤Á≠Ü‰ΩøÁî®Á¥ÄÈåÑ
        function undoPackageUse(patientId, packageRecordId, usageItemId) {
            // ËÆÄÂèñÊâÄÊúâÁóÖ‰∫∫Â•óÁ•®Á¥ÄÈåÑ
            const all = getPatientPackagesStore();
            // ÊâæÂà∞Â∞çÊáâÂ•óÁ•®Á¥¢Âºï
            const idx = all.findIndex(p => p.id === packageRecordId && p.patientId === patientId);
            if (idx === -1) {
                showToast('Êâæ‰∏çÂà∞Â∞çÊáâÁöÑÂ•óÁ•®ÔºåÁÑ°Ê≥ïÂèñÊ∂à', 'warning');
                return;
            }
            // Â¢ûÂä†Ââ©È§òÊ¨°Êï∏
            all[idx].remainingUses += 1;
            setPatientPackagesStore(all);
            // ÁßªÈô§Ë©≤Á≠Ü $0 ‰ΩøÁî®Á¥ÄÈåÑ
            selectedBillingItems = selectedBillingItems.filter(it => it.id !== usageItemId);
            // Êõ¥Êñ∞È°ØÁ§∫
            updateBillingDisplay();
            if (typeof refreshPatientPackagesUI === 'function') {
                refreshPatientPackagesUI();
            }
            showToast('Â∑≤ÂèñÊ∂àÊú¨Ê¨°Â•óÁ•®‰ΩøÁî®ÔºåÊ¨°Êï∏Â∑≤ÈÄÄÂõû', 'success');
        }

        // ÁóÖ‰∫∫Ë©≥Á¥∞Ë≥áÊñôÂ•óÁ•®ÂàÜÈ†ÅÈ°ØÁ§∫ÁöÑËÆäÊï∏ËàáÂáΩÂºè
        let currentPatientPackages = [];
        let currentPatientPackagePage = 0;
        const PACKAGES_PER_PAGE = 5;
        function renderPatientPackagesDetailPage() {
            const start = currentPatientPackagePage * PACKAGES_PER_PAGE;
            const end = start + PACKAGES_PER_PAGE;
            const pkgs = currentPatientPackages.slice(start, end);
            let html = '';
            pkgs.forEach(function(pkg) {
                const purchased = new Date(pkg.purchasedAt);
                const exp = new Date(pkg.expiresAt);
                const now = new Date();
                const expired = now > exp;
                const status = expired ? '<span class="text-red-600">Â∑≤Âà∞Êúü</span>' :
                    (pkg.remainingUses <= 0 ? '<span class="text-gray-600">Â∑≤Áî®ÂÆå</span>' :
                        '<span class="text-green-600">Ââ©È§ò ' + pkg.remainingUses + '/' + pkg.totalUses + '</span>');
                html += '<div class="flex justify-between items-start bg-purple-50 border border-purple-200 rounded p-2">';
                html += '<div>';
                html += '<div class="font-medium text-purple-900">' + pkg.name + '</div>';
                html += '<div class="text-xs text-gray-600">Ë≥ºË≤∑Êó•Ôºö' + purchased.toLocaleDateString("zh-TW") + ' ¬∑ Âà∞ÊúüÊó•Ôºö' + exp.toLocaleDateString("zh-TW") + '</div>';
                html += '<div class="text-xs text-gray-600">Ââ©È§òÊ¨°Êï∏Ôºö' + pkg.remainingUses + '/' + pkg.totalUses + '</div>';
                html += '</div>';
                html += '<div class="mt-1">' + status + '</div>';
                html += '</div>';
            });
            const totalPages = Math.ceil(currentPatientPackages.length / PACKAGES_PER_PAGE);
            if (totalPages > 1) {
                html += '<div class="flex justify-end space-x-2 mt-2">';
                const prevDisabled = currentPatientPackagePage <= 0;
                const nextDisabled = currentPatientPackagePage >= totalPages - 1;
                html += '<button type="button" ' + (prevDisabled ? 'disabled' : '') + ' onclick="changePatientPackagePage(-1)" class="px-2 py-1 bg-gray-200 text-gray-700 rounded ' + (prevDisabled ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-300') + '">‰∏ä‰∏ÄÈ†Å</button>';
                html += '<button type="button" ' + (nextDisabled ? 'disabled' : '') + ' onclick="changePatientPackagePage(1)" class="px-2 py-1 bg-gray-200 text-gray-700 rounded ' + (nextDisabled ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-300') + '">‰∏ã‰∏ÄÈ†Å</button>';
                html += '</div>';
            }
            return html;
        }
        function changePatientPackagePage(delta) {
            const totalPages = Math.ceil(currentPatientPackages.length / PACKAGES_PER_PAGE);
            currentPatientPackagePage = Math.min(Math.max(currentPatientPackagePage + delta, 0), totalPages - 1);
            const container = document.getElementById('patientPackagesDetailList');
            if (container) {
                container.innerHTML = renderPatientPackagesDetailPage();
            }
        }

// Firebase Êï∏ÊìöÁÆ°ÁêÜÁ≥ªÁµ±
class FirebaseDataManager {
    constructor() {
        this.isReady = false;
        this.initializeWhenReady();
    }

    async initializeWhenReady() {
        // Á≠âÂæÖ Firebase ÂàùÂßãÂåñ
        while (!window.firebase) {
            await new Promise(resolve => setTimeout(resolve, 100));
        }
        this.isReady = true;
        console.log('Firebase Êï∏ÊìöÁÆ°ÁêÜÂô®Â∑≤Ê∫ñÂÇôÂ∞±Á∑í');
    }

    // ÁóÖ‰∫∫Êï∏ÊìöÁÆ°ÁêÜ
    async addPatient(patientData) {
        if (!this.isReady) {
            showToast('Êï∏ÊìöÁÆ°ÁêÜÂô®Â∞öÊú™Ê∫ñÂÇôÂ∞±Á∑í', 'error');
            return { success: false };
        }

        try {
            const docRef = await window.firebase.addDoc(
                window.firebase.collection(window.firebase.db, 'patients'),
                {
                    ...patientData,
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    createdBy: currentUser || 'system'
                }
            );
            
            console.log('ÁóÖ‰∫∫Êï∏ÊìöÂ∑≤Ê∑ªÂä†Âà∞ Firebase:', docRef.id);
            return { success: true, id: docRef.id };
        } catch (error) {
            console.error('Ê∑ªÂä†ÁóÖ‰∫∫Êï∏ÊìöÂ§±Êïó:', error);
            showToast('‰øùÂ≠òÁóÖ‰∫∫Êï∏ÊìöÂ§±Êïó', 'error');
            return { success: false, error: error.message };
        }
    }

    async getPatients() {
        if (!this.isReady) return { success: false, data: [] };

        try {
            const querySnapshot = await window.firebase.getDocs(
                window.firebase.collection(window.firebase.db, 'patients')
            );
            
            const patients = [];
            querySnapshot.forEach((doc) => {
                patients.push({ id: doc.id, ...doc.data() });
            });
            
            console.log('Â∑≤Âæû Firebase ËÆÄÂèñÁóÖ‰∫∫Êï∏Êìö:', patients.length, 'Á≠Ü');
            return { success: true, data: patients };
        } catch (error) {
            console.error('ËÆÄÂèñÁóÖ‰∫∫Êï∏ÊìöÂ§±Êïó:', error);
            return { success: false, data: [] };
        }
    }

    async updatePatient(patientId, patientData) {
        try {
            await window.firebase.updateDoc(
                window.firebase.doc(window.firebase.db, 'patients', patientId),
                {
                    ...patientData,
                    updatedAt: new Date(),
                    updatedBy: currentUser || 'system'
                }
            );
            return { success: true };
        } catch (error) {
            console.error('Êõ¥Êñ∞ÁóÖ‰∫∫Êï∏ÊìöÂ§±Êïó:', error);
            return { success: false, error: error.message };
        }
    }

    async deletePatient(patientId) {
        try {
            await window.firebase.deleteDoc(
                window.firebase.doc(window.firebase.db, 'patients', patientId)
            );
            return { success: true };
        } catch (error) {
            console.error('Âà™Èô§ÁóÖ‰∫∫Êï∏ÊìöÂ§±Êïó:', error);
            return { success: false, error: error.message };
        }
    }
// Ë®∫ÁóáË®òÈåÑÁÆ°ÁêÜ
    async addConsultation(consultationData) {
        if (!this.isReady) {
            showToast('Êï∏ÊìöÁÆ°ÁêÜÂô®Â∞öÊú™Ê∫ñÂÇôÂ∞±Á∑í', 'error');
            return { success: false };
        }

        try {
            const docRef = await window.firebase.addDoc(
                window.firebase.collection(window.firebase.db, 'consultations'),
                {
                    ...consultationData,
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    createdBy: currentUser
                }
            );
            
            console.log('Ë®∫ÁóáË®òÈåÑÂ∑≤Ê∑ªÂä†Âà∞ Firebase:', docRef.id);
            return { success: true, id: docRef.id };
        } catch (error) {
            console.error('Ê∑ªÂä†Ë®∫ÁóáË®òÈåÑÂ§±Êïó:', error);
            showToast('‰øùÂ≠òË®∫ÁóáË®òÈåÑÂ§±Êïó', 'error');
            return { success: false, error: error.message };
        }
    }

    async getConsultations() {
        if (!this.isReady) return { success: false, data: [] };

        try {
            const querySnapshot = await window.firebase.getDocs(
                window.firebase.collection(window.firebase.db, 'consultations')
            );
            
            const consultations = [];
            querySnapshot.forEach((doc) => {
                consultations.push({ id: doc.id, ...doc.data() });
            });
            
            console.log('Â∑≤Âæû Firebase ËÆÄÂèñË®∫ÁóáË®òÈåÑ:', consultations.length, 'Á≠Ü');
            return { success: true, data: consultations };
        } catch (error) {
            console.error('ËÆÄÂèñË®∫ÁóáË®òÈåÑÂ§±Êïó:', error);
            return { success: false, data: [] };
        }
    }

    async updateConsultation(consultationId, consultationData) {
        try {
            await window.firebase.updateDoc(
                window.firebase.doc(window.firebase.db, 'consultations', consultationId),
                {
                    ...consultationData,
                    updatedAt: new Date(),
                    updatedBy: currentUser
                }
            );
            return { success: true };
        } catch (error) {
            console.error('Êõ¥Êñ∞Ë®∫ÁóáË®òÈåÑÂ§±Êïó:', error);
            return { success: false, error: error.message };
        }
    }

    async getPatientConsultations(patientId) {
        if (!this.isReady) return { success: false, data: [] };

        try {
            const allConsultations = await this.getConsultations();
            if (!allConsultations.success) {
                return { success: false, data: [] };
            }

            const patientConsultations = allConsultations.data
                .filter(consultation => consultation.patientId === patientId)
                .sort((a, b) => {
                    const dateA = a.date ? new Date(a.date.seconds * 1000) : new Date(a.createdAt.seconds * 1000);
                    const dateB = b.date ? new Date(b.date.seconds * 1000) : new Date(b.createdAt.seconds * 1000);
                    return dateB - dateA; // ÊúÄÊñ∞ÁöÑÂú®ÂâçÈù¢
                });

            return { success: true, data: patientConsultations };
        } catch (error) {
            console.error('ËÆÄÂèñÁóÖ‰∫∫Ë®∫ÁóáË®òÈåÑÂ§±Êïó:', error);
            return { success: false, data: [] };
        }
    }
    // Áî®Êà∂Êï∏ÊìöÁÆ°ÁêÜ
    async addUser(userData) {
        if (!this.isReady) {
            showToast('Êï∏ÊìöÁÆ°ÁêÜÂô®Â∞öÊú™Ê∫ñÂÇôÂ∞±Á∑í', 'error');
            return { success: false };
        }

        try {
            const docRef = await window.firebase.addDoc(
                window.firebase.collection(window.firebase.db, 'users'),
                {
                    ...userData,
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    createdBy: currentUser || 'system'
                }
            );
            
            console.log('Áî®Êà∂Êï∏ÊìöÂ∑≤Ê∑ªÂä†Âà∞ Firebase:', docRef.id);
            return { success: true, id: docRef.id };
        } catch (error) {
            console.error('Ê∑ªÂä†Áî®Êà∂Êï∏ÊìöÂ§±Êïó:', error);
            showToast('‰øùÂ≠òÁî®Êà∂Êï∏ÊìöÂ§±Êïó', 'error');
            return { success: false, error: error.message };
        }
    }

    async getUsers() {
        if (!this.isReady) return { success: false, data: [] };

        try {
            const querySnapshot = await window.firebase.getDocs(
                window.firebase.collection(window.firebase.db, 'users')
            );
            
            const users = [];
            querySnapshot.forEach((doc) => {
                users.push({ id: doc.id, ...doc.data() });
            });
            
            console.log('Â∑≤Âæû Firebase ËÆÄÂèñÁî®Êà∂Êï∏Êìö:', users.length, 'Á≠Ü');
            return { success: true, data: users };
        } catch (error) {
            console.error('ËÆÄÂèñÁî®Êà∂Êï∏ÊìöÂ§±Êïó:', error);
            return { success: false, data: [] };
        }
    }

    async updateUser(userId, userData) {
        try {
            await window.firebase.updateDoc(
                window.firebase.doc(window.firebase.db, 'users', userId),
                {
                    ...userData,
                    updatedAt: new Date(),
                    updatedBy: currentUser || 'system'
                }
            );
            return { success: true };
        } catch (error) {
            console.error('Êõ¥Êñ∞Áî®Êà∂Êï∏ÊìöÂ§±Êïó:', error);
            return { success: false, error: error.message };
        }
    }

    async deleteUser(userId) {
        try {
            await window.firebase.deleteDoc(
                window.firebase.doc(window.firebase.db, 'users', userId)
            );
            return { success: true };
        } catch (error) {
            console.error('Âà™Èô§Áî®Êà∂Êï∏ÊìöÂ§±Êïó:', error);
            return { success: false, error: error.message };
        }
    }
}

// ÂàùÂßãÂåñÊï∏ÊìöÁÆ°ÁêÜÂô®
let firebaseDataManager;
window.addEventListener('load', () => {
    firebaseDataManager = new FirebaseDataManager();
    window.firebaseDataManager = firebaseDataManager; // ÂÖ®Âüü‰ΩøÁî®
    // Firebase Ë≥áÊñôÁÆ°ÁêÜÂô®ÂàùÂßãÂåñÂÆåÊàêÂæåÊõ¥Êñ∞Áµ±Ë®à
    updateStatistics();
});
        
// ÂàùÂßãÂåñÁ≥ªÁµ±
document.addEventListener('DOMContentLoaded', function() {
    // Á≥ªÁµ±ÂïüÂãïÊôÇÊ∏ÖÁ©∫ÈÅéÊúüÊéõËôü
    clearOldAppointments();
    
    updateClinicSettingsDisplay();
    
    // ÂàùÂßãÂåñÊï∏ÊìöÈÅ∑Áßª
    initializeDataMigration();
    
    // Ëá™ÂãïËÅöÁÑ¶Âà∞ÈõªÂ≠êÈÉµ‰ª∂Ëº∏ÂÖ•Ê°Ü
    const usernameInput = document.getElementById('mainLoginUsername');
    if (usernameInput) {
        setTimeout(() => {
            usernameInput.focus();
        }, 100);
    }
});

// ÂàùÂßãÂåñÊï∏ÊìöÈÅ∑Áßª
async function initializeDataMigration() {
    // Á≠âÂæÖ Firebase Êï∏ÊìöÁÆ°ÁêÜÂô®Ê∫ñÂÇôÂ∞±Á∑í
    while (!window.firebaseDataManager || !window.firebaseDataManager.isReady) {
        await new Promise(resolve => setTimeout(resolve, 500));
    }

    try {
        // Ê™¢Êü•ÊòØÂê¶ÈúÄË¶ÅÈÅ∑ÁßªÁî®Êà∂Êï∏Êìö
        await migrateUserDataToFirebase();
    } catch (error) {
        console.error('Êï∏ÊìöÈÅ∑ÁßªÂàùÂßãÂåñÈåØË™§:', error);
    }
}

// ÈÅ∑ÁßªÁî®Êà∂Êï∏ÊìöÂà∞ Firebase
async function migrateUserDataToFirebase() {
    try {
        // Ê™¢Êü• Firebase ÊòØÂê¶Â∑≤ÊúâÁî®Êà∂Êï∏Êìö
        const firebaseResult = await window.firebaseDataManager.getUsers();
        const hasFirebaseUsers = firebaseResult.success && firebaseResult.data.length > 0;

        // Ê™¢Êü•Êú¨Âú∞ÊòØÂê¶ÊúâÁî®Êà∂Êï∏Êìö
        const localUsers = JSON.parse(localStorage.getItem('users') || '[]');
        const hasLocalUsers = localUsers.length > 0;

        console.log(`Firebase Áî®Êà∂Êï∏Êìö: ${hasFirebaseUsers ? firebaseResult.data.length : 0} Á≠Ü`);
        console.log(`Êú¨Âú∞Áî®Êà∂Êï∏Êìö: ${hasLocalUsers ? localUsers.length : 0} Á≠Ü`);

        if (hasLocalUsers && !hasFirebaseUsers) {
            // ÊúâÊú¨Âú∞Êï∏Êìö‰ΩÜ Firebase Ê≤íÊúâÊï∏ÊìöÔºåÈÄ≤Ë°åÈÅ∑Áßª
            console.log('ÈñãÂßãÈÅ∑ÁßªÁî®Êà∂Êï∏ÊìöÂà∞ Firebase...');
            
            for (const user of localUsers) {
                try {
                    // ÁßªÈô§Êú¨Âú∞ IDÔºåËÆì Firebase ÁîüÊàêÊñ∞ÁöÑ ID
                    const { id, ...userData } = user;
                    
                    const result = await window.firebaseDataManager.addUser(userData);
                    if (result.success) {
                        console.log(`Áî®Êà∂ ${user.name} ÈÅ∑ÁßªÊàêÂäü`);
                    } else {
                        console.error(`Áî®Êà∂ ${user.name} ÈÅ∑ÁßªÂ§±Êïó`);
                    }
                } catch (error) {
                    console.error(`ÈÅ∑ÁßªÁî®Êà∂ ${user.name} ÊôÇÁôºÁîüÈåØË™§:`, error);
                }
            }
            
            console.log('Áî®Êà∂Êï∏ÊìöÈÅ∑ÁßªÂÆåÊàê');
            showToast('Áî®Êà∂Êï∏ÊìöÂ∑≤ÂêåÊ≠•Âà∞Èõ≤Á´Ø', 'success');
        } else if (hasFirebaseUsers) {
            // Firebase ÊúâÊï∏ÊìöÔºåÂêåÊ≠•Âà∞Êú¨Âú∞
            await syncUserDataFromFirebase();
        } else {
            // ÂÖ©ÈÇäÈÉΩÊ≤íÊúâÊï∏ÊìöÔºåËºâÂÖ•È†êË®≠Áî®Êà∂Êï∏Êìö
            if (localUsers.length === 0) {
                users = defaultUsers;
                localStorage.setItem('users', JSON.stringify(users));
                
                // ÈÅ∑ÁßªÈ†êË®≠Áî®Êà∂Âà∞ Firebase
                for (const user of defaultUsers) {
                    try {
                        const { id, ...userData } = user;
                        await window.firebaseDataManager.addUser(userData);
                    } catch (error) {
                        console.error('ÈÅ∑ÁßªÈ†êË®≠Áî®Êà∂Â§±Êïó:', error);
                    }
                }
            }
        }
    } catch (error) {
        console.error('ÈÅ∑ÁßªÁî®Êà∂Êï∏ÊìöÊôÇÁôºÁîüÈåØË™§:', error);
    }
}
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96abf25724ae0514',t:'MTc1NDQ1NjE3NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script><script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"96c38f22ee47ddc3","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.7.0","token":"b2074e7888b746fe9fbbc15492b4c3d4"}' crossorigin="anonymous"></script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"96d90c272a1cdd44","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.7.0","token":"b2074e7888b746fe9fbbc15492b4c3d4"}' crossorigin="anonymous"></script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"96dd51fb1d5d84a2","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.7.0","token":"b2074e7888b746fe9fbbc15492b4c3d4"}' crossorigin="anonymous"></script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"96dd62519b8eb430","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.7.0","token":"b2074e7888b746fe9fbbc15492b4c3d4"}' crossorigin="anonymous"></script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"96deefe9585702cc","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.7.0","token":"b2074e7888b746fe9fbbc15492b4c3d4"}' crossorigin="anonymous"></script>
</body>
</html>
