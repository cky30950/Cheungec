<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰∏≠ÈÜ´Ë®∫ÊâÄÁ≥ªÁµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* ÊµÆÂãïÊèêÁ§∫Ê®£Âºè */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            max-width: 500px;
            padding: 16px 20px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transform: translateX(100%);
            transition: all 0.3s ease-in-out;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .toast.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .toast.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .toast.info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }
        
        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .toast-content {
            flex: 1;
            line-height: 1.4;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">
    <!-- ÁôªÂÖ•È†ÅÈù¢ -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="text-4xl mb-4">üè•</div>
                <h1 id="loginTitle" class="text-2xl font-bold text-gray-800 mb-2">‰∏≠ÈÜ´Ë®∫ÊâÄ</h1>
                <p id="loginEnglishTitle" class="text-sm text-gray-500 mb-3">Traditional Chinese Medicine Clinic</p>
                <p class="text-gray-600">Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑÂ∏≥ËôüÂØÜÁ¢ºÁôªÂÖ•</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Â∏≥Ëôü</label>
                    <input type="text" id="mainLoginUsername" placeholder="Ë´ãËº∏ÂÖ•Â∏≥Ëôü" 
                           class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           onkeypress="if(event.key==='Enter') document.getElementById('mainLoginPassword').focus()">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ÂØÜÁ¢º</label>
                    <input type="password" id="mainLoginPassword" placeholder="Ë´ãËº∏ÂÖ•ÂØÜÁ¢º" 
                           class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           onkeypress="if(event.key==='Enter') attemptMainLogin()">
                </div>
                
                <button onclick="attemptMainLogin()" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                    ÁôªÂÖ•Á≥ªÁµ±
                </button>
                
                <!-- Á§∫ÁØÑÂ∏≥ËôüÊèêÁ§∫ -->
                <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="text-sm font-medium text-blue-800 mb-3">Á§∫ÁØÑÂ∏≥ËôüÔºö</div>
                    <div class="text-xs text-blue-700 space-y-2">
                        <div class="flex justify-between items-center">
                            <span>üë®‚Äçüíº Èô≥Á∂ìÁêÜË®∫ÊâÄÁÆ°ÁêÜ</span>
                            <span class="font-mono bg-white px-2 py-1 rounded">manager / manager2024</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span>üë®‚Äç‚öïÔ∏è Âºµ‰∏≠ÈÜ´Â∏´ÈÜ´Â∏´</span>
                            <span class="font-mono bg-white px-2 py-1 rounded">drzhang / zhang888</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span>üë©‚Äçüíª ÊûóË≠∑ÁêÜÂ∏´Ë≠∑ÁêÜÂ∏´</span>
                            <span class="font-mono bg-white px-2 py-1 rounded">nurse_amy / amy2024</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ‰∏ªÁ≥ªÁµ±È†ÅÈù¢ -->
    <div id="mainSystem" class="hidden fade-in">
        <!-- ÂÅ¥ÈÇäÈÅ∏ÂñÆ -->
        <div id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-2xl transform -translate-x-full transition-transform duration-300 ease-in-out">
            <div class="flex flex-col h-full">
                <!-- ÈÅ∏ÂñÆÊ®ôÈ°å -->
                <div class="bg-green-600 text-white p-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">üè•</span>
                            <h2 class="text-lg font-bold">Ë®∫ÊâÄÂäüËÉΩ</h2>
                        </div>
                        <button onclick="toggleSidebar()" class="text-white hover:text-gray-200 text-xl">
                            √ó
                        </button>
                    </div>
                    <div id="sidebarUserRole" class="text-sm text-green-100 mt-2"></div>
                </div>

                <!-- ÂäüËÉΩÈÅ∏ÂñÆÈ†ÖÁõÆ -->
                <div class="flex-1 py-4">
                    <div id="sidebarMenu" class="space-y-2 px-4">
                        <!-- ÈÅ∏ÂñÆÈ†ÖÁõÆÊúÉÂãïÊÖãÁîüÊàê -->
                    </div>
                </div>

                <!-- Â∫ïÈÉ®Êìç‰Ωú -->
                <div class="border-t border-gray-200 p-4">
                    <button onclick="logout()" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg text-sm transition duration-200 flex items-center justify-center">
                        <span class="mr-2">üö™</span>
                        ÁôªÂá∫Á≥ªÁµ±
                    </button>
                </div>
            </div>
        </div>

        <!-- ÈÅÆÁΩ©Â±§ -->
        <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden" onclick="toggleSidebar()"></div>

        <!-- È†ÇÈÉ®Â∞éËà™ -->
        <nav class="bg-white shadow-lg border-b-4 border-green-500">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <button onclick="toggleSidebar()" class="mr-4 p-2 rounded-lg hover:bg-gray-100 transition duration-200">
                            <div class="w-6 h-6 flex flex-col justify-center space-y-1">
                                <div class="w-full h-0.5 bg-gray-600"></div>
                                <div class="w-full h-0.5 bg-gray-600"></div>
                                <div class="w-full h-0.5 bg-gray-600"></div>
                            </div>
                        </button>
                        <span class="text-2xl mr-3">üè•</span>
                        <div>
                            <h1 id="systemTitle" class="text-xl font-bold text-gray-800">‰∏≠ÈÜ´Ë®∫ÊâÄ</h1>
                            <p id="systemEnglishTitle" class="text-xs text-gray-500">Traditional Chinese Medicine Clinic</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="userRole" class="text-sm text-gray-600"></span>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                            ÁôªÂá∫
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- ‰∏ªË¶ÅÂÖßÂÆπÂçÄÂüü -->
        <div class="max-w-7xl mx-auto px-4 py-6">
            <!-- Ê≠°ËøéÈ†ÅÈù¢ -->
            <div id="welcomePage" class="text-center py-16">
                <div class="text-6xl mb-6">üè•</div>
                <h2 id="welcomeTitle" class="text-3xl font-bold text-gray-800 mb-2">Ê≠°Ëøé‰ΩøÁî®‰∏≠ÈÜ´Ë®∫ÊâÄ</h2>
                <p id="welcomeEnglishTitle" class="text-lg text-gray-500 mb-4">Welcome to Traditional Chinese Medicine Clinic</p>
                <p class="text-gray-600 text-lg mb-8">Ë´ãÈªûÊìäÂ∑¶‰∏äËßíÈÅ∏ÂñÆÊåâÈàïÈñãÂßã‰ΩøÁî®Á≥ªÁµ±ÂäüËÉΩ</p>
                <div class="bg-white rounded-xl shadow-lg p-8 max-w-4xl mx-auto">
                    <h3 class="text-xl font-semibold mb-4">Á≥ªÁµ±ÂäüËÉΩÊ¶ÇË¶Ω</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <div class="text-2xl mb-2">üë•</div>
                            <div class="font-semibold">ÁóÖ‰∫∫Ë≥áÊñôÁÆ°ÁêÜ</div>
                            <div class="text-gray-600 mt-1">Êñ∞Â¢û„ÄÅÊü•Áúã„ÄÅÁÆ°ÁêÜÁóÖ‰∫∫Ë≥áÊñô</div>
                        </div>
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <div class="text-2xl mb-2">ü©∫</div>
                            <div class="font-semibold">Ë®∫ÁóáÁ≥ªÁµ±</div>
                            <div class="text-gray-600 mt-1">Ë®òÈåÑÁóáÁãÄ„ÄÅË®∫Êñ∑„ÄÅÈñãÁ´ãËôïÊñπ</div>
                        </div>
                        <div class="text-center p-4 bg-purple-50 rounded-lg">
                            <div class="text-2xl mb-2">üë§</div>
                            <div class="font-semibold">Áî®Êà∂ÁÆ°ÁêÜ</div>
                            <div class="text-gray-600 mt-1">ÁÆ°ÁêÜË®∫ÊâÄÁî®Êà∂Â∏≥ËôüÂèäÊ¨äÈôê</div>
                        </div>
                        <div class="text-center p-4 bg-red-50 rounded-lg">
                            <div class="text-2xl mb-2">‚öôÔ∏è</div>
                            <div class="font-semibold">Á≥ªÁµ±ÁÆ°ÁêÜ</div>
                            <div class="text-gray-600 mt-1">Áµ±Ë®àË≥áÊñô„ÄÅÂÇô‰ªΩÂåØÂá∫</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÁóÖ‰∫∫Ë≥áÊñôÁÆ°ÁêÜ -->
            <div id="patientManagement" class="hidden bg-white rounded-xl shadow-lg p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">ÁóÖ‰∫∫Ë≥áÊñôÁÆ°ÁêÜ</h2>
                    <div class="flex flex-col md:flex-row gap-3">
                        <div class="relative">
                            <input type="text" id="searchPatient" placeholder="ÊêúÂ∞ãÁóÖ‰∫∫Á∑®Ëôü„ÄÅÂßìÂêçÊàñÈõªË©±..." class="border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:ring-2 focus:ring-green-500 focus:border-transparent w-full md:w-64">
                            <span class="absolute right-3 top-2.5 text-gray-400">üîç</span>
                        </div>
                        <button onclick="showAddPatientForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200 whitespace-nowrap">
                            + Êñ∞Â¢ûÁóÖ‰∫∫
                        </button>
                    </div>
                </div>

                <!-- Êñ∞Â¢û/Á∑®ËºØÁóÖ‰∫∫Ë°®ÂñÆÂΩàÁ™ó -->
                <div id="addPatientModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                            <h3 id="formTitle" class="text-xl font-bold text-gray-800">Êñ∞Â¢ûÁóÖ‰∫∫Ë≥áÊñô</h3>
                            <button onclick="hideAddPatientForm()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ÂßìÂêç *</label>
                                    <input type="text" id="patientName" placeholder="Ë´ãËº∏ÂÖ•ÂßìÂêç" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Âπ¥ÈΩ°</label>
                                    <input type="number" id="patientAge" placeholder="Á≥ªÁµ±Ëá™ÂãïË®àÁÆó" min="0" max="120" readonly class="w-full border border-gray-300 rounded-lg px-4 py-2 bg-gray-100 text-gray-600">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ÊÄßÂà• *</label>
                                    <select id="patientGender" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                        <option value="">Ë´ãÈÅ∏ÊìáÊÄßÂà•</option>
                                        <option value="Áî∑">Áî∑</option>
                                        <option value="Â•≥">Â•≥</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ÈõªË©±ËôüÁ¢º *</label>
                                    <input type="tel" id="patientPhone" placeholder="‰æãÔºö0912-345-678" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Ë∫´ÂàÜË≠âÂ≠óËôü</label>
                                    <input type="text" id="patientIdCard" placeholder="‰æãÔºöA123456789" maxlength="10" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Âá∫ÁîüÊó•Êúü *</label>
                                    <input type="date" id="patientBirthDate" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent" onchange="updatePatientAge()">
                                </div>
                                <div class="md:col-span-2 lg:col-span-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ËÅØÁµ°Âú∞ÂùÄ</label>
                                    <textarea id="patientAddress" placeholder="Ë´ãËº∏ÂÖ•ÂÆåÊï¥Âú∞ÂùÄ" rows="2" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                                </div>
                                <div class="md:col-span-2 lg:col-span-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ÈÅéÊïèÂè≤</label>
                                    <textarea id="patientAllergies" placeholder="Ë´ãË©≥Á¥∞Ë®òÈåÑËó•Áâ©ÈÅéÊïèÊàñÈ£üÁâ©ÈÅéÊïèÂè≤" rows="2" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                                </div>
                                <div class="md:col-span-2 lg:col-span-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ÁóÖÂè≤ÂèäÂÇôË®ª</label>
                                    <textarea id="patientHistory" placeholder="Ë´ãË®òÈåÑÈáçË¶ÅÁóÖÂè≤„ÄÅÂÆ∂ÊóèÁóÖÂè≤„ÄÅÊÖ¢ÊÄßÁñæÁóÖÁ≠â" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-gray-200">
                                <button onclick="hideAddPatientForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                                    ÂèñÊ∂à
                                </button>
                                <button onclick="savePatient()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200">
                                    <span id="saveButtonText">ÂÑ≤Â≠ò</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ÁóÖ‰∫∫ÂàóË°® -->
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Á∑®Ëôü</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ÂßìÂêç</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Âπ¥ÈΩ°</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ÊÄßÂà•</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ÈõªË©±</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody id="patientList" class="divide-y divide-gray-200">
                            <!-- ÁóÖ‰∫∫Ë≥áÊñôÊúÉÂãïÊÖãËºâÂÖ• -->
                        </tbody>
                    </table>
                </div>

                <!-- ÁóÖ‰∫∫Ë©≥Á¥∞Ë≥áÊñôÂΩàÁ™ó -->
                <div id="patientDetailModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
                            <h3 class="text-xl font-bold text-gray-800">ÁóÖ‰∫∫Ë©≥Á¥∞Ë≥áÊñô</h3>
                            <button onclick="closePatientDetail()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                        </div>
                        <div id="patientDetailContent" class="p-6">
                            <!-- Ë©≥Á¥∞ÂÖßÂÆπÊúÉÂãïÊÖãËºâÂÖ• -->
                        </div>
                    </div>
                </div>

                <!-- ÁóÖ‰∫∫ÁóÖÊ≠∑Êü•ÁúãÂΩàÁ™ó -->
                <div id="patientMedicalHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                            <h3 id="patientMedicalHistoryTitle" class="text-xl font-bold text-gray-800">ÁóÖÊ≠∑Ë®òÈåÑ</h3>
                            <button onclick="closePatientMedicalHistoryModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                        </div>
                        
                        <div class="p-6">
                            <!-- ÁóÖ‰∫∫Âü∫Êú¨Ë≥áË®ä -->
                            <div id="patientMedicalHistoryPatientInfo" class="bg-blue-50 rounded-lg p-4 mb-6">
                                <!-- ÁóÖ‰∫∫Ë≥áË®äÊúÉÂãïÊÖãËºâÂÖ• -->
                            </div>
                            
                            <!-- Ë®∫ÁóáË®òÈåÑÂàóË°® -->
                            <div id="patientMedicalHistoryContent">
                                <!-- Ë®∫ÁóáË®òÈåÑÊúÉÂãïÊÖãËºâÂÖ• -->
                            </div>
                        </div>
                    </div>
                </div>




            </div>

            <!-- Ë®∫ÁóáÁ≥ªÁµ± -->
            <div id="consultationSystem" class="hidden bg-white rounded-xl shadow-lg p-6">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">ÊéõËôüË®∫ÁóáÁ≥ªÁµ±</h2>
                    <p class="text-gray-600 mt-2">Á∞°ÊΩîÁöÑÊéõËôüÊµÅÁ®ãÁÆ°ÁêÜ</p>
                </div>
                
                <!-- ÁóÖ‰∫∫ÊêúÁ¥¢ÊéõËôü -->
                <div class="bg-gradient-to-r from-blue-50 to-green-50 rounded-lg p-6 mb-6">
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold text-gray-800 flex items-center mb-2">
                            <span class="mr-2">üîç</span>ÊêúÁ¥¢ÁóÖ‰∫∫ÊéõËôü
                        </h3>
                        <p class="text-sm text-gray-600">Ë´ãËº∏ÂÖ•ÁóÖ‰∫∫ÂßìÂêç„ÄÅÁ∑®ËôüÊàñÈõªË©±ÈÄ≤Ë°åÊêúÁ¥¢</p>
                    </div>
                    
                    <div class="flex gap-3">
                        <div class="flex-1 relative">
                            <input type="text" id="patientSearchInput" placeholder="ÊêúÂ∞ãÁóÖ‰∫∫ÂßìÂêç„ÄÅÁ∑®ËôüÊàñÈõªË©±..." 
                                   class="w-full border border-gray-300 rounded-lg px-4 py-3 pr-10 focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                   oninput="searchPatientsForRegistration()">
                            <span class="absolute right-3 top-3.5 text-gray-400">üîç</span>
                        </div>
                        <button onclick="clearPatientSearch()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-lg transition duration-200">
                            Ê∏ÖÈô§
                        </button>
                    </div>
                    
                    <!-- ÊêúÁ¥¢ÁµêÊûú -->
                    <div id="patientSearchResults" class="mt-4 hidden">
                        <div class="bg-white rounded-lg border border-gray-200 max-h-64 overflow-y-auto">
                            <div id="searchResultsList" class="divide-y divide-gray-200">
                                <!-- ÊêúÁ¥¢ÁµêÊûúÊúÉÂãïÊÖãËºâÂÖ• -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ÊéõËôüÂΩàÁ™ó -->
                <div id="registrationModal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
                        <div class="bg-green-600 text-white px-6 py-4 rounded-t-xl">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-bold">ÁóÖ‰∫∫ÊéõËôü</h3>
                                <button onclick="closeRegistrationModal()" class="text-white hover:text-gray-200 text-2xl">√ó</button>
                            </div>
                        </div>
                        
                        <div class="p-6 space-y-4">
                            <!-- ÈÅ∏‰∏≠ÁöÑÁóÖ‰∫∫Ë≥áË®ä -->
                            <div class="bg-blue-50 rounded-lg p-4">
                                <div class="flex items-center mb-2">
                                    <span class="mr-2">üë§</span>
                                    <span class="font-semibold text-gray-700">ÁóÖ‰∫∫Ë≥áË®ä</span>
                                </div>
                                <div id="selectedPatientInfo" class="text-sm text-gray-600">
                                    <!-- ÁóÖ‰∫∫Ë≥áË®äÊúÉÂãïÊÖãËºâÂÖ• -->
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <span class="mr-2">‚è∞</span>ÊéõËôüÊôÇÈñì
                                </label>
                                <input type="datetime-local" id="appointmentDateTime" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <span class="mr-2">üìù</span>‰∏ªË®¥ÁóáÁãÄ
                                </label>
                                <textarea id="quickChiefComplaint" placeholder="Ë´ãÁ∞°Ëø∞ÁóÖ‰∫∫ÁöÑ‰∏ªË¶ÅÁóáÁãÄ..." rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                            </div>
                            
                            <div class="flex space-x-3 pt-4">
                                <button onclick="closeRegistrationModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg transition duration-200">
                                    ÂèñÊ∂à
                                </button>
                                <button onclick="confirmRegistration()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                    Á¢∫Ë™çÊéõËôü
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ‰ªäÊó•ÊéõËôüÂàóË°® -->
                <div class="bg-white border border-gray-200 rounded-lg">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 rounded-t-lg">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                                <span class="mr-2">üìÖ</span>‰ªäÊó•ÊéõËôüÂàóË°®
                            </h3>
                            <div class="text-sm text-gray-600">
                                Á∏ΩË®àÔºö<span id="todayTotal" class="font-semibold text-blue-600">0</span> ‰∫∫
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Â∫èËôü</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ÁóÖ‰∫∫ÂßìÂêç</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ÊéõËôüÊôÇÈñì</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‰∏ªË®¥ÁóáÁãÄ</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ÁãÄÊÖã</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Êìç‰Ωú</th>
                                    </tr>
                                </thead>
                                <tbody id="todayAppointmentsList" class="divide-y divide-gray-200">
                                    <!-- ÊéõËôüÂàóË°®ÊúÉÂãïÊÖãËºâÂÖ• -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>



                <!-- Ë®∫ÁóáË®òÈåÑÊü•ÁúãÂΩàÁ™ó -->
                <div id="medicalHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                            <h3 id="medicalHistoryTitle" class="text-xl font-bold text-gray-800">Ë®∫ÁóáË®òÈåÑ</h3>
                            <button onclick="closeMedicalHistoryModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                        </div>
                        
                        <div class="p-6">
                            <!-- ÁóÖ‰∫∫Âü∫Êú¨Ë≥áË®ä -->
                            <div id="medicalHistoryPatientInfo" class="bg-blue-50 rounded-lg p-4 mb-6">
                                <!-- ÁóÖ‰∫∫Ë≥áË®äÊúÉÂãïÊÖãËºâÂÖ• -->
                            </div>
                            
                            <!-- Ë®∫ÁóáË®òÈåÑÂàóË°® -->
                            <div id="medicalHistoryContent">
                                <!-- Ë®∫ÁóáË®òÈåÑÊúÉÂãïÊÖãËºâÂÖ• -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ë®∫ÁóáË°®ÂñÆÂçÄÂüü -->
                <div id="consultationForm" class="hidden bg-white border border-gray-200 rounded-lg mt-6">
                    <div class="bg-green-600 text-white px-6 py-4 rounded-t-lg">
                        <h3 class="text-xl font-bold">Ë®∫ÁóáË®òÈåÑ</h3>
                    </div>
                    
                    <div class="p-6">
                        <!-- ÁóÖ‰∫∫Ë≥áË®ä -->
                        <div class="bg-blue-50 rounded-lg p-4 mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="font-medium">ÁóÖ‰∫∫Ôºö</span>
                                    <span id="formPatientName" class="text-blue-600 font-semibold"></span>
                                </div>
                                <div>
                                    <span class="font-medium">ÊéõËôüÊôÇÈñìÔºö</span>
                                    <span id="formAppointmentTime"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Ë®∫ÁóáË°®ÂñÆ -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Â∑¶ÂÅ¥ -->
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        ‰∏ªË®¥ *
                                    </label>
                                    <textarea id="formSymptoms" placeholder="ÁóÖ‰∫∫‰∏ªË¶Å‰∏çÈÅ©ÁóáÁãÄ„ÄÅÁôºÁóÖÊôÇÈñì„ÄÅÁóáÁãÄÁâπÈªûÁ≠â..." rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        ËàåË±°
                                    </label>
                                    <textarea id="formTongue" placeholder="ËàåË≥™„ÄÅËàåËãî„ÄÅËàåÂΩ¢Á≠â..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        ËÑàË±°
                                    </label>
                                    <textarea id="formPulse" placeholder="ËÑà‰Ωç„ÄÅËÑàÁéá„ÄÅËÑàÂäõ„ÄÅËÑàÂΩ¢Á≠â..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        ÁèæÁóÖÂè≤
                                    </label>
                                    <textarea id="formCurrentHistory" placeholder="ÁôºÁóÖÁ∂ìÈÅé„ÄÅÁóáÁãÄËÆäÂåñ„ÄÅÊ≤ªÁôÇÁ∂ìÈÅéÁ≠â..." rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        ‰∏≠ÈÜ´Ë®∫Êñ∑ *
                                    </label>
                                    <textarea id="formDiagnosis" placeholder="‰∏≠ÈÜ´ÁóÖÂêçË®∫Êñ∑..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        Ë≠âÂûãË®∫Êñ∑
                                    </label>
                                    <textarea id="formSyndrome" placeholder="Ëæ®Ë≠âÂàÜÂûã„ÄÅÁóÖÊ©üÂàÜÊûê..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        ÈáùÁÅ∏ÂÇôË®ª
                                    </label>
                                    <textarea id="formAcupunctureNotes" placeholder="ÈáùÁÅ∏Á©¥‰Ωç„ÄÅÊâãÊ≥ï„ÄÅÊ≥®ÊÑè‰∫ãÈ†ÖÁ≠â..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                            </div>
                            
                            <!-- Âè≥ÂÅ¥ -->
                            <div class="space-y-4">
                                
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="block text-sm font-semibold text-gray-700">
                                            ËôïÊñπÂÖßÂÆπ
                                        </label>
                                        <button type="button" onclick="loadPreviousPrescription()" 
                                                class="text-xs bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded transition duration-200">
                                            üìã ËºâÂÖ•‰∏äÊ¨°ËôïÊñπ
                                        </button>
                                    </div>
                                    
                                    <!-- ‰∏≠Ëó•Â∫´ÊêúÁ¥¢ÂçÄÂüü -->
                                    <div class="mb-3 bg-blue-50 rounded-lg p-3 border border-blue-200">
                                        <div class="flex items-center mb-2">
                                            <span class="text-sm font-medium text-blue-800 mr-2">üîç ÊêúÁ¥¢‰∏≠Ëó•Â∫´Ôºö</span>
                                            <div class="flex-1 relative">
                                                <input type="text" id="prescriptionSearch" placeholder="ÊêúÁ¥¢‰∏≠Ëó•ÊùêÊàñÊñπÂäëÂêçÁ®±..." 
                                                       class="w-full border border-blue-300 rounded px-3 py-1 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                       oninput="searchHerbsForPrescription()">
                                                <button onclick="clearPrescriptionSearch()" class="absolute right-2 top-1 text-gray-400 hover:text-gray-600 text-sm">√ó</button>
                                            </div>
                                        </div>
                                        
                                        <!-- ÊêúÁ¥¢ÁµêÊûú -->
                                        <div id="prescriptionSearchResults" class="hidden">
                                            <div class="bg-white rounded border border-blue-200 max-h-48 overflow-y-auto">
                                                <div id="prescriptionSearchList" class="grid grid-cols-1 md:grid-cols-2 gap-2 p-2">
                                                    <!-- ÊêúÁ¥¢ÁµêÊûúÊúÉÂãïÊÖãËºâÂÖ• -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Â∑≤ÈÅ∏ÊìáÁöÑËôïÊñπÂÖßÂÆπ -->
                                    <div class="border border-gray-300 rounded-lg p-3 min-h-[120px] bg-gray-50">
                                        <div id="selectedPrescriptionItems" class="space-y-2">
                                            <div class="text-sm text-gray-500 text-center py-4">
                                                Ë´ã‰ΩøÁî®‰∏äÊñπÊêúÁ¥¢ÂäüËÉΩÊ∑ªÂä†‰∏≠Ëó•ÊùêÊàñÊñπÂäë
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- ÊúçËó•Â§©Êï∏ÂèäÊ¨°Êï∏Ë®≠ÂÆöÔºàÂè™Âú®ÊúâËôïÊñπÂÖßÂÆπÊôÇÈ°ØÁ§∫Ôºâ -->
                                    <div id="medicationSettings" class="mt-3 bg-green-50 rounded-lg p-3 border border-green-200" style="display: none;">
                                        <div class="space-y-3">
                                            <!-- ÊúçËó•Â§©Êï∏ -->
                                            <div class="flex items-center justify-between">
                                                <span class="text-sm font-medium text-green-800">ÊúçËó•Â§©Êï∏</span>
                                                <div class="flex items-center space-x-2">
                                                    <button onclick="updateMedicationDays(-1)" class="w-7 h-7 bg-green-500 text-white rounded-full text-sm hover:bg-green-600 transition duration-200">-</button>
                                                    <input type="number" id="medicationDays" value="5" min="1" max="30" 
                                                           class="w-14 px-2 py-1 text-center border border-green-300 rounded focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm"
                                                           onchange="updateMedicationDaysFromInput()" onclick="this.select()">
                                                    <button onclick="updateMedicationDays(1)" class="w-7 h-7 bg-green-500 text-white rounded-full text-sm hover:bg-green-600 transition duration-200">+</button>
                                                    <span class="text-sm text-green-800">Â§©</span>
                                                </div>
                                            </div>
                                            
                                            <!-- ÊúçËó•Ê¨°Êï∏ -->
                                            <div class="flex items-center justify-between">
                                                <span class="text-sm font-medium text-green-800">ÊØèÊó•Ê¨°Êï∏</span>
                                                <div class="flex items-center space-x-2">
                                                    <button onclick="updateMedicationFrequency(-1)" class="w-7 h-7 bg-green-500 text-white rounded-full text-sm hover:bg-green-600 transition duration-200">-</button>
                                                    <input type="number" id="medicationFrequency" value="2" min="1" max="6" 
                                                           class="w-14 px-2 py-1 text-center border border-green-300 rounded focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm"
                                                           onchange="updateMedicationFrequency(0)" onclick="this.select()">
                                                    <button onclick="updateMedicationFrequency(1)" class="w-7 h-7 bg-green-500 text-white rounded-full text-sm hover:bg-green-600 transition duration-200">+</button>
                                                    <span class="text-sm text-green-800">Ê¨°/Êó•</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Èö±ËóèÁöÑÊñáÊú¨ÂüüÁî®ÊñºÂ≠òÂÑ≤ËôïÊñπÂÖßÂÆπ -->
                                    <textarea id="formPrescription" class="hidden"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        ÊúçÁî®ÊñπÊ≥ï
                                    </label>
                                    <textarea id="formUsage" placeholder="ÁÖéÁÖÆÊñπÊ≥ï„ÄÅÊúçÁî®ÊôÇÈñì„ÄÅÂäëÈáèÁ≠â..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="block text-sm font-semibold text-gray-700">
                                            Êî∂Ë≤ªÈ†ÖÁõÆ
                                        </label>
                                        <button type="button" onclick="loadPreviousBillingItems()" 
                                                class="text-xs bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded transition duration-200">
                                            üí∞ ËºâÂÖ•‰∏äÊ¨°Êî∂Ë≤ª
                                        </button>
                                    </div>
                                    
                                    <!-- Êî∂Ë≤ªÈ†ÖÁõÆÊêúÁ¥¢ÂçÄÂüü -->
                                    <div class="mb-3 bg-green-50 rounded-lg p-3 border border-green-200">
                                        <div class="flex items-center mb-2">
                                            <span class="text-sm font-medium text-green-800 mr-2">üí∞ ÈÅ∏ÊìáÊî∂Ë≤ªÈ†ÖÁõÆÔºö</span>
                                            <div class="flex-1 relative">
                                                <input type="text" id="billingSearch" placeholder="ÊêúÁ¥¢Êî∂Ë≤ªÈ†ÖÁõÆÂêçÁ®±..." 
                                                       class="w-full border border-green-300 rounded px-3 py-1 text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                       oninput="searchBillingForConsultation()">
                                                <button onclick="clearBillingSearch()" class="absolute right-2 top-1 text-gray-400 hover:text-gray-600 text-sm">√ó</button>
                                            </div>
                                        </div>
                                        
                                        <!-- ÊêúÁ¥¢ÁµêÊûú -->
                                        <div id="billingSearchResults" class="hidden">
                                            <div class="bg-white rounded border border-green-200 max-h-48 overflow-y-auto">
                                                <div id="billingSearchList" class="grid grid-cols-1 md:grid-cols-2 gap-2 p-2">
                                                    <!-- ÊêúÁ¥¢ÁµêÊûúÊúÉÂãïÊÖãËºâÂÖ• -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Â∑≤ÈÅ∏ÊìáÁöÑÊî∂Ë≤ªÈ†ÖÁõÆ -->
                                    <div class="border border-gray-300 rounded-lg p-3 min-h-[80px] bg-gray-50">
                                        <div id="selectedBillingItems" class="space-y-2">
                                            <div class="text-sm text-gray-500 text-center py-4">
                                                Ë´ã‰ΩøÁî®‰∏äÊñπÊêúÁ¥¢ÂäüËÉΩÊ∑ªÂä†Êî∂Ë≤ªÈ†ÖÁõÆ
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Á∏ΩË≤ªÁî®È°ØÁ§∫ -->
                                    <div class="mt-2 text-right">
                                        <span class="text-sm font-medium text-gray-700">Á∏ΩË≤ªÁî®Ôºö</span>
                                        <span id="totalBillingAmount" class="text-lg font-bold text-green-600">$0</span>
                                    </div>
                                    
                                    <!-- Èö±ËóèÁöÑÊñáÊú¨ÂüüÁî®ÊñºÂ≠òÂÑ≤Êî∂Ë≤ªÈ†ÖÁõÆ -->
                                    <textarea id="formBillingItems" class="hidden"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        ÁôÇÁ®ã
                                    </label>
                                    <input type="text" id="formTreatmentCourse" placeholder="‰æãÔºö7Â§©„ÄÅ2ÈÄ±„ÄÅ1ÂÄãÊúàÁ≠â..." class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        ÈÜ´ÂõëÂèäÊ≥®ÊÑè‰∫ãÈ†Ö
                                    </label>
                                    <textarea id="formInstructions" placeholder="È£≤È£üÂÆúÂøå„ÄÅÁîüÊ¥ªË™øË≠∑„ÄÅÊ≥®ÊÑè‰∫ãÈ†ÖÁ≠â..." rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Ë§áË®∫ÊôÇÈñì -->
                        <div class="mt-6 pt-4 border-t border-gray-200">
                            <div class="max-w-md">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Ë§áË®∫ÊôÇÈñì
                                </label>
                                <input type="datetime-local" id="formFollowUpDate" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <p class="text-xs text-gray-500 mt-1">Âª∫Ë≠∞ÁóÖ‰∫∫‰∏ãÊ¨°ÂõûË®∫ÁöÑÊôÇÈñì</p>
                            </div>
                        </div>
                        
                        <!-- Êìç‰ΩúÊåâÈàï -->
                        <div class="flex justify-end space-x-3 mt-6 pt-4 border-t border-gray-200">
                            <button onclick="cancelConsultation()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                                ÂèñÊ∂àË®∫Áóá
                            </button>
                            <button onclick="saveConsultation()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200">
                                <span id="consultationSaveButtonText">ÂÆåÊàêË®∫Áóá</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‰∏≠Ëó•Â∫´ÁÆ°ÁêÜ -->
            <div id="herbLibrary" class="hidden bg-white rounded-xl shadow-lg p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">‰∏≠Ëó•Â∫´ÁÆ°ÁêÜ</h2>
                    <div class="flex flex-col md:flex-row gap-3">
                        <div class="relative">
                            <input type="text" id="searchHerb" placeholder="ÊêúÂ∞ã‰∏≠Ëó•ÊùêÊàñÊñπÂäëÂêçÁ®±..." class="border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:ring-2 focus:ring-green-500 focus:border-transparent w-full md:w-64">
                            <span class="absolute right-3 top-2.5 text-gray-400">üîç</span>
                        </div>
                        <button onclick="showAddHerbForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200 whitespace-nowrap">
                            + Êñ∞Â¢û‰∏≠Ëó•Êùê
                        </button>
                        <button onclick="showAddFormulaForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200 whitespace-nowrap">
                            + Êñ∞Â¢ûÊñπÂäë
                        </button>
                    </div>
                </div>

                <!-- ÂàÜÈ°ûÊ®ôÁ±§ -->
                <div class="mb-6">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterHerbLibrary('all')" id="filter-all" class="px-4 py-2 rounded-lg text-sm font-medium bg-blue-100 text-blue-800 transition duration-200">
                            ÂÖ®ÈÉ®
                        </button>
                        <button onclick="filterHerbLibrary('herb')" id="filter-herb" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            ‰∏≠Ëó•Êùê
                        </button>
                        <button onclick="filterHerbLibrary('formula')" id="filter-formula" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            ÊñπÂäë
                        </button>
                    </div>
                </div>

                <!-- Êñ∞Â¢û/Á∑®ËºØ‰∏≠Ëó•ÊùêË°®ÂñÆÂΩàÁ™ó -->
                <div id="addHerbModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                            <h3 id="herbFormTitle" class="text-xl font-bold text-gray-800">Êñ∞Â¢û‰∏≠Ëó•Êùê</h3>
                            <button onclick="hideAddHerbForm()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">‰∏≠Ëó•ÊùêÂêçÁ®± *</label>
                                    <input type="text" id="herbName" placeholder="Ë´ãËº∏ÂÖ•‰∏≠Ëó•ÊùêÂêçÁ®±" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Âà•Âêç</label>
                                    <input type="text" id="herbAlias" placeholder="ÂÖ∂‰ªñÂêçÁ®±ÊàñÂà•Âêç" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ÊÄßÂë≥</label>
                                    <input type="text" id="herbNature" placeholder="‰æãÔºöÁîò„ÄÅÂæÆËã¶ÔºåÊ∫´" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Ê≠∏Á∂ì</label>
                                    <input type="text" id="herbMeridian" placeholder="‰æãÔºöËÇ∫„ÄÅËÑæ„ÄÅËÖéÁ∂ì" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ÂäüÊïà</label>
                                    <textarea id="herbEffects" placeholder="Ë´ãÊèèËø∞‰∏ªË¶ÅÂäüÊïà" rows="2" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">‰∏ªÊ≤ª</label>
                                    <textarea id="herbIndications" placeholder="Ë´ãÊèèËø∞‰∏ªË¶ÅÊ≤ªÁôÇÁØÑÂúç" rows="2" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Â∏∏Áî®ÂäëÈáè</label>
                                    <input type="text" id="herbDosage" placeholder="‰æãÔºö3-9g" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">‰ΩøÁî®Ê≥®ÊÑè</label>
                                    <input type="text" id="herbCautions" placeholder="Á¶ÅÂøåÊàñÊ≥®ÊÑè‰∫ãÈ†Ö" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-gray-200">
                                <button onclick="hideAddHerbForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                                    ÂèñÊ∂à
                                </button>
                                <button onclick="saveHerb()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200">
                                    <span id="herbSaveButtonText">ÂÑ≤Â≠ò</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Êñ∞Â¢û/Á∑®ËºØÊñπÂäëË°®ÂñÆÂΩàÁ™ó -->
                <div id="addFormulaModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                            <h3 id="formulaFormTitle" class="text-xl font-bold text-gray-800">Êñ∞Â¢ûÊñπÂäë</h3>
                            <button onclick="hideAddFormulaForm()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">ÊñπÂäëÂêçÁ®± *</label>
                                        <input type="text" id="formulaName" placeholder="Ë´ãËº∏ÂÖ•ÊñπÂäëÂêçÁ®±" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Âá∫Ëôï</label>
                                        <input type="text" id="formulaSource" placeholder="‰æãÔºöÂÇ∑ÂØíË´ñ„ÄÅÈáëÂå±Ë¶ÅÁï•" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">ÂäüÊïà</label>
                                        <textarea id="formulaEffects" placeholder="Ë´ãÊèèËø∞ÊñπÂäë‰∏ªË¶ÅÂäüÊïà" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">‰∏ªÊ≤ª</label>
                                        <textarea id="formulaIndications" placeholder="Ë´ãÊèèËø∞‰∏ªË¶ÅÊ≤ªÁôÇÁóÖÁóá" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                    </div>
                                </div>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">ÁµÑÊàê *</label>
                                        <textarea id="formulaComposition" placeholder="Ë´ãËº∏ÂÖ•ÊñπÂäëÁµÑÊàêÔºå‰æãÂ¶ÇÔºö&#10;‰∫∫ÂèÉ 9g&#10;ÁôΩÊúÆ 9g&#10;ËåØËãì 9g&#10;ÁîòËçâ 6g" rows="8" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Áî®Ê≥ï</label>
                                        <textarea id="formulaUsage" placeholder="ÁÖéÁÖÆÊñπÊ≥ï„ÄÅÊúçÁî®ÊñπÂºèÁ≠â" rows="2" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Ê≥®ÊÑè‰∫ãÈ†Ö</label>
                                        <textarea id="formulaCautions" placeholder="Á¶ÅÂøå„ÄÅÊ≥®ÊÑè‰∫ãÈ†ÖÁ≠â" rows="2" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-gray-200">
                                <button onclick="hideAddFormulaForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                                    ÂèñÊ∂à
                                </button>
                                <button onclick="saveFormula()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition duration-200">
                                    <span id="formulaSaveButtonText">ÂÑ≤Â≠ò</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ‰∏≠Ëó•Â∫´ÂàóË°® -->
                <div class="overflow-x-auto">
                    <div id="herbLibraryList" class="space-y-4">
                        <!-- ‰∏≠Ëó•Â∫´ÂÖßÂÆπÊúÉÂãïÊÖãËºâÂÖ• -->
                    </div>
                </div>
            </div>

            <!-- Êî∂Ë≤ªÈ†ÖÁõÆÁÆ°ÁêÜ -->
            <div id="billingManagement" class="hidden bg-white rounded-xl shadow-lg p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">Êî∂Ë≤ªÈ†ÖÁõÆÁÆ°ÁêÜ</h2>
                    <div class="flex flex-col md:flex-row gap-3">
                        <div class="relative">
                            <input type="text" id="searchBilling" placeholder="ÊêúÂ∞ãÊî∂Ë≤ªÈ†ÖÁõÆÂêçÁ®±..." class="border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:ring-2 focus:ring-green-500 focus:border-transparent w-full md:w-64">
                            <span class="absolute right-3 top-2.5 text-gray-400">üîç</span>
                        </div>
                        <button onclick="showAddBillingItemForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200 whitespace-nowrap">
                            + Êñ∞Â¢ûÊî∂Ë≤ªÈ†ÖÁõÆ
                        </button>
                    </div>
                </div>

                <!-- ÂàÜÈ°ûÊ®ôÁ±§ -->
                <div class="mb-6">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterBillingItems('all')" id="billing-filter-all" class="px-4 py-2 rounded-lg text-sm font-medium bg-blue-100 text-blue-800 transition duration-200">
                            ÂÖ®ÈÉ®
                        </button>
                        <button onclick="filterBillingItems('consultation')" id="billing-filter-consultation" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            Ë®∫ÁôÇË≤ª
                        </button>
                        <button onclick="filterBillingItems('medicine')" id="billing-filter-medicine" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            Ëó•Ë≤ª
                        </button>
                        <button onclick="filterBillingItems('treatment')" id="billing-filter-treatment" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            Ê≤ªÁôÇË≤ª
                        </button>
                        <button onclick="filterBillingItems('other')" id="billing-filter-other" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            ÂÖ∂‰ªñ
                        </button>
                        <button onclick="filterBillingItems('discount')" id="billing-filter-discount" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            ÊäòÊâ£È†ÖÁõÆ
                        </button>
                    </div>
                </div>

                <!-- Êñ∞Â¢û/Á∑®ËºØÊî∂Ë≤ªÈ†ÖÁõÆË°®ÂñÆÂΩàÁ™ó -->
                <div id="addBillingItemModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                            <h3 id="billingItemFormTitle" class="text-xl font-bold text-gray-800">Êñ∞Â¢ûÊî∂Ë≤ªÈ†ÖÁõÆ</h3>
                            <button onclick="hideAddBillingItemForm()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">È†ÖÁõÆÂêçÁ®± *</label>
                                    <input type="text" id="billingItemName" placeholder="Ë´ãËº∏ÂÖ•Êî∂Ë≤ªÈ†ÖÁõÆÂêçÁ®±" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">È†ÖÁõÆÈ°ûÂà• *</label>
                                    <select id="billingItemCategory" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                        <option value="">Ë´ãÈÅ∏ÊìáÈ°ûÂà•</option>
                                        <option value="consultation">Ë®∫ÁôÇË≤ª</option>
                                        <option value="medicine">Ëó•Ë≤ª</option>
                                        <option value="treatment">Ê≤ªÁôÇË≤ª</option>
                                        <option value="other">ÂÖ∂‰ªñ</option>
                                        <option value="discount">ÊäòÊâ£È†ÖÁõÆ</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Êî∂Ë≤ªÈáëÈ°ç *</label>
                                    <input type="number" id="billingItemPrice" placeholder="0" step="1" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">ÊäòÊâ£È†ÖÁõÆÔºöËº∏ÂÖ•0.9Ë°®Á§∫9ÊäòÔºåËº∏ÂÖ•9ÊúÉËá™ÂãïËΩâÁÇ∫9ÊäòÔºåÊàñËº∏ÂÖ•Ë≤†Êï∏Ë°®Á§∫Âõ∫ÂÆöÈáëÈ°çÊäòÊâ£</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Ë®àË≤ªÂñÆ‰Ωç</label>
                                    <input type="text" id="billingItemUnit" placeholder="‰æãÔºöÊ¨°„ÄÅÂäë„ÄÅÂåÖ" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">È†ÖÁõÆË™™Êòé</label>
                                    <textarea id="billingItemDescription" placeholder="Ë´ãÊèèËø∞Êî∂Ë≤ªÈ†ÖÁõÆÁöÑË©≥Á¥∞ÂÖßÂÆπ" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="billingItemActive" checked class="mr-2 rounded">
                                        <span class="text-sm font-medium text-gray-700">ÂïüÁî®Ê≠§Êî∂Ë≤ªÈ†ÖÁõÆ</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-gray-200">
                                <button onclick="hideAddBillingItemForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                                    ÂèñÊ∂à
                                </button>
                                <button onclick="saveBillingItem()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200">
                                    <span id="billingItemSaveButtonText">ÂÑ≤Â≠ò</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Êî∂Ë≤ªÈ†ÖÁõÆÂàóË°® -->
                <div class="overflow-x-auto">
                    <div id="billingItemsList" class="space-y-4">
                        <!-- Êî∂Ë≤ªÈ†ÖÁõÆÂÖßÂÆπÊúÉÂãïÊÖãËºâÂÖ• -->
                    </div>
                </div>
            </div>

            <!-- Ë®∫ÊâÄÁî®Êà∂ÁÆ°ÁêÜ -->
            <div id="userManagement" class="hidden bg-white rounded-xl shadow-lg p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">Ë®∫ÊâÄÁî®Êà∂ÁÆ°ÁêÜ</h2>
                    <div class="flex flex-col md:flex-row gap-3">
                        <div class="relative">
                            <input type="text" id="searchUser" placeholder="ÊêúÂ∞ãÁî®Êà∂ÂêçÁ®±ÊàñÂ∏≥Ëôü..." class="border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:ring-2 focus:ring-green-500 focus:border-transparent w-full md:w-64">
                            <span class="absolute right-3 top-2.5 text-gray-400">üîç</span>
                        </div>
                        <button onclick="showAddUserForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200 whitespace-nowrap">
                            + Êñ∞Â¢ûÁî®Êà∂
                        </button>
                    </div>
                </div>

                <!-- ÁãÄÊÖãÁØ©ÈÅ∏Ê®ôÁ±§ -->
                <div class="mb-6">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterUsers('all')" id="user-filter-all" class="px-4 py-2 rounded-lg text-sm font-medium bg-blue-100 text-blue-800 transition duration-200">
                            ÂÖ®ÈÉ®Áî®Êà∂
                        </button>
                        <button onclick="filterUsers('inactive')" id="user-filter-inactive" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            Â∑≤ÂÅúÁî®
                        </button>
                    </div>
                </div>

                <!-- Êñ∞Â¢û/Á∑®ËºØÁî®Êà∂Ë°®ÂñÆÂΩàÁ™ó -->
                <div id="addUserModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                            <h3 id="userFormTitle" class="text-xl font-bold text-gray-800">Êñ∞Â¢ûÁî®Êà∂</h3>
                            <button onclick="hideAddUserForm()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Â∏≥Ëôü *</label>
                                    <input type="text" id="userName" placeholder="Ë´ãËº∏ÂÖ•ÁôªÂÖ•Â∏≥Ëôü" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">Â∏≥ËôüÂè™ËÉΩÂåÖÂê´Ëã±ÊñáÂ≠óÊØç„ÄÅÊï∏Â≠óÂíåÂ∫ïÁ∑ö</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ÂØÜÁ¢º *</label>
                                    <input type="password" id="userPassword" placeholder="Ë´ãËº∏ÂÖ•ÂØÜÁ¢º" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">ÂØÜÁ¢ºËá≥Â∞ë6ÂÄãÂ≠óÁ¨¶</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ÂßìÂêç *</label>
                                    <input type="text" id="userDisplayName" placeholder="Ë´ãËº∏ÂÖ•ÁúüÂØ¶ÂßìÂêç" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ËÅ∑‰Ωç *</label>
                                    <select id="userPosition" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                        <option value="">Ë´ãÈÅ∏ÊìáËÅ∑‰Ωç</option>
                                        <option value="Ë®∫ÊâÄÁÆ°ÁêÜ">Ë®∫ÊâÄÁÆ°ÁêÜ</option>
                                        <option value="ÈÜ´Â∏´">ÈÜ´Â∏´</option>
                                        <option value="Ë≠∑ÁêÜÂ∏´">Ë≠∑ÁêÜÂ∏´</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ÈõªÂ≠êÈÉµ‰ª∂</label>
                                    <input type="email" id="userEmail" placeholder="Ë´ãËº∏ÂÖ•ÈõªÂ≠êÈÉµ‰ª∂" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ÈõªË©±ËôüÁ¢º</label>
                                    <input type="tel" id="userPhone" placeholder="Ë´ãËº∏ÂÖ•ÈõªË©±ËôüÁ¢º" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="userActive" checked class="mr-2 rounded">
                                        <span class="text-sm font-medium text-gray-700">ÂïüÁî®Ê≠§Áî®Êà∂Â∏≥Ëôü</span>
                                    </label>
                                    <p class="text-xs text-gray-500 mt-1">ÂÅúÁî®ÁöÑÂ∏≥ËôüÂ∞áÁÑ°Ê≥ïÁôªÂÖ•Á≥ªÁµ±</p>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-gray-200">
                                <button onclick="hideAddUserForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                                    ÂèñÊ∂à
                                </button>
                                <button onclick="saveUser()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200">
                                    <span id="userSaveButtonText">ÂÑ≤Â≠ò</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Áî®Êà∂ÂàóË°® -->
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Â∏≥Ëôü</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ÂßìÂêç</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ËÅ∑‰Ωç</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ÈõªÂ≠êÈÉµ‰ª∂</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ÁãÄÊÖã</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ÊúÄÂæåÁôªÂÖ•</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody id="userList" class="divide-y divide-gray-200">
                            <!-- Áî®Êà∂Ë≥áÊñôÊúÉÂãïÊÖãËºâÂÖ• -->
                        </tbody>
                    </table>
                </div>
            </div>



            <!-- Á≥ªÁµ±ÁÆ°ÁêÜ -->
            <div id="systemManagement" class="hidden bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Á≥ªÁµ±ÁÆ°ÁêÜ</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">Ë®∫ÊâÄÁµ±Ë®à</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span>Á∏ΩÁóÖ‰∫∫Êï∏Ôºö</span>
                                <span id="totalPatients" class="font-semibold">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>‰ªäÊó•Ë®∫ÁóáÔºö</span>
                                <span id="todayConsultations" class="font-semibold">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Êú¨ÊúàË®∫ÁóáÔºö</span>
                                <span id="monthlyConsultations" class="font-semibold">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">Ë®∫ÊâÄË®≠ÂÆö</h3>
                        <div class="space-y-3">
                            <div class="text-center py-4" id="clinicSettingsDisplay">
                                <div class="text-sm text-gray-700 mb-3">
                                    <div class="font-medium">Ë®∫ÊâÄ‰∏≠ÊñáÂêçÁ®±Ôºö<span id="displayChineseName">‰∏≠ÈÜ´Ë®∫ÊâÄ</span></div>
                                    <div class="text-gray-600 mt-1">Ë®∫ÊâÄËã±ÊñáÂêçÁ®±Ôºö<span id="displayEnglishName">Traditional Chinese Medicine Clinic</span></div>
                                </div>
                                <button onclick="showClinicSettingsModal()" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                    Ë®∫ÊâÄË≥áÊñô‰øÆÊîπ
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">Ë≥áÊñôÁÆ°ÁêÜ</h3>
                        <div class="space-y-3">
                            <button onclick="exportData()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                ÂåØÂá∫Ë≥áÊñô
                            </button>
                            <button onclick="backupData()" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                ÂÇô‰ªΩË≥áÊñô
                            </button>
                            <button onclick="clearData()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                Ê∏ÖÈô§Ë≥áÊñô
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ë®∫ÊâÄË≥áÊñô‰øÆÊîπÂΩàÁ™ó -->
    <div id="clinicSettingsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                <h3 class="text-xl font-bold text-gray-800">Ë®∫ÊâÄË≥áÊñô‰øÆÊîπ</h3>
                <button onclick="hideClinicSettingsModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
            </div>
            
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ë®∫ÊâÄ‰∏≠ÊñáÂêçÁ®± *</label>
                        <input type="text" id="clinicChineseName" placeholder="Ë´ãËº∏ÂÖ•Ë®∫ÊâÄ‰∏≠ÊñáÂêçÁ®±" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ë®∫ÊâÄËã±ÊñáÂêçÁ®±</label>
                        <input type="text" id="clinicEnglishName" placeholder="Ë´ãËº∏ÂÖ•Ë®∫ÊâÄËã±ÊñáÂêçÁ®±" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ë®∫ÊâÄÁáüÊ•≠ÊôÇÈñì</label>
                        <input type="text" id="clinicBusinessHours" placeholder="‰æãÔºöÈÄ±‰∏ÄËá≥ÈÄ±‰∫î 09:00-18:00" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ë®∫ÊâÄÈõªË©±</label>
                        <input type="tel" id="clinicPhone" placeholder="Ë´ãËº∏ÂÖ•Ë®∫ÊâÄÈõªË©±ËôüÁ¢º" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ë®∫ÊâÄÂú∞ÂùÄ</label>
                        <textarea id="clinicAddress" placeholder="Ë´ãËº∏ÂÖ•Ë®∫ÊâÄÂÆåÊï¥Âú∞ÂùÄ" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-gray-200">
                    <button onclick="hideClinicSettingsModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                        ÂèñÊ∂à
                    </button>
                    <button onclick="saveClinicSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition duration-200">
                        ÂÑ≤Â≠ò
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Á≥ªÁµ±Ë≥áÊñôÂÑ≤Â≠ò
        let currentUser = null;
        let currentUserData = null;
        
        // Ë®∫ÊâÄË®≠ÂÆö
        let clinicSettings = JSON.parse(localStorage.getItem('clinicSettings') || '{}');
        if (!clinicSettings.chineseName) {
            clinicSettings.chineseName = '‰∏≠ÈÜ´Ë®∫ÊâÄ';
            clinicSettings.englishName = 'Traditional Chinese Medicine Clinic';
            clinicSettings.businessHours = 'ÈÄ±‰∏ÄËá≥ÈÄ±‰∫î 09:00-18:00';
            clinicSettings.phone = '(852) 2345-6789';
            clinicSettings.address = 'È¶ôÊ∏Ø‰∏≠Áí∞ÁöáÂêéÂ§ßÈÅì‰∏≠123Ëôü';
            localStorage.setItem('clinicSettings', JSON.stringify(clinicSettings));
        }
        
        // ÊµÆÂãïÊèêÁ§∫ÂäüËÉΩ
        function showToast(message, type = 'info') {
            // ÁßªÈô§ÁèæÊúâÁöÑÊèêÁ§∫
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // ÂâµÂª∫Êñ∞ÁöÑÊèêÁ§∫
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            // Ë®≠ÁΩÆÂúñÊ®ô
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-content">${message}</div>
            `;
            
            // Ê∑ªÂä†Âà∞È†ÅÈù¢
            document.body.appendChild(toast);
            
            // È°ØÁ§∫ÂãïÁï´
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // 2ÁßíÂæåÊ∑°Âá∫‰∏¶ÁßªÈô§
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 2000);
        }
        
        // Ë®àÁÆóÂπ¥ÈΩ°ÂáΩÊï∏
        function calculateAge(birthDate) {
            const birth = new Date(birthDate);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            
            return age;
        }
        
        // Ê†ºÂºèÂåñÂπ¥ÈΩ°È°ØÁ§∫
        function formatAge(birthDate) {
            if (!birthDate) return 'Êú™Áü•';
            
            const birth = new Date(birthDate);
            const today = new Date();
            
            let years = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                years--;
            }
            
            if (years > 0) {
                return `${years}Ê≠≤`;
            } else {
                // Êú™Êªø‰∏ÄÊ≠≤ÁöÑÂ¨∞ÂπºÂÖíÈ°ØÁ§∫ÊúàÊï∏
                let months = today.getMonth() - birth.getMonth();
                let days = today.getDate() - birth.getDate();
                
                if (days < 0) {
                    months--;
                    const lastMonth = new Date(today.getFullYear(), today.getMonth(), 0);
                    days += lastMonth.getDate();
                }
                
                if (months < 0) {
                    months += 12;
                }
                
                if (months > 0) {
                    return `${months}ÂÄãÊúà`;
                } else {
                    return `${days}Â§©`;
                }
            }
        }
        
        // ÁîüÊàêÁóÖ‰∫∫Á∑®ËôüÂáΩÊï∏
        function generatePatientNumber() {
            const existingNumbers = patients
                .map(p => p.patientNumber)
                .filter(num => num && num.startsWith('P'))
                .map(num => parseInt(num.substring(1)))
                .filter(num => !isNaN(num));
            
            const maxNumber = existingNumbers.length > 0 ? Math.max(...existingNumbers) : 0;
            const newNumber = maxNumber + 1;
            return `P${newNumber.toString().padStart(6, '0')}`;
        }

        // È†êË®≠Ê∏¨Ë©¶ÁóÖ‰∫∫Ë≥áÊñô
        const defaultPatients = [
            {
                id: 1001,
                patientNumber: 'P000001',
                name: 'ÁéãÂ∞èÊòé',
                gender: 'Áî∑',
                phone: '0912-345-678',
                birthDate: '1989-03-15',
                address: 'Âè∞ÂåóÂ∏ÇÂ§ßÂÆâÂçÄ‰ø°Áæ©Ë∑ØÂõõÊÆµ123Ëôü',
                history: 'È´òË°ÄÂ£ìÁóÖÂè≤3Âπ¥ÔºåÂÅ∂ÊúâÈ†≠ÊöàÁóáÁãÄ',
                createdAt: new Date('2024-01-15').toISOString()
            },
            {
                id: 1002,
                patientNumber: 'P000002',
                name: 'ÊùéÁæéËèØ',
                gender: 'Â•≥',
                phone: '0923-456-789',
                birthDate: '1996-07-22',
                address: 'Êñ∞ÂåóÂ∏ÇÊùøÊ©ãÂçÄ‰∏≠Â±±Ë∑Ø‰∫åÊÆµ456Ëôü',
                history: 'Á∂ìÂ∏∏ÊÄßÂ§±Áú†ÔºåÂ∑•‰ΩúÂ£ìÂäõÂ§ß',
                createdAt: new Date('2024-01-20').toISOString()
            },
            {
                id: 1003,
                patientNumber: 'P000003',
                name: 'ÂºµÂøóÂº∑',
                gender: 'Áî∑',
                phone: '0934-567-890',
                birthDate: '1982-11-08',
                address: 'Ê°ÉÂúíÂ∏Ç‰∏≠Â£¢ÂçÄ‰∏≠Ê≠£Ë∑Ø789Ëôü',
                history: 'ÊÖ¢ÊÄßËÉÉÁÇéÔºåÈ£≤È£ü‰∏çË¶èÂæã',
                createdAt: new Date('2024-02-01').toISOString()
            },
            {
                id: 1004,
                patientNumber: 'P000004',
                name: 'Èô≥ÈõÖÂ©∑',
                gender: 'Â•≥',
                phone: '0945-678-901',
                birthDate: '1993-05-12',
                address: 'Âè∞‰∏≠Â∏ÇË•øÂ±ØÂçÄÂè∞ÁÅ£Â§ßÈÅì‰∏âÊÆµ321Ëôü',
                history: 'ÊúàÁ∂ì‰∏çË™øÔºåÁ∂ìÂ∏∏ËÖ∞ÈÖ∏ËÉåÁóõ',
                createdAt: new Date('2024-02-10').toISOString()
            },
            {
                id: 1005,
                patientNumber: 'P000005',
                name: 'ÊûóÂ§ßÂÅâ',
                gender: 'Áî∑',
                phone: '0956-789-012',
                birthDate: '1969-12-03',
                address: 'È´òÈõÑÂ∏ÇÂâçÈáëÂçÄ‰∏≠Ê≠£ÂõõË∑Ø654Ëôü',
                history: 'Á≥ñÂ∞øÁóÖÊÇ£ËÄÖÔºåÈúÄÂÆöÊúüËøΩËπ§Ë°ÄÁ≥ñ',
                createdAt: new Date('2024-02-15').toISOString()
            }
        ];

        // ÂàùÂßãÂåñÁóÖ‰∫∫Ë≥áÊñôÔºàÂ¶ÇÊûúÊú¨Âú∞ÂÑ≤Â≠òÁÇ∫Á©∫ÂâáËºâÂÖ•È†êË®≠Ë≥áÊñôÔºâ
        let patients = JSON.parse(localStorage.getItem('patients') || '[]');
        if (patients.length === 0) {
            patients = defaultPatients;
            localStorage.setItem('patients', JSON.stringify(patients));
        } else {
            // ÁÇ∫ËàäË≥áÊñôË£úÂÖÖÁóÖ‰∫∫Á∑®Ëôü
            let needsUpdate = false;
            patients.forEach(patient => {
                if (!patient.patientNumber) {
                    patient.patientNumber = generatePatientNumber();
                    needsUpdate = true;
                }
            });
            if (needsUpdate) {
                localStorage.setItem('patients', JSON.stringify(patients));
            }
        }
        
        // È†êË®≠Ë®∫ÁóáË®òÈåÑ
        const defaultConsultations = [
            {
                id: 2001,
                appointmentId: 3001,
                patientId: 1001,
                symptoms: 'È†≠ÁóõÈ†≠ÊöàÔºåË°ÄÂ£ìÂÅèÈ´òÔºå‰º¥ÊúâÂøÉÊÇ∏ÔºåÁù°Áú†ÂìÅË≥™‰∏ç‰Ω≥',
                tongue: 'ËàåË≥™Á¥ÖÔºåËãîËñÑÈªÉ',
                pulse: 'ËÑàÂº¶Êï∏',
                currentHistory: 'ÊÇ£ËÄÖ3Âπ¥ÂâçË®∫Êñ∑È´òË°ÄÂ£ìÔºåÂπ≥ÊôÇË°ÄÂ£ìÊéßÂà∂‰∏çÁ©©ÂÆöÔºåËøëÊúüÂ∑•‰ΩúÂ£ìÂäõÂ§ßÔºåÈ†≠ÁóõÁóáÁãÄÂä†Èáç',
                diagnosis: 'Áú©ÊöàÔºàÈ´òË°ÄÂ£ìÁóÖÔºâ',
                syndrome: 'ËÇùÈôΩ‰∏ä‰∫¢Ë≠â',
                prescription: 'Â§©È∫ªÈâ§Ëó§È£≤Âä†Ê∏õ\nÂ§©È∫ª 10g\nÈâ§Ëó§ 15g\nÁü≥Ê±∫Êòé 30g\nÊ¢îÂ≠ê 10g\nÈªÉËä© 10g\nÂ∑ùÁâõËÜù 15g\nÊùú‰ª≤ 15g\nÁõäÊØçËçâ 15g\nÂ§ú‰∫§Ëó§ 20g\nËåØÁ•û 15g',
                usage: 'Ê∞¥ÁÖéÊúçÔºåÊØèÊó•‰∏ÄÂäëÔºåÂàÜÊó©ÊôöÂÖ©Ê¨°Ê∫´Êúç',
                treatmentCourse: '7Â§©',
                instructions: 'Ê≥®ÊÑè‰ºëÊÅØÔºåÈÅøÂÖçÊÉÖÁ∑íÊøÄÂãïÔºåÂÆöÊúüÁõ£Ê∏¨Ë°ÄÂ£ìÔºåÈ£≤È£üÊ∏ÖÊ∑°Â∞ëÈπΩ',
                followUpDate: '2024-03-01T09:00',
                date: new Date('2024-02-23T10:30').toISOString(),
                doctor: 'doctor',
                status: 'completed'
            },
            {
                id: 2002,
                appointmentId: 3002,
                patientId: 1002,
                symptoms: 'Â§±Áú†Â§öÂ§¢ÔºåÂÖ•Áù°Âõ∞Èõ£ÔºåÊòìÈÜíÔºå‰º¥ÊúâÂøÉÁÖ©ÔºåÂ∑•‰ΩúÂ£ìÂäõÂ§ß',
                tongue: 'ËàåË≥™Ê∑°Á¥ÖÔºåËãîËñÑÁôΩ',
                pulse: 'ËÑàÁ¥∞Êï∏',
                currentHistory: 'ÊÇ£ËÄÖËøëÂçäÂπ¥‰æÜÂ∑•‰ΩúÂ£ìÂäõÂ¢ûÂ§ßÔºåÁù°Áú†ÂìÅË≥™ÈÄêÊº∏‰∏ãÈôçÔºåÊØèÊôöÈúÄ1-2Â∞èÊôÇÊâçËÉΩÂÖ•Áù°',
                diagnosis: '‰∏çÂØêÔºàÂ§±Áú†ÁóáÔºâ',
                syndrome: 'ÂøÉËÖé‰∏ç‰∫§Ë≠â',
                prescription: 'ÁîòÈ∫•Â§ßÊ£óÊπØÂêà‰∫§Ê≥∞‰∏∏Âä†Ê∏õ\nÁîòËçâ 6g\nÂ∞èÈ∫• 30g\nÂ§ßÊ£ó 10Êûö\nÈªÉÈÄ£ 3g\nËÇâÊ°Ç 1g\nÈÖ∏Ê£ó‰ªÅ 20g\nÈæçÈ™® 15g\nÁâ°Ë†£ 15g\nÈÅ†Âøó 10g\nËåØÁ•û 15g',
                usage: 'Ê∞¥ÁÖéÊúçÔºåÊØèÊó•‰∏ÄÂäëÔºåÊôöÈ§êÂæåÂèäÁù°ÂâçÂêÑÊúç‰∏ÄÊ¨°',
                treatmentCourse: '10Â§©',
                instructions: 'Áù°ÂâçÈÅøÂÖç‰ΩøÁî®ÈõªÂ≠êÁî¢ÂìÅÔºå‰øùÊåÅË¶èÂæã‰ΩúÊÅØÔºåÂèØÈÅ©Áï∂ÈÄ≤Ë°åÊîæÈ¨ÜÈÅãÂãï',
                followUpDate: '2024-03-05T14:00',
                date: new Date('2024-02-25T14:15').toISOString(),
                doctor: 'doctor',
                status: 'completed'
            },
            {
                id: 2003,
                appointmentId: 3003,
                patientId: 1003,
                symptoms: 'ËÉÉËÑòËÑπÁóõÔºåÈ£üÂæåÂä†ÈáçÔºåÂôØÊ∞£È†ªÁπÅÔºåÈ£üÊÖæ‰∏çÊåØ',
                tongue: 'ËàåË≥™Ê∑°ÔºåËãîÁôΩËÜ©',
                pulse: 'ËÑàÂº¶Êªë',
                currentHistory: 'ÊÇ£ËÄÖÊúâÊÖ¢ÊÄßËÉÉÁÇéÁóÖÂè≤ÔºåÂπ≥ÊôÇÈ£≤È£ü‰∏çË¶èÂæãÔºåÂ∏∏ÊúâËÉÉËÑò‰∏çÈÅ©ÔºåËøëÊúüÁóáÁãÄÂä†Èáç',
                diagnosis: 'ËÉÉÁóõÔºàÊÖ¢ÊÄßËÉÉÁÇéÔºâ',
                syndrome: 'ËÑæËÉÉËôõÂº±ÔºåÊøïÊªØ‰∏≠ÁÑ¶Ë≠â',
                prescription: 'È¶ôÁ†ÇÂÖ≠ÂêõÂ≠êÊπØÂä†Ê∏õ\nÈª®ÂèÉ 15g\nÁôΩÊúÆ 10g\nËåØËãì 15g\nÁîòËçâ 6g\nÈô≥ÁöÆ 10g\nÂçäÂ§è 10g\nÊú®È¶ô 6g\nÁ†Ç‰ªÅ 6g\nÊû≥ÊÆº 10g\nÁ•ûÈ∫¥ 15g',
                usage: 'Ê∞¥ÁÖéÊúçÔºåÊØèÊó•‰∏ÄÂäëÔºåÈ£ØÂâç30ÂàÜÈêòÊ∫´Êúç',
                treatmentCourse: '14Â§©',
                instructions: 'Ë¶èÂæãÈ£≤È£üÔºåÁ¥∞ÂöºÊÖ¢Âö•ÔºåÈÅøÂÖçÁîüÂÜ∑ËæõËæ£È£üÁâ©Ôºå‰øùÊåÅÂøÉÊÉÖÊÑâÂø´',
                followUpDate: '2024-03-10T10:30',
                date: new Date('2024-02-26T10:45').toISOString(),
                doctor: 'doctor',
                status: 'completed'
            }
        ];

        let consultations = JSON.parse(localStorage.getItem('consultations') || '[]');
        if (consultations.length === 0) {
            consultations = defaultConsultations;
            localStorage.setItem('consultations', JSON.stringify(consultations));
        }
        
        let appointments = JSON.parse(localStorage.getItem('appointments') || '[]');

        // È†êË®≠‰∏≠Ëó•ÊùêË≥áÊñô
        const defaultHerbs = [
            {
                id: 5001,
                type: 'herb',
                name: '‰∫∫ÂèÉ',
                alias: 'Á¥ÖÂèÉ„ÄÅÁôΩÂèÉ',
                nature: 'Áîò„ÄÅÂæÆËã¶ÔºåÂæÆÊ∫´',
                meridian: 'ËÑæ„ÄÅËÇ∫„ÄÅÂøÉÁ∂ì',
                effects: 'Â§ßË£úÂÖÉÊ∞£ÔºåÂæ©ËÑàÂõ∫ËÑ´ÔºåË£úËÑæÁõäËÇ∫ÔºåÁîüÊ¥•ÂÆâÁ•û',
                indications: 'È´îËôõÊ¨≤ËÑ´ÔºåËÇ¢ÂÜ∑ËÑàÂæÆÔºåËÑæËôõÈ£üÂ∞ëÔºåËÇ∫ËôõÂñòÂí≥ÔºåÊ¥•ÂÇ∑Âè£Ê∏¥ÔºåÂÖßÁÜ±Ê∂àÊ∏¥Ôºå‰πÖÁóÖËôõÁæ∏ÔºåÈ©öÊÇ∏Â§±Áú†ÔºåÈôΩÁóøÂÆÆÂÜ∑',
                dosage: '3-9g',
                cautions: '‰∏çÂÆúËàáËóúËòÜÂêåÁî®',
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 5002,
                type: 'herb',
                name: 'ÁôΩÊúÆ',
                alias: 'ÊñºÊúÆ„ÄÅÂÜ¨ÊúÆ',
                nature: 'Áîò„ÄÅËã¶ÔºåÊ∫´',
                meridian: 'ËÑæ„ÄÅËÉÉÁ∂ì',
                effects: 'ÂÅ•ËÑæÁõäÊ∞£ÔºåÁá•ÊøïÂà©Ê∞¥ÔºåÊ≠¢Ê±óÔºåÂÆâËÉé',
                indications: 'ËÑæËôõÈ£üÂ∞ëÔºåËÖπËÑπÊ≥ÑÁÄâÔºåÁó∞È£≤Áú©ÊÇ∏ÔºåÊ∞¥ËÖ´ÔºåËá™Ê±óÔºåËÉéÂãï‰∏çÂÆâ',
                dosage: '6-12g',
                cautions: 'Èô∞ËôõÁá•Ê∏¥ÔºåÊ∞£ÊªØËÑπÊÇ∂ËÄÖÂøåÊúç',
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 5003,
                type: 'herb',
                name: 'ËåØËãì',
                alias: 'ÁôΩËåØËãì„ÄÅÈõ≤Ëãì',
                nature: 'Áîò„ÄÅÊ∑°ÔºåÂπ≥',
                meridian: 'ÂøÉ„ÄÅËÇ∫„ÄÅËÑæ„ÄÅËÖéÁ∂ì',
                effects: 'Âà©Ê∞¥Êª≤ÊøïÔºåÂÅ•ËÑæÔºåÂØßÂøÉ',
                indications: 'Ê∞¥ËÖ´Â∞øÂ∞ëÔºåÁó∞È£≤Áú©ÊÇ∏ÔºåËÑæËôõÈ£üÂ∞ëÔºå‰æøÊ∫èÊ≥ÑÁÄâÔºåÂøÉÁ•û‰∏çÂÆâÔºåÈ©öÊÇ∏Â§±Áú†',
                dosage: '10-15g',
                cautions: 'ËôõÂØíÁ≤æÊªëÊàñÊ∞£Ëôõ‰∏ãÈô∑ËÄÖÂøåÊúç',
                createdAt: new Date('2024-01-01').toISOString()
            }
        ];

        // È†êË®≠ÊñπÂäëË≥áÊñô
        const defaultFormulas = [
            {
                id: 6001,
                type: 'formula',
                name: 'ÂõõÂêõÂ≠êÊπØ',
                source: 'Â§™Âπ≥ÊÉ†Ê∞ëÂíåÂäëÂ±ÄÊñπ',
                effects: 'ÁõäÊ∞£ÂÅ•ËÑæ',
                indications: 'ËÑæËÉÉÊ∞£ËôõÔºåÈù¢Ëâ≤ËêéÁôΩÔºåË™ûËÅ≤‰ΩéÂæÆÔºåÊ∞£Áü≠‰πèÂäõÔºåÈ£üÂ∞ë‰æøÊ∫èÔºåËàåÊ∑°ËãîÁôΩÔºåËÑàËôõÂº±',
                composition: '‰∫∫ÂèÉ 9g\nÁôΩÊúÆ 9g\nËåØËãì 9g\nÁîòËçâ 6g',
                usage: 'Ê∞¥ÁÖéÊúçÔºåÊØèÊó•‰∏ÄÂäëÔºåÂàÜ‰∫åÊ¨°Ê∫´Êúç',
                cautions: 'Èô∞ËôõÁÅ´Êó∫ËÄÖÊÖéÁî®',
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 6002,
                type: 'formula',
                name: 'ÂÖ≠ÂêõÂ≠êÊπØ',
                source: 'ÈÜ´Â≠∏Ê≠£ÂÇ≥',
                effects: 'ÁõäÊ∞£ÂÅ•ËÑæÔºåÁá•ÊøïÂåñÁó∞',
                indications: 'ËÑæËÉÉÊ∞£ËôõÂÖºÊúâÁó∞ÊøïÔºåÈ£üÂ∞ë‰æøÊ∫èÔºåËÉ∏ËÑòÁóûÊÇ∂ÔºåÂòîÈÄÜÁ≠âÁóá',
                composition: '‰∫∫ÂèÉ 9g\nÁôΩÊúÆ 9g\nËåØËãì 9g\nÁîòËçâ 6g\nÈô≥ÁöÆ 6g\nÂçäÂ§è 6g',
                usage: 'Ê∞¥ÁÖéÊúçÔºåÊØèÊó•‰∏ÄÂäëÔºåÂàÜ‰∫åÊ¨°Ê∫´Êúç',
                cautions: 'Èô∞ËôõÁá•Âí≥„ÄÅÊ¥•Ê∂≤‰∏çË∂≥ËÄÖÂøåÁî®',
                createdAt: new Date('2024-01-01').toISOString()
            }
        ];

        // ÂàùÂßãÂåñ‰∏≠Ëó•Â∫´Ë≥áÊñô
        let herbLibrary = JSON.parse(localStorage.getItem('herbLibrary') || '[]');
        if (herbLibrary.length === 0) {
            herbLibrary = [...defaultHerbs, ...defaultFormulas];
            localStorage.setItem('herbLibrary', JSON.stringify(herbLibrary));
        }

        // È†êË®≠Êî∂Ë≤ªÈ†ÖÁõÆË≥áÊñô
        const defaultBillingItems = [
            // Ë®∫ÁôÇË≤ªÈ°ûÂà•
            {
                id: 4001,
                name: 'Ë®∫Èáë',
                category: 'consultation',
                price: 150,
                unit: 'Ê¨°',
                description: '‰∏≠ÈÜ´Â∏´Ë®∫ÁóáË≤ªÁî®',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4002,
                name: 'Ë§áË®∫Ë≤ª',
                category: 'consultation',
                price: 120,
                unit: 'Ê¨°',
                description: 'Ë§áË®∫ÁóÖ‰∫∫Ë®∫ÁóáË≤ªÁî®',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4003,
                name: 'ÊÄ•Ë®∫Ë≤ª',
                category: 'consultation',
                price: 200,
                unit: 'Ê¨°',
                description: 'ÊÄ•Ë®∫ÊàñÈùûËæ¶ÂÖ¨ÊôÇÈñìË®∫Áóá',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            
            // Ëó•Ë≤ªÈ°ûÂà•
            {
                id: 4011,
                name: '‰∏≠Ëó•Ë™øÂäëË≤ª',
                category: 'medicine',
                price: 25,
                unit: 'Âäë',
                description: '‰∏≠Ëó•ÊùêË™øÂäëÂèäÂåÖË£ùË≤ªÁî®',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4012,
                name: 'ÊøÉÁ∏Æ‰∏≠Ëó•Á≤â',
                category: 'medicine',
                price: 15,
                unit: 'ÂåÖ',
                description: 'ÁßëÂ≠∏‰∏≠Ëó•ÊøÉÁ∏ÆÁ≤âÂäë',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4013,
                name: 'Â§ñÁî®Ëó•ËÜè',
                category: 'medicine',
                price: 80,
                unit: 'ÊîØ',
                description: '‰∏≠Ëó•Â§ñÁî®Ëó•ËÜè',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4014,
                name: 'Ëó•ÈÖí',
                category: 'medicine',
                price: 120,
                unit: 'Áì∂',
                description: '‰∏≠Ëó•Êµ∏Ë£ΩËó•ÈÖí',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            
            // Ê≤ªÁôÇË≤ªÈ°ûÂà•
            {
                id: 4021,
                name: 'ÈáùÁÅ∏Ê≤ªÁôÇ',
                category: 'treatment',
                price: 100,
                unit: 'Ê¨°',
                description: 'ÈáùÁÅ∏Á©¥‰ΩçÊ≤ªÁôÇ',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4022,
                name: 'Êé®ÊãøÊåâÊë©',
                category: 'treatment',
                price: 150,
                unit: 'Ê¨°',
                description: '‰∏≠ÈÜ´Êé®ÊãøÊåâÊë©Ê≤ªÁôÇ',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4023,
                name: 'ÊãîÁΩêÊ≤ªÁôÇ',
                category: 'treatment',
                price: 80,
                unit: 'Ê¨°',
                description: 'ÊãîÁΩêÁôÇÊ≥ï',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4024,
                name: 'ÂàÆÁóßÊ≤ªÁôÇ',
                category: 'treatment',
                price: 60,
                unit: 'Ê¨°',
                description: 'ÂàÆÁóßÁôÇÊ≥ï',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4025,
                name: 'ËâæÁÅ∏Ê≤ªÁôÇ',
                category: 'treatment',
                price: 90,
                unit: 'Ê¨°',
                description: 'ËâæÊ¢ùÁÅ∏Ê≥ïÊ≤ªÁôÇ',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4026,
                name: 'ÈõªÈáùÊ≤ªÁôÇ',
                category: 'treatment',
                price: 120,
                unit: 'Ê¨°',
                description: 'ÈõªÈáùÂà∫ÊøÄÊ≤ªÁôÇ',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4027,
                name: 'ËÄ≥ÈáùÊ≤ªÁôÇ',
                category: 'treatment',
                price: 70,
                unit: 'Ê¨°',
                description: 'ËÄ≥Á©¥ÈáùÂà∫Ê≤ªÁôÇ',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4028,
                name: 'Â∞èÂÖíÊé®Êãø',
                category: 'treatment',
                price: 100,
                unit: 'Ê¨°',
                description: 'Â∞èÂÖíÊé®ÊãøÊåâÊë©',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            
            // ÂÖ∂‰ªñÈ°ûÂà•
            {
                id: 4031,
                name: 'Ë®∫Êñ∑Êõ∏',
                category: 'other',
                price: 50,
                unit: '‰ªΩ',
                description: '‰∏≠ÈÜ´Ë®∫Êñ∑Ë≠âÊòéÊõ∏',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4032,
                name: 'ÁóÖÂÅáË≠âÊòé',
                category: 'other',
                price: 30,
                unit: '‰ªΩ',
                description: 'ÁóÖÂÅáË≠âÊòéÊõ∏',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4033,
                name: 'È´îË≥™Ë™øÁêÜË´ÆË©¢',
                category: 'other',
                price: 200,
                unit: 'Ê¨°',
                description: 'ÂÄã‰∫∫È´îË≥™ÂàÜÊûêÂèäË™øÁêÜÂª∫Ë≠∞',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4034,
                name: 'È£≤È£üÊåáÂ∞é',
                category: 'other',
                price: 80,
                unit: 'Ê¨°',
                description: '‰∏≠ÈÜ´È£≤È£üÁôÇÊ≥ïÊåáÂ∞é',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4035,
                name: 'È§äÁîü‰øùÂÅ•Ë´ÆË©¢',
                category: 'other',
                price: 120,
                unit: 'Ê¨°',
                description: '‰∏≠ÈÜ´È§äÁîü‰øùÂÅ•ÊåáÂ∞é',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            
            // ÊäòÊâ£È†ÖÁõÆÈ°ûÂà•
            {
                id: 4041,
                name: 'Èï∑ËÄÖÂÑ™ÊÉ†',
                category: 'discount',
                price: 0.9, // 9Êäò
                unit: '',
                description: '65Ê≠≤‰ª•‰∏äÈï∑ËÄÖ9ÊäòÂÑ™ÊÉ†',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4042,
                name: 'Â≠∏ÁîüÂÑ™ÊÉ†',
                category: 'discount',
                price: 0.85, // 85Êäò
                unit: '',
                description: 'Â≠∏ÁîüÊÜëË≠â85ÊäòÂÑ™ÊÉ†',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4043,
                name: 'ÊúÉÂì°ÂÑ™ÊÉ†',
                category: 'discount',
                price: 0.95, // 95Êäò
                unit: '',
                description: 'Ë®∫ÊâÄÊúÉÂì°95ÊäòÂÑ™ÊÉ†',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4044,
                name: 'ÁôÇÁ®ãÂ•óÈ§êÊäòÊâ£',
                category: 'discount',
                price: 0.8, // 8Êäò
                unit: '',
                description: 'Ë≥ºË≤∑ÁôÇÁ®ãÂ•óÈ§ê8ÊäòÂÑ™ÊÉ†',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4045,
                name: 'ÂàùË®∫ÂÑ™ÊÉ†',
                category: 'discount',
                price: -50, // Âõ∫ÂÆöÊ∏õ50ÂÖÉ
                unit: '',
                description: 'È¶ñÊ¨°Â∞±Ë®∫Ê∏õÂÖç50ÂÖÉ',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4046,
                name: 'Ë§áË®∫ÂÑ™ÊÉ†Âà∏',
                category: 'discount',
                price: -30, // Âõ∫ÂÆöÊ∏õ30ÂÖÉ
                unit: '',
                description: 'Ë§áË®∫ÂÑ™ÊÉ†Âà∏Ê∏õÂÖç30ÂÖÉ',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4047,
                name: 'ÂÆ∂Â∫≠Â•óÈ§êÊäòÊâ£',
                category: 'discount',
                price: 0.75, // 75Êäò
                unit: '',
                description: 'ÂÆ∂Â∫≠ÊàêÂì°ÂêåÊôÇÂ∞±Ë®∫75Êäò',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4048,
                name: 'ÁØÄÊó•ÁâπÊÉ†',
                category: 'discount',
                price: 0.88, // 88Êäò
                unit: '',
                description: 'ÁØÄÊó•ÊúüÈñìÁâπÂà•ÂÑ™ÊÉ†88Êäò',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            }
        ];

        // ÂàùÂßãÂåñÊî∂Ë≤ªÈ†ÖÁõÆË≥áÊñô
        let billingItems = JSON.parse(localStorage.getItem('billingItems') || '[]');
        if (billingItems.length === 0) {
            billingItems = defaultBillingItems;
            localStorage.setItem('billingItems', JSON.stringify(billingItems));
        }

        // È†êË®≠Áî®Êà∂Ë≥áÊñô
        const defaultUsers = [
            {
                id: 1,
                username: 'manager',
                password: 'manager2024',
                name: 'Èô≥Á∂ìÁêÜ',
                position: 'Ë®∫ÊâÄÁÆ°ÁêÜ',
                email: 'manager@tcmclinic.com',
                phone: '02-8888-1001',
                active: true,
                createdAt: new Date('2024-01-01').toISOString(),
                lastLogin: null
            },
            {
                id: 2,
                username: 'drzhang',
                password: 'zhang888',
                name: 'Âºµ‰∏≠ÈÜ´Â∏´',
                position: 'ÈÜ´Â∏´',
                email: 'drzhang@tcmclinic.com',
                phone: '02-8888-1002',
                active: true,
                createdAt: new Date('2024-01-01').toISOString(),
                lastLogin: null
            },
            {
                id: 3,
                username: 'nurse_amy',
                password: 'amy2024',
                name: 'ÊûóË≠∑ÁêÜÂ∏´',
                position: 'Ë≠∑ÁêÜÂ∏´',
                email: 'amy@tcmclinic.com',
                phone: '02-8888-1003',
                active: true,
                createdAt: new Date('2024-01-01').toISOString(),
                lastLogin: null
            }
        ];

        // ÂàùÂßãÂåñÁî®Êà∂Ë≥áÊñô
        let users = JSON.parse(localStorage.getItem('users') || '[]');
        if (users.length === 0) {
            users = defaultUsers;
            localStorage.setItem('users', JSON.stringify(users));
        }

        // ÊâÄÊúâÁî®Êà∂ÈÉΩÊúâÂÆåÊï¥Ê¨äÈôê
        const allPermissions = ['patientManagement', 'consultationSystem', 'herbLibrary', 'billingManagement', 'userManagement', 'systemManagement'];

        // ‰∏ªË¶ÅÁôªÂÖ•ÂäüËÉΩ
        function attemptMainLogin() {
            const username = document.getElementById('mainLoginUsername').value.trim();
            const password = document.getElementById('mainLoginPassword').value.trim();
            
            if (!username || !password) {
                showToast('Ë´ãËº∏ÂÖ•Â∏≥ËôüÂíåÂØÜÁ¢ºÔºÅ', 'error');
                return;
            }
            
            // Â∞ãÊâæÂåπÈÖçÁöÑÁî®Êà∂
            const user = users.find(u => 
                u.username === username && 
                u.password === password && 
                u.active
            );
            
            if (!user) {
                // Ê™¢Êü•ÊòØÂê¶Â∏≥ËôüÂ≠òÂú®‰ΩÜÂØÜÁ¢ºÈåØË™§
                const existingUser = users.find(u => u.username === username);
                if (existingUser) {
                    if (!existingUser.active) {
                        showToast('Ê≠§Â∏≥ËôüÂ∑≤Ë¢´ÂÅúÁî®ÔºåË´ãËÅØÁπ´ÁÆ°ÁêÜÂì°ÔºÅ', 'error');
                    } else {
                        showToast('ÂØÜÁ¢ºÈåØË™§ÔºåË´ãÈáçÊñ∞Ëº∏ÂÖ•ÔºÅ', 'error');
                    }
                } else {
                    showToast('Â∏≥Ëôü‰∏çÂ≠òÂú®ÔºåË´ãÊ™¢Êü•Ëº∏ÂÖ•ÔºÅ', 'error');
                }
                
                // Ê∏ÖÁ©∫ÂØÜÁ¢ºÊ¨Ñ‰Ωç
                document.getElementById('mainLoginPassword').value = '';
                document.getElementById('mainLoginPassword').focus();
                return;
            }
            
            // ÁôªÂÖ•ÊàêÂäü
            performLogin(user);
        }
        
        // Âü∑Ë°åÁôªÂÖ•
        function performLogin(user) {
            // Êõ¥Êñ∞ÊúÄÂæåÁôªÂÖ•ÊôÇÈñì
            const userIndex = users.findIndex(u => u.id === user.id);
            if (userIndex !== -1) {
                users[userIndex].lastLogin = new Date().toISOString();
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            currentUser = user.username;
            currentUserData = user;
            
            // ÂàáÊèõÂà∞‰∏ªÁ≥ªÁµ±
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainSystem').classList.remove('hidden');
            
            document.getElementById('userRole').textContent = `Áï∂ÂâçÁî®Êà∂Ôºö${getUserDisplayName(user)}`;
            document.getElementById('sidebarUserRole').textContent = `Áï∂ÂâçÁî®Êà∂Ôºö${getUserDisplayName(user)}`;
            
            generateSidebarMenu();
            updateStatistics();
            
            showToast(`Ê≠°ËøéÂõû‰æÜÔºå${getUserDisplayName(user)}ÔºÅ`, 'success');
        }

        // ÂÅ¥ÈÇäÈÅ∏ÂñÆÊéßÂà∂
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        // ÁôªÂá∫ÂäüËÉΩ
        function logout() {
            currentUser = null;
            currentUserData = null;
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('mainSystem').classList.add('hidden');
            document.getElementById('sidebar').classList.add('-translate-x-full');
            document.getElementById('sidebarOverlay').classList.add('hidden');
            hideAllSections();
        }

        // ÁîüÊàêÂÅ¥ÈÇäÈÅ∏ÂñÆ
        function generateSidebarMenu() {
            const menuContainer = document.getElementById('sidebarMenu');
            menuContainer.innerHTML = '';
            
            const menuItems = {
                patientManagement: { title: 'ÁóÖ‰∫∫Ë≥áÊñôÁÆ°ÁêÜ', icon: 'üë•', description: 'Êñ∞Â¢û„ÄÅÊü•Áúã„ÄÅÁÆ°ÁêÜÁóÖ‰∫∫Ë≥áÊñô' },
                consultationSystem: { title: 'Ë®∫ÁóáÁ≥ªÁµ±', icon: 'ü©∫', description: 'Ë®òÈåÑÁóáÁãÄ„ÄÅË®∫Êñ∑„ÄÅÈñãÁ´ãËôïÊñπ' },
                herbLibrary: { title: '‰∏≠Ëó•Â∫´ÁÆ°ÁêÜ', icon: 'üåø', description: 'ÁÆ°ÁêÜ‰∏≠Ëó•ÊùêÂèäÊñπÂäëË≥áÊñô' },
                billingManagement: { title: 'Êî∂Ë≤ªÈ†ÖÁõÆÁÆ°ÁêÜ', icon: 'üí∞', description: 'ÁÆ°ÁêÜË®∫ÁôÇË≤ªÁî®ÂèäÊî∂Ë≤ªÈ†ÖÁõÆ' },
                userManagement: { title: 'Ë®∫ÊâÄÁî®Êà∂ÁÆ°ÁêÜ', icon: 'üë§', description: 'ÁÆ°ÁêÜË®∫ÊâÄÁî®Êà∂Â∏≥ËôüÂèäÊ¨äÈôê' },
                systemManagement: { title: 'Á≥ªÁµ±ÁÆ°ÁêÜ', icon: '‚öôÔ∏è', description: 'Áµ±Ë®àË≥áÊñô„ÄÅÂÇô‰ªΩÂåØÂá∫' }
            };
            
            allPermissions.forEach(permission => {
                const item = menuItems[permission];
                const button = document.createElement('button');
                button.className = 'w-full text-left p-4 rounded-lg hover:bg-gray-100 transition duration-200 border border-gray-200 mb-2';
                button.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-2xl mr-4">${item.icon}</span>
                        <div>
                            <div class="font-semibold text-gray-800">${item.title}</div>
                            <div class="text-sm text-gray-600">${item.description}</div>
                        </div>
                    </div>
                `;
                button.onclick = () => {
                    showSection(permission);
                    toggleSidebar();
                };
                menuContainer.appendChild(button);
            });
        }

        // È°ØÁ§∫ÊåáÂÆöÂçÄÂüü
        function showSection(sectionId) {
            hideAllSections();
            document.getElementById('welcomePage').classList.add('hidden');
            document.getElementById(sectionId).classList.remove('hidden');
            
            if (sectionId === 'patientManagement') {
                loadPatientList();
            } else if (sectionId === 'consultationSystem') {
                loadConsultationSystem();
            } else if (sectionId === 'herbLibrary') {
                loadHerbLibrary();
            } else if (sectionId === 'billingManagement') {
                loadBillingManagement();
            } else if (sectionId === 'userManagement') {
                loadUserManagement();
            }
        }

        // Èö±ËóèÊâÄÊúâÂçÄÂüü
        function hideAllSections() {
            ['patientManagement', 'consultationSystem', 'herbLibrary', 'billingManagement', 'userManagement', 'systemManagement', 'welcomePage'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
        }

        // ÁóÖ‰∫∫ÁÆ°ÁêÜÂäüËÉΩ
        let editingPatientId = null;
        let filteredPatients = [];
        
        // Êõ¥Êñ∞ÁóÖ‰∫∫Âπ¥ÈΩ°È°ØÁ§∫
        function updatePatientAge() {
            const birthDate = document.getElementById('patientBirthDate').value;
            const ageInput = document.getElementById('patientAge');
            
            if (birthDate) {
                const age = calculateAge(birthDate);
                ageInput.value = age;
            } else {
                ageInput.value = '';
            }
        }

        function showAddPatientForm() {
            editingPatientId = null;
            document.getElementById('formTitle').textContent = 'Êñ∞Â¢ûÁóÖ‰∫∫Ë≥áÊñô';
            document.getElementById('saveButtonText').textContent = 'ÂÑ≤Â≠ò';
            document.getElementById('addPatientModal').classList.remove('hidden');
            clearPatientForm();
        }

        function hideAddPatientForm() {
            document.getElementById('addPatientModal').classList.add('hidden');
            clearPatientForm();
            editingPatientId = null;
        }

        function clearPatientForm() {
            ['patientName', 'patientAge', 'patientGender', 'patientPhone', 'patientIdCard', 'patientBirthDate', 'patientAddress', 'patientAllergies', 'patientHistory'].forEach(id => {
                document.getElementById(id).value = '';
            });
        }

        function savePatient() {
            const patient = {
                id: editingPatientId || Date.now(),
                patientNumber: editingPatientId ? patients.find(p => p.id === editingPatientId).patientNumber : generatePatientNumber(),
                name: document.getElementById('patientName').value.trim(),
                age: document.getElementById('patientAge').value,
                gender: document.getElementById('patientGender').value,
                phone: document.getElementById('patientPhone').value.trim(),
                idCard: document.getElementById('patientIdCard').value.trim(),
                birthDate: document.getElementById('patientBirthDate').value,
                address: document.getElementById('patientAddress').value.trim(),
                allergies: document.getElementById('patientAllergies').value.trim(),
                history: document.getElementById('patientHistory').value.trim(),
                createdAt: editingPatientId ? patients.find(p => p.id === editingPatientId).createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            // È©óË≠âÂøÖÂ°´Ê¨Ñ‰Ωç
            if (!patient.name || !patient.gender || !patient.phone || !patient.birthDate) {
                showToast('Ë´ãÂ°´ÂØ´ÂøÖË¶ÅË≥áÊñôÔºàÂßìÂêç„ÄÅÊÄßÂà•„ÄÅÈõªË©±„ÄÅÂá∫ÁîüÊó•ÊúüÔºâÔºÅ', 'error');
                return;
            }

            // È©óË≠âÂá∫ÁîüÊó•Êúü
            const birthDate = new Date(patient.birthDate);
            const today = new Date();
            if (birthDate > today) {
                showToast('Âá∫ÁîüÊó•Êúü‰∏çËÉΩÊôöÊñº‰ªäÂ§©ÔºÅ', 'error');
                return;
            }

            // Ë®àÁÆóÂπ¥ÈΩ°
            const calculatedAge = calculateAge(patient.birthDate);
            if (calculatedAge > 120) {
                showToast('Ë´ãÁ¢∫Ë™çÂá∫ÁîüÊó•ÊúüÊòØÂê¶Ê≠£Á¢∫ÔºÅ', 'error');
                return;
            }

            // È©óË≠âÈõªË©±Ê†ºÂºè
            const phoneRegex = /^[0-9\-\+\(\)\s]+$/;
            if (!phoneRegex.test(patient.phone)) {
                showToast('Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÈõªË©±ËôüÁ¢ºÔºÅ', 'error');
                return;
            }

            // È©óË≠âË∫´ÂàÜË≠âÊ†ºÂºèÔºàÂ¶ÇÊûúÊúâÂ°´ÂØ´Ôºâ
            if (patient.idCard) {
                const idRegex = /^[A-Z][12][0-9]{8}$/;
                if (!idRegex.test(patient.idCard)) {
                    showToast('Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑË∫´ÂàÜË≠âÂ≠óËôüÊ†ºÂºèÔºà‰æãÔºöA123456789ÔºâÔºÅ', 'error');
                    return;
                }
            }

            if (editingPatientId) {
                // Êõ¥Êñ∞ÁèæÊúâÁóÖ‰∫∫
                const index = patients.findIndex(p => p.id === editingPatientId);
                patients[index] = patient;
                showToast('ÁóÖ‰∫∫Ë≥áÊñôÂ∑≤ÊàêÂäüÊõ¥Êñ∞ÔºÅ', 'success');
            } else {
                // Êñ∞Â¢ûÁóÖ‰∫∫
                patients.push(patient);
                showToast('ÁóÖ‰∫∫Ë≥áÊñôÂ∑≤ÊàêÂäüÊñ∞Â¢ûÔºÅ', 'success');
            }

            localStorage.setItem('patients', JSON.stringify(patients));
            loadPatientList();
            hideAddPatientForm();
            updateStatistics();
        }

        function loadPatientList() {
            const tbody = document.getElementById('patientList');
            const searchTerm = document.getElementById('searchPatient').value.toLowerCase();
            
            // ÈÅéÊøæÁóÖ‰∫∫Ë≥áÊñô
            filteredPatients = patients.filter(patient => 
                patient.name.toLowerCase().includes(searchTerm) ||
                patient.phone.includes(searchTerm) ||
                (patient.idCard && patient.idCard.toLowerCase().includes(searchTerm)) ||
                (patient.patientNumber && patient.patientNumber.toLowerCase().includes(searchTerm))
            );

            tbody.innerHTML = '';

            if (filteredPatients.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            ${searchTerm ? 'Ê≤íÊúâÊâæÂà∞Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑÁóÖ‰∫∫' : 'Â∞öÁÑ°ÁóÖ‰∫∫Ë≥áÊñô'}
                        </td>
                    </tr>
                `;
                return;
            }

            filteredPatients.forEach(patient => {

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-blue-600 font-medium">${patient.patientNumber || 'Êú™Ë®≠ÂÆö'}</td>
                    <td class="px-4 py-3 text-sm text-gray-900 font-medium">${patient.name}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${formatAge(patient.birthDate)}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${patient.gender}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${patient.phone}</td>

                    <td class="px-4 py-3 text-sm space-x-2">
                        <button onclick="viewPatient(${patient.id})" class="text-blue-600 hover:text-blue-800">Êü•Áúã</button>
                        <button onclick="showPatientMedicalHistory(${patient.id})" class="text-purple-600 hover:text-purple-800">ÁóÖÊ≠∑</button>
                        <button onclick="editPatient(${patient.id})" class="text-green-600 hover:text-green-800">Á∑®ËºØ</button>
                        <button onclick="deletePatient(${patient.id})" class="text-red-600 hover:text-red-800">Âà™Èô§</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function editPatient(id) {
            const patient = patients.find(p => p.id === id);
            if (!patient) return;

            editingPatientId = id;
            document.getElementById('formTitle').textContent = 'Á∑®ËºØÁóÖ‰∫∫Ë≥áÊñô';
            document.getElementById('saveButtonText').textContent = 'Êõ¥Êñ∞';
            
            // Â°´ÂÖ•ÁèæÊúâË≥áÊñô
            document.getElementById('patientName').value = patient.name || '';
            document.getElementById('patientGender').value = patient.gender || '';
            document.getElementById('patientPhone').value = patient.phone || '';
            document.getElementById('patientIdCard').value = patient.idCard || '';
            document.getElementById('patientBirthDate').value = patient.birthDate || '';
            document.getElementById('patientAddress').value = patient.address || '';
            document.getElementById('patientAllergies').value = patient.allergies || '';
            document.getElementById('patientHistory').value = patient.history || '';
            
            // Ëá™ÂãïË®àÁÆóÂπ¥ÈΩ°
            updatePatientAge();
            
            document.getElementById('addPatientModal').classList.remove('hidden');
        }

        function deletePatient(id) {
            const patient = patients.find(p => p.id === id);
            if (!patient) return;

            if (confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§ÁóÖ‰∫∫„Äå${patient.name}„ÄçÁöÑË≥áÊñôÂóéÔºü\n\nÊ≥®ÊÑèÔºöÁõ∏ÈóúÁöÑË®∫ÁóáË®òÈåÑ‰πüÊúÉ‰∏Ä‰ΩµÂà™Èô§ÔºÅ`)) {
                // Âà™Èô§ÁóÖ‰∫∫Ë≥áÊñô
                patients = patients.filter(p => p.id !== id);
                // Âà™Èô§Áõ∏ÈóúË®∫ÁóáË®òÈåÑ
                consultations = consultations.filter(c => c.patientId !== id);
                // Âà™Èô§Áõ∏ÈóúÊéõËôüË®òÈåÑ
                appointments = appointments.filter(a => a.patientId !== id);
                
                localStorage.setItem('patients', JSON.stringify(patients));
                localStorage.setItem('consultations', JSON.stringify(consultations));
                localStorage.setItem('appointments', JSON.stringify(appointments));
                
                loadPatientList();
                updateStatistics();
                showToast('ÁóÖ‰∫∫Ë≥áÊñôÂèäÁõ∏ÈóúË®∫ÁóáË®òÈåÑÂ∑≤Âà™Èô§ÔºÅ', 'success');
            }
        }

        function viewPatient(id) {
            const patient = patients.find(p => p.id === id);
            if (!patient) return;

            // Áç≤ÂèñË©≤ÁóÖ‰∫∫ÁöÑË®∫ÁóáË®òÈåÑÁµ±Ë®à
            const patientConsultations = consultations.filter(c => c.patientId === id);
            const totalConsultations = patientConsultations.length;
            const lastConsultation = patientConsultations.length > 0 ? 
                patientConsultations.sort((a, b) => new Date(b.date) - new Date(a.date))[0] : null;

            const content = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <h4 class="text-lg font-semibold text-gray-800 border-b pb-2">Âü∫Êú¨Ë≥áÊñô</h4>
                        <div class="space-y-2">
                            <div><span class="font-medium">ÁóÖ‰∫∫Á∑®ËôüÔºö</span><span class="text-blue-600 font-semibold">${patient.patientNumber || 'Êú™Ë®≠ÂÆö'}</span></div>
                            <div><span class="font-medium">ÂßìÂêçÔºö</span>${patient.name}</div>
                            <div><span class="font-medium">Âπ¥ÈΩ°Ôºö</span>${formatAge(patient.birthDate)}</div>
                            <div><span class="font-medium">ÊÄßÂà•Ôºö</span>${patient.gender}</div>
                            <div><span class="font-medium">ÈõªË©±Ôºö</span>${patient.phone}</div>
                            ${patient.idCard ? `<div><span class="font-medium">Ë∫´ÂàÜË≠âÔºö</span>${patient.idCard}</div>` : ''}
                            ${patient.birthDate ? `<div><span class="font-medium">Âá∫ÁîüÊó•ÊúüÔºö</span>${new Date(patient.birthDate).toLocaleDateString('zh-TW')}</div>` : ''}
                            ${patient.address ? `<div><span class="font-medium">Âú∞ÂùÄÔºö</span>${patient.address}</div>` : ''}
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <h4 class="text-lg font-semibold text-gray-800 border-b pb-2">ÈÜ´ÁôÇË≥áË®ä</h4>
                        <div class="space-y-2">
                            ${patient.allergies ? `<div><span class="font-medium">ÈÅéÊïèÂè≤Ôºö</span><div class="mt-1 p-2 bg-red-50 rounded text-sm">${patient.allergies}</div></div>` : ''}
                            ${patient.history ? `<div><span class="font-medium">ÁóÖÂè≤Ôºö</span><div class="mt-1 p-2 bg-gray-50 rounded text-sm">${patient.history}</div></div>` : ''}
                            <div><span class="font-medium">Âª∫Ê™îÊó•ÊúüÔºö</span>${new Date(patient.createdAt).toLocaleDateString('zh-TW')}</div>
                            ${patient.updatedAt ? `<div><span class="font-medium">Êõ¥Êñ∞Êó•ÊúüÔºö</span>${new Date(patient.updatedAt).toLocaleDateString('zh-TW')}</div>` : ''}
                        </div>
                    </div>
                </div>
                
                <!-- Ë®∫ÁóáË®òÈåÑÊëòË¶Å -->
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-semibold text-gray-800">Ë®∫ÁóáË®òÈåÑÊëòË¶Å</h4>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="bg-blue-50 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-blue-600">${totalConsultations}</div>
                            <div class="text-sm text-blue-800">Á∏ΩË®∫ÁóáÊ¨°Êï∏</div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4 text-center">
                            <div class="text-lg font-semibold text-green-600">
                                ${lastConsultation ? new Date(lastConsultation.date).toLocaleDateString('zh-TW') : 'ÁÑ°'}
                            </div>
                            <div class="text-sm text-green-800">ÊúÄËøëË®∫Áóá</div>
                        </div>
                        <div class="bg-orange-50 rounded-lg p-4 text-center">
                            <div class="text-lg font-semibold text-orange-600">
                                ${lastConsultation ? (lastConsultation.followUpDate ? 
                                    new Date(lastConsultation.followUpDate).toLocaleDateString('zh-TW') : 'ÁÑ°ÂÆâÊéí') : 'ÁÑ°'}
                            </div>
                            <div class="text-sm text-orange-800">‰∏ãÊ¨°Ë§áË®∫</div>
                        </div>
                    </div>
                    
                    ${totalConsultations > 0 ? `
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h5 class="font-medium text-gray-800 mb-2">ÊúÄËøëË®∫ÁóáË®òÈåÑ</h5>
                            <div class="text-sm text-gray-700">
                                <div><span class="font-medium">Ë®∫Êñ∑Ôºö</span>${lastConsultation.diagnosis || 'ÁÑ°Ë®òÈåÑ'}</div>
                                <div class="mt-1"><span class="font-medium">Ë≠âÂûãÔºö</span>${lastConsultation.syndrome || 'ÁÑ°Ë®òÈåÑ'}</div>
                                ${lastConsultation.instructions ? `<div class="mt-1"><span class="font-medium">ÈÜ´ÂõëÔºö</span>${lastConsultation.instructions}</div>` : ''}
                            </div>
                        </div>
                    ` : `
                        <div class="text-center py-8 text-gray-500">
                            <div class="text-4xl mb-2">üìã</div>
                            <div>Â∞öÁÑ°Ë®∫ÁóáË®òÈåÑ</div>
                        </div>
                    `}
                </div>
            `;

            document.getElementById('patientDetailContent').innerHTML = content;
            document.getElementById('patientDetailModal').classList.remove('hidden');
        }

        function closePatientDetail() {
            document.getElementById('patientDetailModal').classList.add('hidden');
        }





        // ÊêúÂ∞ãÂäüËÉΩ
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchPatient');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    loadPatientList();
                });
            }
        });

        // Ë®∫ÁóáÁ≥ªÁµ±ÂäüËÉΩ
        let selectedPatientForRegistration = null;
        let currentConsultingAppointmentId = null;
        
        function loadConsultationSystem() {
            loadTodayAppointments();
            clearPatientSearch();
        }
        
        // ÊêúÁ¥¢ÁóÖ‰∫∫ÈÄ≤Ë°åÊéõËôü
        function searchPatientsForRegistration() {
            const searchTerm = document.getElementById('patientSearchInput').value.trim().toLowerCase();
            const resultsContainer = document.getElementById('patientSearchResults');
            const resultsList = document.getElementById('searchResultsList');
            
            if (searchTerm.length < 1) {
                resultsContainer.classList.add('hidden');
                return;
            }
            
            // ÊêúÁ¥¢ÂåπÈÖçÁöÑÁóÖ‰∫∫
            const matchedPatients = patients.filter(patient => 
                patient.name.toLowerCase().includes(searchTerm) ||
                patient.phone.includes(searchTerm) ||
                (patient.patientNumber && patient.patientNumber.toLowerCase().includes(searchTerm))
            );
            
            if (matchedPatients.length === 0) {
                resultsList.innerHTML = `
                    <div class="p-4 text-center text-gray-500">
                        Êâæ‰∏çÂà∞Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑÁóÖ‰∫∫
                    </div>
                `;
                resultsContainer.classList.remove('hidden');
                return;
            }
            
            // È°ØÁ§∫ÊêúÁ¥¢ÁµêÊûú
            resultsList.innerHTML = matchedPatients.map(patient => `
                <div class="p-4 hover:bg-gray-50 cursor-pointer transition duration-200" onclick="selectPatientForRegistration(${patient.id})">
                    <div>
                        <div class="font-semibold text-gray-900">${patient.name}</div>
                        <div class="text-sm text-gray-600">Á∑®ËôüÔºö${patient.patientNumber} | Âπ¥ÈΩ°Ôºö${formatAge(patient.birthDate)} | ÊÄßÂà•Ôºö${patient.gender}</div>
                        <div class="text-sm text-gray-500">ÈõªË©±Ôºö${patient.phone}</div>
                    </div>
                </div>
            `).join('');
            
            resultsContainer.classList.remove('hidden');
        }
        
        // ÈÅ∏ÊìáÁóÖ‰∫∫ÈÄ≤Ë°åÊéõËôü
        function selectPatientForRegistration(patientId) {
            // Ê™¢Êü•ÊòØÂê¶ÊúâÁóÖ‰∫∫Ê≠£Âú®Ë®∫Áóá‰∏≠
            const consultingAppointment = appointments.find(apt => 
                apt.status === 'consulting' && 
                new Date(apt.appointmentTime).toDateString() === new Date().toDateString()
            );
            
            if (consultingAppointment) {
                const consultingPatient = patients.find(p => p.id === consultingAppointment.patientId);
                const consultingPatientName = consultingPatient ? consultingPatient.name : 'Êüê‰ΩçÁóÖ‰∫∫';
                showToast(`ÁÑ°Ê≥ïÈÄ≤Ë°åÊéõËôüÔºÅ${consultingPatientName}Ê≠£Âú®Ë®∫Áóá‰∏≠ÔºåË´ãÁ≠âÂæÖË®∫ÁóáÂÆåÊàêÂæåÂÜçÈÄ≤Ë°åÊéõËôüÊìç‰Ωú„ÄÇ`, 'warning');
                return;
            }
            
            const patient = patients.find(p => p.id === patientId);
            if (!patient) return;
            
            selectedPatientForRegistration = patient;
            showRegistrationModal(patient);
        }
        
        // Ê∏ÖÈô§ÁóÖ‰∫∫ÊêúÁ¥¢
        function clearPatientSearch() {
            document.getElementById('patientSearchInput').value = '';
            document.getElementById('patientSearchResults').classList.add('hidden');
            selectedPatientForRegistration = null;
        }
        

        
        // È°ØÁ§∫ÊéõËôüÂΩàÁ™ó
        function showRegistrationModal(patient) {
            if (!patient) return;
            
            // È°ØÁ§∫ÈÅ∏‰∏≠ÁöÑÁóÖ‰∫∫Ë≥áË®ä
            document.getElementById('selectedPatientInfo').innerHTML = `
                <div class="space-y-1">
                    <div><span class="font-medium">ÂßìÂêçÔºö</span>${patient.name}</div>
                    <div><span class="font-medium">Á∑®ËôüÔºö</span>${patient.patientNumber}</div>
                    <div><span class="font-medium">Âπ¥ÈΩ°Ôºö</span>${formatAge(patient.birthDate)} | <span class="font-medium">ÊÄßÂà•Ôºö</span>${patient.gender}</div>
                    <div><span class="font-medium">ÈõªË©±Ôºö</span>${patient.phone}</div>
                </div>
            `;
            
            // Ë®≠ÁΩÆÈ†êË®≠ÊéõËôüÊôÇÈñìÁÇ∫Áï∂ÂâçÊôÇÈñìÔºàÂä†5ÂàÜÈêòÈÅøÂÖçÊôÇÈñìÈÅéÊúüÔºâ
            const now = new Date();
            now.setMinutes(now.getMinutes() + 5); // Âä†5ÂàÜÈêò
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const localDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
            
            document.getElementById('appointmentDateTime').value = localDateTime;
            
            clearRegistrationForm();
            document.getElementById('registrationModal').classList.remove('hidden');
        }
        
        // ÈóúÈñâÊéõËôüÂΩàÁ™ó
        function closeRegistrationModal() {
            document.getElementById('registrationModal').classList.add('hidden');
            clearRegistrationForm();
            selectedPatientForRegistration = null;
        }
        
        // Ê∏ÖÁ©∫ÊéõËôüË°®ÂñÆ
        function clearRegistrationForm() {
            document.getElementById('quickChiefComplaint').value = '';
        }
        
        // Á¢∫Ë™çÊéõËôü
        function confirmRegistration() {
            if (!selectedPatientForRegistration) {
                showToast('Á≥ªÁµ±ÈåØË™§ÔºöÊú™ÈÅ∏ÊìáÁóÖ‰∫∫ÔºÅ', 'error');
                return;
            }
            
            const appointmentDateTime = document.getElementById('appointmentDateTime').value;
            const chiefComplaint = document.getElementById('quickChiefComplaint').value.trim();
            
            if (!appointmentDateTime) {
                showToast('Ë´ãÈÅ∏ÊìáÊéõËôüÊôÇÈñìÔºÅ', 'error');
                return;
            }
            
            // È©óË≠âÊéõËôüÊôÇÈñì‰∏çËÉΩÊòØÈÅéÂéªÊôÇÈñìÔºàÂÖÅË®±1ÂàÜÈêòÁöÑË™§Â∑ÆÔºâ
            const selectedTime = new Date(appointmentDateTime);
            const now = new Date();
            now.setMinutes(now.getMinutes() - 1); // ÂÖÅË®±1ÂàÜÈêòË™§Â∑Æ
            if (selectedTime < now) {
                showToast('ÊéõËôüÊôÇÈñì‰∏çËÉΩÊó©ÊñºÁèæÂú®ÊôÇÈñìÔºÅ', 'error');
                return;
            }
            
            const appointment = {
                id: Date.now(),
                patientId: selectedPatientForRegistration.id,
                appointmentTime: selectedTime.toISOString(),
                chiefComplaint: chiefComplaint || 'ÁÑ°ÁâπÊÆä‰∏ªË®¥',
                status: 'registered', // registered, waiting, consulting, completed
                createdAt: new Date().toISOString(),
                createdBy: currentUserData ? currentUserData.username : currentUser
            };
            
            appointments.push(appointment);
            localStorage.setItem('appointments', JSON.stringify(appointments));
            
            showToast(`${selectedPatientForRegistration.name} ÊéõËôüÊàêÂäüÔºÅ`, 'success');
            
            closeRegistrationModal();
            clearPatientSearch();
            loadTodayAppointments();
        }
        
        // ËºâÂÖ•‰ªäÊó•ÊéõËôüÂàóË°®
        function loadTodayAppointments() {
            const today = new Date().toDateString();
            const todayAppointments = appointments.filter(apt => 
                new Date(apt.appointmentTime).toDateString() === today
            ).sort((a, b) => new Date(a.appointmentTime) - new Date(b.appointmentTime));
            
            const tbody = document.getElementById('todayAppointmentsList');
            document.getElementById('todayTotal').textContent = todayAppointments.length;
            
            if (todayAppointments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            ‰ªäÊó•Êö´ÁÑ°ÊéõËôüË®òÈåÑ
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = todayAppointments.map((appointment, index) => {
                const patient = patients.find(p => p.id === appointment.patientId);
                if (!patient) return '';
                
                const statusInfo = getStatusInfo(appointment.status);
                const operationButtons = getOperationButtons(appointment);
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm text-gray-900 font-medium">${index + 1}</td>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">
                            ${patient.name}
                            <div class="text-xs text-gray-500">${patient.patientNumber}</div>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900">
                            ${new Date(appointment.appointmentTime).toLocaleString('zh-TW', {
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900">
                            <div class="max-w-xs truncate" title="${appointment.chiefComplaint || 'ÁÑ°'}">
                                ${appointment.chiefComplaint || 'ÁÑ°'}
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusInfo.class}">
                                ${statusInfo.text}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm">
                            <div class="flex flex-wrap gap-1">
                                ${operationButtons}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Áç≤ÂèñÁãÄÊÖãË≥áË®ä
        function getStatusInfo(status) {
            const statusMap = {
                'registered': { text: 'Â∑≤ÊéõËôü', class: 'bg-blue-100 text-blue-800' },
                'waiting': { text: 'ÂÄôË®∫‰∏≠', class: 'bg-yellow-100 text-yellow-800' },
                'consulting': { text: 'Ë®∫Áóá‰∏≠', class: 'bg-green-100 text-green-800' },
                'completed': { text: 'Â∑≤ÂÆåÊàê', class: 'bg-gray-100 text-gray-800' }
            };
            return statusMap[status] || { text: 'Êú™Áü•', class: 'bg-gray-100 text-gray-800' };
        }
        
        // Áç≤ÂèñÊìç‰ΩúÊåâÈàï
        function getOperationButtons(appointment) {
            const buttons = [];
            
            // Ê™¢Êü•ÊòØÂê¶ÊúâÁóÖ‰∫∫Ê≠£Âú®Ë®∫Áóá‰∏≠
            const isAnyoneConsulting = appointments.some(apt => 
                apt.status === 'consulting' && 
                new Date(apt.appointmentTime).toDateString() === new Date().toDateString()
            );
            
            const isCurrentConsulting = appointment.status === 'consulting';
            
            // ÊâÄÊúâÁãÄÊÖãÈÉΩÂèØ‰ª•Êü•ÁúãË®∫ÁóáË®òÈåÑ
            buttons.push(`<button onclick="viewPatientMedicalHistory(${appointment.patientId})" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs transition duration-200">Ë®∫ÁóáË®òÈåÑ</button>`);
            
            // Â¶ÇÊûúÊúâ‰∫∫Âú®Ë®∫Áóá‰∏≠‰∏î‰∏çÊòØÁï∂ÂâçÁóÖ‰∫∫ÔºåÂâáÂÖ∂‰ªñÊìç‰ΩúÈÉΩË¢´Á¶ÅÁî®
            const isDisabled = isAnyoneConsulting && !isCurrentConsulting;
            let disabledTooltip = '';
            if (isDisabled) {
                const consultingAppointment = appointments.find(apt => 
                    apt.status === 'consulting' && 
                    new Date(apt.appointmentTime).toDateString() === new Date().toDateString()
                );
                const consultingPatient = consultingAppointment ? patients.find(p => p.id === consultingAppointment.patientId) : null;
                const consultingPatientName = consultingPatient ? consultingPatient.name : 'Êüê‰ΩçÁóÖ‰∫∫';
                disabledTooltip = `title="${consultingPatientName}Ê≠£Âú®Ë®∫Áóá‰∏≠ÔºåÊìç‰ΩúÊö´ÊôÇÁ¶ÅÁî®"`;
            }
            
            switch (appointment.status) {
                case 'registered':
                    if (isDisabled) {
                        buttons.push(`<span class="bg-gray-300 text-gray-500 px-2 py-1 rounded text-xs cursor-not-allowed" ${disabledTooltip}>Á¢∫Ë™çÂà∞ÈÅî</span>`);
                        buttons.push(`<span class="bg-gray-300 text-gray-500 px-2 py-1 rounded text-xs cursor-not-allowed" ${disabledTooltip}>ÁßªÈô§ÊéõËôü</span>`);
                    } else {
                        buttons.push(`<button onclick="confirmPatientArrival(${appointment.id})" class="bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded text-xs transition duration-200">Á¢∫Ë™çÂà∞ÈÅî</button>`);
                        buttons.push(`<button onclick="removeAppointment(${appointment.id})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition duration-200">ÁßªÈô§ÊéõËôü</button>`);
                    }
                    break;
                    
                case 'waiting':
                    if (isDisabled) {
                        buttons.push(`<span class="bg-gray-300 text-gray-500 px-2 py-1 rounded text-xs cursor-not-allowed" ${disabledTooltip}>ÈñãÂßãË®∫Áóá</span>`);
                    } else {
                        buttons.push(`<button onclick="startConsultation(${appointment.id})" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs transition duration-200">ÈñãÂßãË®∫Áóá</button>`);
                    }
                    break;
                    
                case 'consulting':
                    buttons.push(`<button onclick="continueConsultation(${appointment.id})" class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-xs transition duration-200">ÁπºÁ∫åË®∫Áóá</button>`);
                    break;
                    
                case 'completed':
                    // ÂàóÂç∞Êî∂ÊìöÂäüËÉΩ‰∏çÂèóË®∫ÁóáÁãÄÊÖãÈôêÂà∂
                    buttons.push(`<button onclick="printReceiptFromAppointment(${appointment.id})" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs transition duration-200">ÂàóÂç∞Êî∂Êìö</button>`);
                    
                    if (isDisabled) {
                        buttons.push(`<span class="bg-gray-300 text-gray-500 px-2 py-1 rounded text-xs cursor-not-allowed" ${disabledTooltip}>‰øÆÊîπÁóÖÊ≠∑</span>`);
                        buttons.push(`<span class="bg-gray-300 text-gray-500 px-2 py-1 rounded text-xs cursor-not-allowed" ${disabledTooltip}>Êí§ÂõûË®∫Áóá</span>`);
                    } else {
                        buttons.push(`<button onclick="editMedicalRecord(${appointment.id})" class="bg-orange-500 hover:bg-orange-600 text-white px-2 py-1 rounded text-xs transition duration-200">‰øÆÊîπÁóÖÊ≠∑</button>`);
                        buttons.push(`<button onclick="withdrawConsultation(${appointment.id})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition duration-200">Êí§ÂõûË®∫Áóá</button>`);
                    }
                    break;
                    
                default:
                    buttons.push('<span class="text-gray-400 text-xs">ÁãÄÊÖãÁï∞Â∏∏</span>');
                    break;
            }
            
            return buttons.join('');
        }
        

        
        // Á¢∫Ë™çÁóÖ‰∫∫Âà∞ÈÅîÔºàÂä©ÁêÜÊìç‰ΩúÔºâ
        function confirmPatientArrival(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) {
                showToast('Êâæ‰∏çÂà∞ÊéõËôüË®òÈåÑÔºÅ', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            if (!patient) {
                showToast('Êâæ‰∏çÂà∞ÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
                return;
            }
            
            // Ë©≥Á¥∞ÁãÄÊÖãÊ™¢Êü•
            console.log(`Á¢∫Ë™çÂà∞ÈÅîÁãÄÊÖãÊ™¢Êü• - ÁóÖ‰∫∫: ${patient.name}, Áï∂ÂâçÁãÄÊÖã: ${appointment.status}`);
            
            // Âè™ÊúâÂ∑≤ÊéõËôüÁãÄÊÖãÊâçËÉΩÁ¢∫Ë™çÂà∞ÈÅî
            if (appointment.status !== 'registered') {
                const statusNames = {
                    'waiting': 'ÂÄôË®∫‰∏≠',
                    'consulting': 'Ë®∫Áóá‰∏≠',
                    'completed': 'Â∑≤ÂÆåÊàê'
                };
                const currentStatusName = statusNames[appointment.status] || appointment.status;
                showToast(`ÁÑ°Ê≥ïÁ¢∫Ë™çÂà∞ÈÅîÔºÅÁóÖ‰∫∫ ${patient.name} ÁõÆÂâçÁãÄÊÖãÁÇ∫„Äå${currentStatusName}„ÄçÔºåÂè™ËÉΩÂ∞ç„ÄåÂ∑≤ÊéõËôü„ÄçÁöÑÁóÖ‰∫∫Á¢∫Ë™çÂà∞ÈÅî„ÄÇ`, 'warning');
                return;
            }
            
            // Êõ¥Êñ∞ÁãÄÊÖãÁÇ∫ÂÄôË®∫‰∏≠
            appointment.status = 'waiting';
            appointment.arrivedAt = new Date().toISOString();
            appointment.confirmedBy = currentUserData ? currentUserData.username : currentUser;
            
            // ‰øùÂ≠òÁãÄÊÖãËÆäÊõ¥
            localStorage.setItem('appointments', JSON.stringify(appointments));
            
            showToast(`${patient.name} Â∑≤Á¢∫Ë™çÂà∞ÈÅîÔºåÈÄ≤ÂÖ•ÂÄôË®∫ÁãÄÊÖãÔºÅ`, 'success');
            loadTodayAppointments();
        }
        
        // ÁßªÈô§ÊéõËôüÂäüËÉΩ
        function removeAppointment(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) {
                showToast('Êâæ‰∏çÂà∞ÊéõËôüË®òÈåÑÔºÅ', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            if (!patient) {
                showToast('Êâæ‰∏çÂà∞ÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
                return;
            }
            
            // Ë©≥Á¥∞ÁãÄÊÖãÊ™¢Êü•
            console.log(`ÁßªÈô§ÊéõËôüÁãÄÊÖãÊ™¢Êü• - ÁóÖ‰∫∫: ${patient.name}, Áï∂ÂâçÁãÄÊÖã: ${appointment.status}`);
            
            // Ê™¢Êü•ÊòØÂê¶ÂèØ‰ª•ÁßªÈô§
            if (appointment.status === 'waiting') {
                showToast(`ÁÑ°Ê≥ïÁßªÈô§ÊéõËôüÔºÅÁóÖ‰∫∫ ${patient.name} Â∑≤Á¢∫Ë™çÂà∞ÈÅîÂÄôË®∫‰∏≠ÔºåË´ãËÅØÁπ´ÈÜ´Â∏´ËôïÁêÜ„ÄÇ`, 'warning');
                return;
            }
            
            if (appointment.status === 'consulting') {
                showToast(`ÁÑ°Ê≥ïÁßªÈô§ÊéõËôüÔºÅÁóÖ‰∫∫ ${patient.name} ÁõÆÂâçÊ≠£Âú®Ë®∫Áóá‰∏≠ÔºåË´ãÂÖàÁµêÊùüË®∫ÁóáÂæåÂÜçÁßªÈô§„ÄÇ`, 'warning');
                return;
            }
            
            if (appointment.status === 'completed') {
                showToast(`ÁÑ°Ê≥ïÁßªÈô§ÊéõËôüÔºÅÁóÖ‰∫∫ ${patient.name} Â∑≤ÂÆåÊàêË®∫ÁóáÔºåÂ∑≤ÂÆåÊàêÁöÑË®òÈåÑÁÑ°Ê≥ïÁßªÈô§„ÄÇ`, 'warning');
                return;
            }
            
            // Á¢∫Ë™çÁßªÈô§
            const statusNames = {
                'registered': 'Â∑≤ÊéõËôü',
                'waiting': 'ÂÄôË®∫‰∏≠'
            };
            const statusText = statusNames[appointment.status] || appointment.status;
            
            const confirmMessage = `Á¢∫ÂÆöË¶ÅÁßªÈô§ ${patient.name} ÁöÑÊéõËôüÂóéÔºü\n\n` +
                                 `ÁãÄÊÖãÔºö${statusText}\n` +
                                 `ÊéõËôüÊôÇÈñìÔºö${new Date(appointment.appointmentTime).toLocaleString('zh-TW')}\n\n` +
                                 `Ê≥®ÊÑèÔºöÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ`;
            
            if (confirm(confirmMessage)) {
                // ÂæûÊéõËôüÂàóË°®‰∏≠ÁßªÈô§
                appointments = appointments.filter(apt => apt.id !== appointmentId);
                localStorage.setItem('appointments', JSON.stringify(appointments));
                
                showToast(`Â∑≤ÁßªÈô§ ${patient.name} ÁöÑÊéõËôüË®òÈåÑ`, 'success');
                loadTodayAppointments();
                
                // Â¶ÇÊûúÊ≠£Âú®Ë®∫ÁóáË°®ÂñÆ‰∏≠È°ØÁ§∫Ë©≤ÁóÖ‰∫∫ÔºåÂâáÈóúÈñâË°®ÂñÆ
                if (currentConsultingAppointmentId === appointmentId) {
                    closeConsultationForm();
                    currentConsultingAppointmentId = null;
                }
            }
        }
        

        

        
        // ÈñãÂßãË®∫ÁóáÔºàÈÜ´Â∏´Êìç‰ΩúÔºâ
        function startConsultation(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) {
                showToast('Êâæ‰∏çÂà∞ÊéõËôüË®òÈåÑÔºÅ', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            if (!patient) {
                showToast('Êâæ‰∏çÂà∞ÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
                return;
            }
            
            // Ë©≥Á¥∞ÁãÄÊÖãÊ™¢Êü•ÂíåË®∫Êñ∑
            console.log(`ÈñãÂßãË®∫ÁóáÁãÄÊÖãÊ™¢Êü• - ÁóÖ‰∫∫: ${patient.name}, Áï∂ÂâçÁãÄÊÖã: ${appointment.status}`);
            
            // Ê™¢Êü•ÁóÖ‰∫∫ÁãÄÊÖãÊòØÂê¶ÂÖÅË®±ÈñãÂßãË®∫Áóá
            if (!['waiting', 'registered'].includes(appointment.status)) {
                const statusNames = {
                    'consulting': 'Ë®∫Áóá‰∏≠',
                    'completed': 'Â∑≤ÂÆåÊàê'
                };
                const currentStatusName = statusNames[appointment.status] || appointment.status;
                showToast(`ÁÑ°Ê≥ïÈñãÂßãË®∫ÁóáÔºÅÁóÖ‰∫∫ ${patient.name} ÁõÆÂâçÁãÄÊÖãÁÇ∫„Äå${currentStatusName}„ÄçÔºåÂè™ËÉΩÂ∞ç„ÄåÂ∑≤ÊéõËôü„ÄçÊàñ„ÄåÂÄôË®∫‰∏≠„ÄçÁöÑÁóÖ‰∫∫ÈñãÂßãË®∫Áóá„ÄÇ`, 'error');
                return;
            }
            
            // Â¶ÇÊûúÊòØÂ∑≤ÊéõËôüÁãÄÊÖãÔºåËá™ÂãïÁ¢∫Ë™çÂà∞ÈÅî
            if (appointment.status === 'registered') {
                appointment.arrivedAt = new Date().toISOString();
                appointment.confirmedBy = currentUserData ? currentUserData.username : currentUser;
                showToast(`${patient.name} Â∑≤Ëá™ÂãïÁ¢∫Ë™çÂà∞ÈÅî`, 'info');
            }
            
            // Ê™¢Êü•ÊòØÂê¶Â∑≤ÊúâÂÖ∂‰ªñÁóÖ‰∫∫Âú®Ë®∫Áóá‰∏≠
            const consultingAppointment = appointments.find(apt => 
                apt.status === 'consulting' && 
                apt.id !== appointmentId &&
                new Date(apt.appointmentTime).toDateString() === new Date().toDateString()
            );
            
            if (consultingAppointment) {
                const consultingPatient = patients.find(p => p.id === consultingAppointment.patientId);
                const consultingPatientName = consultingPatient ? consultingPatient.name : 'Êú™Áü•ÁóÖ‰∫∫';
                
                if (confirm(`ÁõÆÂâç ${consultingPatientName} Ê≠£Âú®Ë®∫Áóá‰∏≠„ÄÇ\n\nÊòØÂê¶Ë¶ÅÁµêÊùüË©≤ÁóÖ‰∫∫ÁöÑË®∫Áóá‰∏¶ÈñãÂßãÁÇ∫ ${patient.name} Ë®∫ÁóáÔºü\n\nÊ≥®ÊÑèÔºö${consultingPatientName} ÁöÑÁãÄÊÖãÂ∞áÊîπÂõûÂÄôË®∫‰∏≠„ÄÇ`)) {
                    // ÁµêÊùüÁï∂ÂâçË®∫ÁóáÁöÑÁóÖ‰∫∫
                    consultingAppointment.status = 'waiting';
                    delete consultingAppointment.consultationStartTime;
                    delete consultingAppointment.consultingDoctor;
                    
                    // ÈóúÈñâÂèØËÉΩÈñãÂïüÁöÑË®∫ÁóáË°®ÂñÆ
                    if (currentConsultingAppointmentId === consultingAppointment.id) {
                        closeConsultationForm();
                    }
                    
                    showToast(`Â∑≤ÁµêÊùü ${consultingPatientName} ÁöÑË®∫Áóá`, 'info');
                } else {
                    return; // Áî®Êà∂ÂèñÊ∂àÊìç‰Ωú
                }
            }
            
            // ÈñãÂßãÊñ∞ÁöÑË®∫Áóá - Ê≠£Á¢∫Ë®≠ÁΩÆÁãÄÊÖãÁÇ∫Ë®∫Áóá‰∏≠
            appointment.status = 'consulting';
            appointment.consultationStartTime = new Date().toISOString();
            appointment.consultingDoctor = currentUserData ? currentUserData.username : currentUser;
            
            // Á´ãÂç≥‰øùÂ≠òÁãÄÊÖãËÆäÊõ¥
            localStorage.setItem('appointments', JSON.stringify(appointments));
            
            // Ë®≠ÁΩÆÁï∂ÂâçË®∫ÁóáID‰∏¶È°ØÁ§∫Ë°®ÂñÆ
            currentConsultingAppointmentId = appointmentId;
            showConsultationForm(appointment);
            
            // ÈáçÊñ∞ËºâÂÖ•ÂàóË°®‰ª•È°ØÁ§∫Ê≠£Á¢∫ÁãÄÊÖã
            loadTodayAppointments();
            
            showToast(`ÈñãÂßãÁÇ∫ ${patient.name} Ë®∫Áóá`, 'success');
        }
        
        // ÁπºÁ∫åË®∫Áóá
        function continueConsultation(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) return;
            
            currentConsultingAppointmentId = appointmentId;
            showConsultationForm(appointment);
        }
        
        // È°ØÁ§∫Ë®∫ÁóáË°®ÂñÆ
        function showConsultationForm(appointment) {
            const patient = patients.find(p => p.id === appointment.patientId);
            if (!patient) return;
            
            // Ë®≠ÁΩÆÁóÖ‰∫∫Ë≥áË®ä
            document.getElementById('formPatientName').textContent = `${patient.name} (${patient.patientNumber})`;
            document.getElementById('formAppointmentTime').textContent = new Date(appointment.appointmentTime).toLocaleString('zh-TW');
            
            // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Á∑®ËºØÊ®°Âºè
            if (appointment.status === 'completed' && appointment.consultationId) {
                // Á∑®ËºØÊ®°ÂºèÔºöËºâÂÖ•ÁèæÊúâË®∫ÁóáË®òÈåÑ
                const consultation = consultations.find(c => c.id === appointment.consultationId);
                if (consultation) {
                    document.getElementById('formSymptoms').value = consultation.symptoms || '';
                    document.getElementById('formTongue').value = consultation.tongue || '';
                    document.getElementById('formPulse').value = consultation.pulse || '';
                    document.getElementById('formCurrentHistory').value = consultation.currentHistory || '';
                    document.getElementById('formDiagnosis').value = consultation.diagnosis || '';
                    document.getElementById('formSyndrome').value = consultation.syndrome || '';
                    document.getElementById('formAcupunctureNotes').value = consultation.acupunctureNotes || '';
                    document.getElementById('formUsage').value = consultation.usage || '';
                    document.getElementById('formTreatmentCourse').value = consultation.treatmentCourse || '';
                    document.getElementById('formInstructions').value = consultation.instructions || '';
                    document.getElementById('formFollowUpDate').value = consultation.followUpDate || '';
                    
                    // Ëß£ÊûêËôïÊñπÂÖßÂÆπ‰∏¶ÈáçÂª∫ËôïÊñπÈ†ÖÁõÆ
                    selectedPrescriptionItems = [];
                    if (consultation.prescription) {
                        // Áõ¥Êé•Â∞áËôïÊñπÂÖßÂÆπË®≠ÁΩÆÂà∞Èö±ËóèÊñáÊú¨Âüü
                        document.getElementById('formPrescription').value = consultation.prescription;
                        // È°ØÁ§∫ÁèæÊúâËôïÊñπÂÖßÂÆπ
                        document.getElementById('selectedPrescriptionItems').innerHTML = `
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                <div class="text-sm font-semibold text-gray-700 mb-2">ÁèæÊúâËôïÊñπÂÖßÂÆπÔºö</div>
                                <div class="text-sm text-gray-900 whitespace-pre-line">${consultation.prescription}</div>
                                <div class="text-xs text-gray-600 mt-2">ÊèêÁ§∫ÔºöÂèØÁπºÁ∫å‰ΩøÁî®ÊêúÁ¥¢ÂäüËÉΩÊ∑ªÂä†Êñ∞ÁöÑ‰∏≠Ëó•ÊùêÊàñÊñπÂäë</div>
                            </div>
                        `;
                    } else {
                        updatePrescriptionDisplay();
                    }
                    
                    // Ëß£ÊûêÊî∂Ë≤ªÈ†ÖÁõÆ‰∏¶ÈáçÂª∫Êî∂Ë≤ªÈ†ÖÁõÆ
                    selectedBillingItems = [];
                    if (consultation.billingItems) {
                        // ÈÄôË£°Á∞°ÂåñËôïÁêÜÔºåÂ∞áÊî∂Ë≤ªÈ†ÖÁõÆË®≠ÁΩÆÂà∞Èö±ËóèÊñáÊú¨Âüü
                        document.getElementById('formBillingItems').value = consultation.billingItems;
                        // È°ØÁ§∫ÊèêÁ§∫‰ø°ÊÅØ
                        document.getElementById('selectedBillingItems').innerHTML = `
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                <div class="text-sm font-semibold text-gray-700 mb-2">ÁèæÊúâÊî∂Ë≤ªÈ†ÖÁõÆÔºö</div>
                                <div class="text-sm text-gray-900 whitespace-pre-line">${consultation.billingItems}</div>
                                <div class="text-xs text-gray-600 mt-2">ÊèêÁ§∫ÔºöÂèØÁπºÁ∫å‰ΩøÁî®ÊêúÁ¥¢ÂäüËÉΩÊ∑ªÂä†Êñ∞ÁöÑÊî∂Ë≤ªÈ†ÖÁõÆ</div>
                            </div>
                        `;
                        // Êõ¥Êñ∞Á∏ΩË≤ªÁî®È°ØÁ§∫ÔºàÂæûÁèæÊúâË≥áÊñô‰∏≠ÊèêÂèñÔºâ
                        const totalMatch = consultation.billingItems.match(/Á∏ΩË≤ªÁî®Ôºö\$(\d+)/);
                        if (totalMatch) {
                            document.getElementById('totalBillingAmount').textContent = `$${totalMatch[1]}`;
                        }
                    } else {
                        updateBillingDisplay();
                    }
                    
                    document.getElementById('consultationSaveButtonText').textContent = 'Êõ¥Êñ∞ÁóÖÊ≠∑';
                } else {
                    clearConsultationForm();
                }
            } else {
                // Êñ∞Ë®∫ÁóáÊ®°ÂºèÔºöÈ†êÂ°´‰∏äÊ¨°ÁóÖÊ≠∑Ë≥áÊñô
                prefillWithPreviousRecord(patient, appointment);
                
                document.getElementById('consultationSaveButtonText').textContent = 'ÂÆåÊàêË®∫Áóá';
            }
            
            document.getElementById('consultationForm').classList.remove('hidden');
            
            // ÊªæÂãïÂà∞Ë°®ÂñÆ‰ΩçÁΩÆ
            document.getElementById('consultationForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        // È†êÂ°´‰∏äÊ¨°ÁóÖÊ≠∑Ë≥áÊñô
        function prefillWithPreviousRecord(patient, appointment) {
            // Áç≤ÂèñË©≤ÁóÖ‰∫∫ÁöÑÊúÄËøë‰∏ÄÊ¨°Ë®∫ÁóáË®òÈåÑÔºàÊéíÈô§Áï∂ÂâçÊ≠£Âú®Á∑®ËºØÁöÑË®òÈåÑÔºâ
            const patientConsultations = consultations
                .filter(c => c.patientId === patient.id)
                .sort((a, b) => new Date(b.date) - new Date(a.date)); // ÊåâÊó•ÊúüÈôçÂ∫èÊéíÂàóÔºàÊúÄÊñ∞Âú®ÂâçÔºâ
            
            const lastConsultation = patientConsultations[0]; // ÊúÄËøë‰∏ÄÊ¨°Ë®∫ÁóáË®òÈåÑ
            
            if (lastConsultation) {
                // È†êÂ°´Âü∫Êú¨Ë®∫ÁóáË≥áÊñôÔºà‰ΩÜ‰∏çÂåÖÊã¨‰∏ªË®¥ÂíåËôïÊñπÔºåÂõ†ÁÇ∫ÊØèÊ¨°ÂèØËÉΩ‰∏çÂêåÔºâ
                document.getElementById('formTongue').value = lastConsultation.tongue || '';
                document.getElementById('formPulse').value = lastConsultation.pulse || '';
                document.getElementById('formDiagnosis').value = lastConsultation.diagnosis || '';
                document.getElementById('formSyndrome').value = lastConsultation.syndrome || '';
                document.getElementById('formUsage').value = lastConsultation.usage || 'Êó©Êôö‰∏ÄÊ¨°ÔºåÈ£ØÂæåÊúç';
                document.getElementById('formTreatmentCourse').value = lastConsultation.treatmentCourse || '‰∏ÄÂë®';
                document.getElementById('formInstructions').value = lastConsultation.instructions || 'Ê≥®ÊÑè‰ºëÊÅØÔºåÈ£≤È£üÊ∏ÖÊ∑°';
                
                // È†êÂ°´‰∏ªË®¥ÔºàÂ¶ÇÊûúÊéõËôüÊôÇÊ≤íÊúâÂ°´ÂØ´‰∏ªË®¥ÔºåÂâá‰ΩøÁî®‰∏äÊ¨°ÁöÑ‰∏ªË®¥Ôºâ
                if (appointment.chiefComplaint && appointment.chiefComplaint !== 'ÁÑ°ÁâπÊÆä‰∏ªË®¥') {
                    document.getElementById('formSymptoms').value = appointment.chiefComplaint;
                } else {
                    document.getElementById('formSymptoms').value = lastConsultation.symptoms || '';
                }
                
                // ‰∏çËºâÂÖ•‰∏äÊ¨°ËôïÊñπÂÖßÂÆπÔºåËÆìÈÜ´Â∏´ÈáçÊñ∞ÈñãÁ´ã
                selectedPrescriptionItems = [];
                updatePrescriptionDisplay();
                clearPrescriptionSearch();
                
                // Ëá™ÂãïÊ∑ªÂä†È†êË®≠Ë®∫ÈáëÊî∂Ë≤ªÈ†ÖÁõÆ
                addDefaultConsultationFee(patient);
                
                // È°ØÁ§∫È†êÂ°´ÊèêÁ§∫
                showToast(`Â∑≤È†êÂ°´ ${patient.name} ‰∏äÊ¨°Ë®∫ÁóáË≥áÊñôÔºà${new Date(lastConsultation.date).toLocaleDateString('zh-TW')}ÔºâÔºåËôïÊñπÂÖßÂÆπË´ãÈáçÊñ∞ÈñãÁ´ã`, 'info');
                
            } else {
                // Ê≤íÊúâÊ≠∑Âè≤Ë®òÈåÑÔºå‰ΩøÁî®È†êË®≠ÂÄº
                clearConsultationForm();
                if (appointment.chiefComplaint) {
                    document.getElementById('formSymptoms').value = appointment.chiefComplaint;
                }
                
                // Ëá™ÂãïÊ∑ªÂä†È†êË®≠Ë®∫ÈáëÊî∂Ë≤ªÈ†ÖÁõÆ
                addDefaultConsultationFee(patient);
                
                showToast(`${patient.name} ÊòØÈ¶ñÊ¨°Ë®∫ÁóáÔºåÂ∑≤ËºâÂÖ•È†êË®≠Ë°®ÂñÆ`, 'info');
            }
        }
        
        // Ê∏ÖÁ©∫Ë®∫ÁóáË°®ÂñÆ
        function clearConsultationForm() {
            ['formSymptoms', 'formTongue', 'formPulse', 'formCurrentHistory', 'formDiagnosis', 'formSyndrome', 'formAcupunctureNotes', 'formPrescription', 'formFollowUpDate'].forEach(id => {
                document.getElementById(id).value = '';
            });
            
            // ÈáçÁΩÆÊúçËó•Êó•Êï∏ÂíåÊ¨°Êï∏ÁÇ∫È†êË®≠ÂÄº
            document.getElementById('medicationDays').value = '5';
            document.getElementById('medicationFrequency').value = '2';
            
            // Ë®≠ÁΩÆÈ†êË®≠ÂÄº
            document.getElementById('formUsage').value = 'Êó©Êôö‰∏ÄÊ¨°ÔºåÈ£ØÂæåÊúç';
            document.getElementById('formInstructions').value = 'Ê≥®ÊÑè‰ºëÊÅØÔºåÈ£≤È£üÊ∏ÖÊ∑°';
            document.getElementById('formTreatmentCourse').value = '‰∏ÄÂë®';
            
            // Ê∏ÖÁ©∫ËôïÊñπÈ†ÖÁõÆ
            selectedPrescriptionItems = [];
            updatePrescriptionDisplay();
            clearPrescriptionSearch();
            
            // Ê∏ÖÁ©∫Êî∂Ë≤ªÈ†ÖÁõÆÔºà‰ΩÜÊúÉÂú® prefillWithPreviousRecord ‰∏≠Ëá™ÂãïÊ∑ªÂä†Ë®∫ÈáëÔºâ
            selectedBillingItems = [];
            updateBillingDisplay();
            clearBillingSearch();
        }
        
        // ÈóúÈñâË®∫ÁóáË°®ÂñÆ
        function closeConsultationForm() {
            // Èö±ËóèË®∫ÁóáË°®ÂñÆ
            document.getElementById('consultationForm').classList.add('hidden');
            
            // Ê∏ÖÁêÜÂÖ®ÂüüËÆäÊï∏
            currentConsultingAppointmentId = null;
            
            // Ê∏ÖÁ©∫ËôïÊñπÂíåÊî∂Ë≤ªÈ†ÖÁõÆÈÅ∏Êìá
            selectedPrescriptionItems = [];
            selectedBillingItems = [];
            
            // ÊªæÂãïÂõûÈ†ÇÈÉ®
            document.getElementById('consultationSystem').scrollIntoView({ behavior: 'smooth' });
        }
        
        // ÂèñÊ∂àË®∫Áóá
        function cancelConsultation() {
            if (!currentConsultingAppointmentId) {
                closeConsultationForm();
                return;
            }
            
            const appointment = appointments.find(apt => apt.id === currentConsultingAppointmentId);
            if (!appointment) {
                closeConsultationForm();
                currentConsultingAppointmentId = null;
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            if (!patient) {
                closeConsultationForm();
                currentConsultingAppointmentId = null;
                return;
            }
            
            // Ë©≥Á¥∞ÁãÄÊÖãÊ™¢Êü•
            console.log(`ÂèñÊ∂àË®∫ÁóáÁãÄÊÖãÊ™¢Êü• - ÁóÖ‰∫∫: ${patient.name}, Áï∂ÂâçÁãÄÊÖã: ${appointment.status}`);
            
            if (appointment.status === 'consulting') {
                const confirmMessage = `Á¢∫ÂÆöË¶ÅÂèñÊ∂à ${patient.name} ÁöÑË®∫ÁóáÂóéÔºü\n\n` +
                                     `ÁóÖ‰∫∫ÁãÄÊÖãÂ∞áÂõûÂà∞ÂÄôË®∫‰∏≠ÔºåÂ∑≤Â°´ÂØ´ÁöÑË®∫ÁóáÂÖßÂÆπÂ∞áÊúÉÈÅ∫Â§±„ÄÇ\n\n` +
                                     `Ê≥®ÊÑèÔºöÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ`;
                
                if (confirm(confirmMessage)) {
                    // Â∞áÁãÄÊÖãÊîπÂõûÂÄôË®∫‰∏≠
                    appointment.status = 'waiting';
                    delete appointment.consultationStartTime;
                    delete appointment.consultingDoctor;
                    
                    // ‰øùÂ≠òÁãÄÊÖãËÆäÊõ¥
                    localStorage.setItem('appointments', JSON.stringify(appointments));
                    
                    showToast(`Â∑≤ÂèñÊ∂à ${patient.name} ÁöÑË®∫ÁóáÔºåÁóÖ‰∫∫ÂõûÂà∞ÂÄôË®∫ÁãÄÊÖã`, 'info');
                    
                    // ÈóúÈñâË°®ÂñÆ‰∏¶Ê∏ÖÁêÜ
                    closeConsultationForm();
                    currentConsultingAppointmentId = null;
                    loadTodayAppointments();
                }
            } else if (appointment.status === 'completed') {
                // Â¶ÇÊûúÊòØÂ∑≤ÂÆåÊàêÁöÑË®∫ÁóáÔºåÂè™ÊòØÈóúÈñâÁ∑®ËºØÊ®°Âºè
                showToast('Â∑≤ÈÄÄÂá∫ÁóÖÊ≠∑Á∑®ËºØÊ®°Âºè', 'info');
                closeConsultationForm();
                currentConsultingAppointmentId = null;
            } else {
                // ÂÖ∂‰ªñÁãÄÊÖãÁõ¥Êé•ÈóúÈñâ
                closeConsultationForm();
                currentConsultingAppointmentId = null;
            }
        }
        
        // ÂÑ≤Â≠òË®∫ÁóáË®òÈåÑÔºàÈÜ´Â∏´Êìç‰ΩúÔºâ
        function saveConsultation() {
            if (!currentConsultingAppointmentId) {
                showToast('Á≥ªÁµ±ÈåØË™§ÔºöÊâæ‰∏çÂà∞Ë®∫ÁóáË®òÈåÑÔºÅ', 'error');
                return;
            }
            
            const appointment = appointments.find(apt => apt.id === currentConsultingAppointmentId);
            if (!appointment) {
                showToast('Êâæ‰∏çÂà∞ÊéõËôüË®òÈåÑÔºÅ', 'error');
                return;
            }
            
            const symptoms = document.getElementById('formSymptoms').value.trim();
            const diagnosis = document.getElementById('formDiagnosis').value.trim();
            const syndrome = document.getElementById('formSyndrome').value.trim();
            const prescription = document.getElementById('formPrescription').value.trim();
            
            if (!symptoms || !diagnosis) {
                showToast('Ë´ãÂ°´ÂØ´ÂøÖÂ°´Ê¨Ñ‰ΩçÔºö‰∏ªË®¥„ÄÅ‰∏≠ÈÜ´Ë®∫Êñ∑ÔºÅ', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            
            // Ê™¢Êü•ÊòØÂê¶ÁÇ∫‰øÆÊîπÁóÖÊ≠∑Ê®°Âºè
            if (appointment.status === 'completed' && appointment.consultationId) {
                // ‰øÆÊîπÁèæÊúâÁóÖÊ≠∑
                const existingConsultation = consultations.find(c => c.id === appointment.consultationId);
                if (existingConsultation) {
                    existingConsultation.symptoms = symptoms;
                    existingConsultation.tongue = document.getElementById('formTongue').value.trim();
                    existingConsultation.pulse = document.getElementById('formPulse').value.trim();
                    existingConsultation.currentHistory = document.getElementById('formCurrentHistory').value.trim();
                    existingConsultation.diagnosis = diagnosis;
                    existingConsultation.syndrome = syndrome;
                    existingConsultation.acupunctureNotes = document.getElementById('formAcupunctureNotes').value.trim();
                    
                    // ËôïÊñπÂÖßÂÆπÁõ¥Êé•‰ΩøÁî®Ë°®ÂñÆ‰∏≠ÁöÑÂÖßÂÆπÔºàÂåÖÂê´ÁèæÊúâËôïÊñπÂíåÊñ∞Ê∑ªÂä†ÁöÑÈ†ÖÁõÆÔºâ
                    existingConsultation.prescription = prescription;
                    
                    existingConsultation.usage = document.getElementById('formUsage').value.trim();
                    existingConsultation.treatmentCourse = document.getElementById('formTreatmentCourse').value.trim();
                    existingConsultation.instructions = document.getElementById('formInstructions').value.trim();
                    existingConsultation.followUpDate = document.getElementById('formFollowUpDate').value;
                    existingConsultation.billingItems = document.getElementById('formBillingItems').value.trim();
                    existingConsultation.updatedAt = new Date().toISOString();
                    existingConsultation.updatedBy = currentUserData ? currentUserData.username : currentUser;
                    
                    localStorage.setItem('consultations', JSON.stringify(consultations));
                    showToast(`${patient.name} ÁöÑÁóÖÊ≠∑Â∑≤ÊàêÂäüÊõ¥Êñ∞ÔºÅ`, 'success');
                }
            } else if (appointment.status === 'consulting') {
                // Êñ∞Â¢ûË®∫ÁóáË®òÈåÑ
                const consultation = {
                    id: Date.now(),
                    appointmentId: currentConsultingAppointmentId,
                    patientId: appointment.patientId,
                    symptoms: symptoms,
                    tongue: document.getElementById('formTongue').value.trim(),
                    pulse: document.getElementById('formPulse').value.trim(),
                    currentHistory: document.getElementById('formCurrentHistory').value.trim(),
                    diagnosis: diagnosis,
                    syndrome: syndrome,
                    acupunctureNotes: document.getElementById('formAcupunctureNotes').value.trim(),
                    prescription: prescription,
                    usage: document.getElementById('formUsage').value.trim(),
                    treatmentCourse: document.getElementById('formTreatmentCourse').value.trim(),
                    instructions: document.getElementById('formInstructions').value.trim(),
                    followUpDate: document.getElementById('formFollowUpDate').value,
                    billingItems: document.getElementById('formBillingItems').value.trim(),
                    date: new Date().toISOString(),
                    doctor: currentUserData ? currentUserData.username : currentUser,
                    status: 'completed'
                };
                
                consultations.push(consultation);
                localStorage.setItem('consultations', JSON.stringify(consultations));
                
                // Êõ¥Êñ∞ÊéõËôüÁãÄÊÖãÁÇ∫Â∑≤ÂÆåÊàê
                appointment.status = 'completed';
                appointment.completedAt = new Date().toISOString();
                appointment.consultationId = consultation.id;
                appointment.completedBy = currentUserData ? currentUserData.username : currentUser;
                localStorage.setItem('appointments', JSON.stringify(appointments));
                
                showToast(`${patient.name} ÁöÑË®∫ÁóáË®òÈåÑÂ∑≤ÂÆåÊàê‰∏¶‰øùÂ≠òÔºÅ`, 'success');
            } else {
                showToast('Âè™ËÉΩ‰øùÂ≠òË®∫Áóá‰∏≠ÁãÄÊÖãÁöÑË®òÈåÑÊàñ‰øÆÊîπÂ∑≤ÂÆåÊàêÁöÑÁóÖÊ≠∑ÔºÅ', 'warning');
                return;
            }
            
            closeConsultationForm();
            loadTodayAppointments();
            updateStatistics();
            
            // Ê∏ÖÁ©∫ÊêúÂ∞ãÊ¨Ñ‰Ωç
            clearAllSearchFields();
        }
        

        
        // ÁóÖ‰∫∫Ë≥áÊñôÁÆ°ÁêÜÈ†ÅÈù¢ÁöÑÁóÖÊ≠∑Êü•ÁúãÂäüËÉΩ
        let currentPatientConsultations = [];
        let currentPatientHistoryPage = 0;
        
        function showPatientMedicalHistory(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) {
                showToast('Êâæ‰∏çÂà∞ÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
                return;
            }
            
            // Áç≤ÂèñË©≤ÁóÖ‰∫∫ÁöÑÊâÄÊúâË®∫ÁóáË®òÈåÑ
            currentPatientConsultations = consultations
                .filter(c => c.patientId === patientId)
                .sort((a, b) => new Date(a.date) - new Date(b.date)); // ÊåâÊó•ÊúüÂçáÂ∫èÊéíÂàóÔºàËºÉËàäËá≥ËºÉÊñ∞Ôºâ
            
            // È†êË®≠È°ØÁ§∫ÊúÄÊñ∞ÁöÑÁóÖÊ≠∑ÔºàÊúÄËøë‰∏ÄÊ¨°Ë®∫ÁóáÔºâ
            currentPatientHistoryPage = currentPatientConsultations.length - 1;
            
            // Ë®≠ÁΩÆÊ®ôÈ°å
            document.getElementById('patientMedicalHistoryTitle').textContent = `${patient.name} ÁöÑÁóÖÊ≠∑Ë®òÈåÑ`;
            
            // È°ØÁ§∫ÁóÖ‰∫∫Âü∫Êú¨Ë≥áË®ä
            document.getElementById('patientMedicalHistoryPatientInfo').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
                    <div>
                        <span class="font-medium text-gray-700">ÁóÖ‰∫∫Á∑®ËôüÔºö</span>
                        <span class="text-blue-600 font-semibold">${patient.patientNumber}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">ÂßìÂêçÔºö</span>
                        <span class="font-semibold">${patient.name}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">Âπ¥ÈΩ°Ôºö</span>
                        <span>${formatAge(patient.birthDate)}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">ÊÄßÂà•Ôºö</span>
                        <span>${patient.gender}</span>
                    </div>
                    ${patient.allergies ? `
                    <div class="md:col-span-4">
                        <span class="font-medium text-red-600">ÈÅéÊïèÂè≤Ôºö</span>
                        <span class="text-red-700 bg-red-50 px-2 py-1 rounded">${patient.allergies}</span>
                    </div>
                    ` : ''}
                </div>
            `;
            
            // È°ØÁ§∫ÂàÜÈ†ÅÁóÖÊ≠∑Ë®òÈåÑ
            displayPatientMedicalHistoryPage();
            
            document.getElementById('patientMedicalHistoryModal').classList.remove('hidden');
        }
        
        function displayPatientMedicalHistoryPage() {
            const contentDiv = document.getElementById('patientMedicalHistoryContent');
            
            if (currentPatientConsultations.length === 0) {
                contentDiv.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-4xl mb-4">üìã</div>
                        <div class="text-lg font-medium mb-2">Êö´ÁÑ°Ë®∫ÁóáË®òÈåÑ</div>
                        <div class="text-sm">Ë©≤ÁóÖ‰∫∫Â∞öÊú™ÊúâË®∫ÁóáË®òÈåÑ</div>
                    </div>
                `;
                return;
            }
            
            const consultation = currentPatientConsultations[currentPatientHistoryPage];
            const totalPages = currentPatientConsultations.length;
            const currentPageNumber = currentPatientHistoryPage + 1;
            const consultationNumber = currentPatientHistoryPage + 1;
            
            contentDiv.innerHTML = `
                <!-- ÂàÜÈ†ÅÂ∞éËà™ -->
                <div class="mb-6 flex justify-between items-center bg-gray-50 rounded-lg p-4">
                    <div class="flex items-center space-x-4">
                        <h4 class="text-lg font-semibold text-gray-800">Ë®∫ÁóáË®òÈåÑ</h4>
                        <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                            Á¨¨ ${consultationNumber} Ê¨°Ë®∫Áóá
                        </span>
                        <span class="text-sm text-gray-600">
                            ÂÖ± ${totalPages} Ê¨°Ë®∫ÁóáË®òÈåÑ
                        </span>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <button onclick="changePatientHistoryPage(-1)" 
                                ${currentPatientHistoryPage === 0 ? 'disabled' : ''}
                                class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-sm">
                            ‚Üê ËºÉËàä
                        </button>
                        <span class="text-sm text-gray-600 px-2">
                            ${currentPageNumber} / ${totalPages}
                        </span>
                        <button onclick="changePatientHistoryPage(1)" 
                                ${currentPatientHistoryPage === totalPages - 1 ? 'disabled' : ''}
                                class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-sm">
                            ËºÉÊñ∞ ‚Üí
                        </button>
                    </div>
                </div>
                
                <!-- Áï∂ÂâçÁóÖÊ≠∑Ë®òÈåÑ -->
                <div class="border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                    <div class="bg-gradient-to-r from-gray-50 to-blue-50 px-6 py-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center space-x-4">
                                <span class="font-semibold text-gray-900 text-lg">
                                    ${new Date(consultation.date).toLocaleDateString('zh-TW')} 
                                    ${new Date(consultation.date).toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'})}
                                </span>
                                <span class="text-sm text-gray-600 bg-white px-3 py-1 rounded">
                                    ÈÜ´Â∏´Ôºö${getDoctorDisplayName(consultation.doctor)}
                                </span>
                                ${consultation.updatedAt ? `
                                    <span class="text-xs text-orange-600 bg-orange-50 px-2 py-1 rounded">
                                        Â∑≤‰øÆÊîπ
                                    </span>
                                ` : ''}
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="printConsultationRecord(${consultation.id})" 
                                        class="text-green-600 hover:text-green-800 text-sm font-medium bg-green-50 px-3 py-2 rounded">
                                    üìÑ ÂàóÂç∞
                                </button>
                                ${(() => {
                                    // Ê™¢Êü•ÊòØÂê¶Ê≠£Âú®Ë®∫Áóá‰∏îÁÇ∫Áõ∏ÂêåÁóÖ‰∫∫
                                    if (currentConsultingAppointmentId) {
                                        const currentAppointment = appointments.find(apt => apt.id === currentConsultingAppointmentId);
                                        if (currentAppointment && currentAppointment.patientId === consultation.patientId) {
                                            return `
                                                <button onclick="loadMedicalRecordToCurrentConsultation(${consultation.id})" 
                                                        class="text-blue-600 hover:text-blue-800 text-sm font-medium bg-blue-50 px-3 py-2 rounded">
                                                    üìã ËºâÂÖ•ÁóÖÊ≠∑
                                                </button>
                                            `;
                                        }
                                    }
                                    return '';
                                })()}
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="space-y-4">
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">‰∏ªË®¥</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.symptoms || 'ÁÑ°Ë®òÈåÑ'}</div>
                                </div>
                                
                                ${consultation.tongue ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ËàåË±°</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.tongue}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.pulse ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ËÑàË±°</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.pulse}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.currentHistory ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ÁèæÁóÖÂè≤</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.currentHistory}</div>
                                </div>
                                ` : ''}
                                
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">‰∏≠ÈÜ´Ë®∫Êñ∑</span>
                                    <div class="bg-green-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-green-400">${consultation.diagnosis || 'ÁÑ°Ë®òÈåÑ'}</div>
                                </div>
                                
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">Ë≠âÂûãË®∫Êñ∑</span>
                                    <div class="bg-blue-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-blue-400">${consultation.syndrome || 'ÁÑ°Ë®òÈåÑ'}</div>
                                </div>
                                
                                ${consultation.acupunctureNotes ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ÈáùÁÅ∏ÂÇôË®ª</span>
                                    <div class="bg-orange-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-orange-400">${consultation.acupunctureNotes}</div>
                                </div>
                                ` : ''}
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ËôïÊñπÂÖßÂÆπ</span>
                                    <div class="bg-yellow-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-yellow-400 whitespace-pre-line">${consultation.prescription || 'ÁÑ°Ë®òÈåÑ'}</div>
                                </div>
                                
                                ${consultation.usage ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ÊúçÁî®ÊñπÊ≥ï</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.usage}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.treatmentCourse ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ÁôÇÁ®ã</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.treatmentCourse}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.instructions ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ÈÜ´ÂõëÂèäÊ≥®ÊÑè‰∫ãÈ†Ö</span>
                                    <div class="bg-red-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-red-400">${consultation.instructions}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.followUpDate ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">Ë§áË®∫ÊôÇÈñì</span>
                                    <div class="bg-purple-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-purple-400">${new Date(consultation.followUpDate).toLocaleString('zh-TW')}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.billingItems ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">Êî∂Ë≤ªÈ†ÖÁõÆ</span>
                                    <div class="bg-green-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-green-400 whitespace-pre-line">${consultation.billingItems}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function changePatientHistoryPage(direction) {
            const newPage = currentPatientHistoryPage + direction;
            if (newPage >= 0 && newPage < currentPatientConsultations.length) {
                currentPatientHistoryPage = newPage;
                displayPatientMedicalHistoryPage();
            }
        }

        // ÈóúÈñâÁóÖ‰∫∫ÁóÖÊ≠∑Êü•ÁúãÂΩàÁ™ó
        function closePatientMedicalHistoryModal() {
            document.getElementById('patientMedicalHistoryModal').classList.add('hidden');
        }



        // Ë®∫ÁóáÁ≥ªÁµ±‰∏≠ÁöÑÁóÖÊ≠∑Êü•ÁúãÂäüËÉΩ
        let currentConsultationConsultations = [];
        let currentConsultationHistoryPage = 0;
        
        function viewPatientMedicalHistory(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) {
                showToast('Êâæ‰∏çÂà∞ÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
                return;
            }
            
            // Áç≤ÂèñË©≤ÁóÖ‰∫∫ÁöÑÊâÄÊúâË®∫ÁóáË®òÈåÑ
            currentConsultationConsultations = consultations
                .filter(c => c.patientId === patientId)
                .sort((a, b) => new Date(a.date) - new Date(b.date)); // ÊåâÊó•ÊúüÂçáÂ∫èÊéíÂàóÔºàËºÉËàäËá≥ËºÉÊñ∞Ôºâ
            
            // È†êË®≠È°ØÁ§∫ÊúÄÊñ∞ÁöÑÁóÖÊ≠∑ÔºàÊúÄËøë‰∏ÄÊ¨°Ë®∫ÁóáÔºâ
            currentConsultationHistoryPage = currentConsultationConsultations.length - 1;
            
            // Ë®≠ÁΩÆÊ®ôÈ°å
            document.getElementById('medicalHistoryTitle').textContent = `${patient.name} ÁöÑË®∫ÁóáË®òÈåÑ`;
            
            // È°ØÁ§∫ÁóÖ‰∫∫Âü∫Êú¨Ë≥áË®ä
            document.getElementById('medicalHistoryPatientInfo').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
                    <div>
                        <span class="font-medium text-gray-700">ÁóÖ‰∫∫Á∑®ËôüÔºö</span>
                        <span class="text-blue-600 font-semibold">${patient.patientNumber}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">ÂßìÂêçÔºö</span>
                        <span class="font-semibold">${patient.name}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">Âπ¥ÈΩ°Ôºö</span>
                        <span>${formatAge(patient.birthDate)}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">ÊÄßÂà•Ôºö</span>
                        <span>${patient.gender}</span>
                    </div>
                    ${patient.allergies ? `
                    <div class="md:col-span-4">
                        <span class="font-medium text-red-600">ÈÅéÊïèÂè≤Ôºö</span>
                        <span class="text-red-700 bg-red-50 px-2 py-1 rounded">${patient.allergies}</span>
                    </div>
                    ` : ''}
                </div>
            `;
            
            // È°ØÁ§∫ÂàÜÈ†ÅÁóÖÊ≠∑Ë®òÈåÑ
            displayConsultationMedicalHistoryPage();
            
            document.getElementById('medicalHistoryModal').classList.remove('hidden');
        }
        
        function displayConsultationMedicalHistoryPage() {
            const contentDiv = document.getElementById('medicalHistoryContent');
            
            if (currentConsultationConsultations.length === 0) {
                contentDiv.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-4xl mb-4">üìã</div>
                        <div class="text-lg font-medium mb-2">Êö´ÁÑ°Ë®∫ÁóáË®òÈåÑ</div>
                        <div class="text-sm">Ë©≤ÁóÖ‰∫∫Â∞öÊú™ÊúâË®∫ÁóáË®òÈåÑ</div>
                    </div>
                `;
                return;
            }
            
            const consultation = currentConsultationConsultations[currentConsultationHistoryPage];
            const totalPages = currentConsultationConsultations.length;
            const currentPageNumber = currentConsultationHistoryPage + 1;
            const consultationNumber = currentConsultationHistoryPage + 1;
            
            contentDiv.innerHTML = `
                <!-- ÂàÜÈ†ÅÂ∞éËà™ -->
                <div class="mb-6 flex justify-between items-center bg-gray-50 rounded-lg p-4">
                    <div class="flex items-center space-x-4">
                        <h4 class="text-lg font-semibold text-gray-800">Ë®∫ÁóáË®òÈåÑ</h4>
                        <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                            Á¨¨ ${consultationNumber} Ê¨°Ë®∫Áóá
                        </span>
                        <span class="text-sm text-gray-600">
                            ÂÖ± ${totalPages} Ê¨°Ë®∫ÁóáË®òÈåÑ
                        </span>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <button onclick="changeConsultationHistoryPage(-1)" 
                                ${currentConsultationHistoryPage === 0 ? 'disabled' : ''}
                                class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-sm">
                            ‚Üê ËºÉËàä
                        </button>
                        <span class="text-sm text-gray-600 px-2">
                            ${currentPageNumber} / ${totalPages}
                        </span>
                        <button onclick="changeConsultationHistoryPage(1)" 
                                ${currentConsultationHistoryPage === totalPages - 1 ? 'disabled' : ''}
                                class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-sm">
                            ËºÉÊñ∞ ‚Üí
                        </button>
                    </div>
                </div>
                
                <!-- Áï∂ÂâçÁóÖÊ≠∑Ë®òÈåÑ -->
                <div class="border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                    <div class="bg-gradient-to-r from-gray-50 to-blue-50 px-6 py-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center space-x-4">
                                <span class="font-semibold text-gray-900 text-lg">
                                    ${new Date(consultation.date).toLocaleDateString('zh-TW')} 
                                    ${new Date(consultation.date).toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'})}
                                </span>
                                <span class="text-sm text-gray-600 bg-white px-3 py-1 rounded">
                                    ÈÜ´Â∏´Ôºö${getDoctorDisplayName(consultation.doctor)}
                                </span>
                                ${consultation.updatedAt ? `
                                    <span class="text-xs text-orange-600 bg-orange-50 px-2 py-1 rounded">
                                        Â∑≤‰øÆÊîπ
                                    </span>
                                ` : ''}
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="printConsultationRecord(${consultation.id})" 
                                        class="text-green-600 hover:text-green-800 text-sm font-medium bg-green-50 px-3 py-2 rounded">
                                    üìÑ ÂàóÂç∞
                                </button>
                                ${(() => {
                                    // Ê™¢Êü•ÊòØÂê¶Ê≠£Âú®Ë®∫Áóá‰∏îÁÇ∫Áõ∏ÂêåÁóÖ‰∫∫
                                    if (currentConsultingAppointmentId) {
                                        const currentAppointment = appointments.find(apt => apt.id === currentConsultingAppointmentId);
                                        if (currentAppointment && currentAppointment.patientId === consultation.patientId) {
                                            return `
                                                <button onclick="loadMedicalRecordToCurrentConsultation(${consultation.id})" 
                                                        class="text-blue-600 hover:text-blue-800 text-sm font-medium bg-blue-50 px-3 py-2 rounded">
                                                    üìã ËºâÂÖ•ÁóÖÊ≠∑
                                                </button>
                                            `;
                                        }
                                    }
                                    return '';
                                })()}
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="space-y-4">
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">‰∏ªË®¥</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.symptoms || 'ÁÑ°Ë®òÈåÑ'}</div>
                                </div>
                                
                                ${consultation.tongue ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ËàåË±°</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.tongue}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.pulse ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ËÑàË±°</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.pulse}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.currentHistory ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ÁèæÁóÖÂè≤</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.currentHistory}</div>
                                </div>
                                ` : ''}
                                
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">‰∏≠ÈÜ´Ë®∫Êñ∑</span>
                                    <div class="bg-green-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-green-400">${consultation.diagnosis || 'ÁÑ°Ë®òÈåÑ'}</div>
                                </div>
                                
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">Ë≠âÂûãË®∫Êñ∑</span>
                                    <div class="bg-blue-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-blue-400">${consultation.syndrome || 'ÁÑ°Ë®òÈåÑ'}</div>
                                </div>
                                
                                ${consultation.acupunctureNotes ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ÈáùÁÅ∏ÂÇôË®ª</span>
                                    <div class="bg-orange-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-orange-400">${consultation.acupunctureNotes}</div>
                                </div>
                                ` : ''}
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ËôïÊñπÂÖßÂÆπ</span>
                                    <div class="bg-yellow-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-yellow-400 whitespace-pre-line">${consultation.prescription || 'ÁÑ°Ë®òÈåÑ'}</div>
                                </div>
                                
                                ${consultation.usage ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ÊúçÁî®ÊñπÊ≥ï</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.usage}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.treatmentCourse ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ÁôÇÁ®ã</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.treatmentCourse}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.instructions ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ÈÜ´ÂõëÂèäÊ≥®ÊÑè‰∫ãÈ†Ö</span>
                                    <div class="bg-red-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-red-400">${consultation.instructions}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.followUpDate ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">Ë§áË®∫ÊôÇÈñì</span>
                                    <div class="bg-purple-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-purple-400">${new Date(consultation.followUpDate).toLocaleString('zh-TW')}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.billingItems ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">Êî∂Ë≤ªÈ†ÖÁõÆ</span>
                                    <div class="bg-green-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-green-400 whitespace-pre-line">${consultation.billingItems}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function changeConsultationHistoryPage(direction) {
            const newPage = currentConsultationHistoryPage + direction;
            if (newPage >= 0 && newPage < currentConsultationConsultations.length) {
                currentConsultationHistoryPage = newPage;
                displayConsultationMedicalHistoryPage();
            }
        }
        
        // ÈóúÈñâË®∫ÁóáË®òÈåÑÂΩàÁ™ó
        function closeMedicalHistoryModal() {
            document.getElementById('medicalHistoryModal').classList.add('hidden');
        }
        

        
        // ÂæûÊéõËôüË®òÈåÑÂàóÂç∞Êî∂Êìö
        function printReceiptFromAppointment(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) {
                showToast('Êâæ‰∏çÂà∞ÊéõËôüË®òÈåÑÔºÅ', 'error');
                return;
            }
            
            if (appointment.status !== 'completed' || !appointment.consultationId) {
                showToast('Âè™ËÉΩÂàóÂç∞Â∑≤ÂÆåÊàêË®∫ÁóáÁöÑÊî∂ÊìöÔºÅ', 'error');
                return;
            }
            
            const consultation = consultations.find(c => c.id === appointment.consultationId);
            if (!consultation) {
                showToast('Êâæ‰∏çÂà∞Â∞çÊáâÁöÑË®∫ÁóáË®òÈåÑÔºÅ', 'error');
                return;
            }
            
            // Áõ¥Êé•Ë™øÁî®ÁèæÊúâÁöÑÂàóÂç∞ÂäüËÉΩ
            printConsultationRecord(consultation.id);
        }
        
        // ÂàóÂç∞Ë®∫ÁóáË®òÈåÑ
        function printConsultationRecord(consultationId) {
            const consultation = consultations.find(c => c.id === consultationId);
            if (!consultation) {
                showToast('Êâæ‰∏çÂà∞Ë®∫ÁóáË®òÈåÑÔºÅ', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === consultation.patientId);
            if (!patient) {
                showToast('Êâæ‰∏çÂà∞ÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
                return;
            }
            
            // Ëß£ÊûêÊî∂Ë≤ªÈ†ÖÁõÆ‰ª•Ë®àÁÆóÁ∏ΩÈáëÈ°ç
            let totalAmount = 0;
            let billingItemsHtml = '';
            if (consultation.billingItems) {
                const lines = consultation.billingItems.split('\n');
                lines.forEach(line => {
                    if (line.includes('=') && line.includes('$')) {
                        const match = line.match(/\$(\d+)/);
                        if (match) {
                            totalAmount += parseInt(match[1]);
                        }
                        billingItemsHtml += `<tr><td style="padding: 5px; border-bottom: 1px dotted #ccc;">${line}</td></tr>`;
                    } else if (line.includes('Á∏ΩË≤ªÁî®')) {
                        const match = line.match(/\$(\d+)/);
                        if (match) {
                            totalAmount = parseInt(match[1]);
                        }
                    }
                });
            }
            
            // ÂâµÂª∫‰∏≠ÈÜ´Ë®∫ÊâÄÊî∂ÊìöÊ†ºÂºè
            const printContent = `
                <!DOCTYPE html>
                <html lang="zh-TW">
                <head>
                    <meta charset="UTF-8">
                    <title>Êî∂Êìö - ${patient.name}</title>
                    <style>
                        body { 
                            font-family: 'Microsoft JhengHei', 'ÂæÆËªüÊ≠£ÈªëÈ´î', sans-serif; 
                            margin: 0; 
                            padding: 20px; 
                            line-height: 1.4;
                            font-size: 14px;
                        }
                        .receipt-container {
                            max-width: 400px;
                            margin: 0 auto;
                            border: 2px solid #000;
                            padding: 15px;
                            background: white;
                        }
                        .clinic-header {
                            text-align: center;
                            border-bottom: 2px double #000;
                            padding-bottom: 10px;
                            margin-bottom: 15px;
                        }
                        .clinic-name {
                            font-size: 20px;
                            font-weight: bold;
                            margin-bottom: 3px;
                            letter-spacing: 2px;
                        }
                        .clinic-subtitle {
                            font-size: 12px;
                            color: #666;
                            margin-bottom: 5px;
                        }
                        .receipt-title {
                            font-size: 18px;
                            font-weight: bold;
                            text-align: center;
                            margin: 10px 0;
                            letter-spacing: 3px;
                        }
                        .receipt-info {
                            margin-bottom: 15px;
                        }
                        .info-row {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 5px;
                            font-size: 13px;
                        }
                        .info-label {
                            font-weight: bold;
                        }
                        .items-section {
                            border-top: 1px solid #000;
                            border-bottom: 1px solid #000;
                            padding: 10px 0;
                            margin: 15px 0;
                        }
                        .items-title {
                            font-weight: bold;
                            text-align: center;
                            margin-bottom: 10px;
                            font-size: 15px;
                        }
                        .items-table {
                            width: 100%;
                            font-size: 13px;
                        }
                        .items-table td {
                            padding: 3px 5px;
                            border-bottom: 1px dotted #999;
                        }
                        .total-section {
                            text-align: right;
                            margin: 15px 0;
                            font-size: 16px;
                            font-weight: bold;
                        }
                        .total-amount {
                            font-size: 10px;
                            color: #000;
                            border: 2px solid #000;
                            padding: 8px;
                            display: inline-block;
                            min-width: 100px;
                            text-align: center;
                        }
                        .prescription-section {
                            margin: 15px 0;
                            border-top: 1px dashed #666;
                            padding-top: 10px;
                        }
                        .prescription-title {
                            font-weight: bold;
                            margin-bottom: 8px;
                            font-size: 14px;
                        }
                        .prescription-content {
                            background: #f9f9f9;
                            padding: 8px;
                            border: 1px solid #ddd;
                            font-size: 12px;
                            line-height: 1.3;
                        }
                        .footer-info {
                            margin-top: 20px;
                            border-top: 1px dashed #666;
                            padding-top: 10px;
                            font-size: 11px;
                            color: #666;
                        }
                        .footer-row {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 3px;
                        }
                        .thank-you {
                            text-align: center;
                            margin: 15px 0;
                            font-weight: bold;
                            font-size: 14px;
                        }
                        .diagnosis-section {
                            margin: 10px 0;
                            font-size: 12px;
                        }
                        .diagnosis-title {
                            font-weight: bold;
                            margin-bottom: 5px;
                        }
                        @media print {
                            body { margin: 0; padding: 10px; }
                            .receipt-container { border: 2px solid #000; }
                        }
                    </style>
                </head>
                <body>
                    <div class="receipt-container">
                        <!-- Ë®∫ÊâÄÊ®ôÈ°å -->
                        <div class="clinic-header">
                            <div class="clinic-name">${clinicSettings.chineseName || '‰∏≠ÈÜ´Ë®∫ÊâÄ'}</div>
                            <div class="clinic-subtitle">${clinicSettings.englishName || 'Traditional Chinese Medicine Clinic'}</div>
                            <div class="clinic-subtitle">ÈõªË©±Ôºö${clinicSettings.phone || '(852) 2345-6789'}„ÄÄÂú∞ÂùÄÔºö${clinicSettings.address || 'È¶ôÊ∏Ø‰∏≠Áí∞ÁöáÂêéÂ§ßÈÅì‰∏≠123Ëôü'}</div>
                        </div>
                        
                        <!-- Êî∂ÊìöÊ®ôÈ°å -->
                        <div class="receipt-title">Êî∂„ÄÄÊìö</div>
                        
                        <!-- Âü∫Êú¨Ë≥áË®ä -->
                        <div class="receipt-info">
                            <div class="info-row">
                                <span class="info-label">Êî∂ÊìöÁ∑®ËôüÔºö</span>
                                <span>R${consultation.id.toString().padStart(6, '0')}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ÁóÖ‰∫∫ÂßìÂêçÔºö</span>
                                <span>${patient.name}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ÁóÖÊ≠∑ËôüÁ¢ºÔºö</span>
                                <span>${patient.patientNumber}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Ë®∫ÁôÇÊó•ÊúüÔºö</span>
                                <span>${new Date(consultation.date).toLocaleDateString('zh-TW', {
                                    year: 'numeric',
                                    month: '2-digit',
                                    day: '2-digit'
                                })}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Ë®∫ÁôÇÊôÇÈñìÔºö</span>
                                <span>${new Date(consultation.date).toLocaleTimeString('zh-TW', {
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">‰∏ªÊ≤ªÈÜ´Â∏´Ôºö</span>
                                <span>${getDoctorDisplayName(consultation.doctor)}</span>
                            </div>
                        </div>
                        
                        <!-- Ë®∫Êñ∑Ë≥áË®ä -->
                        ${consultation.diagnosis ? `
                        <div class="diagnosis-section">
                            <div class="diagnosis-title">Ë®∫Êñ∑Ôºö</div>
                            <div>${consultation.diagnosis}</div>
                            ${consultation.syndrome ? `<div>Ë≠âÂûãÔºö${consultation.syndrome}</div>` : ''}
                        </div>
                        ` : ''}
                        
                        <!-- Êî∂Ë≤ªÈ†ÖÁõÆ -->
                        ${consultation.billingItems ? `
                        <div class="items-section">
                            <div class="items-title">Êî∂Ë≤ªÊòéÁ¥∞</div>
                            <table class="items-table">
                                ${billingItemsHtml}
                            </table>
                        </div>
                        ` : ''}
                        
                        <!-- Á∏ΩÈáëÈ°ç -->
                        <div class="total-section">
                            <div style="margin-bottom: 8px; font-size: 10px;">ÊáâÊî∂ÈáëÈ°çÔºö</div>
                            <div class="total-amount">HK$ ${totalAmount.toLocaleString()}</div>
                        </div>
                        
                        <!-- ËôïÊñπË≥áË®ä -->
                        ${consultation.prescription ? `
                        <div class="prescription-section">
                            <div class="prescription-title">üìã ËôïÊñπÂÖßÂÆπ</div>
                            <div class="prescription-content">${consultation.prescription.replace(/\n/g, '<br>')}</div>
                            ${consultation.usage ? `
                            <div style="margin-top: 8px; font-size: 12px;">
                                <strong>ÊúçÁî®ÊñπÊ≥ïÔºö</strong>${consultation.usage}
                            </div>
                            ` : ''}
                        </div>
                        ` : ''}
                        
                        <!-- ÈÜ´Âõë -->
                        ${consultation.instructions ? `
                        <div style="margin: 10px 0; font-size: 12px; background: #fff3cd; padding: 8px; border: 1px solid #ffeaa7;">
                            <strong>‚ö†Ô∏è ÈÜ´ÂõëÂèäÊ≥®ÊÑè‰∫ãÈ†ÖÔºö</strong><br>
                            ${consultation.instructions}
                        </div>
                        ` : ''}
                        
                        <!-- Ë§áË®∫ÊèêÈÜí -->
                        ${consultation.followUpDate ? `
                        <div style="margin: 10px 0; font-size: 12px; background: #e3f2fd; padding: 8px; border: 1px solid #90caf9;">
                            <strong>üìÖ Âª∫Ë≠∞Ë§áË®∫ÊôÇÈñìÔºö</strong><br>
                            ${new Date(consultation.followUpDate).toLocaleString('zh-TW')}
                        </div>
                        ` : ''}
                        
                        <!-- ÊÑüË¨ùË™û -->
                        <div class="thank-you">
                            Ë¨ùË¨ùÊÇ®ÁöÑÂÖâËá®ÔºåÁ•ùÊÇ®Ë∫´È´îÂÅ•Â∫∑ÔºÅ
                        </div>
                        
                        <!-- È†ÅÂ∞æË≥áË®ä -->
                        <div class="footer-info">
                            <div class="footer-row">
                                <span>Êî∂ÊìöÈñãÁ´ãÊôÇÈñìÔºö</span>
                                <span>${new Date().toLocaleString('zh-TW')}</span>
                            </div>
                            <div class="footer-row">
                                <span>Ë®∫ÊâÄÁáüÊ•≠ÊôÇÈñìÔºö</span>
                                <span>${clinicSettings.businessHours || 'ÈÄ±‰∏ÄËá≥ÈÄ±‰∫î 09:00-18:00'}</span>
                            </div>
                            <div class="footer-row">
                                <span>Êú¨Êî∂ÊìöË´ãÂ¶•ÂñÑ‰øùÂ≠ò</span>
                                <span>Â¶ÇÊúâÁñëÂïèË´ãÊ¥ΩÊ´ÉÊ™Ø</span>
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            // ÈñãÂïüÊñ∞Ë¶ñÁ™óÈÄ≤Ë°åÂàóÂç∞
            const printWindow = window.open('', '_blank', 'width=500,height=700');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            
            showToast('‰∏≠ÈÜ´Ë®∫ÊâÄÊî∂ÊìöÂ∑≤Ê∫ñÂÇôÂàóÂç∞ÔºÅ', 'success');
        }

        // Êí§ÂõûË®∫ÁóáÂäüËÉΩ
        function withdrawConsultation(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) {
                showToast('Êâæ‰∏çÂà∞ÊéõËôüË®òÈåÑÔºÅ', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            if (!patient) {
                showToast('Êâæ‰∏çÂà∞ÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
                return;
            }
            
            // Ë©≥Á¥∞ÁãÄÊÖãÊ™¢Êü•
            console.log(`Êí§ÂõûË®∫ÁóáÁãÄÊÖãÊ™¢Êü• - ÁóÖ‰∫∫: ${patient.name}, Áï∂ÂâçÁãÄÊÖã: ${appointment.status}, Ë®∫ÁóáË®òÈåÑID: ${appointment.consultationId}`);
            
            // Âè™ÊúâÂ∑≤ÂÆåÊàêÁöÑË®∫ÁóáÊâçËÉΩÊí§Âõû
            if (appointment.status !== 'completed') {
                const statusNames = {
                    'registered': 'Â∑≤ÊéõËôü',
                    'waiting': 'ÂÄôË®∫‰∏≠',
                    'consulting': 'Ë®∫Áóá‰∏≠'
                };
                const currentStatusName = statusNames[appointment.status] || appointment.status;
                showToast(`ÁÑ°Ê≥ïÊí§ÂõûË®∫ÁóáÔºÅÁóÖ‰∫∫ ${patient.name} ÁõÆÂâçÁãÄÊÖãÁÇ∫„Äå${currentStatusName}„ÄçÔºåÂè™ËÉΩÊí§ÂõûÂ∑≤ÂÆåÊàêÁöÑË®∫Áóá„ÄÇ`, 'warning');
                return;
            }
            
            // Ê™¢Êü•ÊòØÂê¶ÊúâË®∫ÁóáË®òÈåÑ
            if (!appointment.consultationId) {
                showToast(`ÁÑ°Ê≥ïÊí§ÂõûË®∫ÁóáÔºÅÁóÖ‰∫∫ ${patient.name} Ê≤íÊúâÂ∞çÊáâÁöÑË®∫ÁóáË®òÈåÑ„ÄÇ`, 'error');
                return;
            }
            
            const consultation = consultations.find(c => c.id === appointment.consultationId);
            if (!consultation) {
                showToast(`ÁÑ°Ê≥ïÊí§ÂõûË®∫ÁóáÔºÅÊâæ‰∏çÂà∞ÁóÖ‰∫∫ ${patient.name} ÁöÑË®∫ÁóáË®òÈåÑË≥áÊñô„ÄÇ`, 'error');
                return;
            }
            
            // Á¢∫Ë™çÊí§ÂõûÊìç‰Ωú
            const confirmMessage = `Á¢∫ÂÆöË¶ÅÊí§Âõû ${patient.name} ÁöÑË®∫ÁóáÂóéÔºü\n\n` +
                                 `Ê≠§Êìç‰ΩúÂ∞áÊúÉÔºö\n` +
                                 `‚Ä¢ Âà™Èô§Ë©≤Ê¨°Ë®∫ÁóáË®òÈåÑ\n` +
                                 `‚Ä¢ ÁóÖ‰∫∫ÁãÄÊÖãÂõûÂà∞„ÄåÂ∑≤ÊéõËôü„Äç\n` +
                                 `‚Ä¢ ÊâÄÊúâË®∫ÁóáË≥áÊñôÂ∞áÊ∞∏‰πÖÈÅ∫Â§±\n\n` +
                                 `Ë®∫ÁóáÊó•ÊúüÔºö${new Date(consultation.date).toLocaleString('zh-TW')}\n` +
                                 `Ë®∫Êñ∑Ôºö${consultation.diagnosis || 'ÁÑ°Ë®òÈåÑ'}\n\n` +
                                 `Ê≥®ÊÑèÔºöÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ`;
            
            if (confirm(confirmMessage)) {
                // Âà™Èô§Ë®∫ÁóáË®òÈåÑ
                const consultationIndex = consultations.findIndex(c => c.id === appointment.consultationId);
                if (consultationIndex !== -1) {
                    consultations.splice(consultationIndex, 1);
                    localStorage.setItem('consultations', JSON.stringify(consultations));
                }
                
                // Â∞áÊéõËôüÁãÄÊÖãÊîπÂõûÂ∑≤ÊéõËôü
                appointment.status = 'registered';
                delete appointment.completedAt;
                delete appointment.consultationId;
                delete appointment.completedBy;
                delete appointment.consultationStartTime;
                delete appointment.consultingDoctor;
                
                // ‰øùÂ≠òÁãÄÊÖãËÆäÊõ¥
                localStorage.setItem('appointments', JSON.stringify(appointments));
                
                showToast(`Â∑≤Êí§Âõû ${patient.name} ÁöÑË®∫ÁóáÔºåÁóÖ‰∫∫ÁãÄÊÖãÂõûÂà∞Â∑≤ÊéõËôü`, 'success');
                
                // Â¶ÇÊûúÊ≠£Âú®Á∑®ËºØË©≤ÁóÖÊ≠∑ÔºåÂâáÈóúÈñâË°®ÂñÆ
                if (currentConsultingAppointmentId === appointmentId) {
                    closeConsultationForm();
                    currentConsultingAppointmentId = null;
                }
                
                // ÈáçÊñ∞ËºâÂÖ•ÂàóË°®ÂíåÁµ±Ë®à
                loadTodayAppointments();
                updateStatistics();
            }
        }

        // ‰øÆÊîπÁóÖÊ≠∑ÂäüËÉΩ
        function editMedicalRecord(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) {
                showToast('Êâæ‰∏çÂà∞ÊéõËôüË®òÈåÑÔºÅ', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            if (!patient) {
                showToast('Êâæ‰∏çÂà∞ÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
                return;
            }
            
            // Ë©≥Á¥∞ÁãÄÊÖãÊ™¢Êü•
            console.log(`‰øÆÊîπÁóÖÊ≠∑ÁãÄÊÖãÊ™¢Êü• - ÁóÖ‰∫∫: ${patient.name}, Áï∂ÂâçÁãÄÊÖã: ${appointment.status}, Ë®∫ÁóáË®òÈåÑID: ${appointment.consultationId}`);
            
            // Âè™ÊúâÂ∑≤ÂÆåÊàêÁöÑË®∫ÁóáÊâçËÉΩ‰øÆÊîπÁóÖÊ≠∑
            if (appointment.status !== 'completed') {
                const statusNames = {
                    'registered': 'Â∑≤ÊéõËôü',
                    'waiting': 'ÂÄôË®∫‰∏≠',
                    'consulting': 'Ë®∫Áóá‰∏≠'
                };
                const currentStatusName = statusNames[appointment.status] || appointment.status;
                showToast(`ÁÑ°Ê≥ï‰øÆÊîπÁóÖÊ≠∑ÔºÅÁóÖ‰∫∫ ${patient.name} ÁõÆÂâçÁãÄÊÖãÁÇ∫„Äå${currentStatusName}„ÄçÔºåÂè™ËÉΩ‰øÆÊîπÂ∑≤ÂÆåÊàêË®∫ÁóáÁöÑÁóÖÊ≠∑„ÄÇ`, 'warning');
                return;
            }
            
            // Ê™¢Êü•ÊòØÂê¶ÊúâË®∫ÁóáË®òÈåÑ
            if (!appointment.consultationId) {
                showToast(`ÁÑ°Ê≥ï‰øÆÊîπÁóÖÊ≠∑ÔºÅÁóÖ‰∫∫ ${patient.name} Ê≤íÊúâÂ∞çÊáâÁöÑË®∫ÁóáË®òÈåÑ„ÄÇ`, 'error');
                return;
            }
            
            const consultation = consultations.find(c => c.id === appointment.consultationId);
            if (!consultation) {
                showToast(`ÁÑ°Ê≥ï‰øÆÊîπÁóÖÊ≠∑ÔºÅÊâæ‰∏çÂà∞ÁóÖ‰∫∫ ${patient.name} ÁöÑË®∫ÁóáË®òÈåÑË≥áÊñô„ÄÇ`, 'error');
                return;
            }
            
            // Ê™¢Êü•ÊòØÂê¶ÊúâÂÖ∂‰ªñÁóÖ‰∫∫Ê≠£Âú®Ë®∫Áóá‰∏≠
            const consultingAppointment = appointments.find(apt => 
                apt.status === 'consulting' && 
                new Date(apt.appointmentTime).toDateString() === new Date().toDateString()
            );
            
            if (consultingAppointment) {
                const consultingPatient = patients.find(p => p.id === consultingAppointment.patientId);
                const consultingPatientName = consultingPatient ? consultingPatient.name : 'Êú™Áü•ÁóÖ‰∫∫';
                
                if (confirm(`ÁõÆÂâç ${consultingPatientName} Ê≠£Âú®Ë®∫Áóá‰∏≠„ÄÇ\n\nÊòØÂê¶Ë¶ÅÁµêÊùüË©≤ÁóÖ‰∫∫ÁöÑË®∫Áóá‰∏¶ÈñãÂßã‰øÆÊîπ ${patient.name} ÁöÑÁóÖÊ≠∑Ôºü\n\nÊ≥®ÊÑèÔºö${consultingPatientName} ÁöÑÁãÄÊÖãÂ∞áÊîπÂõûÂÄôË®∫‰∏≠„ÄÇ`)) {
                    // ÁµêÊùüÁï∂ÂâçË®∫ÁóáÁöÑÁóÖ‰∫∫
                    consultingAppointment.status = 'waiting';
                    delete consultingAppointment.consultationStartTime;
                    delete consultingAppointment.consultingDoctor;
                    
                    // ÈóúÈñâÂèØËÉΩÈñãÂïüÁöÑË®∫ÁóáË°®ÂñÆ
                    if (currentConsultingAppointmentId === consultingAppointment.id) {
                        closeConsultationForm();
                    }
                    
                    showToast(`Â∑≤ÁµêÊùü ${consultingPatientName} ÁöÑË®∫Áóá`, 'info');
                    localStorage.setItem('appointments', JSON.stringify(appointments));
                } else {
                    return; // Áî®Êà∂ÂèñÊ∂àÊìç‰Ωú
                }
            }
            
            // Ë®≠ÁΩÆÁÇ∫Á∑®ËºØÊ®°Âºè
            currentConsultingAppointmentId = appointmentId;
            showConsultationForm(appointment);
            
            showToast(`ÈÄ≤ÂÖ• ${patient.name} ÁöÑÁóÖÊ≠∑Á∑®ËºØÊ®°Âºè`, 'info');
        }

        // Á≥ªÁµ±ÁÆ°ÁêÜÂäüËÉΩ
        function updateStatistics() {
            document.getElementById('totalPatients').textContent = patients.length;
            
            const today = new Date().toDateString();
            const todayConsultations = consultations.filter(c => 
                new Date(c.date).toDateString() === today
            ).length;
            document.getElementById('todayConsultations').textContent = todayConsultations;
            
            const thisMonth = new Date().getMonth();
            const monthlyConsultations = consultations.filter(c => 
                new Date(c.date).getMonth() === thisMonth
            ).length;
            document.getElementById('monthlyConsultations').textContent = monthlyConsultations;
        }

        function exportData() {
            const data = {
                patients: patients,
                consultations: consultations,
                appointments: appointments,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Ë®∫ÊâÄË≥áÊñô_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Ë≥áÊñôÂåØÂá∫ÂÆåÊàêÔºÅ', 'success');
        }

        function backupData() {
            const backup = {
                patients: patients,
                consultations: consultations,
                appointments: appointments,
                backupDate: new Date().toISOString()
            };
            localStorage.setItem('clinicBackup', JSON.stringify(backup));
            showToast('Ë≥áÊñôÂÇô‰ªΩÂÆåÊàêÔºÅ', 'success');
        }

        function clearData() {
            if (confirm('Ë≠¶ÂëäÔºöÊ≠§Êìç‰ΩúÂ∞áÊ∏ÖÈô§ÊâÄÊúâË≥áÊñôÔºåÁ¢∫ÂÆöË¶ÅÁπºÁ∫åÂóéÔºü')) {
                if (confirm('ÊúÄÂæåÁ¢∫Ë™çÔºöÊâÄÊúâÁóÖ‰∫∫Ë≥áÊñôÂíåË®∫ÁóáË®òÈåÑÂ∞áË¢´Ê∞∏‰πÖÂà™Èô§ÔºÅ')) {
                    localStorage.removeItem('patients');
                    localStorage.removeItem('consultations');
                    localStorage.removeItem('appointments');
                    patients = [];
                    consultations = [];
                    appointments = [];
                    updateStatistics();
                    showToast('ÊâÄÊúâË≥áÊñôÂ∑≤Ê∏ÖÈô§ÔºÅ', 'success');
                }
            }
        }

        // Ë®∫ÊâÄË®≠ÂÆöÁÆ°ÁêÜÂäüËÉΩ
        function showClinicSettingsModal() {
            // ËºâÂÖ•ÁèæÊúâË®≠ÂÆö
            document.getElementById('clinicChineseName').value = clinicSettings.chineseName || '';
            document.getElementById('clinicEnglishName').value = clinicSettings.englishName || '';
            document.getElementById('clinicBusinessHours').value = clinicSettings.businessHours || '';
            document.getElementById('clinicPhone').value = clinicSettings.phone || '';
            document.getElementById('clinicAddress').value = clinicSettings.address || '';
            
            document.getElementById('clinicSettingsModal').classList.remove('hidden');
        }
        
        function hideClinicSettingsModal() {
            document.getElementById('clinicSettingsModal').classList.add('hidden');
        }
        
        function saveClinicSettings() {
            const chineseName = document.getElementById('clinicChineseName').value.trim();
            const englishName = document.getElementById('clinicEnglishName').value.trim();
            const businessHours = document.getElementById('clinicBusinessHours').value.trim();
            const phone = document.getElementById('clinicPhone').value.trim();
            const address = document.getElementById('clinicAddress').value.trim();
            
            if (!chineseName) {
                showToast('Ë´ãËº∏ÂÖ•Ë®∫ÊâÄ‰∏≠ÊñáÂêçÁ®±ÔºÅ', 'error');
                return;
            }
            
            // Êõ¥Êñ∞Ë®∫ÊâÄË®≠ÂÆö
            clinicSettings.chineseName = chineseName;
            clinicSettings.englishName = englishName;
            clinicSettings.businessHours = businessHours;
            clinicSettings.phone = phone;
            clinicSettings.address = address;
            clinicSettings.updatedAt = new Date().toISOString();
            
            // ‰øùÂ≠òÂà∞Êú¨Âú∞ÂÑ≤Â≠ò
            localStorage.setItem('clinicSettings', JSON.stringify(clinicSettings));
            
            // Êõ¥Êñ∞Á≥ªÁµ±ÁÆ°ÁêÜÈ†ÅÈù¢ÁöÑÈ°ØÁ§∫
            updateClinicSettingsDisplay();
            
            hideClinicSettingsModal();
            showToast('Ë®∫ÊâÄË≥áÊñôÂ∑≤ÊàêÂäüÊõ¥Êñ∞ÔºÅ', 'success');
        }
        
        function updateClinicSettingsDisplay() {
            // Êõ¥Êñ∞Á≥ªÁµ±ÁÆ°ÁêÜÈ†ÅÈù¢ÁöÑË®∫ÊâÄË®≠ÂÆöÈ°ØÁ§∫
            const chineseNameSpan = document.getElementById('displayChineseName');
            const englishNameSpan = document.getElementById('displayEnglishName');
            
            if (chineseNameSpan) {
                chineseNameSpan.textContent = clinicSettings.chineseName || '‰∏≠ÈÜ´Ë®∫ÊâÄ';
            }
            if (englishNameSpan) {
                englishNameSpan.textContent = clinicSettings.englishName || 'Traditional Chinese Medicine Clinic';
            }
            
            // Êõ¥Êñ∞ÁôªÂÖ•È†ÅÈù¢ÁöÑË®∫ÊâÄÂêçÁ®±
            const loginTitle = document.getElementById('loginTitle');
            const loginEnglishTitle = document.getElementById('loginEnglishTitle');
            if (loginTitle) {
                loginTitle.textContent = clinicSettings.chineseName || '‰∏≠ÈÜ´Ë®∫ÊâÄ';
            }
            if (loginEnglishTitle) {
                loginEnglishTitle.textContent = clinicSettings.englishName || 'Traditional Chinese Medicine Clinic';
            }
            
            // Êõ¥Êñ∞‰∏ªÈ†ÅÈù¢ÁöÑË®∫ÊâÄÂêçÁ®±
            const systemTitle = document.getElementById('systemTitle');
            const systemEnglishTitle = document.getElementById('systemEnglishTitle');
            if (systemTitle) {
                systemTitle.textContent = clinicSettings.chineseName || '‰∏≠ÈÜ´Ë®∫ÊâÄ';
            }
            if (systemEnglishTitle) {
                systemEnglishTitle.textContent = clinicSettings.englishName || 'Traditional Chinese Medicine Clinic';
            }
            
            // Êõ¥Êñ∞Ê≠°ËøéÈ†ÅÈù¢ÁöÑË®∫ÊâÄÂêçÁ®±
            const welcomeTitle = document.getElementById('welcomeTitle');
            const welcomeEnglishTitle = document.getElementById('welcomeEnglishTitle');
            if (welcomeTitle) {
                welcomeTitle.textContent = `Ê≠°Ëøé‰ΩøÁî®${clinicSettings.chineseName || '‰∏≠ÈÜ´Ë®∫ÊâÄ'}`;
            }
            if (welcomeEnglishTitle) {
                welcomeEnglishTitle.textContent = `Welcome to ${clinicSettings.englishName || 'Traditional Chinese Medicine Clinic'}`;
            }
        }



        // ‰∏≠Ëó•Â∫´ÁÆ°ÁêÜÂäüËÉΩ
        let editingHerbId = null;
        let editingFormulaId = null;
        let currentHerbFilter = 'all';
        
        function loadHerbLibrary() {
            displayHerbLibrary();
            
            // ÊêúÂ∞ãÂäüËÉΩ
            const searchInput = document.getElementById('searchHerb');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    displayHerbLibrary();
                });
            }
        }
        
        function filterHerbLibrary(type) {
            currentHerbFilter = type;
            
            // Êõ¥Êñ∞ÊåâÈàïÊ®£Âºè
            document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                btn.className = 'px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200';
            });
            document.getElementById(`filter-${type}`).className = 'px-4 py-2 rounded-lg text-sm font-medium bg-blue-100 text-blue-800 transition duration-200';
            
            displayHerbLibrary();
        }
        
        function displayHerbLibrary() {
            const searchTerm = document.getElementById('searchHerb').value.toLowerCase();
            const listContainer = document.getElementById('herbLibraryList');
            
            // ÈÅéÊøæË≥áÊñô
            let filteredItems = herbLibrary.filter(item => {
                const matchesSearch = item.name.toLowerCase().includes(searchTerm) ||
                                    (item.alias && item.alias.toLowerCase().includes(searchTerm)) ||
                                    (item.effects && item.effects.toLowerCase().includes(searchTerm));
                
                const matchesFilter = currentHerbFilter === 'all' || item.type === currentHerbFilter;
                
                return matchesSearch && matchesFilter;
            });
            
            if (filteredItems.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-4xl mb-4">üåø</div>
                        <div class="text-lg font-medium mb-2">Ê≤íÊúâÊâæÂà∞Áõ∏ÈóúË≥áÊñô</div>
                        <div class="text-sm">Ë´ãÂòóË©¶ÂÖ∂‰ªñÊêúÂ∞ãÊ¢ù‰ª∂ÊàñÊñ∞Â¢û‰∏≠Ëó•Êùê/ÊñπÂäë</div>
                    </div>
                `;
                return;
            }
            
            // ÊåâÈ°ûÂûãÂàÜÁµÑÈ°ØÁ§∫
            const herbs = filteredItems.filter(item => item.type === 'herb');
            const formulas = filteredItems.filter(item => item.type === 'formula');
            
            let html = '';
            
            if (herbs.length > 0 && (currentHerbFilter === 'all' || currentHerbFilter === 'herb')) {
                html += `
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="mr-2">üåø</span>‰∏≠Ëó•Êùê (${herbs.length})
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${herbs.map(herb => createHerbCard(herb)).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (formulas.length > 0 && (currentHerbFilter === 'all' || currentHerbFilter === 'formula')) {
                html += `
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="mr-2">üìã</span>ÊñπÂäë (${formulas.length})
                        </h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            ${formulas.map(formula => createFormulaCard(formula)).join('')}
                        </div>
                    </div>
                `;
            }
            
            listContainer.innerHTML = html;
        }
        
        function createHerbCard(herb) {
            return `
                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition duration-200">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900">${herb.name}</h4>
                            ${herb.alias ? `<p class="text-sm text-gray-600">${herb.alias}</p>` : ''}
                        </div>
                        <div class="flex space-x-1">
                            <button onclick="editHerb(${herb.id})" class="text-blue-600 hover:text-blue-800 text-sm">Á∑®ËºØ</button>
                            <button onclick="deleteHerbItem(${herb.id})" class="text-red-600 hover:text-red-800 text-sm">Âà™Èô§</button>
                        </div>
                    </div>
                    
                    <div class="space-y-2 text-sm">
                        ${herb.nature ? `<div><span class="font-medium text-gray-700">ÊÄßÂë≥Ôºö</span>${herb.nature}</div>` : ''}
                        ${herb.meridian ? `<div><span class="font-medium text-gray-700">Ê≠∏Á∂ìÔºö</span>${herb.meridian}</div>` : ''}
                        ${herb.effects ? `<div><span class="font-medium text-gray-700">ÂäüÊïàÔºö</span>${herb.effects}</div>` : ''}
                        ${herb.dosage ? `<div><span class="font-medium text-gray-700">ÂäëÈáèÔºö</span><span class="text-blue-600 font-medium">${herb.dosage}</span></div>` : ''}
                        ${herb.cautions ? `<div><span class="font-medium text-red-600">Ê≥®ÊÑèÔºö</span><span class="text-red-700">${herb.cautions}</span></div>` : ''}
                    </div>
                </div>
            `;
        }
        
        function createFormulaCard(formula) {
            return `
                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition duration-200">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900">${formula.name}</h4>
                            ${formula.source ? `<p class="text-sm text-gray-600">Âá∫ËôïÔºö${formula.source}</p>` : ''}
                        </div>
                        <div class="flex space-x-1">
                            <button onclick="editFormula(${formula.id})" class="text-blue-600 hover:text-blue-800 text-sm">Á∑®ËºØ</button>
                            <button onclick="deleteHerbItem(${formula.id})" class="text-red-600 hover:text-red-800 text-sm">Âà™Èô§</button>
                        </div>
                    </div>
                    
                    <div class="space-y-3 text-sm">
                        ${formula.effects ? `<div><span class="font-medium text-gray-700">ÂäüÊïàÔºö</span>${formula.effects}</div>` : ''}
                        ${formula.indications ? `<div><span class="font-medium text-gray-700">‰∏ªÊ≤ªÔºö</span>${formula.indications}</div>` : ''}
                        ${formula.composition ? `
                            <div>
                                <span class="font-medium text-gray-700">ÁµÑÊàêÔºö</span>
                                <div class="mt-1 p-2 bg-yellow-50 rounded text-xs whitespace-pre-line border-l-2 border-yellow-400">${formula.composition}</div>
                            </div>
                        ` : ''}
                        ${formula.usage ? `<div><span class="font-medium text-gray-700">Áî®Ê≥ïÔºö</span>${formula.usage}</div>` : ''}
                        ${formula.cautions ? `<div><span class="font-medium text-red-600">Ê≥®ÊÑèÔºö</span><span class="text-red-700">${formula.cautions}</span></div>` : ''}
                    </div>
                </div>
            `;
        }
        
        // ‰∏≠Ëó•ÊùêË°®ÂñÆÂäüËÉΩ
        function showAddHerbForm() {
            editingHerbId = null;
            document.getElementById('herbFormTitle').textContent = 'Êñ∞Â¢û‰∏≠Ëó•Êùê';
            document.getElementById('herbSaveButtonText').textContent = 'ÂÑ≤Â≠ò';
            clearHerbForm();
            document.getElementById('addHerbModal').classList.remove('hidden');
        }
        
        function hideAddHerbForm() {
            document.getElementById('addHerbModal').classList.add('hidden');
            clearHerbForm();
            editingHerbId = null;
        }
        
        function clearHerbForm() {
            ['herbName', 'herbAlias', 'herbNature', 'herbMeridian', 'herbEffects', 'herbIndications', 'herbDosage', 'herbCautions'].forEach(id => {
                document.getElementById(id).value = '';
            });
        }
        
        function editHerb(id) {
            const herb = herbLibrary.find(item => item.id === id && item.type === 'herb');
            if (!herb) return;
            
            editingHerbId = id;
            document.getElementById('herbFormTitle').textContent = 'Á∑®ËºØ‰∏≠Ëó•Êùê';
            document.getElementById('herbSaveButtonText').textContent = 'Êõ¥Êñ∞';
            
            document.getElementById('herbName').value = herb.name || '';
            document.getElementById('herbAlias').value = herb.alias || '';
            document.getElementById('herbNature').value = herb.nature || '';
            document.getElementById('herbMeridian').value = herb.meridian || '';
            document.getElementById('herbEffects').value = herb.effects || '';
            document.getElementById('herbIndications').value = herb.indications || '';
            document.getElementById('herbDosage').value = herb.dosage || '';
            document.getElementById('herbCautions').value = herb.cautions || '';
            
            document.getElementById('addHerbModal').classList.remove('hidden');
        }
        
        function saveHerb() {
            const name = document.getElementById('herbName').value.trim();
            
            if (!name) {
                showToast('Ë´ãËº∏ÂÖ•‰∏≠Ëó•ÊùêÂêçÁ®±ÔºÅ', 'error');
                return;
            }
            
            const herb = {
                id: editingHerbId || Date.now(),
                type: 'herb',
                name: name,
                alias: document.getElementById('herbAlias').value.trim(),
                nature: document.getElementById('herbNature').value.trim(),
                meridian: document.getElementById('herbMeridian').value.trim(),
                effects: document.getElementById('herbEffects').value.trim(),
                indications: document.getElementById('herbIndications').value.trim(),
                dosage: document.getElementById('herbDosage').value.trim(),
                cautions: document.getElementById('herbCautions').value.trim(),
                createdAt: editingHerbId ? herbLibrary.find(h => h.id === editingHerbId).createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (editingHerbId) {
                const index = herbLibrary.findIndex(item => item.id === editingHerbId);
                herbLibrary[index] = herb;
                showToast('‰∏≠Ëó•ÊùêË≥áÊñôÂ∑≤Êõ¥Êñ∞ÔºÅ', 'success');
            } else {
                herbLibrary.push(herb);
                showToast('‰∏≠Ëó•ÊùêÂ∑≤Êñ∞Â¢ûÔºÅ', 'success');
            }
            
            localStorage.setItem('herbLibrary', JSON.stringify(herbLibrary));
            hideAddHerbForm();
            displayHerbLibrary();
        }
        
        // ÊñπÂäëË°®ÂñÆÂäüËÉΩ
        function showAddFormulaForm() {
            editingFormulaId = null;
            document.getElementById('formulaFormTitle').textContent = 'Êñ∞Â¢ûÊñπÂäë';
            document.getElementById('formulaSaveButtonText').textContent = 'ÂÑ≤Â≠ò';
            clearFormulaForm();
            document.getElementById('addFormulaModal').classList.remove('hidden');
        }
        
        function hideAddFormulaForm() {
            document.getElementById('addFormulaModal').classList.add('hidden');
            clearFormulaForm();
            editingFormulaId = null;
        }
        
        function clearFormulaForm() {
            ['formulaName', 'formulaSource', 'formulaEffects', 'formulaIndications', 'formulaComposition', 'formulaUsage', 'formulaCautions'].forEach(id => {
                document.getElementById(id).value = '';
            });
        }
        
        function editFormula(id) {
            const formula = herbLibrary.find(item => item.id === id && item.type === 'formula');
            if (!formula) return;
            
            editingFormulaId = id;
            document.getElementById('formulaFormTitle').textContent = 'Á∑®ËºØÊñπÂäë';
            document.getElementById('formulaSaveButtonText').textContent = 'Êõ¥Êñ∞';
            
            document.getElementById('formulaName').value = formula.name || '';
            document.getElementById('formulaSource').value = formula.source || '';
            document.getElementById('formulaEffects').value = formula.effects || '';
            document.getElementById('formulaIndications').value = formula.indications || '';
            document.getElementById('formulaComposition').value = formula.composition || '';
            document.getElementById('formulaUsage').value = formula.usage || '';
            document.getElementById('formulaCautions').value = formula.cautions || '';
            
            document.getElementById('addFormulaModal').classList.remove('hidden');
        }
        
        function saveFormula() {
            const name = document.getElementById('formulaName').value.trim();
            const composition = document.getElementById('formulaComposition').value.trim();
            
            if (!name) {
                showToast('Ë´ãËº∏ÂÖ•ÊñπÂäëÂêçÁ®±ÔºÅ', 'error');
                return;
            }
            
            if (!composition) {
                showToast('Ë´ãËº∏ÂÖ•ÊñπÂäëÁµÑÊàêÔºÅ', 'error');
                return;
            }
            
            const formula = {
                id: editingFormulaId || Date.now(),
                type: 'formula',
                name: name,
                source: document.getElementById('formulaSource').value.trim(),
                effects: document.getElementById('formulaEffects').value.trim(),
                indications: document.getElementById('formulaIndications').value.trim(),
                composition: composition,
                usage: document.getElementById('formulaUsage').value.trim(),
                cautions: document.getElementById('formulaCautions').value.trim(),
                createdAt: editingFormulaId ? herbLibrary.find(f => f.id === editingFormulaId).createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (editingFormulaId) {
                const index = herbLibrary.findIndex(item => item.id === editingFormulaId);
                herbLibrary[index] = formula;
                showToast('ÊñπÂäëË≥áÊñôÂ∑≤Êõ¥Êñ∞ÔºÅ', 'success');
            } else {
                herbLibrary.push(formula);
                showToast('ÊñπÂäëÂ∑≤Êñ∞Â¢ûÔºÅ', 'success');
            }
            
            localStorage.setItem('herbLibrary', JSON.stringify(herbLibrary));
            hideAddFormulaForm();
            displayHerbLibrary();
        }
        
        // Âà™Èô§‰∏≠Ëó•ÊùêÊàñÊñπÂäë
        function deleteHerbItem(id) {
            const item = herbLibrary.find(h => h.id === id);
            if (!item) return;
            
            const itemType = item.type === 'herb' ? '‰∏≠Ëó•Êùê' : 'ÊñπÂäë';
            
            if (confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§${itemType}„Äå${item.name}„ÄçÂóéÔºü\n\nÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ`)) {
                herbLibrary = herbLibrary.filter(h => h.id !== id);
                localStorage.setItem('herbLibrary', JSON.stringify(herbLibrary));
                showToast(`${itemType}„Äå${item.name}„ÄçÂ∑≤Âà™Èô§ÔºÅ`, 'success');
                displayHerbLibrary();
            }
        }

        // Êî∂Ë≤ªÈ†ÖÁõÆÁÆ°ÁêÜÂäüËÉΩ
        let editingBillingItemId = null;
        let currentBillingFilter = 'all';
        
        function loadBillingManagement() {
            displayBillingItems();
            
            // ÊêúÂ∞ãÂäüËÉΩ
            const searchInput = document.getElementById('searchBilling');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    displayBillingItems();
                });
            }
        }
        
        function filterBillingItems(category) {
            currentBillingFilter = category;
            
            // Êõ¥Êñ∞ÊåâÈàïÊ®£Âºè
            document.querySelectorAll('[id^="billing-filter-"]').forEach(btn => {
                btn.className = 'px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200';
            });
            document.getElementById(`billing-filter-${category}`).className = 'px-4 py-2 rounded-lg text-sm font-medium bg-blue-100 text-blue-800 transition duration-200';
            
            displayBillingItems();
        }
        
        function displayBillingItems() {
            const searchTerm = document.getElementById('searchBilling').value.toLowerCase();
            const listContainer = document.getElementById('billingItemsList');
            
            // ÈÅéÊøæË≥áÊñô
            let filteredItems = billingItems.filter(item => {
                const matchesSearch = item.name.toLowerCase().includes(searchTerm) ||
                                    (item.description && item.description.toLowerCase().includes(searchTerm));
                
                const matchesFilter = currentBillingFilter === 'all' || item.category === currentBillingFilter;
                
                return matchesSearch && matchesFilter;
            });
            
            if (filteredItems.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-4xl mb-4">üí∞</div>
                        <div class="text-lg font-medium mb-2">Ê≤íÊúâÊâæÂà∞Áõ∏ÈóúÊî∂Ë≤ªÈ†ÖÁõÆ</div>
                        <div class="text-sm">Ë´ãÂòóË©¶ÂÖ∂‰ªñÊêúÂ∞ãÊ¢ù‰ª∂ÊàñÊñ∞Â¢ûÊî∂Ë≤ªÈ†ÖÁõÆ</div>
                    </div>
                `;
                return;
            }
            
            // ÊåâÈ°ûÂà•ÂàÜÁµÑÈ°ØÁ§∫
            const categories = {
                consultation: { name: 'Ë®∫ÁôÇË≤ª', icon: 'ü©∫', items: [] },
                medicine: { name: 'Ëó•Ë≤ª', icon: 'üíä', items: [] },
                treatment: { name: 'Ê≤ªÁôÇË≤ª', icon: 'üîß', items: [] },
                other: { name: 'ÂÖ∂‰ªñ', icon: 'üìã', items: [] },
                discount: { name: 'ÊäòÊâ£È†ÖÁõÆ', icon: 'üí∏', items: [] }
            };
            
            filteredItems.forEach(item => {
                if (categories[item.category]) {
                    categories[item.category].items.push(item);
                }
            });
            
            let html = '';
            
            Object.keys(categories).forEach(categoryKey => {
                const category = categories[categoryKey];
                if (category.items.length > 0 && (currentBillingFilter === 'all' || currentBillingFilter === categoryKey)) {
                    html += `
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="mr-2">${category.icon}</span>${category.name} (${category.items.length})
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${category.items.map(item => createBillingItemCard(item)).join('')}
                            </div>
                        </div>
                    `;
                }
            });
            
            listContainer.innerHTML = html;
        }
        
        function createBillingItemCard(item) {
            const statusClass = item.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
            const statusText = item.active ? 'ÂïüÁî®' : 'ÂÅúÁî®';
            
            // ÊäòÊâ£È†ÖÁõÆ‰ΩøÁî®‰∏çÂêåÁöÑÈ°èËâ≤È°ØÁ§∫
            const priceColor = item.category === 'discount' ? 'text-red-600' : 'text-green-600';
            let pricePrefix = '$';
            let displayPrice = Math.abs(item.price);
            
            // ËôïÁêÜÊäòÊâ£È†ÖÁõÆÁöÑÈ°ØÁ§∫
            if (item.category === 'discount') {
                if (item.price > 0 && item.price < 1) {
                    // ÁôæÂàÜÊØîÊäòÊâ£ (0.9 = 9Êäò)
                    pricePrefix = '';
                    displayPrice = (item.price * 10).toFixed(0);
                } else if (item.price < 0) {
                    // Âõ∫ÂÆöÈáëÈ°çÊäòÊâ£
                    pricePrefix = '-$';
                    displayPrice = Math.abs(item.price);
                }
            }
            
            return `
                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition duration-200 ${!item.active ? 'opacity-75' : ''}">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h4 class="text-lg font-semibold text-gray-900">${item.name}</h4>
                            <div class="flex items-center mt-1">
                                <span class="text-2xl font-bold text-green-600">$${Math.abs(item.price)}</span>
                                ${item.unit ? `<span class="text-sm text-gray-500 ml-1">/ ${item.unit}</span>` : ''}
                            </div>
                        </div>
                        <div class="flex flex-col items-end space-y-2">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                                ${statusText}
                            </span>
                            <div class="flex space-x-1">
                                <button onclick="editBillingItem(${item.id})" class="text-blue-600 hover:text-blue-800 text-sm">Á∑®ËºØ</button>
                                <button onclick="deleteBillingItem(${item.id})" class="text-red-600 hover:text-red-800 text-sm">Âà™Èô§</button>
                            </div>
                        </div>
                    </div>
                    
                    ${item.description ? `
                        <div class="text-sm text-gray-600 bg-gray-50 p-2 rounded">
                            ${item.description}
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        // Êî∂Ë≤ªÈ†ÖÁõÆË°®ÂñÆÂäüËÉΩ
        function showAddBillingItemForm() {
            editingBillingItemId = null;
            document.getElementById('billingItemFormTitle').textContent = 'Êñ∞Â¢ûÊî∂Ë≤ªÈ†ÖÁõÆ';
            document.getElementById('billingItemSaveButtonText').textContent = 'ÂÑ≤Â≠ò';
            clearBillingItemForm();
            document.getElementById('addBillingItemModal').classList.remove('hidden');
        }
        
        function hideAddBillingItemForm() {
            document.getElementById('addBillingItemModal').classList.add('hidden');
            clearBillingItemForm();
            editingBillingItemId = null;
        }
        
        function clearBillingItemForm() {
            document.getElementById('billingItemName').value = '';
            document.getElementById('billingItemCategory').value = '';
            document.getElementById('billingItemPrice').value = '';
            document.getElementById('billingItemUnit').value = '';
            document.getElementById('billingItemDescription').value = '';
            document.getElementById('billingItemActive').checked = true;
        }
        
        function editBillingItem(id) {
            const item = billingItems.find(b => b.id === id);
            if (!item) return;
            
            editingBillingItemId = id;
            document.getElementById('billingItemFormTitle').textContent = 'Á∑®ËºØÊî∂Ë≤ªÈ†ÖÁõÆ';
            document.getElementById('billingItemSaveButtonText').textContent = 'Êõ¥Êñ∞';
            
            document.getElementById('billingItemName').value = item.name || '';
            document.getElementById('billingItemCategory').value = item.category || '';
            document.getElementById('billingItemPrice').value = item.price || '';
            document.getElementById('billingItemUnit').value = item.unit || '';
            document.getElementById('billingItemDescription').value = item.description || '';
            document.getElementById('billingItemActive').checked = item.active !== false;
            
            document.getElementById('addBillingItemModal').classList.remove('hidden');
        }
        
        function saveBillingItem() {
            const name = document.getElementById('billingItemName').value.trim();
            const category = document.getElementById('billingItemCategory').value;
            const price = parseFloat(document.getElementById('billingItemPrice').value);
            
            if (!name) {
                showToast('Ë´ãËº∏ÂÖ•Êî∂Ë≤ªÈ†ÖÁõÆÂêçÁ®±ÔºÅ', 'error');
                return;
            }
            
            if (!category) {
                showToast('Ë´ãÈÅ∏ÊìáÈ†ÖÁõÆÈ°ûÂà•ÔºÅ', 'error');
                return;
            }
            
            if (isNaN(price)) {
                showToast('Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÊî∂Ë≤ªÈáëÈ°çÔºÅ', 'error');
                return;
            }
            
            // ÊäòÊâ£È†ÖÁõÆÂÖÅË®±Ë≤†Êï∏Êàñ0-1‰πãÈñìÁöÑÂ∞èÊï∏ÔºàÁôæÂàÜÊØîÔºâÔºåÂÖ∂‰ªñÈ†ÖÁõÆ‰∏çÂÖÅË®±Ë≤†Êï∏
            if (category !== 'discount' && price < 0) {
                showToast('Èô§ÊäòÊâ£È†ÖÁõÆÂ§ñÔºåÊî∂Ë≤ªÈáëÈ°ç‰∏çËÉΩÁÇ∫Ë≤†Êï∏ÔºÅ', 'error');
                return;
            }
            
            // ÊäòÊâ£È†ÖÁõÆÁöÑÁâπÊÆäÈ©óË≠â
            if (category === 'discount') {
                if (price > 0 && price >= 1 && price <= 10) {
                    // Â¶ÇÊûúËº∏ÂÖ•1-10‰πãÈñìÁöÑÊï∏Â≠óÔºåËá™ÂãïËΩâÊèõÁÇ∫ÊäòÊâ£ÊØî‰æã
                    price = price / 10;
                    document.getElementById('billingItemPrice').value = price;
                    showToast(`Â∑≤Ëá™ÂãïËΩâÊèõÁÇ∫${(price * 100).toFixed(0)}Êäò`, 'info');
                }
            }
            
            const item = {
                id: editingBillingItemId || Date.now(),
                name: name,
                category: category,
                price: price,
                unit: document.getElementById('billingItemUnit').value.trim(),
                description: document.getElementById('billingItemDescription').value.trim(),
                active: document.getElementById('billingItemActive').checked,
                createdAt: editingBillingItemId ? billingItems.find(b => b.id === editingBillingItemId).createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (editingBillingItemId) {
                const index = billingItems.findIndex(b => b.id === editingBillingItemId);
                billingItems[index] = item;
                showToast('Êî∂Ë≤ªÈ†ÖÁõÆÂ∑≤Êõ¥Êñ∞ÔºÅ', 'success');
            } else {
                billingItems.push(item);
                showToast('Êî∂Ë≤ªÈ†ÖÁõÆÂ∑≤Êñ∞Â¢ûÔºÅ', 'success');
            }
            
            localStorage.setItem('billingItems', JSON.stringify(billingItems));
            hideAddBillingItemForm();
            displayBillingItems();
        }
        
        function deleteBillingItem(id) {
            const item = billingItems.find(b => b.id === id);
            if (!item) return;
            
            if (confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§Êî∂Ë≤ªÈ†ÖÁõÆ„Äå${item.name}„ÄçÂóéÔºü\n\nÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ`)) {
                billingItems = billingItems.filter(b => b.id !== id);
                localStorage.setItem('billingItems', JSON.stringify(billingItems));
                showToast(`Êî∂Ë≤ªÈ†ÖÁõÆ„Äå${item.name}„ÄçÂ∑≤Âà™Èô§ÔºÅ`, 'success');
                displayBillingItems();
            }
        }

        // ËôïÊñπÊêúÁ¥¢ÂäüËÉΩ
        function searchHerbsForPrescription() {
            const searchTerm = document.getElementById('prescriptionSearch').value.trim().toLowerCase();
            const resultsContainer = document.getElementById('prescriptionSearchResults');
            const resultsList = document.getElementById('prescriptionSearchList');
            
            if (searchTerm.length < 1) {
                resultsContainer.classList.add('hidden');
                return;
            }
            
            // ÊêúÁ¥¢ÂåπÈÖçÁöÑ‰∏≠Ëó•ÊùêÂíåÊñπÂäë
            const matchedItems = herbLibrary.filter(item => 
                item.name.toLowerCase().includes(searchTerm) ||
                (item.alias && item.alias.toLowerCase().includes(searchTerm)) ||
                (item.effects && item.effects.toLowerCase().includes(searchTerm))
            ).slice(0, 10); // ÈôêÂà∂È°ØÁ§∫Ââç10ÂÄãÁµêÊûú
            
            if (matchedItems.length === 0) {
                resultsList.innerHTML = `
                    <div class="p-3 text-center text-gray-500 text-sm">
                        Êâæ‰∏çÂà∞Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑ‰∏≠Ëó•ÊùêÊàñÊñπÂäë
                    </div>
                `;
                resultsContainer.classList.remove('hidden');
                return;
            }
            
            // È°ØÁ§∫ÊêúÁ¥¢ÁµêÊûú
            resultsList.innerHTML = matchedItems.map(item => {
                const typeName = item.type === 'herb' ? '‰∏≠Ëó•Êùê' : 'ÊñπÂäë';
                const bgColor = item.type === 'herb' ? 'bg-green-50 hover:bg-green-100 border-green-200' : 'bg-blue-50 hover:bg-blue-100 border-blue-200';
                
                return `
                    <div class="p-3 ${bgColor} border rounded-lg cursor-pointer transition duration-200" onclick="addToPrescription('${item.type}', ${item.id})">
                        <div class="text-center">
                            <div class="font-semibold text-gray-900 text-sm mb-1">${item.name}</div>
                            <div class="text-xs bg-white text-gray-600 px-2 py-1 rounded mb-2">${typeName}</div>
                            ${item.type === 'herb' && item.dosage ? `<div class="text-xs text-blue-600 font-medium">${item.dosage}</div>` : ''}
                            ${item.effects ? `<div class="text-xs text-gray-600 mt-1">${item.effects.substring(0, 30)}${item.effects.length > 30 ? '...' : ''}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            resultsContainer.classList.remove('hidden');
        }
        
        // Â≠òÂÑ≤Â∑≤ÈÅ∏ÊìáÁöÑËôïÊñπÈ†ÖÁõÆ
        let selectedPrescriptionItems = [];
        
        // Â≠òÂÑ≤Â∑≤ÈÅ∏ÊìáÁöÑÊî∂Ë≤ªÈ†ÖÁõÆ
        let selectedBillingItems = [];
        
        // Ê∑ªÂä†Âà∞ËôïÊñπÂÖßÂÆπ
        function addToPrescription(type, itemId) {
            const item = herbLibrary.find(h => h.id === itemId);
            if (!item) return;
            
            // Ê™¢Êü•ÊòØÂê¶Â∑≤Á∂ìÊ∑ªÂä†ÈÅé
            const existingIndex = selectedPrescriptionItems.findIndex(p => p.id === itemId);
            if (existingIndex !== -1) {
                showToast(`${item.name} Â∑≤Á∂ìÂú®ËôïÊñπ‰∏≠ÔºÅ`, 'warning');
                return;
            }
            
            // Ê∑ªÂä†Âà∞Â∑≤ÈÅ∏ÊìáÈ†ÖÁõÆ
            const prescriptionItem = {
                id: itemId,
                type: type,
                name: item.name,
                dosage: type === 'herb' ? (item.dosage || '6g') : null,
                customDosage: type === 'herb' ? '6' : null, // È†êË®≠6ÂÖã
                composition: type === 'formula' ? item.composition : null,
                effects: item.effects
            };
            
            selectedPrescriptionItems.push(prescriptionItem);
            
            // Êõ¥Êñ∞È°ØÁ§∫
            updatePrescriptionDisplay();
            
            // Â¶ÇÊûúÊòØÁ¨¨‰∏ÄÂÄãËôïÊñπÈ†ÖÁõÆÔºåËá™ÂãïÊ∑ªÂä†Ëó•Ë≤ª
            if (selectedPrescriptionItems.length === 1) {
                const days = parseInt(document.getElementById('medicationDays').value) || 5;
                updateMedicineFeeByDays(days);
            }
            
            // Ê∏ÖÈô§ÊêúÁ¥¢
            clearPrescriptionSearch();
            
            showToast(`Â∑≤Ê∑ªÂä†${type === 'herb' ? '‰∏≠Ëó•Êùê' : 'ÊñπÂäë'}Ôºö${item.name}`, 'success');
        }
        
        // Êõ¥Êñ∞ËôïÊñπÈ°ØÁ§∫
        function updatePrescriptionDisplay() {
            const container = document.getElementById('selectedPrescriptionItems');
            const hiddenTextarea = document.getElementById('formPrescription');
            const medicationSettings = document.getElementById('medicationSettings');
            
            if (selectedPrescriptionItems.length === 0) {
                container.innerHTML = `
                    <div class="text-sm text-gray-500 text-center py-4">
                        Ë´ã‰ΩøÁî®‰∏äÊñπÊêúÁ¥¢ÂäüËÉΩÊ∑ªÂä†‰∏≠Ëó•ÊùêÊàñÊñπÂäë
                    </div>
                `;
                hiddenTextarea.value = '';
                // Èö±ËóèÊúçËó•Â§©Êï∏Ë®≠ÂÆö
                medicationSettings.style.display = 'none';
                return;
            }
            
            // È°ØÁ§∫ÊúçËó•Â§©Êï∏Ë®≠ÂÆö
            medicationSettings.style.display = 'block';
            
            // È°ØÁ§∫Â∑≤Ê∑ªÂä†ÁöÑÈ†ÖÁõÆ
            const displayHtml = `
                <div class="space-y-3">
                    ${selectedPrescriptionItems.map((item, index) => {
                        const bgColor = item.type === 'herb' ? 'bg-green-50 border-green-200' : 'bg-blue-50 border-blue-200';
                        
                        return `
                            <div class="flex items-center ${bgColor} border rounded-lg p-3">
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-900">${item.name}</div>
                                    ${item.type === 'formula' ? `<div class="text-xs text-gray-600">ÊñπÂäë</div>` : ''}
                                </div>
                                ${item.type === 'herb' ? `
                                    <div class="flex items-center space-x-2 mr-3">
                                        <input type="number" 
                                               value="${item.customDosage || '6'}" 
                                               min="0.5" 
                                               max="100" 
                                               step="0.5"
                                               class="w-16 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500 focus:border-transparent text-center"
                                               onchange="updatePrescriptionDosage(${index}, this.value)"
                                               onclick="this.select()">
                                        <span class="text-sm text-gray-600 font-medium">g</span>
                                    </div>
                                ` : ''}
                                <button onclick="removePrescriptionItem(${index})" class="text-red-500 hover:text-red-700 font-bold text-lg px-2">√ó</button>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                ${selectedPrescriptionItems.some(item => item.type === 'formula') ? `
                    <div class="mt-4 space-y-2">
                        <div class="text-sm font-semibold text-gray-700">ÊñπÂäëÁµÑÊàêÔºö</div>
                        ${selectedPrescriptionItems.filter(item => item.type === 'formula').map(formula => `
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                <div class="font-semibold text-gray-900 mb-2">${formula.name}Ôºö</div>
                                <div class="text-sm text-gray-700 whitespace-pre-line">${formula.composition || 'ÁµÑÊàêÊú™Ë®òÈåÑ'}</div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            `;
            
            container.innerHTML = displayHtml;
            
            // Êõ¥Êñ∞Èö±ËóèÁöÑÊñáÊú¨Âüü
            let prescriptionText = '';
            
            selectedPrescriptionItems.forEach(item => {
                if (item.type === 'herb') {
                    const dosage = item.customDosage || '6';
                    prescriptionText += `${item.name} ${dosage}g\n`;
                } else if (item.type === 'formula') {
                    prescriptionText += `${item.name}Ôºö\n${item.composition || 'ÁµÑÊàêÊú™Ë®òÈåÑ'}\n\n`;
                }
            });
            
            hiddenTextarea.value = prescriptionText.trim();
        }
        
        // Êõ¥Êñ∞ÊúçËó•Â§©Êï∏
        function updateMedicationDays(change) {
            const daysInput = document.getElementById('medicationDays');
            const currentDays = parseInt(daysInput.value) || 5;
            const newDays = Math.max(1, Math.min(30, currentDays + change));
            daysInput.value = newDays;
            
            // Êõ¥Êñ∞ËôïÊñπÈ°ØÁ§∫
            if (selectedPrescriptionItems.length > 0) {
                updatePrescriptionDisplay();
            }
            
            // Ëá™ÂãïÊõ¥Êñ∞Ëó•Ë≤ª
            updateMedicineFeeByDays(newDays);
        }
        
        // Êõ¥Êñ∞ÊúçËó•Ê¨°Êï∏
        function updateMedicationFrequency(change) {
            const frequencyInput = document.getElementById('medicationFrequency');
            const currentFrequency = parseInt(frequencyInput.value) || 2;
            const newFrequency = Math.max(1, Math.min(6, currentFrequency + change));
            frequencyInput.value = newFrequency;
            
            // Êõ¥Êñ∞ËôïÊñπÈ°ØÁ§∫
            if (selectedPrescriptionItems.length > 0) {
                updatePrescriptionDisplay();
            }
        }
        
        // Ê†πÊìöÈñãËó•Â§©Êï∏Ëá™ÂãïÊõ¥Êñ∞Ëó•Ë≤ª
        function updateMedicineFeeByDays(days) {
            // Âè™ÊúâÂú®ÊúâËôïÊñπÂÖßÂÆπÊôÇÊâçËá™ÂãïÊõ¥Êñ∞Ëó•Ë≤ª
            if (selectedPrescriptionItems.length === 0) {
                return;
            }
            
            // Â∞ãÊâæ‰∏≠Ëó•Ë™øÂäëË≤ªÈ†ÖÁõÆ
            const medicineFeeItem = billingItems.find(item => 
                item.active && 
                item.category === 'medicine' && 
                (item.name.includes('‰∏≠Ëó•') || item.name.includes('Ëó•Ë≤ª') || item.name.includes('Ë™øÂäë'))
            );
            
            if (!medicineFeeItem) {
                return; // Â¶ÇÊûúÊ≤íÊúâÊâæÂà∞Ëó•Ë≤ªÈ†ÖÁõÆÔºå‰∏çÈÄ≤Ë°åËá™ÂãïÊõ¥Êñ∞
            }
            
            // Êü•ÊâæÁèæÊúâÁöÑËó•Ë≤ªÈ†ÖÁõÆ
            const existingMedicineFeeIndex = selectedBillingItems.findIndex(item => 
                item.id === medicineFeeItem.id
            );
            
            if (existingMedicineFeeIndex !== -1) {
                // Êõ¥Êñ∞ÁèæÊúâËó•Ë≤ªÈ†ÖÁõÆÁöÑÊï∏ÈáèÁÇ∫Â§©Êï∏
                selectedBillingItems[existingMedicineFeeIndex].quantity = days;
                updateBillingDisplay();
                showToast(`Â∑≤Êõ¥Êñ∞Ëó•Ë≤ªÔºö${medicineFeeItem.name} x${days}Â§©`, 'info');
            } else {
                // Â¶ÇÊûúÊ≤íÊúâËó•Ë≤ªÈ†ÖÁõÆÔºåËá™ÂãïÊ∑ªÂä†
                const billingItem = {
                    id: medicineFeeItem.id,
                    name: medicineFeeItem.name,
                    category: medicineFeeItem.category,
                    price: medicineFeeItem.price,
                    unit: medicineFeeItem.unit,
                    description: medicineFeeItem.description,
                    quantity: days
                };
                
                selectedBillingItems.push(billingItem);
                updateBillingDisplay();
                showToast(`Â∑≤Ëá™ÂãïÊ∑ªÂä†Ëó•Ë≤ªÔºö${medicineFeeItem.name} x${days}Â§©`, 'info');
            }
        }
        
        // ËôïÁêÜÂ§©Êï∏Ëº∏ÂÖ•Ê°ÜÁõ¥Êé•ËÆäÊõ¥
        function updateMedicationDaysFromInput() {
            const daysInput = document.getElementById('medicationDays');
            const days = parseInt(daysInput.value) || 5;
            
            // Á¢∫‰øùÂ§©Êï∏Âú®ÊúâÊïàÁØÑÂúçÂÖß
            const validDays = Math.max(1, Math.min(30, days));
            if (validDays !== days) {
                daysInput.value = validDays;
            }
            
            // Êõ¥Êñ∞ËôïÊñπÈ°ØÁ§∫
            if (selectedPrescriptionItems.length > 0) {
                updatePrescriptionDisplay();
            }
            
            // Ëá™ÂãïÊõ¥Êñ∞Ëó•Ë≤ª
            updateMedicineFeeByDays(validDays);
        }
        

        
        // Êõ¥Êñ∞ËôïÊñπËó•Èáè
        function updatePrescriptionDosage(index, newDosage) {
            if (index >= 0 && index < selectedPrescriptionItems.length) {
                const dosage = parseFloat(newDosage);
                if (dosage > 0 && dosage <= 100) {
                    selectedPrescriptionItems[index].customDosage = newDosage;
                    // ÈáçÊñ∞ÁîüÊàêËôïÊñπÊñáÊú¨
                    updatePrescriptionDisplay();
                } else {
                    // Â¶ÇÊûúËº∏ÂÖ•ÁÑ°ÊïàÔºåÊÅ¢Âæ©ÂéüÂÄº
                    updatePrescriptionDisplay();
                    showToast('Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑËó•ÈáèÔºà0.5-100ÂÖãÔºâ', 'warning');
                }
            }
        }
        
        // ÁßªÈô§ËôïÊñπÈ†ÖÁõÆ
        function removePrescriptionItem(index) {
            if (index >= 0 && index < selectedPrescriptionItems.length) {
                const removedItem = selectedPrescriptionItems.splice(index, 1)[0];
                updatePrescriptionDisplay();
                
                // Â¶ÇÊûúÁßªÈô§ÂæåÊ≤íÊúâËôïÊñπÈ†ÖÁõÆ‰∫ÜÔºåÁßªÈô§Ëó•Ë≤ª
                if (selectedPrescriptionItems.length === 0) {
                    // Â∞ãÊâæ‰∏¶ÁßªÈô§Ëó•Ë≤ªÈ†ÖÁõÆ
                    const medicineFeeItem = billingItems.find(item => 
                        item.active && 
                        item.category === 'medicine' && 
                        (item.name.includes('‰∏≠Ëó•') || item.name.includes('Ëó•Ë≤ª') || item.name.includes('Ë™øÂäë'))
                    );
                    
                    if (medicineFeeItem) {
                        const medicineFeeIndex = selectedBillingItems.findIndex(item => 
                            item.id === medicineFeeItem.id
                        );
                        
                        if (medicineFeeIndex !== -1) {
                            selectedBillingItems.splice(medicineFeeIndex, 1);
                            updateBillingDisplay();
                        }
                    }
                }
            }
        }
        
        // Ê∏ÖÈô§ËôïÊñπÊêúÁ¥¢
        function clearPrescriptionSearch() {
            document.getElementById('prescriptionSearch').value = '';
            document.getElementById('prescriptionSearchResults').classList.add('hidden');
        }
        
        // Êî∂Ë≤ªÈ†ÖÁõÆÊêúÁ¥¢ÂäüËÉΩ
        function searchBillingForConsultation() {
            const searchTerm = document.getElementById('billingSearch').value.trim().toLowerCase();
            const resultsContainer = document.getElementById('billingSearchResults');
            const resultsList = document.getElementById('billingSearchList');
            
            if (searchTerm.length < 1) {
                resultsContainer.classList.add('hidden');
                return;
            }
            
            // ÊêúÁ¥¢ÂåπÈÖçÁöÑÊî∂Ë≤ªÈ†ÖÁõÆÔºàÂè™È°ØÁ§∫ÂïüÁî®ÁöÑÈ†ÖÁõÆÔºâ
            const matchedItems = billingItems.filter(item => 
                item.active && (
                    item.name.toLowerCase().includes(searchTerm) ||
                    (item.description && item.description.toLowerCase().includes(searchTerm))
                )
            ).slice(0, 10); // ÈôêÂà∂È°ØÁ§∫Ââç10ÂÄãÁµêÊûú
            
            if (matchedItems.length === 0) {
                resultsList.innerHTML = `
                    <div class="p-3 text-center text-gray-500 text-sm">
                        Êâæ‰∏çÂà∞Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑÊî∂Ë≤ªÈ†ÖÁõÆ
                    </div>
                `;
                resultsContainer.classList.remove('hidden');
                return;
            }
            
            // È°ØÁ§∫ÊêúÁ¥¢ÁµêÊûú
            resultsList.innerHTML = matchedItems.map(item => {
                const categoryNames = {
                    consultation: 'Ë®∫ÁôÇË≤ª',
                    medicine: 'Ëó•Ë≤ª',
                    treatment: 'Ê≤ªÁôÇË≤ª',
                    other: 'ÂÖ∂‰ªñ',
                    discount: 'ÊäòÊâ£È†ÖÁõÆ'
                };
                const categoryName = categoryNames[item.category] || 'Êú™ÂàÜÈ°û';
                const bgColor = getCategoryBgColor(item.category);
                
                return `
                    <div class="p-3 ${bgColor} border rounded-lg cursor-pointer transition duration-200" onclick="addToBilling(${item.id})">
                        <div class="text-center">
                            <div class="font-semibold text-gray-900 text-sm mb-1">${item.name}</div>
                            <div class="text-xs bg-white text-gray-600 px-2 py-1 rounded mb-2">${categoryName}</div>
                            ${item.category !== 'discount' ? `
                                <div class="text-sm font-bold text-green-600">
                                    $${item.price}
                                </div>
                            ` : ''}
                            ${item.unit ? `<div class="text-xs text-gray-600">/ ${item.unit}</div>` : ''}
                            ${item.description ? `<div class="text-xs text-gray-600 mt-1">${item.description.substring(0, 30)}${item.description.length > 30 ? '...' : ''}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            resultsContainer.classList.remove('hidden');
        }
        
        // Áç≤ÂèñÈ°ûÂà•ËÉåÊôØÈ°èËâ≤
        function getCategoryBgColor(category) {
            const colors = {
                consultation: 'bg-blue-50 hover:bg-blue-100 border-blue-200',
                medicine: 'bg-green-50 hover:bg-green-100 border-green-200',
                treatment: 'bg-orange-50 hover:bg-orange-100 border-orange-200',
                other: 'bg-gray-50 hover:bg-gray-100 border-gray-200',
                discount: 'bg-red-50 hover:bg-red-100 border-red-200'
            };
            return colors[category] || colors.other;
        }
        
        // Ê∑ªÂä†Âà∞Êî∂Ë≤ªÈ†ÖÁõÆ
        function addToBilling(itemId) {
            const item = billingItems.find(b => b.id === itemId);
            if (!item) return;
            
            // Ê™¢Êü•ÊòØÂê¶Â∑≤Á∂ìÊ∑ªÂä†ÈÅé
            const existingIndex = selectedBillingItems.findIndex(b => b.id === itemId);
            if (existingIndex !== -1) {
                // Â¶ÇÊûúÂ∑≤Â≠òÂú®ÔºåÂ¢ûÂä†Êï∏Èáè
                selectedBillingItems[existingIndex].quantity += 1;
            } else {
                // Ê∑ªÂä†Êñ∞È†ÖÁõÆ
                const billingItem = {
                    id: itemId,
                    name: item.name,
                    category: item.category,
                    price: item.price,
                    unit: item.unit,
                    description: item.description,
                    quantity: 1
                };
                selectedBillingItems.push(billingItem);
            }
            
            // Êõ¥Êñ∞È°ØÁ§∫
            updateBillingDisplay();
            
            // Ê∏ÖÈô§ÊêúÁ¥¢
            clearBillingSearch();
            
            showToast(`Â∑≤Ê∑ªÂä†Êî∂Ë≤ªÈ†ÖÁõÆÔºö${item.name}`, 'success');
        }
        
        // Êõ¥Êñ∞Êî∂Ë≤ªÈ†ÖÁõÆÈ°ØÁ§∫
        function updateBillingDisplay() {
            const container = document.getElementById('selectedBillingItems');
            const hiddenTextarea = document.getElementById('formBillingItems');
            const totalAmountSpan = document.getElementById('totalBillingAmount');
            
            if (selectedBillingItems.length === 0) {
                container.innerHTML = `
                    <div class="text-sm text-gray-500 text-center py-4">
                        Ë´ã‰ΩøÁî®‰∏äÊñπÊêúÁ¥¢ÂäüËÉΩÊ∑ªÂä†Êî∂Ë≤ªÈ†ÖÁõÆ
                    </div>
                `;
                hiddenTextarea.value = '';
                totalAmountSpan.textContent = '$0';
                return;
            }
            
            // Ë®àÁÆóÁ∏ΩË≤ªÁî®
            let totalAmount = 0;
            let subtotalBeforeDiscount = 0;
            
            // ÂÖàË®àÁÆóÈùûÊäòÊâ£È†ÖÁõÆÁöÑÂ∞èË®à
            selectedBillingItems.forEach(item => {
                if (item.category !== 'discount') {
                    subtotalBeforeDiscount += item.price * item.quantity;
                }
            });
            
            // Ë®àÁÆóÊäòÊâ£ÂæåÁöÑÁ∏ΩÈáëÈ°ç
            totalAmount = subtotalBeforeDiscount;
            selectedBillingItems.forEach(item => {
                if (item.category === 'discount') {
                    if (item.price > 0 && item.price < 1) {
                        // ÁôæÂàÜÊØîÊäòÊâ£ÔºöÂ∞çÂ∞èË®àÈÄ≤Ë°åÊäòÊâ£Ë®àÁÆó
                        const discountAmount = subtotalBeforeDiscount * (1 - item.price) * item.quantity;
                        totalAmount -= discountAmount;
                    } else {
                        // Âõ∫ÂÆöÈáëÈ°çÊäòÊâ£
                        totalAmount += item.price * item.quantity;
                    }
                }
            });
            totalAmountSpan.textContent = `$${totalAmount}`;
            
            // ÂàÜÈõ¢ÊäòÊâ£È†ÖÁõÆÂíåÈùûÊäòÊâ£È†ÖÁõÆÔºå‰ΩÜ‰øùÊåÅÂêÑËá™ÁöÑÊ∑ªÂä†È†ÜÂ∫è
            const nonDiscountItems = [];
            const discountItems = [];
            
            selectedBillingItems.forEach((item, originalIndex) => {
                if (item.category === 'discount') {
                    discountItems.push({ item, originalIndex });
                } else {
                    nonDiscountItems.push({ item, originalIndex });
                }
            });
            
            // Âêà‰ΩµÈ°ØÁ§∫ÔºöÈùûÊäòÊâ£È†ÖÁõÆÂú®ÂâçÔºåÊäòÊâ£È†ÖÁõÆÂú®Âæå
            const displayItems = [...nonDiscountItems, ...discountItems];
            
            // È°ØÁ§∫Â∑≤ÈÅ∏ÊìáÁöÑÈ†ÖÁõÆÔºàÈùûÊäòÊâ£È†ÖÁõÆÂú®ÂâçÔºåÊäòÊâ£È†ÖÁõÆÂú®ÂæåÔºâ
            container.innerHTML = `
                <div class="space-y-2">
                    ${displayItems.map(({ item, originalIndex }) => {
                        const categoryNames = {
                            consultation: 'Ë®∫ÁôÇË≤ª',
                            medicine: 'Ëó•Ë≤ª',
                            treatment: 'Ê≤ªÁôÇË≤ª',
                            other: 'ÂÖ∂‰ªñ',
                            discount: 'ÊäòÊâ£È†ÖÁõÆ'
                        };
                        const categoryName = categoryNames[item.category] || 'Êú™ÂàÜÈ°û';
                        const bgColor = getCategoryBgColor(item.category);
                        let subtotal;
                        let subtotalDisplay;
                        
                        if (item.category === 'discount' && item.price > 0 && item.price < 1) {
                            // ÁôæÂàÜÊØîÊäòÊâ£ÔºöÈ°ØÁ§∫ÊäòÊâ£ÈáëÈ°ç
                            const discountAmount = subtotalBeforeDiscount * (1 - item.price) * item.quantity;
                            subtotal = -discountAmount;
                            subtotalDisplay = `-$${discountAmount.toFixed(0)}`;
                        } else {
                            // ‰∏ÄËà¨È†ÖÁõÆÊàñÂõ∫ÂÆöÈáëÈ°çÊäòÊâ£
                            subtotal = item.price * item.quantity;
                            subtotalDisplay = `$${subtotal}`;
                        }
                        
                        return `
                            <div class="flex items-center ${bgColor} border rounded-lg p-3">
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-900">${item.name}</div>
                                    <div class="text-xs text-gray-600">${categoryName}</div>
                                    <div class="text-sm font-medium ${item.category === 'discount' ? 'text-red-600' : 'text-green-600'}">
                                        ${(() => {
                                            if (item.category === 'discount') {
                                                if (item.price > 0 && item.price < 1) {
                                                    return `${(item.price * 10).toFixed(1)}Êäò`;
                                                } else if (item.price < 0) {
                                                    return `-$${Math.abs(item.price)}`;
                                                } else {
                                                    return `$${item.price}`;
                                                }
                                            }
                                            return `$${item.price}`;
                                        })()}${item.unit ? ` / ${item.unit}` : ''}
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2 mr-3">
                                    <button onclick="updateBillingQuantity(${originalIndex}, -1)" class="w-6 h-6 bg-red-500 text-white rounded-full text-xs hover:bg-red-600 transition duration-200">-</button>
                                    <span class="w-8 text-center font-semibold">${item.quantity}</span>
                                    <button onclick="updateBillingQuantity(${originalIndex}, 1)" class="w-6 h-6 bg-green-500 text-white rounded-full text-xs hover:bg-green-600 transition duration-200">+</button>
                                </div>
                                <div class="mr-3 text-right">
                                    <div class="font-bold ${subtotal < 0 ? 'text-red-600' : 'text-green-600'}">${subtotalDisplay}</div>
                                </div>
                                <button onclick="removeBillingItem(${originalIndex})" class="text-red-500 hover:text-red-700 font-bold text-lg px-2">√ó</button>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <!-- Â∞èË®àÂíåÁ∏ΩË®àÈ°ØÁ§∫ -->
                ${subtotalBeforeDiscount > 0 && selectedBillingItems.some(item => item.category === 'discount') ? `
                    <div class="mt-4 pt-3 border-t border-gray-200">
                        <div class="text-right space-y-1">
                            <div class="text-sm text-gray-600">
                                Â∞èË®àÔºö<span class="font-medium">$${subtotalBeforeDiscount}</span>
                            </div>
                            ${selectedBillingItems.filter(item => item.category === 'discount').map(item => {
                                if (item.price > 0 && item.price < 1) {
                                    const discountAmount = subtotalBeforeDiscount * (1 - item.price) * item.quantity;
                                    return `<div class="text-sm text-red-600">
                                        ${item.name}Ôºö<span class="font-medium">-$${discountAmount.toFixed(0)}</span>
                                    </div>`;
                                } else {
                                    return `<div class="text-sm text-red-600">
                                        ${item.name}Ôºö<span class="font-medium">$${item.price * item.quantity}</span>
                                    </div>`;
                                }
                            }).join('')}
                            <div class="text-base font-bold text-green-600 pt-1 border-t border-gray-300">
                                Á∏ΩË®àÔºö$${Math.round(totalAmount)}
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
            
            // Êõ¥Êñ∞Èö±ËóèÁöÑÊñáÊú¨ÂüüÔºàÈùûÊäòÊâ£È†ÖÁõÆÂú®ÂâçÔºåÊäòÊâ£È†ÖÁõÆÂú®ÂæåÔºâ
            let billingText = '';
            
            // Â¶ÇÊûúÊúâÊäòÊâ£È†ÖÁõÆÔºåÂÖàÈ°ØÁ§∫Â∞èË®à
            if (selectedBillingItems.some(item => item.category === 'discount')) {
                billingText += `Â∞èË®àÔºö$${subtotalBeforeDiscount}\n\n`;
            }
            
            // ÂÖàË®òÈåÑÈùûÊäòÊâ£È†ÖÁõÆ
            selectedBillingItems.forEach(item => {
                if (item.category !== 'discount') {
                    billingText += `${item.name} x${item.quantity} = $${item.price * item.quantity}\n`;
                }
            });
            
            // ÂÜçË®òÈåÑÊäòÊâ£È†ÖÁõÆ
            selectedBillingItems.forEach(item => {
                if (item.category === 'discount') {
                    if (item.price > 0 && item.price < 1) {
                        // ÁôæÂàÜÊØîÊäòÊâ£
                        const discountAmount = subtotalBeforeDiscount * (1 - item.price) * item.quantity;
                        billingText += `${item.name} x${item.quantity} = -$${discountAmount.toFixed(0)}\n`;
                    } else {
                        // Âõ∫ÂÆöÈáëÈ°çÊäòÊâ£
                        billingText += `${item.name} x${item.quantity} = $${item.price * item.quantity}\n`;
                    }
                }
            });
            
            billingText += `\nÁ∏ΩË≤ªÁî®Ôºö$${Math.round(totalAmount)}`;
            hiddenTextarea.value = billingText.trim();
        }
        
        // Êõ¥Êñ∞Êî∂Ë≤ªÈ†ÖÁõÆÊï∏Èáè
        function updateBillingQuantity(index, change) {
            if (index >= 0 && index < selectedBillingItems.length) {
                const newQuantity = selectedBillingItems[index].quantity + change;
                if (newQuantity > 0) {
                    selectedBillingItems[index].quantity = newQuantity;
                    updateBillingDisplay();
                } else if (newQuantity === 0) {
                    // Êï∏ÈáèÁÇ∫0ÊôÇÁßªÈô§È†ÖÁõÆ
                    removeBillingItem(index);
                }
            }
        }
        
        // ÁßªÈô§Êî∂Ë≤ªÈ†ÖÁõÆ
        function removeBillingItem(index) {
            if (index >= 0 && index < selectedBillingItems.length) {
                const removedItem = selectedBillingItems.splice(index, 1)[0];
                updateBillingDisplay();
                // showToast(`Â∑≤ÁßªÈô§Ôºö${removedItem.name}`, 'info');
            }
        }
        
        // Ê∏ÖÈô§Êî∂Ë≤ªÈ†ÖÁõÆÊêúÁ¥¢
        function clearBillingSearch() {
            document.getElementById('billingSearch').value = '';
            document.getElementById('billingSearchResults').classList.add('hidden');
        }
        
        // Ê∏ÖÁ©∫ÊâÄÊúâÊêúÂ∞ãÊ¨Ñ‰Ωç
        function clearAllSearchFields() {
            // Ê∏ÖÁ©∫ÁóÖ‰∫∫ÊêúÂ∞ãÊ¨Ñ
            const patientSearchInput = document.getElementById('patientSearchInput');
            if (patientSearchInput) {
                patientSearchInput.value = '';
            }
            
            // Ê∏ÖÁ©∫ËôïÊñπÊêúÂ∞ãÊ¨Ñ
            clearPrescriptionSearch();
            
            // Ê∏ÖÁ©∫Êî∂Ë≤ªÈ†ÖÁõÆÊêúÂ∞ãÊ¨Ñ
            clearBillingSearch();
        }
        
        // Ëá™ÂãïÊ∑ªÂä†È†êË®≠Ë®∫ÈáëÊî∂Ë≤ª
        function addDefaultConsultationFee(patient) {
            // Â∞ãÊâæË®∫ÈáëÊî∂Ë≤ªÈ†ÖÁõÆÔºàÂÑ™ÂÖàÂ∞ãÊâæÂêçÁ®±ÂåÖÂê´„ÄåË®∫Èáë„ÄçÁöÑÈ†ÖÁõÆÔºâ
            let consultationFeeItem = billingItems.find(item => 
                item.active && 
                item.category === 'consultation' && 
                item.name.includes('Ë®∫Èáë')
            );
            
            // Â¶ÇÊûúÊ≤íÊúâÊâæÂà∞Ë®∫ÈáëÈ†ÖÁõÆÔºå‰ΩøÁî®Á¨¨‰∏ÄÂÄãË®∫ÁôÇË≤ªÈ†ÖÁõÆ
            if (!consultationFeeItem) {
                consultationFeeItem = billingItems.find(item => 
                    item.active && item.category === 'consultation'
                );
            }
            
            // Â¶ÇÊûúÊâæÂà∞Ë®∫ÈáëÈ†ÖÁõÆÔºåËá™ÂãïÊ∑ªÂä†
            if (consultationFeeItem) {
                // Ê∏ÖÁ©∫ÁèæÊúâÊî∂Ë≤ªÈ†ÖÁõÆ
                selectedBillingItems = [];
                
                // Ê∑ªÂä†Ë®∫ÈáëÈ†ÖÁõÆ
                const billingItem = {
                    id: consultationFeeItem.id,
                    name: consultationFeeItem.name,
                    category: consultationFeeItem.category,
                    price: consultationFeeItem.price,
                    unit: consultationFeeItem.unit,
                    description: consultationFeeItem.description,
                    quantity: 1
                };
                
                selectedBillingItems.push(billingItem);
                
                // Ëá™ÂãïÊ∑ªÂä†È†êË®≠Ëó•Ë≤ªÔºàÊ†πÊìöÈ†êË®≠5Â§©Ôºâ
                const defaultDays = 5;
                updateMedicineFeeByDays(defaultDays);
                
                // Êõ¥Êñ∞È°ØÁ§∫
                updateBillingDisplay();
            } else {
                // Â¶ÇÊûúÊ≤íÊúâÊâæÂà∞‰ªª‰ΩïË®∫ÁôÇË≤ªÈ†ÖÁõÆÔºåÂè™Ê∏ÖÁ©∫Êî∂Ë≤ªÈ†ÖÁõÆ‰∏¶Êõ¥Êñ∞È°ØÁ§∫
                selectedBillingItems = [];
                updateBillingDisplay();
            }
        }
        

        
        // ËºâÂÖ•‰∏äÊ¨°ËôïÊñπÂÖßÂÆπÔºàÊåâÈàïËß∏ÁôºÔºâ
        function loadPreviousPrescription() {
            if (!currentConsultingAppointmentId) {
                showToast('Ë´ãÂÖàÈñãÂßãË®∫ÁóáÔºÅ', 'error');
                return;
            }
            
            const appointment = appointments.find(apt => apt.id === currentConsultingAppointmentId);
            if (!appointment) {
                showToast('Êâæ‰∏çÂà∞Áï∂ÂâçË®∫ÁóáË®òÈåÑÔºÅ', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            if (!patient) {
                showToast('Êâæ‰∏çÂà∞ÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
                return;
            }
            
            // Áç≤ÂèñË©≤ÁóÖ‰∫∫ÁöÑÊúÄËøë‰∏ÄÊ¨°Ë®∫ÁóáË®òÈåÑÔºàÊéíÈô§Áï∂ÂâçÊ≠£Âú®Á∑®ËºØÁöÑË®òÈåÑÔºâ
            const patientConsultations = consultations
                .filter(c => c.patientId === patient.id)
                .sort((a, b) => new Date(b.date) - new Date(a.date)); // ÊåâÊó•ÊúüÈôçÂ∫èÊéíÂàóÔºàÊúÄÊñ∞Âú®ÂâçÔºâ
            
            const lastConsultation = patientConsultations[0]; // ÊúÄËøë‰∏ÄÊ¨°Ë®∫ÁóáË®òÈåÑ
            
            if (!lastConsultation || !lastConsultation.prescription) {
                showToast(`${patient.name} Ê≤íÊúâ‰∏äÊ¨°ËôïÊñπË®òÈåÑÂèØËºâÂÖ•`, 'warning');
                return;
            }
            
            // Áõ¥Êé•ËºâÂÖ•Ôºå‰∏çÈúÄË¶ÅÁ¢∫Ë™ç
            // Ê∏ÖÁ©∫ÁèæÊúâËôïÊñπÈ†ÖÁõÆ
            selectedPrescriptionItems = [];
            
            // Ëß£Êûê‰∏äÊ¨°ËôïÊñπÂÖßÂÆπÔºåÈáçÂª∫ËôïÊñπÈ†ÖÁõÆ
            parsePrescriptionToItems(lastConsultation.prescription);
            
            // Êõ¥Êñ∞ËôïÊñπÈ°ØÁ§∫
            updatePrescriptionDisplay();
            
            // showToast(`Â∑≤ËºâÂÖ• ${patient.name} ‰∏äÊ¨°ÁöÑËôïÊñπÂÖßÂÆπ`, 'success');
        }
        
        // Ëß£ÊûêËôïÊñπÂÖßÂÆπ‰∏¶ÈáçÂª∫ËôïÊñπÈ†ÖÁõÆ
        function parsePrescriptionToItems(prescriptionText) {
            if (!prescriptionText) return;
            
            const lines = prescriptionText.split('\n');
            let currentFormula = null;
            let formulaComposition = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÊñπÂäëÊ®ôÈ°åÔºà‰ª•ÔºöÁµêÂ∞æÔºâ
                if (line.endsWith('Ôºö')) {
                    // Â¶ÇÊûú‰πãÂâçÊúâÊñπÂäëÂú®ËôïÁêÜÔºåÂÖàÂÆåÊàêÂÆÉ
                    if (currentFormula) {
                        finishCurrentFormula();
                    }
                    
                    // ÈñãÂßãÊñ∞ÁöÑÊñπÂäë
                    const formulaName = line.slice(0, -1).trim();
                    const formula = herbLibrary.find(item => 
                        item.type === 'formula' && item.name === formulaName
                    );
                    
                    if (formula) {
                        currentFormula = {
                            id: formula.id,
                            type: 'formula',
                            name: formula.name,
                            composition: formula.composition,
                            effects: formula.effects
                        };
                        formulaComposition = [];
                    }
                    continue;
                }
                
                // Â¶ÇÊûúÊ≠£Âú®ËôïÁêÜÊñπÂäëÔºåÊî∂ÈõÜÁµÑÊàêÂÖßÂÆπ
                if (currentFormula) {
                    // Ê™¢Êü•ÊòØÂê¶ÁÇ∫‰∏≠Ëó•ÊùêÊ†ºÂºèÔºàËó•ÊùêÂêç ÂäëÈáègÔºâ
                    const herbMatch = line.match(/^(.+?)\s+(\d+(?:\.\d+)?)g$/);
                    if (herbMatch) {
                        formulaComposition.push(line);
                    } else {
                        // Â¶ÇÊûú‰∏çÊòØËó•ÊùêÊ†ºÂºèÔºåÂèØËÉΩÊòØÊñπÂäëÁöÑÂÖ∂‰ªñÊèèËø∞Ôºå‰πüÂä†ÂÖ•ÁµÑÊàê
                        formulaComposition.push(line);
                    }
                } else {
                    // ‰∏çÂú®ÊñπÂäë‰∏≠ÔºåËß£ÊûêÁÇ∫Áç®Á´ãÁöÑ‰∏≠Ëó•Êùê
                    const herbMatch = line.match(/^(.+?)\s+(\d+(?:\.\d+)?)g$/);
                    if (herbMatch) {
                        const herbName = herbMatch[1].trim();
                        const dosage = herbMatch[2];
                        
                        // Âú®‰∏≠Ëó•Â∫´‰∏≠Â∞ãÊâæÂ∞çÊáâÁöÑ‰∏≠Ëó•Êùê
                        const herb = herbLibrary.find(item => 
                            item.type === 'herb' && item.name === herbName
                        );
                        
                        if (herb) {
                            const prescriptionItem = {
                                id: herb.id,
                                type: 'herb',
                                name: herb.name,
                                dosage: herb.dosage || '6g',
                                customDosage: dosage,
                                effects: herb.effects
                            };
                            selectedPrescriptionItems.push(prescriptionItem);
                        } else {
                            // Â¶ÇÊûúÂú®‰∏≠Ëó•Â∫´‰∏≠Êâæ‰∏çÂà∞ÔºåÂâµÂª∫‰∏ÄÂÄãËá®ÊôÇÈ†ÖÁõÆ
                            const prescriptionItem = {
                                id: Date.now() + Math.random(), // Ëá®ÊôÇID
                                type: 'herb',
                                name: herbName,
                                dosage: `${dosage}g`,
                                customDosage: dosage,
                                effects: 'ÔºàÂæû‰∏äÊ¨°ËôïÊñπËºâÂÖ•Ôºâ'
                            };
                            selectedPrescriptionItems.push(prescriptionItem);
                        }
                    }
                }
            }
            
            // ËôïÁêÜÊúÄÂæå‰∏ÄÂÄãÊñπÂäëÔºàÂ¶ÇÊûúÊúâÁöÑË©±Ôºâ
            if (currentFormula) {
                finishCurrentFormula();
            }
            
            // ÂÆåÊàêÁï∂ÂâçÊñπÂäëÁöÑËôïÁêÜ
            function finishCurrentFormula() {
                if (formulaComposition.length > 0) {
                    currentFormula.composition = formulaComposition.join('\n');
                }
                selectedPrescriptionItems.push(currentFormula);
                currentFormula = null;
                formulaComposition = [];
            }
        }
        

        
        // ËºâÂÖ•‰∏äÊ¨°Êî∂Ë≤ªÈ†ÖÁõÆÔºàÊåâÈàïËß∏ÁôºÔºâ
        function loadPreviousBillingItems() {
            if (!currentConsultingAppointmentId) {
                showToast('Ë´ãÂÖàÈñãÂßãË®∫ÁóáÔºÅ', 'error');
                return;
            }
            
            const appointment = appointments.find(apt => apt.id === currentConsultingAppointmentId);
            if (!appointment) {
                showToast('Êâæ‰∏çÂà∞Áï∂ÂâçË®∫ÁóáË®òÈåÑÔºÅ', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            if (!patient) {
                showToast('Êâæ‰∏çÂà∞ÁóÖ‰∫∫Ë≥áÊñôÔºÅ', 'error');
                return;
            }
            
            // Áç≤ÂèñË©≤ÁóÖ‰∫∫ÁöÑÊúÄËøë‰∏ÄÊ¨°Ë®∫ÁóáË®òÈåÑ
            const patientConsultations = consultations
                .filter(c => c.patientId === patient.id)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const lastConsultation = patientConsultations[0];
            
            if (!lastConsultation || !lastConsultation.billingItems) {
                showToast(`${patient.name} Ê≤íÊúâ‰∏äÊ¨°Êî∂Ë≤ªË®òÈåÑÂèØËºâÂÖ•`, 'warning');
                return;
            }
            
            // Áõ¥Êé•ËºâÂÖ•Ôºå‰∏çÈúÄË¶ÅÁ¢∫Ë™ç
            // Ê∏ÖÁ©∫ÁèæÊúâÊî∂Ë≤ªÈ†ÖÁõÆ
            selectedBillingItems = [];
            
            // Ëß£Êûê‰∏¶ËºâÂÖ•‰∏äÊ¨°Êî∂Ë≤ªÈ†ÖÁõÆ
            parseBillingItemsFromText(lastConsultation.billingItems);
            
            // Êõ¥Êñ∞È°ØÁ§∫
            updateBillingDisplay();
        }
        
        // Ëß£ÊûêÊî∂Ë≤ªÈ†ÖÁõÆÊñáÂ≠ó‰∏¶ËºâÂÖ•
        function parseBillingItemsFromText(billingText) {
            if (!billingText) {
                return;
            }
            
            // Ëß£Êûê‰∏äÊ¨°Êî∂Ë≤ªÈ†ÖÁõÆ
            const billingLines = billingText.split('\n');
            
            billingLines.forEach(line => {
                line = line.trim();
                if (!line || line.includes('Â∞èË®à') || line.includes('Á∏ΩË≤ªÁî®')) return;
                
                // Ëß£ÊûêÊî∂Ë≤ªÈ†ÖÁõÆÊ†ºÂºèÔºöÈ†ÖÁõÆÂêç xÊï∏Èáè = $ÈáëÈ°ç Êàñ È†ÖÁõÆÂêç xÊï∏Èáè = -$ÈáëÈ°ç
                const itemMatch = line.match(/^(.+?)\s+x(\d+)\s+=\s+([\-\$]?\d+)$/);
                if (itemMatch) {
                    const itemName = itemMatch[1].trim();
                    const quantity = parseInt(itemMatch[2]);
                    
                    // Âú®Êî∂Ë≤ªÈ†ÖÁõÆ‰∏≠Â∞ãÊâæÂ∞çÊáâÁöÑÈ†ÖÁõÆ
                    const billingItem = billingItems.find(item => 
                        item.active && item.name === itemName
                    );
                    
                    if (billingItem) {
                        const selectedItem = {
                            id: billingItem.id,
                            name: billingItem.name,
                            category: billingItem.category,
                            price: billingItem.price,
                            unit: billingItem.unit,
                            description: billingItem.description,
                            quantity: quantity
                        };
                        selectedBillingItems.push(selectedItem);
                    } else {
                        // Â¶ÇÊûúÂú®Êî∂Ë≤ªÈ†ÖÁõÆ‰∏≠Êâæ‰∏çÂà∞ÔºåÂâµÂª∫‰∏ÄÂÄãËá®ÊôÇÈ†ÖÁõÆÔºàÁî®ÊñºÂ∑≤Âà™Èô§ÁöÑÊî∂Ë≤ªÈ†ÖÁõÆÔºâ
                        console.log(`Êâæ‰∏çÂà∞Êî∂Ë≤ªÈ†ÖÁõÆÔºö${itemName}ÔºåÂèØËÉΩÂ∑≤Ë¢´Âà™Èô§`);
                    }
                }
            });
        }
        
        // ËºâÂÖ•‰∏äÊ¨°Êî∂Ë≤ªÈ†ÖÁõÆÔºàÂÖßÈÉ®ÂáΩÊï∏ - ‰øùÁïôÂêëÂæåÂÖºÂÆπÔºâ
        function loadPreviousBillingItemsFromConsultation(lastConsultation) {
            selectedBillingItems = [];
            parseBillingItemsFromText(lastConsultation.billingItems);
            updateBillingDisplay();
        }
        
        // ËºâÂÖ•ÊåáÂÆöÁóÖÊ≠∑Ë®òÈåÑÂà∞Áï∂ÂâçË®∫Áóá
        function loadMedicalRecordToCurrentConsultation(consultationId) {
            if (!currentConsultingAppointmentId) {
                showToast('Ë´ãÂÖàÈñãÂßãË®∫ÁóáÔºÅ', 'error');
                return;
            }
            
            const consultation = consultations.find(c => c.id === consultationId);
            if (!consultation) {
                showToast('Êâæ‰∏çÂà∞ÊåáÂÆöÁöÑË®∫ÁóáË®òÈåÑÔºÅ', 'error');
                return;
            }
            
            const currentAppointment = appointments.find(apt => apt.id === currentConsultingAppointmentId);
            if (!currentAppointment) {
                showToast('Êâæ‰∏çÂà∞Áï∂ÂâçË®∫ÁóáË®òÈåÑÔºÅ', 'error');
                return;
            }
            
            // Á¢∫Ë™çÊòØÂê¶ÁÇ∫Áõ∏ÂêåÁóÖ‰∫∫
            if (currentAppointment.patientId !== consultation.patientId) {
                showToast('Âè™ËÉΩËºâÂÖ•Áõ∏ÂêåÁóÖ‰∫∫ÁöÑÁóÖÊ≠∑Ë®òÈåÑÔºÅ', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === consultation.patientId);
            const consultationDate = new Date(consultation.date).toLocaleDateString('zh-TW');
            
            // Á¢∫Ë™çËºâÂÖ•Êìç‰Ωú
            const confirmMessage = `Á¢∫ÂÆöË¶ÅËºâÂÖ• ${patient ? patient.name : 'Êú™Áü•ÁóÖ‰∫∫'} Âú® ${consultationDate} ÁöÑÁóÖÊ≠∑Ë®òÈåÑÂóéÔºü\n\n` +
                                 `Ê≠§Êìç‰ΩúÂ∞áÊúÉË¶ÜËìãÁï∂ÂâçÂ∑≤Â°´ÂØ´ÁöÑË®∫ÁóáÂÖßÂÆπÔºåÂåÖÊã¨Ôºö\n` +
                                 `‚Ä¢ ‰∏ªË®¥„ÄÅËàåË±°„ÄÅËÑàË±°Á≠âË®∫ÁóáË≥áÊñô\n` +
                                 `‚Ä¢ Ë®∫Êñ∑ÂíåË≠âÂûã\n` +
                                 `‚Ä¢ ËôïÊñπÂÖßÂÆπ\n` +
                                 `‚Ä¢ Êî∂Ë≤ªÈ†ÖÁõÆ\n` +
                                 `‚Ä¢ ÈÜ´ÂõëÂíåÊ≥®ÊÑè‰∫ãÈ†Ö\n\n` +
                                 `Ê≥®ÊÑèÔºöÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // ËºâÂÖ•Ë®∫ÁóáË≥áÊñô
            document.getElementById('formSymptoms').value = consultation.symptoms || '';
            document.getElementById('formTongue').value = consultation.tongue || '';
            document.getElementById('formPulse').value = consultation.pulse || '';
            document.getElementById('formCurrentHistory').value = consultation.currentHistory || '';
            document.getElementById('formDiagnosis').value = consultation.diagnosis || '';
            document.getElementById('formSyndrome').value = consultation.syndrome || '';
            document.getElementById('formAcupunctureNotes').value = consultation.acupunctureNotes || '';
            document.getElementById('formUsage').value = consultation.usage || '';
            document.getElementById('formTreatmentCourse').value = consultation.treatmentCourse || '';
            document.getElementById('formInstructions').value = consultation.instructions || '';
            document.getElementById('formFollowUpDate').value = consultation.followUpDate || '';
            
            // ËºâÂÖ•ËôïÊñπÂÖßÂÆπ
            selectedPrescriptionItems = [];
            if (consultation.prescription) {
                // Áõ¥Êé•Â∞áËôïÊñπÂÖßÂÆπË®≠ÁΩÆÂà∞Èö±ËóèÊñáÊú¨Âüü
                document.getElementById('formPrescription').value = consultation.prescription;
                
                // Ëß£ÊûêËôïÊñπÂÖßÂÆπ‰∏¶ÈáçÂª∫ËôïÊñπÈ†ÖÁõÆ
                parsePrescriptionToItems(consultation.prescription);
                
                // Êõ¥Êñ∞ËôïÊñπÈ°ØÁ§∫
                updatePrescriptionDisplay();
            } else {
                // Ê∏ÖÁ©∫ËôïÊñπ
                document.getElementById('formPrescription').value = '';
                updatePrescriptionDisplay();
            }
            
            // ËºâÂÖ•Êî∂Ë≤ªÈ†ÖÁõÆ
            selectedBillingItems = [];
            if (consultation.billingItems) {
                // Áõ¥Êé•Â∞áÊî∂Ë≤ªÈ†ÖÁõÆË®≠ÁΩÆÂà∞Èö±ËóèÊñáÊú¨Âüü
                document.getElementById('formBillingItems').value = consultation.billingItems;
                
                // Ëß£Êûê‰∏¶ËºâÂÖ•Êî∂Ë≤ªÈ†ÖÁõÆ
                parseBillingItemsFromText(consultation.billingItems);
                
                // Êõ¥Êñ∞Êî∂Ë≤ªÈ°ØÁ§∫
                updateBillingDisplay();
            } else {
                // Ê∏ÖÁ©∫Êî∂Ë≤ªÈ†ÖÁõÆ
                document.getElementById('formBillingItems').value = '';
                updateBillingDisplay();
            }
            
            // Ê∏ÖÈô§ÊêúÁ¥¢Ê°Ü
            clearPrescriptionSearch();
            clearBillingSearch();
            
            // ÈóúÈñâÁóÖÊ≠∑Êü•ÁúãÂΩàÁ™ó
            closeMedicalHistoryModal();
            
            // ÊªæÂãïÂà∞Ë®∫ÁóáË°®ÂñÆ
            document.getElementById('consultationForm').scrollIntoView({ behavior: 'smooth' });
            
            showToast(`Â∑≤ËºâÂÖ• ${patient ? patient.name : 'Êú™Áü•ÁóÖ‰∫∫'} Âú® ${consultationDate} ÁöÑÂÆåÊï¥ÁóÖÊ≠∑Ë®òÈåÑ`, 'success');
        }
        
        // Ê∏ÖÁ©∫Ë®∫ÁóáË°®ÂñÆÊôÇ‰πüË¶ÅÊ∏ÖÁ©∫ËôïÊñπÊêúÁ¥¢
        function clearConsultationFormOld() {
            ['formSymptoms', 'formTongue', 'formPulse', 'formCurrentHistory', 'formDiagnosis', 'formSyndrome', 'formAcupunctureNotes', 'formPrescription', 'formUsage', 'formTreatmentCourse', 'formInstructions', 'formFollowUpDate'].forEach(id => {
                document.getElementById(id).value = '';
            });
            
            // Ê∏ÖÁ©∫ËôïÊñπÈ†ÖÁõÆ
            selectedPrescriptionItems = [];
            updatePrescriptionDisplay();
            clearPrescriptionSearch();
            
            // Ê∏ÖÁ©∫Êî∂Ë≤ªÈ†ÖÁõÆ
            selectedBillingItems = [];
            updateBillingDisplay();
            clearBillingSearch();
        }



        // Áç≤ÂèñÁî®Êà∂È°ØÁ§∫ÂêçÁ®±ÔºàÂßìÂêçÂÖ®Âêç + ËÅ∑‰ΩçÔºâ
        function getUserDisplayName(user) {
            if (!user || !user.name) return 'Êú™Áü•Áî®Êà∂';
            
            const fullName = user.name;
            const position = user.position || 'Áî®Êà∂';
            
            return `${fullName}${position}`;
        }
        
        // Áç≤ÂèñÈÜ´Â∏´È°ØÁ§∫ÂêçÁ®±
        function getDoctorDisplayName(doctorRole) {
            if (!doctorRole) return 'Êú™Ë®òÈåÑ';
            
            // Â¶ÇÊûúÊòØËàäÁöÑÂõ∫ÂÆöÂÄºÔºåÁõ¥Êé•ËøîÂõû
            if (doctorRole === 'doctor') {
                return 'Âºµ‰∏≠ÈÜ´Â∏´ÈÜ´Â∏´';
            }
            
            // Â∞ãÊâæÂ∞çÊáâÁöÑÈÜ´Â∏´Áî®Êà∂
            const doctorUser = users.find(u => u.username === doctorRole);
            if (doctorUser) {
                return getUserDisplayName(doctorUser);
            }
            
            // Â¶ÇÊûúÊâæ‰∏çÂà∞ÔºåËøîÂõûÂéüÂÄº
            return doctorRole;
        }
        
        // Áî®Êà∂ÁÆ°ÁêÜÂäüËÉΩ
        let editingUserId = null;
        let currentUserFilter = 'all';
        
        function loadUserManagement() {
            displayUsers();
            
            // ÊêúÂ∞ãÂäüËÉΩ
            const searchInput = document.getElementById('searchUser');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    displayUsers();
                });
            }
        }
        
        function filterUsers(status) {
            currentUserFilter = status;
            
            // Êõ¥Êñ∞ÊåâÈàïÊ®£Âºè
            document.querySelectorAll('[id^="user-filter-"]').forEach(btn => {
                btn.className = 'px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200';
            });
            document.getElementById(`user-filter-${status}`).className = 'px-4 py-2 rounded-lg text-sm font-medium bg-blue-100 text-blue-800 transition duration-200';
            
            displayUsers();
        }
        
        function displayUsers() {
            const searchTerm = document.getElementById('searchUser').value.toLowerCase();
            const tbody = document.getElementById('userList');
            
            // ÈÅéÊøæÁî®Êà∂Ë≥áÊñô
            let filteredUsers = users.filter(user => {
                const matchesSearch = user.username.toLowerCase().includes(searchTerm) ||
                                    user.name.toLowerCase().includes(searchTerm) ||
                                    (user.email && user.email.toLowerCase().includes(searchTerm));
                
                let matchesFilter = true;
                if (currentUserFilter === 'inactive') {
                    matchesFilter = !user.active;
                }
                
                return matchesSearch && matchesFilter;
            });
            
            tbody.innerHTML = '';
            
            if (filteredUsers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                            ${searchTerm ? 'Ê≤íÊúâÊâæÂà∞Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑÁî®Êà∂' : 'Â∞öÁÑ°Áî®Êà∂Ë≥áÊñô'}
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredUsers.forEach(user => {
                const statusClass = user.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const statusText = user.active ? 'ÂïüÁî®' : 'ÂÅúÁî®';
                
                const lastLogin = user.lastLogin ? 
                    new Date(user.lastLogin).toLocaleString('zh-TW') : 'ÂæûÊú™ÁôªÂÖ•';
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-900 font-medium">${user.username}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${user.name}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${user.position || 'Êú™Ë®≠ÂÆö'}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${user.email || 'Êú™Ë®≠ÂÆö'}</td>
                    <td class="px-4 py-3">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600">${lastLogin}</td>
                    <td class="px-4 py-3 text-sm space-x-2">
                        <button onclick="editUser(${user.id})" class="text-blue-600 hover:text-blue-800">Á∑®ËºØ</button>
                        ${user.id !== currentUserData.id ? `
                            <button onclick="toggleUserStatus(${user.id})" class="text-orange-600 hover:text-orange-800">
                                ${user.active ? 'ÂÅúÁî®' : 'ÂïüÁî®'}
                            </button>
                            <button onclick="deleteUser(${user.id})" class="text-red-600 hover:text-red-800">Âà™Èô§</button>
                        ` : `
                            <span class="text-gray-400 text-xs">Áï∂ÂâçÁî®Êà∂</span>
                        `}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function showAddUserForm() {
            editingUserId = null;
            document.getElementById('userFormTitle').textContent = 'Êñ∞Â¢ûÁî®Êà∂';
            document.getElementById('userSaveButtonText').textContent = 'ÂÑ≤Â≠ò';
            clearUserForm();
            document.getElementById('addUserModal').classList.remove('hidden');
        }
        
        function hideAddUserForm() {
            document.getElementById('addUserModal').classList.add('hidden');
            clearUserForm();
            editingUserId = null;
        }
        
        function clearUserForm() {
            ['userName', 'userPassword', 'userDisplayName', 'userPosition', 'userEmail', 'userPhone'].forEach(id => {
                document.getElementById(id).value = '';
            });
            document.getElementById('userActive').checked = true;
        }
        
        function editUser(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;
            
            editingUserId = id;
            document.getElementById('userFormTitle').textContent = 'Á∑®ËºØÁî®Êà∂';
            document.getElementById('userSaveButtonText').textContent = 'Êõ¥Êñ∞';
            
            document.getElementById('userName').value = user.username || '';
            document.getElementById('userPassword').value = ''; // ÂØÜÁ¢ºÊ¨Ñ‰Ωç‰øùÊåÅÁ©∫ÁôΩ
            document.getElementById('userDisplayName').value = user.name || '';
            document.getElementById('userPosition').value = user.position || '';
            document.getElementById('userEmail').value = user.email || '';
            document.getElementById('userPhone').value = user.phone || '';
            document.getElementById('userActive').checked = user.active !== false;
            
            document.getElementById('addUserModal').classList.remove('hidden');
        }
        
        function saveUser() {
            const username = document.getElementById('userName').value.trim();
            const password = document.getElementById('userPassword').value.trim();
            const name = document.getElementById('userDisplayName').value.trim();
            const position = document.getElementById('userPosition').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const phone = document.getElementById('userPhone').value.trim();
            const active = document.getElementById('userActive').checked;
            
            // È©óË≠âÂøÖÂ°´Ê¨Ñ‰Ωç
            if (!username || !name || !position) {
                showToast('Ë´ãÂ°´ÂØ´ÂøÖË¶ÅË≥áÊñôÔºàÂ∏≥Ëôü„ÄÅÂßìÂêç„ÄÅËÅ∑‰ΩçÔºâÔºÅ', 'error');
                return;
            }
            
            // È©óË≠âÂ∏≥ËôüÊ†ºÂºè
            const usernameRegex = /^[a-zA-Z0-9_]+$/;
            if (!usernameRegex.test(username)) {
                showToast('Â∏≥ËôüÂè™ËÉΩÂåÖÂê´Ëã±ÊñáÂ≠óÊØç„ÄÅÊï∏Â≠óÂíåÂ∫ïÁ∑öÔºÅ', 'error');
                return;
            }
            
            // Êñ∞Â¢ûÁî®Êà∂ÊôÇÂØÜÁ¢ºÁÇ∫ÂøÖÂ°´
            if (!editingUserId && !password) {
                showToast('Ë´ãËº∏ÂÖ•ÂØÜÁ¢ºÔºÅ', 'error');
                return;
            }
            
            // È©óË≠âÂØÜÁ¢ºÈï∑Â∫¶
            if (password && password.length < 6) {
                showToast('ÂØÜÁ¢ºËá≥Â∞ëÈúÄË¶Å6ÂÄãÂ≠óÁ¨¶ÔºÅ', 'error');
                return;
            }
            
            // Ê™¢Êü•Â∏≥ËôüÊòØÂê¶ÈáçË§á
            const existingUser = users.find(u => u.username === username && u.id !== editingUserId);
            if (existingUser) {
                showToast('Ê≠§Â∏≥ËôüÂ∑≤Â≠òÂú®ÔºåË´ã‰ΩøÁî®ÂÖ∂‰ªñÂ∏≥ËôüÔºÅ', 'error');
                return;
            }
            
            // È©óË≠âÈõªÂ≠êÈÉµ‰ª∂Ê†ºÂºè
            if (email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    showToast('Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÈõªÂ≠êÈÉµ‰ª∂Ê†ºÂºèÔºÅ', 'error');
                    return;
                }
            }
            
            if (editingUserId) {
                // Êõ¥Êñ∞ÁèæÊúâÁî®Êà∂
                const userIndex = users.findIndex(u => u.id === editingUserId);
                if (userIndex === -1) {
                    showToast('Êâæ‰∏çÂà∞Ë¶ÅÊõ¥Êñ∞ÁöÑÁî®Êà∂ÔºÅ', 'error');
                    return;
                }
                
                // Áõ¥Êé•Êõ¥Êñ∞Áî®Êà∂Â±¨ÊÄß
                users[userIndex].username = username;
                users[userIndex].name = name;
                users[userIndex].position = position;
                users[userIndex].email = email;
                users[userIndex].phone = phone;
                users[userIndex].active = active;
                users[userIndex].updatedAt = new Date().toISOString();
                
                // Âè™ÊúâÂú®ÂØÜÁ¢ºÊúâËº∏ÂÖ•ÊôÇÊâçÊõ¥Êñ∞ÂØÜÁ¢º
                if (password) {
                    users[userIndex].password = password;
                }
                
                // Â¶ÇÊûúÊõ¥Êñ∞ÁöÑÊòØÁï∂ÂâçÁôªÂÖ•Áî®Êà∂ÔºåÂêåÊ≠•Êõ¥Êñ∞ currentUserData
                if (editingUserId === currentUserData.id) {
                    currentUserData = users[userIndex];
                    currentUser = users[userIndex].username;
                    
                    // Êõ¥Êñ∞È°ØÁ§∫ÁöÑÁî®Êà∂Ë≥áË®ä
                    document.getElementById('userRole').textContent = `Áï∂ÂâçÁî®Êà∂Ôºö${getUserDisplayName(users[userIndex])}`;
                    document.getElementById('sidebarUserRole').textContent = `Áï∂ÂâçÁî®Êà∂Ôºö${getUserDisplayName(users[userIndex])}`;
                }
                
                showToast('Áî®Êà∂Ë≥áÊñôÂ∑≤ÊàêÂäüÊõ¥Êñ∞ÔºÅ', 'success');
            } else {
                // Êñ∞Â¢ûÁî®Êà∂
                const newUser = {
                    id: Date.now(),
                    username: username,
                    password: password,
                    name: name,
                    position: position,
                    email: email,
                    phone: phone,
                    active: active,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    lastLogin: null
                };
                
                users.push(newUser);
                showToast('Áî®Êà∂Â∑≤ÊàêÂäüÊñ∞Â¢ûÔºÅ', 'success');
            }
            
            localStorage.setItem('users', JSON.stringify(users));
            displayUsers();
            hideAddUserForm();
        }
        
        function toggleUserStatus(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;
            
            // Èò≤Ê≠¢ÂÅúÁî®Ëá™Â∑±ÁöÑÂ∏≥Ëôü
            if (user.id === currentUserData.id) {
                showToast('‰∏çËÉΩÂÅúÁî®Ëá™Â∑±ÁöÑÂ∏≥ËôüÔºÅ', 'error');
                return;
            }
            
            const action = user.active ? 'ÂÅúÁî®' : 'ÂïüÁî®';
            const confirmMessage = `Á¢∫ÂÆöË¶Å${action}Áî®Êà∂„Äå${user.name}„ÄçÂóéÔºü\n\n${user.active ? 'ÂÅúÁî®ÂæåË©≤Áî®Êà∂Â∞áÁÑ°Ê≥ïÁôªÂÖ•Á≥ªÁµ±„ÄÇ' : 'ÂïüÁî®ÂæåË©≤Áî®Êà∂ÂèØ‰ª•Ê≠£Â∏∏ÁôªÂÖ•Á≥ªÁµ±„ÄÇ'}`;
            
            if (confirm(confirmMessage)) {
                user.active = !user.active;
                user.updatedAt = new Date().toISOString();
                
                localStorage.setItem('users', JSON.stringify(users));
                displayUsers();
                showToast(`Áî®Êà∂„Äå${user.name}„ÄçÂ∑≤${action}ÔºÅ`, 'success');
            }
        }
        
        function deleteUser(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;
            
            // Èò≤Ê≠¢Âà™Èô§Ëá™Â∑±ÁöÑÂ∏≥Ëôü
            if (user.id === currentUserData.id) {
                showToast('‰∏çËÉΩÂà™Èô§Ëá™Â∑±ÁöÑÂ∏≥ËôüÔºÅ', 'error');
                return;
            }
            
            // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÊúÄÂæå‰∏ÄÂÄãÁÆ°ÁêÜÂì°
            const adminUsers = users.filter(u => u.role === 'admin' && u.active && u.id !== id);
            if (user.role === 'admin' && adminUsers.length === 0) {
                showToast('‰∏çËÉΩÂà™Èô§ÊúÄÂæå‰∏ÄÂÄãÁÆ°ÁêÜÂì°Â∏≥ËôüÔºÅ', 'error');
                return;
            }
            
            const confirmMessage = `Á¢∫ÂÆöË¶ÅÂà™Èô§Áî®Êà∂„Äå${user.name}„ÄçÂóéÔºü\n\n` +
                                 `Â∏≥ËôüÔºö${user.username}\n` +
                                 `ËßíËâ≤Ôºö${user.role === 'admin' ? 'ÁÆ°ÁêÜÂì°' : user.role === 'doctor' ? 'ÈÜ´Â∏´' : 'Âä©ÁêÜ'}\n\n` +
                                 `Ê≥®ÊÑèÔºöÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ`;
            
            if (confirm(confirmMessage)) {
                users = users.filter(u => u.id !== id);
                localStorage.setItem('users', JSON.stringify(users));
                displayUsers();
                showToast(`Áî®Êà∂„Äå${user.name}„ÄçÂ∑≤Âà™Èô§ÔºÅ`, 'success');
            }
        }



        // ÂàùÂßãÂåñÁ≥ªÁµ±
        document.addEventListener('DOMContentLoaded', function() {
            updateStatistics();
            updateClinicSettingsDisplay();
            
            // Ëá™ÂãïËÅöÁÑ¶Âà∞Â∏≥ËôüËº∏ÂÖ•Ê°Ü
            const usernameInput = document.getElementById('mainLoginUsername');
            if (usernameInput) {
                setTimeout(() => {
                    usernameInput.focus();
                }, 100);
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'969e3fd174b07155',t:'MTc1NDMxMjU0OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
