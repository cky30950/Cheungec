<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中醫診所系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* 浮動提示樣式 */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            max-width: 500px;
            padding: 16px 20px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transform: translateX(100%);
            transition: all 0.3s ease-in-out;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .toast.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .toast.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .toast.info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }
        
        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .toast-content {
            flex: 1;
            line-height: 1.4;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">
    <!-- 登入頁面 -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="text-4xl mb-4">🏥</div>
                <h1 id="loginTitle" class="text-2xl font-bold text-gray-800 mb-2">12334</h1>
                <p id="loginEnglishTitle" class="text-sm text-gray-500 mb-3">12334 Clinic</p>
                <p class="text-gray-600">請輸入您的帳號密碼登入</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">帳號</label>
                    <input type="text" id="mainLoginUsername" placeholder="請輸入帳號" 
                           class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           onkeypress="if(event.key==='Enter') document.getElementById('mainLoginPassword').focus()">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">密碼</label>
                    <input type="password" id="mainLoginPassword" placeholder="請輸入密碼" 
                           class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           onkeypress="if(event.key==='Enter') attemptMainLogin()">
                </div>
                
                <button onclick="attemptMainLogin()" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                    登入系統
                </button>
                
                <!-- 示範帳號提示 -->
                <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="text-sm font-medium text-blue-800 mb-3">示範帳號：</div>
                    <div class="text-xs text-blue-700 space-y-2">
                        <div class="flex justify-between items-center">
                            <span>👨‍💼 陳經理診所管理</span>
                            <span class="font-mono bg-white px-2 py-1 rounded">manager / manager2024</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span>👨‍⚕️ 張中醫師醫師</span>
                            <span class="font-mono bg-white px-2 py-1 rounded">drzhang / zhang888</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span>👩‍💻 林護理師護理師</span>
                            <span class="font-mono bg-white px-2 py-1 rounded">nurse_amy / amy2024</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 主系統頁面 -->
    <div id="mainSystem" class="hidden fade-in">
        <!-- 側邊選單 -->
        <div id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-2xl transform -translate-x-full transition-transform duration-300 ease-in-out">
            <div class="flex flex-col h-full">
                <!-- 選單標題 -->
                <div class="bg-green-600 text-white p-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">🏥</span>
                            <h2 class="text-lg font-bold">診所功能</h2>
                        </div>
                        <button onclick="toggleSidebar()" class="text-white hover:text-gray-200 text-xl">
                            ×
                        </button>
                    </div>
                    <div id="sidebarUserRole" class="text-sm text-green-100 mt-2"></div>
                </div>

                <!-- 功能選單項目 -->
                <div class="flex-1 py-4">
                    <div id="sidebarMenu" class="space-y-2 px-4">
                        <!-- 選單項目會動態生成 -->
                    </div>
                </div>

                <!-- 底部操作 -->
                <div class="border-t border-gray-200 p-4">
                    <button onclick="logout()" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg text-sm transition duration-200 flex items-center justify-center">
                        <span class="mr-2">🚪</span>
                        登出系統
                    </button>
                </div>
            </div>
        </div>

        <!-- 遮罩層 -->
        <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden" onclick="toggleSidebar()"></div>

        <!-- 頂部導航 -->
        <nav class="bg-white shadow-lg border-b-4 border-green-500">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <button onclick="toggleSidebar()" class="mr-4 p-2 rounded-lg hover:bg-gray-100 transition duration-200">
                            <div class="w-6 h-6 flex flex-col justify-center space-y-1">
                                <div class="w-full h-0.5 bg-gray-600"></div>
                                <div class="w-full h-0.5 bg-gray-600"></div>
                                <div class="w-full h-0.5 bg-gray-600"></div>
                            </div>
                        </button>
                        <span class="text-2xl mr-3">🏥</span>
                        <div>
                            <h1 id="systemTitle" class="text-xl font-bold text-gray-800">12334</h1>
                            <p id="systemEnglishTitle" class="text-xs text-gray-500">12334 Clinic</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="userRole" class="text-sm text-gray-600"></span>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                            登出
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- 主要內容區域 -->
        <div class="max-w-7xl mx-auto px-4 py-6">
            <!-- 歡迎頁面 -->
            <div id="welcomePage" class="text-center py-16">
                <div class="text-6xl mb-6">🏥</div>
                <h2 id="welcomeTitle" class="text-3xl font-bold text-gray-800 mb-2">歡迎使用12334</h2>
                <p id="welcomeEnglishTitle" class="text-lg text-gray-500 mb-4">Welcome to 12334 Clinic</p>
                <p class="text-gray-600 text-lg mb-8">請點擊左上角選單按鈕開始使用系統功能</p>
                <div class="bg-white rounded-xl shadow-lg p-8 max-w-4xl mx-auto">
                    <h3 class="text-xl font-semibold mb-4">系統功能概覽</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <div class="text-2xl mb-2">👥</div>
                            <div class="font-semibold">病人資料管理</div>
                            <div class="text-gray-600 mt-1">新增、查看、管理病人資料</div>
                        </div>
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <div class="text-2xl mb-2">🩺</div>
                            <div class="font-semibold">診症系統</div>
                            <div class="text-gray-600 mt-1">記錄症狀、診斷、開立處方</div>
                        </div>
                        <div class="text-center p-4 bg-purple-50 rounded-lg">
                            <div class="text-2xl mb-2">👤</div>
                            <div class="font-semibold">用戶管理</div>
                            <div class="text-gray-600 mt-1">管理診所用戶帳號及權限</div>
                        </div>
                        <div class="text-center p-4 bg-red-50 rounded-lg">
                            <div class="text-2xl mb-2">⚙️</div>
                            <div class="font-semibold">系統管理</div>
                            <div class="text-gray-600 mt-1">統計資料、備份匯出</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 病人資料管理 -->
            <div id="patientManagement" class="hidden bg-white rounded-xl shadow-lg p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">病人資料管理</h2>
                    <div class="flex flex-col md:flex-row gap-3">
                        <div class="relative">
                            <input type="text" id="searchPatient" placeholder="搜尋病人編號、姓名或電話..." class="border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:ring-2 focus:ring-green-500 focus:border-transparent w-full md:w-64">
                            <span class="absolute right-3 top-2.5 text-gray-400">🔍</span>
                        </div>
                        <button onclick="showAddPatientForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200 whitespace-nowrap">
                            + 新增病人
                        </button>
                    </div>
                </div>

                <!-- 新增/編輯病人表單彈窗 -->
                <div id="addPatientModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                            <h3 id="formTitle" class="text-xl font-bold text-gray-800">新增病人資料</h3>
                            <button onclick="hideAddPatientForm()" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">姓名 *</label>
                                    <input type="text" id="patientName" placeholder="請輸入姓名" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">年齡</label>
                                    <input type="number" id="patientAge" placeholder="系統自動計算" min="0" max="120" readonly class="w-full border border-gray-300 rounded-lg px-4 py-2 bg-gray-100 text-gray-600">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">性別 *</label>
                                    <select id="patientGender" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                        <option value="">請選擇性別</option>
                                        <option value="男">男</option>
                                        <option value="女">女</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">電話號碼 *</label>
                                    <input type="tel" id="patientPhone" placeholder="例：0912-345-678" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">身分證字號</label>
                                    <input type="text" id="patientIdCard" placeholder="例：A123456789" maxlength="10" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">出生日期 *</label>
                                    <input type="date" id="patientBirthDate" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent" onchange="updatePatientAge()">
                                </div>
                                <div class="md:col-span-2 lg:col-span-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">聯絡地址</label>
                                    <textarea id="patientAddress" placeholder="請輸入完整地址" rows="2" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                                </div>
                                <div class="md:col-span-2 lg:col-span-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">過敏史</label>
                                    <textarea id="patientAllergies" placeholder="請詳細記錄藥物過敏或食物過敏史" rows="2" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                                </div>
                                <div class="md:col-span-2 lg:col-span-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">病史及備註</label>
                                    <textarea id="patientHistory" placeholder="請記錄重要病史、家族病史、慢性疾病等" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-gray-200">
                                <button onclick="hideAddPatientForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                                    取消
                                </button>
                                <button onclick="savePatient()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200">
                                    <span id="saveButtonText">儲存</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 病人列表 -->
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">編號</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">姓名</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">年齡</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">性別</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">電話</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">操作</th>
                            </tr>
                        </thead>
                        <tbody id="patientList" class="divide-y divide-gray-200">
                            <!-- 病人資料會動態載入 -->
                        </tbody>
                    </table>
                </div>

                <!-- 病人詳細資料彈窗 -->
                <div id="patientDetailModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
                            <h3 class="text-xl font-bold text-gray-800">病人詳細資料</h3>
                            <button onclick="closePatientDetail()" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
                        </div>
                        <div id="patientDetailContent" class="p-6">
                            <!-- 詳細內容會動態載入 -->
                        </div>
                    </div>
                </div>

                <!-- 病人病歷查看彈窗 -->
                <div id="patientMedicalHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                            <h3 id="patientMedicalHistoryTitle" class="text-xl font-bold text-gray-800">病歷記錄</h3>
                            <button onclick="closePatientMedicalHistoryModal()" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
                        </div>
                        
                        <div class="p-6">
                            <!-- 病人基本資訊 -->
                            <div id="patientMedicalHistoryPatientInfo" class="bg-blue-50 rounded-lg p-4 mb-6">
                                <!-- 病人資訊會動態載入 -->
                            </div>
                            
                            <!-- 診症記錄列表 -->
                            <div id="patientMedicalHistoryContent">
                                <!-- 診症記錄會動態載入 -->
                            </div>
                        </div>
                    </div>
                </div>




            </div>

            <!-- 診症系統 -->
            <div id="consultationSystem" class="hidden bg-white rounded-xl shadow-lg p-6">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">掛號診症系統</h2>
                    <p class="text-gray-600 mt-2">簡潔的掛號流程管理</p>
                </div>
                
                <!-- 病人搜索掛號 -->
                <div class="bg-gradient-to-r from-blue-50 to-green-50 rounded-lg p-6 mb-6">
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold text-gray-800 flex items-center mb-2">
                            <span class="mr-2">🔍</span>搜索病人掛號
                        </h3>
                        <p class="text-sm text-gray-600">請輸入病人姓名、編號或電話進行搜索</p>
                    </div>
                    
                    <div class="flex gap-3">
                        <div class="flex-1 relative">
                            <input type="text" id="patientSearchInput" placeholder="搜尋病人姓名、編號或電話..." 
                                   class="w-full border border-gray-300 rounded-lg px-4 py-3 pr-10 focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                   oninput="searchPatientsForRegistration()">
                            <span class="absolute right-3 top-3.5 text-gray-400">🔍</span>
                        </div>
                        <button onclick="clearPatientSearch()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-lg transition duration-200">
                            清除
                        </button>
                    </div>
                    
                    <!-- 搜索結果 -->
                    <div id="patientSearchResults" class="mt-4 hidden">
                        <div class="bg-white rounded-lg border border-gray-200 max-h-64 overflow-y-auto">
                            <div id="searchResultsList" class="divide-y divide-gray-200">
                                <!-- 搜索結果會動態載入 -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 掛號彈窗 -->
                <div id="registrationModal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
                        <div class="bg-green-600 text-white px-6 py-4 rounded-t-xl">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-bold">病人掛號</h3>
                                <button onclick="closeRegistrationModal()" class="text-white hover:text-gray-200 text-2xl">×</button>
                            </div>
                        </div>
                        
                        <div class="p-6 space-y-4">
                            <!-- 選中的病人資訊 -->
                            <div class="bg-blue-50 rounded-lg p-4">
                                <div class="flex items-center mb-2">
                                    <span class="mr-2">👤</span>
                                    <span class="font-semibold text-gray-700">病人資訊</span>
                                </div>
                                <div id="selectedPatientInfo" class="text-sm text-gray-600">
                                    <!-- 病人資訊會動態載入 -->
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <span class="mr-2">👨‍⚕️</span>掛號醫師 *
                                </label>
                                <select id="appointmentDoctor" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="">請選擇醫師</option>
                                    <!-- 醫師選項會動態載入 -->
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <span class="mr-2">⏰</span>掛號時間
                                </label>
                                <input type="datetime-local" id="appointmentDateTime" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <span class="mr-2">📝</span>主訴症狀
                                </label>
                                <textarea id="quickChiefComplaint" placeholder="請簡述病人的主要症狀..." rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                            </div>
                            
                            <div class="flex space-x-3 pt-4">
                                <button onclick="closeRegistrationModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg transition duration-200">
                                    取消
                                </button>
                                <button onclick="confirmRegistration()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                    確認掛號
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 今日掛號列表 -->
                <div class="bg-white border border-gray-200 rounded-lg">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 rounded-t-lg">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                                <span class="mr-2">📅</span>今日掛號列表
                            </h3>
                            <div class="text-sm text-gray-600">
                                總計：<span id="todayTotal" class="font-semibold text-blue-600">0</span> 人
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">序號</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">病人姓名</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">掛號醫師</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">掛號時間</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">主訴症狀</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">狀態</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="todayAppointmentsList" class="divide-y divide-gray-200">
                                    <!-- 掛號列表會動態載入 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>



                <!-- 診症記錄查看彈窗 -->
                <div id="medicalHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                            <h3 id="medicalHistoryTitle" class="text-xl font-bold text-gray-800">診症記錄</h3>
                            <button onclick="closeMedicalHistoryModal()" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
                        </div>
                        
                        <div class="p-6">
                            <!-- 病人基本資訊 -->
                            <div id="medicalHistoryPatientInfo" class="bg-blue-50 rounded-lg p-4 mb-6">
                                <!-- 病人資訊會動態載入 -->
                            </div>
                            
                            <!-- 診症記錄列表 -->
                            <div id="medicalHistoryContent">
                                <!-- 診症記錄會動態載入 -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 診症表單區域 -->
                <div id="consultationForm" class="hidden bg-white border border-gray-200 rounded-lg mt-6">
                    <div class="bg-green-600 text-white px-6 py-4 rounded-t-lg">
                        <h3 class="text-xl font-bold">診症記錄</h3>
                    </div>
                    
                    <div class="p-6">
                        <!-- 病人資訊 -->
                        <div class="bg-blue-50 rounded-lg p-4 mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="font-medium">病人：</span>
                                    <span id="formPatientName" class="text-blue-600 font-semibold"></span>
                                </div>
                                <div>
                                    <span class="font-medium">掛號時間：</span>
                                    <span id="formAppointmentTime"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 診症表單 -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- 左側 -->
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        主訴 *
                                    </label>
                                    <textarea id="formSymptoms" placeholder="病人主要不適症狀、發病時間、症狀特點等..." rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        舌象
                                    </label>
                                    <textarea id="formTongue" placeholder="舌質、舌苔、舌形等..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        脈象
                                    </label>
                                    <textarea id="formPulse" placeholder="脈位、脈率、脈力、脈形等..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        現病史
                                    </label>
                                    <textarea id="formCurrentHistory" placeholder="發病經過、症狀變化、治療經過等..." rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        中醫診斷 *
                                    </label>
                                    <textarea id="formDiagnosis" placeholder="中醫病名診斷..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        證型診斷
                                    </label>
                                    <textarea id="formSyndrome" placeholder="辨證分型、病機分析..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        針灸備註
                                    </label>
                                    <textarea id="formAcupunctureNotes" placeholder="針灸穴位、手法、注意事項等..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                            </div>
                            
                            <!-- 右側 -->
                            <div class="space-y-4">
                                
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="block text-sm font-semibold text-gray-700">
                                            處方內容
                                        </label>
                                        <button type="button" onclick="loadPreviousPrescription()" 
                                                class="text-xs bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded transition duration-200">
                                            📋 載入上次處方
                                        </button>
                                    </div>
                                    
                                    <!-- 中藥庫搜索區域 -->
                                    <div class="mb-3 bg-yellow-50 rounded-lg p-3 border border-yellow-200">
                                        <div class="flex items-center mb-2">
                                            <span class="text-sm font-medium text-yellow-800 mr-2">🔍 搜索中藥庫：</span>
                                            <div class="flex-1 relative">
                                                <input type="text" id="prescriptionSearch" placeholder="搜索中藥材或方劑名稱..." 
                                                       class="w-full border border-yellow-300 rounded px-3 py-1 text-sm focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                                       oninput="searchHerbsForPrescription()">
                                                <button onclick="clearPrescriptionSearch()" class="absolute right-2 top-1 text-gray-400 hover:text-gray-600 text-sm">×</button>
                                            </div>
                                        </div>
                                        
                                        <!-- 搜索結果 -->
                                        <div id="prescriptionSearchResults" class="hidden">
                                            <div class="bg-white rounded border border-yellow-200 max-h-48 overflow-y-auto">
                                                <div id="prescriptionSearchList" class="grid grid-cols-1 md:grid-cols-2 gap-2 p-2">
                                                    <!-- 搜索結果會動態載入 -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 已選擇的處方內容 -->
                                    <div class="border border-gray-300 rounded-lg p-3 min-h-[120px] bg-gray-50">
                                        <div id="selectedPrescriptionItems" class="space-y-2">
                                            <div class="text-sm text-gray-500 text-center py-4">
                                                請使用上方搜索功能添加中藥材或方劑
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 服藥天數及次數設定（只在有處方內容時顯示） -->
                                    <div id="medicationSettings" class="mt-3 bg-yellow-50 rounded-lg p-3 border border-yellow-200" style="display: none;">
                                        <div class="space-y-3">
                                            <!-- 服藥天數 -->
                                            <div class="flex items-center justify-between">
                                                <span class="text-sm font-medium text-yellow-800">服藥天數</span>
                                                <div class="flex items-center space-x-2">
                                                    <button onclick="updateMedicationDays(-1)" class="w-7 h-7 bg-yellow-500 text-white rounded-full text-sm hover:bg-yellow-600 transition duration-200">-</button>
                                                    <input type="number" id="medicationDays" value="5" min="1" max="30" 
                                                           class="w-14 px-2 py-1 text-center border border-yellow-300 rounded focus:ring-2 focus:ring-yellow-500 focus:border-transparent text-sm"
                                                           onchange="updateMedicationDaysFromInput()" onclick="this.select()">
                                                    <button onclick="updateMedicationDays(1)" class="w-7 h-7 bg-yellow-500 text-white rounded-full text-sm hover:bg-yellow-600 transition duration-200">+</button>
                                                    <span class="text-sm text-yellow-800">天</span>
                                                </div>
                                            </div>
                                            
                                            <!-- 服藥次數 -->
                                            <div class="flex items-center justify-between">
                                                <span class="text-sm font-medium text-yellow-800">每日次數</span>
                                                <div class="flex items-center space-x-2">
                                                    <button onclick="updateMedicationFrequency(-1)" class="w-7 h-7 bg-yellow-500 text-white rounded-full text-sm hover:bg-yellow-600 transition duration-200">-</button>
                                                    <input type="number" id="medicationFrequency" value="2" min="1" max="6" 
                                                           class="w-14 px-2 py-1 text-center border border-yellow-300 rounded focus:ring-2 focus:ring-yellow-500 focus:border-transparent text-sm"
                                                           onchange="updateMedicationFrequency(0)" onclick="this.select()">
                                                    <button onclick="updateMedicationFrequency(1)" class="w-7 h-7 bg-yellow-500 text-white rounded-full text-sm hover:bg-yellow-600 transition duration-200">+</button>
                                                    <span class="text-sm text-yellow-800">次/日</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 隱藏的文本域用於存儲處方內容 -->
                                    <textarea id="formPrescription" class="hidden"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        服用方法
                                    </label>
                                    <textarea id="formUsage" placeholder="煎煮方法、服用時間、劑量等..." rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="block text-sm font-semibold text-gray-700">
                                            收費項目
                                        </label>
                                        <button type="button" onclick="loadPreviousBillingItems()" 
                                                class="text-xs bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded transition duration-200">
                                            💰 載入上次收費
                                        </button>
                                    </div>
                                    
                                    <!-- 收費項目搜索區域 -->
                                    <div class="mb-3 bg-green-50 rounded-lg p-3 border border-green-200">
                                        <div class="flex items-center mb-2">
                                            <span class="text-sm font-medium text-green-800 mr-2">💰 選擇收費項目：</span>
                                            <div class="flex-1 relative">
                                                <input type="text" id="billingSearch" placeholder="搜索收費項目名稱..." 
                                                       class="w-full border border-green-300 rounded px-3 py-1 text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                       oninput="searchBillingForConsultation()">
                                                <button onclick="clearBillingSearch()" class="absolute right-2 top-1 text-gray-400 hover:text-gray-600 text-sm">×</button>
                                            </div>
                                        </div>
                                        
                                        <!-- 搜索結果 -->
                                        <div id="billingSearchResults" class="hidden">
                                            <div class="bg-white rounded border border-green-200 max-h-48 overflow-y-auto">
                                                <div id="billingSearchList" class="grid grid-cols-1 md:grid-cols-2 gap-2 p-2">
                                                    <!-- 搜索結果會動態載入 -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 已選擇的收費項目 -->
                                    <div class="border border-gray-300 rounded-lg p-3 min-h-[80px] bg-gray-50">
                                        <div id="selectedBillingItems" class="space-y-2">
                                            <div class="text-sm text-gray-500 text-center py-4">
                                                請使用上方搜索功能添加收費項目
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 總費用顯示 -->
                                    <div class="mt-2 text-right">
                                        <span class="text-sm font-medium text-gray-700">總費用：</span>
                                        <span id="totalBillingAmount" class="text-lg font-bold text-green-600">$0</span>
                                    </div>
                                    
                                    <!-- 隱藏的文本域用於存儲收費項目 -->
                                    <textarea id="formBillingItems" class="hidden"></textarea>

                                    <!-- 病人套票管理 -->
                                    <div class="mt-4 border border-purple-200 rounded-lg p-3 bg-purple-50">
                                      <div class="flex items-center justify-between mb-2">
                                        <div class="text-sm font-semibold text-purple-800">🎫 病人套票</div>
                                        <button type="button" onclick="refreshPatientPackagesUI()"
                                                class="text-xs px-2 py-1 bg-purple-600 text-white rounded">刷新</button>
                                      </div>
                                      <div id="patientPackagesList" class="space-y-2 text-sm text-gray-700">
                                        <!-- 動態載入 -->
                                        <div class="text-gray-500">尚未載入或無套票</div>
                                      </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        療程
                                    </label>
                                    <input type="text" id="formTreatmentCourse" placeholder="例：7天、2週、1個月等..." class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        醫囑及注意事項
                                    </label>
                                    <textarea id="formInstructions" placeholder="飲食宜忌、生活調護、注意事項等..." rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 複診時間及其他時間設定 -->
                        <div class="mt-6 pt-4 border-t border-gray-200">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        複診時間
                                    </label>
                                    <input type="datetime-local" id="formFollowUpDate" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">建議病人下次回診的時間</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        到診時間
                                    </label>
                                    <input type="datetime-local" id="formVisitTime" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">實際到診的時間（用於證明書）</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        建議休息期間
                                    </label>
                                    <div class="space-y-2">
                                        <div class="flex items-center space-x-2">
                                            <label class="text-xs text-gray-600 w-12">開始：</label>
                                            <input type="date" id="formRestStartDate" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" onchange="updateRestPeriod()">
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <label class="text-xs text-gray-600 w-12">結束：</label>
                                            <input type="date" id="formRestEndDate" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" onchange="updateRestPeriod()">
                                        </div>
                                        <div class="text-center">
                                            <span id="restPeriodDisplay" class="text-sm text-gray-500 font-medium">請選擇開始和結束日期</span>
                                        </div>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">用於病假證明書的建議休息期間</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 操作按鈕 -->
                        <div class="flex justify-end space-x-3 mt-6 pt-4 border-t border-gray-200">
                            <button onclick="cancelConsultation()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                                取消診症
                            </button>
                            <button onclick="saveConsultation()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200">
                                <span id="consultationSaveButtonText">完成診症</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 中藥庫管理 -->
            <div id="herbLibrary" class="hidden bg-white rounded-xl shadow-lg p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">中藥庫管理</h2>
                    <div class="flex flex-col md:flex-row gap-3">
                        <div class="relative">
                            <input type="text" id="searchHerb" placeholder="搜尋中藥材或方劑名稱..." class="border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:ring-2 focus:ring-green-500 focus:border-transparent w-full md:w-64">
                            <span class="absolute right-3 top-2.5 text-gray-400">🔍</span>
                        </div>
                        <button onclick="showAddHerbForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200 whitespace-nowrap">
                            + 新增中藥材
                        </button>
                        <button onclick="showAddFormulaForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200 whitespace-nowrap">
                            + 新增方劑
                        </button>
                    </div>
                </div>

                <!-- 分類標籤 -->
                <div class="mb-6">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterHerbLibrary('all')" id="filter-all" class="px-4 py-2 rounded-lg text-sm font-medium bg-blue-100 text-blue-800 transition duration-200">
                            全部
                        </button>
                        <button onclick="filterHerbLibrary('herb')" id="filter-herb" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            中藥材
                        </button>
                        <button onclick="filterHerbLibrary('formula')" id="filter-formula" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            方劑
                        </button>
                    </div>
                </div>

                <!-- 新增/編輯中藥材表單彈窗 -->
                <div id="addHerbModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                            <h3 id="herbFormTitle" class="text-xl font-bold text-gray-800">新增中藥材</h3>
                            <button onclick="hideAddHerbForm()" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">中藥材名稱 *</label>
                                    <input type="text" id="herbName" placeholder="請輸入中藥材名稱" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">別名</label>
                                    <input type="text" id="herbAlias" placeholder="其他名稱或別名" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">性味</label>
                                    <input type="text" id="herbNature" placeholder="例：甘、微苦，溫" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">歸經</label>
                                    <input type="text" id="herbMeridian" placeholder="例：肺、脾、腎經" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">功效</label>
                                    <textarea id="herbEffects" placeholder="請描述主要功效" rows="2" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">主治</label>
                                    <textarea id="herbIndications" placeholder="請描述主要治療範圍" rows="2" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">常用劑量</label>
                                    <input type="text" id="herbDosage" placeholder="例：3-9g" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">使用注意</label>
                                    <input type="text" id="herbCautions" placeholder="禁忌或注意事項" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-gray-200">
                                <button onclick="hideAddHerbForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                                    取消
                                </button>
                                <button onclick="saveHerb()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200">
                                    <span id="herbSaveButtonText">儲存</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 新增/編輯方劑表單彈窗 -->
                <div id="addFormulaModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                            <h3 id="formulaFormTitle" class="text-xl font-bold text-gray-800">新增方劑</h3>
                            <button onclick="hideAddFormulaForm()" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">方劑名稱 *</label>
                                        <input type="text" id="formulaName" placeholder="請輸入方劑名稱" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">出處</label>
                                        <input type="text" id="formulaSource" placeholder="例：傷寒論、金匱要略" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">功效</label>
                                        <textarea id="formulaEffects" placeholder="請描述方劑主要功效" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">主治</label>
                                        <textarea id="formulaIndications" placeholder="請描述主要治療病症" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                    </div>
                                </div>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">組成 *</label>
                                        <textarea id="formulaComposition" placeholder="請輸入方劑組成，例如：&#10;人參&#10;白朮&#10;茯苓&#10;甘草" rows="8" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">用法</label>
                                        <textarea id="formulaUsage" placeholder="煎煮方法、服用方式等" rows="2" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">注意事項</label>
                                        <textarea id="formulaCautions" placeholder="禁忌、注意事項等" rows="2" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-gray-200">
                                <button onclick="hideAddFormulaForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                                    取消
                                </button>
                                <button onclick="saveFormula()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition duration-200">
                                    <span id="formulaSaveButtonText">儲存</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 中藥庫列表 -->
                <div class="overflow-x-auto">
                    <div id="herbLibraryList" class="space-y-4">
                        <!-- 中藥庫內容會動態載入 -->
                    </div>
                </div>
            </div>

            <!-- 收費項目管理 -->
            <div id="billingManagement" class="hidden bg-white rounded-xl shadow-lg p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">收費項目管理</h2>
                    <div class="flex flex-col md:flex-row gap-3">
                        <div class="relative">
                            <input type="text" id="searchBilling" placeholder="搜尋收費項目名稱..." class="border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:ring-2 focus:ring-green-500 focus:border-transparent w-full md:w-64">
                            <span class="absolute right-3 top-2.5 text-gray-400">🔍</span>
                        </div>
                        <button onclick="showAddBillingItemForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200 whitespace-nowrap">
                            + 新增收費項目
                        </button>
                    </div>
                </div>

                <!-- 分類標籤 -->
                <div class="mb-6">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterBillingItems('all')" id="billing-filter-all" class="px-4 py-2 rounded-lg text-sm font-medium bg-blue-100 text-blue-800 transition duration-200">
                            全部
                        </button>
                        <button onclick="filterBillingItems('consultation')" id="billing-filter-consultation" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            診療費
                        </button>
                        <button onclick="filterBillingItems('medicine')" id="billing-filter-medicine" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            藥費
                        </button>
                        <button onclick="filterBillingItems('treatment')" id="billing-filter-treatment" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            治療費
                        </button>
                        <button onclick="filterBillingItems('other')" id="billing-filter-other" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            其他
                        </button>
                        <button onclick="filterBillingItems('discount')" id="billing-filter-discount" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            折扣項目
                        </button>
                        <button onclick="filterBillingItems('package')" id="billing-filter-package" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            套票項目
                        </button>
                    </div>
                </div>

                <!-- 新增/編輯收費項目表單彈窗 -->
                <div id="addBillingItemModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                            <h3 id="billingItemFormTitle" class="text-xl font-bold text-gray-800">新增收費項目</h3>
                            <button onclick="hideAddBillingItemForm()" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">項目名稱 *</label>
                                    <input type="text" id="billingItemName" placeholder="請輸入收費項目名稱" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">項目類別 *</label>
                                    <select id="billingItemCategory" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                        <option value="">請選擇類別</option>
                                        <option value="consultation">診療費</option>
                                        <option value="medicine">藥費</option>
                                        <option value="treatment">治療費</option>
                                        <option value="other">其他</option>
                                        <option value="discount">折扣項目</option>
                                        <option value="package">套票項目</option>
                                    </select>
                                </div>
                                <!-- 套票專用欄位：當類別選擇 package 時顯示 -->
                                <div id="packageFields" class="md:col-span-2 hidden">
                                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                      <label class="block text-sm font-medium text-gray-700 mb-1">套票可用次數 *</label>
                                      <input type="number" id="billingItemPackageUses" placeholder="例如：10" min="1"
                                             class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    </div>
                                    <div>
                                      <label class="block text-sm font-medium text-gray-700 mb-1">有效天數 *</label>
                                      <input type="number" id="billingItemValidityDays" placeholder="例如：180（半年）" min="1"
                                             class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                      <p class="text-xs text-gray-500 mt-1">自購買日起算</p>
                                    </div>
                                  </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">收費金額 *</label>
                                    <input type="number" id="billingItemPrice" placeholder="0" step="1" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">折扣項目：輸入0.9表示9折，輸入9會自動轉為9折，或輸入負數表示固定金額折扣</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">計費單位</label>
                                    <input type="text" id="billingItemUnit" placeholder="例：次、劑、包" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">項目說明</label>
                                    <textarea id="billingItemDescription" placeholder="請描述收費項目的詳細內容" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="billingItemActive" checked class="mr-2 rounded">
                                        <span class="text-sm font-medium text-gray-700">啟用此收費項目</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-gray-200">
                                <button onclick="hideAddBillingItemForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                                    取消
                                </button>
                                <button onclick="saveBillingItem()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200">
                                    <span id="billingItemSaveButtonText">儲存</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 收費項目列表 -->
                <div class="overflow-x-auto">
                    <div id="billingItemsList" class="space-y-4">
                        <!-- 收費項目內容會動態載入 -->
                    </div>
                </div>
            </div>

            <!-- 診所用戶管理 -->
            <div id="userManagement" class="hidden bg-white rounded-xl shadow-lg p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">診所用戶管理</h2>
                    <div class="flex flex-col md:flex-row gap-3">
                        <div class="relative">
                            <input type="text" id="searchUser" placeholder="搜尋用戶名稱或帳號..." class="border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:ring-2 focus:ring-green-500 focus:border-transparent w-full md:w-64">
                            <span class="absolute right-3 top-2.5 text-gray-400">🔍</span>
                        </div>
                        <button onclick="showAddUserForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200 whitespace-nowrap">
                            + 新增用戶
                        </button>
                    </div>
                </div>

                <!-- 狀態篩選標籤 -->
                <div class="mb-6">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterUsers('all')" id="user-filter-all" class="px-4 py-2 rounded-lg text-sm font-medium bg-blue-100 text-blue-800 transition duration-200">
                            全部用戶
                        </button>
                        <button onclick="filterUsers('inactive')" id="user-filter-inactive" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200">
                            已停用
                        </button>
                    </div>
                </div>

                <!-- 新增/編輯用戶表單彈窗 -->
                <div id="addUserModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                            <h3 id="userFormTitle" class="text-xl font-bold text-gray-800">新增用戶</h3>
                            <button onclick="hideAddUserForm()" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">帳號 *</label>
                                    <input type="text" id="userName" placeholder="請輸入登入帳號" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">帳號只能包含英文字母、數字和底線</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">密碼 *</label>
                                    <input type="password" id="userPassword" placeholder="請輸入密碼" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">密碼至少6個字符</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">姓名 *</label>
                                    <input type="text" id="userDisplayName" placeholder="請輸入真實姓名" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">職位 *</label>
                                    <select id="userPosition" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent" onchange="toggleRegistrationNumberField()">
                                        <option value="">請選擇職位</option>
                                        <option value="診所管理">診所管理</option>
                                        <option value="醫師">醫師</option>
                                        <option value="護理師">護理師</option>
                                    </select>
                                </div>
                                <div id="registrationNumberField" class="hidden">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">中醫註冊編號 *</label>
                                    <input type="text" id="userRegistrationNumber" placeholder="請輸入中醫註冊編號" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">醫師職位必須填寫註冊編號</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">電子郵件</label>
                                    <input type="email" id="userEmail" placeholder="請輸入電子郵件" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">電話號碼</label>
                                    <input type="tel" id="userPhone" placeholder="請輸入電話號碼" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="userActive" checked class="mr-2 rounded">
                                        <span class="text-sm font-medium text-gray-700">啟用此用戶帳號</span>
                                    </label>
                                    <p class="text-xs text-gray-500 mt-1">停用的帳號將無法登入系統</p>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-gray-200">
                                <button onclick="hideAddUserForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                                    取消
                                </button>
                                <button onclick="saveUser()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200">
                                    <span id="userSaveButtonText">儲存</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 用戶列表 -->
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">帳號</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">姓名</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">職位</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">註冊編號</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">電子郵件</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">狀態</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">最後登入</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">操作</th>
                            </tr>
                        </thead>
                        <tbody id="userList" class="divide-y divide-gray-200">
                            <!-- 用戶資料會動態載入 -->
                        </tbody>
                    </table>
                </div>
            </div>

<!-- 財務報表 -->
            <div id="financialReports" class="hidden bg-white rounded-xl shadow-lg p-6">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2 flex items-center">
                        <span class="mr-3">📊</span>財務報表
                    </h2>
                    <p class="text-gray-600">診所收入分析與財務統計</p>
                </div>

                <!-- 篩選控制區 -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">報表類型</label>
                            <select id="reportType" onchange="generateFinancialReport()" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="daily">日報表</option>
                                <option value="weekly">週報表</option>
                                <option value="monthly" selected>月報表</option>
                                <option value="yearly">年報表</option>
                                <option value="custom">自訂期間</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">快速選擇</label>
                            <select id="quickDate" onchange="setQuickDate()" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="">請選擇...</option>
                                <option value="today">今天</option>
                                <option value="yesterday">昨天</option>
                                <option value="thisWeek">本週</option>
                                <option value="lastWeek">上週</option>
                                <option value="thisMonth">本月</option>
                                <option value="lastMonth">上月</option>
                                <option value="thisYear">今年</option>
                                <option value="lastYear">去年</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">開始日期</label>
                            <input type="date" id="startDate" onchange="generateFinancialReport()" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">結束日期</label>
                            <input type="date" id="endDate" onchange="generateFinancialReport()" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">醫師篩選</label>
                            <select id="doctorFilter" onchange="generateFinancialReport()" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="">全部醫師</option>
                            </select>
                        </div>
                        
                        <div class="flex items-end space-x-2">
                            <button onclick="generateFinancialReport()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200 flex items-center">
                                <span class="mr-2">🔄</span>更新報表
                            </button>
                            <button onclick="exportFinancialReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition duration-200 flex items-center">
                                <span class="mr-2">📥</span>匯出
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 關鍵指標卡片 -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gradient-to-r from-green-400 to-green-600 text-white rounded-xl p-6 shadow-lg transform hover:scale-105 transition duration-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100 text-sm font-medium">總收入</p>
                                <h3 id="totalRevenue" class="text-3xl font-bold">$0</h3>
                                <p id="revenueChange" class="text-green-100 text-sm mt-1">統計期間收入</p>
                            </div>
                            <div class="bg-white bg-opacity-20 rounded-full p-3">
                                <span class="text-2xl">💰</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-blue-400 to-blue-600 text-white rounded-xl p-6 shadow-lg transform hover:scale-105 transition duration-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100 text-sm font-medium">診症人次</p>
                                <h3 id="totalConsultations" class="text-3xl font-bold">0</h3>
                                <p id="consultationChange" class="text-blue-100 text-sm mt-1">完成診症次數</p>
                            </div>
                            <div class="bg-white bg-opacity-20 rounded-full p-3">
                                <span class="text-2xl">👥</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-purple-400 to-purple-600 text-white rounded-xl p-6 shadow-lg transform hover:scale-105 transition duration-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100 text-sm font-medium">平均消費</p>
                                <h3 id="averageRevenue" class="text-3xl font-bold">$0</h3>
                                <p id="averageChange" class="text-purple-100 text-sm mt-1">每次診症平均</p>
                            </div>
                            <div class="bg-white bg-opacity-20 rounded-full p-3">
                                <span class="text-2xl">📊</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-orange-400 to-orange-600 text-white rounded-xl p-6 shadow-lg transform hover:scale-105 transition duration-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-orange-100 text-sm font-medium">活躍醫師</p>
                                <h3 id="activeDoctors" class="text-3xl font-bold">0</h3>
                                <p id="doctorChange" class="text-orange-100 text-sm mt-1">有診症的醫師</p>
                            </div>
                            <div class="bg-white bg-opacity-20 rounded-full p-3">
                                <span class="text-2xl">👨‍⚕️</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 詳細報表 -->
                <div class="bg-white border border-gray-200 rounded-lg">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 rounded-t-lg">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                                <span class="mr-2">📋</span>詳細財務報表
                            </h3>
                            <div class="text-sm text-gray-600">
                                資料更新時間：<span id="lastUpdateTime">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 標籤頁 -->
                    <div class="border-b border-gray-200">
                        <nav class="flex space-x-8 px-6" role="tablist">
                            <button onclick="switchFinancialTab('summary')" id="financialSummaryTab" class="py-4 px-1 border-b-2 border-green-500 text-green-600 font-medium text-sm transition duration-200">
                                收入摘要
                            </button>
                            <button onclick="switchFinancialTab('daily')" id="financialDailyTab" class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm transition duration-200">
                                每日明細
                            </button>
                            <button onclick="switchFinancialTab('doctor')" id="financialDoctorTab" class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm transition duration-200">
                                醫師業績
                            </button>
                            <button onclick="switchFinancialTab('service')" id="financialServiceTab" class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm transition duration-200">
                                服務分析
                            </button>
                        </nav>
                    </div>
                    
                    <!-- 標籤內容 -->
                    <div class="p-6">
                        <!-- 收入摘要標籤 -->
                        <div id="financialSummaryContent" class="financial-tab-content">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">項目</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">金額</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">佔比</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">備註</th>
                                        </tr>
                                    </thead>
                                    <tbody id="financialSummaryTableBody" class="divide-y divide-gray-200">
                                        <tr>
                                            <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                                                請點擊「更新報表」來載入資料
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- 每日明細標籤 -->
                        <div id="financialDailyContent" class="financial-tab-content hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">日期</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">診症人次</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">收入金額</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">平均消費</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">主要服務</th>
                                        </tr>
                                    </thead>
                                    <tbody id="financialDailyTableBody" class="divide-y divide-gray-200">
                                        <tr>
                                            <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                                                請點擊「更新報表」來載入資料
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- 醫師業績標籤 -->
                        <div id="financialDoctorContent" class="financial-tab-content hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">醫師</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">診症人次</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">總收入</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">平均消費</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">佔比</th>
                                        </tr>
                                    </thead>
                                    <tbody id="financialDoctorTableBody" class="divide-y divide-gray-200">
                                        <tr>
                                            <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                                                請點擊「更新報表」來載入資料
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- 服務分析標籤 -->
                        <div id="financialServiceContent" class="financial-tab-content hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">服務類型</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">次數</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">總金額</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">平均單價</th>
                                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">收入佔比</th>
                                        </tr>
                                    </thead>
                                    <tbody id="financialServiceTableBody" class="divide-y divide-gray-200">
                                        <tr>
                                            <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                                                請點擊「更新報表」來載入資料
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 系統管理 -->
            <div id="systemManagement" class="hidden bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">系統管理</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">診所統計</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span>總病人數：</span>
                                <span id="totalPatients" class="font-semibold">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>今日診症：</span>
                                <span id="todayConsultations" class="font-semibold">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>本月診症：</span>
                                <span id="monthlyConsultations" class="font-semibold">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">診所設定</h3>
                        <div class="space-y-3">
                            <div class="text-center py-4" id="clinicSettingsDisplay">
                                <div class="text-sm text-gray-700 mb-3">
                                    <div class="font-medium">診所中文名稱：<span id="displayChineseName">12334</span></div>
                                    <div class="text-gray-600 mt-1">診所英文名稱：<span id="displayEnglishName">12334 Clinic</span></div>
                                </div>
                                <button onclick="showClinicSettingsModal()" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                    診所資料修改
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">資料管理</h3>
                        <div class="space-y-3">
                            <button onclick="exportData()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                匯出資料
                            </button>
                            <button onclick="backupData()" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                備份資料
                            </button>
                            <button onclick="clearData()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                清除資料
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 診所資料修改彈窗 -->
    <div id="clinicSettingsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                <h3 class="text-xl font-bold text-gray-800">診所資料修改</h3>
                <button onclick="hideClinicSettingsModal()" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
            </div>
            
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">診所中文名稱 *</label>
                        <input type="text" id="clinicChineseName" placeholder="請輸入診所中文名稱" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">診所英文名稱</label>
                        <input type="text" id="clinicEnglishName" placeholder="請輸入診所英文名稱" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">診所營業時間</label>
                        <input type="text" id="clinicBusinessHours" placeholder="例：週一至週五 09:00-18:00" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">診所電話</label>
                        <input type="tel" id="clinicPhone" placeholder="請輸入診所電話號碼" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">診所地址</label>
                        <textarea id="clinicAddress" placeholder="請輸入診所完整地址" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-gray-200">
                    <button onclick="hideClinicSettingsModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                        取消
                    </button>
                    <button onclick="saveClinicSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition duration-200">
                        儲存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 系統資料儲存
        let currentUser = null;
        let currentUserData = null;
        
        // 診所設定
        let clinicSettings = JSON.parse(localStorage.getItem('clinicSettings') || '{}');
        if (!clinicSettings.chineseName) {
            clinicSettings.chineseName = '12334';
            clinicSettings.englishName = '12334 Clinic';
            clinicSettings.businessHours = '週一至週五 09:00-18:00';
            clinicSettings.phone = '(852) 2345-6789';
            clinicSettings.address = '香港中環皇后大道中123號';
            localStorage.setItem('clinicSettings', JSON.stringify(clinicSettings));
        }
        
        // 浮動提示功能
        function showToast(message, type = 'info') {
            // 移除現有的提示
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // 創建新的提示
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            // 設置圖標
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-content">${message}</div>
            `;
            
            // 添加到頁面
            document.body.appendChild(toast);
            
            // 顯示動畫
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // 2秒後淡出並移除
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 2000);
        }
        
        // 計算年齡函數
        function calculateAge(birthDate) {
            const birth = new Date(birthDate);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            
            return age;
        }
        
        // 格式化年齡顯示
        function formatAge(birthDate) {
            if (!birthDate) return '未知';
            
            const birth = new Date(birthDate);
            const today = new Date();
            
            let years = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                years--;
            }
            
            if (years > 0) {
                return `${years}歲`;
            } else {
                // 未滿一歲的嬰幼兒顯示月數
                let months = today.getMonth() - birth.getMonth();
                let days = today.getDate() - birth.getDate();
                
                if (days < 0) {
                    months--;
                    const lastMonth = new Date(today.getFullYear(), today.getMonth(), 0);
                    days += lastMonth.getDate();
                }
                
                if (months < 0) {
                    months += 12;
                }
                
                if (months > 0) {
                    return `${months}個月`;
                } else {
                    return `${days}天`;
                }
            }
        }
        
        // 生成病人編號函數
        function generatePatientNumber() {
            const existingNumbers = patients
                .map(p => p.patientNumber)
                .filter(num => num && num.startsWith('P'))
                .map(num => parseInt(num.substring(1)))
                .filter(num => !isNaN(num));
            
            const maxNumber = existingNumbers.length > 0 ? Math.max(...existingNumbers) : 0;
            const newNumber = maxNumber + 1;
            return `P${newNumber.toString().padStart(6, '0')}`;
        }

        // 預設測試病人資料
        const defaultPatients = [
            {
                id: 1001,
                patientNumber: 'P000001',
                name: '王小明',
                gender: '男',
                phone: '0912-345-678',
                birthDate: '1989-03-15',
                address: '台北市大安區信義路四段123號',
                history: '高血壓病史3年，偶有頭暈症狀',
                createdAt: new Date('2024-01-15').toISOString()
            },
            {
                id: 1002,
                patientNumber: 'P000002',
                name: '李美華',
                gender: '女',
                phone: '0923-456-789',
                birthDate: '1996-07-22',
                address: '新北市板橋區中山路二段456號',
                history: '經常性失眠，工作壓力大',
                createdAt: new Date('2024-01-20').toISOString()
            },
            {
                id: 1003,
                patientNumber: 'P000003',
                name: '張志強',
                gender: '男',
                phone: '0934-567-890',
                birthDate: '1982-11-08',
                address: '桃園市中壢區中正路789號',
                history: '慢性胃炎，飲食不規律',
                createdAt: new Date('2024-02-01').toISOString()
            },
            {
                id: 1004,
                patientNumber: 'P000004',
                name: '陳雅婷',
                gender: '女',
                phone: '0945-678-901',
                birthDate: '1993-05-12',
                address: '台中市西屯區台灣大道三段321號',
                history: '月經不調，經常腰酸背痛',
                createdAt: new Date('2024-02-10').toISOString()
            },
            {
                id: 1005,
                patientNumber: 'P000005',
                name: '林大偉',
                gender: '男',
                phone: '0956-789-012',
                birthDate: '1969-12-03',
                address: '高雄市前金區中正四路654號',
                history: '糖尿病患者，需定期追蹤血糖',
                createdAt: new Date('2024-02-15').toISOString()
            }
        ];

        // 初始化病人資料（如果本地儲存為空則載入預設資料）
        let patients = JSON.parse(localStorage.getItem('patients') || '[]');
        if (patients.length === 0) {
            patients = defaultPatients;
            localStorage.setItem('patients', JSON.stringify(patients));
        } else {
            // 為舊資料補充病人編號
            let needsUpdate = false;
            patients.forEach(patient => {
                if (!patient.patientNumber) {
                    patient.patientNumber = generatePatientNumber();
                    needsUpdate = true;
                }
            });
            if (needsUpdate) {
                localStorage.setItem('patients', JSON.stringify(patients));
            }
        }
        
        // 預設診症記錄
        const defaultConsultations = [
            {
                id: 2001,
                appointmentId: 3001,
                patientId: 1001,
                symptoms: '頭痛頭暈，血壓偏高，伴有心悸，睡眠品質不佳',
                tongue: '舌質紅，苔薄黃',
                pulse: '脈弦數',
                currentHistory: '患者3年前診斷高血壓，平時血壓控制不穩定，近期工作壓力大，頭痛症狀加重',
                diagnosis: '眩暈（高血壓病）',
                syndrome: '肝陽上亢證',
                prescription: '天麻鉤藤飲加減\n天麻 10g\n鉤藤 15g\n石決明 30g\n梔子 10g\n黃芩 10g\n川牛膝 15g\n杜仲 15g\n益母草 15g\n夜交藤 20g\n茯神 15g',
                usage: '水煎服，每日一劑，分早晚兩次溫服',
                treatmentCourse: '7天',
                instructions: '注意休息，避免情緒激動，定期監測血壓，飲食清淡少鹽',
                followUpDate: '2024-03-01T09:00',
                date: new Date('2024-02-23T10:30').toISOString(),
                doctor: 'drzhang',
                status: 'completed'
            },
            {
                id: 2002,
                appointmentId: 3002,
                patientId: 1002,
                symptoms: '失眠多夢，入睡困難，易醒，伴有心煩，工作壓力大',
                tongue: '舌質淡紅，苔薄白',
                pulse: '脈細數',
                currentHistory: '患者近半年來工作壓力增大，睡眠品質逐漸下降，每晚需1-2小時才能入睡',
                diagnosis: '不寐（失眠症）',
                syndrome: '心腎不交證',
                prescription: '甘麥大棗湯合交泰丸加減\n甘草 6g\n小麥 30g\n大棗 10枚\n黃連 3g\n肉桂 1g\n酸棗仁 20g\n龍骨 15g\n牡蠣 15g\n遠志 10g\n茯神 15g',
                usage: '水煎服，每日一劑，晚餐後及睡前各服一次',
                treatmentCourse: '10天',
                instructions: '睡前避免使用電子產品，保持規律作息，可適當進行放鬆運動',
                followUpDate: '2024-03-05T14:00',
                date: new Date('2024-02-25T14:15').toISOString(),
                doctor: 'drzhang',
                status: 'completed'
            },
            {
                id: 2003,
                appointmentId: 3003,
                patientId: 1003,
                symptoms: '胃脘脹痛，食後加重，噯氣頻繁，食慾不振',
                tongue: '舌質淡，苔白膩',
                pulse: '脈弦滑',
                currentHistory: '患者有慢性胃炎病史，平時飲食不規律，常有胃脘不適，近期症狀加重',
                diagnosis: '胃痛（慢性胃炎）',
                syndrome: '脾胃虛弱，濕滯中焦證',
                prescription: '香砂六君子湯加減\n黨參 15g\n白朮 10g\n茯苓 15g\n甘草 6g\n陳皮 10g\n半夏 10g\n木香 6g\n砂仁 6g\n枳殼 10g\n神麴 15g',
                usage: '水煎服，每日一劑，飯前30分鐘溫服',
                treatmentCourse: '14天',
                instructions: '規律飲食，細嚼慢嚥，避免生冷辛辣食物，保持心情愉快',
                followUpDate: '2024-03-10T10:30',
                date: new Date('2024-02-26T10:45').toISOString(),
                doctor: 'drzhang',
                status: 'completed'
            }
        ];

        let consultations = JSON.parse(localStorage.getItem('consultations') || '[]');
        if (consultations.length === 0) {
            consultations = defaultConsultations;
            localStorage.setItem('consultations', JSON.stringify(consultations));
        }
        
        // 預設掛號記錄
        const defaultAppointments = [
            {
                id: 3001,
                patientId: 1001,
                appointmentTime: new Date('2024-02-23T10:00').toISOString(),
                appointmentDoctor: 'drzhang',
                chiefComplaint: '頭痛頭暈，血壓偏高',
                status: 'completed',
                createdAt: new Date('2024-02-22T15:30').toISOString(),
                createdBy: 'nurse_amy',
                arrivedAt: new Date('2024-02-23T09:55').toISOString(),
                confirmedBy: 'nurse_amy',
                consultationStartTime: new Date('2024-02-23T10:30').toISOString(),
                consultingDoctor: 'drzhang',
                completedAt: new Date('2024-02-23T11:15').toISOString(),
                consultationId: 2001,
                completedBy: 'drzhang'
            },
            {
                id: 3002,
                patientId: 1002,
                appointmentTime: new Date('2024-02-25T14:00').toISOString(),
                appointmentDoctor: 'drzhang',
                chiefComplaint: '失眠多夢，入睡困難',
                status: 'completed',
                createdAt: new Date('2024-02-24T10:20').toISOString(),
                createdBy: 'nurse_amy',
                arrivedAt: new Date('2024-02-25T13:50').toISOString(),
                confirmedBy: 'nurse_amy',
                consultationStartTime: new Date('2024-02-25T14:15').toISOString(),
                consultingDoctor: 'drzhang',
                completedAt: new Date('2024-02-25T15:00').toISOString(),
                consultationId: 2002,
                completedBy: 'drzhang'
            },
            {
                id: 3003,
                patientId: 1003,
                appointmentTime: new Date('2024-02-26T10:30').toISOString(),
                appointmentDoctor: 'drzhang',
                chiefComplaint: '胃脘脹痛，食後加重',
                status: 'completed',
                createdAt: new Date('2024-02-25T16:45').toISOString(),
                createdBy: 'nurse_amy',
                arrivedAt: new Date('2024-02-26T10:25').toISOString(),
                confirmedBy: 'nurse_amy',
                consultationStartTime: new Date('2024-02-26T10:45').toISOString(),
                consultingDoctor: 'drzhang',
                completedAt: new Date('2024-02-26T11:30').toISOString(),
                consultationId: 2003,
                completedBy: 'drzhang'
            }
        ];

        let appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
        if (appointments.length === 0) {
            appointments = defaultAppointments;
            localStorage.setItem('appointments', JSON.stringify(appointments));
        } else {
            // 為舊資料補充醫師欄位
            let needsUpdate = false;
            appointments.forEach(appointment => {
                if (!appointment.appointmentDoctor) {
                    appointment.appointmentDoctor = 'drzhang'; // 預設為張醫師
                    needsUpdate = true;
                }
            });
            if (needsUpdate) {
                localStorage.setItem('appointments', JSON.stringify(appointments));
            }
        }

        // 預設中藥材資料
        const defaultHerbs = [
            {
                id: 5001,
                type: 'herb',
                name: '人參',
                alias: '紅參、白參',
                nature: '甘、微苦，微溫',
                meridian: '脾、肺、心經',
                effects: '大補元氣，復脈固脫，補脾益肺，生津安神',
                indications: '體虛欲脫，肢冷脈微，脾虛食少，肺虛喘咳，津傷口渴，內熱消渴，久病虛羸，驚悸失眠，陽痿宮冷',
                dosage: '3-9g',
                cautions: '不宜與藜蘆同用',
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 5002,
                type: 'herb',
                name: '白朮',
                alias: '於朮、冬朮',
                nature: '甘、苦，溫',
                meridian: '脾、胃經',
                effects: '健脾益氣，燥濕利水，止汗，安胎',
                indications: '脾虛食少，腹脹泄瀉，痰飲眩悸，水腫，自汗，胎動不安',
                dosage: '6-12g',
                cautions: '陰虛燥渴，氣滯脹悶者忌服',
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 5003,
                type: 'herb',
                name: '茯苓',
                alias: '白茯苓、雲苓',
                nature: '甘、淡，平',
                meridian: '心、肺、脾、腎經',
                effects: '利水滲濕，健脾，寧心',
                indications: '水腫尿少，痰飲眩悸，脾虛食少，便溏泄瀉，心神不安，驚悸失眠',
                dosage: '10-15g',
                cautions: '虛寒精滑或氣虛下陷者忌服',
                createdAt: new Date('2024-01-01').toISOString()
            }
        ];

        // 預設方劑資料
        const defaultFormulas = [
            {
                id: 6001,
                type: 'formula',
                name: '四君子湯',
                source: '太平惠民和劑局方',
                effects: '益氣健脾',
                indications: '脾胃氣虛，面色萎白，語聲低微，氣短乏力，食少便溏，舌淡苔白，脈虛弱',
                composition: '人參\n白朮\n茯苓\n甘草',
                usage: '水煎服，每日一劑，分二次溫服',
                cautions: '陰虛火旺者慎用',
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 6002,
                type: 'formula',
                name: '六君子湯',
                source: '醫學正傳',
                effects: '益氣健脾，燥濕化痰',
                indications: '脾胃氣虛兼有痰濕，食少便溏，胸脘痞悶，嘔逆等症',
                composition: '人參\n白朮\n茯苓\n甘草\n陳皮\n半夏',
                usage: '水煎服，每日一劑，分二次溫服',
                cautions: '陰虛燥咳、津液不足者忌用',
                createdAt: new Date('2024-01-01').toISOString()
            }
        ];

        // 初始化中藥庫資料
        let herbLibrary = JSON.parse(localStorage.getItem('herbLibrary') || '[]');
        if (herbLibrary.length === 0) {
            herbLibrary = [...defaultHerbs, ...defaultFormulas];
            localStorage.setItem('herbLibrary', JSON.stringify(herbLibrary));
        }

        // 預設收費項目資料
        const defaultBillingItems = [
            // 診療費類別
            {
                id: 4001,
                name: '診金',
                category: 'consultation',
                price: 150,
                unit: '次',
                description: '中醫師診症費用',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4002,
                name: '複診費',
                category: 'consultation',
                price: 120,
                unit: '次',
                description: '複診病人診症費用',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4003,
                name: '急診費',
                category: 'consultation',
                price: 200,
                unit: '次',
                description: '急診或非辦公時間診症',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            
            // 藥費類別
            {
                id: 4011,
                name: '中藥調劑費',
                category: 'medicine',
                price: 25,
                unit: '劑',
                description: '中藥材調劑及包裝費用',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4012,
                name: '濃縮中藥粉',
                category: 'medicine',
                price: 15,
                unit: '包',
                description: '科學中藥濃縮粉劑',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4013,
                name: '外用藥膏',
                category: 'medicine',
                price: 80,
                unit: '支',
                description: '中藥外用藥膏',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4014,
                name: '藥酒',
                category: 'medicine',
                price: 120,
                unit: '瓶',
                description: '中藥浸製藥酒',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            
            // 治療費類別
            {
                id: 4021,
                name: '針灸治療',
                category: 'treatment',
                price: 100,
                unit: '次',
                description: '針灸穴位治療',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4022,
                name: '推拿按摩',
                category: 'treatment',
                price: 150,
                unit: '次',
                description: '中醫推拿按摩治療',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4023,
                name: '拔罐治療',
                category: 'treatment',
                price: 80,
                unit: '次',
                description: '拔罐療法',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4024,
                name: '刮痧治療',
                category: 'treatment',
                price: 60,
                unit: '次',
                description: '刮痧療法',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4025,
                name: '艾灸治療',
                category: 'treatment',
                price: 90,
                unit: '次',
                description: '艾條灸法治療',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4026,
                name: '電針治療',
                category: 'treatment',
                price: 120,
                unit: '次',
                description: '電針刺激治療',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4027,
                name: '耳針治療',
                category: 'treatment',
                price: 70,
                unit: '次',
                description: '耳穴針刺治療',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4028,
                name: '小兒推拿',
                category: 'treatment',
                price: 100,
                unit: '次',
                description: '小兒推拿按摩',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            
            // 其他類別
            {
                id: 4031,
                name: '診斷書',
                category: 'other',
                price: 50,
                unit: '份',
                description: '中醫診斷證明書',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4032,
                name: '病假證明',
                category: 'other',
                price: 30,
                unit: '份',
                description: '病假證明書',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4033,
                name: '體質調理諮詢',
                category: 'other',
                price: 200,
                unit: '次',
                description: '個人體質分析及調理建議',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4034,
                name: '飲食指導',
                category: 'other',
                price: 80,
                unit: '次',
                description: '中醫飲食療法指導',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4035,
                name: '養生保健諮詢',
                category: 'other',
                price: 120,
                unit: '次',
                description: '中醫養生保健指導',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            
            // 折扣項目類別
            {
                id: 4041,
                name: '長者優惠',
                category: 'discount',
                price: 0.9, // 9折
                unit: '',
                description: '65歲以上長者9折優惠',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4042,
                name: '學生優惠',
                category: 'discount',
                price: 0.85, // 85折
                unit: '',
                description: '學生憑證85折優惠',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4043,
                name: '會員優惠',
                category: 'discount',
                price: 0.95, // 95折
                unit: '',
                description: '診所會員95折優惠',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4044,
                name: '療程套餐折扣',
                category: 'discount',
                price: 0.8, // 8折
                unit: '',
                description: '購買療程套餐8折優惠',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4045,
                name: '初診優惠',
                category: 'discount',
                price: -50, // 固定減50元
                unit: '',
                description: '首次就診減免50元',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4046,
                name: '複診優惠券',
                category: 'discount',
                price: -30, // 固定減30元
                unit: '',
                description: '複診優惠券減免30元',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4047,
                name: '家庭套餐折扣',
                category: 'discount',
                price: 0.75, // 75折
                unit: '',
                description: '家庭成員同時就診75折',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4048,
                name: '節日特惠',
                category: 'discount',
                price: 0.88, // 88折
                unit: '',
                description: '節日期間特別優惠88折',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            // 套票項目類別
            {
                id: 4051,
                name: '中醫養生套餐',
                category: 'package',
                price: 1200,
                unit: '套',
                description: '包含：診症1次 + 針灸3次 + 中藥7劑，適合日常保健',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4052,
                name: '針灸療程套票（10次）',
                category: 'package',
                price: 800,
                unit: '套',
                description: '針灸治療10次套票，單次使用價值$100，套票價$800',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4053,
                name: '推拿按摩套票（5次）',
                category: 'package',
                price: 600,
                unit: '套',
                description: '推拿按摩5次套票，單次使用價值$150，套票價$600',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4054,
                name: '中醫調理療程',
                category: 'package',
                price: 2000,
                unit: '套',
                description: '包含：初診1次 + 複診3次 + 針灸8次 + 中藥21劑，3週完整調理',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4055,
                name: '家庭保健套餐',
                category: 'package',
                price: 3000,
                unit: '套',
                description: '適合3-4人家庭，包含體質分析、養生指導、預防保健諮詢',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4056,
                name: '痛症專項套票',
                category: 'package',
                price: 1500,
                unit: '套',
                description: '專治各種痛症，包含：診症2次 + 針灸6次 + 推拿4次 + 外用藥膏',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4057,
                name: '月子調理套餐',
                category: 'package',
                price: 2500,
                unit: '套',
                description: '產後調理專用，包含：診症4次 + 中藥28劑 + 營養指導 + 體質調理',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            },
            {
                id: 4058,
                name: '學生健康套票',
                category: 'package',
                price: 800,
                unit: '套',
                description: '學生專享優惠套票，包含：診症2次 + 針灸3次 + 健康指導',
                active: true,
                createdAt: new Date('2024-01-01').toISOString()
            }
        ];

        // 初始化收費項目資料
        let billingItems = JSON.parse(localStorage.getItem('billingItems') || '[]');
        if (billingItems.length === 0) {
            billingItems = defaultBillingItems;
            localStorage.setItem('billingItems', JSON.stringify(billingItems));
        }

        // 預設用戶資料
        const defaultUsers = [
            {
                id: 1,
                username: 'manager',
                password: 'manager2024',
                name: '陳經理',
                position: '診所管理',
                email: 'manager@tcmclinic.com',
                phone: '02-8888-1001',
                active: true,
                createdAt: new Date('2024-01-01').toISOString(),
                lastLogin: null
            },
            {
                id: 2,
                username: 'drzhang',
                password: 'zhang888',
                name: '張中醫師',
                position: '醫師',
                registrationNumber: 'CM001234',
                email: 'drzhang@tcmclinic.com',
                phone: '02-8888-1002',
                active: true,
                createdAt: new Date('2024-01-01').toISOString(),
                lastLogin: null
            },
            {
                id: 3,
                username: 'nurse_amy',
                password: 'amy2024',
                name: '林護理師',
                position: '護理師',
                email: 'amy@tcmclinic.com',
                phone: '02-8888-1003',
                active: true,
                createdAt: new Date('2024-01-01').toISOString(),
                lastLogin: null
            }
        ];

        // 初始化用戶資料
        let users = JSON.parse(localStorage.getItem('users') || '[]');
        if (users.length === 0) {
            users = defaultUsers;
            localStorage.setItem('users', JSON.stringify(users));
        }

        // 所有用戶都有完整權限
        const allPermissions = ['patientManagement', 'consultationSystem', 'herbLibrary', 'billingManagement', 'financialReports', 'userManagement', 'systemManagement'];

        // 主要登入功能
        function attemptMainLogin() {
            const username = document.getElementById('mainLoginUsername').value.trim();
            const password = document.getElementById('mainLoginPassword').value.trim();
            
            if (!username || !password) {
                showToast('請輸入帳號和密碼！', 'error');
                return;
            }
            
            // 尋找匹配的用戶
            const user = users.find(u => 
                u.username === username && 
                u.password === password && 
                u.active
            );
            
            if (!user) {
                // 檢查是否帳號存在但密碼錯誤
                const existingUser = users.find(u => u.username === username);
                if (existingUser) {
                    if (!existingUser.active) {
                        showToast('此帳號已被停用，請聯繫管理員！', 'error');
                    } else {
                        showToast('密碼錯誤，請重新輸入！', 'error');
                    }
                } else {
                    showToast('帳號不存在，請檢查輸入！', 'error');
                }
                
                // 清空密碼欄位
                document.getElementById('mainLoginPassword').value = '';
                document.getElementById('mainLoginPassword').focus();
                return;
            }
            
            // 登入成功
            performLogin(user);
        }
        
        // 執行登入
        function performLogin(user) {
            // 更新最後登入時間
            const userIndex = users.findIndex(u => u.id === user.id);
            if (userIndex !== -1) {
                users[userIndex].lastLogin = new Date().toISOString();
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            currentUser = user.username;
            currentUserData = user;
            
            // 切換到主系統
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainSystem').classList.remove('hidden');
            
            document.getElementById('userRole').textContent = `當前用戶：${getUserDisplayName(user)}`;
            document.getElementById('sidebarUserRole').textContent = `當前用戶：${getUserDisplayName(user)}`;
            
            generateSidebarMenu();
            updateStatistics();
            
            showToast(`歡迎回來，${getUserDisplayName(user)}！`, 'success');
        }

        // 側邊選單控制
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        // 登出功能
        function logout() {
            currentUser = null;
            currentUserData = null;
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('mainSystem').classList.add('hidden');
            document.getElementById('sidebar').classList.add('-translate-x-full');
            document.getElementById('sidebarOverlay').classList.add('hidden');
            hideAllSections();
        }

        // 生成側邊選單
        function generateSidebarMenu() {
            const menuContainer = document.getElementById('sidebarMenu');
            menuContainer.innerHTML = '';
            
            const menuItems = {
                patientManagement: { title: '病人資料管理', icon: '👥', description: '新增、查看、管理病人資料' },
                consultationSystem: { title: '診症系統', icon: '🩺', description: '記錄症狀、診斷、開立處方' },
                herbLibrary: { title: '中藥庫管理', icon: '🌿', description: '管理中藥材及方劑資料' },
                billingManagement: { title: '收費項目管理', icon: '💰', description: '管理診療費用及收費項目' },
                userManagement: { title: '診所用戶管理', icon: '👤', description: '管理診所用戶帳號及權限' },
                financialReports: { title: '財務報表', icon: '📊', description: '收入分析與財務統計' },
                systemManagement: { title: '系統管理', icon: '⚙️', description: '統計資料、備份匯出' }
            };
            
            allPermissions.forEach(permission => {
                const item = menuItems[permission];
                const button = document.createElement('button');
                button.className = 'w-full text-left p-4 rounded-lg hover:bg-gray-100 transition duration-200 border border-gray-200 mb-2';
                button.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-2xl mr-4">${item.icon}</span>
                        <div>
                            <div class="font-semibold text-gray-800">${item.title}</div>
                            <div class="text-sm text-gray-600">${item.description}</div>
                        </div>
                    </div>
                `;
                button.onclick = () => {
                    showSection(permission);
                    toggleSidebar();
                };
                menuContainer.appendChild(button);
            });
        }

        // 顯示指定區域
        function showSection(sectionId) {
            hideAllSections();
            document.getElementById('welcomePage').classList.add('hidden');
            document.getElementById(sectionId).classList.remove('hidden');
            
            if (sectionId === 'patientManagement') {
                loadPatientList();
            } else if (sectionId === 'consultationSystem') {
                loadConsultationSystem();
            } else if (sectionId === 'herbLibrary') {
                loadHerbLibrary();
            } else if (sectionId === 'billingManagement') {
                loadBillingManagement();
            } else if (sectionId === 'financialReports') {
                loadFinancialReports();
            } else if (sectionId === 'userManagement') {
                loadUserManagement();
            }
        }

        // 隱藏所有區域
        function hideAllSections() {
            ['patientManagement', 'consultationSystem', 'herbLibrary', 'billingManagement', 'userManagement', 'financialReports', 'systemManagement', 'welcomePage'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
        }

        // 病人管理功能
        let editingPatientId = null;
        let filteredPatients = [];
        
        // 更新病人年齡顯示
        function updatePatientAge() {
            const birthDate = document.getElementById('patientBirthDate').value;
            const ageInput = document.getElementById('patientAge');
            
            if (birthDate) {
                const age = calculateAge(birthDate);
                ageInput.value = age;
            } else {
                ageInput.value = '';
            }
        }

        function showAddPatientForm() {
            editingPatientId = null;
            document.getElementById('formTitle').textContent = '新增病人資料';
            document.getElementById('saveButtonText').textContent = '儲存';
            document.getElementById('addPatientModal').classList.remove('hidden');
            clearPatientForm();
        }

        function hideAddPatientForm() {
            document.getElementById('addPatientModal').classList.add('hidden');
            clearPatientForm();
            editingPatientId = null;
        }

        function clearPatientForm() {
            ['patientName', 'patientAge', 'patientGender', 'patientPhone', 'patientIdCard', 'patientBirthDate', 'patientAddress', 'patientAllergies', 'patientHistory'].forEach(id => {
                document.getElementById(id).value = '';
            });
        }

        function savePatient() {
            const patient = {
                id: editingPatientId || Date.now(),
                patientNumber: editingPatientId ? patients.find(p => p.id === editingPatientId).patientNumber : generatePatientNumber(),
                name: document.getElementById('patientName').value.trim(),
                age: document.getElementById('patientAge').value,
                gender: document.getElementById('patientGender').value,
                phone: document.getElementById('patientPhone').value.trim(),
                idCard: document.getElementById('patientIdCard').value.trim(),
                birthDate: document.getElementById('patientBirthDate').value,
                address: document.getElementById('patientAddress').value.trim(),
                allergies: document.getElementById('patientAllergies').value.trim(),
                history: document.getElementById('patientHistory').value.trim(),
                createdAt: editingPatientId ? patients.find(p => p.id === editingPatientId).createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            // 驗證必填欄位
            if (!patient.name || !patient.gender || !patient.phone || !patient.birthDate) {
                showToast('請填寫必要資料（姓名、性別、電話、出生日期）！', 'error');
                return;
            }

            // 驗證出生日期
            const birthDate = new Date(patient.birthDate);
            const today = new Date();
            if (birthDate > today) {
                showToast('出生日期不能晚於今天！', 'error');
                return;
            }

            // 計算年齡
            const calculatedAge = calculateAge(patient.birthDate);
            if (calculatedAge > 120) {
                showToast('請確認出生日期是否正確！', 'error');
                return;
            }

            // 驗證電話格式
            const phoneRegex = /^[0-9\-\+\(\)\s]+$/;
            if (!phoneRegex.test(patient.phone)) {
                showToast('請輸入有效的電話號碼！', 'error');
                return;
            }

            // 驗證身分證格式（如果有填寫）
            if (patient.idCard) {
                const idRegex = /^[A-Z][12][0-9]{8}$/;
                if (!idRegex.test(patient.idCard)) {
                    showToast('請輸入有效的身分證字號格式（例：A123456789）！', 'error');
                    return;
                }
            }

            if (editingPatientId) {
                // 更新現有病人
                const index = patients.findIndex(p => p.id === editingPatientId);
                patients[index] = patient;
                showToast('病人資料已成功更新！', 'success');
            } else {
                // 新增病人
                patients.push(patient);
                showToast('病人資料已成功新增！', 'success');
            }

            localStorage.setItem('patients', JSON.stringify(patients));
            loadPatientList();
            hideAddPatientForm();
            updateStatistics();
        }

        function loadPatientList() {
            const tbody = document.getElementById('patientList');
            const searchTerm = document.getElementById('searchPatient').value.toLowerCase();
            
            // 過濾病人資料
            filteredPatients = patients.filter(patient => 
                patient.name.toLowerCase().includes(searchTerm) ||
                patient.phone.includes(searchTerm) ||
                (patient.idCard && patient.idCard.toLowerCase().includes(searchTerm)) ||
                (patient.patientNumber && patient.patientNumber.toLowerCase().includes(searchTerm))
            );

            tbody.innerHTML = '';

            if (filteredPatients.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            ${searchTerm ? '沒有找到符合條件的病人' : '尚無病人資料'}
                        </td>
                    </tr>
                `;
                return;
            }

            filteredPatients.forEach(patient => {

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-blue-600 font-medium">${patient.patientNumber || '未設定'}</td>
                    <td class="px-4 py-3 text-sm text-gray-900 font-medium">${patient.name}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${formatAge(patient.birthDate)}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${patient.gender}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${patient.phone}</td>

                    <td class="px-4 py-3 text-sm space-x-2">
                        <button onclick="viewPatient(${patient.id})" class="text-blue-600 hover:text-blue-800">查看</button>
                        <button onclick="showPatientMedicalHistory(${patient.id})" class="text-purple-600 hover:text-purple-800">病歷</button>
                        <button onclick="editPatient(${patient.id})" class="text-green-600 hover:text-green-800">編輯</button>
                        <button onclick="deletePatient(${patient.id})" class="text-red-600 hover:text-red-800">刪除</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function editPatient(id) {
            const patient = patients.find(p => p.id === id);
            if (!patient) return;

            editingPatientId = id;
            document.getElementById('formTitle').textContent = '編輯病人資料';
            document.getElementById('saveButtonText').textContent = '更新';
            
            // 填入現有資料
            document.getElementById('patientName').value = patient.name || '';
            document.getElementById('patientGender').value = patient.gender || '';
            document.getElementById('patientPhone').value = patient.phone || '';
            document.getElementById('patientIdCard').value = patient.idCard || '';
            document.getElementById('patientBirthDate').value = patient.birthDate || '';
            document.getElementById('patientAddress').value = patient.address || '';
            document.getElementById('patientAllergies').value = patient.allergies || '';
            document.getElementById('patientHistory').value = patient.history || '';
            
            // 自動計算年齡
            updatePatientAge();
            
            document.getElementById('addPatientModal').classList.remove('hidden');
        }

        function deletePatient(id) {
            const patient = patients.find(p => p.id === id);
            if (!patient) return;

            if (confirm(`確定要刪除病人「${patient.name}」的資料嗎？\n\n注意：相關的診症記錄也會一併刪除！`)) {
                // 刪除病人資料
                patients = patients.filter(p => p.id !== id);
                // 刪除相關診症記錄
                consultations = consultations.filter(c => c.patientId !== id);
                // 刪除相關掛號記錄
                appointments = appointments.filter(a => a.patientId !== id);
                
                localStorage.setItem('patients', JSON.stringify(patients));
                localStorage.setItem('consultations', JSON.stringify(consultations));
                localStorage.setItem('appointments', JSON.stringify(appointments));
                
                loadPatientList();
                updateStatistics();
                showToast('病人資料及相關診症記錄已刪除！', 'success');
            }
        }

        function viewPatient(id) {
            const patient = patients.find(p => p.id === id);
            if (!patient) return;

            // 獲取該病人的診症記錄統計
            const patientConsultations = consultations.filter(c => c.patientId === id);
            const totalConsultations = patientConsultations.length;
            const lastConsultation = patientConsultations.length > 0 ? 
                patientConsultations.sort((a, b) => new Date(b.date) - new Date(a.date))[0] : null;

            const content = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <h4 class="text-lg font-semibold text-gray-800 border-b pb-2">基本資料</h4>
                        <div class="space-y-2">
                            <div><span class="font-medium">病人編號：</span><span class="text-blue-600 font-semibold">${patient.patientNumber || '未設定'}</span></div>
                            <div><span class="font-medium">姓名：</span>${patient.name}</div>
                            <div><span class="font-medium">年齡：</span>${formatAge(patient.birthDate)}</div>
                            <div><span class="font-medium">性別：</span>${patient.gender}</div>
                            <div><span class="font-medium">電話：</span>${patient.phone}</div>
                            ${patient.idCard ? `<div><span class="font-medium">身分證：</span>${patient.idCard}</div>` : ''}
                            ${patient.birthDate ? `<div><span class="font-medium">出生日期：</span>${new Date(patient.birthDate).toLocaleDateString('zh-TW')}</div>` : ''}
                            ${patient.address ? `<div><span class="font-medium">地址：</span>${patient.address}</div>` : ''}
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <h4 class="text-lg font-semibold text-gray-800 border-b pb-2">醫療資訊</h4>
                        <div class="space-y-2">
                            ${patient.allergies ? `<div><span class="font-medium">過敏史：</span><div class="mt-1 p-2 bg-red-50 rounded text-sm">${patient.allergies}</div></div>` : ''}
                            ${patient.history ? `<div><span class="font-medium">病史：</span><div class="mt-1 p-2 bg-gray-50 rounded text-sm">${patient.history}</div></div>` : ''}
                            <div><span class="font-medium">建檔日期：</span>${new Date(patient.createdAt).toLocaleDateString('zh-TW')}</div>
                            ${patient.updatedAt ? `<div><span class="font-medium">更新日期：</span>${new Date(patient.updatedAt).toLocaleDateString('zh-TW')}</div>` : ''}
                        </div>
                    </div>
                </div>
                
                <!-- 診症記錄摘要 -->
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-semibold text-gray-800">診症記錄摘要</h4>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="bg-blue-50 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-blue-600">${totalConsultations}</div>
                            <div class="text-sm text-blue-800">總診症次數</div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4 text-center">
                            <div class="text-lg font-semibold text-green-600">
                                ${lastConsultation ? new Date(lastConsultation.date).toLocaleDateString('zh-TW') : '無'}
                            </div>
                            <div class="text-sm text-green-800">最近診症</div>
                        </div>
                        <div class="bg-orange-50 rounded-lg p-4 text-center">
                            <div class="text-lg font-semibold text-orange-600">
                                ${lastConsultation ? (lastConsultation.followUpDate ? 
                                    new Date(lastConsultation.followUpDate).toLocaleDateString('zh-TW') : '無安排') : '無'}
                            </div>
                            <div class="text-sm text-orange-800">下次複診</div>
                        </div>
                    </div>
                    
                    ${totalConsultations > 0 ? `
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h5 class="font-medium text-gray-800 mb-2">最近診症記錄</h5>
                            <div class="text-sm text-gray-700">
                                <div><span class="font-medium">診斷：</span>${lastConsultation.diagnosis || '無記錄'}</div>
                                <div class="mt-1"><span class="font-medium">證型：</span>${lastConsultation.syndrome || '無記錄'}</div>
                                ${lastConsultation.instructions ? `<div class="mt-1"><span class="font-medium">醫囑：</span>${lastConsultation.instructions}</div>` : ''}
                            </div>
                        </div>
                    ` : `
                        <div class="text-center py-8 text-gray-500">
                            <div class="text-4xl mb-2">📋</div>
                            <div>尚無診症記錄</div>
                        </div>
                    `}
                </div>
            `;

            document.getElementById('patientDetailContent').innerHTML = content;
            document.getElementById('patientDetailModal').classList.remove('hidden');
        }

        function closePatientDetail() {
            document.getElementById('patientDetailModal').classList.add('hidden');
        }





        // 搜尋功能
        document.addEventListener('DOMContentLoaded', function() {
            // 套票欄位切換
            const categorySelect = document.getElementById('billingItemCategory');
            if (categorySelect) {
                categorySelect.addEventListener('change', function () {
                    const isPackage = this.value === 'package';
                    const pf = document.getElementById('packageFields');
                    if (pf) pf.classList.toggle('hidden', !isPackage);
                });
            }
            const searchInput = document.getElementById('searchPatient');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    loadPatientList();
                });
            }
        });

        // 診症系統功能
        let selectedPatientForRegistration = null;
        let currentConsultingAppointmentId = null;
        
        function loadConsultationSystem() {
            loadTodayAppointments();
            clearPatientSearch();
        }
        
        // 搜索病人進行掛號
        function searchPatientsForRegistration() {
            const searchTerm = document.getElementById('patientSearchInput').value.trim().toLowerCase();
            const resultsContainer = document.getElementById('patientSearchResults');
            const resultsList = document.getElementById('searchResultsList');
            
            if (searchTerm.length < 1) {
                resultsContainer.classList.add('hidden');
                return;
            }
            
            // 搜索匹配的病人
            const matchedPatients = patients.filter(patient => 
                patient.name.toLowerCase().includes(searchTerm) ||
                patient.phone.includes(searchTerm) ||
                (patient.patientNumber && patient.patientNumber.toLowerCase().includes(searchTerm))
            );
            
            if (matchedPatients.length === 0) {
                resultsList.innerHTML = `
                    <div class="p-4 text-center text-gray-500">
                        找不到符合條件的病人
                    </div>
                `;
                resultsContainer.classList.remove('hidden');
                return;
            }
            
            // 顯示搜索結果
            resultsList.innerHTML = matchedPatients.map(patient => `
                <div class="p-4 hover:bg-gray-50 cursor-pointer transition duration-200" onclick="selectPatientForRegistration(${patient.id})">
                    <div>
                        <div class="font-semibold text-gray-900">${patient.name}</div>
                        <div class="text-sm text-gray-600">編號：${patient.patientNumber} | 年齡：${formatAge(patient.birthDate)} | 性別：${patient.gender}</div>
                        <div class="text-sm text-gray-500">電話：${patient.phone}</div>
                    </div>
                </div>
            `).join('');
            
            resultsContainer.classList.remove('hidden');
        }
        
        // 選擇病人進行掛號
        function selectPatientForRegistration(patientId) {
            // 檢查是否有病人正在診症中
            const consultingAppointment = appointments.find(apt => 
                apt.status === 'consulting' && 
                new Date(apt.appointmentTime).toDateString() === new Date().toDateString()
            );
            
            if (consultingAppointment) {
                const consultingPatient = patients.find(p => p.id === consultingAppointment.patientId);
                const consultingPatientName = consultingPatient ? consultingPatient.name : '某位病人';
                showToast(`無法進行掛號！${consultingPatientName}正在診症中，請等待診症完成後再進行掛號操作。`, 'warning');
                return;
            }
            
            const patient = patients.find(p => p.id === patientId);
            if (!patient) return;
            
            selectedPatientForRegistration = patient;
            showRegistrationModal(patient);
        }
        
        // 清除病人搜索
        function clearPatientSearch() {
            document.getElementById('patientSearchInput').value = '';
            document.getElementById('patientSearchResults').classList.add('hidden');
            selectedPatientForRegistration = null;
        }
        

        
        // 顯示掛號彈窗
        function showRegistrationModal(patient) {
            if (!patient) return;
            
            // 顯示選中的病人資訊
            document.getElementById('selectedPatientInfo').innerHTML = `
                <div class="space-y-1">
                    <div><span class="font-medium">姓名：</span>${patient.name}</div>
                    <div><span class="font-medium">編號：</span>${patient.patientNumber}</div>
                    <div><span class="font-medium">年齡：</span>${formatAge(patient.birthDate)} | <span class="font-medium">性別：</span>${patient.gender}</div>
                    <div><span class="font-medium">電話：</span>${patient.phone}</div>
                </div>
            `;
            
            // 載入醫師選項
            loadDoctorOptions();
            
            // 設置預設掛號時間為當前時間（加5分鐘避免時間過期）
            const now = new Date();
            now.setMinutes(now.getMinutes() + 5); // 加5分鐘
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const localDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
            
            document.getElementById('appointmentDateTime').value = localDateTime;
            
            clearRegistrationForm();
            document.getElementById('registrationModal').classList.remove('hidden');
        }
        
        // 載入醫師選項
        function loadDoctorOptions() {
            const doctorSelect = document.getElementById('appointmentDoctor');
            
            // 獲取所有啟用的醫師用戶
            const doctors = users.filter(user => 
                user.active && user.position === '醫師'
            );
            
            // 清空現有選項（保留預設選項）
            doctorSelect.innerHTML = '<option value="">請選擇醫師</option>';
            
            // 添加醫師選項
            doctors.forEach(doctor => {
                const option = document.createElement('option');
                option.value = doctor.username;
                option.textContent = `${doctor.name}醫師`;
                if (doctor.registrationNumber) {
                    option.textContent += ` (${doctor.registrationNumber})`;
                }
                doctorSelect.appendChild(option);
            });
            
            // 如果當前用戶是醫師，預設選擇自己
            if (currentUserData && currentUserData.position === '醫師') {
                doctorSelect.value = currentUserData.username;
            }
        }
        
        // 關閉掛號彈窗
        function closeRegistrationModal() {
            document.getElementById('registrationModal').classList.add('hidden');
            clearRegistrationForm();
            selectedPatientForRegistration = null;
        }
        
        // 清空掛號表單
        function clearRegistrationForm() {
            document.getElementById('appointmentDoctor').value = '';
            document.getElementById('quickChiefComplaint').value = '';
        }
        
        // 確認掛號
        function confirmRegistration() {
            if (!selectedPatientForRegistration) {
                showToast('系統錯誤：未選擇病人！', 'error');
                return;
            }
            
            const appointmentDateTime = document.getElementById('appointmentDateTime').value;
            const appointmentDoctor = document.getElementById('appointmentDoctor').value;
            const chiefComplaint = document.getElementById('quickChiefComplaint').value.trim();
            
            if (!appointmentDateTime) {
                showToast('請選擇掛號時間！', 'error');
                return;
            }
            
            if (!appointmentDoctor) {
                showToast('請選擇掛號醫師！', 'error');
                return;
            }
            
            // 驗證選擇的醫師是否存在且啟用
            const selectedDoctor = users.find(user => 
                user.username === appointmentDoctor && 
                user.active && 
                user.position === '醫師'
            );
            
            if (!selectedDoctor) {
                showToast('選擇的醫師無效，請重新選擇！', 'error');
                return;
            }
            
            // 驗證掛號時間不能是過去時間（允許1分鐘的誤差）
            const selectedTime = new Date(appointmentDateTime);
            const now = new Date();
            now.setMinutes(now.getMinutes() - 1); // 允許1分鐘誤差
            if (selectedTime < now) {
                showToast('掛號時間不能早於現在時間！', 'error');
                return;
            }
            
            const appointment = {
                id: Date.now(),
                patientId: selectedPatientForRegistration.id,
                appointmentTime: selectedTime.toISOString(),
                appointmentDoctor: appointmentDoctor,
                chiefComplaint: chiefComplaint || '無特殊主訴',
                status: 'registered', // registered, waiting, consulting, completed
                createdAt: new Date().toISOString(),
                createdBy: currentUserData ? currentUserData.username : currentUser
            };
            
            appointments.push(appointment);
            localStorage.setItem('appointments', JSON.stringify(appointments));
            
            showToast(`${selectedPatientForRegistration.name} 已掛號給 ${selectedDoctor.name}醫師！`, 'success');
            
            closeRegistrationModal();
            clearPatientSearch();
            loadTodayAppointments();
        }
        
        // 每日自動清空掛號列表
        function clearOldAppointments() {
            const today = new Date().toDateString();
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayString = yesterday.toDateString();
            
            // 移除昨天及更早的掛號記錄
            const originalLength = appointments.length;
            appointments = appointments.filter(apt => {
                const appointmentDate = new Date(apt.appointmentTime).toDateString();
                return appointmentDate >= today; // 只保留今天及以後的掛號
            });
            
            // 如果有清除記錄，保存到本地儲存
            if (appointments.length < originalLength) {
                localStorage.setItem('appointments', JSON.stringify(appointments));
                console.log(`已清除 ${originalLength - appointments.length} 筆過期掛號記錄`);
            }
        }

        // 載入今日掛號列表
        function loadTodayAppointments() {
            // 先清空過期掛號
            clearOldAppointments();
            
            const today = new Date().toDateString();
            let todayAppointments = appointments.filter(apt => 
                new Date(apt.appointmentTime).toDateString() === today
            );
            
            // 如果當前用戶是醫師，只顯示掛給自己的病人
            if (currentUserData && currentUserData.position === '醫師') {
                todayAppointments = todayAppointments.filter(apt => 
                    apt.appointmentDoctor === currentUserData.username
                );
            }
            
            // 按時間排序
            todayAppointments.sort((a, b) => new Date(a.appointmentTime) - new Date(b.appointmentTime));
            
            const tbody = document.getElementById('todayAppointmentsList');
            document.getElementById('todayTotal').textContent = todayAppointments.length;
            
            if (todayAppointments.length === 0) {
                const message = currentUserData && currentUserData.position === '醫師' 
                    ? '今日暫無掛給您的病人' 
                    : '今日暫無掛號記錄';
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                            ${message}
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = todayAppointments.map((appointment, index) => {
                const patient = patients.find(p => p.id === appointment.patientId);
                if (!patient) return '';
                
                // 獲取掛號醫師資訊
                const appointmentDoctor = users.find(u => u.username === appointment.appointmentDoctor);
                const doctorName = appointmentDoctor ? `${appointmentDoctor.name}醫師` : '未指定醫師';
                
                const statusInfo = getStatusInfo(appointment.status);
                const operationButtons = getOperationButtons(appointment);
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm text-gray-900 font-medium">${index + 1}</td>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">
                            ${patient.name}
                            <div class="text-xs text-gray-500">${patient.patientNumber}</div>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900">
                            <div class="font-medium text-blue-600">${doctorName}</div>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900">
                            ${new Date(appointment.appointmentTime).toLocaleString('zh-TW', {
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900">
                            <div class="max-w-xs truncate" title="${appointment.chiefComplaint || '無'}">
                                ${appointment.chiefComplaint || '無'}
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusInfo.class}">
                                ${statusInfo.text}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm">
                            <div class="flex flex-wrap gap-1">
                                ${operationButtons}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // 獲取狀態資訊
        function getStatusInfo(status) {
            const statusMap = {
                'registered': { text: '已掛號', class: 'bg-blue-100 text-blue-800' },
                'waiting': { text: '候診中', class: 'bg-yellow-100 text-yellow-800' },
                'consulting': { text: '診症中', class: 'bg-green-100 text-green-800' },
                'completed': { text: '已完成', class: 'bg-gray-100 text-gray-800' }
            };
            return statusMap[status] || { text: '未知', class: 'bg-gray-100 text-gray-800' };
        }
        
        // 獲取操作按鈕
        function getOperationButtons(appointment) {
            const buttons = [];
            
            // 檢查是否有病人正在診症中
            const isAnyoneConsulting = appointments.some(apt => 
                apt.status === 'consulting' && 
                new Date(apt.appointmentTime).toDateString() === new Date().toDateString()
            );
            
            const isCurrentConsulting = appointment.status === 'consulting';
            
            // 檢查當前用戶是否為該掛號的醫師
            const isAppointmentDoctor = currentUserData && 
                currentUserData.position === '醫師' && 
                appointment.appointmentDoctor === currentUserData.username;
            
            // 檢查當前用戶是否為管理員或護理師（可以進行管理操作）
            const canManage = currentUserData && 
                (currentUserData.position === '診所管理' || currentUserData.position === '護理師');
            
            // 檢查當前用戶是否可以確認到達（管理員、護理師或該掛號的醫師）
            const canConfirmArrival = canManage || isAppointmentDoctor;
            
            // 所有狀態都可以查看診症記錄
            buttons.push(`<button onclick="viewPatientMedicalHistory(${appointment.patientId})" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs transition duration-200">診症記錄</button>`);
            
            // 如果有人在診症中且不是當前病人，則其他操作都被禁用
            const isDisabled = isAnyoneConsulting && !isCurrentConsulting;
            let disabledTooltip = '';
            if (isDisabled) {
                const consultingAppointment = appointments.find(apt => 
                    apt.status === 'consulting' && 
                    new Date(apt.appointmentTime).toDateString() === new Date().toDateString()
                );
                const consultingPatient = consultingAppointment ? patients.find(p => p.id === consultingAppointment.patientId) : null;
                const consultingPatientName = consultingPatient ? consultingPatient.name : '某位病人';
                disabledTooltip = `title="${consultingPatientName}正在診症中，操作暫時禁用"`;
            }
            
            switch (appointment.status) {
                case 'registered':
                    if (isDisabled) {
                        if (canConfirmArrival) {
                            buttons.push(`<span class="bg-gray-300 text-gray-500 px-2 py-1 rounded text-xs cursor-not-allowed" ${disabledTooltip}>確認到達</span>`);
                        }
                        if (canManage) {
                            buttons.push(`<span class="bg-gray-300 text-gray-500 px-2 py-1 rounded text-xs cursor-not-allowed" ${disabledTooltip}>移除掛號</span>`);
                        }
                    } else {
                        if (canConfirmArrival) {
                            buttons.push(`<button onclick="confirmPatientArrival(${appointment.id})" class="bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded text-xs transition duration-200">確認到達</button>`);
                        }
                        if (canManage) {
                            buttons.push(`<button onclick="removeAppointment(${appointment.id})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition duration-200">移除掛號</button>`);
                        }
                    }
                    break;
                    
                case 'waiting':
                    if (isDisabled) {
                        if (isAppointmentDoctor) {
                            buttons.push(`<span class="bg-gray-300 text-gray-500 px-2 py-1 rounded text-xs cursor-not-allowed" ${disabledTooltip}>開始診症</span>`);
                        }
                    } else {
                        if (isAppointmentDoctor) {
                            buttons.push(`<button onclick="startConsultation(${appointment.id})" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs transition duration-200">開始診症</button>`);
                        }
                    }
                    break;
                    
                case 'consulting':
                    if (isAppointmentDoctor) {
                        buttons.push(`<button onclick="continueConsultation(${appointment.id})" class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-xs transition duration-200">繼續診症</button>`);
                    }
                    break;
                    
                case 'completed':
                    // 列印收據功能不受診症狀態限制
                    buttons.push(`<button onclick="printReceiptFromAppointment(${appointment.id})" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs transition duration-200">列印收據</button>`);
                    buttons.push(`<button onclick="printAttendanceCertificateFromAppointment(${appointment.id})" class="bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-xs transition duration-200">到診證明</button>`);
                    buttons.push(`<button onclick="printSickLeaveFromAppointment(${appointment.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs transition duration-200">病假證明</button>`);
                    
                    if (isDisabled) {
                        if (isAppointmentDoctor) {
                            buttons.push(`<span class="bg-gray-300 text-gray-500 px-2 py-1 rounded text-xs cursor-not-allowed" ${disabledTooltip}>修改病歷</span>`);
                        }
                        if (canManage) {
                            buttons.push(`<span class="bg-gray-300 text-gray-500 px-2 py-1 rounded text-xs cursor-not-allowed" ${disabledTooltip}>撤回診症</span>`);
                        }
                    } else {
                        if (isAppointmentDoctor) {
                            buttons.push(`<button onclick="editMedicalRecord(${appointment.id})" class="bg-orange-500 hover:bg-orange-600 text-white px-2 py-1 rounded text-xs transition duration-200">修改病歷</button>`);
                        }
                        if (canManage) {
                            buttons.push(`<button onclick="withdrawConsultation(${appointment.id})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition duration-200">撤回診症</button>`);
                        }
                    }
                    break;
                    
                default:
                    buttons.push('<span class="text-gray-400 text-xs">狀態異常</span>');
                    break;
            }
            
            return buttons.join('');
        }
        

        
        // 確認病人到達（助理操作）
        function confirmPatientArrival(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) {
                showToast('找不到掛號記錄！', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            if (!patient) {
                showToast('找不到病人資料！', 'error');
                return;
            }
            
            // 詳細狀態檢查
            console.log(`確認到達狀態檢查 - 病人: ${patient.name}, 當前狀態: ${appointment.status}`);
            
            // 只有已掛號狀態才能確認到達
            if (appointment.status !== 'registered') {
                const statusNames = {
                    'waiting': '候診中',
                    'consulting': '診症中',
                    'completed': '已完成'
                };
                const currentStatusName = statusNames[appointment.status] || appointment.status;
                showToast(`無法確認到達！病人 ${patient.name} 目前狀態為「${currentStatusName}」，只能對「已掛號」的病人確認到達。`, 'warning');
                return;
            }
            
            // 更新狀態為候診中
            appointment.status = 'waiting';
            appointment.arrivedAt = new Date().toISOString();
            appointment.confirmedBy = currentUserData ? currentUserData.username : currentUser;
            
            // 保存狀態變更
            localStorage.setItem('appointments', JSON.stringify(appointments));
            
            showToast(`${patient.name} 已確認到達，進入候診狀態！`, 'success');
            loadTodayAppointments();
        }
        
        // 移除掛號功能
        function removeAppointment(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) {
                showToast('找不到掛號記錄！', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            if (!patient) {
                showToast('找不到病人資料！', 'error');
                return;
            }
            
            // 詳細狀態檢查
            console.log(`移除掛號狀態檢查 - 病人: ${patient.name}, 當前狀態: ${appointment.status}`);
            
            // 檢查是否可以移除
            if (appointment.status === 'waiting') {
                showToast(`無法移除掛號！病人 ${patient.name} 已確認到達候診中，請聯繫醫師處理。`, 'warning');
                return;
            }
            
            if (appointment.status === 'consulting') {
                showToast(`無法移除掛號！病人 ${patient.name} 目前正在診症中，請先結束診症後再移除。`, 'warning');
                return;
            }
            
            if (appointment.status === 'completed') {
                showToast(`無法移除掛號！病人 ${patient.name} 已完成診症，已完成的記錄無法移除。`, 'warning');
                return;
            }
            
            // 確認移除
            const statusNames = {
                'registered': '已掛號',
                'waiting': '候診中'
            };
            const statusText = statusNames[appointment.status] || appointment.status;
            
            const confirmMessage = `確定要移除 ${patient.name} 的掛號嗎？\n\n` +
                                 `狀態：${statusText}\n` +
                                 `掛號時間：${new Date(appointment.appointmentTime).toLocaleString('zh-TW')}\n\n` +
                                 `注意：此操作無法復原！`;
            
            if (confirm(confirmMessage)) {
                // 從掛號列表中移除
                appointments = appointments.filter(apt => apt.id !== appointmentId);
                localStorage.setItem('appointments', JSON.stringify(appointments));
                
                showToast(`已移除 ${patient.name} 的掛號記錄`, 'success');
                loadTodayAppointments();
                
                // 如果正在診症表單中顯示該病人，則關閉表單
                if (currentConsultingAppointmentId === appointmentId) {
                    closeConsultationForm();
                    currentConsultingAppointmentId = null;
                }
            }
        }
        

        

        
        // 開始診症（醫師操作）
        function startConsultation(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) {
                showToast('找不到掛號記錄！', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            if (!patient) {
                showToast('找不到病人資料！', 'error');
                return;
            }
            
            // 檢查當前用戶是否為該掛號的醫師
            if (!currentUserData || currentUserData.position !== '醫師' || appointment.appointmentDoctor !== currentUserData.username) {
                showToast('只有該掛號的醫師才能開始診症！', 'error');
                return;
            }
            
            // 詳細狀態檢查和診斷
            console.log(`開始診症狀態檢查 - 病人: ${patient.name}, 當前狀態: ${appointment.status}`);
            
            // 檢查病人狀態是否允許開始診症
            if (!['waiting', 'registered'].includes(appointment.status)) {
                const statusNames = {
                    'consulting': '診症中',
                    'completed': '已完成'
                };
                const currentStatusName = statusNames[appointment.status] || appointment.status;
                showToast(`無法開始診症！病人 ${patient.name} 目前狀態為「${currentStatusName}」，只能對「已掛號」或「候診中」的病人開始診症。`, 'error');
                return;
            }
            
            // 如果是已掛號狀態，自動確認到達
            if (appointment.status === 'registered') {
                appointment.arrivedAt = new Date().toISOString();
                appointment.confirmedBy = currentUserData ? currentUserData.username : currentUser;
                showToast(`${patient.name} 已自動確認到達`, 'info');
            }
            
            // 檢查是否已有其他病人在診症中（只檢查同一醫師的病人）
            const consultingAppointment = appointments.find(apt => 
                apt.status === 'consulting' && 
                apt.id !== appointmentId &&
                apt.appointmentDoctor === currentUserData.username &&
                new Date(apt.appointmentTime).toDateString() === new Date().toDateString()
            );
            
            if (consultingAppointment) {
                const consultingPatient = patients.find(p => p.id === consultingAppointment.patientId);
                const consultingPatientName = consultingPatient ? consultingPatient.name : '未知病人';
                
                if (confirm(`您目前正在為 ${consultingPatientName} 診症。\n\n是否要結束該病人的診症並開始為 ${patient.name} 診症？\n\n注意：${consultingPatientName} 的狀態將改回候診中。`)) {
                    // 結束當前診症的病人
                    consultingAppointment.status = 'waiting';
                    delete consultingAppointment.consultationStartTime;
                    delete consultingAppointment.consultingDoctor;
                    
                    // 關閉可能開啟的診症表單
                    if (currentConsultingAppointmentId === consultingAppointment.id) {
                        closeConsultationForm();
                    }
                    
                    showToast(`已結束 ${consultingPatientName} 的診症`, 'info');
                } else {
                    return; // 用戶取消操作
                }
            }
            
            // 開始新的診症 - 正確設置狀態為診症中
            appointment.status = 'consulting';
            appointment.consultationStartTime = new Date().toISOString();
            appointment.consultingDoctor = currentUserData ? currentUserData.username : currentUser;
            
            // 立即保存狀態變更
            localStorage.setItem('appointments', JSON.stringify(appointments));
            
            // 設置當前診症ID並顯示表單
            currentConsultingAppointmentId = appointmentId;
            showConsultationForm(appointment);
            
            // 重新載入列表以顯示正確狀態
            loadTodayAppointments();
            
            showToast(`開始為 ${patient.name} 診症`, 'success');
        }
        
        // 繼續診症
        function continueConsultation(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) return;
            
            currentConsultingAppointmentId = appointmentId;
            showConsultationForm(appointment);
        }
        
        // 顯示診症表單
        function showConsultationForm(appointment) {
            const patient = patients.find(p => p.id === appointment.patientId);
            if (!patient) return;
            
            // 設置病人資訊
            document.getElementById('formPatientName').textContent = `${patient.name} (${patient.patientNumber})`;
            document.getElementById('formAppointmentTime').textContent = new Date(appointment.appointmentTime).toLocaleString('zh-TW');
            renderPatientPackages(patient.id);
            
            // 檢查是否為編輯模式
            if (appointment.status === 'completed' && appointment.consultationId) {
                // 編輯模式：載入現有診症記錄
                const consultation = consultations.find(c => c.id === appointment.consultationId);
                if (consultation) {
                    document.getElementById('formSymptoms').value = consultation.symptoms || '';
                    document.getElementById('formTongue').value = consultation.tongue || '';
                    document.getElementById('formPulse').value = consultation.pulse || '';
                    document.getElementById('formCurrentHistory').value = consultation.currentHistory || '';
                    document.getElementById('formDiagnosis').value = consultation.diagnosis || '';
                    document.getElementById('formSyndrome').value = consultation.syndrome || '';
                    document.getElementById('formAcupunctureNotes').value = consultation.acupunctureNotes || '';
                    document.getElementById('formUsage').value = consultation.usage || '';
                    document.getElementById('formTreatmentCourse').value = consultation.treatmentCourse || '';
                    document.getElementById('formInstructions').value = consultation.instructions || '';
                    document.getElementById('formFollowUpDate').value = consultation.followUpDate || '';
                    document.getElementById('formVisitTime').value = consultation.visitTime || '';
                    
                    // 載入休息期間設定
                    if (consultation.restStartDate && consultation.restEndDate) {
                        document.getElementById('formRestStartDate').value = consultation.restStartDate;
                        document.getElementById('formRestEndDate').value = consultation.restEndDate;
                        updateRestPeriod();
                    } else {
                        // 如果沒有設定，使用預設值
                        const startDate = new Date();
                        const endDate = new Date();
                        endDate.setDate(startDate.getDate() + 2);
                        
                        const startDateStr = `${startDate.getFullYear()}-${String(startDate.getMonth() + 1).padStart(2, '0')}-${String(startDate.getDate()).padStart(2, '0')}`;
                        const endDateStr = `${endDate.getFullYear()}-${String(endDate.getMonth() + 1).padStart(2, '0')}-${String(endDate.getDate()).padStart(2, '0')}`;
                        
                        document.getElementById('formRestStartDate').value = startDateStr;
                        document.getElementById('formRestEndDate').value = endDateStr;
                        updateRestPeriod();
                    }
                    
                    // 解析處方內容並重建處方項目
                    selectedPrescriptionItems = [];
                    if (consultation.prescription) {
                        // 直接將處方內容設置到隱藏文本域
                        document.getElementById('formPrescription').value = consultation.prescription;
                        // 顯示現有處方內容
                        document.getElementById('selectedPrescriptionItems').innerHTML = `
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                <div class="text-sm font-semibold text-gray-700 mb-2">現有處方內容：</div>
                                <div class="text-sm text-gray-900 whitespace-pre-line">${consultation.prescription}</div>
                                <div class="text-xs text-gray-600 mt-2">提示：可繼續使用搜索功能添加新的中藥材或方劑</div>
                            </div>
                        `;
                    } else {
                        updatePrescriptionDisplay();
                    }
                    
                    // 解析收費項目並重建收費項目
                    selectedBillingItems = [];
                    if (consultation.billingItems) {
                        // 這裡簡化處理，將收費項目設置到隱藏文本域
                        document.getElementById('formBillingItems').value = consultation.billingItems;
                        // 顯示提示信息
                        document.getElementById('selectedBillingItems').innerHTML = `
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                <div class="text-sm font-semibold text-gray-700 mb-2">現有收費項目：</div>
                                <div class="text-sm text-gray-900 whitespace-pre-line">${consultation.billingItems}</div>
                                <div class="text-xs text-gray-600 mt-2">提示：可繼續使用搜索功能添加新的收費項目</div>
                            </div>
                        `;
                        // 更新總費用顯示（從現有資料中提取）
                        const totalMatch = consultation.billingItems.match(/總費用：\$(\d+)/);
                        if (totalMatch) {
                            document.getElementById('totalBillingAmount').textContent = `$${totalMatch[1]}`;
                        }
                    } else {
                        updateBillingDisplay();
                    }
                    
                    document.getElementById('consultationSaveButtonText').textContent = '更新病歷';
                } else {
                    clearConsultationForm();
                }
            } else {
                // 新診症模式：使用空白表單
                clearConsultationForm();
                
                // 設置預設到診時間為當前診症開始時間
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const localDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
                document.getElementById('formVisitTime').value = localDateTime;
                
                // 設置預設休息期間（今天到後天，共3天）
                const startDate = new Date();
                const endDate = new Date();
                endDate.setDate(startDate.getDate() + 2);
                
                const startDateStr = `${startDate.getFullYear()}-${String(startDate.getMonth() + 1).padStart(2, '0')}-${String(startDate.getDate()).padStart(2, '0')}`;
                const endDateStr = `${endDate.getFullYear()}-${String(endDate.getMonth() + 1).padStart(2, '0')}-${String(endDate.getDate()).padStart(2, '0')}`;
                
                document.getElementById('formRestStartDate').value = startDateStr;
                document.getElementById('formRestEndDate').value = endDateStr;
                updateRestPeriod();
                
                // 如果掛號時有填寫主訴，則預填到主訴欄位
                if (appointment.chiefComplaint && appointment.chiefComplaint !== '無特殊主訴') {
                    document.getElementById('formSymptoms').value = appointment.chiefComplaint;
                }
                
                // 自動添加預設診金收費項目
                addDefaultConsultationFee(patient);
                
                document.getElementById('consultationSaveButtonText').textContent = '完成診症';
            }
            
            document.getElementById('consultationForm').classList.remove('hidden');
            
            // 滾動到表單位置
            document.getElementById('consultationForm').scrollIntoView({ behavior: 'smooth' });
        }
        

        
        // 清空診症表單
        function clearConsultationForm() {
            ['formSymptoms', 'formTongue', 'formPulse', 'formCurrentHistory', 'formDiagnosis', 'formSyndrome', 'formAcupunctureNotes', 'formPrescription', 'formFollowUpDate', 'formVisitTime', 'formRestStartDate', 'formRestEndDate'].forEach(id => {
                document.getElementById(id).value = '';
            });
            
            // 重置服藥日數和次數為預設值
            document.getElementById('medicationDays').value = '5';
            document.getElementById('medicationFrequency').value = '2';
            
            // 重置休息期間顯示
            document.getElementById('restPeriodDisplay').textContent = '請選擇開始和結束日期';
            document.getElementById('restPeriodDisplay').className = 'text-sm text-gray-500 font-medium';
            
            // 設置預設值
            document.getElementById('formUsage').value = '早晚一次，飯後服';
            document.getElementById('formInstructions').value = '注意休息，飲食清淡';
            document.getElementById('formTreatmentCourse').value = '一周';
            
            // 清空處方項目
            selectedPrescriptionItems = [];
            updatePrescriptionDisplay();
            clearPrescriptionSearch();
            
            // 清空收費項目（但會在 prefillWithPreviousRecord 中自動添加診金）
            selectedBillingItems = [];
            updateBillingDisplay();
            clearBillingSearch();
        }
        
        // 關閉診症表單
        function closeConsultationForm() {
            // 隱藏診症表單
            document.getElementById('consultationForm').classList.add('hidden');
            
            // 清理全域變數
            currentConsultingAppointmentId = null;
            
            // 清空處方和收費項目選擇
            selectedPrescriptionItems = [];
            selectedBillingItems = [];
            
            // 滾動回頂部
            document.getElementById('consultationSystem').scrollIntoView({ behavior: 'smooth' });
        }
        
        // 取消診症
        function cancelConsultation() {
            if (!currentConsultingAppointmentId) {
                closeConsultationForm();
                return;
            }
            
            const appointment = appointments.find(apt => apt.id === currentConsultingAppointmentId);
            if (!appointment) {
                closeConsultationForm();
                currentConsultingAppointmentId = null;
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            if (!patient) {
                closeConsultationForm();
                currentConsultingAppointmentId = null;
                return;
            }
            
            // 詳細狀態檢查
            console.log(`取消診症狀態檢查 - 病人: ${patient.name}, 當前狀態: ${appointment.status}`);
            
            if (appointment.status === 'consulting') {
                const confirmMessage = `確定要取消 ${patient.name} 的診症嗎？\n\n` +
                                     `病人狀態將回到候診中，已填寫的診症內容將會遺失。\n\n` +
                                     `注意：此操作無法復原！`;
                
                if (confirm(confirmMessage)) {
                    // 將狀態改回候診中
                    appointment.status = 'waiting';
                    delete appointment.consultationStartTime;
                    delete appointment.consultingDoctor;
                    
                    // 保存狀態變更
                    localStorage.setItem('appointments', JSON.stringify(appointments));
                    
                    showToast(`已取消 ${patient.name} 的診症，病人回到候診狀態`, 'info');
                    
                    // 關閉表單並清理
                    closeConsultationForm();
                    currentConsultingAppointmentId = null;
                    loadTodayAppointments();
                }
            } else if (appointment.status === 'completed') {
                // 如果是已完成的診症，只是關閉編輯模式
                showToast('已退出病歷編輯模式', 'info');
                closeConsultationForm();
                currentConsultingAppointmentId = null;
            } else {
                // 其他狀態直接關閉
                closeConsultationForm();
                currentConsultingAppointmentId = null;
            }
        }
        
        // 儲存診症記錄（醫師操作）
        function saveConsultation() {
            if (!currentConsultingAppointmentId) {
                showToast('系統錯誤：找不到診症記錄！', 'error');
                return;
            }
            
            const appointment = appointments.find(apt => apt.id === currentConsultingAppointmentId);
            if (!appointment) {
                showToast('找不到掛號記錄！', 'error');
                return;
            }
            
            const symptoms = document.getElementById('formSymptoms').value.trim();
            const diagnosis = document.getElementById('formDiagnosis').value.trim();
            const syndrome = document.getElementById('formSyndrome').value.trim();
            const prescription = document.getElementById('formPrescription').value.trim();
            
            if (!symptoms || !diagnosis) {
                showToast('請填寫必填欄位：主訴、中醫診斷！', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            // 處理購買套票：將購買的套票轉為病人套票
            (function handlePackagesBeforeSave(){
                const packagePurchases = selectedBillingItems.filter(it => it.category === 'package');
                packagePurchases.forEach(it => {
                    if (typeof it.packageUses === 'undefined' || typeof it.validityDays === 'undefined') {
                        console.warn('套票缺少 packageUses / validityDays');
                        return;
                    }
                    purchasePackage(patient.id, it);
                });
            })();
            
            // 檢查是否為修改病歷模式
            if (appointment.status === 'completed' && appointment.consultationId) {
                // 修改現有病歷
                const existingConsultation = consultations.find(c => c.id === appointment.consultationId);
                if (existingConsultation) {
                    existingConsultation.symptoms = symptoms;
                    existingConsultation.tongue = document.getElementById('formTongue').value.trim();
                    existingConsultation.pulse = document.getElementById('formPulse').value.trim();
                    existingConsultation.currentHistory = document.getElementById('formCurrentHistory').value.trim();
                    existingConsultation.diagnosis = diagnosis;
                    existingConsultation.syndrome = syndrome;
                    existingConsultation.acupunctureNotes = document.getElementById('formAcupunctureNotes').value.trim();
                    
                    // 處方內容直接使用表單中的內容（包含現有處方和新添加的項目）
                    existingConsultation.prescription = prescription;
                    
                    existingConsultation.usage = document.getElementById('formUsage').value.trim();
                    existingConsultation.treatmentCourse = document.getElementById('formTreatmentCourse').value.trim();
                    existingConsultation.instructions = document.getElementById('formInstructions').value.trim();
                    existingConsultation.followUpDate = document.getElementById('formFollowUpDate').value;
                    existingConsultation.visitTime = document.getElementById('formVisitTime').value;
                    existingConsultation.restStartDate = document.getElementById('formRestStartDate').value;
                    existingConsultation.restEndDate = document.getElementById('formRestEndDate').value;
                    existingConsultation.billingItems = document.getElementById('formBillingItems').value.trim();
                    existingConsultation.updatedAt = new Date().toISOString();
                    existingConsultation.updatedBy = currentUserData ? currentUserData.username : currentUser;
                    
                    localStorage.setItem('consultations', JSON.stringify(consultations));
                    showToast(`${patient.name} 的病歷已成功更新！`, 'success');
                }
            } else if (appointment.status === 'consulting') {
                // 新增診症記錄
                const consultation = {
                    id: Date.now(),
                    appointmentId: currentConsultingAppointmentId,
                    patientId: appointment.patientId,
                    symptoms: symptoms,
                    tongue: document.getElementById('formTongue').value.trim(),
                    pulse: document.getElementById('formPulse').value.trim(),
                    currentHistory: document.getElementById('formCurrentHistory').value.trim(),
                    diagnosis: diagnosis,
                    syndrome: syndrome,
                    acupunctureNotes: document.getElementById('formAcupunctureNotes').value.trim(),
                    prescription: prescription,
                    usage: document.getElementById('formUsage').value.trim(),
                    treatmentCourse: document.getElementById('formTreatmentCourse').value.trim(),
                    instructions: document.getElementById('formInstructions').value.trim(),
                    followUpDate: document.getElementById('formFollowUpDate').value,
                    visitTime: document.getElementById('formVisitTime').value,
                    restStartDate: document.getElementById('formRestStartDate').value,
                    restEndDate: document.getElementById('formRestEndDate').value,
                    billingItems: document.getElementById('formBillingItems').value.trim(),
                    date: new Date().toISOString(),
                    doctor: currentUserData ? currentUserData.username : currentUser,
                    status: 'completed'
                };
                
                consultations.push(consultation);
                localStorage.setItem('consultations', JSON.stringify(consultations));
                
                // 更新掛號狀態為已完成
                appointment.status = 'completed';
                appointment.completedAt = new Date().toISOString();
                appointment.consultationId = consultation.id;
                appointment.completedBy = currentUserData ? currentUserData.username : currentUser;
                localStorage.setItem('appointments', JSON.stringify(appointments));
                
                showToast(`${patient.name} 的診症記錄已完成並保存！`, 'success');
            } else {
                showToast('只能保存診症中狀態的記錄或修改已完成的病歷！', 'warning');
                return;
            }
            
            closeConsultationForm();
            loadTodayAppointments();
            updateStatistics();
            
            // 清空搜尋欄位
            clearAllSearchFields();
        }
        

        
        // 病人資料管理頁面的病歷查看功能
        let currentPatientConsultations = [];
        let currentPatientHistoryPage = 0;
        
        function showPatientMedicalHistory(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) {
                showToast('找不到病人資料！', 'error');
                return;
            }
            
            // 獲取該病人的所有診症記錄
            currentPatientConsultations = consultations
                .filter(c => c.patientId === patientId)
                .sort((a, b) => new Date(a.date) - new Date(b.date)); // 按日期升序排列（較舊至較新）
            
            // 預設顯示最新的病歷（最近一次診症）
            currentPatientHistoryPage = currentPatientConsultations.length - 1;
            
            // 設置標題
            document.getElementById('patientMedicalHistoryTitle').textContent = `${patient.name} 的病歷記錄`;
            
            // 顯示病人基本資訊
            document.getElementById('patientMedicalHistoryPatientInfo').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
                    <div>
                        <span class="font-medium text-gray-700">病人編號：</span>
                        <span class="text-blue-600 font-semibold">${patient.patientNumber}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">姓名：</span>
                        <span class="font-semibold">${patient.name}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">年齡：</span>
                        <span>${formatAge(patient.birthDate)}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">性別：</span>
                        <span>${patient.gender}</span>
                    </div>
                    ${patient.allergies ? `
                    <div class="md:col-span-4">
                        <span class="font-medium text-red-600">過敏史：</span>
                        <span class="text-red-700 bg-red-50 px-2 py-1 rounded">${patient.allergies}</span>
                    </div>
                    ` : ''}
                </div>
            `;
            
            // 顯示分頁病歷記錄
            displayPatientMedicalHistoryPage();
            
            document.getElementById('patientMedicalHistoryModal').classList.remove('hidden');
        }
        
        function displayPatientMedicalHistoryPage() {
            const contentDiv = document.getElementById('patientMedicalHistoryContent');
            
            if (currentPatientConsultations.length === 0) {
                contentDiv.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-4xl mb-4">📋</div>
                        <div class="text-lg font-medium mb-2">暫無診症記錄</div>
                        <div class="text-sm">該病人尚未有診症記錄</div>
                    </div>
                `;
                return;
            }
            
            const consultation = currentPatientConsultations[currentPatientHistoryPage];
            const totalPages = currentPatientConsultations.length;
            const currentPageNumber = currentPatientHistoryPage + 1;
            const consultationNumber = currentPatientHistoryPage + 1;
            
            contentDiv.innerHTML = `
                <!-- 分頁導航 -->
                <div class="mb-6 flex justify-between items-center bg-gray-50 rounded-lg p-4">
                    <div class="flex items-center space-x-4">
                        <h4 class="text-lg font-semibold text-gray-800">診症記錄</h4>
                        <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                            第 ${consultationNumber} 次診症
                        </span>
                        <span class="text-sm text-gray-600">
                            共 ${totalPages} 次診症記錄
                        </span>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <button onclick="changePatientHistoryPage(-1)" 
                                ${currentPatientHistoryPage === 0 ? 'disabled' : ''}
                                class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-sm">
                            ← 較舊
                        </button>
                        <span class="text-sm text-gray-600 px-2">
                            ${currentPageNumber} / ${totalPages}
                        </span>
                        <button onclick="changePatientHistoryPage(1)" 
                                ${currentPatientHistoryPage === totalPages - 1 ? 'disabled' : ''}
                                class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-sm">
                            較新 →
                        </button>
                    </div>
                </div>
                
                <!-- 當前病歷記錄 -->
                <div class="border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                    <div class="bg-gradient-to-r from-gray-50 to-blue-50 px-6 py-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center space-x-4">
                                <span class="font-semibold text-gray-900 text-lg">
                                    ${new Date(consultation.date).toLocaleDateString('zh-TW')} 
                                    ${new Date(consultation.date).toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'})}
                                </span>
                                <span class="text-sm text-gray-600 bg-white px-3 py-1 rounded">
                                    醫師：${getDoctorDisplayName(consultation.doctor)}
                                </span>
                                ${consultation.updatedAt ? `
                                    <span class="text-xs text-orange-600 bg-orange-50 px-2 py-1 rounded">
                                        已修改
                                    </span>
                                ` : ''}
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="printConsultationRecord(${consultation.id})" 
                                        class="text-green-600 hover:text-green-800 text-sm font-medium bg-green-50 px-3 py-2 rounded">
                                    📄 列印收據
                                </button>
                                <button onclick="printAttendanceCertificate(${consultation.id})" 
                                        class="text-blue-600 hover:text-blue-800 text-sm font-medium bg-blue-50 px-3 py-2 rounded">
                                    📋 到診證明
                                </button>
                                ${(() => {
                                    // 檢查是否正在診症且為相同病人
                                    if (currentConsultingAppointmentId) {
                                        const currentAppointment = appointments.find(apt => apt.id === currentConsultingAppointmentId);
                                        if (currentAppointment && currentAppointment.patientId === consultation.patientId) {
                                            return `
                                                <button onclick="loadMedicalRecordToCurrentConsultation(${consultation.id})" 
                                                        class="text-blue-600 hover:text-blue-800 text-sm font-medium bg-blue-50 px-3 py-2 rounded">
                                                    📋 載入病歷
                                                </button>
                                            `;
                                        }
                                    }
                                    return '';
                                })()}
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="space-y-4">
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">主訴</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.symptoms || '無記錄'}</div>
                                </div>
                                
                                ${consultation.tongue ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">舌象</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.tongue}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.pulse ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">脈象</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.pulse}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.currentHistory ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">現病史</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.currentHistory}</div>
                                </div>
                                ` : ''}
                                
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">中醫診斷</span>
                                    <div class="bg-green-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-green-400">${consultation.diagnosis || '無記錄'}</div>
                                </div>
                                
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">證型診斷</span>
                                    <div class="bg-blue-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-blue-400">${consultation.syndrome || '無記錄'}</div>
                                </div>
                                
                                ${consultation.acupunctureNotes ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">針灸備註</span>
                                    <div class="bg-orange-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-orange-400">${consultation.acupunctureNotes}</div>
                                </div>
                                ` : ''}
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">處方內容</span>
                                    <div class="bg-yellow-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-yellow-400 whitespace-pre-line">${consultation.prescription || '無記錄'}</div>
                                </div>
                                
                                ${consultation.usage ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">服用方法</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.usage}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.treatmentCourse ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">療程</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.treatmentCourse}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.instructions ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">醫囑及注意事項</span>
                                    <div class="bg-red-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-red-400">${consultation.instructions}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.followUpDate ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">複診時間</span>
                                    <div class="bg-purple-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-purple-400">${new Date(consultation.followUpDate).toLocaleString('zh-TW')}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.billingItems ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">收費項目</span>
                                    <div class="bg-green-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-green-400 whitespace-pre-line">${consultation.billingItems}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function changePatientHistoryPage(direction) {
            const newPage = currentPatientHistoryPage + direction;
            if (newPage >= 0 && newPage < currentPatientConsultations.length) {
                currentPatientHistoryPage = newPage;
                displayPatientMedicalHistoryPage();
            }
        }

        // 關閉病人病歷查看彈窗
        function closePatientMedicalHistoryModal() {
            document.getElementById('patientMedicalHistoryModal').classList.add('hidden');
        }



        // 診症系統中的病歷查看功能
        let currentConsultationConsultations = [];
        let currentConsultationHistoryPage = 0;
        
        function viewPatientMedicalHistory(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) {
                showToast('找不到病人資料！', 'error');
                return;
            }
            
            // 獲取該病人的所有診症記錄
            currentConsultationConsultations = consultations
                .filter(c => c.patientId === patientId)
                .sort((a, b) => new Date(a.date) - new Date(b.date)); // 按日期升序排列（較舊至較新）
            
            // 預設顯示最新的病歷（最近一次診症）
            currentConsultationHistoryPage = currentConsultationConsultations.length - 1;
            
            // 設置標題
            document.getElementById('medicalHistoryTitle').textContent = `${patient.name} 的診症記錄`;
            
            // 顯示病人基本資訊
            document.getElementById('medicalHistoryPatientInfo').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
                    <div>
                        <span class="font-medium text-gray-700">病人編號：</span>
                        <span class="text-blue-600 font-semibold">${patient.patientNumber}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">姓名：</span>
                        <span class="font-semibold">${patient.name}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">年齡：</span>
                        <span>${formatAge(patient.birthDate)}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">性別：</span>
                        <span>${patient.gender}</span>
                    </div>
                    ${patient.allergies ? `
                    <div class="md:col-span-4">
                        <span class="font-medium text-red-600">過敏史：</span>
                        <span class="text-red-700 bg-red-50 px-2 py-1 rounded">${patient.allergies}</span>
                    </div>
                    ` : ''}
                </div>
            `;
            
            // 顯示分頁病歷記錄
            displayConsultationMedicalHistoryPage();
            
            document.getElementById('medicalHistoryModal').classList.remove('hidden');
        }
        
        function displayConsultationMedicalHistoryPage() {
            const contentDiv = document.getElementById('medicalHistoryContent');
            
            if (currentConsultationConsultations.length === 0) {
                contentDiv.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-4xl mb-4">📋</div>
                        <div class="text-lg font-medium mb-2">暫無診症記錄</div>
                        <div class="text-sm">該病人尚未有診症記錄</div>
                    </div>
                `;
                return;
            }
            
            const consultation = currentConsultationConsultations[currentConsultationHistoryPage];
            const totalPages = currentConsultationConsultations.length;
            const currentPageNumber = currentConsultationHistoryPage + 1;
            const consultationNumber = currentConsultationHistoryPage + 1;
            
            contentDiv.innerHTML = `
                <!-- 分頁導航 -->
                <div class="mb-6 flex justify-between items-center bg-gray-50 rounded-lg p-4">
                    <div class="flex items-center space-x-4">
                        <h4 class="text-lg font-semibold text-gray-800">診症記錄</h4>
                        <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                            第 ${consultationNumber} 次診症
                        </span>
                        <span class="text-sm text-gray-600">
                            共 ${totalPages} 次診症記錄
                        </span>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <button onclick="changeConsultationHistoryPage(-1)" 
                                ${currentConsultationHistoryPage === 0 ? 'disabled' : ''}
                                class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-sm">
                            ← 較舊
                        </button>
                        <span class="text-sm text-gray-600 px-2">
                            ${currentPageNumber} / ${totalPages}
                        </span>
                        <button onclick="changeConsultationHistoryPage(1)" 
                                ${currentConsultationHistoryPage === totalPages - 1 ? 'disabled' : ''}
                                class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-sm">
                            較新 →
                        </button>
                    </div>
                </div>
                
                <!-- 當前病歷記錄 -->
                <div class="border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                    <div class="bg-gradient-to-r from-gray-50 to-blue-50 px-6 py-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center space-x-4">
                                <span class="font-semibold text-gray-900 text-lg">
                                    ${new Date(consultation.date).toLocaleDateString('zh-TW')} 
                                    ${new Date(consultation.date).toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'})}
                                </span>
                                <span class="text-sm text-gray-600 bg-white px-3 py-1 rounded">
                                    醫師：${getDoctorDisplayName(consultation.doctor)}
                                </span>
                                ${consultation.updatedAt ? `
                                    <span class="text-xs text-orange-600 bg-orange-50 px-2 py-1 rounded">
                                        已修改
                                    </span>
                                ` : ''}
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="printConsultationRecord(${consultation.id})" 
                                        class="text-green-600 hover:text-green-800 text-sm font-medium bg-green-50 px-3 py-2 rounded">
                                    📄 列印收據
                                </button>
                                <button onclick="printAttendanceCertificate(${consultation.id})" 
                                        class="text-blue-600 hover:text-blue-800 text-sm font-medium bg-blue-50 px-3 py-2 rounded">
                                    📋 到診證明
                                </button>
                                ${(() => {
                                    // 檢查是否正在診症且為相同病人
                                    if (currentConsultingAppointmentId) {
                                        const currentAppointment = appointments.find(apt => apt.id === currentConsultingAppointmentId);
                                        if (currentAppointment && currentAppointment.patientId === consultation.patientId) {
                                            return `
                                                <button onclick="loadMedicalRecordToCurrentConsultation(${consultation.id})" 
                                                        class="text-blue-600 hover:text-blue-800 text-sm font-medium bg-blue-50 px-3 py-2 rounded">
                                                    📋 載入病歷
                                                </button>
                                            `;
                                        }
                                    }
                                    return '';
                                })()}
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="space-y-4">
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">主訴</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.symptoms || '無記錄'}</div>
                                </div>
                                
                                ${consultation.tongue ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">舌象</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.tongue}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.pulse ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">脈象</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.pulse}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.currentHistory ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">現病史</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.currentHistory}</div>
                                </div>
                                ` : ''}
                                
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">中醫診斷</span>
                                    <div class="bg-green-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-green-400">${consultation.diagnosis || '無記錄'}</div>
                                </div>
                                
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">證型診斷</span>
                                    <div class="bg-blue-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-blue-400">${consultation.syndrome || '無記錄'}</div>
                                </div>
                                
                                ${consultation.acupunctureNotes ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">針灸備註</span>
                                    <div class="bg-orange-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-orange-400">${consultation.acupunctureNotes}</div>
                                </div>
                                ` : ''}
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">處方內容</span>
                                    <div class="bg-yellow-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-yellow-400 whitespace-pre-line">${consultation.prescription || '無記錄'}</div>
                                </div>
                                
                                ${consultation.usage ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">服用方法</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.usage}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.treatmentCourse ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">療程</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900">${consultation.treatmentCourse}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.instructions ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">醫囑及注意事項</span>
                                    <div class="bg-red-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-red-400">${consultation.instructions}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.followUpDate ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">複診時間</span>
                                    <div class="bg-purple-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-purple-400">${new Date(consultation.followUpDate).toLocaleString('zh-TW')}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.billingItems ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">收費項目</span>
                                    <div class="bg-green-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-green-400 whitespace-pre-line">${consultation.billingItems}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function changeConsultationHistoryPage(direction) {
            const newPage = currentConsultationHistoryPage + direction;
            if (newPage >= 0 && newPage < currentConsultationConsultations.length) {
                currentConsultationHistoryPage = newPage;
                displayConsultationMedicalHistoryPage();
            }
        }
        
        // 關閉診症記錄彈窗
        function closeMedicalHistoryModal() {
            document.getElementById('medicalHistoryModal').classList.add('hidden');
        }
        

        
        // 從掛號記錄列印收據
        function printReceiptFromAppointment(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) {
                showToast('找不到掛號記錄！', 'error');
                return;
            }
            
            if (appointment.status !== 'completed' || !appointment.consultationId) {
                showToast('只能列印已完成診症的收據！', 'error');
                return;
            }
            
            const consultation = consultations.find(c => c.id === appointment.consultationId);
            if (!consultation) {
                showToast('找不到對應的診症記錄！', 'error');
                return;
            }
            
            // 直接調用現有的列印功能
            printConsultationRecord(consultation.id);
        }
        
        // 從掛號記錄列印到診證明
        function printAttendanceCertificateFromAppointment(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) {
                showToast('找不到掛號記錄！', 'error');
                return;
            }
            
            if (appointment.status !== 'completed' || !appointment.consultationId) {
                showToast('只能列印已完成診症的到診證明！', 'error');
                return;
            }
            
            const consultation = consultations.find(c => c.id === appointment.consultationId);
            if (!consultation) {
                showToast('找不到對應的診症記錄！', 'error');
                return;
            }
            
            // 直接調用到診證明列印功能
            printAttendanceCertificate(consultation.id);
        }
        
        // 從掛號記錄列印病假證明
        function printSickLeaveFromAppointment(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) {
                showToast('找不到掛號記錄！', 'error');
                return;
            }
            
            if (appointment.status !== 'completed' || !appointment.consultationId) {
                showToast('只能列印已完成診症的病假證明！', 'error');
                return;
            }
            
            const consultation = consultations.find(c => c.id === appointment.consultationId);
            if (!consultation) {
                showToast('找不到對應的診症記錄！', 'error');
                return;
            }
            
            // 直接調用病假證明列印功能
            printSickLeave(consultation.id);
        }
        
        // 列印診症記錄
        function printConsultationRecord(consultationId) {
            const consultation = consultations.find(c => c.id === consultationId);
            if (!consultation) {
                showToast('找不到診症記錄！', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === consultation.patientId);
            if (!patient) {
                showToast('找不到病人資料！', 'error');
                return;
            }
            
            // 解析收費項目以計算總金額
            let totalAmount = 0;
            let billingItemsHtml = '';
            if (consultation.billingItems) {
                const lines = consultation.billingItems.split('\n');
                lines.forEach(line => {
                    if (line.includes('=') && line.includes('$')) {
                        const match = line.match(/\$(\d+)/);
                        if (match) {
                            totalAmount += parseInt(match[1]);
                        }
                        billingItemsHtml += `<tr><td style="padding: 5px; border-bottom: 1px dotted #ccc;">${line}</td></tr>`;
                    } else if (line.includes('總費用')) {
                        const match = line.match(/\$(\d+)/);
                        if (match) {
                            totalAmount = parseInt(match[1]);
                        }
                    }
                });
            }
            
            // 創建中醫診所收據格式
            const printContent = `
                <!DOCTYPE html>
                <html lang="zh-TW">
                <head>
                    <meta charset="UTF-8">
                    <title>收據 - ${patient.name}</title>
                    <style>
                        body { 
                            font-family: 'Microsoft JhengHei', '微軟正黑體', sans-serif; 
                            margin: 0; 
                            padding: 10px; 
                            line-height: 1.3;
                            font-size: 11px;
                        }
                        .receipt-container {
                            width: 148mm;
                            height: 210mm;
                            margin: 0 auto;
                            border: 2px solid #000;
                            padding: 8px;
                            background: white;
                            box-sizing: border-box;
                        }
                        .clinic-header {
                            text-align: center;
                            border-bottom: 2px double #000;
                            padding-bottom: 10px;
                            margin-bottom: 15px;
                        }
                        .clinic-name {
                            font-size: 14px;
                            font-weight: bold;
                            margin-bottom: 2px;
                            letter-spacing: 1px;
                        }
                        .clinic-subtitle {
                            font-size: 10px;
                            color: #666;
                            margin-bottom: 3px;
                        }
                        .receipt-title {
                            font-size: 14px;
                            font-weight: bold;
                            text-align: center;
                            margin: 6px 0;
                            letter-spacing: 2px;
                        }
                        .receipt-info {
                            margin-bottom: 10px;
                        }
                        .info-row {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 3px;
                            font-size: 11px;
                        }
                        .info-label {
                            font-weight: bold;
                        }
                        .items-section {
                            border-top: 1px solid #000;
                            border-bottom: 1px solid #000;
                            padding: 6px 0;
                            margin: 8px 0;
                        }
                        .items-title {
                            font-weight: bold;
                            text-align: center;
                            margin-bottom: 6px;
                            font-size: 12px;
                        }
                        .items-table {
                            width: 100%;
                            font-size: 10px;
                        }
                        .items-table td {
                            padding: 3px 5px;
                            border-bottom: 1px dotted #999;
                        }
                        .total-section {
                            text-align: right;
                            margin: 8px 0;
                            font-size: 12px;
                            font-weight: bold;
                        }
                        .total-amount {
                            font-size: 12px;
                            color: #000;
                            border: 2px solid #000;
                            padding: 4px;
                            display: inline-block;
                            min-width: 60px;
                            text-align: center;
                        }
                        .prescription-section {
                            margin: 8px 0;
                            border-top: 1px dashed #666;
                            padding-top: 6px;
                        }
                        .prescription-title {
                            font-weight: bold;
                            margin-bottom: 4px;
                            font-size: 11px;
                        }
                        .prescription-content {
                            background: #f9f9f9;
                            padding: 4px;
                            border: 1px solid #ddd;
                            font-size: 10px;
                            line-height: 1.2;
                        }
                        .footer-info {
                            margin-top: 10px;
                            border-top: 1px dashed #666;
                            padding-top: 6px;
                            font-size: 9px;
                            color: #666;
                        }
                        .footer-row {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 2px;
                        }
                        .thank-you {
                            text-align: center;
                            margin: 8px 0;
                            font-weight: bold;
                            font-size: 11px;
                        }
                        .diagnosis-section {
                            margin: 6px 0;
                            font-size: 10px;
                        }
                        .diagnosis-title {
                            font-weight: bold;
                            margin-bottom: 3px;
                        }
                        @media print {
                            @page {
                                size: A5;
                                margin: 10mm;
                            }
                            body { 
                                margin: 0; 
                                padding: 0; 
                                font-size: 11px;
                            }
                            .receipt-container { 
                                border: 2px solid #000;
                                width: 100%;
                                height: 100%;
                                padding: 8mm;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="receipt-container">
                        <!-- 診所標題 -->
                        <div class="clinic-header">
                            <div class="clinic-name">${clinicSettings.chineseName || '12334'}</div>
                            <div class="clinic-subtitle">${clinicSettings.englishName || '12334 Clinic'}</div>
                            <div class="clinic-subtitle">電話：${clinicSettings.phone || '(852) 2345-6789'}　地址：${clinicSettings.address || '香港中環皇后大道中123號'}</div>
                        </div>
                        
                        <!-- 收據標題 -->
                        <div class="receipt-title">收　據</div>
                        
                        <!-- 基本資訊 -->
                        <div class="receipt-info">
                            <div class="info-row">
                                <span class="info-label">收據編號：</span>
                                <span>R${consultation.id.toString().padStart(6, '0')}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">病人姓名：</span>
                                <span>${patient.name}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">病歷號碼：</span>
                                <span>${patient.patientNumber}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">診療日期：</span>
                                <span>${new Date(consultation.date).toLocaleDateString('zh-TW', {
                                    year: 'numeric',
                                    month: '2-digit',
                                    day: '2-digit'
                                })}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">診療時間：</span>
                                <span>${new Date(consultation.date).toLocaleTimeString('zh-TW', {
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">主治醫師：</span>
                                <span>${getDoctorDisplayName(consultation.doctor)}</span>
                            </div>
                            ${(() => {
                                const regNumber = getDoctorRegistrationNumber(consultation.doctor);
                                return regNumber ? `
                                    <div class="info-row">
                                        <span class="info-label">註冊編號：</span>
                                        <span>${regNumber}</span>
                                    </div>
                                ` : '';
                            })()}
                        </div>
                        
                        <!-- 診斷資訊 -->
                        ${consultation.diagnosis ? `
                        <div class="diagnosis-section">
                            <div class="diagnosis-title">診斷：</div>
                            <div>${consultation.diagnosis}</div>
                            ${consultation.syndrome ? `<div>證型：${consultation.syndrome}</div>` : ''}
                        </div>
                        ` : ''}
                        
                        <!-- 收費項目 -->
                        ${consultation.billingItems ? `
                        <div class="items-section">
                            <div class="items-title">收費明細</div>
                            <table class="items-table">
                                ${billingItemsHtml}
                            </table>
                        </div>
                        ` : ''}
                        
                        <!-- 總金額 -->
                        <div class="total-section">
                            <div style="margin-bottom: 8px; font-size: 10px;">應收金額：</div>
                            <div class="total-amount">HK$ ${totalAmount.toLocaleString()}</div>
                        </div>
                        
                        <!-- 處方資訊 -->
                        ${consultation.prescription ? `
                        <div class="prescription-section">
                            <div class="prescription-title">📋 處方內容</div>
                            <div class="prescription-content">${(() => {
                                // 將處方內容按行分割，然後橫向排列
                                const lines = consultation.prescription.split('\n').filter(line => line.trim());
                                const allItems = [];
                                let i = 0;
                                
                                while (i < lines.length) {
                                    const line = lines[i].trim();
                                    if (!line) {
                                        i++;
                                        continue;
                                    }
                                    
                                    // 檢查是否為藥材/方劑格式（名稱 劑量g）
                                    const itemMatch = line.match(/^(.+?)\s+(\d+(?:\.\d+)?)g$/);
                                    if (itemMatch) {
                                        const itemName = itemMatch[1].trim();
                                        const dosage = itemMatch[2];
                                        
                                        // 檢查是否為常見方劑名稱
                                        const isFormula = ['湯', '散', '丸', '膏', '飲', '丹', '煎', '方', '劑'].some(suffix => itemName.includes(suffix));
                                        
                                        if (isFormula) {
                                            // 檢查下一行是否為方劑組成
                                            let composition = '';
                                            if (i + 1 < lines.length) {
                                                const nextLine = lines[i + 1].trim();
                                                // 如果下一行不是標準藥材格式，視為方劑組成
                                                if (nextLine && !nextLine.match(/^.+?\s+\d+(?:\.\d+)?g$/)) {
                                                    composition = nextLine.replace(/\n/g, '、').replace(/、/g, ',');
                                                    i++; // 跳過組成行
                                                }
                                            }
                                            
                                            // 方劑顯示格式：方劑名 劑量g (組成)
                                            if (composition) {
                                                allItems.push(`${itemName} ${dosage}g <span style="font-size: 8px;">(${composition})</span>`);
                                            } else {
                                                allItems.push(`${itemName} ${dosage}g`);
                                            }
                                        } else {
                                            // 普通藥材
                                            allItems.push(`${itemName} ${dosage}g`);
                                        }
                                    } else {
                                        // 非標準格式的行，可能是獨立的說明
                                        allItems.push(`<div style="margin: 2px 0; font-size: 9px; color: #666;">${line}</div>`);
                                    }
                                    
                                    i++;
                                }
                                
                                // 分離普通項目和特殊行
                                const regularItems = allItems.filter(item => typeof item === 'string' && !item.includes('<div'));
                                const specialLines = allItems.filter(item => typeof item === 'string' && item.includes('<div'));
                                
                                let result = '';
                                
                                // 先顯示特殊行
                                specialLines.forEach(line => {
                                    result += line;
                                });
                                
                                // 然後顯示所有項目（包括方劑和藥材），每行4個橫向排列
                                if (regularItems.length > 0) {
                                    for (let j = 0; j < regularItems.length; j += 4) {
                                        const lineItems = regularItems.slice(j, j + 4);
                                        result += `<div style="margin: 2px 0;">${lineItems.join('　')}</div>`;
                                    }
                                }
                                
                                return result || consultation.prescription.replace(/\n/g, '<br>');
                            })()}</div>
                            ${consultation.usage ? `
                            <div style="margin-top: 8px; font-size: 12px;">
                                <strong>服用方法：</strong>${consultation.usage}
                            </div>
                            ` : ''}
                        </div>
                        ` : ''}
                        
                        <!-- 醫囑 -->
                        ${consultation.instructions ? `
                        <div style="margin: 10px 0; font-size: 12px; background: #fff3cd; padding: 8px; border: 1px solid #ffeaa7;">
                            <strong>⚠️ 醫囑及注意事項：</strong><br>
                            ${consultation.instructions}
                        </div>
                        ` : ''}
                        
                        <!-- 複診提醒 -->
                        ${consultation.followUpDate ? `
                        <div style="margin: 10px 0; font-size: 12px; background: #e3f2fd; padding: 8px; border: 1px solid #90caf9;">
                            <strong>📅 建議複診時間：</strong><br>
                            ${new Date(consultation.followUpDate).toLocaleString('zh-TW')}
                        </div>
                        ` : ''}
                        
                        <!-- 感謝語 -->
                        <div class="thank-you">
                            謝謝您的光臨，祝您身體健康！
                        </div>
                        
                        <!-- 頁尾資訊 -->
                        <div class="footer-info">
                            <div class="footer-row">
                                <span>收據開立時間：</span>
                                <span>${new Date().toLocaleString('zh-TW')}</span>
                            </div>
                            <div class="footer-row">
                                <span>診所營業時間：</span>
                                <span>${clinicSettings.businessHours || '週一至週五 09:00-18:00'}</span>
                            </div>
                            <div class="footer-row">
                                <span>本收據請妥善保存</span>
                                <span>如有疑問請洽櫃檯</span>
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            // 開啟新視窗進行列印
            const printWindow = window.open('', '_blank', 'width=500,height=700');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            
            showToast('中醫診所收據已準備列印！', 'success');
        }
        
        // 列印到診證明
        function printAttendanceCertificate(consultationId) {
            const consultation = consultations.find(c => c.id === consultationId);
            if (!consultation) {
                showToast('找不到診症記錄！', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === consultation.patientId);
            if (!patient) {
                showToast('找不到病人資料！', 'error');
                return;
            }
            
            // 創建到診證明格式
            const printContent = `
                <!DOCTYPE html>
                <html lang="zh-TW">
                <head>
                    <meta charset="UTF-8">
                    <title>到診證明書 - ${patient.name}</title>
                    <style>
                        body { 
                            font-family: 'Microsoft JhengHei', '微軟正黑體', sans-serif; 
                            margin: 0; 
                            padding: 8px; 
                            line-height: 1.3;
                            font-size: 10px;
                            background: white;
                        }
                        .certificate-container {
                            width: 148mm;
                            height: 210mm;
                            margin: 0 auto;
                            border: 3px solid #000;
                            padding: 8px;
                            background: white;
                            position: relative;
                            box-sizing: border-box;
                        }
                        .clinic-header {
                            text-align: center;
                            border-bottom: 2px solid #000;
                            padding-bottom: 10px;
                            margin-bottom: 15px;
                        }
                        .clinic-name {
                            font-size: 13px;
                            font-weight: bold;
                            margin-bottom: 3px;
                            letter-spacing: 1px;
                        }
                        .clinic-subtitle {
                            font-size: 10px;
                            color: #666;
                            margin-bottom: 4px;
                        }
                        .certificate-title {
                            font-size: 16px;
                            font-weight: bold;
                            text-align: center;
                            margin: 8px 0;
                            letter-spacing: 3px;
                            color: #000;
                        }
                        .certificate-number {
                            text-align: right;
                            font-size: 10px;
                            color: #666;
                            margin-bottom: 10px;
                        }
                        .content-section {
                            margin: 8px 0;
                            font-size: 10px;
                            line-height: 1.4;
                        }
                        .patient-info {
                            margin: 8px 0;
                        }
                        .info-row {
                            margin: 4px 0;
                            display: flex;
                            align-items: center;
                        }
                        .info-label {
                            font-weight: bold;
                            min-width: 80px;
                            display: inline-block;
                            font-size: 10px;
                        }
                        .info-value {
                            border-bottom: 1px solid #000;
                            min-width: 120px;
                            padding: 3px 6px;
                            margin-left: 6px;
                            font-size: 10px;
                        }
                        .attendance-section {
                            margin: 8px 0;
                            background: #e3f2fd;
                            padding: 6px;
                            border: 2px solid #2196f3;
                            border-radius: 4px;
                            text-align: center;
                        }
                        .attendance-title {
                            font-size: 11px;
                            font-weight: bold;
                            color: #1976d2;
                            margin-bottom: 4px;
                        }
                        .attendance-details {
                            font-size: 10px;
                            line-height: 1.3;
                        }
                        .doctor-signature {
                            margin-top: 10px;
                            display: flex;
                            justify-content: space-between;
                            align-items: flex-end;
                        }
                        .signature-section {
                            text-align: center;
                        }
                        .signature-line {
                            border-bottom: 2px solid #000;
                            width: 60px;
                            height: 25px;
                            margin: 6px auto;
                            position: relative;
                        }
                        .signature-label {
                            font-size: 9px;
                            color: #666;
                            margin-top: 3px;
                        }
                        .date-section {
                            text-align: right;
                            font-size: 10px;
                        }
                        .footer-note {
                            margin-top: 15px;
                            padding-top: 8px;
                            border-top: 1px dashed #666;
                            font-size: 8px;
                            color: #666;
                            text-align: center;
                        }
                        .watermark {
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%) rotate(-45deg);
                            font-size: 80px;
                            color: rgba(0, 0, 0, 0.05);
                            font-weight: bold;
                            z-index: 0;
                            pointer-events: none;
                        }
                        .content {
                            position: relative;
                            z-index: 1;
                        }
                        @media print {
                            @page {
                                size: A5;
                                margin: 10mm;
                            }
                            body { 
                                margin: 0; 
                                padding: 0; 
                                font-size: 11px;
                            }
                            .certificate-container { 
                                border: 3px solid #000;
                                width: 100%;
                                height: 100%;
                                padding: 8mm;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="certificate-container">
                        <!-- 浮水印 -->
                        <div class="watermark">到診證明</div>
                        
                        <div class="content">
                            <!-- 診所標題 -->
                            <div class="clinic-header">
                                <div class="clinic-name">${clinicSettings.chineseName || '1233455'}</div>
                                <div class="clinic-subtitle">${clinicSettings.englishName || '1233455 Clinic'}</div>
                                <div class="clinic-subtitle">電話：${clinicSettings.phone || '(852) 2345-6789'}　地址：${clinicSettings.address || '香港中環皇后大道中123號'}</div>
                            </div>
                            
                            <!-- 證明書編號 -->
                            <div class="certificate-number">
                                證明書編號：AC${consultation.id.toString().padStart(6, '0')}
                            </div>
                            
                            <!-- 證明書標題 -->
                            <div class="certificate-title">到診證明書</div>
                            
                            <!-- 病人資訊 -->
                            <div class="patient-info">
                                <div class="info-row">
                                    <span class="info-label">姓　　名：</span>
                                    <span class="info-value">${patient.name}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">性　　別：</span>
                                    <span class="info-value">${patient.gender}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">年　　齡：</span>
                                    <span class="info-value">${formatAge(patient.birthDate)}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">身分證號：</span>
                                    <span class="info-value">${patient.idCard || '未提供'}</span>
                                </div>
                            </div>
                            
                            <!-- 到診資訊 -->
                            <div class="attendance-section">
                                <div class="attendance-title">到診資訊</div>
                                <div class="attendance-details">
                                    <div><strong>到診日期：</strong>${(() => {
                                        const visitDate = consultation.visitTime ? new Date(consultation.visitTime) : new Date(consultation.date);
                                        return visitDate.toLocaleDateString('zh-TW', {
                                            year: 'numeric',
                                            month: '2-digit',
                                            day: '2-digit'
                                        });
                                    })()}</div>
                                    <div><strong>到診時間：</strong>${(() => {
                                        const visitDate = consultation.visitTime ? new Date(consultation.visitTime) : new Date(consultation.date);
                                        return visitDate.toLocaleTimeString('zh-TW', {
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        });
                                    })()}</div>
                                </div>
                            </div>
                            
                            <!-- 診療資訊 -->
                            ${consultation.diagnosis ? `
                            <div class="content-section">
                                <div style="margin-bottom: 15px;">
                                    <strong>診斷結果：</strong>${consultation.diagnosis}
                                </div>
                            </div>
                            ` : ''}
                            
                            <div class="content-section">
                                <strong>茲證明上述病人確實於上述日期時間到本診所接受中醫診療。</strong>
                            </div>
                            
                            <div class="content-section">
                                <strong>特此證明。</strong>
                            </div>
                            
                            <!-- 醫師簽名區 -->
                            <div class="doctor-signature">
                                <div class="signature-section">
                                    <div class="signature-line"></div>
                                    <div class="signature-label">主治醫師簽名</div>
                                    <div style="margin-top: 10px; font-weight: bold;">
                                        ${getDoctorDisplayName(consultation.doctor)}
                                    </div>
                                    ${(() => {
                                        const regNumber = getDoctorRegistrationNumber(consultation.doctor);
                                        return regNumber ? `
                                            <div style="margin-top: 5px; font-size: 12px; color: #666;">
                                                註冊編號：${regNumber}
                                            </div>
                                        ` : '';
                                    })()}
                                </div>
                                
                                <div class="date-section">
                                    <div style="margin-bottom: 20px;">
                                        <strong>開立日期：</strong><br>
                                        ${new Date().toLocaleDateString('zh-TW', {
                                            year: 'numeric',
                                            month: '2-digit',
                                            day: '2-digit'
                                        })}
                                    </div>
                                    <div style="border: 2px solid #000; padding: 15px; text-align: center; background: #f8f9fa;">
                                        <div style="font-weight: bold; margin-bottom: 5px;">診所印章</div>
                                        <div style="font-size: 12px; color: #666;">(此處應蓋診所印章)</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 頁尾說明 -->
                            <div class="footer-note">
                                <div>本證明書僅證明到診事實，如有疑問請洽本診所</div>
                                <div>診所電話：${clinicSettings.phone || '(852) 2345-6789'} | 營業時間：${clinicSettings.businessHours || '週一至週五 09:00-18:00'}</div>
                                <div style="margin-top: 10px; font-size: 10px;">
                                    證明書開立時間：${new Date().toLocaleString('zh-TW')}
                                </div>
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            // 開啟新視窗進行列印
            const printWindow = window.open('', '_blank', 'width=700,height=900');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            
            showToast('到診證明書已準備列印！', 'success');
        }
        
        // 列印病假證明
        function printSickLeave(consultationId) {
            const consultation = consultations.find(c => c.id === consultationId);
            if (!consultation) {
                showToast('找不到診症記錄！', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === consultation.patientId);
            if (!patient) {
                showToast('找不到病人資料！', 'error');
                return;
            }
            
            // 創建病假證明格式
            const printContent = `
                <!DOCTYPE html>
                <html lang="zh-TW">
                <head>
                    <meta charset="UTF-8">
                    <title>病假證明書 - ${patient.name}</title>
                    <style>
                        body { 
                            font-family: 'Microsoft JhengHei', '微軟正黑體', sans-serif; 
                            margin: 0; 
                            padding: 8px; 
                            line-height: 1.3;
                            font-size: 10px;
                            background: white;
                        }
                        .certificate-container {
                            width: 148mm;
                            height: 210mm;
                            margin: 0 auto;
                            border: 3px solid #000;
                            padding: 8px;
                            background: white;
                            position: relative;
                            box-sizing: border-box;
                        }
                        .clinic-header {
                            text-align: center;
                            border-bottom: 2px solid #000;
                            padding-bottom: 10px;
                            margin-bottom: 15px;
                        }
                        .clinic-name {
                            font-size: 13px;
                            font-weight: bold;
                            margin-bottom: 3px;
                            letter-spacing: 1px;
                        }
                        .clinic-subtitle {
                            font-size: 10px;
                            color: #666;
                            margin-bottom: 4px;
                        }
                        .certificate-title {
                            font-size: 16px;
                            font-weight: bold;
                            text-align: center;
                            margin: 8px 0;
                            letter-spacing: 3px;
                            color: #000;
                        }
                        .certificate-number {
                            text-align: right;
                            font-size: 10px;
                            color: #666;
                            margin-bottom: 10px;
                        }
                        .content-section {
                            margin: 8px 0;
                            font-size: 10px;
                            line-height: 1.4;
                        }
                        .patient-info {
                            margin: 8px 0;
                        }
                        .info-row {
                            margin: 4px 0;
                            display: flex;
                            align-items: center;
                        }
                        .info-label {
                            font-weight: bold;
                            min-width: 80px;
                            display: inline-block;
                            font-size: 10px;
                        }
                        .info-value {
                            border-bottom: 1px solid #000;
                            min-width: 120px;
                            padding: 3px 6px;
                            margin-left: 6px;
                            font-size: 10px;
                        }
                        .diagnosis-section {
                            margin: 8px 0;
                            background: #f9f9f9;
                            padding: 6px;
                            border: 1px solid #ddd;
                            border-radius: 3px;
                        }
                        .rest-period {
                            margin: 8px 0;
                            font-size: 11px;
                            font-weight: bold;
                            text-align: center;
                            background: #fff3cd;
                            padding: 6px;
                            border: 2px solid #ffc107;
                            border-radius: 4px;
                        }
                        .doctor-signature {
                            margin-top: 10px;
                            display: flex;
                            justify-content: space-between;
                            align-items: flex-end;
                        }
                        .signature-section {
                            text-align: center;
                        }
                        .signature-line {
                            border-bottom: 2px solid #000;
                            width: 60px;
                            height: 25px;
                            margin: 6px auto;
                            position: relative;
                        }
                        .signature-label {
                            font-size: 9px;
                            color: #666;
                            margin-top: 3px;
                        }
                        .date-section {
                            text-align: right;
                            font-size: 10px;
                        }
                        .footer-note {
                            margin-top: 15px;
                            padding-top: 8px;
                            border-top: 1px dashed #666;
                            font-size: 8px;
                            color: #666;
                            text-align: center;
                        }
                        .watermark {
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%) rotate(-45deg);
                            font-size: 80px;
                            color: rgba(0, 0, 0, 0.05);
                            font-weight: bold;
                            z-index: 0;
                            pointer-events: none;
                        }
                        .content {
                            position: relative;
                            z-index: 1;
                        }
                        @media print {
                            @page {
                                size: A5;
                                margin: 10mm;
                            }
                            body { 
                                margin: 0; 
                                padding: 0; 
                                font-size: 11px;
                            }
                            .certificate-container { 
                                border: 3px solid #000;
                                width: 100%;
                                height: 100%;
                                padding: 8mm;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="certificate-container">
                        <!-- 浮水印 -->
                        <div class="watermark">病假證明</div>
                        
                        <div class="content">
                            <!-- 診所標題 -->
                            <div class="clinic-header">
                                <div class="clinic-name">${clinicSettings.chineseName || '1233455'}</div>
                                <div class="clinic-subtitle">${clinicSettings.englishName || '1233455 Clinic'}</div>
                                <div class="clinic-subtitle">電話：${clinicSettings.phone || '(852) 2345-6789'}　地址：${clinicSettings.address || '香港中環皇后大道中123號'}</div>
                            </div>
                            
                            <!-- 證明書編號 -->
                            <div class="certificate-number">
                                證明書編號：SL${consultation.id.toString().padStart(6, '0')}
                            </div>
                            
                            <!-- 證明書標題 -->
                            <div class="certificate-title">病假證明書</div>
                            
                            <!-- 病人資訊 -->
                            <div class="patient-info">
                                <div class="info-row">
                                    <span class="info-label">姓　　名：</span>
                                    <span class="info-value">${patient.name}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">性　　別：</span>
                                    <span class="info-value">${patient.gender}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">年　　齡：</span>
                                    <span class="info-value">${formatAge(patient.birthDate)}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">身分證號：</span>
                                    <span class="info-value">${patient.idCard || '未提供'}</span>
                                </div>
                            </div>
                            
                            <!-- 診斷資訊 -->
                            <div class="diagnosis-section">
                                <div style="margin-bottom: 15px;">
                                    <strong>診療日期：</strong>${(() => {
                                        const visitDate = consultation.visitTime ? new Date(consultation.visitTime) : new Date(consultation.date);
                                        return visitDate.toLocaleDateString('zh-TW', {
                                            year: 'numeric',
                                            month: '2-digit',
                                            day: '2-digit'
                                        });
                                    })()}
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <strong>診斷結果：</strong>${consultation.diagnosis || '需要休息調養'}
                                </div>
                            </div>
                            
                            <!-- 建議休息期間 -->
                            <div class="rest-period">
                                建議休息期間：${(() => {
                                    // 優先使用診症記錄中的休息期間設定
                                    if (consultation.restStartDate && consultation.restEndDate) {
                                        const startDate = new Date(consultation.restStartDate);
                                        const endDate = new Date(consultation.restEndDate);
                                        const timeDiff = endDate.getTime() - startDate.getTime();
                                        const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1; // 包含開始和結束日期
                                        
                                        return `${startDate.toLocaleDateString('zh-TW')} 至 ${endDate.toLocaleDateString('zh-TW')} (共 ${daysDiff} 天)`;
                                    }
                                    
                                    // 如果沒有設定休息期間，使用舊的邏輯
                                    let restDays = consultation.restDays ? parseInt(consultation.restDays) : 3;
                                    
                                    // 如果沒有設定休息天數，則根據治療療程推算
                                    if (!consultation.restDays) {
                                        const treatmentCourse = consultation.treatmentCourse || '一周';
                                        
                                        if (treatmentCourse.includes('天')) {
                                            const match = treatmentCourse.match(/(\d+)天/);
                                            if (match) {
                                                restDays = Math.min(parseInt(match[1]), 7); // 最多7天
                                            }
                                        } else if (treatmentCourse.includes('週') || treatmentCourse.includes('周')) {
                                            const match = treatmentCourse.match(/(\d+)[週周]/);
                                            if (match) {
                                                restDays = Math.min(parseInt(match[1]) * 7, 7); // 最多7天
                                            }
                                        }
                                    }
                                    
                                    // 使用到診時間作為起始日期，如果沒有則使用診症日期
                                    const startDate = consultation.visitTime ? new Date(consultation.visitTime) : new Date(consultation.date);
                                    const endDate = new Date(startDate);
                                    endDate.setDate(startDate.getDate() + restDays - 1);
                                    
                                    return `${startDate.toLocaleDateString('zh-TW')} 至 ${endDate.toLocaleDateString('zh-TW')} (共 ${restDays} 天)`;
                                })()}
                            </div>
                            
                            <!-- 醫囑 -->
                            ${consultation.instructions ? `
                            <div class="content-section">
                                <strong>醫師建議：</strong><br>
                                ${consultation.instructions}
                            </div>
                            ` : ''}
                            
                            <div class="content-section">
                                <strong>特此證明。</strong>
                            </div>
                            
                            <!-- 醫師簽名區 -->
                            <div class="doctor-signature">
                                <div class="signature-section">
                                    <div class="signature-line"></div>
                                    <div class="signature-label">主治醫師簽名</div>
                                    <div style="margin-top: 10px; font-weight: bold;">
                                        ${getDoctorDisplayName(consultation.doctor)}
                                    </div>
                                    ${(() => {
                                        const regNumber = getDoctorRegistrationNumber(consultation.doctor);
                                        return regNumber ? `
                                            <div style="margin-top: 5px; font-size: 12px; color: #666;">
                                                註冊編號：${regNumber}
                                            </div>
                                        ` : '';
                                    })()}
                                </div>
                                
                                <div class="date-section">
                                    <div style="margin-bottom: 20px;">
                                        <strong>開立日期：</strong><br>
                                        ${new Date().toLocaleDateString('zh-TW', {
                                            year: 'numeric',
                                            month: '2-digit',
                                            day: '2-digit'
                                        })}
                                    </div>
                                    <div style="border: 2px solid #000; padding: 15px; text-align: center; background: #f8f9fa;">
                                        <div style="font-weight: bold; margin-bottom: 5px;">診所印章</div>
                                        <div style="font-size: 12px; color: #666;">(此處應蓋診所印章)</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 頁尾說明 -->
                            <div class="footer-note">
                                <div>本證明書僅供請假使用，如有疑問請洽本診所</div>
                                <div>診所電話：${clinicSettings.phone || '(852) 2345-6789'} | 營業時間：${clinicSettings.businessHours || '週一至週五 09:00-18:00'}</div>
                                <div style="margin-top: 10px; font-size: 10px;">
                                    證明書開立時間：${new Date().toLocaleString('zh-TW')}
                                </div>
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            // 開啟新視窗進行列印
            const printWindow = window.open('', '_blank', 'width=700,height=900');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            
            showToast('病假證明書已準備列印！', 'success');
        }

        // 撤回診症功能
        function withdrawConsultation(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) {
                showToast('找不到掛號記錄！', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            if (!patient) {
                showToast('找不到病人資料！', 'error');
                return;
            }
            
            // 詳細狀態檢查
            console.log(`撤回診症狀態檢查 - 病人: ${patient.name}, 當前狀態: ${appointment.status}, 診症記錄ID: ${appointment.consultationId}`);
            
            // 只有已完成的診症才能撤回
            if (appointment.status !== 'completed') {
                const statusNames = {
                    'registered': '已掛號',
                    'waiting': '候診中',
                    'consulting': '診症中'
                };
                const currentStatusName = statusNames[appointment.status] || appointment.status;
                showToast(`無法撤回診症！病人 ${patient.name} 目前狀態為「${currentStatusName}」，只能撤回已完成的診症。`, 'warning');
                return;
            }
            
            // 檢查是否有診症記錄
            if (!appointment.consultationId) {
                showToast(`無法撤回診症！病人 ${patient.name} 沒有對應的診症記錄。`, 'error');
                return;
            }
            
            const consultation = consultations.find(c => c.id === appointment.consultationId);
            if (!consultation) {
                showToast(`無法撤回診症！找不到病人 ${patient.name} 的診症記錄資料。`, 'error');
                return;
            }
            
            // 確認撤回操作
            const confirmMessage = `確定要撤回 ${patient.name} 的診症嗎？\n\n` +
                                 `此操作將會：\n` +
                                 `• 刪除該次診症記錄\n` +
                                 `• 病人狀態回到「已掛號」\n` +
                                 `• 所有診症資料將永久遺失\n\n` +
                                 `診症日期：${new Date(consultation.date).toLocaleString('zh-TW')}\n` +
                                 `診斷：${consultation.diagnosis || '無記錄'}\n\n` +
                                 `注意：此操作無法復原！`;
            
            if (confirm(confirmMessage)) {
                // 刪除診症記錄
                const consultationIndex = consultations.findIndex(c => c.id === appointment.consultationId);
                if (consultationIndex !== -1) {
                    consultations.splice(consultationIndex, 1);
                    localStorage.setItem('consultations', JSON.stringify(consultations));
                }
                
                // 將掛號狀態改回已掛號
                appointment.status = 'registered';
                delete appointment.completedAt;
                delete appointment.consultationId;
                delete appointment.completedBy;
                delete appointment.consultationStartTime;
                delete appointment.consultingDoctor;
                
                // 保存狀態變更
                localStorage.setItem('appointments', JSON.stringify(appointments));
                
                showToast(`已撤回 ${patient.name} 的診症，病人狀態回到已掛號`, 'success');
                
                // 如果正在編輯該病歷，則關閉表單
                if (currentConsultingAppointmentId === appointmentId) {
                    closeConsultationForm();
                    currentConsultingAppointmentId = null;
                }
                
                // 重新載入列表和統計
                loadTodayAppointments();
                updateStatistics();
            }
        }

        // 修改病歷功能
        function editMedicalRecord(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) {
                showToast('找不到掛號記錄！', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            if (!patient) {
                showToast('找不到病人資料！', 'error');
                return;
            }
            
            // 詳細狀態檢查
            console.log(`修改病歷狀態檢查 - 病人: ${patient.name}, 當前狀態: ${appointment.status}, 診症記錄ID: ${appointment.consultationId}`);
            
            // 只有已完成的診症才能修改病歷
            if (appointment.status !== 'completed') {
                const statusNames = {
                    'registered': '已掛號',
                    'waiting': '候診中',
                    'consulting': '診症中'
                };
                const currentStatusName = statusNames[appointment.status] || appointment.status;
                showToast(`無法修改病歷！病人 ${patient.name} 目前狀態為「${currentStatusName}」，只能修改已完成診症的病歷。`, 'warning');
                return;
            }
            
            // 檢查是否有診症記錄
            if (!appointment.consultationId) {
                showToast(`無法修改病歷！病人 ${patient.name} 沒有對應的診症記錄。`, 'error');
                return;
            }
            
            const consultation = consultations.find(c => c.id === appointment.consultationId);
            if (!consultation) {
                showToast(`無法修改病歷！找不到病人 ${patient.name} 的診症記錄資料。`, 'error');
                return;
            }
            
            // 檢查是否有其他病人正在診症中
            const consultingAppointment = appointments.find(apt => 
                apt.status === 'consulting' && 
                new Date(apt.appointmentTime).toDateString() === new Date().toDateString()
            );
            
            if (consultingAppointment) {
                const consultingPatient = patients.find(p => p.id === consultingAppointment.patientId);
                const consultingPatientName = consultingPatient ? consultingPatient.name : '未知病人';
                
                if (confirm(`目前 ${consultingPatientName} 正在診症中。\n\n是否要結束該病人的診症並開始修改 ${patient.name} 的病歷？\n\n注意：${consultingPatientName} 的狀態將改回候診中。`)) {
                    // 結束當前診症的病人
                    consultingAppointment.status = 'waiting';
                    delete consultingAppointment.consultationStartTime;
                    delete consultingAppointment.consultingDoctor;
                    
                    // 關閉可能開啟的診症表單
                    if (currentConsultingAppointmentId === consultingAppointment.id) {
                        closeConsultationForm();
                    }
                    
                    showToast(`已結束 ${consultingPatientName} 的診症`, 'info');
                    localStorage.setItem('appointments', JSON.stringify(appointments));
                } else {
                    return; // 用戶取消操作
                }
            }
            
            // 設置為編輯模式
            currentConsultingAppointmentId = appointmentId;
            showConsultationForm(appointment);
            
            showToast(`進入 ${patient.name} 的病歷編輯模式`, 'info');
        }

        // 系統管理功能
        function updateStatistics() {
            document.getElementById('totalPatients').textContent = patients.length;
            
            const today = new Date().toDateString();
            const todayConsultations = consultations.filter(c => 
                new Date(c.date).toDateString() === today
            ).length;
            document.getElementById('todayConsultations').textContent = todayConsultations;
            
            const thisMonth = new Date().getMonth();
            const monthlyConsultations = consultations.filter(c => 
                new Date(c.date).getMonth() === thisMonth
            ).length;
            document.getElementById('monthlyConsultations').textContent = monthlyConsultations;
        }

        function exportData() {
            const data = {
                patients: patients,
                consultations: consultations,
                appointments: appointments,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `診所資料_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('資料匯出完成！', 'success');
        }

        function backupData() {
            const backup = {
                patients: patients,
                consultations: consultations,
                appointments: appointments,
                backupDate: new Date().toISOString()
            };
            localStorage.setItem('clinicBackup', JSON.stringify(backup));
            showToast('資料備份完成！', 'success');
        }

        function clearData() {
            if (confirm('警告：此操作將清除所有資料，確定要繼續嗎？')) {
                if (confirm('最後確認：所有病人資料和診症記錄將被永久刪除！')) {
                    localStorage.removeItem('patients');
                    localStorage.removeItem('consultations');
                    localStorage.removeItem('appointments');
                    patients = [];
                    consultations = [];
                    appointments = [];
                    updateStatistics();
                    showToast('所有資料已清除！', 'success');
                }
            }
        }

        // 診所設定管理功能
        function showClinicSettingsModal() {
            // 載入現有設定
            document.getElementById('clinicChineseName').value = clinicSettings.chineseName || '';
            document.getElementById('clinicEnglishName').value = clinicSettings.englishName || '';
            document.getElementById('clinicBusinessHours').value = clinicSettings.businessHours || '';
            document.getElementById('clinicPhone').value = clinicSettings.phone || '';
            document.getElementById('clinicAddress').value = clinicSettings.address || '';
            
            document.getElementById('clinicSettingsModal').classList.remove('hidden');
        }
        
        function hideClinicSettingsModal() {
            document.getElementById('clinicSettingsModal').classList.add('hidden');
        }
        
        function saveClinicSettings() {
            const chineseName = document.getElementById('clinicChineseName').value.trim();
            const englishName = document.getElementById('clinicEnglishName').value.trim();
            const businessHours = document.getElementById('clinicBusinessHours').value.trim();
            const phone = document.getElementById('clinicPhone').value.trim();
            const address = document.getElementById('clinicAddress').value.trim();
            
            if (!chineseName) {
                showToast('請輸入診所中文名稱！', 'error');
                return;
            }
            
            // 更新診所設定
            clinicSettings.chineseName = chineseName;
            clinicSettings.englishName = englishName;
            clinicSettings.businessHours = businessHours;
            clinicSettings.phone = phone;
            clinicSettings.address = address;
            clinicSettings.updatedAt = new Date().toISOString();
            
            // 保存到本地儲存
            localStorage.setItem('clinicSettings', JSON.stringify(clinicSettings));
            
            // 更新系統管理頁面的顯示
            updateClinicSettingsDisplay();
            
            hideClinicSettingsModal();
            showToast('診所資料已成功更新！', 'success');
        }
        
        function updateClinicSettingsDisplay() {
            // 更新系統管理頁面的診所設定顯示
            const chineseNameSpan = document.getElementById('displayChineseName');
            const englishNameSpan = document.getElementById('displayEnglishName');
            
            if (chineseNameSpan) {
                chineseNameSpan.textContent = clinicSettings.chineseName || '1233455';
            }
            if (englishNameSpan) {
                englishNameSpan.textContent = clinicSettings.englishName || '1233455 Clinic';
            }
            
            // 更新登入頁面的診所名稱
            const loginTitle = document.getElementById('loginTitle');
            const loginEnglishTitle = document.getElementById('loginEnglishTitle');
            if (loginTitle) {
                loginTitle.textContent = clinicSettings.chineseName || '1233455';
            }
            if (loginEnglishTitle) {
                loginEnglishTitle.textContent = clinicSettings.englishName || '1233455 Clinic';
            }
            
            // 更新主頁面的診所名稱
            const systemTitle = document.getElementById('systemTitle');
            const systemEnglishTitle = document.getElementById('systemEnglishTitle');
            if (systemTitle) {
                systemTitle.textContent = clinicSettings.chineseName || '1233455';
            }
            if (systemEnglishTitle) {
                systemEnglishTitle.textContent = clinicSettings.englishName || '1233455 Clinic';
            }
            
            // 更新歡迎頁面的診所名稱
            const welcomeTitle = document.getElementById('welcomeTitle');
            const welcomeEnglishTitle = document.getElementById('welcomeEnglishTitle');
            if (welcomeTitle) {
                welcomeTitle.textContent = `歡迎使用${clinicSettings.chineseName || '1233455'}`;
            }
            if (welcomeEnglishTitle) {
                welcomeEnglishTitle.textContent = `Welcome to ${clinicSettings.englishName || '1233455 Clinic'}`;
            }
        }



        // 中藥庫管理功能
        let editingHerbId = null;
        let editingFormulaId = null;
        let currentHerbFilter = 'all';
        
        function loadHerbLibrary() {
            displayHerbLibrary();
            
            // 搜尋功能
            const searchInput = document.getElementById('searchHerb');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    displayHerbLibrary();
                });
            }
        }
        
        function filterHerbLibrary(type) {
            currentHerbFilter = type;
            
            // 更新按鈕樣式
            document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                btn.className = 'px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200';
            });
            document.getElementById(`filter-${type}`).className = 'px-4 py-2 rounded-lg text-sm font-medium bg-blue-100 text-blue-800 transition duration-200';
            
            displayHerbLibrary();
        }
        
        function displayHerbLibrary() {
            const searchTerm = document.getElementById('searchHerb').value.toLowerCase();
            const listContainer = document.getElementById('herbLibraryList');
            
            // 過濾資料
            let filteredItems = herbLibrary.filter(item => {
                const matchesSearch = item.name.toLowerCase().includes(searchTerm) ||
                                    (item.alias && item.alias.toLowerCase().includes(searchTerm)) ||
                                    (item.effects && item.effects.toLowerCase().includes(searchTerm));
                
                const matchesFilter = currentHerbFilter === 'all' || item.type === currentHerbFilter;
                
                return matchesSearch && matchesFilter;
            });
            
            if (filteredItems.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-4xl mb-4">🌿</div>
                        <div class="text-lg font-medium mb-2">沒有找到相關資料</div>
                        <div class="text-sm">請嘗試其他搜尋條件或新增中藥材/方劑</div>
                    </div>
                `;
                return;
            }
            
            // 按類型分組顯示
            const herbs = filteredItems.filter(item => item.type === 'herb');
            const formulas = filteredItems.filter(item => item.type === 'formula');
            
            let html = '';
            
            if (herbs.length > 0 && (currentHerbFilter === 'all' || currentHerbFilter === 'herb')) {
                html += `
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="mr-2">🌿</span>中藥材 (${herbs.length})
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${herbs.map(herb => createHerbCard(herb)).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (formulas.length > 0 && (currentHerbFilter === 'all' || currentHerbFilter === 'formula')) {
                html += `
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="mr-2">📋</span>方劑 (${formulas.length})
                        </h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            ${formulas.map(formula => createFormulaCard(formula)).join('')}
                        </div>
                    </div>
                `;
            }
            
            listContainer.innerHTML = html;
        }
        
        function createHerbCard(herb) {
            return `
                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition duration-200">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900">${herb.name}</h4>
                            ${herb.alias ? `<p class="text-sm text-gray-600">${herb.alias}</p>` : ''}
                        </div>
                        <div class="flex space-x-1">
                            <button onclick="editHerb(${herb.id})" class="text-blue-600 hover:text-blue-800 text-sm">編輯</button>
                            <button onclick="deleteHerbItem(${herb.id})" class="text-red-600 hover:text-red-800 text-sm">刪除</button>
                        </div>
                    </div>
                    
                    <div class="space-y-2 text-sm">
                        ${herb.nature ? `<div><span class="font-medium text-gray-700">性味：</span>${herb.nature}</div>` : ''}
                        ${herb.meridian ? `<div><span class="font-medium text-gray-700">歸經：</span>${herb.meridian}</div>` : ''}
                        ${herb.effects ? `<div><span class="font-medium text-gray-700">功效：</span>${herb.effects}</div>` : ''}
                        ${herb.dosage ? `<div><span class="font-medium text-gray-700">劑量：</span><span class="text-blue-600 font-medium">${herb.dosage}</span></div>` : ''}
                        ${herb.cautions ? `<div><span class="font-medium text-red-600">注意：</span><span class="text-red-700">${herb.cautions}</span></div>` : ''}
                    </div>
                </div>
            `;
        }
        
        function createFormulaCard(formula) {
            return `
                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition duration-200">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900">${formula.name}</h4>
                            ${formula.source ? `<p class="text-sm text-gray-600">出處：${formula.source}</p>` : ''}
                        </div>
                        <div class="flex space-x-1">
                            <button onclick="editFormula(${formula.id})" class="text-blue-600 hover:text-blue-800 text-sm">編輯</button>
                            <button onclick="deleteHerbItem(${formula.id})" class="text-red-600 hover:text-red-800 text-sm">刪除</button>
                        </div>
                    </div>
                    
                    <div class="space-y-3 text-sm">
                        ${formula.effects ? `<div><span class="font-medium text-gray-700">功效：</span>${formula.effects}</div>` : ''}
                        ${formula.indications ? `<div><span class="font-medium text-gray-700">主治：</span>${formula.indications}</div>` : ''}
                        ${formula.composition ? `
                            <div>
                                <span class="font-medium text-gray-700">組成：</span>
                                <div class="mt-1 p-2 bg-yellow-50 rounded text-xs whitespace-pre-line border-l-2 border-yellow-400">${formula.composition}</div>
                            </div>
                        ` : ''}
                        ${formula.usage ? `<div><span class="font-medium text-gray-700">用法：</span>${formula.usage}</div>` : ''}
                        ${formula.cautions ? `<div><span class="font-medium text-red-600">注意：</span><span class="text-red-700">${formula.cautions}</span></div>` : ''}
                    </div>
                </div>
            `;
        }
        
        // 中藥材表單功能
        function showAddHerbForm() {
            editingHerbId = null;
            document.getElementById('herbFormTitle').textContent = '新增中藥材';
            document.getElementById('herbSaveButtonText').textContent = '儲存';
            clearHerbForm();
            document.getElementById('addHerbModal').classList.remove('hidden');
        }
        
        function hideAddHerbForm() {
            document.getElementById('addHerbModal').classList.add('hidden');
            clearHerbForm();
            editingHerbId = null;
        }
        
        function clearHerbForm() {
            ['herbName', 'herbAlias', 'herbNature', 'herbMeridian', 'herbEffects', 'herbIndications', 'herbDosage', 'herbCautions'].forEach(id => {
                document.getElementById(id).value = '';
            });
        }
        
        function editHerb(id) {
            const herb = herbLibrary.find(item => item.id === id && item.type === 'herb');
            if (!herb) return;
            
            editingHerbId = id;
            document.getElementById('herbFormTitle').textContent = '編輯中藥材';
            document.getElementById('herbSaveButtonText').textContent = '更新';
            
            document.getElementById('herbName').value = herb.name || '';
            document.getElementById('herbAlias').value = herb.alias || '';
            document.getElementById('herbNature').value = herb.nature || '';
            document.getElementById('herbMeridian').value = herb.meridian || '';
            document.getElementById('herbEffects').value = herb.effects || '';
            document.getElementById('herbIndications').value = herb.indications || '';
            document.getElementById('herbDosage').value = herb.dosage || '';
            document.getElementById('herbCautions').value = herb.cautions || '';
            
            document.getElementById('addHerbModal').classList.remove('hidden');
        }
        
        function saveHerb() {
            const name = document.getElementById('herbName').value.trim();
            
            if (!name) {
                showToast('請輸入中藥材名稱！', 'error');
                return;
            }
            
            const herb = {
                id: editingHerbId || Date.now(),
                type: 'herb',
                name: name,
                alias: document.getElementById('herbAlias').value.trim(),
                nature: document.getElementById('herbNature').value.trim(),
                meridian: document.getElementById('herbMeridian').value.trim(),
                effects: document.getElementById('herbEffects').value.trim(),
                indications: document.getElementById('herbIndications').value.trim(),
                dosage: document.getElementById('herbDosage').value.trim(),
                cautions: document.getElementById('herbCautions').value.trim(),
                createdAt: editingHerbId ? herbLibrary.find(h => h.id === editingHerbId).createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (editingHerbId) {
                const index = herbLibrary.findIndex(item => item.id === editingHerbId);
                herbLibrary[index] = herb;
                showToast('中藥材資料已更新！', 'success');
            } else {
                herbLibrary.push(herb);
                showToast('中藥材已新增！', 'success');
            }
            
            localStorage.setItem('herbLibrary', JSON.stringify(herbLibrary));
            hideAddHerbForm();
            displayHerbLibrary();
        }
        
        // 方劑表單功能
        function showAddFormulaForm() {
            editingFormulaId = null;
            document.getElementById('formulaFormTitle').textContent = '新增方劑';
            document.getElementById('formulaSaveButtonText').textContent = '儲存';
            clearFormulaForm();
            document.getElementById('addFormulaModal').classList.remove('hidden');
        }
        
        function hideAddFormulaForm() {
            document.getElementById('addFormulaModal').classList.add('hidden');
            clearFormulaForm();
            editingFormulaId = null;
        }
        
        function clearFormulaForm() {
            ['formulaName', 'formulaSource', 'formulaEffects', 'formulaIndications', 'formulaComposition', 'formulaUsage', 'formulaCautions'].forEach(id => {
                document.getElementById(id).value = '';
            });
        }
        
        function editFormula(id) {
            const formula = herbLibrary.find(item => item.id === id && item.type === 'formula');
            if (!formula) return;
            
            editingFormulaId = id;
            document.getElementById('formulaFormTitle').textContent = '編輯方劑';
            document.getElementById('formulaSaveButtonText').textContent = '更新';
            
            document.getElementById('formulaName').value = formula.name || '';
            document.getElementById('formulaSource').value = formula.source || '';
            document.getElementById('formulaEffects').value = formula.effects || '';
            document.getElementById('formulaIndications').value = formula.indications || '';
            document.getElementById('formulaComposition').value = formula.composition || '';
            document.getElementById('formulaUsage').value = formula.usage || '';
            document.getElementById('formulaCautions').value = formula.cautions || '';
            
            document.getElementById('addFormulaModal').classList.remove('hidden');
        }
        
        function saveFormula() {
            const name = document.getElementById('formulaName').value.trim();
            const composition = document.getElementById('formulaComposition').value.trim();
            
            if (!name) {
                showToast('請輸入方劑名稱！', 'error');
                return;
            }
            
            if (!composition) {
                showToast('請輸入方劑組成！', 'error');
                return;
            }
            
            const formula = {
                id: editingFormulaId || Date.now(),
                type: 'formula',
                name: name,
                source: document.getElementById('formulaSource').value.trim(),
                effects: document.getElementById('formulaEffects').value.trim(),
                indications: document.getElementById('formulaIndications').value.trim(),
                composition: composition,
                usage: document.getElementById('formulaUsage').value.trim(),
                cautions: document.getElementById('formulaCautions').value.trim(),
                createdAt: editingFormulaId ? herbLibrary.find(f => f.id === editingFormulaId).createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (editingFormulaId) {
                const index = herbLibrary.findIndex(item => item.id === editingFormulaId);
                herbLibrary[index] = formula;
                showToast('方劑資料已更新！', 'success');
            } else {
                herbLibrary.push(formula);
                showToast('方劑已新增！', 'success');
            }
            
            localStorage.setItem('herbLibrary', JSON.stringify(herbLibrary));
            hideAddFormulaForm();
            displayHerbLibrary();
        }
        
        // 刪除中藥材或方劑
        function deleteHerbItem(id) {
            const item = herbLibrary.find(h => h.id === id);
            if (!item) return;
            
            const itemType = item.type === 'herb' ? '中藥材' : '方劑';
            
            if (confirm(`確定要刪除${itemType}「${item.name}」嗎？\n\n此操作無法復原！`)) {
                herbLibrary = herbLibrary.filter(h => h.id !== id);
                localStorage.setItem('herbLibrary', JSON.stringify(herbLibrary));
                showToast(`${itemType}「${item.name}」已刪除！`, 'success');
                displayHerbLibrary();
            }
        }

        // 收費項目管理功能
        let editingBillingItemId = null;
        let currentBillingFilter = 'all';
        
        function loadBillingManagement() {
            displayBillingItems();
            
            // 搜尋功能
            const searchInput = document.getElementById('searchBilling');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    displayBillingItems();
                });
            }
        }
        
        function filterBillingItems(category) {
            currentBillingFilter = category;
            
            // 更新按鈕樣式
            document.querySelectorAll('[id^="billing-filter-"]').forEach(btn => {
                btn.className = 'px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200';
            });
            document.getElementById(`billing-filter-${category}`).className = 'px-4 py-2 rounded-lg text-sm font-medium bg-blue-100 text-blue-800 transition duration-200';
            
            displayBillingItems();
        }
        
        function displayBillingItems() {
            const searchTerm = document.getElementById('searchBilling').value.toLowerCase();
            const listContainer = document.getElementById('billingItemsList');
            
            // 過濾資料
            let filteredItems = billingItems.filter(item => {
                const matchesSearch = item.name.toLowerCase().includes(searchTerm) ||
                                    (item.description && item.description.toLowerCase().includes(searchTerm));
                
                const matchesFilter = currentBillingFilter === 'all' || item.category === currentBillingFilter;
                
                return matchesSearch && matchesFilter;
            });
            
            if (filteredItems.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-4xl mb-4">💰</div>
                        <div class="text-lg font-medium mb-2">沒有找到相關收費項目</div>
                        <div class="text-sm">請嘗試其他搜尋條件或新增收費項目</div>
                    </div>
                `;
                return;
            }
            
            // 按類別分組顯示
            const categories = {
                consultation: { name: '診療費', icon: '🩺', items: [] },
                medicine: { name: '藥費', icon: '💊', items: [] },
                treatment: { name: '治療費', icon: '🔧', items: [] },
                other: { name: '其他', icon: '📋', items: [] },
                discount: { name: '折扣項目', icon: '💸', items: [] },
                package: { name: '套票項目', icon: '🎫', items: [] }
            };
            
            filteredItems.forEach(item => {
                if (categories[item.category]) {
                    categories[item.category].items.push(item);
                }
            });
            
            let html = '';
            
            Object.keys(categories).forEach(categoryKey => {
                const category = categories[categoryKey];
                if (category.items.length > 0 && (currentBillingFilter === 'all' || currentBillingFilter === categoryKey)) {
                    html += `
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="mr-2">${category.icon}</span>${category.name} (${category.items.length})
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${category.items.map(item => createBillingItemCard(item)).join('')}
                            </div>
                        </div>
                    `;
                }
            });
            
            listContainer.innerHTML = html;
        }
        
        function createBillingItemCard(item) {
            const statusClass = item.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
            const statusText = item.active ? '啟用' : '停用';
            
            // 折扣項目使用不同的顏色顯示
            const priceColor = item.category === 'discount' ? 'text-red-600' : 'text-green-600';
            let pricePrefix = '$';
            let displayPrice = Math.abs(item.price);
            
            // 處理折扣項目的顯示
            if (item.category === 'discount') {
                if (item.price > 0 && item.price < 1) {
                    // 百分比折扣 (0.9 = 9折)
                    pricePrefix = '';
                    displayPrice = (item.price * 10).toFixed(0);
                } else if (item.price < 0) {
                    // 固定金額折扣
                    pricePrefix = '-$';
                    displayPrice = Math.abs(item.price);
                }
            }
            
            return `
                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition duration-200 ${!item.active ? 'opacity-75' : ''}">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h4 class="text-lg font-semibold text-gray-900">${item.name}</h4>
                            <div class="flex items-center mt-1">
                                <span class="text-2xl font-bold text-green-600">$${Math.abs(item.price)}</span>
                                ${item.unit ? `<span class="text-sm text-gray-500 ml-1">/ ${item.unit}</span>` : ''}
                            </div>
                        </div>
                        <div class="flex flex-col items-end space-y-2">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                                ${statusText}
                            </span>
                            <div class="flex space-x-1">
                                <button onclick="editBillingItem(${item.id})" class="text-blue-600 hover:text-blue-800 text-sm">編輯</button>
                                <button onclick="deleteBillingItem(${item.id})" class="text-red-600 hover:text-red-800 text-sm">刪除</button>
                            </div>
                        </div>
                    </div>
                    
                    ${item.description ? `
                        <div class="text-sm text-gray-600 bg-gray-50 p-2 rounded">
                            ${item.description}
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        // 收費項目表單功能
        function showAddBillingItemForm() {
            editingBillingItemId = null;
            document.getElementById('billingItemFormTitle').textContent = '新增收費項目';
            document.getElementById('billingItemSaveButtonText').textContent = '儲存';
            clearBillingItemForm();
            document.getElementById('addBillingItemModal').classList.remove('hidden');
        }
        
        function hideAddBillingItemForm() {
            document.getElementById('addBillingItemModal').classList.add('hidden');
            clearBillingItemForm();
            editingBillingItemId = null;
        }
        
        function clearBillingItemForm() {
            document.getElementById('billingItemPackageUses').value = '';
            document.getElementById('billingItemValidityDays').value = '';
            var pf = document.getElementById('packageFields'); if (pf) pf.classList.add('hidden');
            document.getElementById('billingItemName').value = '';
            document.getElementById('billingItemCategory').value = '';
            document.getElementById('billingItemPrice').value = '';
            document.getElementById('billingItemUnit').value = '';
            document.getElementById('billingItemDescription').value = '';
            document.getElementById('billingItemActive').checked = true;
        }
        
        function editBillingItem(id) {
            const item = billingItems.find(b => b.id === id);
            if (!item) return;
            
            editingBillingItemId = id;
            document.getElementById('billingItemFormTitle').textContent = '編輯收費項目';
            document.getElementById('billingItemSaveButtonText').textContent = '更新';
            
            document.getElementById('billingItemName').value = item.name || '';
            document.getElementById('billingItemCategory').value = item.category || '';
            document.getElementById('billingItemPrice').value = item.price || '';
            document.getElementById('billingItemUnit').value = item.unit || '';
            document.getElementById('billingItemDescription').value = item.description || '';
            document.getElementById('billingItemActive').checked = item.active !== false;
            document.getElementById('billingItemPackageUses').value = item.packageUses || '';
            document.getElementById('billingItemValidityDays').value = item.validityDays || '';
            {
                const pf = document.getElementById('packageFields');
                if (pf) pf.classList.toggle('hidden', item.category !== 'package');
            }
            
            document.getElementById('addBillingItemModal').classList.remove('hidden');
        }
        
        function saveBillingItem() {
            const name = document.getElementById('billingItemName').value.trim();
            const category = document.getElementById('billingItemCategory').value;
            let price = parseFloat(document.getElementById('billingItemPrice').value);

            let packageUses = null;
            let validityDays = null;
            if (category === 'package') {
                packageUses = parseInt(document.getElementById('billingItemPackageUses').value);
                validityDays = parseInt(document.getElementById('billingItemValidityDays').value);
                if (!packageUses || packageUses <= 0) {
                    showToast('請輸入套票可用次數！', 'error');
                    return;
                }
                if (!validityDays || validityDays <= 0) {
                    showToast('請輸入有效天數！', 'error');
                    return;
                }
            }
            
            if (!name) {
                showToast('請輸入收費項目名稱！', 'error');
                return;
            }
            
            if (!category) {
                showToast('請選擇項目類別！', 'error');
                return;
            }
            
            if (isNaN(price)) {
                showToast('請輸入有效的收費金額！', 'error');
                return;
            }
            
            // 折扣項目允許負數或0-1之間的小數（百分比），其他項目不允許負數
            if (category !== 'discount' && price < 0) {
                showToast('除折扣項目外，收費金額不能為負數！', 'error');
                return;
            }
            
            // 折扣項目的特殊驗證
            if (category === 'discount') {
                if (price > 0 && price >= 1 && price <= 10) {
                    // 如果輸入1-10之間的數字，自動轉換為折扣比例
                    price = price / 10;
                    document.getElementById('billingItemPrice').value = price;
                    showToast(`已自動轉換為${(price * 100).toFixed(0)}折`, 'info');
                }
            }
            
            const item = {
                id: editingBillingItemId || Date.now(),
                name: name,
                category: category,
                price: price,
                unit: document.getElementById('billingItemUnit').value.trim(),
                description: document.getElementById('billingItemDescription').value.trim(),
                packageUses: packageUses,
                validityDays: validityDays,
                active: document.getElementById('billingItemActive').checked,
                createdAt: editingBillingItemId ? billingItems.find(b => b.id === editingBillingItemId).createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (editingBillingItemId) {
                const index = billingItems.findIndex(b => b.id === editingBillingItemId);
                billingItems[index] = item;
                showToast('收費項目已更新！', 'success');
            } else {
                billingItems.push(item);
                showToast('收費項目已新增！', 'success');
            }
            
            localStorage.setItem('billingItems', JSON.stringify(billingItems));
            hideAddBillingItemForm();
            displayBillingItems();
        }
        
        function deleteBillingItem(id) {
            const item = billingItems.find(b => b.id === id);
            if (!item) return;
            
            if (confirm(`確定要刪除收費項目「${item.name}」嗎？\n\n此操作無法復原！`)) {
                billingItems = billingItems.filter(b => b.id !== id);
                localStorage.setItem('billingItems', JSON.stringify(billingItems));
                showToast(`收費項目「${item.name}」已刪除！`, 'success');
                displayBillingItems();
            }
        }

        // 處方搜索功能
        function searchHerbsForPrescription() {
            const searchTerm = document.getElementById('prescriptionSearch').value.trim().toLowerCase();
            const resultsContainer = document.getElementById('prescriptionSearchResults');
            const resultsList = document.getElementById('prescriptionSearchList');
            
            if (searchTerm.length < 1) {
                resultsContainer.classList.add('hidden');
                return;
            }
            
            // 搜索匹配的中藥材和方劑
            const matchedItems = herbLibrary.filter(item => 
                item.name.toLowerCase().includes(searchTerm) ||
                (item.alias && item.alias.toLowerCase().includes(searchTerm)) ||
                (item.effects && item.effects.toLowerCase().includes(searchTerm))
            ).slice(0, 10); // 限制顯示前10個結果
            
            if (matchedItems.length === 0) {
                resultsList.innerHTML = `
                    <div class="p-3 text-center text-gray-500 text-sm">
                        找不到符合條件的中藥材或方劑
                    </div>
                `;
                resultsContainer.classList.remove('hidden');
                return;
            }
            
            // 顯示搜索結果
            resultsList.innerHTML = matchedItems.map(item => {
                const typeName = item.type === 'herb' ? '中藥材' : '方劑';
                const bgColor = 'bg-yellow-50 hover:bg-yellow-100 border-yellow-200';
                
                return `
                    <div class="p-3 ${bgColor} border rounded-lg cursor-pointer transition duration-200" onclick="addToPrescription('${item.type}', ${item.id})">
                        <div class="text-center">
                            <div class="font-semibold text-gray-900 text-sm mb-1">${item.name}</div>
                            <div class="text-xs bg-white text-gray-600 px-2 py-1 rounded mb-2">${typeName}</div>
                            ${item.type === 'herb' && item.dosage ? `<div class="text-xs text-yellow-600 font-medium">${item.dosage}</div>` : ''}
                            ${item.effects ? `<div class="text-xs text-gray-600 mt-1">${item.effects.substring(0, 30)}${item.effects.length > 30 ? '...' : ''}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            resultsContainer.classList.remove('hidden');
        }
        
        // 存儲已選擇的處方項目
        let selectedPrescriptionItems = [];
        
        // 存儲已選擇的收費項目
        let selectedBillingItems = [];
        
        // 添加到處方內容
        function addToPrescription(type, itemId) {
            const item = herbLibrary.find(h => h.id === itemId);
            if (!item) return;
            
            // 檢查是否已經添加過
            const existingIndex = selectedPrescriptionItems.findIndex(p => p.id === itemId);
            if (existingIndex !== -1) {
                showToast(`${item.name} 已經在處方中！`, 'warning');
                return;
            }
            
            // 添加到已選擇項目
            const prescriptionItem = {
                id: itemId,
                type: type,
                name: item.name,
                dosage: type === 'herb' ? (item.dosage || '6g') : null,
                customDosage: '6', // 中藥材和方劑都預設6克
                composition: type === 'formula' ? item.composition : null,
                effects: item.effects
            };
            
            selectedPrescriptionItems.push(prescriptionItem);
            
            // 更新顯示
            updatePrescriptionDisplay();
            
            // 如果是第一個處方項目，自動添加藥費
            if (selectedPrescriptionItems.length === 1) {
                const days = parseInt(document.getElementById('medicationDays').value) || 5;
                updateMedicineFeeByDays(days);
            }
            
            // 清除搜索
            clearPrescriptionSearch();
            
            showToast(`已添加${type === 'herb' ? '中藥材' : '方劑'}：${item.name}`, 'success');
        }
        

        
        // 更新處方顯示
        function updatePrescriptionDisplay() {
            const container = document.getElementById('selectedPrescriptionItems');
            const hiddenTextarea = document.getElementById('formPrescription');
            const medicationSettings = document.getElementById('medicationSettings');
            
            if (selectedPrescriptionItems.length === 0) {
                container.innerHTML = `
                    <div class="text-sm text-gray-500 text-center py-4">
                        請使用上方搜索功能添加中藥材或方劑
                    </div>
                `;
                hiddenTextarea.value = '';
                // 隱藏服藥天數設定
                medicationSettings.style.display = 'none';
                return;
            }
            
            // 顯示服藥天數設定
            medicationSettings.style.display = 'block';
            
            // 顯示已添加的項目
            const displayHtml = `
                <div class="space-y-3">
                    ${selectedPrescriptionItems.map((item, index) => {
                        const bgColor = 'bg-yellow-50 border-yellow-200';
                        
                        return `
                            <div class="${bgColor} border rounded-lg p-3">
                                <div class="flex items-center">
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900">${item.name}</div>
                                        ${item.type === 'formula' ? `<div class="text-xs text-gray-600">方劑</div>` : ''}
                                    </div>
                                    <div class="flex items-center space-x-2 mr-3">
                                        <input type="number" 
                                               value="${item.customDosage || '6'}" 
                                               min="0.5" 
                                               max="100" 
                                               step="0.5"
                                               class="w-16 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-yellow-500 focus:border-transparent text-center"
                                               onchange="updatePrescriptionDosage(${index}, this.value)"
                                               onclick="this.select()">
                                        <span class="text-sm text-gray-600 font-medium">g</span>
                                    </div>
                                    <button onclick="removePrescriptionItem(${index})" class="text-red-500 hover:text-red-700 font-bold text-lg px-2">×</button>
                                </div>
                                
                                ${item.type === 'formula' && item.composition ? `
                                    <div class="mt-3 pt-3 border-t border-yellow-200">
                                        <div class="text-xs font-semibold text-gray-700 mb-2">方劑組成：</div>
                                        <div class="text-xs text-gray-600 bg-white rounded px-3 py-2 border border-yellow-100">
                                            ${item.composition.replace(/\n/g, '、')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            container.innerHTML = displayHtml;
            
            // 更新隱藏的文本域
            let prescriptionText = '';
            
            selectedPrescriptionItems.forEach(item => {
                if (item.type === 'herb') {
                    const dosage = item.customDosage || '6';
                    prescriptionText += `${item.name} ${dosage}g\n`;
                } else if (item.type === 'formula') {
                    const dosage = item.customDosage || '6';
                    prescriptionText += `${item.name} ${dosage}g\n`;
                    if (item.composition) {
                        prescriptionText += `${item.composition.replace(/\n/g, '、')}\n`;
                    }
                    prescriptionText += '\n';
                }
            });
            
            hiddenTextarea.value = prescriptionText.trim();
        }
        
        // 更新服藥天數
        function updateMedicationDays(change) {
            const daysInput = document.getElementById('medicationDays');
            const currentDays = parseInt(daysInput.value) || 5;
            const newDays = Math.max(1, Math.min(30, currentDays + change));
            daysInput.value = newDays;
            
            // 更新處方顯示
            if (selectedPrescriptionItems.length > 0) {
                updatePrescriptionDisplay();
            }
            
            // 自動更新藥費
            updateMedicineFeeByDays(newDays);
        }
        
        // 更新服藥次數
        function updateMedicationFrequency(change) {
            const frequencyInput = document.getElementById('medicationFrequency');
            const currentFrequency = parseInt(frequencyInput.value) || 2;
            const newFrequency = Math.max(1, Math.min(6, currentFrequency + change));
            frequencyInput.value = newFrequency;
            
            // 更新處方顯示
            if (selectedPrescriptionItems.length > 0) {
                updatePrescriptionDisplay();
            }
        }
        
        // 根據開藥天數自動更新藥費
        function updateMedicineFeeByDays(days) {
            // 只有在有處方內容時才自動更新藥費
            if (selectedPrescriptionItems.length === 0) {
                return;
            }
            
            // 尋找中藥調劑費項目
            const medicineFeeItem = billingItems.find(item => 
                item.active && 
                item.category === 'medicine' && 
                (item.name.includes('中藥') || item.name.includes('藥費') || item.name.includes('調劑'))
            );
            
            if (!medicineFeeItem) {
                return; // 如果沒有找到藥費項目，不進行自動更新
            }
            
            // 查找現有的藥費項目
            const existingMedicineFeeIndex = selectedBillingItems.findIndex(item => 
                item.id === medicineFeeItem.id
            );
            
            if (existingMedicineFeeIndex !== -1) {
                // 更新現有藥費項目的數量為天數
                selectedBillingItems[existingMedicineFeeIndex].quantity = days;
                updateBillingDisplay();
                showToast(`已更新藥費：${medicineFeeItem.name} x${days}天`, 'info');
            } else {
                // 如果沒有藥費項目，自動添加
                const billingItem = {
                    id: medicineFeeItem.id,
                    name: medicineFeeItem.name,
                    category: medicineFeeItem.category,
                    price: medicineFeeItem.price,
                    unit: medicineFeeItem.unit,
                    description: medicineFeeItem.description,
                    quantity: days
                };
                
                selectedBillingItems.push(billingItem);
                updateBillingDisplay();
                showToast(`已自動添加藥費：${medicineFeeItem.name} x${days}天`, 'info');
            }
        }
        
        // 處理天數輸入框直接變更
        function updateMedicationDaysFromInput() {
            const daysInput = document.getElementById('medicationDays');
            const days = parseInt(daysInput.value) || 5;
            
            // 確保天數在有效範圍內
            const validDays = Math.max(1, Math.min(30, days));
            if (validDays !== days) {
                daysInput.value = validDays;
            }
            
            // 更新處方顯示
            if (selectedPrescriptionItems.length > 0) {
                updatePrescriptionDisplay();
            }
            
            // 自動更新藥費
            updateMedicineFeeByDays(validDays);
        }
        
        // 更新休息期間顯示
        function updateRestPeriod() {
            const startDateInput = document.getElementById('formRestStartDate');
            const endDateInput = document.getElementById('formRestEndDate');
            const displaySpan = document.getElementById('restPeriodDisplay');
            
            if (!startDateInput || !endDateInput || !displaySpan) return;
            
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            
            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                if (end >= start) {
                    const timeDiff = end.getTime() - start.getTime();
                    const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1; // 包含開始和結束日期
                    displaySpan.textContent = `共 ${daysDiff} 天`;
                    displaySpan.className = 'text-sm text-blue-600 font-medium';
                } else {
                    displaySpan.textContent = '結束日期不能早於開始日期';
                    displaySpan.className = 'text-sm text-red-600 font-medium';
                }
            } else {
                displaySpan.textContent = '請選擇開始和結束日期';
                displaySpan.className = 'text-sm text-gray-500 font-medium';
            }
        }
        

        
        // 更新處方藥量
        function updatePrescriptionDosage(index, newDosage) {
            if (index >= 0 && index < selectedPrescriptionItems.length) {
                const dosage = parseFloat(newDosage);
                if (dosage > 0 && dosage <= 100) {
                    selectedPrescriptionItems[index].customDosage = newDosage;
                    // 重新生成處方文本
                    updatePrescriptionDisplay();
                } else {
                    // 如果輸入無效，恢復原值
                    updatePrescriptionDisplay();
                    showToast('請輸入有效的藥量（0.5-100克）', 'warning');
                }
            }
        }
        

        
        // 移除處方項目
        function removePrescriptionItem(index) {
            if (index >= 0 && index < selectedPrescriptionItems.length) {
                const removedItem = selectedPrescriptionItems.splice(index, 1)[0];
                updatePrescriptionDisplay();
                
                // 如果移除後沒有處方項目了，移除藥費
                if (selectedPrescriptionItems.length === 0) {
                    // 尋找並移除藥費項目
                    const medicineFeeItem = billingItems.find(item => 
                        item.active && 
                        item.category === 'medicine' && 
                        (item.name.includes('中藥') || item.name.includes('藥費') || item.name.includes('調劑'))
                    );
                    
                    if (medicineFeeItem) {
                        const medicineFeeIndex = selectedBillingItems.findIndex(item => 
                            item.id === medicineFeeItem.id
                        );
                        
                        if (medicineFeeIndex !== -1) {
                            selectedBillingItems.splice(medicineFeeIndex, 1);
                            updateBillingDisplay();
                        }
                    }
                }
            }
        }
        
        // 清除處方搜索
        function clearPrescriptionSearch() {
            document.getElementById('prescriptionSearch').value = '';
            document.getElementById('prescriptionSearchResults').classList.add('hidden');
        }
        
        // 收費項目搜索功能
        function searchBillingForConsultation() {
            const searchTerm = document.getElementById('billingSearch').value.trim().toLowerCase();
            const resultsContainer = document.getElementById('billingSearchResults');
            const resultsList = document.getElementById('billingSearchList');
            
            if (searchTerm.length < 1) {
                resultsContainer.classList.add('hidden');
                return;
            }
            
            // 搜索匹配的收費項目（只顯示啟用的項目）
            const matchedItems = billingItems.filter(item => 
                item.active && (
                    item.name.toLowerCase().includes(searchTerm) ||
                    (item.description && item.description.toLowerCase().includes(searchTerm))
                )
            ).slice(0, 10); // 限制顯示前10個結果
            
            if (matchedItems.length === 0) {
                resultsList.innerHTML = `
                    <div class="p-3 text-center text-gray-500 text-sm">
                        找不到符合條件的收費項目
                    </div>
                `;
                resultsContainer.classList.remove('hidden');
                return;
            }
            
            // 顯示搜索結果
            resultsList.innerHTML = matchedItems.map(item => {
                const categoryNames = {
                    consultation: '診療費',
                    medicine: '藥費',
                    treatment: '治療費',
                    other: '其他',
                    discount: '折扣項目',
                    package: '套票項目'
                };
                const categoryName = categoryNames[item.category] || '未分類';
                const bgColor = getCategoryBgColor(item.category);
                
                return `
                    <div class="p-3 ${bgColor} border rounded-lg cursor-pointer transition duration-200" onclick="addToBilling(${item.id})">
                        <div class="text-center">
                            <div class="font-semibold text-gray-900 text-sm mb-1">${item.name}</div>
                            <div class="text-xs bg-white text-gray-600 px-2 py-1 rounded mb-2">${categoryName}</div>
                            ${item.category !== 'discount' ? `
                                <div class="text-sm font-bold text-green-600">
                                    $${item.price}
                                </div>
                            ` : ''}
                            ${item.unit ? `<div class="text-xs text-gray-600">/ ${item.unit}</div>` : ''}
                            ${item.description ? `<div class="text-xs text-gray-600 mt-1">${item.description.substring(0, 30)}${item.description.length > 30 ? '...' : ''}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            resultsContainer.classList.remove('hidden');
        }
        
        // 獲取類別背景顏色
        function getCategoryBgColor(category) {
            const colors = {
                consultation: 'bg-blue-50 hover:bg-blue-100 border-blue-200',
                medicine: 'bg-green-50 hover:bg-green-100 border-green-200',
                treatment: 'bg-orange-50 hover:bg-orange-100 border-orange-200',
                other: 'bg-gray-50 hover:bg-gray-100 border-gray-200',
                discount: 'bg-red-50 hover:bg-red-100 border-red-200',
                package: 'bg-purple-50 hover:bg-purple-100 border-purple-200'
            };
            return colors[category] || colors.other;
        }
        
        // 添加到收費項目
        function addToBilling(itemId) {
            const item = billingItems.find(b => b.id === itemId);
            if (!item) return;
            
            // 檢查是否已經添加過
            const existingIndex = selectedBillingItems.findIndex(b => b.id === itemId);
            if (existingIndex !== -1) {
                // 如果已存在，增加數量
                selectedBillingItems[existingIndex].quantity += 1;
            } else {
                // 添加新項目
                const billingItem = {
                    id: itemId,
                    name: item.name,
                    category: item.category,
                    price: item.price,
                    unit: item.unit,
                    description: item.description,
                    packageUses: item.packageUses,
                    validityDays: item.validityDays,
                    quantity: 1
                };
                selectedBillingItems.push(billingItem);
            }
            
            // 更新顯示
            updateBillingDisplay();
            
            // 清除搜索
            clearBillingSearch();
            
            showToast(`已添加收費項目：${item.name}`, 'success');
        }
        
        // 更新收費項目顯示
        function updateBillingDisplay() {
            const container = document.getElementById('selectedBillingItems');
            const hiddenTextarea = document.getElementById('formBillingItems');
            const totalAmountSpan = document.getElementById('totalBillingAmount');
            
            if (selectedBillingItems.length === 0) {
                container.innerHTML = `
                    <div class="text-sm text-gray-500 text-center py-4">
                        請使用上方搜索功能添加收費項目
                    </div>
                `;
                hiddenTextarea.value = '';
                totalAmountSpan.textContent = '$0';
                return;
            }
            
            // 計算總費用
            let totalAmount = 0;
            let subtotalBeforeDiscount = 0;
            
            // 先計算非折扣項目的小計
            selectedBillingItems.forEach(item => {
                if (item.category !== 'discount') {
                    subtotalBeforeDiscount += item.price * item.quantity;
                }
            });
            
            // 計算折扣後的總金額
            totalAmount = subtotalBeforeDiscount;
            selectedBillingItems.forEach(item => {
                if (item.category === 'discount') {
                    if (item.price > 0 && item.price < 1) {
                        // 百分比折扣：對小計進行折扣計算
                        const discountAmount = subtotalBeforeDiscount * (1 - item.price) * item.quantity;
                        totalAmount -= discountAmount;
                    } else {
                        // 固定金額折扣
                        totalAmount += item.price * item.quantity;
                    }
                }
            });
            totalAmountSpan.textContent = `$${totalAmount}`;
            
            // 分離折扣項目和非折扣項目，但保持各自的添加順序
            const nonDiscountItems = [];
            const discountItems = [];
            
            selectedBillingItems.forEach((item, originalIndex) => {
                if (item.category === 'discount') {
                    discountItems.push({ item, originalIndex });
                } else {
                    nonDiscountItems.push({ item, originalIndex });
                }
            });
            
            // 合併顯示：非折扣項目在前，折扣項目在後
            const displayItems = [...nonDiscountItems, ...discountItems];
            
            // 顯示已選擇的項目（非折扣項目在前，折扣項目在後）
            container.innerHTML = `
                <div class="space-y-2">
                    ${displayItems.map(({ item, originalIndex }) => {
                        const categoryNames = {
                            consultation: '診療費',
                            medicine: '藥費',
                            treatment: '治療費',
                            other: '其他',
                            discount: '折扣項目',
                            package: '套票項目'
                        };
                        const categoryName = categoryNames[item.category] || '未分類';
                        const bgColor = getCategoryBgColor(item.category);
                        let subtotal;
                        let subtotalDisplay;
                        // 套票使用：不顯示加減號，只保留取消按鈕
                        const isPackageUse = item.category === 'packageUse';
                        const qtyControls = isPackageUse ? '' : `<div class="flex items-center space-x-2 mr-3">
                            <button onclick="updateBillingQuantity(${originalIndex}, -1)" class="bg-red-500 text-white px-2 py-1 rounded-full text-xs hover:bg-red-600 transition duration-200">-</button>
                            <span class="w-8 text-center font-semibold">${item.quantity}</span>
                            <button onclick="updateBillingQuantity(${originalIndex}, 1)" class="bg-green-500 text-white px-2 py-1 rounded-full text-xs hover:bg-green-600 transition duration-200">+</button>
                        </div>`;
        
                        
                        if (item.category === 'discount' && item.price > 0 && item.price < 1) {
                            // 百分比折扣：顯示折扣金額
                            const discountAmount = subtotalBeforeDiscount * (1 - item.price) * item.quantity;
                            subtotal = -discountAmount;
                            subtotalDisplay = `-$${discountAmount.toFixed(0)}`;
                        } else {
                            // 一般項目或固定金額折扣
                            subtotal = item.price * item.quantity;
                            subtotalDisplay = `$${subtotal}`;
                        }
                        
                        return `
                            <div class="flex items-center ${bgColor} border rounded-lg p-3">
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-900">${item.name}</div>
                                    <div class="text-xs text-gray-600">${categoryName}</div>
                                    <div class="text-sm font-medium ${item.category === 'discount' ? 'text-red-600' : 'text-green-600'}">
                                        ${(() => {
                                            if (item.category === 'discount') {
                                                if (item.price > 0 && item.price < 1) {
                                                    return `${(item.price * 10).toFixed(1)}折`;
                                                } else if (item.price < 0) {
                                                    return `-$${Math.abs(item.price)}`;
                                                } else {
                                                    return `$${item.price}`;
                                                }
                                            }
                                            return `$${item.price}`;
                                        })()}${item.unit ? ` / ${item.unit}` : ''}
                                    </div>
                                </div>
                                ${qtyControls}
                                <div class="mr-3 text-right">
                                    <div class="font-bold ${subtotal < 0 ? 'text-red-600' : 'text-green-600'}">${subtotalDisplay}</div>
                                </div>
                                <button onclick="removeBillingItem(${originalIndex})" class="text-red-500 hover:text-red-700 font-bold text-lg px-2">×</button>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <!-- 小計和總計顯示 -->
                ${subtotalBeforeDiscount > 0 && selectedBillingItems.some(item => item.category === 'discount') ? `
                    <div class="mt-4 pt-3 border-t border-gray-200">
                        <div class="text-right space-y-1">
                            <div class="text-sm text-gray-600">
                                小計：<span class="font-medium">$${subtotalBeforeDiscount}</span>
                            </div>
                            ${selectedBillingItems.filter(item => item.category === 'discount').map(item => {
                                if (item.price > 0 && item.price < 1) {
                                    const discountAmount = subtotalBeforeDiscount * (1 - item.price) * item.quantity;
                                    return `<div class="text-sm text-red-600">
                                        ${item.name}：<span class="font-medium">-$${discountAmount.toFixed(0)}</span>
                                    </div>`;
                                } else {
                                    return `<div class="text-sm text-red-600">
                                        ${item.name}：<span class="font-medium">$${item.price * item.quantity}</span>
                                    </div>`;
                                }
                            }).join('')}
                            <div class="text-base font-bold text-green-600 pt-1 border-t border-gray-300">
                                總計：$${Math.round(totalAmount)}
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
            
            // 更新隱藏的文本域（非折扣項目在前，折扣項目在後）
            let billingText = '';
            
            // 如果有折扣項目，先顯示小計
            if (selectedBillingItems.some(item => item.category === 'discount')) {
                billingText += `小計：$${subtotalBeforeDiscount}\n\n`;
            }
            
            // 先記錄非折扣項目
            selectedBillingItems.forEach(item => {
                if (item.category !== 'discount') {
                    billingText += `${item.name} x${item.quantity} = $${item.price * item.quantity}\n`;
                }
            });
            
            // 再記錄折扣項目
            selectedBillingItems.forEach(item => {
                if (item.category === 'discount') {
                    if (item.price > 0 && item.price < 1) {
                        // 百分比折扣
                        const discountAmount = subtotalBeforeDiscount * (1 - item.price) * item.quantity;
                        billingText += `${item.name} x${item.quantity} = -$${discountAmount.toFixed(0)}\n`;
                    } else {
                        // 固定金額折扣
                        billingText += `${item.name} x${item.quantity} = $${item.price * item.quantity}\n`;
                    }
                }
            });
            
            billingText += `\n總費用：$${Math.round(totalAmount)}`;
            hiddenTextarea.value = billingText.trim();
        }
        
        // 更新收費項目數量
        function updateBillingQuantity(index, change) {
            if (index >= 0 && index < selectedBillingItems.length) {
                const newQuantity = selectedBillingItems[index].quantity + change;
                if (newQuantity > 0) {
                    selectedBillingItems[index].quantity = newQuantity;
                    updateBillingDisplay();
                } else if (newQuantity === 0) {
                    // 數量為0時移除項目
                    removeBillingItem(index);
                }
            }
        }
        
        // 移除收費項目
        function removeBillingItem(index) {
            if (index >= 0 && index < selectedBillingItems.length) {
                const removedItem = selectedBillingItems.splice(index, 1)[0];
                updateBillingDisplay();
                // showToast(`已移除：${removedItem.name}`, 'info');
            }
        }
        
        // 清除收費項目搜索
        function clearBillingSearch() {
            document.getElementById('billingSearch').value = '';
            document.getElementById('billingSearchResults').classList.add('hidden');
        }
        
        // 清空所有搜尋欄位
        function clearAllSearchFields() {
            // 清空病人搜尋欄
            const patientSearchInput = document.getElementById('patientSearchInput');
            if (patientSearchInput) {
                patientSearchInput.value = '';
            }
            
            // 清空處方搜尋欄
            clearPrescriptionSearch();
            
            // 清空收費項目搜尋欄
            clearBillingSearch();
        }
        
        // 自動添加預設診金收費
        function addDefaultConsultationFee(patient) {
            // 尋找診金收費項目（優先尋找名稱包含「診金」的項目）
            let consultationFeeItem = billingItems.find(item => 
                item.active && 
                item.category === 'consultation' && 
                item.name.includes('診金')
            );
            
            // 如果沒有找到診金項目，使用第一個診療費項目
            if (!consultationFeeItem) {
                consultationFeeItem = billingItems.find(item => 
                    item.active && item.category === 'consultation'
                );
            }
            
            // 如果找到診金項目，自動添加
            if (consultationFeeItem) {
                // 清空現有收費項目
                selectedBillingItems = [];
                
                // 添加診金項目
                const billingItem = {
                    id: consultationFeeItem.id,
                    name: consultationFeeItem.name,
                    category: consultationFeeItem.category,
                    price: consultationFeeItem.price,
                    unit: consultationFeeItem.unit,
                    description: consultationFeeItem.description,
                    quantity: 1
                };
                
                selectedBillingItems.push(billingItem);
                
                // 自動添加預設藥費（根據預設5天）
                const defaultDays = 5;
                updateMedicineFeeByDays(defaultDays);
                
                // 更新顯示
                updateBillingDisplay();
            } else {
                // 如果沒有找到任何診療費項目，只清空收費項目並更新顯示
                selectedBillingItems = [];
                updateBillingDisplay();
            }
        }
        

        
        // 載入上次處方內容（按鈕觸發）
        function loadPreviousPrescription() {
            if (!currentConsultingAppointmentId) {
                showToast('請先開始診症！', 'error');
                return;
            }
            
            const appointment = appointments.find(apt => apt.id === currentConsultingAppointmentId);
            if (!appointment) {
                showToast('找不到當前診症記錄！', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            if (!patient) {
                showToast('找不到病人資料！', 'error');
                return;
            }
            
            // 獲取該病人的最近一次診症記錄（排除當前正在編輯的記錄）
            const patientConsultations = consultations
                .filter(c => c.patientId === patient.id)
                .sort((a, b) => new Date(b.date) - new Date(a.date)); // 按日期降序排列（最新在前）
            
            const lastConsultation = patientConsultations[0]; // 最近一次診症記錄
            
            if (!lastConsultation || !lastConsultation.prescription) {
                showToast(`${patient.name} 沒有上次處方記錄可載入`, 'warning');
                return;
            }
            
            // 直接載入，不需要確認
            // 清空現有處方項目
            selectedPrescriptionItems = [];
            
            // 解析上次處方內容，重建處方項目
            parsePrescriptionToItems(lastConsultation.prescription);
            
            // 更新處方顯示
            updatePrescriptionDisplay();
            
            // showToast(`已載入 ${patient.name} 上次的處方內容`, 'success');
        }
        
        // 解析處方內容並重建處方項目
        function parsePrescriptionToItems(prescriptionText) {
            if (!prescriptionText) return;
            
            const lines = prescriptionText.split('\n');
            let i = 0;
            
            while (i < lines.length) {
                const line = lines[i].trim();
                if (!line) {
                    i++;
                    continue;
                }
                
                // 檢查是否為藥材/方劑格式（名稱 劑量g）
                const itemMatch = line.match(/^(.+?)\s+(\d+(?:\.\d+)?)g$/);
                if (itemMatch) {
                    const itemName = itemMatch[1].trim();
                    const dosage = itemMatch[2];
                    
                    // 先在中藥庫中尋找對應的項目（優先匹配中藥材，再匹配方劑）
                    let foundItem = herbLibrary.find(item => 
                        item.type === 'herb' && item.name === itemName
                    );
                    
                    if (foundItem) {
                        // 找到中藥材
                        const prescriptionItem = {
                            id: foundItem.id,
                            type: 'herb',
                            name: foundItem.name,
                            dosage: foundItem.dosage || '6g',
                            customDosage: dosage,
                            effects: foundItem.effects
                        };
                        selectedPrescriptionItems.push(prescriptionItem);
                    } else {
                        // 沒找到中藥材，尋找方劑
                        foundItem = herbLibrary.find(item => 
                            item.type === 'formula' && item.name === itemName
                        );
                        
                        if (foundItem) {
                            // 找到方劑
                            const prescriptionItem = {
                                id: foundItem.id,
                                type: 'formula',
                                name: foundItem.name,
                                customDosage: dosage,
                                composition: foundItem.composition,
                                effects: foundItem.effects
                            };
                            selectedPrescriptionItems.push(prescriptionItem);
                        } else {
                            // 都沒找到，根據常見方劑名稱特徵智能判斷類型
                            const isLikelyFormula = isFormulaName(itemName);
                            
                            const prescriptionItem = {
                                id: Date.now() + Math.random(), // 臨時ID
                                type: isLikelyFormula ? 'formula' : 'herb',
                                name: itemName,
                                customDosage: dosage,
                                effects: '（從上次處方載入）'
                            };
                            
                            if (isLikelyFormula) {
                                prescriptionItem.composition = '（從上次處方載入）';
                            } else {
                                prescriptionItem.dosage = `${dosage}g`;
                            }
                            
                            selectedPrescriptionItems.push(prescriptionItem);
                        }
                    }
                }
                
                i++;
            }
        }
        
        // 判斷是否為方劑名稱的輔助函數
        function isFormulaName(name) {
            // 常見方劑名稱特徵
            const formulaKeywords = [
                '湯', '散', '丸', '膏', '飲', '丹', '煎', '方', '劑',
                '四君子', '六君子', '八珍', '十全', '補中益氣', '逍遙',
                '甘麥大棗', '小柴胡', '大柴胡', '半夏瀉心', '黃連解毒',
                '清熱解毒', '銀翹', '桑菊', '麻黃', '桂枝', '葛根',
                '白虎', '承氣', '理中', '真武', '苓桂', '五苓'
            ];
            
            return formulaKeywords.some(keyword => name.includes(keyword));
        }
        

        
        // 載入上次收費項目（按鈕觸發）
        function loadPreviousBillingItems() {
            if (!currentConsultingAppointmentId) {
                showToast('請先開始診症！', 'error');
                return;
            }
            
            const appointment = appointments.find(apt => apt.id === currentConsultingAppointmentId);
            if (!appointment) {
                showToast('找不到當前診症記錄！', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === appointment.patientId);
            if (!patient) {
                showToast('找不到病人資料！', 'error');
                return;
            }
            
            // 獲取該病人的最近一次診症記錄
            const patientConsultations = consultations
                .filter(c => c.patientId === patient.id)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const lastConsultation = patientConsultations[0];
            
            if (!lastConsultation || !lastConsultation.billingItems) {
                showToast(`${patient.name} 沒有上次收費記錄可載入`, 'warning');
                return;
            }
            
            // 直接載入，不需要確認
            // 清空現有收費項目
            selectedBillingItems = [];
            
            // 解析並載入上次收費項目
            parseBillingItemsFromText(lastConsultation.billingItems);
            
            // 更新顯示
            updateBillingDisplay();
        }
        
        // 解析收費項目文字並載入
        function parseBillingItemsFromText(billingText) {
            if (!billingText) {
                return;
            }
            
            // 解析上次收費項目
            const billingLines = billingText.split('\n');
            
            billingLines.forEach(line => {
                line = line.trim();
                if (!line || line.includes('小計') || line.includes('總費用')) return;
                
                // 解析收費項目格式：項目名 x數量 = $金額 或 項目名 x數量 = -$金額
                const itemMatch = line.match(/^(.+?)\s+x(\d+)\s+=\s+([\-\$]?\d+)$/);
                if (itemMatch) {
                    const itemName = itemMatch[1].trim();
                    const quantity = parseInt(itemMatch[2]);
                    
                    // 在收費項目中尋找對應的項目
                    const billingItem = billingItems.find(item => 
                        item.active && item.name === itemName
                    );
                    
                    if (billingItem) {
                        const selectedItem = {
                            id: billingItem.id,
                            name: billingItem.name,
                            category: billingItem.category,
                            price: billingItem.price,
                            unit: billingItem.unit,
                            description: billingItem.description,
                            quantity: quantity
                        };
                        selectedBillingItems.push(selectedItem);
                    } else {
                        // 如果在收費項目中找不到，創建一個臨時項目（用於已刪除的收費項目）
                        console.log(`找不到收費項目：${itemName}，可能已被刪除`);
                    }
                }
            });
        }
        
        // 載入上次收費項目（內部函數 - 保留向後兼容）
        function loadPreviousBillingItemsFromConsultation(lastConsultation) {
            selectedBillingItems = [];
            parseBillingItemsFromText(lastConsultation.billingItems);
            updateBillingDisplay();
        }
        
        // 載入指定病歷記錄到當前診症
        function loadMedicalRecordToCurrentConsultation(consultationId) {
            if (!currentConsultingAppointmentId) {
                showToast('請先開始診症！', 'error');
                return;
            }
            
            const consultation = consultations.find(c => c.id === consultationId);
            if (!consultation) {
                showToast('找不到指定的診症記錄！', 'error');
                return;
            }
            
            const currentAppointment = appointments.find(apt => apt.id === currentConsultingAppointmentId);
            if (!currentAppointment) {
                showToast('找不到當前診症記錄！', 'error');
                return;
            }
            
            // 確認是否為相同病人
            if (currentAppointment.patientId !== consultation.patientId) {
                showToast('只能載入相同病人的病歷記錄！', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === consultation.patientId);
            const consultationDate = new Date(consultation.date).toLocaleDateString('zh-TW');
            
            // 確認載入操作
            const confirmMessage = `確定要載入 ${patient ? patient.name : '未知病人'} 在 ${consultationDate} 的病歷記錄嗎？\n\n` +
                                 `此操作將會覆蓋當前已填寫的診症內容，包括：\n` +
                                 `• 主訴、舌象、脈象等診症資料\n` +
                                 `• 診斷和證型\n` +
                                 `• 處方內容\n` +
                                 `• 收費項目\n` +
                                 `• 醫囑和注意事項\n\n` +
                                 `注意：此操作無法復原！`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // 載入診症資料
            document.getElementById('formSymptoms').value = consultation.symptoms || '';
            document.getElementById('formTongue').value = consultation.tongue || '';
            document.getElementById('formPulse').value = consultation.pulse || '';
            document.getElementById('formCurrentHistory').value = consultation.currentHistory || '';
            document.getElementById('formDiagnosis').value = consultation.diagnosis || '';
            document.getElementById('formSyndrome').value = consultation.syndrome || '';
            document.getElementById('formAcupunctureNotes').value = consultation.acupunctureNotes || '';
            document.getElementById('formUsage').value = consultation.usage || '';
            document.getElementById('formTreatmentCourse').value = consultation.treatmentCourse || '';
            document.getElementById('formInstructions').value = consultation.instructions || '';
            document.getElementById('formFollowUpDate').value = consultation.followUpDate || '';
            document.getElementById('formVisitTime').value = consultation.visitTime || '';
            
            // 載入休息期間
            if (consultation.restStartDate && consultation.restEndDate) {
                document.getElementById('formRestStartDate').value = consultation.restStartDate;
                document.getElementById('formRestEndDate').value = consultation.restEndDate;
                updateRestPeriod();
            } else {
                // 使用預設休息期間（今天到後天）
                const startDate = new Date();
                const endDate = new Date();
                endDate.setDate(startDate.getDate() + 2);
                
                const startDateStr = `${startDate.getFullYear()}-${String(startDate.getMonth() + 1).padStart(2, '0')}-${String(startDate.getDate()).padStart(2, '0')}`;
                const endDateStr = `${endDate.getFullYear()}-${String(endDate.getMonth() + 1).padStart(2, '0')}-${String(endDate.getDate()).padStart(2, '0')}`;
                
                document.getElementById('formRestStartDate').value = startDateStr;
                document.getElementById('formRestEndDate').value = endDateStr;
                updateRestPeriod();
            }
            
            // 載入處方內容
            selectedPrescriptionItems = [];
            if (consultation.prescription) {
                // 直接將處方內容設置到隱藏文本域
                document.getElementById('formPrescription').value = consultation.prescription;
                
                // 解析處方內容並重建處方項目
                parsePrescriptionToItems(consultation.prescription);
                
                // 更新處方顯示
                updatePrescriptionDisplay();
            } else {
                // 清空處方
                document.getElementById('formPrescription').value = '';
                updatePrescriptionDisplay();
            }
            
            // 載入收費項目
            selectedBillingItems = [];
            if (consultation.billingItems) {
                // 直接將收費項目設置到隱藏文本域
                document.getElementById('formBillingItems').value = consultation.billingItems;
                
                // 解析並載入收費項目
                parseBillingItemsFromText(consultation.billingItems);
                
                // 更新收費顯示
                updateBillingDisplay();
            } else {
                // 清空收費項目
                document.getElementById('formBillingItems').value = '';
                updateBillingDisplay();
            }
            
            // 清除搜索框
            clearPrescriptionSearch();
            clearBillingSearch();
            
            // 關閉病歷查看彈窗
            closeMedicalHistoryModal();
            
            // 滾動到診症表單
            document.getElementById('consultationForm').scrollIntoView({ behavior: 'smooth' });
            
            showToast(`已載入 ${patient ? patient.name : '未知病人'} 在 ${consultationDate} 的完整病歷記錄`, 'success');
        }
        
        // 清空診症表單時也要清空處方搜索
        function clearConsultationFormOld() {
            ['formSymptoms', 'formTongue', 'formPulse', 'formCurrentHistory', 'formDiagnosis', 'formSyndrome', 'formAcupunctureNotes', 'formPrescription', 'formUsage', 'formTreatmentCourse', 'formInstructions', 'formFollowUpDate'].forEach(id => {
                document.getElementById(id).value = '';
            });
            
            // 清空處方項目
            selectedPrescriptionItems = [];
            updatePrescriptionDisplay();
            clearPrescriptionSearch();
            
            // 清空收費項目
            selectedBillingItems = [];
            updateBillingDisplay();
            clearBillingSearch();
        }



        // 獲取用戶顯示名稱（姓名全名 + 職位）
        function getUserDisplayName(user) {
            if (!user || !user.name) return '未知用戶';
            
            const fullName = user.name;
            const position = user.position || '用戶';
            
            return `${fullName}${position}`;
        }
        
        // 獲取醫師顯示名稱
        function getDoctorDisplayName(doctorRole) {
            if (!doctorRole) return '未記錄';
            
            // 如果是舊的固定值，直接返回
            if (doctorRole === 'doctor') {
                return '張中醫師醫師';
            }
            
            // 尋找對應的醫師用戶
            const doctorUser = users.find(u => u.username === doctorRole);
            if (doctorUser) {
                return getUserDisplayName(doctorUser);
            }
            
            // 如果找不到，返回原值
            return doctorRole;
        }
        
        // 獲取醫師註冊編號
        function getDoctorRegistrationNumber(doctorRole) {
            if (!doctorRole) return null;
            
            // 如果是舊的固定值，返回預設註冊編號
            if (doctorRole === 'doctor') {
                return 'CM001234';
            }
            
            // 尋找對應的醫師用戶
            const doctorUser = users.find(u => u.username === doctorRole);
            if (doctorUser && doctorUser.position === '醫師') {
                return doctorUser.registrationNumber || null;
            }
            
            return null;
        }
        
        // 用戶管理功能
        let editingUserId = null;
        let currentUserFilter = 'all';
        
        function loadUserManagement() {
            displayUsers();
            
            // 搜尋功能
            const searchInput = document.getElementById('searchUser');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    displayUsers();
                });
            }
        }
        
        function filterUsers(status) {
            currentUserFilter = status;
            
            // 更新按鈕樣式
            document.querySelectorAll('[id^="user-filter-"]').forEach(btn => {
                btn.className = 'px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200';
            });
            document.getElementById(`user-filter-${status}`).className = 'px-4 py-2 rounded-lg text-sm font-medium bg-blue-100 text-blue-800 transition duration-200';
            
            displayUsers();
        }
        
        function displayUsers() {
            const searchTerm = document.getElementById('searchUser').value.toLowerCase();
            const tbody = document.getElementById('userList');
            
            // 過濾用戶資料
            let filteredUsers = users.filter(user => {
                const matchesSearch = user.username.toLowerCase().includes(searchTerm) ||
                                    user.name.toLowerCase().includes(searchTerm) ||
                                    (user.email && user.email.toLowerCase().includes(searchTerm));
                
                let matchesFilter = true;
                if (currentUserFilter === 'inactive') {
                    matchesFilter = !user.active;
                }
                
                return matchesSearch && matchesFilter;
            });
            
            tbody.innerHTML = '';
            
            if (filteredUsers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                            ${searchTerm ? '沒有找到符合條件的用戶' : '尚無用戶資料'}
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredUsers.forEach(user => {
                const statusClass = user.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const statusText = user.active ? '啟用' : '停用';
                
                const lastLogin = user.lastLogin ? 
                    new Date(user.lastLogin).toLocaleString('zh-TW') : '從未登入';
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-900 font-medium">${user.username}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${user.name}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${user.position || '未設定'}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${user.position === '醫師' ? (user.registrationNumber || '未設定') : '-'}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${user.email || '未設定'}</td>
                    <td class="px-4 py-3">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600">${lastLogin}</td>
                    <td class="px-4 py-3 text-sm space-x-2">
                        <button onclick="editUser(${user.id})" class="text-blue-600 hover:text-blue-800">編輯</button>
                        ${user.id !== currentUserData.id ? `
                            <button onclick="toggleUserStatus(${user.id})" class="text-orange-600 hover:text-orange-800">
                                ${user.active ? '停用' : '啟用'}
                            </button>
                            <button onclick="deleteUser(${user.id})" class="text-red-600 hover:text-red-800">刪除</button>
                        ` : `
                            <span class="text-gray-400 text-xs">當前用戶</span>
                        `}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function showAddUserForm() {
            editingUserId = null;
            document.getElementById('userFormTitle').textContent = '新增用戶';
            document.getElementById('userSaveButtonText').textContent = '儲存';
            clearUserForm();
            document.getElementById('addUserModal').classList.remove('hidden');
        }
        
        function hideAddUserForm() {
            document.getElementById('addUserModal').classList.add('hidden');
            clearUserForm();
            editingUserId = null;
        }
        
        function clearUserForm() {
            ['userName', 'userPassword', 'userDisplayName', 'userPosition', 'userEmail', 'userPhone', 'userRegistrationNumber'].forEach(id => {
                document.getElementById(id).value = '';
            });
            document.getElementById('userActive').checked = true;
            
            // 隱藏註冊編號欄位
            document.getElementById('registrationNumberField').classList.add('hidden');
        }
        
        // 切換註冊編號欄位顯示
        function toggleRegistrationNumberField() {
            const positionSelect = document.getElementById('userPosition');
            const registrationField = document.getElementById('registrationNumberField');
            
            if (positionSelect.value === '醫師') {
                registrationField.classList.remove('hidden');
            } else {
                registrationField.classList.add('hidden');
                // 清空註冊編號欄位
                document.getElementById('userRegistrationNumber').value = '';
            }
        }
        
        function editUser(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;
            
            editingUserId = id;
            document.getElementById('userFormTitle').textContent = '編輯用戶';
            document.getElementById('userSaveButtonText').textContent = '更新';
            
            document.getElementById('userName').value = user.username || '';
            document.getElementById('userPassword').value = ''; // 密碼欄位保持空白
            document.getElementById('userDisplayName').value = user.name || '';
            document.getElementById('userPosition').value = user.position || '';
            document.getElementById('userEmail').value = user.email || '';
            document.getElementById('userPhone').value = user.phone || '';
            document.getElementById('userRegistrationNumber').value = user.registrationNumber || '';
            document.getElementById('userActive').checked = user.active !== false;
            
            // 根據職位顯示或隱藏註冊編號欄位
            toggleRegistrationNumberField();
            
            document.getElementById('addUserModal').classList.remove('hidden');
        }
        
        function saveUser() {
            const username = document.getElementById('userName').value.trim();
            const password = document.getElementById('userPassword').value.trim();
            const name = document.getElementById('userDisplayName').value.trim();
            const position = document.getElementById('userPosition').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const phone = document.getElementById('userPhone').value.trim();
            const registrationNumber = document.getElementById('userRegistrationNumber').value.trim();
            const active = document.getElementById('userActive').checked;
            
            // 驗證必填欄位
            if (!username || !name || !position) {
                showToast('請填寫必要資料（帳號、姓名、職位）！', 'error');
                return;
            }
            
            // 醫師職位必須填寫註冊編號
            if (position === '醫師' && !registrationNumber) {
                showToast('醫師職位必須填寫中醫註冊編號！', 'error');
                return;
            }
            
            // 驗證帳號格式
            const usernameRegex = /^[a-zA-Z0-9_]+$/;
            if (!usernameRegex.test(username)) {
                showToast('帳號只能包含英文字母、數字和底線！', 'error');
                return;
            }
            
            // 新增用戶時密碼為必填
            if (!editingUserId && !password) {
                showToast('請輸入密碼！', 'error');
                return;
            }
            
            // 驗證密碼長度
            if (password && password.length < 6) {
                showToast('密碼至少需要6個字符！', 'error');
                return;
            }
            
            // 檢查帳號是否重複
            const existingUser = users.find(u => u.username === username && u.id !== editingUserId);
            if (existingUser) {
                showToast('此帳號已存在，請使用其他帳號！', 'error');
                return;
            }
            
            // 驗證電子郵件格式
            if (email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    showToast('請輸入有效的電子郵件格式！', 'error');
                    return;
                }
            }
            
            if (editingUserId) {
                // 更新現有用戶
                const userIndex = users.findIndex(u => u.id === editingUserId);
                if (userIndex === -1) {
                    showToast('找不到要更新的用戶！', 'error');
                    return;
                }
                
                // 直接更新用戶屬性
                users[userIndex].username = username;
                users[userIndex].name = name;
                users[userIndex].position = position;
                users[userIndex].registrationNumber = position === '醫師' ? registrationNumber : null;
                users[userIndex].email = email;
                users[userIndex].phone = phone;
                users[userIndex].active = active;
                users[userIndex].updatedAt = new Date().toISOString();
                
                // 只有在密碼有輸入時才更新密碼
                if (password) {
                    users[userIndex].password = password;
                }
                
                // 如果更新的是當前登入用戶，同步更新 currentUserData
                if (editingUserId === currentUserData.id) {
                    currentUserData = users[userIndex];
                    currentUser = users[userIndex].username;
                    
                    // 更新顯示的用戶資訊
                    document.getElementById('userRole').textContent = `當前用戶：${getUserDisplayName(users[userIndex])}`;
                    document.getElementById('sidebarUserRole').textContent = `當前用戶：${getUserDisplayName(users[userIndex])}`;
                }
                
                showToast('用戶資料已成功更新！', 'success');
            } else {
                // 新增用戶
                const newUser = {
                    id: Date.now(),
                    username: username,
                    password: password,
                    name: name,
                    position: position,
                    registrationNumber: position === '醫師' ? registrationNumber : null,
                    email: email,
                    phone: phone,
                    active: active,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    lastLogin: null
                };
                
                users.push(newUser);
                showToast('用戶已成功新增！', 'success');
            }
            
            localStorage.setItem('users', JSON.stringify(users));
            displayUsers();
            hideAddUserForm();
        }
        
        function toggleUserStatus(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;
            
            // 防止停用自己的帳號
            if (user.id === currentUserData.id) {
                showToast('不能停用自己的帳號！', 'error');
                return;
            }
            
            const action = user.active ? '停用' : '啟用';
            const confirmMessage = `確定要${action}用戶「${user.name}」嗎？\n\n${user.active ? '停用後該用戶將無法登入系統。' : '啟用後該用戶可以正常登入系統。'}`;
            
            if (confirm(confirmMessage)) {
                user.active = !user.active;
                user.updatedAt = new Date().toISOString();
                
                localStorage.setItem('users', JSON.stringify(users));
                displayUsers();
                showToast(`用戶「${user.name}」已${action}！`, 'success');
            }
        }
        
        function deleteUser(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;
            
            // 防止刪除自己的帳號
            if (user.id === currentUserData.id) {
                showToast('不能刪除自己的帳號！', 'error');
                return;
            }
            
            // 檢查是否為最後一個管理員
            const adminUsers = users.filter(u => u.role === 'admin' && u.active && u.id !== id);
            if (user.role === 'admin' && adminUsers.length === 0) {
                showToast('不能刪除最後一個管理員帳號！', 'error');
                return;
            }
            
            const confirmMessage = `確定要刪除用戶「${user.name}」嗎？\n\n` +
                                 `帳號：${user.username}\n` +
                                 `角色：${user.role === 'admin' ? '管理員' : user.role === 'doctor' ? '醫師' : '助理'}\n\n` +
                                 `注意：此操作無法復原！`;
            
            if (confirm(confirmMessage)) {
                users = users.filter(u => u.id !== id);
                localStorage.setItem('users', JSON.stringify(users));
                displayUsers();
                showToast(`用戶「${user.name}」已刪除！`, 'success');
            }
        }

// 財務報表功能
        let currentFinancialTabType = 'summary';
        
        // 載入財務報表頁面
        function loadFinancialReports() {
            // 設置預設日期範圍（本月）
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            document.getElementById('startDate').value = formatFinancialDate(firstDayOfMonth);
            document.getElementById('endDate').value = formatFinancialDate(lastDayOfMonth);
            
            // 載入醫師選項
            loadFinancialDoctorOptions();
            
            // 生成初始報表
            generateFinancialReport();
        }

        // 格式化日期為 YYYY-MM-DD
        function formatFinancialDate(date) {
            return date.toISOString().split('T')[0];
        }

        // 載入醫師選項
        function loadFinancialDoctorOptions() {
            const doctorSelect = document.getElementById('doctorFilter');
            const doctors = users.filter(user => 
                user.active && user.position === '醫師'
            );
            
            // 清空現有選項（保留「全部醫師」）
            doctorSelect.innerHTML = '<option value="">全部醫師</option>';
            
            // 添加醫師選項
            doctors.forEach(doctor => {
                const option = document.createElement('option');
                option.value = doctor.username;
                option.textContent = `${doctor.name}`;
                doctorSelect.appendChild(option);
            });
        }

        // 快速日期選擇
        function setQuickDate() {
            const quickDate = document.getElementById('quickDate').value;
            const today = new Date();
            let startDate, endDate;

            switch (quickDate) {
                case 'today':
                    startDate = endDate = today;
                    document.getElementById('reportType').value = 'daily';
                    break;
                case 'yesterday':
                    startDate = endDate = new Date(today.getTime() - 24 * 60 * 60 * 1000);
                    document.getElementById('reportType').value = 'daily';
                    break;
                case 'thisWeek':
                    const thisWeekStart = new Date(today);
                    thisWeekStart.setDate(today.getDate() - today.getDay());
                    startDate = thisWeekStart;
                    endDate = today;
                    document.getElementById('reportType').value = 'weekly';
                    break;
                case 'lastWeek':
                    const lastWeekStart = new Date(today);
                    lastWeekStart.setDate(today.getDate() - today.getDay() - 7);
                    const lastWeekEnd = new Date(lastWeekStart);
                    lastWeekEnd.setDate(lastWeekStart.getDate() + 6);
                    startDate = lastWeekStart;
                    endDate = lastWeekEnd;
                    document.getElementById('reportType').value = 'weekly';
                    break;
                case 'thisMonth':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    document.getElementById('reportType').value = 'monthly';
                    break;
                case 'lastMonth':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                    document.getElementById('reportType').value = 'monthly';
                    break;
                case 'thisYear':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = new Date(today.getFullYear(), 11, 31);
                    document.getElementById('reportType').value = 'yearly';
                    break;
                case 'lastYear':
                    startDate = new Date(today.getFullYear() - 1, 0, 1);
                    endDate = new Date(today.getFullYear() - 1, 11, 31);
                    document.getElementById('reportType').value = 'yearly';
                    break;
                default:
                    return;
            }

            if (startDate && endDate) {
                document.getElementById('startDate').value = formatFinancialDate(startDate);
                document.getElementById('endDate').value = formatFinancialDate(endDate);
                generateFinancialReport();
            }
        }

        // 解析收費項目文本
        function parseFinancialBillingItems(billingText) {
            const items = [];
            const lines = billingText.split('\n');
            let totalAmount = 0;

            lines.forEach(line => {
                line = line.trim();
                if (!line || line.includes('小計') || line.includes('總費用')) {
                    // 提取總費用
                    if (line.includes('總費用')) {
                        const match = line.match(/\$(\d+)/);
                        if (match) {
                            totalAmount = parseInt(match[1]);
                        }
                    }
                    return;
                }

                // 解析收費項目格式：項目名 x數量 = $金額 或 項目名 x數量 = -$金額
                const itemMatch = line.match(/^(.+?)\s+x(\d+)\s+=\s+([\-\$]?\d+)$/);
                if (itemMatch) {
                    const itemName = itemMatch[1].trim();
                    const quantity = parseInt(itemMatch[2]);
                    const amount = parseInt(itemMatch[3].replace(/[\-\$]/g, ''));
                    const isDiscount = itemMatch[3].includes('-');

                    items.push({
                        name: itemName,
                        quantity: quantity,
                        unitPrice: Math.abs(amount / quantity),
                        totalAmount: isDiscount ? -amount : amount,
                        category: getFinancialCategoryFromItemName(itemName)
                    });
                }
            });

            return { items, totalAmount };
        }

        // 根據項目名稱推斷類別
        function getFinancialCategoryFromItemName(itemName) {
            if (itemName.includes('診金') || itemName.includes('診療') || itemName.includes('複診')) {
                return 'consultation';
            } else if (itemName.includes('藥') || itemName.includes('中藥') || itemName.includes('調劑')) {
                return 'medicine';
            } else if (itemName.includes('針灸') || itemName.includes('推拿') || itemName.includes('拔罐') || itemName.includes('刮痧') || itemName.includes('艾灸')) {
                return 'treatment';
            } else if (itemName.includes('折扣') || itemName.includes('優惠')) {
                return 'discount';
            } else if (itemName.includes('套票') || itemName.includes('套餐') || itemName.includes('療程') || itemName.includes('方案')) {
                return 'package';
            } else {
                return 'other';
            }
        }

        // 生成財務報表
        function generateFinancialReport() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const doctorFilter = document.getElementById('doctorFilter').value;
            const reportType = document.getElementById('reportType').value;

            if (!startDate || !endDate) {
                showToast('請選擇日期範圍！', 'error');
                return;
            }

            // 過濾診症資料
            const filteredConsultations = filterFinancialConsultations(startDate, endDate, doctorFilter);
            
            // 計算統計資料
            const stats = calculateFinancialStatistics(filteredConsultations);
            
            // 更新關鍵指標
            updateFinancialKeyMetrics(stats);
            
            // 更新表格
            updateFinancialTables(filteredConsultations, stats);
            
            // 更新時間
            document.getElementById('lastUpdateTime').textContent = new Date().toLocaleString('zh-TW');
            
            showToast('財務報表已更新！', 'success');
        }

        // 過濾診症資料
        function filterFinancialConsultations(startDate, endDate, doctorFilter) {
            const start = new Date(startDate);
            const end = new Date(endDate + 'T23:59:59.999Z');

            return consultations.filter(consultation => {
                const consultationDate = new Date(consultation.date);
                const dateInRange = consultationDate >= start && consultationDate <= end;
                const doctorMatch = !doctorFilter || consultation.doctor === doctorFilter;
                const isCompleted = consultation.status === 'completed';

                return dateInRange && doctorMatch && isCompleted;
            });
        }

        // 計算財務統計資料
        function calculateFinancialStatistics(consultations) {
            let totalRevenue = 0;
            let totalConsultations = consultations.length;
            const doctorStats = {};
            const serviceStats = {};
            const dailyStats = {};

            consultations.forEach(consultation => {
                const parsed = parseFinancialBillingItems(consultation.billingItems || '');
                const consultationRevenue = parsed.totalAmount;
                totalRevenue += consultationRevenue;

                // 醫師統計
                if (!doctorStats[consultation.doctor]) {
                    doctorStats[consultation.doctor] = {
                        count: 0,
                        revenue: 0
                    };
                }
                doctorStats[consultation.doctor].count += 1;
                doctorStats[consultation.doctor].revenue += consultationRevenue;

                // 服務統計
                parsed.items.forEach(item => {
                    if (!serviceStats[item.category]) {
                        serviceStats[item.category] = {
                            name: getFinancialCategoryDisplayName(item.category),
                            count: 0,
                            revenue: 0,
                            items: []
                        };
                    }
                    serviceStats[item.category].count += item.quantity;
                    serviceStats[item.category].revenue += item.totalAmount;
                    serviceStats[item.category].items.push(item);
                });

                // 每日統計
                const dateKey = consultation.date.split('T')[0];
                if (!dailyStats[dateKey]) {
                    dailyStats[dateKey] = {
                        count: 0,
                        revenue: 0,
                        services: {}
                    };
                }
                dailyStats[dateKey].count += 1;
                dailyStats[dateKey].revenue += consultationRevenue;
            });

            const averageRevenue = totalConsultations > 0 ? totalRevenue / totalConsultations : 0;
            const activeDoctors = Object.keys(doctorStats).length;

            return {
                totalRevenue,
                totalConsultations,
                averageRevenue,
                activeDoctors,
                doctorStats,
                serviceStats,
                dailyStats
            };
        }

        // 獲取類別顯示名稱
        function getFinancialCategoryDisplayName(category) {
            const names = {
                consultation: '診療費',
                medicine: '藥費',
                treatment: '治療費',
                other: '其他費用',
                discount: '折扣',
                package: '套票項目'
            };
            return names[category] || category;
        }

        // 更新關鍵指標
        function updateFinancialKeyMetrics(stats) {
            document.getElementById('totalRevenue').textContent = `$${stats.totalRevenue.toLocaleString()}`;
            document.getElementById('totalConsultations').textContent = stats.totalConsultations.toLocaleString();
            document.getElementById('averageRevenue').textContent = `$${Math.round(stats.averageRevenue).toLocaleString()}`;
            document.getElementById('activeDoctors').textContent = stats.activeDoctors;
        }

        // 更新財務表格
        function updateFinancialTables(consultations, stats) {
            updateFinancialSummaryTable(stats);
            updateFinancialDailyTable(stats.dailyStats);
            updateFinancialDoctorTable(stats.doctorStats);
            updateFinancialServiceTable(stats.serviceStats);
        }

        // 更新收入摘要表格
        function updateFinancialSummaryTable(stats) {
            const tbody = document.getElementById('financialSummaryTableBody');
            const summaryData = [
                { item: '診療費收入', amount: 0, category: 'consultation' },
                { item: '藥費收入', amount: 0, category: 'medicine' },
                { item: '治療費收入', amount: 0, category: 'treatment' },
                { item: '其他收入', amount: 0, category: 'other' },
                { item: '套票收入', amount: 0, category: 'package' }
            ];

            // 計算各類別收入
            Object.keys(stats.serviceStats).forEach(category => {
                const stat = stats.serviceStats[category];
                const summaryItem = summaryData.find(item => item.category === category);
                if (summaryItem) {
                    summaryItem.amount = stat.revenue;
                }
            });

            const totalRevenue = stats.totalRevenue;

            tbody.innerHTML = summaryData.map(item => {
                const percentage = totalRevenue > 0 ? ((item.amount / totalRevenue) * 100).toFixed(1) : '0';
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm text-gray-900">${item.item}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-right font-medium">$${item.amount.toLocaleString()}</td>
                        <td class="px-4 py-3 text-sm text-gray-600 text-right">${percentage}%</td>
                        <td class="px-4 py-3 text-sm text-gray-500 text-right">統計期間</td>
                    </tr>
                `;
            }).join('');
        }

        // 更新每日明細表格
        function updateFinancialDailyTable(dailyStats) {
            const tbody = document.getElementById('financialDailyTableBody');
            const sortedDates = Object.keys(dailyStats).sort().reverse();

            if (sortedDates.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                            選定期間內沒有診症記錄
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = sortedDates.map(date => {
                const stat = dailyStats[date];
                const averageDaily = stat.count > 0 ? Math.round(stat.revenue / stat.count) : 0;
                const formattedDate = new Date(date + 'T00:00:00').toLocaleDateString('zh-TW');

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm text-gray-900">${formattedDate}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-right">${stat.count}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-right font-medium">$${stat.revenue.toLocaleString()}</td>
                        <td class="px-4 py-3 text-sm text-gray-600 text-right">$${averageDaily.toLocaleString()}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">診療、藥費</td>
                    </tr>
                `;
            }).join('');
        }

        // 更新醫師業績表格
        function updateFinancialDoctorTable(doctorStats) {
            const tbody = document.getElementById('financialDoctorTableBody');
            const totalRevenue = Object.values(doctorStats).reduce((sum, stat) => sum + stat.revenue, 0);

            if (Object.keys(doctorStats).length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                            選定期間內沒有醫師診症記錄
                        </td>
                    </tr>
                `;
                return;
            }

            const sortedDoctors = Object.entries(doctorStats).sort(([,a], [,b]) => b.revenue - a.revenue);

            tbody.innerHTML = sortedDoctors.map(([doctorUsername, stat]) => {
                const percentage = totalRevenue > 0 ? ((stat.revenue / totalRevenue) * 100).toFixed(1) : '0';
                const average = stat.count > 0 ? Math.round(stat.revenue / stat.count) : 0;
                const doctorName = getDoctorDisplayName(doctorUsername);

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm text-gray-900">${doctorName}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-right">${stat.count}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-right font-medium">$${stat.revenue.toLocaleString()}</td>
                        <td class="px-4 py-3 text-sm text-gray-600 text-right">$${average.toLocaleString()}</td>
                        <td class="px-4 py-3 text-sm text-gray-600 text-right">${percentage}%</td>
                    </tr>
                `;
            }).join('');
        }

        // 更新服務分析表格
        function updateFinancialServiceTable(serviceStats) {
            const tbody = document.getElementById('financialServiceTableBody');
            const totalRevenue = Object.values(serviceStats).reduce((sum, stat) => sum + stat.revenue, 0);

            if (Object.keys(serviceStats).length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                            選定期間內沒有服務記錄
                        </td>
                    </tr>
                `;
                return;
            }

            const sortedServices = Object.entries(serviceStats).sort(([,a], [,b]) => b.revenue - a.revenue);

            tbody.innerHTML = sortedServices.map(([category, stat]) => {
                const percentage = totalRevenue > 0 ? ((stat.revenue / totalRevenue) * 100).toFixed(1) : '0';
                const average = stat.count > 0 ? Math.round(stat.revenue / stat.count) : 0;

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm text-gray-900">${stat.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-right">${stat.count}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-right font-medium">$${stat.revenue.toLocaleString()}</td>
                        <td class="px-4 py-3 text-sm text-gray-600 text-right">$${average.toLocaleString()}</td>
                        <td class="px-4 py-3 text-sm text-gray-600 text-right">${percentage}%</td>
                    </tr>
                `;
            }).join('');
        }

        // 切換財務標籤
        function switchFinancialTab(tabType) {
            // 更新標籤按鈕樣式
            document.querySelectorAll('[role="tablist"] button').forEach(btn => {
                if (btn.id && btn.id.startsWith('financial')) {
                    btn.className = 'py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm transition duration-200';
                }
            });
            
            document.getElementById(`financial${tabType.charAt(0).toUpperCase() + tabType.slice(1)}Tab`).className = 'py-4 px-1 border-b-2 border-green-500 text-green-600 font-medium text-sm transition duration-200';

            // 隱藏所有標籤內容
            document.querySelectorAll('.financial-tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // 顯示選中的標籤內容
            document.getElementById(`financial${tabType.charAt(0).toUpperCase() + tabType.slice(1)}Content`).classList.remove('hidden');
            
            currentFinancialTabType = tabType;
        }

        // 匯出財務報表
        function exportFinancialReport() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const reportType = document.getElementById('reportType').value;
            
            // 準備匯出資料
            const reportData = {
                reportInfo: {
                    title: `財務報表 - ${reportType}`,
                    period: `${startDate} 至 ${endDate}`,
                    generatedAt: new Date().toLocaleString('zh-TW')
                },
                summary: {
                    totalRevenue: document.getElementById('totalRevenue').textContent,
                    totalConsultations: document.getElementById('totalConsultations').textContent,
                    averageRevenue: document.getElementById('averageRevenue').textContent,
                    activeDoctors: document.getElementById('activeDoctors').textContent
                }
            };

            // 轉換為 JSON 字符串
            const jsonString = JSON.stringify(reportData, null, 2);
            
            // 創建下載
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `財務報表_${startDate}_${endDate}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast('財務報表已匯出！', 'success');
        }

        
        // 套票管理函式
        function getPatientPackagesStore() {
            return JSON.parse(localStorage.getItem('patientPackages') || '[]');
        }
        function setPatientPackagesStore(list) {
            localStorage.setItem('patientPackages', JSON.stringify(list));
        }
        function getPatientPackages(patientId) {
            const all = getPatientPackagesStore();
            return all.filter(p => p.patientId === patientId);
        }
        function purchasePackage(patientId, item) {
            const totalUses = Number(item.packageUses || item.totalUses || 0);
            const validityDays = Number(item.validityDays || 0);
            const purchasedAt = new Date();
            const expiresAt = new Date(purchasedAt);
            expiresAt.setDate(expiresAt.getDate() + validityDays);
            const record = {
                id: Date.now(),
                patientId: patientId,
                packageItemId: item.id,
                name: item.name,
                totalUses: totalUses,
                remainingUses: totalUses,
                purchasedAt: purchasedAt.toISOString(),
                expiresAt: expiresAt.toISOString()
            };
            const all = getPatientPackagesStore();
            all.push(record);
            setPatientPackagesStore(all);
            return record;
        }
        function consumePackage(patientId, packageRecordId) {
            const all = getPatientPackagesStore();
            const idx = all.findIndex(p => p.id === packageRecordId && p.patientId === patientId);
            if (idx === -1) return { ok: false, msg: '找不到套票' };
            const now = new Date();
            const exp = new Date(all[idx].expiresAt);
            if (now > exp) return { ok: false, msg: '套票已過期' };
            if (all[idx].remainingUses <= 0) return { ok: false, msg: '套票已用完' };
            all[idx].remainingUses -= 1;
            setPatientPackagesStore(all);
            return { ok: true, record: all[idx] };
        }
        function formatPackageStatus(pkg) {
            const exp = new Date(pkg.expiresAt);
            const now = new Date();
            const daysLeft = Math.ceil((exp - now) / (1000*60*60*24));
            const expired = daysLeft < 0;
            return expired
              ? `已到期（${exp.toLocaleDateString('zh-TW')}）`
              : `剩餘 ${pkg.remainingUses}/${pkg.totalUses} 次 · ${exp.toLocaleDateString('zh-TW')} 到期（約 ${daysLeft} 天）`;
        }
        function renderPatientPackages(patientId) {
            const container = document.getElementById('patientPackagesList');
            if (!container) return;
            const pkgs = getPatientPackages(patientId).sort((a,b)=> new Date(a.expiresAt)-new Date(b.expiresAt));
            if (pkgs.length === 0) {
                container.innerHTML = '<div class="text-gray-500">無已購買的套票</div>';
                return;
            }
            container.innerHTML = pkgs.map(pkg => {
                const exp = new Date(pkg.expiresAt);
                const now = new Date();
                const expired = now > exp;
                const disabled = expired || pkg.remainingUses <= 0;
                const badge =
                  expired ? '<span class="ml-2 text-xs text-white px-2 py-0.5 rounded bg-red-500">已到期</span>' :
                  (pkg.remainingUses <= 0 ? '<span class="ml-2 text-xs text-white px-2 py-0.5 rounded bg-gray-500">已用完</span>' : '');
                return `
      <div class="flex items-center justify-between bg-white border border-purple-200 rounded p-2">
        <div>
          <div class="font-medium text-purple-900">${pkg.name}${badge}</div>
          <div class="text-xs text-gray-600">${formatPackageStatus(pkg)}</div>
        </div>
        <button type="button" ${disabled ? 'disabled' : ''} 
          onclick="useOnePackage(${pkg.patientId}, ${pkg.id})"
          class="px-3 py-1 rounded ${disabled ? 'bg-gray-300 text-gray-600' : 'bg-purple-600 text-white hover:bg-purple-700'}">
          使用一次
        </button>
      </div>
    `;
            }).join('');
        }
        function refreshPatientPackagesUI() {
            const appointment = appointments.find(apt => apt.id === currentConsultingAppointmentId);
            if (!appointment) return;
            renderPatientPackages(appointment.patientId);
        }
        function useOnePackage(patientId, packageRecordId) {
            const res = consumePackage(patientId, packageRecordId);
            if (!res.ok) {
                showToast(res.msg || '套票不可用', 'warning');
                return;
            }
            const usedName = `${res.record.name}（使用套票）`;
            selectedBillingItems.push({
                id: `use-${res.record.id}-${Date.now()}`,
                name: usedName,
                category: 'packageUse',
                price: 0,
                unit: '次',
                description: '套票抵扣一次',
                quantity: 1
            });
            updateBillingDisplay();
            refreshPatientPackagesUI();
            showToast(`已使用套票：${res.record.name}，剩餘 ${res.record.remainingUses} 次`, 'success');
        }

// 初始化系統
        document.addEventListener('DOMContentLoaded', function() {
            // 系統啟動時清空過期掛號
            clearOldAppointments();
            
            updateStatistics();
            updateClinicSettingsDisplay();
            
            // 自動聚焦到帳號輸入框
            const usernameInput = document.getElementById('mainLoginUsername');
            if (usernameInput) {
                setTimeout(() => {
                    usernameInput.focus();
                }, 100);
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96abf25724ae0514',t:'MTc1NDQ1NjE3NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script><script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"96c38f22ee47ddc3","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.7.0","token":"b2074e7888b746fe9fbbc15492b4c3d4"}' crossorigin="anonymous"></script>
</body>
</html>
